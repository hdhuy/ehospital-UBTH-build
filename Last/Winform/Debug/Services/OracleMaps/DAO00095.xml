<?xml version="1.0" encoding="utf-8" ?>
<!--============================================================================
//	CAUTION: This file is generated by IBatisNetGen.3.SQLMap.cst at 12/21/2015 2:22:43 PM
//				Any manual editing will be lost in re-generation.
//===========================================================================-->
<sqlMap namespace="eHospital" xmlns="http://ibatis.apache.org/mapping" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
  <statements>
    <!--<statement id="DAO00095_GetList" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select DICHVU_ID from TM_DICHVU_PHANNHOMDICHVU
      where PHANNHOMDICHVU_ID in (select PHANNHOMDICHVU_ID
                                  from TM_PHANNHOMDICHVU
                                  where MAPHANNHOMDICHVU = '$MAPHANNHOMDICHVU$')
      and BENHVIEN_ID = '$BENHVIEN_ID$'
    </statement>-->

    <statement id="DAO00095_TM_CATEGORY_DOCUMENT_GetList" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select * from TM_CATEGORY_DOCUMENT
      <dynamic prepend="where">
      <isParameterPresent>
        <isNotEmpty prepend="and" property="CATEGORY_DOCUMENT_ID">
          TM_CATEGORY_DOCUMENT.CATEGORY_DOCUMENT_ID = '$CATEGORY_DOCUMENT_ID$'
        </isNotEmpty>
        <isNotEmpty prepend="and" property="CATEGORY_DOCUMENT_CODE">
          TM_CATEGORY_DOCUMENT.CATEGORY_DOCUMENT_CODE = '$CATEGORY_DOCUMENT_CODE$'
        </isNotEmpty>
        <isNotEmpty prepend="and" property="CATEGORY_DOCUMENT_NAME">
          TM_CATEGORY_DOCUMENT.CATEGORY_DOCUMENT_NAME = '$CATEGORY_DOCUMENT_NAME$'
        </isNotEmpty>
        <isNotEmpty prepend="and" property="MOTA">
          TM_CATEGORY_DOCUMENT.MOTA = '$MOTA$'
        </isNotEmpty>
        <isNotEmpty prepend="and" property="TINHTRANG">
          TM_CATEGORY_DOCUMENT.TINHTRANG = '$TINHTRANG$'
        </isNotEmpty>
        <isNotEmpty prepend="and" property="BENHVIEN_ID">
          TM_CATEGORY_DOCUMENT.BENHVIEN_ID = '$BENHVIEN_ID$'
        </isNotEmpty>
        <isNotEmpty prepend="and" property="NGAYTAO">
          TM_CATEGORY_DOCUMENT.NGAYTAO = '$NGAYTAO$'
        </isNotEmpty>
        <isNotEmpty prepend="and" property="NGUOITAO_ID">
          TM_CATEGORY_DOCUMENT.NGUOITAO_ID = '$NGUOITAO_ID$'
        </isNotEmpty>
        <isNotEmpty prepend="and" property="NGAYCAPNHAT">
          TM_CATEGORY_DOCUMENT.NGAYCAPNHAT = '$NGAYCAPNHAT$'
        </isNotEmpty>
        <isNotEmpty prepend="and" property="NGUOICAPNHAT_ID">
          TM_CATEGORY_DOCUMENT.NGUOICAPNHAT_ID = '$NGUOICAPNHAT_ID$'
        </isNotEmpty>
      </isParameterPresent>
    </dynamic>
    </statement>


      <statement id="DAO00095_TT_DOCUMENTS_Get" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select * from TT_DOCUMENTS
      <dynamic prepend="where">
        <isParameterPresent>
          <isNotEmpty prepend="and" property="DOCUMENT_ID">
            TT_DOCUMENTS.DOCUMENT_ID = '$DOCUMENT_ID$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="CATEGORY_DOCUMENT_CODE">
            TT_DOCUMENTS.CATEGORY_DOCUMENT_CODE = '$CATEGORY_DOCUMENT_CODE$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="BENHNHAN_ID">
            TT_DOCUMENTS.BENHNHAN_ID = '$BENHNHAN_ID$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="MABENHNHAN">
            TT_DOCUMENTS.MABENHNHAN = '$MABENHNHAN$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="BENHVIEN_ID">
            TT_DOCUMENTS.BENHVIEN_ID = '$BENHVIEN_ID$'
          </isNotEmpty>
 
        </isParameterPresent>
      </dynamic>
    </statement>

    <statement id="DAO00095_TT_DOCUMENTS_GetList" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
    select A.CATEGORY_DOCUMENT_NAME,B.*
      , bn.TENBENHNHAN
      , CASE NVL(BN.NGAYSINH,' ')
      WHEN ' ' THEN TO_CHAR(BN.NAMSINH)
      ELSE TO_CHAR(BN.NGAYSINH,'DD/MM/YYYY')
      END AS NAMSINH
      , gt.DESCRIPTION as GIOITINH, bn.MAYTE
      from TT_DOCUMENTS B
      left join TM_CATEGORY_DOCUMENT A on A.CATEGORY_DOCUMENT_CODE = B.CATEGORY_DOCUMENT_CODE and B.BENHNHAN_ID = '$BENHNHAN_ID$'
      left join TT_BENHNHAN bn on bn.BENHNHAN_ID = b.BENHNHAN_ID
      left join TM_GENDER gt on gt.ID = bn.GIOITINH

      <dynamic prepend="where">
        <isParameterPresent>
          <isNotEmpty prepend="and" property="DOCUMENT_ID">
            B.DOCUMENT_ID = '$DOCUMENT_ID$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="CATEGORY_DOCUMENT_CODE">
            B.CATEGORY_DOCUMENT_CODE = '$CATEGORY_DOCUMENT_CODE$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="MABENHNHAN">
            B.MABENHNHAN = '$MABENHNHAN$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="BENHVIEN_ID">
            A.BENHVIEN_ID = '$BENHVIEN_ID$'
          </isNotEmpty>
        </isParameterPresent>
      </dynamic>
      order by B.NGAYCAPNHAT
    </statement>
    
    
       <update id="DAO00095_TT_DOCUMENT_Update" parameterClass="System.Collections.IDictionary">
      update TT_DOCUMENTS
      set

            TT_DOCUMENTS.FILE_NAME = '$FILE_NAME$'

            ,TT_DOCUMENTS.NGAYCAPNHAT = '$NGAYCAPNHAT$'

            ,TT_DOCUMENTS.NGUOICAPNHAT_ID = '$NGUOICAPNHAT_ID$'
       <dynamic prepend="where">
        <isParameterPresent>
          <isNotEmpty prepend="and" property="DOCUMENT_ID">
            TT_DOCUMENTS.DOCUMENT_ID = '$DOCUMENT_ID$'
          </isNotEmpty>          
          <isNotEmpty prepend="and" property="BENHVIEN_ID">
            TT_DOCUMENTS.BENHVIEN_ID = '$BENHVIEN_ID$'
          </isNotEmpty>          
        </isParameterPresent>
      </dynamic>
    </update>

    <insert id="DAO00095_TT_DOCUMENT_Add" parameterClass="System.Collections.IDictionary" resultClass="System.Int64">
      INSERT INTO TT_DOCUMENTS
      (CATEGORY_DOCUMENT_CODE
      ,BENHNHAN_ID
      ,MABENHNHAN
      ,FILE_NAME_ORI
      ,FILE_NAME
      ,TYPE
      ,FILE_NAME_PATH
      ,MOTA
      ,TINHTRANG
      ,BENHVIEN_ID
      ,NGAYTAO
      ,NGUOITAO_ID
      ,NGAYCAPNHAT
      ,NGUOICAPNHAT_ID
      ,FILE_NAME_UPLOAD)
      VALUES
      (#CATEGORY_DOCUMENT_CODE#
      ,#BENHNHAN_ID#
      ,#MABENHNHAN#
      ,#FILE_NAME_ORI#
      ,#FILE_NAME#
      ,#TYPE#
      ,#FILE_NAME_PATH#
      ,#MOTA#
      ,#TINHTRANG#
      ,#BENHVIEN_ID#
      ,#NGAYTAO#
      ,#NGUOITAO_ID#
      ,#NGAYCAPNHAT#
      ,#NGUOICAPNHAT_ID#
      ,#FILE_NAME_UPLOAD#)
    </insert>

    <statement id="DAO00095_TT_DOCUMENT_Delete" parameterClass="System.Collections.IDictionary" resultClass="System.Int32">
      DELETE FROM TT_DOCUMENTS
      <dynamic prepend="where">
      <isParameterPresent>
        <isNotEmpty prepend="and" property="DOCUMENT_ID">
          TT_DOCUMENTS.DOCUMENT_ID = '$DOCUMENT_ID$'
        </isNotEmpty>
        <isNotEmpty prepend="and" property="BENHVIEN_ID">
          TT_DOCUMENTS.BENHVIEN_ID = '$BENHVIEN_ID$'
        </isNotEmpty>
      </isParameterPresent>
    </dynamic>
    </statement>
    
    <statement id="DAO00095_GopMaBenhNhan" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
    DECLARE
      vrBenhnhanIdHuy NUMBER :=0;
      vrBenhnhanIdSuDung NUMBER:=0;
      vrpara1 VARCHAR(50);
      vrUpdateData VARCHAR(300);

      CURSOR Data_Cursor is
      SELECT distinct TABLE_NAME FROM all_tab_cols where COLUMN_NAME like 'BENHNHAN_ID' and TABLE_NAME like 'TT_%';
begin
    vrBenhnhanIdHuy := '$BENHNHAN_IDHUY$';
    vrBenhnhanIdSuDung := '$BENHNHAN_IDSUDUNG$';
    FOR vrpara1 in Data_Cursor
    LOOP
      vrUpdateData := 'update '|| vrpara1.TABLE_NAME ||' set BENHNHAN_ID = ''' || TO_CHAR(vrBenhnhanIdSuDung) || ''' where BENHNHAN_ID = ''' || TO_CHAR(vrBenhnhanIdHuy) ||'''';
      BEGIN
        <!--dbms_output.put_line(vrUpdateData); -->     
        EXECUTE IMMEDIATE vrUpdateData;
      EXCEPTION 
        WHEN OTHERS THEN dbms_output.put_line('Error SQL:' || SQLCODE);
      END;
      vrUpdateData := '';
    END LOOP;
    update TT_BENHNHAN set ACTIVE = '0' where BENHNHAN_ID = vrBenhnhanIdHuy;
end
    </statement>
    <statement id="DAO00095_GetListTiepNhanGopMaBenhNhan" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select A.TIEPNHAN_ID, B.DVYEUCAU_ID, B.DICHVU_ID, A.SOTIEPNHAN
      from TT_TIEPNHAN A
      left join (select * from TT_DVYEUCAU where BENHNHAN_ID = '$BENHNHAN_ID$') B on B.TIEPNHAN_ID = A.TIEPNHAN_ID and (B.TRANGTHAI = 'CHUAKETQUA' or B.TRANGTHAI = 'DANGTHUCHIEN')
      where A.BENHNHAN_ID = '$BENHNHAN_ID$' and (A.TRANGTHAI = 'DATIEPNHAN' or A.TRANGTHAI = 'NOITRU' or A.TRANGTHAI = 'CAPCUU')
    </statement>
    <statement id="DAO00095_GetListDuyetToaThuocBHYTGopMaBenhNhan" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select distinct A.SOTIEPNHAN, A.TRAITUYEN, A.NGAYMIENDONGCHITRA, A.TIEPNHAN_ID, A.DOITUONG_ID,
      A.LOAITHANHVIEN_ID, A.SUDUNG_BHTN, A.THE_ID, A.THANHVIEN_ID, A.VIP, A.NGUON_BENHNHAN_ID, A.BAOLANH_VIENPHI,
      B.*, 'NGOAITRU' as LOAITOA, C.KHOXUAT_ID as KHOXUAT_ID
      from TT_NGOAITRU_KHAMBENH_TOATHUOC C
      inner join TT_NGOAITRU_KHAMBENH D on C.KHAMBENH_ID = D.KHAMBENH_ID
      inner join TT_TIEPNHAN A on D.TIEPNHAN_ID = A.TIEPNHAN_ID and (A.TRANGTHAI = 'DATIEPNHAN' or A.TRANGTHAI = 'NOITRU' or A.TRANGTHAI = 'CAPCUU')
      inner join TT_BENHNHAN B on B.BENHNHAN_ID = A.BENHNHAN_ID
      where C.DUYET = '1' and C.TRANGTHAI = 'CHUAXUAT' and C.BENHVIEN_ID = '$BENHVIEN_ID$' and (A.SOBHYT is not null)
      union
      select distinct A.SOTIEPNHAN, A.TRAITUYEN, A.NGAYMIENDONGCHITRA, A.TIEPNHAN_ID, A.DOITUONG_ID,
      A.LOAITHANHVIEN_ID, A.SUDUNG_BHTN, A.THE_ID, A.THANHVIEN_ID, A.VIP, A.NGUON_BENHNHAN_ID, A.BAOLANH_VIENPHI,
      B.*, 'NOITRU' as LOAITOA, C.KHOPHAT_ID as KHOXUAT_ID
      from TT_NOITRU_TOATHUOC C
      inner join TT_TIEPNHAN A on C.TIEPNHAN_ID = A.TIEPNHAN_ID and (A.TRANGTHAI = 'DATIEPNHAN' or A.TRANGTHAI = 'NOITRU' or A.TRANGTHAI = 'CAPCUU')
      inner join TT_BENHNHAN B on B.BENHNHAN_ID = A.BENHNHAN_ID
      where
      (C.TRANGTHAI = 'DADUYET' or C.TRANGTHAI = 'CHUAXUAT')
      and C.BENHVIEN_ID = '$BENHVIEN_ID$' and (A.SOBHYT is not null)
      and A.BENHNHAN_ID = '$BENHNHAN_ID$'
    </statement>
    <statement id="DAO00095_LayThongTinSearch" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select
      B.MAYTE, A.SOTIEPNHAN, C.SOBENHAN, B.TENBENHNHAN, F.TENPHONGBAN as KHOADIEUTRI,
      E.TENDOITUONG, A.SOBHYT, B.SODIENTHOAI, B.DIACHILIENLAC, G.MAGIUONG, B.NGUOILIENHE
      from TT_TIEPNHAN A
      inner join TT_BENHNHAN B on B.BENHNHAN_ID = A.BENHNHAN_ID and B.BENHVIEN_ID = '$BENHVIEN_ID$'
      left join TT_NOITRU_BENHAN C on C.TIEPNHAN_ID = A.TIEPNHAN_ID
      left join TT_NOITRU_LUUTRUCHITIET D
      on D.LUUTRU_ID in (select LUUTRU_ID from TT_NOITRU_LUUTRU where BENHAN_ID = C.BENHAN_ID and ROWNUM = 1 order by LUUTRU_ID desc)
      left join TM_DOITUONG E on E.DOITUONG_ID = A.DOITUONG_ID
      left join TM_PHONGBAN F on F.PHONGBAN_ID = NVL(C.KHOACHUYENDEN_ID, C.KHOAVAO_ID)
      left join TM_GIUONGBENH G on G.GIUONGBENH_ID = D.GIUONGBENH_ID
      where
      A.BENHVIEN_ID = '$BENHVIEN_ID$' AND
      C.SOBENHAN like %$THONGTINTIMKIEM$%' or A.SOTIEPNHAN like %$THONGTINTIMKIEM$%'
      or B.TENBENHNHAN like %$THONGTINTIMKIEM$%' or B.SODIENTHOAI like %$THONGTINTIMKIEM$%'
      or B.DIACHILIENLAC like %$THONGTINTIMKIEM$%' or A.SOBHYT like '%$THONGTINTIMKIEM$%'
      or B.HO like %$THONGTINTIMKIEM$%' or B.TEN like %$THONGTINTIMKIEM$%' or B.MAYTE like %$THONGTINTIMKIEM$%'
    </statement>
    <statement id="DAO00095_GetDanhSachBenhNhan_Count" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select count(*) as TOTALROWS from TT_BENHNHAN
      where BENHVIEN_ID = '$BENHVIEN_ID$'
      <isParameterPresent>
        <isNotEmpty prepend="and" property="THONGTINTIMKIEM">
          TT_BENHNHAN.MAYTE like '%$THONGTINTIMKIEM$%'
          or TT_BENHNHAN.TENBENHNHAN like %$THONGTINTIMKIEM$%'
          or TT_BENHNHAN.DIACHITHUONGTRU like %$THONGTINTIMKIEM$%'
          or TT_BENHNHAN.SODIENTHOAI like '%$THONGTINTIMKIEM$%'
        </isNotEmpty>
      </isParameterPresent>

    </statement>
    <statement id="DAO00095_GetDanhSachBenhNhan" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select *
      from
      (
      select ROW_NUMBER() OVER(order by MAYTE) as ROWNUMBER, TT_BENHNHAN.*, B.DESCRIPTION as TENGIOITINH
      from TT_BENHNHAN
      left join TM_GENDER as B on TT_BENHNHAN.GIOITINH = B.ID
      where TT_BENHNHAN.BENHVIEN_ID = '$BENHVIEN_ID$'
      <isParameterPresent>
        <isNotEmpty prepend="and" property="THONGTINTIMKIEM">
          TT_BENHNHAN.MAYTE like '%$THONGTINTIMKIEM$%'
          or TT_BENHNHAN.TENBENHNHAN like %$THONGTINTIMKIEM$%'
          or TT_BENHNHAN.DIACHITHUONGTRU like %$THONGTINTIMKIEM$%'
          or TT_BENHNHAN.SODIENTHOAI like '%$THONGTINTIMKIEM$%'
        </isNotEmpty>
      </isParameterPresent>
      ) lst
      <isNotEmpty prepend="" property="FROMROW">
        where
        lst.ROWNUMBER between $FROMROW$ and $TOROW$
      </isNotEmpty>
      order by lst.MAYTE asc
    </statement>
    <statement id="DAO00095_GetBenhNhanChuaHoanThanh" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select A.*
      from TT_TIEPNHAN A
      left join TT_BENHNHAN B on A.BENHNHAN_ID = B.BENHNHAN_ID
      where
      A.BENHNHAN_ID = '$BENHNHAN_ID$' and A.TRANGTHAI != 'HOANTHANH' and ROWNUM = 1
    </statement>
    <insert id="DAO00095_AddBenhManTinh" parameterClass="System.Collections.IDictionary" resultClass="System.Int64">
      <selectKey property="ID" type="pre" resultClass="System.Int64">
        select TT_BENHNHAN_BENHMANTINH_S.nextval as value from dual
      </selectKey>
      insert into TT_BENHNHAN_BENHMANTINH (
      BENHNHAN_BENHMANTINH_ID
      , BENHNHAN_ID
      , BENHMANTINH_ID
      , BACSIPHATHIEN_ID
      , NGAYPHATHIEN
      , TINHTRANG
      , GHICHU
      , NGAYTAO
      , NGUOITAO_ID
      , NGAYCAPNHAT
      , NGUOICAPNHAT_ID
      , BENHVIEN_ID
      ) values (
      #ID#
      , #BENHNHAN_ID#
      , #BENHMANTINH_ID#
      , #BACSIPHATHIEN_ID#
      , #NGAYPHATHIEN#
      , #TINHTRANG#
      , #GHICHU#
      , #NGAYTAO#
      , #NGUOITAO_ID#
      , #NGAYCAPNHAT#
      , #NGUOICAPNHAT_ID#
      , #BENHVIEN_ID#
      )      
    </insert>

    <update id="DAO00095_UpdateBenhManTinh" parameterClass="System.Collections.IDictionary">
      update TT_BENHNHAN_BENHMANTINH set
      BENHMANTINH_ID = #BENHMANTINH_ID#
      , BACSIPHATHIEN_ID = #BACSIPHATHIEN_ID#
      , NGAYPHATHIEN = #NGAYPHATHIEN#
      , TINHTRANG = #TINHTRANG#
      , GHICHU = #GHICHU#
      , NGAYCAPNHAT = #NGAYCAPNHAT#
      , NGUOICAPNHAT_ID = #NGUOICAPNHAT_ID#
      where
      BENHNHAN_BENHMANTINH_ID = '$BENHNHAN_BENHMANTINH_ID$'
    </update>

    <statement id="DAO00095_GetDSBenhManTinh" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select *
      from TT_BENHNHAN_BENHMANTINH
      where BENHNHAN_ID  = '$BENHNHAN_ID$'
      and BENHVIEN_ID  = '$BENHVIEN_ID$'
    </statement>

    <statement id="DAO00095_GetDSDocuments" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select *
      from TT_DOCUMENTS
      where BENHNHAN_ID  = '$BENHNHAN_ID$'
      and BENHVIEN_ID  = '$BENHVIEN_ID$'
      <isNotEmpty prepend="and" property="TUNGAY">
        TRUNC(NGAYTAO) BETWEEN trunc(#TUNGAY#) and  trunc(#DENNGAY#)
      </isNotEmpty>     
    </statement>

    <statement id="DAO00095_DeleteListBenhManTinh" parameterClass="System.Collections.IDictionary" resultClass="System.Int32">
      delete from TT_BENHNHAN_BENHMANTINH
      where
      BENHNHAN_BENHMANTINH_ID in
      <iterate property="LIST_BENHNHAN_BENHMANTINH_ID" open="(" close=")" conjunction=",">
        #LIST_BENHNHAN_BENHMANTINH_ID[]#
      </iterate>
    </statement>
    <statement id="DAO00095_GetDetails_BNBH" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select  bn.*, bhyt.BENHVIEN_KCB_ID,
      NVL(TO_CHAR(bn.NGAYSINH, 'DD/MM/YYYY'), TO_CHAR(bn.NAMSINH)) as NGAYTHANGNAMSINH,
      bhyt.SOTHE, bhyt.NGAYHIEULUC, bhyt.NGAYHETHIEULUC, bhyt.TINHTHANH_CAPTHE_ID, bhyt.NGAYCAP,
      bhyt.TREN3NAM, bhyt.TREN5NAM, bhyt.NGAYMIENDONGCHITRA, tn.SOTIEPNHAN
      from TT_BENHNHAN  bn
      left join TT_BENHNHAN_BHYT  bhyt on bn.BENHNHAN_ID = bhyt.BENHNHAN_ID
      left join TT_TIEPNHAN  tn on bn.BENHNHAN_ID = tn.BENHNHAN_ID
      where bn.MAYTE = '$MAYTE$' and ACTIVE = '1' 
      order by bhyt.NGAYCAPNHAT desc, bhyt.NGAYTAO desc
    </statement>
    <statement id="DAO00095_GetTTDiUngThuoc" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select *
      from TT_BENHNHAN_DIUNG_THUOC
      where BENHNHAN_ID = '$BENHNHAN_ID$'
      and BENHVIEN_ID = '$BENHVIEN_ID$'
    </statement>
  </statements>
</sqlMap>
