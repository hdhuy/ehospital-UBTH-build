<?xml version="1.0" encoding="utf-8" ?>
<!--============================================================================
//	CAUTION: This file is generated by IBatisNetGen.3.SQLMap.cst at 10/3/2016 10:12:54 AM
//				Any manual editing will be lost in re-generation.
//===========================================================================-->
<sqlMap namespace="eHospital" xmlns="http://ibatis.apache.org/mapping" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
  <statements>
    <insert id="DAO00304_Add" parameterClass="System.Collections.IDictionary" resultClass="System.Int64">
      <selectKey property="ID" type="pre" resultClass="System.Int64">
        select TT_NOITRU_DOTDIEUTRI_CT.nextval as value from sys.dual
      </selectKey>
      insert into TT_NOITRU_DOTDIEUTRI_CHITIET (
      DOTDIEUTRICHITIET_ID
      , DOTDIEUTRI_ID
      , VIENPHI_ID
      , NGAYTAO
      , NGUOITAO_ID
      , NGAYCAPNHAT
      , NGUOICAPNHAT_ID
      ) values (
      #ID#
      , #DOTDIEUTRI_ID#
      , #VIENPHI_ID#
      , #NGAYTAO#
      , #NGUOITAO_ID#
      , #NGAYCAPNHAT#
      , #NGUOICAPNHAT_ID#
      )
    </insert>

    <update id="DAO00304_Update" parameterClass="System.Collections.IDictionary">
      update TT_NOITRU_DOTDIEUTRI_CHITIET set
      NGAYCAPNHAT = #NGAYCAPNHAT#
      , NGUOICAPNHAT_ID = #NGUOICAPNHAT_ID#
      where
      VIENPHI_ID IN (select regexp_substr('$VIENPHI_ID$','[^,]+', 1, level) from sys.dual
      connect by regexp_substr('$VIENPHI_ID$', '[^,]+', 1, level) is not null)
    </update>

    <statement id="DAO00304_Delete" parameterClass="System.Collections.IDictionary" resultClass="System.Int32">
      delete from TT_NOITRU_DOTDIEUTRI_CHITIET
      where
      VIENPHI_ID = '$VIENPHI_ID$'
    </statement>
    <statement id="DAO00304_DeleteForRow" parameterClass="System.Collections.IDictionary" resultClass="System.Int32">
      delete from TT_NOITRU_DOTDIEUTRI_CHITIET
      where
      VIENPHI_ID IN (select regexp_substr('$VIENPHI_ID$','[^,]+', 1, level) from sys.dual
      connect by regexp_substr('$VIENPHI_ID$', '[^,]+', 1, level) is not null)
    </statement>
    <statement id="DAO00304_DotDieuTriID" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select DOTDIEUTRI_ID
      from TT_NOITRU_DOTDIEUTRI
      where BENHAN_ID = '$BENHAN_ID$' and TRANGTHAI='0' AND ROWNUM = 1
      order by DOTDIEUTRI_ID DESC
    </statement>
    <statement id="DAO00304_GetVienPhiYL" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select *
      from TT_VIENPHI
      where BENHAN_ID = '$BENHAN_ID$' and TIEPNHAN_ID = '$TIEPNHAN_ID$' and KHAMBENH_ID = '$KHAMBENH_ID$'
      and BENHVIEN_ID = '$BENHVIEN_ID$' and DATHANHTOAN='0' AND REF_TABLE='TT_NOITRU_TOATHUOC'
      and VIENPHI_ID not in (select VIENPHI_ID from TT_NOITRU_DOTDIEUTRI_CHITIET)
    </statement>
    <statement id="DAO00304_GetVienPhiDV" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select *
      from TT_VIENPHI
      where TIEPNHAN_ID = '$TIEPNHAN_ID$'
      and BENHVIEN_ID = '$BENHVIEN_ID$' and DATHANHTOAN='0'
      and REF_ID in (select regexp_substr('$REF_ID$','[^,]+', 1, level) from sys.dual
      connect by regexp_substr('$REF_ID$', '[^,]+', 1, level) is not null)
      and VIENPHI_ID not in (select VIENPHI_ID from TT_NOITRU_DOTDIEUTRI_CHITIET)
    </statement>
    <statement id="DAO00304_GetVienPhiTheoYLenh" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select *
      from TT_VIENPHI
      where BENHAN_ID = '$BENHAN_ID$' and KHAMBENH_ID = '$KHAMBENH_ID$'
      and BENHVIEN_ID = '$BENHVIEN_ID$'
    </statement>
    <statement id="DAO00304_GetVienPhiTheoDichVu" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select *
      from TT_VIENPHI
      where TIEPNHAN_ID = '$TIEPNHAN_ID$'
      and REF_ID IN (select regexp_substr('$REF_ID$','[^,]+', 1, level) from sys.dual
      connect by regexp_substr('$REF_ID$', '[^,]+', 1, level) is not null) AND REF_TABLE = 'TT_DVYEUCAU'
      and BENHVIEN_ID = '$BENHVIEN_ID$'
    </statement>
    <statement id="DAO00304_GetVienPhiThanhToanTheoDot" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select distinct DDT.*, NV.TENNHANVIEN AS BACSIDIEUTRI, PB.TENPHONGBAN AS KHOADIEUTRI
      from TT_VIENPHI VP
      LEFT JOIN TT_DVYEUCAU DVYC ON DVYC.DVYEUCAU_ID = VP.REF_ID and vp.REF_TABLE='TT_DVYEUCAU'
      INNER JOIN TT_NOITRU_DOTDIEUTRI_CHITIET CT ON VP.VIENPHI_ID = CT.VIENPHI_ID
      INNER JOIN TT_NOITRU_DOTDIEUTRI DDT ON DDT.DOTDIEUTRI_ID = CT.DOTDIEUTRI_ID
      LEFT JOIN TM_PHONGBAN PB ON PB.PHONGBAN_ID = DDT.KHOADIEUTRI_ID
      LEFT JOIN TM_NHANVIEN NV ON NV.NHANVIEN_ID = DDT.BACSYDIEUTRI_ID
      where Vp.BENHAN_ID = '$BENHAN_ID$' and Vp.ACTIVE = '1' and ((DVYC.HUYYEUCAU != '1' and vp.DICHVU_ID is not null) or (vp.DUOC_ID is not null)) and
      ((vp.DATHANHTOAN = '0') or (vp.BENHNHAN_PHAITHANHTOAN > vp.GIATRI_BENHNHAN_DATHANHTOAN and vp.DATHANHTOAN = '1')) and DVYC.DANGKY_ID is null
      <!--and ddt.TRANGTHAI = '1'-->
    </statement>
    <statement id="DAO00304_TT_VIENPHI_THANHTOANDOT" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select distinct a.*, b.GIATRIMIENGIAM_BH, c.GIATRIMIENGIAM_BHTN, f.GIATRIMIENGIAM_THANHVIEN, g.GIATRIMIENGIAM_CTCT
      from
      (select VP.*, c.NOITHUCHIEN_ID, c.NOIYEUCAU_ID, kb.RAVIEN, kb.ISTHUOCBV
      from TT_VIENPHI VP
      left join TT_DVYEUCAU c on c.DVYEUCAU_ID = VP.REF_ID  and vp.REF_TABLE = 'TT_DVYEUCAU'
      inner join TT_NOITRU_DOTDIEUTRI_CHITIET dtct on dtct.VIENPHI_ID = vp.VIENPHI_ID
      inner join TT_NOITRU_DOTDIEUTRI dt on dt.DOTDIEUTRI_ID = dtct.DOTDIEUTRI_ID
      left join TT_NOITRU_TOATHUOC tt on tt.TOATHUOC_ID = vp.REF_ID and vp.REF_TABLE = 'TT_NOITRU_TOATHUOC'
      left join TT_NOITRU_KHAMBENH kb on kb.KHAMBENH_ID = tt.KHAMBENH_ID
      where Vp.BENHAN_ID = '$BENHAN_ID$' and Vp.ACTIVE = '1' and ((c.HUYYEUCAU != '1' and vp.DICHVU_ID is not null) or (vp.DUOC_ID is not null)) and
      ((vp.DATHANHTOAN = '0') or (vp.BENHNHAN_PHAITHANHTOAN > vp.GIATRI_BENHNHAN_DATHANHTOAN and vp.DATHANHTOAN = '1')) and c.DANGKY_ID is null
      <!--and dt.TRANGTHAI = '1'-->) a

      left join (select VIENPHI_ID,
      sum(MGCT.GIATRIMIENGIAM) AS GIATRIMIENGIAM_BH from TT_MIENGIAM MG
      INNER JOIN TT_MIENGIAM_CHITIET MGCT ON MG.MIENGIAM_ID = MGCT.MIENGIAM_ID
      where MG.BENHAN_ID = '$BENHAN_ID$' and MGCT.REF_TABLE = 'TT_MIENGIAM' and MG.TINHTRANG = 1 group by VIENPHI_ID
      ) b on a.VIENPHI_ID = b.VIENPHI_ID

      left join (select VIENPHI_ID, sum(MGCT.GIATRIMIENGIAM) AS GIATRIMIENGIAM_BHTN
      from TT_MIENGIAM_BHTN MG
      INNER JOIN TT_MIENGIAM_CHITIET MGCT ON MG.MIENGIAM_BHTN_ID = MGCT.MIENGIAM_ID
      where  MG.BENHAN_ID = '$BENHAN_ID$' and MGCT.REF_TABLE = 'TT_MIENGIAM_BHTN' and MG.TINHTRANG = 1 group by VIENPHI_ID
      )c on a.VIENPHI_ID = c.VIENPHI_ID

      left join (select VIENPHI_ID, sum(MGCT.GIATRIMIENGIAM) AS GIATRIMIENGIAM_THANHVIEN
      from TT_MIENGIAM_THANHVIEN MG
      INNER JOIN TT_MIENGIAM_CHITIET MGCT ON MG.MIENGIAM_THANHVIEN_ID = MGCT.MIENGIAM_ID
      where MG.TIEPNHAN_ID = '$TIEPNHAN_ID$' and MGCT.REF_TABLE = 'TT_MIENGIAM_THANHVIEN' and MG.TINHTRANG = 1 group by VIENPHI_ID
      )f on a.VIENPHI_ID = f.VIENPHI_ID

      left join(select VIENPHI_ID, sum(MGCT.GIATRIMIENGIAM) AS GIATRIMIENGIAM_CTCT
      from TT_MIENGIAM_CONGTY MG
      INNER JOIN TT_MIENGIAM_CHITIET MGCT ON MG.MIENGIAM_CONGTY_ID = MGCT.MIENGIAM_ID
      where MG.BENHAN_ID = '$BENHAN_ID$' and MGCT.REF_TABLE = 'TT_MIENGIAM_CONGTY' and MG.TINHTRANG = 1 group by VIENPHI_ID
      )g on a.VIENPHI_ID = g.VIENPHI_ID
    </statement>
    <statement id="DAO00304_GetVienPhiDot" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select vp.VIENPHI_ID
      from TT_NOITRU_DOTDIEUTRI_CHITIET dtct
      inner join TT_VIENPHI vp on vp.VIENPHI_ID = dtct.VIENPHI_ID
      where dtct.DOTDIEUTRI_ID IN (select regexp_substr('$DOTDIEUTRI_ID$','[^,]+', 1, level) from sys.dual
      connect by regexp_substr('$DOTDIEUTRI_ID$', '[^,]+', 1, level) is not null)
    </statement>
    <statement id="DAO00304_GetVienPhiWithKhamBenhId" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select *
      from TT_VIENPHI
      where REF_ID IN (select regexp_substr('$REF_ID$','[^,]+', 1, level) from sys.dual
      connect by regexp_substr('$REF_ID$', '[^,]+', 1, level) and KHAMBENH_ID = '$KHAMBENH_ID$' and BENHVIEN_ID = '$BENHVIEN_ID$'
    </statement>
    <statement id="DAO00304_GetDotCallBackVP" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select dt.DOTDIEUTRI_ID, dt.MADOTDIEUTRI
      from TT_HOADON hd
      inner join TT_HOADON_CHITIET_NOITRU ct on ct.HOADON_ID = hd.HOADON_ID
      inner join TT_VIENPHI vp on vp.VIENPHI_ID = ct.VIENPHI_ID
      inner join TT_NOITRU_DOTDIEUTRI_CHITIET dtct on dtct.VIENPHI_ID = vp.VIENPHI_ID
      inner join TT_NOITRU_DOTDIEUTRI dt on dt.DOTDIEUTRI_ID = dtct.DOTDIEUTRI_ID
      where hd.HOADON_ID = '$HOADON_ID$' and hd.BENHAN_ID = '$BENHAN_ID$' and hd.BENHVIEN_ID = '$BENHVIEN_ID$' AND ROWNUM = 1
    </statement>
    <statement id="DAO00304_DeleteNoiTruNhapVien" parameterClass="System.Collections.IDictionary" resultClass="System.Int32">
      delete from TT_NOITRU_NHAPVIEN
      where
      TIEPNHAN_ID = '$TIEPNHAN_ID$' and BENHNHAN_ID = '$BENHNHAN_ID$' and LOAIBENHAN = '$LOAIBENHAN$'
    </statement>
  </statements>
</sqlMap>
