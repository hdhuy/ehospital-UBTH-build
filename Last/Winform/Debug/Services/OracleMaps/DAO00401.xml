<?xml version="1.0" encoding="utf-8" ?>
<sqlMap namespace="eHospital" xmlns="http://ibatis.apache.org/mapping" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" >
 
  <statements>
    <statement id="DAO00401_GetList" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select ID AS LOAI_ID,MA AS MALOAI,TEN AS TENLOAI from TM_PUR_LOAI where BENHVIEN_ID = '$BENHVIEN_ID$' ORDER BY TEN
    </statement>
    <statement id="DAO00401_INV001_GetDMKHOVPP" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      SELECT 1 AS CHON,AA.DICTIONARY_CODE AS MAKHO,AA.DICTIONARY_NAME AS TENKHO,AA.DICTIONARY_CODE AS MAKHOXUAT,AA.DICTIONARY_NAME AS TENKHOXUAT,
      BB.SODU,BB.SODUDENNGAY,BB.KHOASO,BB.NGAYKHOA
      FROM LST_DICTIONARY AA LEFT JOIN TM_INV_KHO BB ON AA.DICTIONARY_CODE = BB.MAKHO
      WHERE AA.DICTIONARY_TYPE_CODE = 'KhoVPP'
    </statement>
    <statement id="DAO00401_INV001_GetTrangThaiNhapKhoVPP" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      SELECT DICTIONARY_CODE AS MATRANGTHAI,DICTIONARY_NAME AS TENTRANGTHAI FROM LST_DICTIONARY WHERE DICTIONARY_TYPE_CODE = 'TrangThaiVPP'
    </statement>
    <statement id="DAO00401_INV001_ChungTuPO" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select DISTINCT 0 AS CHON,CT.CHUNGTU_ID,CT.MACHUNGTU,CT.NGAYLAPCHUNGTU,CT.NGAYGIOLAPCHUNGTU,CT.PROCESS_CODE,CT.PROCESS_NAME,CT.STATE_CODE,CT.STATE_NAME,CT.PHONGBAN_ID,
      CT.TENPHONGBAN,CT.NGUOIDUYETCAP1_ID,CT.TENNGUOIDUYETCAP1,CT.NGAYGIODUYETCAP1,CT.NGUOIDUYETCAP2_ID,CT.TENNGUOIDUYETCAP2,CT.NGAYGIODUYETCAP2,CT.NGUOIDUYETCAP3_ID,
      CT.TENNGUOIDUYETCAP3,CT.NGAYGIODUYETCAP3,CT.CAPDUYET,CT.THOIGIANGIAOHANG,CT.NHACUNGCAP_ID,CT.TENNHACUNGCAP,CT.HINHTHUCGIAOHANG,CT.HINHTHUCTHANHTOAN,CT.TONGTIEN,CT.GHICHU,CT.DIENGIAI,
      CT.TENNGUOITAO,CT.TENNGUOICAPNHAT,CT.NGUOIPHANCONG_ID,CT.TENNGUOIPHANCONG,CT.NGAYPHANCONG,CT.NGAYCHAPNHAN,CT.NGAYTUCHOI,CT.THANHTOAN1,CT.THANHTOAN2,CT.THANHTOAN3,CT.THANHTOAN4,
      CT.THANHTOAN5,CT.THANHTOAN6,CT.BENHVIEN_ID,CT.NGAYTAO,CT.NGUOITAO_ID,CT.NGAYCAPNHAT,CT.NGUOICAPNHAT_ID,
      (CASE WHEN CT.STATE_CODE='3' THEN 'Đã duyệt bởi '+CT.TENNGUOIDUYETCAP1 ELSE CASE WHEN CT.STATE_CODE='4' THEN 'Đã từ chối bởi '+CT.TENNGUOIDUYETCAP1 ELSE CT.STATE_NAME END END) AS TRANGTHAI
      from TT_PUR_CHUNGTU CT INNER JOIN TT_PUR_CHUNGTUCHITIET CTCT ON CT.CHUNGTU_ID = CTCT.CHUNGTU_ID AND CTCT.SOLUONGYEUCAU-NVL(CTCT.SOLUONGDANHAP,0)>0
      where CT.BENHVIEN_ID = '$BENHVIEN_ID$' AND CT.NHACUNGCAP_ID = '$NHACUNGCAP_ID$' AND CT.PROCESS_CODE = 'PO' AND CT.MALOAIPHIEU='VPP' AND CTCT.SOLUONGYEUCAU-NVL(CTCT.SOLUONGDANHAP,0)>0 AND CT.STATE_CODE IN ($TRANGTHAIPO$)
      <isNotEmpty prepend="AND" property="TUNGAY">        
        TO_DATE(TO_CHAR(CT.NGAYLAPCHUNGTU,'MM/DD/YYYY'), 'MM/DD/YYYY') BETWEEN  TRUNC(TO_DATE('$TUNGAY$','MM/DD/YYYY HH:Mi:SS AM')) and TRUNC(TO_DATE('$DENNGAY$','MM/DD/YYYY HH:Mi:SS AM'))
      </isNotEmpty>
      ORDER BY NGAYLAPCHUNGTU
    </statement>
    <statement id="DAO00401_INV001_GetChungTuChiTietPO_ChungTuID" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select CTCT.CHUNGTUCHITIET_ID,CTCT.CHUNGTU_ID,CTCT.HANGHOA_ID,CTCT.MAHANGHOA,CTCT.TENHANGHOA,CTCT.DONVITINH_ID,CTCT.TENDONVITINH,CTCT.LOAI_ID,CTCT.TENLOAI,SOLUONGYEUCAU,CTCT.MOTA,
      CTCT.THUONGHIEU,CTCT.KICHTHUOC,CTCT.VATLIEU,CTCT.GHICHU AS CT_GHICHU,CTCT.FILE_NAME,CTCT.FULLPATHSERVER,CTCT.FULLPATHLOCAL,CTCT.SIZE,CTCT.FILE_NAME_PO,CTCT.FULLPATHSERVER_PO,CTCT.FULLPATHLOCAL_PO,CTCT.SIZE_PO,CTCT.STATE_CODE AS CT_STATE_CODE,CTCT.STATE_NAME AS CT_STATE_NAME,CTCT.NGUOIDUYET_ID AS CT_NGUOIDUYET_ID,CTCT.TENNGUOIDUYET AS CT_TENNGUOIDUYET,CTCT.NGAYGIODUYET AS CT_NGAYGIODUYET,
      CTCT.MACHONGIA,CTCT.TENCHONGIA,CTCT.DONGIA,CTCT.TYLEVAT,CTCT.GIATRIVAT,CTCT.DONGIASAUVAT,CTCT.THANHTIEN,CTCT.NHACUNGCAP_ID AS CT_NHACUNGCAP_ID,CTCT.TENNHACUNGCAP AS CT_TENNHACUNGCAP,CTCT.DONGIAHOPDONG,CTCT.TUNGAYHOPDONG, CTCT.DENNGAYHOPDONG,CTCT.MATONGHOP,
      CTCT.CHUNGTUTONGHOP_ID,CTCT.MALOAIPHIEU,CTCT.BAOHANHTUNGAY,CTCT.BAOHANHDENNGAY,CTCT.TENNGUOITAO,CTCT.TENNGUOICAPNHAT,CTCT.NGAYTAO,CTCT.NGUOITAO_ID,CTCT.NGAYCAPNHAT,CTCT.NGUOICAPNHAT_ID
      from TT_PUR_CHUNGTUCHITIET CTCT
      where CTCT.BENHVIEN_ID = '$BENHVIEN_ID$' AND CTCT.CHUNGTU_ID = '$CHUNGTUPHIEUPO_ID$'
      ORDER BY TENHANGHOA
    </statement>
    <statement id="DAO00401_INV001_GetChiTietPO_MaChungTu" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select CT.MACHUNGTU,CT.NHACUNGCAP_ID,CT.TENNHACUNGCAP,CTCT.CHUNGTUCHITIET_ID AS CHUNGTULIENQUANCHITIET_ID,CTCT.CHUNGTU_ID AS CHUNGTULIENQUAN_ID,CTCT.HANGHOA_ID,CTCT.MAHANGHOA,CTCT.TENHANGHOA,CTCT.DONVITINH_ID,CTCT.TENDONVITINH,CTCT.LOAI_ID,CTCT.TENLOAI,CTCT.SOLUONGYEUCAU,
      (CTCT.SOLUONGYEUCAU-NVL(SOLUONGDANHAP,0)) AS SOLUONGCONLAI, (CTCT.SOLUONGYEUCAU-NVL(SOLUONGDANHAP,0)) AS SOLUONGNHAP, CTCT.MOTA,
      CTCT.THUONGHIEU,CTCT.KICHTHUOC,CTCT.VATLIEU,CTCT.GHICHU AS CT_GHICHU,CTCT.FILE_NAME,CTCT.FULLPATHSERVER,CTCT.FULLPATHLOCAL,CTCT.SIZE,CTCT.FILE_NAME_PO,CTCT.FULLPATHSERVER_PO,CTCT.FULLPATHLOCAL_PO,CTCT.SIZE_PO,CTCT.STATE_CODE AS CT_STATE_CODE,CTCT.STATE_NAME AS CT_STATE_NAME,CTCT.NGUOIDUYET_ID AS CT_NGUOIDUYET_ID,CTCT.TENNGUOIDUYET AS CT_TENNGUOIDUYET,CTCT.NGAYGIODUYET AS CT_NGAYGIODUYET,
      CTCT.MACHONGIA,CTCT.TENCHONGIA,CTCT.DONGIA,CTCT.TYLEVAT,CTCT.GIATRIVAT,CTCT.DONGIASAUVAT,CTCT.THANHTIEN, CTCT.THANHTIEN AS THANHTIENSAUVAT, CTCT.NHACUNGCAP_ID AS CT_NHACUNGCAP_ID,CTCT.TENNHACUNGCAP AS CT_TENNHACUNGCAP,CTCT.DONGIAHOPDONG,CTCT.TUNGAYHOPDONG, CTCT.DENNGAYHOPDONG,CTCT.MATONGHOP,
      CTCT.CHUNGTUTONGHOP_ID,CTCT.MALOAIPHIEU,CTCT.BAOHANHTUNGAY,CTCT.BAOHANHDENNGAY,CTCT.TENNGUOITAO,CTCT.TENNGUOICAPNHAT,CTCT.NGAYTAO,CTCT.NGUOITAO_ID,CTCT.NGAYCAPNHAT,CTCT.NGUOICAPNHAT_ID
      from TT_PUR_CHUNGTUCHITIET CTCT INNER JOIN TT_PUR_CHUNGTU CT ON CT.CHUNGTU_ID=CTCT.CHUNGTU_ID
      where CTCT.BENHVIEN_ID = '$BENHVIEN_ID$' AND CT.MACHUNGTU = '$MACHUNGTULIENQUAN$' AND CTCT.SOLUONGYEUCAU-NVL(CTCT.SOLUONGDANHAP,0)>0
      ORDER BY TENHANGHOA
    </statement>
    <statement id="DAO00401_INV001_KiemTraMaChungTuNhapTonTai" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select SUM(CTCT.SOLUONGNHAP) AS SOLUONGNHAP, SUM(TKCT.SOLUONGXUAT) AS SOLUONGXUAT,CT.IDCHUYEN
      FROM TT_INV_CHUNGTUNHAP CT INNER JOIN TT_INV_CHUNGTUNHAPCHITIET CTCT ON CT.CHUNGTUNHAP_ID=CTCT.CHUNGTUNHAP_ID AND CT.MMYY='$MMYY$'
      INNER JOIN TT_INV_THEODOI TD ON CTCT.THEODOI_ID=TD.THEODOI_ID
      LEFT JOIN TT_INV_TONKHOCHITIET TKCT ON TD.THEODOI_ID=TKCT.THEODOI_ID
      where CT.MMYY='$MMYY$' AND CT.CHUNGTUNHAP_ID = '$CHUNGTUNHAP_ID$' AND CT.BENHVIEN_ID = '$BENHVIEN_ID$'
      GROUP BY CT.IDCHUYEN
    </statement>
    <insert id="DAO00401_INV001_AddChungTuNhap" parameterClass="System.Collections.IDictionary" resultClass="System.Int64">
      <selectKey property="ID" type="pre" resultClass="System.Int64">
        select TT_INV_CHUNGTUNHAP_CHUNGTU_SEQ.nextval as value from dual
      </selectKey>
      INSERT INTO TT_INV_CHUNGTUNHAP
      (CHUNGTUNHAP_ID,MACHUNGTU,MMYY,NGAYCHUNGTU,NHACUNGCAP_ID,TENNHACUNGCAP,MAKHO,TENKHO,NGUOINHAP_ID,TENNGUOINHAP,TENNGUOIGIAO,KYHIEUHOADON,SOSERI,SOHOADON,NGAYHOADON,MATRANGTHAI,TENTRANGTHAI,
      TYLECHIETKHAU,GIATRICHIETKHAU,THANHTIEN,THANHTIENSAUCUNG,GHICHU,CHUNGTULIENQUAN_ID,MACHUNGTULIENQUAN,BENHVIEN_ID,NGAYTAO,NGUOITAO_ID)
      VALUES
      (#ID#,#MACHUNGTU#,#MMYY#,#NGAYCHUNGTU#,#NHACUNGCAP_ID#,#TENNHACUNGCAP#,#MAKHO#,#TENKHO#,#NGUOINHAP_ID#,#TENNGUOINHAP#,#TENNGUOIGIAO#,#KYHIEUHOADON#,#SOSERI#,#SOHOADON#,#NGAYHOADON#,
      #MATRANGTHAI#,#TENTRANGTHAI#,#TYLECHIETKHAU#,#GIATRICHIETKHAU#,#THANHTIEN#,#THANHTIENSAUCUNG#,#GHICHU#,#CHUNGTULIENQUAN_ID#,#MACHUNGTULIENQUAN#,#BENHVIEN_ID#,SYSDATE,#NGUOITAO_ID#)      
    </insert>
    <update id="DAO00401_INV001_UpdChungTuNhap" parameterClass="DataObject">
      UPDATE TT_INV_CHUNGTUNHAP
      SET MMYY = #MMYY#,NGAYCHUNGTU = #NGAYCHUNGTU#,NHACUNGCAP_ID = #NHACUNGCAP_ID#,TENNHACUNGCAP = #TENNHACUNGCAP#,MAKHO = #MAKHO#,TENKHO = #TENKHO#,NGUOINHAP_ID = #NGUOINHAP_ID#,TENNGUOINHAP = #TENNGUOINHAP#,
      TENNGUOIGIAO = #TENNGUOIGIAO#,KYHIEUHOADON = #KYHIEUHOADON#,SOSERI = #SOSERI#,SOHOADON = #SOHOADON#,NGAYHOADON = #NGAYHOADON#,MATRANGTHAI = #MATRANGTHAI#,TENTRANGTHAI = #TENTRANGTHAI#,TYLECHIETKHAU = #TYLECHIETKHAU#,
      GIATRICHIETKHAU = #GIATRICHIETKHAU#,THANHTIEN = #THANHTIEN#,THANHTIENSAUCUNG = #THANHTIENSAUCUNG#,GHICHU = #GHICHU#,CHUNGTULIENQUAN_ID = #CHUNGTULIENQUAN_ID#,MACHUNGTULIENQUAN = #MACHUNGTULIENQUAN#,
      BENHVIEN_ID = #BENHVIEN_ID#,NGAYCAPNHAT = SYSDATE,NGUOICAPNHAT_ID = #NGUOICAPNHAT_ID#
      WHERE CHUNGTUNHAP_ID = '$CHUNGTUNHAP_ID$'
    </update>
    <insert id="DAO00401_INV001_AddChungTuNhapChiTiet" parameterClass="System.String" resultClass="System.Int64">
      <selectKey property="ID" type="pre" resultClass="System.Int64">
        select TT_INV_CHUNGTUNHAPCHITIET__SEQ.nextval as value from dual
      </selectKey>
      INSERT INTO TT_INV_THEODOI(MMYY,HANGHOA_ID,MAHANGHOA,TENHANGHOA,DONVITINH_ID,TENDONVITINH,HANDUNG,LOSX,DONGIA,DONGIASAUVAT,TYLEVAT,TENNGUOITAO,BENHVIEN_ID,NGAYTAO,NGUOITAO_ID)
      VALUES (#MMYY#,#HANGHOA_ID#,#MAHANGHOA#,#TENHANGHOA#,#DONVITINH_ID#,#TENDONVITINH#,#HANDUNG#,#LOSX#,#DONGIA#,#DONGIASAUVAT#,#TYLEVAT#,#TENNGUOITAO#,#BENHVIEN_ID#,SYSDATE,#NGUOITAO_ID#)

      INSERT INTO TT_INV_CHUNGTUNHAPCHITIET(CHUNGTUNHAPCHITIET_ID,CHUNGTUNHAP_ID,MMYY,THEODOI_ID,SOLUONGYEUCAU,SOLUONGCONLAI,SOLUONGNHAP,GIATRIVAT,THANHTIENTRUOCVAT,THANHTIENSAUVAT,NGAYDUKIEN,GHICHU,CHUNGTULIENQUANCHITIET_ID,KHUYENMAI,TENNGUOITAO,BENHVIEN_ID,NGAYTAO,NGUOITAO_ID)
      VALUES (#ID#,#CHUNGTUNHAP_ID#,#MMYY#,SCOPE_IDENTITY(),#SOLUONGYEUCAU#,#SOLUONGCONLAI#,#SOLUONGNHAP#,#GIATRIVAT#,#THANHTIENTRUOCVAT#,#THANHTIENSAUVAT#,#NGAYDUKIEN#,#CT_GHICHU#,#CHUNGTULIENQUANCHITIET_ID#,#KHUYENMAI#,#TENNGUOITAO#,#BENHVIEN_ID#,#NGAYTAO#,#NGUOITAO_ID#)      
    </insert>
    <statement id="DAO00401_INV001_DelChungTuNhapChiTiet" parameterClass="System.String" resultClass="System.Int64">
      DELETE FROM TT_INV_CHUNGTUNHAPCHITIET WHERE MMYY='$MMYY$' AND CHUNGTUNHAP_ID='$CHUNGTUNHAP_ID$';
      <!--DELETE FROM TT_INV_THEODOI WHERE MMYY='$MMYY$' AND THEODOI_ID IN($LISTTHEODOI_ID$);-->
    </statement>
     <statement id="DAO00401_INV001_DelChungTuNhapAll" parameterClass="System.String" resultClass="System.Int64">
       DELETE FROM TT_INV_CHUNGTUNHAPCHITIET WHERE MMYY='$MMYY$' AND CHUNGTUNHAP_ID='$CHUNGTUNHAP_ID$';
       <!--DELETE FROM TT_INV_THEODOI WHERE MMYY='$MMYY$' AND THEODOI_ID IN($LISTTHEODOI_ID$);-->
       DELETE FROM TT_INV_CHUNGTUNHAP WHERE MMYY='$MMYY$' AND CHUNGTUNHAP_ID='$CHUNGTUNHAP_ID$';
     </statement>
    <statement id="DAO00401_INV001_DelChungTuNhapChiTietTheoID" parameterClass="System.String" resultClass="System.Int64">
      DELETE FROM TT_INV_CHUNGTUNHAPCHITIET WHERE MMYY='$MMYY$' AND CHUNGTUNHAPCHITIET_ID='$CHUNGTUNHAPCHITIET_ID$';
      <!--DELETE FROM TT_INV_THEODOI WHERE MMYY='$MMYY$' AND THEODOI_ID=$LISTTHEODOI_ID$;-->
    </statement>
    <statement id="DAO00401_INV001_UpdSLDaNhap_ChungTuChiTietID" parameterClass="DataObject">
      UPDATE TT_PUR_CHUNGTUCHITIET SET SOLUONGDANHAP=0 WHERE CHUNGTUCHITIET_ID IN($LISTCHUNGTUCHITIET_ID$);
      MERGE TT_PUR_CHUNGTUCHITIET AS X USING
      (SELECT SUM(B.SOLUONGNHAP) AS SOLUONGDANHAP,B.CHUNGTULIENQUANCHITIET_ID
      FROM TT_INV_CHUNGTUNHAP A INNER JOIN TT_INV_CHUNGTUNHAPCHITIET B ON A.CHUNGTUNHAP_ID=B.CHUNGTUNHAP_ID AND B.CHUNGTULIENQUANCHITIET_ID IN($LISTCHUNGTUCHITIET_ID$)
      INNER JOIN TT_INV_THEODOI C ON B.THEODOI_ID=C.THEODOI_ID
      WHERE A.MATRANGTHAI='DaNhapKho' AND A.BENHVIEN_ID='$BENHVIEN_ID$'
      GROUP BY B.CHUNGTULIENQUANCHITIET_ID) AS Y
      ON (X.CHUNGTUCHITIET_ID=Y.CHUNGTULIENQUANCHITIET_ID)
      WHEN MATCHED THEN UPDATE SET X.SOLUONGDANHAP=Y.SOLUONGDANHAP;
    </statement>
    <statement id="DAO00401_INV001_UpdSLNhapTonKho" parameterClass="DataObject">
      UPDATE TT_INV_TONKHOCHITIET SET SOLUONGNHAP=0 WHERE MMYY='$MMYY$' AND MAKHO IN($LISTMAKHO$);
      MERGE TT_INV_TONKHOCHITIET AS X USING
      (SELECT QQ.MMYY, QQ.MAKHO,QQ.TENKHO,QQ.THEODOI_ID,SUM(QQ.SOLUONGNHAP) AS SOLUONGNHAP,QQ.NGAYTAO,QQ.NGUOITAO_ID FROM (
      SELECT '$MMYY$' AS MMYY, A.MAKHO,A.TENKHO,B.THEODOI_ID,B.SOLUONGNHAP,C.NGAYTAO,C.NGUOITAO_ID
      FROM TT_INV_CHUNGTUNHAP A INNER JOIN TT_INV_CHUNGTUNHAPCHITIET B ON A.CHUNGTUNHAP_ID=B.CHUNGTUNHAP_ID AND A.MMYY='$MMYY$'
      INNER JOIN TT_INV_THEODOI C ON B.THEODOI_ID=C.THEODOI_ID
      WHERE A.MMYY='$MMYY$' AND A.MATRANGTHAI='DaNhapKho' AND A.BENHVIEN_ID='$BENHVIEN_ID$' AND A.MAKHO IN($LISTMAKHO$)
      UNION ALL
      SELECT '$MMYY$' AS MMYY, A.MAKHO,A.TENKHO,B.THEODOI_ID,B.SOLUONG AS SOLUONGNHAP,C.NGAYTAO,C.NGUOITAO_ID
      FROM TT_INV_CHUNGTUTANGGIAM A INNER JOIN TT_INV_CHUNGTUTANGGIAMCHITIET B ON A.CHUNGTUTANGGIAM_ID=B.CHUNGTUTANGGIAM_ID AND A.MMYY='$MMYY$' AND A.LOAI='tang'
      INNER JOIN TT_INV_THEODOI C ON B.THEODOI_ID=C.THEODOI_ID
      WHERE A.MMYY='$MMYY$' AND A.LOAI='tang' AND A.BENHVIEN_ID='$BENHVIEN_ID$' AND A.MAKHO IN($LISTMAKHO$)) QQ
      GROUP BY QQ.MMYY, QQ.MAKHO,QQ.TENKHO,QQ.THEODOI_ID,QQ.NGAYTAO,QQ.NGUOITAO_ID) AS Y
      ON (X.MMYY=Y.MMYY AND X.MAKHO=Y.MAKHO AND X.THEODOI_ID=Y.THEODOI_ID)
      WHEN MATCHED THEN UPDATE SET X.SOLUONGNHAP=Y.SOLUONGNHAP
      WHEN NOT MATCHED THEN
      INSERT (MMYY,MAKHO,TENKHO,THEODOI_ID,SOLUONGNHAP,BENHVIEN_ID,NGAYTAO,NGUOITAO_ID) VALUES
      ('$MMYY$',Y.MAKHO,Y.TENKHO,Y.THEODOI_ID,Y.SOLUONGNHAP,#BENHVIEN_ID#,Y.NGAYTAO,Y.NGUOITAO_ID);

      UPDATE TT_INV_TONKHOTONGHOP SET SOLUONGTONDAU=0,SOLUONGNHAP=0,SOLUONGXUAT=0 WHERE MMYY='$MMYY$' AND MAKHO IN($LISTMAKHO$);
      MERGE TT_INV_TONKHOTONGHOP AS X USING
      (SELECT '$MMYY$' AS MMYY,A.MAKHO,A.TENKHO,B.HANGHOA_ID,B.MAHANGHOA,B.TENHANGHOA,SUM(A.SOLUONGTONDAU) AS SOLUONGTONDAU,SUM(A.SOLUONGNHAP) AS SOLUONGNHAP,SUM(A.SOLUONGXUAT) AS SOLUONGXUAT
      FROM TT_INV_TONKHOCHITIET A INNER JOIN TT_INV_THEODOI B ON A.THEODOI_ID=B.THEODOI_ID AND A.MMYY='$MMYY$'
      WHERE A.MMYY='$MMYY$' AND A.BENHVIEN_ID='$BENHVIEN_ID$' AND A.MAKHO IN($LISTMAKHO$)
      GROUP BY A.MAKHO,A.TENKHO,B.HANGHOA_ID,B.MAHANGHOA,B.TENHANGHOA) Y
      ON (X.MMYY=Y.MMYY AND X.MAKHO=Y.MAKHO AND X.HANGHOA_ID=Y.HANGHOA_ID)
      WHEN MATCHED THEN UPDATE SET X.SOLUONGTONDAU=Y.SOLUONGTONDAU, X.SOLUONGNHAP=Y.SOLUONGNHAP,X.SOLUONGXUAT=Y.SOLUONGXUAT
      WHEN NOT MATCHED THEN
      INSERT (MMYY,MAKHO,TENKHO,HANGHOA_ID,MAHANGHOA,TENHANGHOA,SOLUONGTONDAU,SOLUONGNHAP,SOLUONGXUAT,BENHVIEN_ID,NGAYTAO)
      VALUES ('$MMYY$',Y.MAKHO,Y.TENKHO,Y.HANGHOA_ID,Y.MAHANGHOA,Y.TENHANGHOA,Y.SOLUONGTONDAU,Y.SOLUONGNHAP,Y.SOLUONGXUAT,#BENHVIEN_ID#,SYSDATE);

      DELETE FROM TT_INV_TONKHOCHITIET WHERE SOLUONGTONDAU=0 AND SOLUONGNHAP=0 AND SOLUONGXUAT=0;
      DELETE FROM TT_INV_TONKHOTONGHOP WHERE SOLUONGTONDAU=0 AND SOLUONGNHAP=0 AND SOLUONGXUAT=0;
    </statement>
  <statement id="DAO00401_INV001_GetChungTuNhap" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      SELECT CT.CHUNGTUNHAP_ID,CT.MACHUNGTU,CT.MMYY,CT.NGAYCHUNGTU,CT.NHACUNGCAP_ID,CT.TENNHACUNGCAP,CT.MAKHO,CT.TENKHO,CT.NGUOINHAP_ID,CT.TENNGUOINHAP,CT.TENNGUOIGIAO,
      CT.KYHIEUHOADON,CT.SOSERI,CT.SOHOADON,CT.NGAYHOADON,CT.MATRANGTHAI,CT.TENTRANGTHAI,CT.TYLECHIETKHAU,CT.GIATRICHIETKHAU,CT.THANHTIEN,CT.THANHTIENSAUCUNG,CT.GHICHU,
      CT.CHUNGTULIENQUAN_ID,CT.MACHUNGTULIENQUAN,CT.BENHVIEN_ID,CT.NGAYTAO,CT.NGUOITAO_ID,CT.NGAYCAPNHAT,CT.NGUOICAPNHAT_ID
      FROM TT_INV_CHUNGTUNHAP CT where CT.BENHVIEN_ID = '$BENHVIEN_ID$' AND CT.MMYY IN($MMYY$)
      <isNotEmpty prepend="AND" property="MACHUNGTU">
        CT.MACHUNGTU LIKE '%$MACHUNGTU$%'
      </isNotEmpty>
    <isNotEmpty prepend="AND" property="TUNGAY">
       CT.NGAYCHUNGTU BETWEEN '$TUNGAY$' AND '$DENNGAY$'
      </isNotEmpty>
    <isNotEmpty prepend="AND" property="NHACUNGCAP_ID">
        CT.NHACUNGCAP_ID = '$NHACUNGCAP_ID$'
      </isNotEmpty>
      ORDER BY CT.NGAYCHUNGTU
    </statement>
  <statement id="DAO00401_INV001_GetChungTuNhapAll" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
    SELECT CT.CHUNGTUNHAP_ID,CT.MACHUNGTU,CT.MMYY,CT.NGAYCHUNGTU,CT.NHACUNGCAP_ID,CT.TENNHACUNGCAP,CT.MAKHO,CT.TENKHO,CT.NGUOINHAP_ID,CT.TENNGUOINHAP,CT.TENNGUOIGIAO,
    CT.KYHIEUHOADON,CT.SOSERI,CT.SOHOADON,CT.NGAYHOADON,CT.MATRANGTHAI,CT.TENTRANGTHAI,CT.TYLECHIETKHAU,CT.GIATRICHIETKHAU,CT.THANHTIEN,CT.THANHTIENSAUCUNG,CT.GHICHU,
    CT.CHUNGTULIENQUAN_ID,CT.MACHUNGTULIENQUAN,CTCT.TENNGUOITAO,CT.IDCHUYEN,CT.BENHVIEN_ID,CT.NGAYTAO,CT.NGUOITAO_ID,CT.NGAYCAPNHAT,CT.NGUOICAPNHAT_ID,
    (CASE WHEN CT.IDCHUYEN IS NULL THEN NULL ELSE 'Đã chuyển EAccount' END) AS CHUYENEACCOUNT,
    CTCT.CHUNGTUNHAPCHITIET_ID,CTCT.SOLUONGYEUCAU,CTCT.SOLUONGCONLAI,CTCT.SOLUONGNHAP,CTCT.GIATRIVAT,CTCT.THANHTIENTRUOCVAT,
    CTCT.THANHTIENSAUVAT,CTCT.NGAYDUKIEN,CTCT.GHICHU AS CT_GHICHU,CTCT.CHUNGTULIENQUANCHITIET_ID,CTCT.KHUYENMAI,
    TD.THEODOI_ID,TD.HANGHOA_ID,TD.MAHANGHOA,TD.TENHANGHOA,TD.DONVITINH_ID,TD.TENDONVITINH,TD.HANDUNG,TD.LOSX,TD.DONGIA,TD.DONGIASAUVAT,TD.TYLEVAT,
    TKCT.SOLUONGXUAT
    FROM TT_INV_CHUNGTUNHAP CT INNER JOIN TT_INV_CHUNGTUNHAPCHITIET CTCT ON CT.CHUNGTUNHAP_ID=CTCT.CHUNGTUNHAP_ID
    <isNotEmpty prepend="AND" property="MMYY">
      CT.MMYY IN($MMYY$)
    </isNotEmpty>
    INNER JOIN TT_INV_THEODOI TD ON CTCT.THEODOI_ID=TD.THEODOI_ID LEFT JOIN TT_INV_TONKHOCHITIET TKCT ON TKCT.THEODOI_ID=TD.THEODOI_ID
    where CT.BENHVIEN_ID = '$BENHVIEN_ID$' AND CT.MACHUNGTU = '$MACHUNGTU$'
    <isNotEmpty prepend="AND" property="MMYY">
      CT.MMYY IN($MMYY$)
    </isNotEmpty>
    ORDER BY TD.TENHANGHOA
  </statement>
    <statement id="DAO00401_INV001_KiemTraMaPhieuYeuCauDaXuatKho" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select SUM(CTCT.SOLUONGDAXUAT) AS SOLUONGDAXUAT
      FROM TT_INV_PHIEUYEUCAU CT INNER JOIN TT_INV_PHIEUYEUCAUCHITIET CTCT ON CT.PHIEUYEUCAU_ID=CTCT.PHIEUYEUCAU_ID AND CT.MMYY='$MMYY$'
      where CT.MMYY='$MMYY$' AND CT.PHIEUYEUCAU_ID = '$PHIEUYEUCAU_ID$' AND CT.BENHVIEN_ID = '$BENHVIEN_ID$'
    </statement>
    <statement id="DAO00401_INV001_KiemTraMaPhieuYeuCauTonTai" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select CT.MAPHIEUYEUCAU
      FROM TT_INV_PHIEUYEUCAU CT
      where CT.MAPHIEUYEUCAU = '$MAPHIEUYEUCAU$' AND CT.BENHVIEN_ID = '$BENHVIEN_ID$'
    </statement>
    <statement id="DAO00401_INV001_GetTonKho" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      SELECT TKTH.HANGHOA_ID,TKTH.MAHANGHOA,TKTH.TENHANGHOA,HH.DONVITINH_ID,HH.TENDONVITINH,SUM(TKTH.SOLUONGTONDAU+TKTH.SOLUONGNHAP-TKTH.SOLUONGXUAT) AS SOLUONGTONCUOI
      FROM TM_PUR_HANGHOA HH INNER JOIN TT_INV_TONKHOTONGHOP TKTH ON HH.ID = TKTH.HANGHOA_ID
      where TKTH.MMYY='$MMYY$' AND TKTH.BENHVIEN_ID = '$BENHVIEN_ID$' AND TKTH.MAKHO = '$MAKHO$'
      GROUP BY TKTH.HANGHOA_ID,TKTH.MAHANGHOA,TKTH.TENHANGHOA,HH.DONVITINH_ID,HH.TENDONVITINH
    </statement>
     <statement id="DAO00401_INV001_GetTonKhoChiTiet" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
       SELECT TD.THEODOI_ID,TD.HANGHOA_ID,TD.MAHANGHOA,TD.TENHANGHOA,TD.DONVITINH_ID,TD.TENDONVITINH,TD.DONGIA AS DONGIATRUOCVAT,TD.DONGIASAUVAT AS DONGIA,CASE WHEN TD.HANDUNG IS NULL THEN DATEADD(YEAR,999, SYSDATE) ELSE TD.HANDUNG END AS HANDUNG ,TD.NGAYTAO,
       SUM(TKCT.SOLUONGTONDAU+TKCT.SOLUONGNHAP-TKCT.SOLUONGXUAT) AS SOLUONGTONCUOI
       FROM TM_PUR_HANGHOA HH INNER JOIN TT_INV_THEODOI TD ON HH.ID = TD.HANGHOA_ID
       INNER JOIN TT_INV_TONKHOCHITIET TKCT ON TD.THEODOI_ID = TKCT.THEODOI_ID
       where TKCT.MMYY='$MMYY$' AND TKCT.BENHVIEN_ID = '$BENHVIEN_ID$' AND TKCT.MAKHO = '$MAKHO$'
       GROUP BY TD.THEODOI_ID,TD.HANGHOA_ID,TD.MAHANGHOA,TD.TENHANGHOA,TD.DONVITINH_ID,TD.TENDONVITINH,TD.DONGIA,TD.DONGIASAUVAT,TD.HANDUNG,TD.NGAYTAO
       ORDER BY TD.NGAYTAO
     </statement>
    <statement id="DAO00401_INV001_GetTonKhoChiTietTongTon" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      SELECT TD.THEODOI_ID,TD.HANGHOA_ID,TD.MAHANGHOA,TD.TENHANGHOA,TD.DONVITINH_ID,TD.TENDONVITINH,TD.DONGIA AS DONGIATRUOCVAT,TD.DONGIASAUVAT AS DONGIA,TO_CHAR(TD.HANDUNG,'DD/MM/YYYY') HANDUNG,TD.LOSX,TO_CHAR(TD.NGAYTAO,'DD/MM/YYYY:HH24:Mi') NGAYTAO,
      SUM(TKCT.SOLUONGTONDAU+TKCT.SOLUONGNHAP-TKCT.SOLUONGXUAT) AS SOLUONGTONCHITIET,SUM(TKTH.SOLUONGTONDAU+TKTH.SOLUONGNHAP-TKTH.SOLUONGXUAT) AS SOLUONGTONCUOI
      FROM TM_PUR_HANGHOA HH INNER JOIN TT_INV_THEODOI TD ON HH.ID = TD.HANGHOA_ID
      INNER JOIN TT_INV_TONKHOTONGHOP TKTH ON HH.ID = TKTH.HANGHOA_ID AND TKTH.MMYY='$MMYY$'
      INNER JOIN TT_INV_TONKHOCHITIET TKCT ON TD.THEODOI_ID = TKCT.THEODOI_ID AND TKCT.MMYY='$MMYY$'
      where TKCT.MMYY='$MMYY$' AND TKCT.BENHVIEN_ID = '$BENHVIEN_ID$' AND TKCT.MAKHO = '$MAKHO$'
      GROUP BY TD.THEODOI_ID,TD.HANGHOA_ID,TD.MAHANGHOA,TD.TENHANGHOA,TD.DONVITINH_ID,TD.TENDONVITINH,TD.DONGIA,TD.DONGIASAUVAT,TD.HANDUNG,TD.NGAYTAO,TD.LOSX
      <isNotEmpty prepend="" property="LISTCHUNGTUTANGGIAMCHITIET_ID">
        UNION ALL
        SELECT TD.THEODOI_ID,TD.HANGHOA_ID,TD.MAHANGHOA,TD.TENHANGHOA,TD.DONVITINH_ID,TD.TENDONVITINH,TD.DONGIA AS DONGIATRUOCVAT,TD.DONGIASAUVAT AS DONGIA,TO_CHAR(TD.HANDUNG,'DD/MM/YYYY') HANDUNG,TD.LOSX,TO_CHAR(TD.NGAYTAO,'DD/MM/YYYY:HH24:Mi') NGAYTAO,
        0 AS SOLUONGTONCHITIET,0 AS SOLUONGTONCUOI
        FROM TM_PUR_HANGHOA HH INNER JOIN TT_INV_THEODOI TD ON HH.ID = TD.HANGHOA_ID
        INNER JOIN TT_INV_TONKHOTONGHOP TKTH ON HH.ID = TKTH.HANGHOA_ID
        INNER JOIN TT_INV_TONKHOCHITIET TKCT ON TD.THEODOI_ID = TKCT.THEODOI_ID
        INNER JOIN TT_INV_CHUNGTUTANGGIAMCHITIET CTCT ON TD.THEODOI_ID=CTCT.THEODOI_ID
        WHERE CTCT.CHUNGTUTANGGIAMCHITIET_ID IN($LISTCHUNGTUTANGGIAMCHITIET_ID$)
      </isNotEmpty>
      <!--ORDER BY TD.TENHANGHOA-->
    </statement>
    <statement id="DAO00401_INV001_DelPhieuYeuCauAll" parameterClass="System.String" resultClass="System.Int64">
      DELETE FROM TT_INV_PHIEUYEUCAUCHITIET WHERE MMYY='$MMYY$' AND PHIEUYEUCAU_ID='$PHIEUYEUCAU_ID$' AND BENHVIEN_ID = '$BENHVIEN_ID$';
      DELETE FROM TT_INV_PHIEUYEUCAU WHERE MMYY='$MMYY$' AND PHIEUYEUCAU_ID='$PHIEUYEUCAU_ID$' AND BENHVIEN_ID = '$BENHVIEN_ID$';
    </statement>
    <statement id="DAO00401_INV001_DelPhieuYeuCauChiTietTheoID" parameterClass="System.String" resultClass="System.Int64">
      DELETE FROM TT_INV_PHIEUYEUCAUCHITIET WHERE MMYY='$MMYY$' AND PHIEUYEUCAUCHITIET_ID='$PHIEUYEUCAUCHITIET_ID$' AND BENHVIEN_ID = '$BENHVIEN_ID$';
    </statement>
    <statement id="DAO00401_INV001_GetPhieuYeuCau" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select YC.PHIEUYEUCAU_ID,YC.MAPHIEUYEUCAU,YC.MMYY,YC.NGAYLAP,YC.PHONGBAN_ID,YC.TENPHONGBAN,YC.MAKHOXUAT,YC.TENKHOXUAT,YC.GHICHU,YC.TENNGUOITAO,YC.TENNGUOICAPNHAT,YC.BENHVIEN_ID,YC.NGAYTAO,YC.NGUOITAO_ID,YC.NGAYCAPNHAT,YC.NGUOICAPNHAT_ID,
      YCCT.PHIEUYEUCAUCHITIET_ID,YCCT.HANGHOA_ID,YCCT.MAHANGHOA,YCCT.TENHANGHOA,YCCT.DONVITINH_ID,YCCT.TENDONVITINH,YCCT.SOLUONGYEUCAU,YCCT.SOLUONGDAXUAT
      FROM TT_INV_PHIEUYEUCAU YC INNER JOIN TT_INV_PHIEUYEUCAUCHITIET YCCT ON YC.PHIEUYEUCAU_ID=YCCT.PHIEUYEUCAU_ID
      where YC.MAPHIEUYEUCAU='$MAPHIEUYEUCAU$' AND YC.BENHVIEN_ID = '$BENHVIEN_ID$'
      <isNotEmpty prepend="AND" property="NGUOITAO_ID">
        YC.NGUOITAO_ID = '$NGUOITAO_ID$'
      </isNotEmpty>
    </statement>
    <insert id="DAO00401_INV001_AddPhieuYeuCau" parameterClass="System.String" resultClass="System.Int64">
      <selectKey property="ID" type="pre" resultClass="System.Int64">
        select TT_INV_PHIEUYEUCAU_PHIEUYE_SEQ.nextval as value from dual
      </selectKey>
      INSERT INTO TT_INV_PHIEUYEUCAU(PHIEUYEUCAU_ID,MAPHIEUYEUCAU,MMYY,NGAYLAP,PHONGBAN_ID,TENPHONGBAN,MAKHOXUAT,TENKHOXUAT,GHICHU,TENNGUOITAO,BENHVIEN_ID,NGAYTAO,NGUOITAO_ID)
      VALUES(#ID#,#MAPHIEUYEUCAU#,#MMYY#,#NGAYLAP#,#PHONGBAN_ID#,#TENPHONGBAN#,#MAKHOXUAT#,#TENKHOXUAT#,#GHICHU#,#TENNGUOITAO#,#BENHVIEN_ID#,SYSDATE,#NGUOITAO_ID#)      
    </insert>
    <update id="DAO00401_INV001_UpdPhieuYeuCau" parameterClass="DataObject">
      UPDATE TT_INV_PHIEUYEUCAU
      SET MMYY = #MMYY#,NGAYLAP = #NGAYLAP#,PHONGBAN_ID = #PHONGBAN_ID#,TENPHONGBAN = #TENPHONGBAN#,MAKHOXUAT = #MAKHOXUAT#,TENKHOXUAT = #TENKHOXUAT#,GHICHU = #GHICHU#,TENNGUOICAPNHAT = #TENNGUOICAPNHAT#,NGAYCAPNHAT = SYSDATE,NGUOICAPNHAT_ID = #NGUOICAPNHAT_ID#
      WHERE PHIEUYEUCAU_ID = '$PHIEUYEUCAU_ID$' AND BENHVIEN_ID = '$BENHVIEN_ID$'
    </update>
    <statement id="DAO00401_INV001_DelPhieuYeuCauChiTiet" parameterClass="System.String" resultClass="System.Int64">
      DELETE FROM TT_INV_PHIEUYEUCAUCHITIET WHERE MMYY='$MMYY$' AND PHIEUYEUCAU_ID = '$PHIEUYEUCAU_ID$' AND BENHVIEN_ID = '$BENHVIEN_ID$';
    </statement>
    <insert id="DAO00401_INV001_AddPhieuYeuCauChiTiet" parameterClass="System.String" resultClass="System.Int64">
      <selectKey property="ID" type="pre" resultClass="System.Int64">
        select TT_INV_PHIEUYEUCAUCHITIET__SEQ.nextval as value from dual
      </selectKey>
      INSERT INTO TT_INV_PHIEUYEUCAUCHITIET(PHIEUYEUCAUCHITIET_ID,PHIEUYEUCAU_ID,MMYY,HANGHOA_ID,MAHANGHOA,TENHANGHOA,DONVITINH_ID,TENDONVITINH,SOLUONGYEUCAU,SOLUONGDAXUAT,TENNGUOITAO,BENHVIEN_ID,NGAYTAO,NGUOITAO_ID)
      VALUES(#ID#,#PHIEUYEUCAU_ID#,#MMYY#,#HANGHOA_ID#,#MAHANGHOA#,#TENHANGHOA#,#DONVITINH_ID#,#TENDONVITINH#,#SOLUONGYEUCAU#,#SOLUONGDAXUAT#,#TENNGUOITAO#,#BENHVIEN_ID#,SYSDATE,#NGUOITAO_ID#)      
    </insert>
    <statement id="DAO00401_INV001_PhieuYeuCauSearch" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select YC.PHIEUYEUCAU_ID,YC.MAPHIEUYEUCAU,YC.MMYY,YC.NGAYLAP,YC.PHONGBAN_ID,YC.TENPHONGBAN,YC.MAKHOXUAT,YC.TENKHOXUAT,YC.GHICHU,YC.TENNGUOITAO,YC.TENNGUOICAPNHAT,YC.BENHVIEN_ID,YC.NGAYTAO,YC.NGUOITAO_ID,YC.NGAYCAPNHAT,YC.NGUOICAPNHAT_ID
      FROM TT_INV_PHIEUYEUCAU YC 
      WHERE YC.BENHVIEN_ID = '$BENHVIEN_ID$' AND YC.NGAYLAP BETWEEN '$TUNGAY$' AND '$DENNGAY$'
      <isNotEmpty prepend="AND" property="MAPHIEUYEUCAU">
        YC.MAPHIEUYEUCAU LIKE '%$MAPHIEUYEUCAU$%'
      </isNotEmpty>
      <isNotEmpty prepend="AND" property="NGUOITAO_ID">
        YC.NGUOITAO_ID = '$NGUOITAO_ID$'
      </isNotEmpty>
      <isNotEmpty prepend="AND" property="CHUNGTUXUAT_ID">
        YC.CHUNGTUXUAT_ID IS NULL
      </isNotEmpty>
    </statement>
    <statement id="DAO00401_INV001_GetPhieuYeuCauChiTiet_PhieuYeuCauID" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select YCCT.PHIEUYEUCAUCHITIET_ID,YCCT.HANGHOA_ID,YCCT.MAHANGHOA,YCCT.TENHANGHOA,YCCT.DONVITINH_ID,YCCT.TENDONVITINH,YCCT.SOLUONGYEUCAU,YCCT.SOLUONGDAXUAT
      FROM TT_INV_PHIEUYEUCAUCHITIET YCCT
      WHERE YCCT.BENHVIEN_ID = '$BENHVIEN_ID$' AND YCCT.PHIEUYEUCAU_ID='$PHIEUYEUCAU_ID$'
    </statement>
    <statement id="DAO00401_INV001_GetNhanVien" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      SELECT DISTINCT N.*
      <!--,NHANVIENMAP.USERID AS USER_ID-->
      ,N.NHANVIEN_ID AS NHANVIENNHAN_ID,N.TENNHANVIEN AS TENNHANVIENNHAN 
      FROM TM_NHANVIEN N
      <!--LEFT JOIN TBL_USER NHANVIENMAP ON NHANVIENMAP.EMPLOYEEID = N.NHANVIEN_ID-->
      ORDER BY N.TENNHANVIEN
    </statement>
    <statement id="DAO00401_INV001_GetDMNhanVien" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      SELECT NHANVIEN_ID,TENNHANVIEN,NHANVIEN_ID AS NHANVIENNHAN_ID,TENNHANVIEN AS TENNHANVIENNHAN FROM TM_NHANVIEN
      where BENHVIEN_ID = '$BENHVIEN_ID$'
      ORDER BY TENNHANVIEN
    </statement>
    <statement id="DAO00401_INV001_KiemTraMaChungTuXuatTonTai" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select CT.IDCHUYEN
      FROM TT_INV_CHUNGTUXUAT CT
      where CT.MACHUNGTU = '$MACHUNGTU$' AND CT.BENHVIEN_ID = '$BENHVIEN_ID$'
      <isNotEmpty prepend="AND" property="MMYY">
      CT.MMYY IN($MMYY$)
    </isNotEmpty>
    </statement>
    <statement id="DAO00401_INV001_DelChungTuXuatAll" parameterClass="System.String" resultClass="System.Int64">
      DELETE FROM TT_INV_CHUNGTUXUATCHITIET WHERE MMYY='$MMYY$' AND CHUNGTUXUAT_ID='$CHUNGTUXUAT_ID$';
      DELETE FROM TT_INV_CHUNGTUXUAT WHERE MMYY='$MMYY$' AND CHUNGTUXUAT_ID='$CHUNGTUXUAT_ID$';
      UPDATE TT_INV_PHIEUYEUCAUCHITIET SET SOLUONGDAXUAT=0 WHERE PHIEUYEUCAU_ID = '$PHIEUYEUCAU_ID$' AND BENHVIEN_ID = '$BENHVIEN_ID$';
      UPDATE TT_INV_PHIEUYEUCAU SET CHUNGTUXUAT_ID=NULL WHERE PHIEUYEUCAU_ID = '$PHIEUYEUCAU_ID$' AND BENHVIEN_ID = '$BENHVIEN_ID$';
    </statement>
    <statement id="DAO00401_INV001_UpdSLXuatTonKho" parameterClass="DataObject">
      UPDATE TT_INV_TONKHOCHITIET SET SOLUONGXUAT=0 WHERE MMYY='$MMYY$' AND MAKHO IN($LISTMAKHO$);
      MERGE TT_INV_TONKHOCHITIET AS X USING
      (SELECT QQ.MMYY, QQ.MAKHO,QQ.TENKHO,QQ.THEODOI_ID,SUM(QQ.SOLUONGXUAT) AS SOLUONGXUAT,QQ.NGAYTAO,QQ.NGUOITAO_ID FROM (
      SELECT '$MMYY$' AS MMYY, A.MAKHOXUAT AS MAKHO,A.TENKHOXUAT AS TENKHO,B.THEODOI_ID,B.SOLUONGXUAT,C.NGAYTAO,C.NGUOITAO_ID
      FROM TT_INV_CHUNGTUXUAT A INNER JOIN TT_INV_CHUNGTUXUATCHITIET B ON A.CHUNGTUXUAT_ID=B.CHUNGTUXUAT_ID AND A.MMYY='$MMYY$'
      INNER JOIN TT_INV_THEODOI C ON B.THEODOI_ID=C.THEODOI_ID
      WHERE A.MMYY='$MMYY$' AND A.BENHVIEN_ID='$BENHVIEN_ID$' AND A.MAKHOXUAT IN($LISTMAKHO$)
      UNION ALL
      SELECT '$MMYY$' AS MMYY, A.MAKHO,A.TENKHO,B.THEODOI_ID,B.SOLUONG AS SOLUONGXUAT,C.NGAYTAO,C.NGUOITAO_ID
      FROM TT_INV_CHUNGTUTANGGIAM A INNER JOIN TT_INV_CHUNGTUTANGGIAMCHITIET B ON A.CHUNGTUTANGGIAM_ID=B.CHUNGTUTANGGIAM_ID AND A.MMYY='$MMYY$' AND A.LOAI='giam'
      INNER JOIN TT_INV_THEODOI C ON B.THEODOI_ID=C.THEODOI_ID
      WHERE A.MMYY='$MMYY$' AND A.LOAI='giam' AND A.BENHVIEN_ID='$BENHVIEN_ID$' AND A.MAKHO IN($LISTMAKHO$)) QQ
      GROUP BY QQ.MMYY, QQ.MAKHO,QQ.TENKHO,QQ.THEODOI_ID,QQ.NGAYTAO,QQ.NGUOITAO_ID) Y
      ON (X.MMYY=Y.MMYY AND X.MAKHO=Y.MAKHO AND X.THEODOI_ID=Y.THEODOI_ID)
      WHEN MATCHED THEN UPDATE SET X.SOLUONGXUAT=Y.SOLUONGXUAT
      WHEN NOT MATCHED THEN
      INSERT (MMYY,MAKHO,TENKHO,THEODOI_ID,SOLUONGXUAT,BENHVIEN_ID,NGAYTAO,NGUOITAO_ID) VALUES
      ('$MMYY$',Y.MAKHO,Y.TENKHO,Y.THEODOI_ID,Y.SOLUONGXUAT,#BENHVIEN_ID#,Y.NGAYTAO,Y.NGUOITAO_ID);

      UPDATE TT_INV_TONKHOTONGHOP SET SOLUONGTONDAU=0,SOLUONGNHAP=0,SOLUONGXUAT=0 WHERE MMYY='$MMYY$' AND MAKHO IN($LISTMAKHO$);
      MERGE TT_INV_TONKHOTONGHOP X USING
      (SELECT '$MMYY$' AS MMYY,A.MAKHO,A.TENKHO,B.HANGHOA_ID,B.MAHANGHOA,B.TENHANGHOA,SUM(A.SOLUONGTONDAU) AS SOLUONGTONDAU,SUM(A.SOLUONGNHAP) AS SOLUONGNHAP,SUM(A.SOLUONGXUAT) AS SOLUONGXUAT
      FROM TT_INV_TONKHOCHITIET A INNER JOIN TT_INV_THEODOI B ON A.THEODOI_ID=B.THEODOI_ID AND A.MMYY='$MMYY$'
      WHERE A.MMYY='$MMYY$' AND A.BENHVIEN_ID='$BENHVIEN_ID$' AND A.MAKHO IN($LISTMAKHO$)
      GROUP BY A.MAKHO,A.TENKHO,B.HANGHOA_ID,B.MAHANGHOA,B.TENHANGHOA) AS Y
      ON (X.MMYY=Y.MMYY AND X.MAKHO=Y.MAKHO AND X.HANGHOA_ID=Y.HANGHOA_ID)
      WHEN MATCHED THEN UPDATE SET X.SOLUONGTONDAU=Y.SOLUONGTONDAU, X.SOLUONGNHAP=Y.SOLUONGNHAP,X.SOLUONGXUAT=Y.SOLUONGXUAT
      WHEN NOT MATCHED THEN
      INSERT (MMYY,MAKHO,TENKHO,HANGHOA_ID,MAHANGHOA,TENHANGHOA,SOLUONGTONDAU,SOLUONGNHAP,SOLUONGXUAT,BENHVIEN_ID,NGAYTAO)
      VALUES ('$MMYY$',Y.MAKHO,Y.TENKHO,Y.HANGHOA_ID,Y.MAHANGHOA,Y.TENHANGHOA,Y.SOLUONGTONDAU,Y.SOLUONGNHAP,Y.SOLUONGXUAT,#BENHVIEN_ID#,SYSDATE);

      DELETE FROM TT_INV_TONKHOCHITIET WHERE SOLUONGTONDAU=0 AND SOLUONGNHAP=0 AND SOLUONGXUAT=0;
      DELETE FROM TT_INV_TONKHOTONGHOP WHERE SOLUONGTONDAU=0 AND SOLUONGNHAP=0 AND SOLUONGXUAT=0;
    </statement>
    <statement id="DAO00401_INV001_GetChungTuXuatAll" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
    SELECT CT.CHUNGTUXUAT_ID,CT.MACHUNGTU,CT.MMYY,CT.NGAYCHUNGTU,CT.MAKHOXUAT,CT.TENKHOXUAT,CT.PHONGBANNHAN_ID,CT.TENPHONGBANNHAN,CT.NHANVIENNHAN_ID,CT.TENNHANVIENNHAN,
    CT.GHICHU,CT.PHIEUYEUCAU_ID,CT.MAPHIEUYEUCAU,CT.XUATKHOTHEO,CT.TENNGUOITAO,CT.TENNGUOICAPNHAT,CT.IDCHUYEN,CT.BENHVIEN_ID,CT.NGAYTAO,CT.NGUOITAO_ID,CT.NGAYCAPNHAT,CT.NGUOICAPNHAT_ID,
    CTCT.SOLUONGYEUCAU,CTCT.SOLUONGXUAT,CTCT.THANHTIEN,CTCT.GHICHU AS CT_GHICHU,CTCT.PHIEUYEUCAUCHITIET_ID,
    TD.THEODOI_ID,TD.HANGHOA_ID,TD.MAHANGHOA,TD.TENHANGHOA,TD.DONVITINH_ID,TD.TENDONVITINH,TD.HANDUNG,TD.LOSX,TD.DONGIASAUVAT AS DONGIA
    FROM TT_INV_CHUNGTUXUAT CT INNER JOIN TT_INV_CHUNGTUXUATCHITIET CTCT ON CT.CHUNGTUXUAT_ID=CTCT.CHUNGTUXUAT_ID
    <isNotEmpty prepend="AND" property="MMYY">
      CT.MMYY IN($MMYY$)
    </isNotEmpty>
    INNER JOIN TT_INV_THEODOI TD ON CTCT.THEODOI_ID=TD.THEODOI_ID
    where CT.BENHVIEN_ID = '$BENHVIEN_ID$' AND CT.MACHUNGTU = '$MACHUNGTU$'
    <isNotEmpty prepend="AND" property="MMYY">
      CT.MMYY IN($MMYY$)
    </isNotEmpty>
    ORDER BY TD.TENHANGHOA
    </statement>
    <statement id="DAO00401_INV001_ChungTuXuatSearch" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select CT.CHUNGTUXUAT_ID,CT.MACHUNGTU,CT.MMYY,CT.NGAYCHUNGTU,CT.MAKHOXUAT,CT.TENKHOXUAT,CT.PHONGBANNHAN_ID,CT.TENPHONGBANNHAN,CT.NHANVIENNHAN_ID,CT.TENNHANVIENNHAN,
      CT.GHICHU,CT.PHIEUYEUCAU_ID,CT.MAPHIEUYEUCAU,CT.XUATKHOTHEO,CT.TENNGUOITAO,CT.TENNGUOICAPNHAT,CT.IDCHUYEN,CT.BENHVIEN_ID,CT.NGAYTAO,CT.NGUOITAO_ID,CT.NGAYCAPNHAT,CT.NGUOICAPNHAT_ID
      FROM TT_INV_CHUNGTUXUAT CT
      WHERE CT.BENHVIEN_ID = '$BENHVIEN_ID$' AND CT.NGAYCHUNGTU BETWEEN '$TUNGAY$' AND '$DENNGAY$'
      <isNotEmpty prepend="AND" property="MACHUNGTU">
        CT.MACHUNGTU LIKE '%$MACHUNGTU$%'
      </isNotEmpty>
    </statement>
    <statement id="DAO00401_INV001_GetChungTuXuatChiTiet_ChungTuID" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select CTCT.SOLUONGYEUCAU,CTCT.SOLUONGXUAT,CTCT.THANHTIEN,CTCT.GHICHU AS CT_GHICHU,CTCT.PHIEUYEUCAUCHITIET_ID,
      TD.THEODOI_ID,TD.HANGHOA_ID,TD.MAHANGHOA,TD.TENHANGHOA,TD.DONVITINH_ID,TD.TENDONVITINH,TD.HANDUNG,TD.LOSX,TD.DONGIASAUVAT AS DONGIA
      FROM TT_INV_CHUNGTUXUATCHITIET CTCT INNER JOIN TT_INV_THEODOI TD ON CTCT.THEODOI_ID=TD.THEODOI_ID
      WHERE CTCT.BENHVIEN_ID = '$BENHVIEN_ID$' AND CTCT.CHUNGTUXUAT_ID='$CHUNGTUXUAT_ID$'
    </statement>
    <statement id="DAO00401_INV001_GetChiTietYC_MaPhieuYeuCau" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select YC.PHIEUYEUCAU_ID,YC.MAPHIEUYEUCAU,YC.MMYY,YC.NGAYLAP,YC.PHONGBAN_ID AS PHONGBANNHAN_ID,YC.TENPHONGBAN AS TENPHONGBANNHAN,YC.MAKHOXUAT,YC.TENKHOXUAT,
      YCCT.PHIEUYEUCAUCHITIET_ID,YCCT.HANGHOA_ID,YCCT.MAHANGHOA,YCCT.TENHANGHOA,YCCT.DONVITINH_ID,YCCT.TENDONVITINH,YCCT.SOLUONGYEUCAU,YCCT.SOLUONGYEUCAU AS SOLUONGXUAT, NULL AS DONGIA,NULL AS LOSX,NULL AS HANDUNG,
      TKTH.SOLUONGTONCUOI
      FROM TT_INV_PHIEUYEUCAU YC INNER JOIN TT_INV_PHIEUYEUCAUCHITIET YCCT ON YC.PHIEUYEUCAU_ID=YCCT.PHIEUYEUCAU_ID
      LEFT JOIN (SELECT (SOLUONGTONDAU+SOLUONGNHAP-SOLUONGXUAT)  SOLUONGTONCUOI, HANGHOA_ID,MAKHO
      FROM TT_INV_TONKHOTONGHOP WHERE BENHVIEN_ID='$BENHVIEN_ID$' AND MMYY='$MMYY$'
      ) TKTH ON YCCT.HANGHOA_ID = TKTH.HANGHOA_ID AND YC.MAKHOXUAT = TKTH.MAKHO
      WHERE YC.MAPHIEUYEUCAU='$MAPHIEUYEUCAU$' AND YC.BENHVIEN_ID = '$BENHVIEN_ID$'
    </statement>
    <statement id="DAO00401_INV001_DelChungTuXuatChiTietTheoID" parameterClass="System.String" resultClass="System.Int64">
      DELETE FROM TT_INV_CHUNGTUXUATCHITIET WHERE MMYY='$MMYY$' AND CHUNGTUXUATCHITIET_ID='$CHUNGTUXUATCHITIET_ID$';
    </statement>
    <update id="DAO00401_INV001_UpdSLDaXuat_PhieuYeuCauChiTietID" parameterClass="DataObject">
      UPDATE TT_INV_PHIEUYEUCAUCHITIET
      SET SOLUONGDAXUAT=#SOLUONGXUAT#
      WHERE PHIEUYEUCAUCHITIET_ID = '$LISTPHIEUYEUCAUCHITIET_ID$' AND BENHVIEN_ID = '$BENHVIEN_ID$'
    </update>
    <insert id="DAO00401_INV001_AddChungTuXuat" parameterClass="System.Collections.IDictionary" resultClass="System.Int64">
    <selectKey property="ID" type="pre" resultClass="System.Int64">
      select TT_INV_CHUNGTUXUAT_CHUNGTU_SEQ.nextval as value from dual
    </selectKey>
    INSERT INTO TT_INV_CHUNGTUXUAT
    (CHUNGTUXUAT_ID,MACHUNGTU,MMYY,NGAYCHUNGTU,MAKHOXUAT,TENKHOXUAT,PHONGBANNHAN_ID,TENPHONGBANNHAN,NHANVIENNHAN_ID,TENNHANVIENNHAN,GHICHU,PHIEUYEUCAU_ID,MAPHIEUYEUCAU,XUATKHOTHEO,TENNGUOITAO,BENHVIEN_ID,NGAYTAO,NGUOITAO_ID)
    VALUES (#ID#,#MACHUNGTU#,#MMYY#,#NGAYCHUNGTU#,#MAKHOXUAT#,#TENKHOXUAT#,#PHONGBANNHAN_ID#,#TENPHONGBANNHAN#,#NHANVIENNHAN_ID#,#TENNHANVIENNHAN#,#GHICHU#,#PHIEUYEUCAU_ID#,#MAPHIEUYEUCAU#,#XUATKHOTHEO#,#TENNGUOITAO#,#BENHVIEN_ID#,SYSDATE,#NGUOITAO_ID#)    
  </insert>
  <update id="DAO00401_INV001_UpdChungTuXuat" parameterClass="DataObject">
      UPDATE TT_INV_CHUNGTUXUAT
      SET MAKHOXUAT = #MAKHOXUAT#,TENKHOXUAT = #TENKHOXUAT#,PHONGBANNHAN_ID = #PHONGBANNHAN_ID#,TENPHONGBANNHAN = #TENPHONGBANNHAN#,NHANVIENNHAN_ID = #NHANVIENNHAN_ID#,TENNHANVIENNHAN = #TENNHANVIENNHAN#,
      GHICHU = #GHICHU#,PHIEUYEUCAU_ID = #PHIEUYEUCAU_ID#,MAPHIEUYEUCAU = #MAPHIEUYEUCAU#,XUATKHOTHEO = #XUATKHOTHEO#,TENNGUOICAPNHAT = #TENNGUOICAPNHAT#,BENHVIEN_ID = #BENHVIEN_ID#,NGAYCAPNHAT = SYSDATE,
      NGUOICAPNHAT_ID = #NGUOICAPNHAT_ID#
      WHERE CHUNGTUXUAT_ID = '$CHUNGTUXUAT_ID$'
    </update>
  <statement id="DAO00401_INV001_DelChungTuXuatChiTiet" parameterClass="System.String" resultClass="System.Int64">
      DELETE FROM TT_INV_CHUNGTUXUATCHITIET WHERE MMYY='$MMYY$' AND CHUNGTUXUAT_ID='$CHUNGTUXUAT_ID$';
    </statement>
    <insert id="DAO00401_INV001_AddChungTuXuatChiTiet" parameterClass="System.String" resultClass="System.Int64">
      <selectKey property="ID" type="pre" resultClass="System.Int64">
        select TT_INV_CHUNGTUXUATCHITIET__SEQ.nextval as value from dual
      </selectKey>
      INSERT INTO TT_INV_CHUNGTUXUATCHITIET(CHUNGTUXUATCHITIET_ID,CHUNGTUXUAT_ID,MMYY,THEODOI_ID,SOLUONGYEUCAU,SOLUONGXUAT,THANHTIEN,GHICHU,PHIEUYEUCAUCHITIET_ID,TENNGUOITAO,BENHVIEN_ID,NGAYTAO,NGUOITAO_ID)
      VALUES(#ID#,#CHUNGTUXUAT_ID#,#MMYY#,#THEODOI_ID#,#SOLUONGYEUCAU#,#SOLUONGXUAT#,#THANHTIEN#,#CT_GHICHU#,#PHIEUYEUCAUCHITIET_ID#,#TENNGUOITAO#,#BENHVIEN_ID#,SYSDATE,#NGUOITAO_ID#)  
    </insert>
  <update id="DAO00401_INV001_UpdChungTuXuatID_PhieuYeuCau" parameterClass="DataObject">
      UPDATE TT_INV_PHIEUYEUCAU SET CHUNGTUXUAT_ID = #CHUNGTUXUAT_ID# WHERE PHIEUYEUCAU_ID = '$PHIEUYEUCAU_ID$' AND BENHVIEN_ID = '$BENHVIEN_ID$'
    </update>
    <statement id="DAO00401_INV001_TinhSoDuDauKy" parameterClass="DataObject">
      UPDATE TT_INV_TONKHOCHITIET SET SOLUONGTONDAU=0 WHERE MMYY='$MMYY$' AND MAKHO IN($LISTMAKHO$);
      MERGE TT_INV_TONKHOCHITIET X USING (
      SELECT TK.MMYY, TK.MAKHO,TK.TENKHO,TK.THEODOI_ID,SUM(TK.SOLUONGTONDAU+TK.SOLUONGNHAP-TK.SOLUONGXUAT) AS SOLUONGTONDAU,TK.NGAYTAO,TK.NGUOITAO_ID
      FROM
      <!--So luong ton dau-->
      (SELECT '$MMYY$' AS MMYY, A.MAKHO,A.TENKHO,B.THEODOI_ID,A.SOLUONGTONDAU,0 AS SOLUONGNHAP,0 AS SOLUONGXUAT,B.NGAYTAO,B.NGUOITAO_ID
      FROM TT_INV_TONKHOCHITIET A INNER JOIN TT_INV_THEODOI B ON A.THEODOI_ID=B.THEODOI_ID AND A.MMYY='$MMYYTRUOC$'
      WHERE A.MMYY='$MMYYTRUOC$' AND A.BENHVIEN_ID='$BENHVIEN_ID$' AND A.MAKHO IN($LISTMAKHO$)
      UNION ALL
      <!--So luong xuat-->
      SELECT '$MMYY$' AS MMYY, A.MAKHOXUAT AS MAKHO,A.TENKHOXUAT AS TENKHO,B.THEODOI_ID,0 AS SOLUONGTONDAU,0 AS SOLUONGNHAP,B.SOLUONGXUAT,C.NGAYTAO,C.NGUOITAO_ID
      FROM TT_INV_CHUNGTUXUAT A INNER JOIN TT_INV_CHUNGTUXUATCHITIET B ON A.CHUNGTUXUAT_ID=B.CHUNGTUXUAT_ID AND A.MMYY='$MMYYTRUOC$'
      INNER JOIN TT_INV_THEODOI C ON B.THEODOI_ID=C.THEODOI_ID
      WHERE A.MMYY='$MMYYTRUOC$' AND A.BENHVIEN_ID='$BENHVIEN_ID$' AND A.MAKHOXUAT IN($LISTMAKHO$)
      UNION ALL
      SELECT '$MMYY$' AS MMYY, A.MAKHO,A.TENKHO,B.THEODOI_ID,0 AS SOLUONGTONDAU,0 AS SOLUONGNHAP,B.SOLUONG AS SOLUONGXUAT,C.NGAYTAO,C.NGUOITAO_ID
      FROM TT_INV_CHUNGTUTANGGIAM A INNER JOIN TT_INV_CHUNGTUTANGGIAMCHITIET B ON A.CHUNGTUTANGGIAM_ID=B.CHUNGTUTANGGIAM_ID AND A.MMYY='$MMYYTRUOC$' AND A.LOAI='giam'
      INNER JOIN TT_INV_THEODOI C ON B.THEODOI_ID=C.THEODOI_ID
      WHERE A.MMYY='$MMYYTRUOC$' AND A.LOAI='giam' AND A.BENHVIEN_ID='$BENHVIEN_ID$' AND A.MAKHO IN($LISTMAKHO$)
      UNION ALL
      <!--So luong nhap-->
      SELECT '$MMYY$' AS MMYY, A.MAKHO,A.TENKHO,B.THEODOI_ID,0 AS SOLUONGTONDAU,B.SOLUONGNHAP,0 AS SOLUONGXUAT,C.NGAYTAO,C.NGUOITAO_ID
      FROM TT_INV_CHUNGTUNHAP A INNER JOIN TT_INV_CHUNGTUNHAPCHITIET B ON A.CHUNGTUNHAP_ID=B.CHUNGTUNHAP_ID AND A.MMYY='$MMYYTRUOC$'
      INNER JOIN TT_INV_THEODOI C ON B.THEODOI_ID=C.THEODOI_ID
      WHERE A.MMYY='$MMYYTRUOC$' AND A.MATRANGTHAI='DaNhapKho' AND A.BENHVIEN_ID='$BENHVIEN_ID$' AND A.MAKHO IN($LISTMAKHO$)
      UNION ALL
      SELECT '$MMYY$' AS MMYY, A.MAKHO,A.TENKHO,B.THEODOI_ID,0 AS SOLUONGTONDAU,B.SOLUONG AS SOLUONGNHAP,0 AS SOLUONGXUAT,C.NGAYTAO,C.NGUOITAO_ID
      FROM TT_INV_CHUNGTUTANGGIAM A INNER JOIN TT_INV_CHUNGTUTANGGIAMCHITIET B ON A.CHUNGTUTANGGIAM_ID=B.CHUNGTUTANGGIAM_ID AND A.MMYY='$MMYYTRUOC$' AND A.LOAI='tang'
      INNER JOIN TT_INV_THEODOI C ON B.THEODOI_ID=C.THEODOI_ID
      WHERE A.MMYY='$MMYYTRUOC$' AND A.LOAI='tang' AND A.BENHVIEN_ID='$BENHVIEN_ID$' AND A.MAKHO IN($LISTMAKHO$)
      ) TK GROUP BY TK.MMYY, TK.MAKHO,TK.TENKHO,TK.THEODOI_ID,TK.NGAYTAO,TK.NGUOITAO_ID) AS Y
      ON (X.MMYY=Y.MMYY AND X.MAKHO=Y.MAKHO AND X.THEODOI_ID=Y.THEODOI_ID)
      WHEN MATCHED THEN UPDATE SET X.SOLUONGTONDAU=Y.SOLUONGTONDAU
      WHEN NOT MATCHED THEN
      INSERT (MMYY,MAKHO,TENKHO,THEODOI_ID,SOLUONGTONDAU,BENHVIEN_ID,NGAYTAO,NGUOITAO_ID) VALUES
      ('$MMYY$',Y.MAKHO,Y.TENKHO,Y.THEODOI_ID,Y.SOLUONGTONDAU,#BENHVIEN_ID#,Y.NGAYTAO,Y.NGUOITAO_ID);

      UPDATE TT_INV_TONKHOTONGHOP SET SOLUONGTONDAU=0,SOLUONGNHAP=0,SOLUONGXUAT=0 WHERE MMYY='$MMYY$' AND MAKHO IN($LISTMAKHO$);
      MERGE TT_INV_TONKHOTONGHOP AS X USING
      (SELECT '$MMYY$' AS MMYY,A.MAKHO,A.TENKHO,B.HANGHOA_ID,B.MAHANGHOA,B.TENHANGHOA,SUM(A.SOLUONGTONDAU) AS SOLUONGTONDAU,SUM(A.SOLUONGNHAP) AS SOLUONGNHAP,SUM(A.SOLUONGXUAT) AS SOLUONGXUAT
      FROM TT_INV_TONKHOCHITIET A INNER JOIN TT_INV_THEODOI B ON A.THEODOI_ID=B.THEODOI_ID AND A.MMYY='$MMYY$'
      WHERE A.MMYY='$MMYY$' AND A.BENHVIEN_ID='$BENHVIEN_ID$' AND A.MAKHO IN($LISTMAKHO$)
      GROUP BY A.MAKHO,A.TENKHO,B.HANGHOA_ID,B.MAHANGHOA,B.TENHANGHOA)  Y
      ON (X.MMYY=Y.MMYY AND X.MAKHO=Y.MAKHO AND X.HANGHOA_ID=Y.HANGHOA_ID)
      WHEN MATCHED THEN UPDATE SET X.SOLUONGTONDAU=Y.SOLUONGTONDAU, X.SOLUONGNHAP=Y.SOLUONGNHAP,X.SOLUONGXUAT=Y.SOLUONGXUAT
      WHEN NOT MATCHED THEN
      INSERT (MMYY,MAKHO,TENKHO,HANGHOA_ID,MAHANGHOA,TENHANGHOA,SOLUONGTONDAU,SOLUONGNHAP,SOLUONGXUAT,BENHVIEN_ID,NGAYTAO)
      VALUES ('$MMYY$',Y.MAKHO,Y.TENKHO,Y.HANGHOA_ID,Y.MAHANGHOA,Y.TENHANGHOA,Y.SOLUONGTONDAU,Y.SOLUONGNHAP,Y.SOLUONGXUAT,#BENHVIEN_ID#,SYSDATE);

      DELETE FROM TT_INV_TONKHOCHITIET WHERE SOLUONGTONDAU=0 AND SOLUONGNHAP=0 AND SOLUONGXUAT=0;
      DELETE FROM TT_INV_TONKHOTONGHOP WHERE SOLUONGTONDAU=0 AND SOLUONGNHAP=0 AND SOLUONGXUAT=0;
    </statement>
    <statement id="DAO00401_INV001_SoDuDMKho" parameterClass="DataObject">
      MERGE TM_INV_KHO AS X USING (
      SELECT AA.DICTIONARY_CODE AS MAKHO,AA.DICTIONARY_NAME AS TENKHO,#SODU# AS SODU,#SODUDENNGAY# AS SODUDENNGAY
      FROM LST_DICTIONARY AA LEFT JOIN TM_INV_KHO BB ON AA.DICTIONARY_CODE = BB.MAKHO
      WHERE AA.DICTIONARY_TYPE_CODE = 'KhoVPP' AND AA.DICTIONARY_CODE IN($LISTMAKHO$)) AS Y
      ON (X.MAKHO=Y.MAKHO)
      WHEN MATCHED THEN UPDATE SET X.SODU=#SODU#,X.SODUDENNGAY=#SODUDENNGAY#,X.NGUOICAPNHAT_ID=#NGUOITAO_ID#
      WHEN NOT MATCHED THEN
      INSERT (MAKHO,TENKHO,SODU,SODUDENNGAY,BENHVIEN_ID,NGAYTAO,NGUOITAO_ID) VALUES
      (Y.MAKHO,Y.TENKHO,Y.SODU,Y.SODUDENNGAY,#BENHVIEN_ID#,SYSDATE,#NGUOITAO_ID#);
    </statement>
    <statement id="DAO00401_INV001_KiemTraMaChungTuTangGiamTonTai" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select CT.CHUNGTUTANGGIAM_ID
      FROM TT_INV_CHUNGTUTANGGIAM CT
      where CT.MACHUNGTU = '$MACHUNGTU$' AND CT.BENHVIEN_ID = '$BENHVIEN_ID$'
    </statement>
    <insert id="DAO00401_INV001_AddChungTuTangGiam" parameterClass="System.Collections.IDictionary" resultClass="System.Int64">
      <selectKey property="ID" type="pre" resultClass="System.Int64">
        select TT_INV_CHUNGTUTANGGIAM_CHU_SEQ.nextval as value from dual
      </selectKey>
      INSERT INTO TT_INV_CHUNGTUTANGGIAM (CHUNGTUTANGGIAM_ID,MACHUNGTU,MMYY,NGAYCHUNGTU,MAKHO,TENKHO,NGUOIDUYET_ID,TENNGUOIDUYET,GHICHU,LOAI,TENNGUOITAO,BENHVIEN_ID,NGAYTAO,NGUOITAO_ID)
      VALUES(#ID#,#MACHUNGTU#,#MMYY#,#NGAYCHUNGTU#,#MAKHO#,#TENKHO#,#NGUOIDUYET_ID#,#TENNGUOIDUYET#,#GHICHU#,#LOAI#,#TENNGUOITAO#,#BENHVIEN_ID#,SYSDATE,#NGUOITAO_ID#)      
    </insert>
    <insert id="DAO00401_INV001_AddChungTuTangGiamChiTiet" parameterClass="System.Collections.IDictionary" resultClass="System.Int64">
      <selectKey property="ID" type="pre" resultClass="System.Int64">
        select TT_INV_CHUNGTUTANGGIAMCHIT_SEQ.nextval as value from dual
      </selectKey>
      INSERT INTO TT_INV_CHUNGTUTANGGIAMCHITIET (CHUNGTUTANGGIAMCHITIET_ID,CHUNGTUTANGGIAM_ID,MMYY,THEODOI_ID,SOLUONG,THANHTIEN,LYDO,TENNGUOITAO,BENHVIEN_ID,NGAYTAO,NGUOITAO_ID)
      VALUES(#ID#,#CHUNGTUTANGGIAM_ID#,#MMYY#,#THEODOI_ID#,#SOLUONG#,#THANHTIEN#,#LYDO#,#TENNGUOITAO#,#BENHVIEN_ID#,SYSDATE,#NGUOITAO_ID#)      
    </insert>
    <statement id="DAO00401_INV001_GetChungTuTangGiam" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      SELECT CT.CHUNGTUTANGGIAM_ID,CT.MACHUNGTU,CT.MMYY,CT.NGAYCHUNGTU,CT.MAKHO,CT.TENKHO,CT.NGUOIDUYET_ID,CT.TENNGUOIDUYET,CT.GHICHU,CT.LOAI,CT.TENNGUOITAO,CT.TENNGUOICAPNHAT,CT.BENHVIEN_ID,CT.NGAYTAO,CT.NGUOITAO_ID,CT.NGAYCAPNHAT,CT.NGUOICAPNHAT_ID,
      CTCT.CHUNGTUTANGGIAMCHITIET_ID,CTCT.SOLUONG,CTCT.THANHTIEN,CTCT.LYDO,
      TD.THEODOI_ID,TD.HANGHOA_ID,TD.MAHANGHOA,TD.TENHANGHOA,TD.DONVITINH_ID,TD.TENDONVITINH,TD.HANDUNG,TD.LOSX,TD.DONGIASAUVAT AS DONGIA, A.SOLUONGTONCUOI
      FROM TT_INV_CHUNGTUTANGGIAM CT INNER JOIN TT_INV_CHUNGTUTANGGIAMCHITIET CTCT ON CT.CHUNGTUTANGGIAM_ID=CTCT.CHUNGTUTANGGIAM_ID
      <isNotEmpty prepend="AND" property="MMYY">
        CT.MMYY IN($MMYY$)
      </isNotEmpty>
      INNER JOIN TT_INV_THEODOI TD ON CTCT.THEODOI_ID=TD.THEODOI_ID
      INNER JOIN
      (
      SELECT DISTINCT TD.THEODOI_ID,TD.HANGHOA_ID,TD.MAHANGHOA,TD.TENHANGHOA,TD.DONVITINH_ID,TD.TENDONVITINH,TD.DONGIA AS DONGIATRUOCVAT,TD.DONGIASAUVAT AS DONGIA,TO_CHAR(TD.HANDUNG,'DD/MM/YYYY') HANDUNG,TD.LOSX, TO_CHAR(TD.NGAYTAO,'DD/MM/YYYY:HH24:Mi') NGAYTAO,
      SUM(TKCT.SOLUONGTONDAU+TKCT.SOLUONGNHAP-TKCT.SOLUONGXUAT) AS SOLUONGTONCHITIET,SUM(TKTH.SOLUONGTONDAU+TKTH.SOLUONGNHAP-TKTH.SOLUONGXUAT) AS SOLUONGTONCUOI
      FROM TM_PUR_HANGHOA HH INNER JOIN TT_INV_THEODOI TD ON HH.ID = TD.HANGHOA_ID
      INNER JOIN TT_INV_TONKHOTONGHOP TKTH ON HH.ID = TKTH.HANGHOA_ID
      <isNotEmpty prepend="AND" property="MMYY">
        TKTH.MMYY IN($MMYY$)
      </isNotEmpty>
      INNER JOIN TT_INV_TONKHOCHITIET TKCT ON TD.THEODOI_ID = TKCT.THEODOI_ID
      <isNotEmpty prepend="AND" property="MMYY">
        TKCT.MMYY IN($MMYY$)
      </isNotEmpty>
      where TKCT.BENHVIEN_ID = '$BENHVIEN_ID$'
      <isNotEmpty prepend="AND" property="MAKHO">
        TKCT.MAKHO = '$MAKHO$'
      </isNotEmpty>
      <isNotEmpty prepend="AND" property="MMYY">
        TKCT.MMYY IN($MMYY$)
      </isNotEmpty>
      GROUP BY TD.THEODOI_ID,TD.HANGHOA_ID,TD.MAHANGHOA,TD.TENHANGHOA,TD.DONVITINH_ID,TD.TENDONVITINH,TD.DONGIA,TD.DONGIASAUVAT,TD.HANDUNG,TD.NGAYTAO,TD.LOSX
      ) A ON A.THEODOI_ID = TD.THEODOI_ID
      where CT.BENHVIEN_ID = '$BENHVIEN_ID$' AND CT.MACHUNGTU = '$MACHUNGTU$'
      <isNotEmpty prepend="AND" property="MMYY">
        CT.MMYY IN($MMYY$)
      </isNotEmpty>
      ORDER BY TD.TENHANGHOA
    </statement>
    <statement id="DAO00401_INV001_ChungTuTangGiamSearch" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select CT.CHUNGTUTANGGIAM_ID,CT.MACHUNGTU,CT.MMYY,CT.NGAYCHUNGTU,CT.MAKHO,CT.TENKHO,CT.NGUOIDUYET_ID,CT.TENNGUOIDUYET,CT.GHICHU,CT.LOAI,
      CT.TENNGUOITAO,CT.TENNGUOICAPNHAT,CT.BENHVIEN_ID,CT.NGAYTAO,CT.NGUOITAO_ID,CT.NGAYCAPNHAT,CT.NGUOICAPNHAT_ID
      FROM TT_INV_CHUNGTUTANGGIAM CT
      WHERE CT.BENHVIEN_ID = '$BENHVIEN_ID$' AND CT.LOAI = '$LOAI$' AND CT.NGAYCHUNGTU BETWEEN '$TUNGAY$' AND '$DENNGAY$'
      <isNotEmpty prepend="AND" property="MACHUNGTU">
        CT.MACHUNGTU LIKE '%$MACHUNGTU$%'
      </isNotEmpty>
    </statement>
    <statement id="DAO00401_INV001_GetChungTuTangGiamChiTiet_ChungTuID" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select CTCT.CHUNGTUTANGGIAMCHITIET_ID,CTCT.SOLUONG,CTCT.THANHTIEN,CTCT.LYDO,CTCT.CHUNGTUTANGGIAM_ID,
      TD.THEODOI_ID,TD.HANGHOA_ID,TD.MAHANGHOA,TD.TENHANGHOA,TD.DONVITINH_ID,TD.TENDONVITINH,TD.HANDUNG,TD.LOSX,TD.DONGIASAUVAT AS DONGIA
      FROM TT_INV_CHUNGTUTANGGIAMCHITIET CTCT INNER JOIN TT_INV_THEODOI TD ON CTCT.THEODOI_ID=TD.THEODOI_ID
      WHERE CTCT.BENHVIEN_ID = '$BENHVIEN_ID$' AND CTCT.CHUNGTUTANGGIAM_ID='$CHUNGTUTANGGIAM_ID$'
    </statement>
    <statement id="DAO00401_INV001_GetKhoaSoChungTu" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select DISTINCT SUBSTR(TKTH.MMYY,2) +'/' + SUBSTR(TKTH.MMYY,-2) AS MMYY,KS.KHOASO_ID,NVL(KS.KHOASO,0) AS KHOASO,TKTH.MAKHO,TKTH.TENKHO,KS.NGUOIKHOA_ID,KS.TENNGUOIKHOA,KS.NGAYKHOA,KS.NGUOIMOKHOA_ID,KS.TENNGUOIMOKHOA,
      KS.NGAYMOKHOA,KS.NGAYTAO,KS.NGUOITAO_ID,K.NGAYKHOA AS SODU_NGAYKHOA
      FROM TT_INV_TONKHOTONGHOP TKTH LEFT JOIN TT_INV_KHOASO KS ON TKTH.MMYY = KS.MMYY
      LEFT JOIN TM_INV_KHO K ON TKTH.MAKHO = K.MAKHO
      WHERE TKTH.BENHVIEN_ID = '$BENHVIEN_ID$'
    </statement>
    <insert id="DAO00401_INV001_AddKhoaSo" parameterClass="System.Collections.IDictionary" resultClass="System.Int64">
      <selectKey property="ID" type="pre" resultClass="System.Int64">
        select TT_INV_KHOASO_KHOASO_ID_SEQ.nextval as value from dual
      </selectKey>
      INSERT INTO TT_INV_KHOASO(KHOASO_ID,KHOASO,MMYY,MAKHO,TENKHO,NGUOIKHOA_ID,TENNGUOIKHOA,NGAYKHOA,NGAYTAO,NGUOITAO_ID,BENHVIEN_ID)
      VALUES(#ID#,#KHOASO#,#MMYY#,#MAKHO#,#TENKHO#,#NGUOIKHOA_ID#,#TENNGUOIKHOA#,#NGAYKHOA#,SYSDATE,#NGUOITAO_ID#,#BENHVIEN_ID#)      
    </insert>
  <update id="DAO00401_INV001_UpdKhoaSo" parameterClass="DataObject">
      UPDATE TT_INV_KHOASO
       SET KHOASO = #KHOASO#,NGUOIKHOA_ID = #NGUOIKHOA_ID#,TENNGUOIKHOA = #TENNGUOIKHOA#,NGAYKHOA = #NGAYKHOA#,NGUOIMOKHOA_ID = #NGUOIMOKHOA_ID#,TENNGUOIMOKHOA = #TENNGUOIMOKHOA#,NGAYMOKHOA = #NGAYMOKHOA#,NGAYCAPNHAT = SYSDATE,NGUOICAPNHAT_ID = #NGUOICAPNHAT_ID#
       WHERE KHOASO_ID = '$KHOASO_ID$' AND MMYY = '$MMYY$' AND MAKHO = '$MAKHO$' AND BENHVIEN_ID = '$BENHVIEN_ID$'
    </update>
    <statement id="DAO00401_INV001_AddKhoaSoHistory" parameterClass="System.String" resultClass="System.Int32">      
      INSERT INTO TT_INV_KHOASOHISTORY(TENNGUOITAO,TRANGTHAIHANHDONG,KS_KHOASO_ID,KS_KHOASO,KS_MMYY,KS_MAKHO,KS_TENKHO,KS_NGUOIKHOA_ID,KS_TENNGUOIKHOA,KS_NGAYKHOA,KS_NGUOIMOKHOA_ID,
      KS_TENNGUOIMOKHOA,KS_NGAYMOKHOA,KS_NGAYTAO,KS_NGUOITAO_ID,KS_NGAYCAPNHAT,KS_NGUOICAPNHAT_ID,NGAYTAO,NGUOITAO_ID,BENHVIEN_ID)
      SELECT
      #TENNGUOITAO#,#TRANGTHAIHANHDONG#,KHOASO_ID,KHOASO,MMYY,MAKHO,TENKHO,NGUOIKHOA_ID,TENNGUOIKHOA,NGAYKHOA,NGUOIMOKHOA_ID,TENNGUOIMOKHOA,NGAYMOKHOA,NGAYTAO,NGUOITAO_ID,
      NGAYCAPNHAT,NGUOICAPNHAT_ID,SYSDATE,#NGUOITAO_ID#,#BENHVIEN_ID#
      FROM TT_INV_KHOASO
      WHERE KHOASO_ID='$KHOASO_ID$' AND BENHVIEN_ID = '$BENHVIEN_ID$'
    </statement>
  <update id="DAO00401_INV001_UpdSoDuDMKho_KhoaSo" parameterClass="DataObject">
      UPDATE TM_INV_KHO
       SET KHOASO = #KHOASO#,NGAYKHOA = #NGAYKHOA#
       WHERE MAKHO = '$MAKHO$' AND  BENHVIEN_ID = '$BENHVIEN_ID$'
    </update>
  <statement id="DAO00401_INV001_KiemTraKhoaSoMMYY" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select KHOASO FROM TT_INV_KHOASO WHERE MMYY = '$MMYY$' AND MAKHO = '$MAKHO$' AND BENHVIEN_ID = '$BENHVIEN_ID$'
    </statement>
    <statement id="DAO00401_INV001_GetDMNhanVen" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      SELECT AA.NHANVIEN_ID,AA.TENNHANVIEN,AA.CHUCVU_ID,BB.DICTIONARY_NAME AS TENCHUCVU
      FROM TM_NHANVIEN AA LEFT JOIN LST_DICTIONARY BB ON AA.CHUCVU_ID=BB.DICTIONARY_ID AND BB.DICTIONARY_TYPE_CODE='ChucVu';
    </statement>
    <statement id="DAO00401_INV001_GetHangHoaPO" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      SELECT A.HANGHOA_ID, B.MACHUNGTU,  A.SOLUONGYEUCAU FROM TT_PUR_CHUNGTUCHITIET A LEFT JOIN TT_PUR_CHUNGTU B on A.CHUNGTU_ID = B.CHUNGTU_ID
      WHERE B.PROCESS_CODE = 'PO' AND B.MACHUNGTU = '$MACHUNGTULIENQUAN$'
    </statement>
    <statement id="DAO00401_INV001_UpdateTrangThaiPO_NhapKho" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      UPDATE TT_PUR_CHUNGTU SET STATE_CODE = #STATE_CODE#, STATE_NAME = #STATE_NAME# WHERE MACHUNGTU = '$MACHUNGTULIENQUAN$' AND PROCESS_CODE = 'PO'
    </statement>
    <statement id="DAO00401_INV001_GetChungTuNhapKho" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      SELECT MACHUNGTU, MACHUNGTULIENQUAN FROM TT_INV_CHUNGTUNHAP WHERE MACHUNGTULIENQUAN = '$MACHUNGTULIENQUAN$'
    </statement>
    <statement id="DAO00401_INV001_UpdateDonGia_HangHoa" parameterClass="DataObject">
      UPDATE TM_PUR_HANGHOA SET DONGIA = #DONGIA# WHERE ID = '$HANGHOA_ID$' AND  BENHVIEN_ID = '$BENHVIEN_ID$'
    </statement>
    <statement id="DAO00401_INV001_GetHangHoaNhapKho_PhieuPO" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      SELECT MACHUNGTULIENQUAN, SOLUONGNHAP, KHUYENMAI FROM TT_INV_CHUNGTUNHAPCHITIET A LEFT JOIN TT_INV_CHUNGTUNHAP B ON B.CHUNGTUNHAP_ID = A.CHUNGTUNHAP_ID WHERE B.MACHUNGTULIENQUAN = '$MACHUNGTULIENQUAN$'
    </statement>
  </statements>
</sqlMap>
