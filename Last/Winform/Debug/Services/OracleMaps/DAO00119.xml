<?xml version="1.0" encoding="utf-8" ?>
<!--============================================================================
//	CAUTION: This file is generated by IBatisNetGen.3.SQLMap.cst at 11/11/2015 9:27:48 AM
//				Any manual editing will be lost in re-generation.
//===========================================================================-->
<sqlMap namespace="eHospital" xmlns="http://ibatis.apache.org/mapping" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" >

  <statements>
    <statement id="DAO00119_TM_CONGTYCHITRA_GetList" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select * from TM_CONGTYCHITRA
      where BENHVIEN_ID = '$BENHVIEN_ID$'
      and TAMNGUNG = '$TAMNGUNG$'
    </statement>
    <statement id="DAO00119_TT_VIENPHI_GetList_BenhNhanThanhVienGoiPhaiThanhToan" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select VP.*
      from TT_VIENPHI VP
      where Vp.BENHNHAN_ID = '$BENHNHAN_ID$' and Vp.ACTIVE = '1' and
      REF_TABLE in ('TT_CSKH_GOI_DANGKY', 'TT_CSKH_THANHVIEN_CAPTHE') and
      ((vp.DATHANHTOAN = '0') or (vp.BENHNHAN_PHAITHANHTOAN > vp.GIATRI_BENHNHAN_DATHANHTOAN and vp.DATHANHTOAN = '1'))
    </statement>
    <statement id="DAO00119_TT_VIENPHI_GetList_TiepNhanPhaiThanhToan" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select  a.*, b.GIATRIMIENGIAM_BH, c.GIATRIMIENGIAM_BHTN, f.GIATRIMIENGIAM_THANHVIEN, g.GIATRIMIENGIAM_CTCT
      from
      (select VP.*, c.NOITHUCHIEN_ID, c.NOIYEUCAU_ID
      from TT_VIENPHI VP
      left join TT_DVYEUCAU c on c.DVYEUCAU_ID = VP.REF_ID  and vp.REF_TABLE = 'TT_DVYEUCAU'
      where Vp.TIEPNHAN_ID = '$TIEPNHAN_ID$' and Vp.ACTIVE = '1' and ((c.HUYYEUCAU != '1' and vp.DICHVU_ID is not null) or (vp.DUOC_ID is not null)) and
      ((vp.DATHANHTOAN = '0') or (vp.BENHNHAN_PHAITHANHTOAN > vp.GIATRI_BENHNHAN_DATHANHTOAN and vp.DATHANHTOAN = '1')) and c.DANGKY_ID is null
      ) a

      left join (select VIENPHI_ID,
      sum(MGCT.GIATRIMIENGIAM) AS GIATRIMIENGIAM_BH from TT_MIENGIAM MG
      INNER JOIN TT_MIENGIAM_CHITIET MGCT ON MG.MIENGIAM_ID = MGCT.MIENGIAM_ID
      where MG.TIEPNHAN_ID= '$TIEPNHAN_ID$' and MGCT.REF_TABLE = 'TT_MIENGIAM' and MG.TINHTRANG = 1 group by VIENPHI_ID
      ) b on a.VIENPHI_ID = b.VIENPHI_ID

      left join (select VIENPHI_ID, sum(MGCT.GIATRIMIENGIAM) AS GIATRIMIENGIAM_BHTN
      from TT_MIENGIAM_BHTN MG
      INNER JOIN TT_MIENGIAM_CHITIET MGCT ON MG.MIENGIAM_BHTN_ID = MGCT.MIENGIAM_ID
      where  MG.TIEPNHAN_ID= '$TIEPNHAN_ID$' and MGCT.REF_TABLE = 'TT_MIENGIAM_BHTN' and MG.TINHTRANG = 1 group by VIENPHI_ID
      )c on a.VIENPHI_ID = c.VIENPHI_ID

      left join (select VIENPHI_ID, sum(MGCT.GIATRIMIENGIAM) AS GIATRIMIENGIAM_THANHVIEN
      from TT_MIENGIAM_THANHVIEN MG
      INNER JOIN TT_MIENGIAM_CHITIET MGCT ON MG.MIENGIAM_THANHVIEN_ID = MGCT.MIENGIAM_ID
      where MG.TIEPNHAN_ID= '$TIEPNHAN_ID$' and MGCT.REF_TABLE = 'TT_MIENGIAM_THANHVIEN' and MG.TINHTRANG = 1 group by VIENPHI_ID
      )f on a.VIENPHI_ID = f.VIENPHI_ID

      left join(select VIENPHI_ID, sum(MGCT.GIATRIMIENGIAM) AS GIATRIMIENGIAM_CTCT
      from TT_MIENGIAM_CONGTY MG
      INNER JOIN TT_MIENGIAM_CHITIET MGCT ON MG.MIENGIAM_CONGTY_ID = MGCT.MIENGIAM_ID
      where MG.TIEPNHAN_ID= '$TIEPNHAN_ID$' and MGCT.REF_TABLE = 'TT_MIENGIAM_CONGTY' and MG.TINHTRANG = 1 group by VIENPHI_ID
      )g on a.VIENPHI_ID = g.VIENPHI_ID
    </statement>
    <statement id="DAO00119_TT_VIENPHI_GetList_TiepNhanPhaiThanhToanWithVienphiId" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select  a.*, b.GIATRIMIENGIAM_BH, c.GIATRIMIENGIAM_BHTN, f.GIATRIMIENGIAM_THANHVIEN, g.GIATRIMIENGIAM_CTCT
      from
      (select VP.*, c.NOITHUCHIEN_ID, c.NOIYEUCAU_ID
      from TT_VIENPHI VP
      left join TT_DVYEUCAU c on c.DVYEUCAU_ID = VP.REF_ID  and vp.REF_TABLE = 'TT_DVYEUCAU'
      where Vp.TIEPNHAN_ID = '$TIEPNHAN_ID$' and Vp.ACTIVE = '1' and ((c.HUYYEUCAU != '1' and vp.DICHVU_ID is not null) or (vp.DUOC_ID is not null)) and
      ((vp.DATHANHTOAN = '0') or (vp.BENHNHAN_PHAITHANHTOAN > vp.GIATRI_BENHNHAN_DATHANHTOAN and vp.DATHANHTOAN = '1')) and c.DANGKY_ID is null
      and vp.VIENPHI_ID in ($LIST_VIENPHI$)) a

      left join (select VIENPHI_ID,
      sum(MGCT.GIATRIMIENGIAM) AS GIATRIMIENGIAM_BH from TT_MIENGIAM MG
      INNER JOIN TT_MIENGIAM_CHITIET MGCT ON MG.MIENGIAM_ID = MGCT.MIENGIAM_ID
      where MG.TIEPNHAN_ID= '$TIEPNHAN_ID$' and MGCT.REF_TABLE = 'TT_MIENGIAM' and MG.TINHTRANG = 1 group by VIENPHI_ID
      ) b on a.VIENPHI_ID = b.VIENPHI_ID

      left join (select VIENPHI_ID, sum(MGCT.GIATRIMIENGIAM) AS GIATRIMIENGIAM_BHTN
      from TT_MIENGIAM_BHTN MG
      INNER JOIN TT_MIENGIAM_CHITIET MGCT ON MG.MIENGIAM_BHTN_ID = MGCT.MIENGIAM_ID
      where  MG.TIEPNHAN_ID= '$TIEPNHAN_ID$' and MGCT.REF_TABLE = 'TT_MIENGIAM_BHTN' and MG.TINHTRANG = 1 group by VIENPHI_ID
      )c on a.VIENPHI_ID = c.VIENPHI_ID

      left join (select VIENPHI_ID, sum(MGCT.GIATRIMIENGIAM) AS GIATRIMIENGIAM_THANHVIEN
      from TT_MIENGIAM_THANHVIEN MG
      INNER JOIN TT_MIENGIAM_CHITIET MGCT ON MG.MIENGIAM_THANHVIEN_ID = MGCT.MIENGIAM_ID
      where MG.TIEPNHAN_ID= '$TIEPNHAN_ID$' and MGCT.REF_TABLE = 'TT_MIENGIAM_THANHVIEN' and MG.TINHTRANG = 1 group by VIENPHI_ID
      )f on a.VIENPHI_ID = f.VIENPHI_ID

      left join(select VIENPHI_ID, sum(MGCT.GIATRIMIENGIAM) AS GIATRIMIENGIAM_CTCT
      from TT_MIENGIAM_CONGTY MG
      INNER JOIN TT_MIENGIAM_CHITIET MGCT ON MG.MIENGIAM_CONGTY_ID = MGCT.MIENGIAM_ID
      where MG.TIEPNHAN_ID= '$TIEPNHAN_ID$' and MGCT.REF_TABLE = 'TT_MIENGIAM_CONGTY' and MG.TINHTRANG = 1 group by VIENPHI_ID
      )g on a.VIENPHI_ID = g.VIENPHI_ID
    </statement>
    <statement id="DAO00119_TT_VIENPHI_GetList_BenhAnPhaiThanhToan" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select  a.*, b.GIATRIMIENGIAM_BH, c.GIATRIMIENGIAM_BHTN, f.GIATRIMIENGIAM_THANHVIEN, g.GIATRIMIENGIAM_CTCT
      from
      (select VP.*, c.NOITHUCHIEN_ID, c.NOIYEUCAU_ID
      from TT_VIENPHI VP
      left join TT_DVYEUCAU c on c.DVYEUCAU_ID = VP.REF_ID  and vp.REF_TABLE = 'TT_DVYEUCAU'
      where Vp.BENHAN_ID = '$BENHAN_ID$' and Vp.ACTIVE = '1' and ((c.HUYYEUCAU != '1' and vp.DICHVU_ID is not null) or (vp.DUOC_ID is not null) or (REF_TABLE = 'TT_NUT_XACNHANSUATAN_CHITIET')) and
      ((vp.DATHANHTOAN = '0') or (vp.BENHNHAN_PHAITHANHTOAN > vp.GIATRI_BENHNHAN_DATHANHTOAN and vp.DATHANHTOAN = '1')) and c.DANGKY_ID is null
      ) a

      left join (select VIENPHI_ID,
      sum(MGCT.GIATRIMIENGIAM) AS GIATRIMIENGIAM_BH from TT_MIENGIAM MG
      INNER JOIN TT_MIENGIAM_CHITIET MGCT ON MG.MIENGIAM_ID = MGCT.MIENGIAM_ID
      where MG.BENHAN_ID = '$BENHAN_ID$' and MGCT.REF_TABLE = 'TT_MIENGIAM' and MG.TINHTRANG = 1 group by VIENPHI_ID
      ) b on a.VIENPHI_ID = b.VIENPHI_ID

      left join (select VIENPHI_ID, sum(MGCT.GIATRIMIENGIAM) AS GIATRIMIENGIAM_BHTN
      from TT_MIENGIAM_BHTN MG
      INNER JOIN TT_MIENGIAM_CHITIET MGCT ON MG.MIENGIAM_BHTN_ID = MGCT.MIENGIAM_ID
      where  MG.BENHAN_ID = '$BENHAN_ID$' and MGCT.REF_TABLE = 'TT_MIENGIAM_BHTN' and MG.TINHTRANG = 1 group by VIENPHI_ID
      )c on a.VIENPHI_ID = c.VIENPHI_ID

      left join (select VIENPHI_ID, sum(MGCT.GIATRIMIENGIAM) AS GIATRIMIENGIAM_THANHVIEN
      from TT_MIENGIAM_THANHVIEN MG
      INNER JOIN TT_MIENGIAM_CHITIET MGCT ON MG.MIENGIAM_THANHVIEN_ID = MGCT.MIENGIAM_ID
      where MG.TIEPNHAN_ID = '$TIEPNHAN_ID$' and MGCT.REF_TABLE = 'TT_MIENGIAM_THANHVIEN' and MG.TINHTRANG = 1 group by VIENPHI_ID
      )f on a.VIENPHI_ID = f.VIENPHI_ID

      left join(select VIENPHI_ID, sum(MGCT.GIATRIMIENGIAM) AS GIATRIMIENGIAM_CTCT
      from TT_MIENGIAM_CONGTY MG
      INNER JOIN TT_MIENGIAM_CHITIET MGCT ON MG.MIENGIAM_CONGTY_ID = MGCT.MIENGIAM_ID
      where MG.BENHAN_ID = '$BENHAN_ID$' and MGCT.REF_TABLE = 'TT_MIENGIAM_CONGTY' and MG.TINHTRANG = 1 group by VIENPHI_ID
      )g on a.VIENPHI_ID = g.VIENPHI_ID
    </statement>
    <statement id="DAO00119_TT_VIENPHI_GetList_BenhAnPhaiThanhToanWithVienPhiId" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select  a.*, b.GIATRIMIENGIAM_BH, c.GIATRIMIENGIAM_BHTN, f.GIATRIMIENGIAM_THANHVIEN, g.GIATRIMIENGIAM_CTCT
      from
      (select VP.*, c.NOITHUCHIEN_ID, c.NOIYEUCAU_ID
      from TT_VIENPHI VP
      left join TT_DVYEUCAU c on c.DVYEUCAU_ID = VP.REF_ID  and vp.REF_TABLE = 'TT_DVYEUCAU'
      where Vp.BENHAN_ID = '$BENHAN_ID$' and Vp.ACTIVE = '1' and ((c.HUYYEUCAU != '1' and vp.DICHVU_ID is not null) or (vp.DUOC_ID is not null)  or (REF_TABLE = 'TT_NUT_XACNHANSUATAN_CHITIET')) and
      ((vp.DATHANHTOAN = '0') or (vp.BENHNHAN_PHAITHANHTOAN > vp.GIATRI_BENHNHAN_DATHANHTOAN and vp.DATHANHTOAN = '1')) and c.DANGKY_ID is null
      and vp.VIENPHI_ID in ($LIST_VIENPHI$)) a

      left join (select VIENPHI_ID,
      sum(MGCT.GIATRIMIENGIAM) AS GIATRIMIENGIAM_BH from TT_MIENGIAM MG
      INNER JOIN TT_MIENGIAM_CHITIET MGCT ON MG.MIENGIAM_ID = MGCT.MIENGIAM_ID
      where MG.BENHAN_ID = '$BENHAN_ID$' and MGCT.REF_TABLE = 'TT_MIENGIAM' and MG.TINHTRANG = 1 group by VIENPHI_ID
      ) b on a.VIENPHI_ID = b.VIENPHI_ID

      left join (select VIENPHI_ID, sum(MGCT.GIATRIMIENGIAM) AS GIATRIMIENGIAM_BHTN
      from TT_MIENGIAM_BHTN MG
      INNER JOIN TT_MIENGIAM_CHITIET MGCT ON MG.MIENGIAM_BHTN_ID = MGCT.MIENGIAM_ID
      where  MG.BENHAN_ID = '$BENHAN_ID$' and MGCT.REF_TABLE = 'TT_MIENGIAM_BHTN' and MG.TINHTRANG = 1 group by VIENPHI_ID
      )c on a.VIENPHI_ID = c.VIENPHI_ID

      left join (select VIENPHI_ID, sum(MGCT.GIATRIMIENGIAM) AS GIATRIMIENGIAM_THANHVIEN
      from TT_MIENGIAM_THANHVIEN MG
      INNER JOIN TT_MIENGIAM_CHITIET MGCT ON MG.MIENGIAM_THANHVIEN_ID = MGCT.MIENGIAM_ID
      where MG.TIEPNHAN_ID = '$TIEPNHAN_ID$' and MGCT.REF_TABLE = 'TT_MIENGIAM_THANHVIEN' and MG.TINHTRANG = 1 group by VIENPHI_ID
      )f on a.VIENPHI_ID = f.VIENPHI_ID

      left join(select VIENPHI_ID, sum(MGCT.GIATRIMIENGIAM) AS GIATRIMIENGIAM_CTCT
      from TT_MIENGIAM_CONGTY MG
      INNER JOIN TT_MIENGIAM_CHITIET MGCT ON MG.MIENGIAM_CONGTY_ID = MGCT.MIENGIAM_ID
      where MG.BENHAN_ID = '$BENHAN_ID$' and MGCT.REF_TABLE = 'TT_MIENGIAM_CONGTY' and MG.TINHTRANG = 1 group by VIENPHI_ID
      )g on a.VIENPHI_ID = g.VIENPHI_ID
    </statement>
    <statement id="DAO00119_TT_VIENPHI_GetList_TiepNhanByHoadon" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select  a.*, a.MIENGIAM_GIATRI as GIATRIMIENGIAM_BH, a.BHTN_GIATRI as GIATRIMIENGIAM_BHTN, a.HOIVIEN_GIATRI as GIATRIMIENGIAM_THANHVIEN, a.CONGTYCHITRA_GIATRI as GIATRIMIENGIAM_CTCT,
      dc.TENDUOCDAYDU NOIDUNG, dc.MADUOC MADICHVU, ld.MALOAIDUOC, dc.BHYT DUOC_BHYT, ld.LOAIVATTU_ID
      from
      (select vp.*, c.NOITHUCHIEN_ID, c.NOIYEUCAU_ID, vpp.DATHUCHIEN, vpp.TIEPNHAN_ID, vpp.BENHAN_ID
      from TT_HOADON_CHITIET_NGOAITRU VP
      left join TT_VIENPHI vpp on vpp.VIENPHI_ID = VP.VIENPHI_ID
      left join TT_DVYEUCAU c on c.DVYEUCAU_ID = VP.REF_ID
      where
      vp.HOADON_ID = '$HOADON_ID$'
      ) a
      left join TM_DUOC dc on A.DUOC_ID = dc.DUOC_ID
      left join TM_LOAIDUOC ld on dc.LOAIDUOC_ID = ld.LOAIDUOC_ID
    </statement>
    <statement id="DAO00119_TT_VIENPHI_GetList_BenhAnByHoadon" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select  a.*, a.MIENGIAM_GIATRI as GIATRIMIENGIAM_BH, a.BHTN_GIATRI as GIATRIMIENGIAM_BHTN, a.HOIVIEN_GIATRI as GIATRIMIENGIAM_THANHVIEN, a.CONGTYCHITRA_GIATRI as GIATRIMIENGIAM_CTCT
      from
      (select vp.*, c.NOITHUCHIEN_ID, c.NOIYEUCAU_ID, vpp.DATHUCHIEN, vpp.TIEPNHAN_ID, vpp.BENHAN_ID
      from TT_HOADON_CHITIET_NOITRU VP
      left join TT_VIENPHI vpp on vpp.VIENPHI_ID = VP.VIENPHI_ID
      left join TT_DVYEUCAU c on c.DVYEUCAU_ID = VP.REF_ID
      where
      vp.HOADON_ID = '$HOADON_ID$'
      ) a
    </statement>
    <statement id="DAO00119_TT_VIENPHI_GetList_TiepNhanDaThanhToan" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select * from TT_VIENPHI
      where
      TIEPNHAN_ID = '$TIEPNHAN_ID$' and 
      (BENHNHAN_PHAITHANHTOAN = GIATRI_BENHNHAN_DATHANHTOAN and DATHANHTOAN = '1')
      and VIENPHI_ID in ($LIST_VIENPHI$)
    </statement>   
    <statement id="DAO00119_TT_VIENPHI_GetList_BenhAnDaThanhToan" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select * from TT_VIENPHI
      where
      TIEPNHAN_ID = '$TIEPNHAN_ID$' and BENHAN_ID = '$BENHAN_ID$' and
      (BENHNHAN_PHAITHANHTOAN = GIATRI_BENHNHAN_DATHANHTOAN and DATHANHTOAN = '1')
      and VIENPHI_ID in ($LIST_VIENPHI$)
    </statement>
    <statement id="DAO00119_TT_VIENPHI_GetList_BenhNhanDaThanhToan" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select * from TT_VIENPHI
      where
      BENHNHAN_ID = '$BENHNHAN_ID$' and
      (BENHNHAN_PHAITHANHTOAN = GIATRI_BENHNHAN_DATHANHTOAN and DATHANHTOAN = '1')
      and VIENPHI_ID in ($LIST_VIENPHI$)
    </statement>
    <statement id="DAO00119_TT_VIENPHI_GetList_DVYeuCauDaThanhToan" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select * from TT_VIENPHI vp
      where
      TIEPNHAN_ID = '$TIEPNHAN_ID$' and
      (vp.DATHANHTOAN = '1') and REF_ID in ($LIST_REFID$)      
    </statement>
    <statement id="DAO00119_TT_VIENPHI_GetList_DVYeuCauDaPhatSinhMienGiam" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select * from TT_MIENGIAM_CHITIET
      where 
      VIENPHI_ID in ( select VIENPHI_ID from TT_VIENPHI vp where TIEPNHAN_ID = '$TIEPNHAN_ID$' and REF_ID in ($DS_DVYEUCAU$) and REF_TABLE = 'TT_DVYEUCAU')
    </statement>
    <statement id="DAO00119_TT_VIENPHI_GetList_VPHienTai" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select * from TT_VIENPHI vp
      where
      ((vp.DATHANHTOAN = '0') or (vp.BENHNHAN_PHAITHANHTOAN > vp.GIATRI_BENHNHAN_DATHANHTOAN and vp.DATHANHTOAN = '1'))
      and VIENPHI_ID in ($LIST_VIENPHI$)
      <isNotEmpty prepend="and" property="TIEPNHAN_ID">
        TIEPNHAN_ID = '$TIEPNHAN_ID$'
      </isNotEmpty>
      <isNotEmpty prepend="and" property="BENHNHAN_ID">
        BENHNHAN_ID = '$BENHNHAN_ID$' and REF_TABLE in ('TT_CSKH_GOI_DANGKY', 'TT_CSKH_THANHVIEN_CAPTHE')
      </isNotEmpty>
    </statement>
    <statement id="DAO00119_TT_VIENPHI_GetList_VPHienTai_MuaNgoaiTT" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select * from TT_VIENPHI vp
      where
      ((vp.DATHANHTOAN = '0') or (vp.BENHNHAN_PHAITHANHTOAN > vp.GIATRI_BENHNHAN_DATHANHTOAN and vp.DATHANHTOAN = '1'))
      and VIENPHI_ID in ($LIST_VIENPHI$)
      <!--<isNotEmpty prepend="and" property="TIEPNHAN_ID">
        TIEPNHAN_ID = '$TIEPNHAN_ID$'
      </isNotEmpty>
      <isNotEmpty prepend="and" property="BENHNHAN_ID">
        BENHNHAN_ID = '$BENHNHAN_ID$' and REF_TABLE in ('TT_DUOC_CHUNGTU_CHITIET')
      </isNotEmpty>-->
    </statement>
    <statement id="DAO00119_TT_VIENPHI_GetList_TiepNhanChuaMienGiamBHTN" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select A.* from
      TT_MIENGIAM_BHTN A
      left join TT_MIENGIAM_CHITIET B on B.MIENGIAM_ID = A.MIENGIAM_BHTN_ID and B.REF_TABLE = 'TT_MIENGIAM_BHTN'
      where  A.TINHTRANG = '0' and B.VIENPHI_ID in ($LIST_VIENPHI$) and A.TIEPNHAN_ID = '$TIEPNHAN_ID$'   
    </statement>
    <statement id="DAO00119_TT_VIENPHI_GetList_TiepNhanDaThucHien" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select * from TT_VIENPHI
      where
      HOADON_ID = '$HOADON_ID$' and (DATHUCHIEN = '0' or DICHVU_ID is null) and VIENPHI_ID in ($LIST_VIENPHI$)
      <isNotEmpty prepend="and" property="TIEPNHAN_ID">
        TIEPNHAN_ID = '$TIEPNHAN_ID$'
      </isNotEmpty>
      <isNotEmpty prepend="and" property="BENHNHAN_ID">
        BENHNHAN_ID = '$BENHNHAN_ID$' and REF_TABLE in ('TT_CSKH_GOI_DANGKY', 'TT_CSKH_THANHVIEN_CAPTHE')
      </isNotEmpty>
    </statement>
    <statement id="DAO00119_TT_VIENPHI_GetList_DVDaLayMau" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select A.* from TT_VIENPHI A
      left join TT_DVYEUCAU B on A.REF_ID = B.DVYEUCAU_ID
      where
      A.HOADON_ID = '$HOADON_ID$' and A.DATHUCHIEN = '0' and A.VIENPHI_ID in ($LIST_VIENPHI$) and A.REF_TABLE = 'TT_DVYEUCAU' and B.TRANGTHAI = 'DALAYMAU'
      <isNotEmpty prepend="and" property="TIEPNHAN_ID">
        A.TIEPNHAN_ID = '$TIEPNHAN_ID$'
      </isNotEmpty>      
    </statement>
    
    <statement id="DAO00119_TT_VIENPHI_GetList_SauKhiHuyThuThay" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select A.* from TT_VIENPHI A      
      where A.VIENPHI_ID in ($LIST_VIENPHI$)
      <isNotEmpty prepend="and" property="TIEPNHAN_ID">
        A.TIEPNHAN_ID = '$TIEPNHAN_ID$'
      </isNotEmpty>      
    </statement>
    <statement id="DAO00119_TT_VIENPHI_XoaBienLaiTamNgoaiTru" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      BEGIN
      delete from TT_HOADON_HINHTHUCTHANHTOAN where HOADON_ID = '$HOADON_ID$';

      delete from TT_HOADON_CHITIET_NGOAITRU where HOADON_ID = '$HOADON_ID$';

      delete from TT_HOADON where HOADON_ID = '$HOADON_ID$';
      END;
    </statement>
    <statement id="DAO00119_TT_VIENPHI_XoaBienLaiTamNoiTru" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      BEGIN
      delete from TT_HOADON_HINHTHUCTHANHTOAN
      where HOADON_ID = '$HOADON_ID$';

      delete from TT_HOADON_CHITIET_NOITRU
      where HOADON_ID = '$HOADON_ID$';

      delete from TT_HOADON
      where HOADON_ID = '$HOADON_ID$';
      END;
    </statement>
    <update id="DAO00119_TT_HOADON_Update_GhiNhanHuy" parameterClass="System.Collections.IDictionary">
      update TT_HOADON set
      NGUOI_GHINHANHUY_ID = #NGUOI_GHINHANHUY_ID#
      , NGUOICAPNHAT_ID = #NGUOICAPNHAT_ID#
      , THOIGIAN_GHINHANHUY = #THOIGIAN_GHINHANHUY#
      , NGAYCAPNHAT = #NGAYCAPNHAT#
      , TRANGTHAI = 'CHODUYET'
      , BENHVIEN_ID = #BENHVIEN_ID#
      , LYDOHUY_ID = #LYDOHUY_ID#
      , GHICHU = #GHICHU#
      where
      HOADON_ID in ($HOADON_ID$)
    </update>
    <statement id="DAO00119_TT_HOADON_KiemTra_DaGhiNhanHuy" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select * from TT_HOADON
      where HOADON_ID in ($HOADON_ID$) and (TRANGTHAI = 'CHODUYET' or (TRANGTHAI = 'DADUYET' and HUYHOADON = '1'))
    </statement>
    <statement id="DAO00119_TT_HOADON_Huy_BienLaiNgoaiTru" parameterClass="System.Collections.IDictionary">
      <!--update vien phi-->
      declare
      Data_Cursor   SYS_REFCURSOR;
      l_return   TT_HOADON_CHITIET_NGOAITRU%ROWTYPE;
      BEGIN
      OPEN Data_Cursor FOR
      SELECT * FROM TT_HOADON_CHITIET_NGOAITRU where HOADON_ID = '$HOADON_ID$';
      LOOP
      FETCH Data_Cursor INTO l_return;
      EXIT WHEN Data_Cursor%NOTFOUND;
      update TT_VIENPHI set
      HUY = '1',
      DATHANHTOAN = '0',
      DUOCPHEPTHUCHIEN = '0',
      GIATRI_BENHNHAN_DATHANHTOAN = GIATRI_BENHNHAN_DATHANHTOAN - l_return.GIATRI_BENHNHAN_DATHANHTOAN,
      GIATRI_HOADON_DATHANHTOAN = GIATRI_HOADON_DATHANHTOAN - l_return.GIATRI_BENHNHAN_DATHANHTOAN,
      NGUOICAPNHAT_ID = '$NGUOICAPNHAT_ID$',
      NGAYCAPNHAT = TO_DATE('$NGAYCAPNHAT$', 'mm-dd-yyyy hh:mi:ss AM')
      where HOADON_ID = '$HOADON_ID$' and VIENPHI_ID = l_return.VIENPHI_ID;
      <!--DBMS_OUTPUT.put_line (l_return.VIENPHI_ID);-->
      END LOOP;
      CLOSE Data_Cursor;
      <!--update hoa don-->
      update TT_HOADON set
      HUYHOADON = '$HUYHOADON$',
      HOANTRA = '$HOANTRA$',
      NGUOICAPNHAT_ID = #NGUOICAPNHAT_ID#,
      NGAYCAPNHAT = #NGAYCAPNHAT#
      where HOADON_ID = $HOADON_ID$;

      <!--Update các biên lai tạm ứng-->
      update TT_HOADON set
      TRANGTHAI = 'DATHUTIEN',
      NGUOICAPNHAT_ID = #NGUOICAPNHAT_ID#,
      NGAYCAPNHAT = #NGAYCAPNHAT#
      where HOADONLIENQUAN_ID = #HOADON_ID#;

    END;
    </statement>
    <statement id="DAO00119_TT_HOADON_Huy_BienLaiNoiTru" parameterClass="System.Collections.IDictionary">
      <!--update vien phi-->
      declare
      Data_Cursor   SYS_REFCURSOR;
      l_return   TT_HOADON_CHITIET_NGOAITRU%ROWTYPE;
      BEGIN
      OPEN Data_Cursor FOR
      SELECT * FROM TT_HOADON_CHITIET_NOITRU where HOADON_ID = '$HOADON_ID$';
      LOOP
      FETCH Data_Cursor INTO l_return;
      EXIT WHEN Data_Cursor%NOTFOUND;
      update TT_VIENPHI set
      HUY = '1',
      DATHANHTOAN = '0',
      DUOCPHEPTHUCHIEN = '0',
      GIATRI_BENHNHAN_DATHANHTOAN = GIATRI_BENHNHAN_DATHANHTOAN - l_return.GIATRI_BENHNHAN_DATHANHTOAN,
      GIATRI_HOADON_DATHANHTOAN = GIATRI_HOADON_DATHANHTOAN - l_return.GIATRI_BENHNHAN_DATHANHTOAN,
      NGUOICAPNHAT_ID = '$NGUOICAPNHAT_ID$',
      NGAYCAPNHAT = TO_DATE('$NGAYCAPNHAT$', 'mm-dd-yyyy hh:mi:ss AM')
      where HOADON_ID = '$HOADON_ID$' and VIENPHI_ID = l_return.VIENPHI_ID;
      <!--DBMS_OUTPUT.put_line (l_return.VIENPHI_ID);-->
      END LOOP;
      CLOSE Data_Cursor;
      <!--update hoa don-->
      update TT_HOADON set
      HUYHOADON = '$HUYHOADON$',
      HOANTRA = '$HOANTRA$',
      NGUOICAPNHAT_ID = #NGUOICAPNHAT_ID#,
      NGAYCAPNHAT = #NGAYCAPNHAT#
      where HOADON_ID = $HOADON_ID$;

      <!--Update các biên lai tạm ứng-->
      update TT_HOADON set
      TRANGTHAI = 'DATHUTIEN',
      NGUOICAPNHAT_ID = #NGUOICAPNHAT_ID#,
      NGAYCAPNHAT = #NGAYCAPNHAT#
      where HOADONLIENQUAN_ID = #HOADON_ID#;

      END;
    </statement>
    <statement id="DAO00119_TT_HOADON_GetDanhSachHoaDonThanhToanDaDuyetHuyNgoaiTru" parameterClass="System.Collections.IDictionary"  resultClass="DataObject">
      <!--select *
      from TT_HOADON
      where
      TIEPNHAN_ID = '$TIEPNHAN_ID$' and BENHAN_ID is null and DATHANHTOAN = '1' and HUYHOADON = '0'-->
      select distinct A.*
      from TT_HOADON A
      left join TT_HOADON_CHITIET_NGOAITRU B on A.HOADON_ID = B.HOADON_ID
      where
      A.TIEPNHAN_ID = '$TIEPNHAN_ID$' and A.BENHAN_ID is null and A.DATHANHTOAN = '1' and A.HUYHOADON = '0'
      and B.REF_TABLE not in ('TT_CSKH_GOI_DANGKY', 'TT_CSKH_THANHVIEN_CAPTHE', 'TT_DUOC_CHUNGTU_CHITIET')
    </statement>

    <statement id="DAO00119_TT_NOITRU_BENHAN_Update_TrangThai" parameterClass="System.Collections.IDictionary"  resultClass="DataObject">
      update TT_NOITRU_BENHAN
      set TRANGTHAI = '$TRANGTHAI$'
      where TIEPNHAN_ID = '$TIEPNHAN_ID$'
    </statement>
  </statements>   
</sqlMap>