<?xml version="1.0" encoding="utf-8" ?>
<!--============================================================================
//	CAUTION: This file is generated by IBatisNetGen.3.SQLMap.cst at 11/11/2015 9:27:48 AM
//				Any manual editing will be lost in re-generation.
//===========================================================================-->
<sqlMap namespace="eHospital" xmlns="http://ibatis.apache.org/mapping" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" >
  <statements>
    <statement id="DAO00085_UpdateDichVuChoThe" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      insert into TT_CSKH_THETHANHVIEN_SUDUNG
      select
      '$THE_ID$' as THE_ID
      ,[THETHANHVIEN_ID]
      ,[DICHVU_ID]
      ,[SOLANTHUCHIEN] as SOLANDINHMUC
      ,0 as SOLANDASUDUNG
      ,[SOLANTHUCHIEN] as SOLANCONLAI
      ,[TYLEGIAM]
      ,[SOTIENGIAM]
      ,[BENHVIEN_ID]
      , GetDate() as NGAYTAO
      ,'$NGUOITAO_ID$' as NGUOITAO_ID
      , GetDate() as NGAYCAPNHAT
      ,'$NGUOICAPNHAT_ID$' as NGUOICAPNHAT_ID
      from TM_CSKH_THETHANHVIEN_DICHVU
      where THETHANHVIEN_ID = (select THETHANHVIEN_ID from TT_CSKH_THANHVIEN_CAPTHE where THE_ID = '$THE_ID$' and BENHVIEN_ID = '$BENHVIEN_ID$') and BENHVIEN_ID = '$BENHVIEN_ID$'
    </statement>
    <statement id="DAO00085_SoVoucherDaTontai" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select * from TT_CSKH_THANHVIEN_CAPTHE
      where SOVOUCHER = '$SOVOUCHER$'
    </statement>
    <statement id="DAO00085_GetBenhNhanThanhVien" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select * from TT_CSKH_THANHVIEN
      where
      BENHNHAN_ID = '$BENHNHAN_ID$'
      and (TAMNGUNG is null or TAMNGUNG = '0')  and (DAXOA is null or DAXOA = '0')
    </statement>
    <statement id="DAO00085_GetListTheBenhNhan" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select
      A.BENHNHAN_ID, A.NGAYTAOHOIVIEN, A.BACSICHIDINH_ID, A.NOICHIDINH_ID, '0' as UPDATETHE,
      B.*
      from  TT_CSKH_THANHVIEN_CAPTHE B
      left join TT_CSKH_THANHVIEN A on A.THANHVIEN_ID = B.THANHVIEN_ID and B.THETHANHVIEN_ID is not null and (B.TAMNGUNG is null or B.TAMNGUNG = '0')
      where
      BENHNHAN_ID = '$BENHNHAN_ID$'
      and (A.TAMNGUNG is null or A.TAMNGUNG = '0')  and (A.DAXOA is null or A.DAXOA = '0')
    </statement>
    <statement id="DAO00085_GetCountThanhVienTheBenhNhan" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      SELECT count(B.THE_ID) as TOTALROWS
      from TT_CSKH_THANHVIEN A
      left join
      (
      select A.THE_ID, A.MATHE, A.KICHHOAT, A.THETHANHVIEN_ID, A.THANHVIEN_ID, A.NGAYTAO, A.NGAYDANGKY, A.NGAYKICHHOAT, A.TAMNGUNG, A.SOVOUCHER,
      B.TENTHETHANHVIEN
      from TT_CSKH_THANHVIEN_CAPTHE A
      left join TM_CSKH_THETHANHVIEN B on A.THETHANHVIEN_ID =  B.THETHANHVIEN_ID
      ) B on A.THANHVIEN_ID = B.THANHVIEN_ID
      inner join TT_BENHNHAN C on C.BENHNHAN_ID = A.BENHNHAN_ID <!--and C.BENHVIEN_ID = '$BENHVIEN_ID$'-->
      where A.BENHVIEN_ID = '$BENHVIEN_ID$' and B.TAMNGUNG is null
      <isNotEmpty prepend="and" property="TENBENHNHAN">
        (C.TENBENHNHAN like '%' + #TENBENHNHAN# + '%' or C.MAYTE like '%' + #TENBENHNHAN# + '%')
      </isNotEmpty>
      <isNotEmpty prepend="and" property="MATHETHANHVIEN">
        (B.MATHE like '%' + #MATHETHANHVIEN# + '%')
      </isNotEmpty>
      <isNotEmpty prepend="" property="ISNGAYHETHAN">
        <isEqual prepend="" property="ISNGAYHETHAN" compareValue="0">
          <isNotEmpty prepend="and" property="TUNGAY">
            CAST(B.NGAYTAO as date) &#62;&#61; '$TUNGAY$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="DENNGAY">
            CAST(B.NGAYTAO as date) &#60;&#61; '$DENNGAY$'
          </isNotEmpty>
        </isEqual>
        <isEqual prepend="" property="ISNGAYHETHAN" compareValue="1">
          <isNotEmpty prepend="and" property="TUNGAY">
            CAST(B.NGAYKICHHOAT as date) &#62;&#61; '$TUNGAY$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="DENNGAY">
            CAST(B.NGAYKICHHOAT as date) &#60;&#61; '$DENNGAY$'
          </isNotEmpty>
        </isEqual>
      </isNotEmpty>
    </statement>
    <statement id="DAO00085_GetListThanhVienTheBenhNhan" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select *
      from
      (select
      ROW_NUMBER() OVER(order by A.BENHNHAN_ID) as ROWNUMBER,
      A.MATHANHVIEN,
      B.THE_ID, B.MATHE, B.KICHHOAT, B.THETHANHVIEN_ID, B.TENTHETHANHVIEN,B.NGAYHIEULUC, B.NGAYHETHAN, B.DATHUTIEN, B.NGAYKICHHOAT,
      C.*, D.DESCRIPTION, B.TAMNGUNG, B.SOVOUCHER
      from TT_CSKH_THANHVIEN A
      left join
      (
      select A.THE_ID, A.MATHE, A.KICHHOAT, A.DATHUTIEN, A.THETHANHVIEN_ID, A.THANHVIEN_ID, A.NGAYTAO, A.NGAYDANGKY, A.NGAYKICHHOAT,
      B.TENTHETHANHVIEN, A.NGAYHIEULUC, A.NGAYHETHAN, A.TAMNGUNG, A.SOVOUCHER
      from TT_CSKH_THANHVIEN_CAPTHE A
      left join TM_CSKH_THETHANHVIEN B on A.THETHANHVIEN_ID =  B.THETHANHVIEN_ID
      ) B on A.THANHVIEN_ID = B.THANHVIEN_ID
      inner join TT_BENHNHAN C on C.BENHNHAN_ID = A.BENHNHAN_ID <!--and C.BENHVIEN_ID = '$BENHVIEN_ID$'-->
      left join TM_GENDER D on C.GIOITINH = D.ID <!--and C.BENHVIEN_ID = '$BENHVIEN_ID$'-->
      where A.BENHVIEN_ID = '$BENHVIEN_ID$' and B.TAMNGUNG is null
      <isNotEmpty prepend="and" property="TENBENHNHAN">
        (C.TENBENHNHAN like '%' + #TENBENHNHAN# + '%' or C.MAYTE like '%' + #TENBENHNHAN# + '%')
      </isNotEmpty>
      <isNotEmpty prepend="and" property="MATHETHANHVIEN">
        (B.MATHE like '%' + #MATHETHANHVIEN# + '%')
      </isNotEmpty>
      <isNotEmpty prepend="" property="ISNGAYHETHAN">
        <isEqual prepend="" property="ISNGAYHETHAN" compareValue="0">
          <isNotEmpty prepend="and" property="TUNGAY">
            CAST(B.NGAYTAO as date) &#62;&#61; '$TUNGAY$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="DENNGAY">
            CAST(B.NGAYTAO as date) &#60;&#61; '$DENNGAY$'
          </isNotEmpty>
        </isEqual>
        <isEqual prepend="" property="ISNGAYHETHAN" compareValue="1">
          <isNotEmpty prepend="and" property="TUNGAY">
            CAST(B.NGAYKICHHOAT as date) &#62;&#61; '$TUNGAY$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="DENNGAY">
            CAST(B.NGAYKICHHOAT as date) &#60;&#61; '$DENNGAY$'
          </isNotEmpty>
        </isEqual>
      </isNotEmpty>
      ) lst
      <isNotEmpty prepend="" property="FROMROW">
        where
        lst.ROWNUMBER between $FROMROW$ and $TOROW$
      </isNotEmpty>
      order by lst.BENHNHAN_ID asc      
    </statement>
    <statement id="DAO00085_GetAllThanhVienTheBenhNhan" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select
      ROW_NUMBER() OVER(order by A.BENHNHAN_ID) as ROWNUMBER,
      A.MATHANHVIEN,
      B.THE_ID, B.MATHE, B.KICHHOAT, B.THETHANHVIEN_ID, B.TENTHETHANHVIEN,B.NGAYHIEULUC, B.NGAYHETHAN, B.DATHUTIEN,
      C.*, D.DESCRIPTION
      from TT_CSKH_THANHVIEN A
      left join
      (
      select A.THE_ID, A.MATHE, A.KICHHOAT, A.DATHUTIEN, A.THETHANHVIEN_ID, A.THANHVIEN_ID,
      B.TENTHETHANHVIEN, A.NGAYHIEULUC, A.NGAYHETHAN
      from TT_CSKH_THANHVIEN_CAPTHE A
      left join TM_CSKH_THETHANHVIEN B on A.THETHANHVIEN_ID =  B.THETHANHVIEN_ID
      ) B on A.THANHVIEN_ID = B.THANHVIEN_ID
      inner join TT_BENHNHAN C on C.BENHNHAN_ID = A.BENHNHAN_ID <!--and C.BENHVIEN_ID = '$BENHVIEN_ID$'-->
      left join TM_GENDER D on C.GIOITINH = D.ID <!--and C.BENHVIEN_ID = '$BENHVIEN_ID$'-->
      where A.BENHVIEN_ID = '$BENHVIEN_ID$' AND B.KICHHOAT = '1'
      <isNotEmpty prepend="and" property="TENBENHNHAN">
        (C.TENBENHNHAN like '%' + #TENBENHNHAN# + '%' or C.MAYTE like '%' + #TENBENHNHAN# + '%')
      </isNotEmpty>
      <isNotEmpty prepend="and" property="MATHETHANHVIEN">
        (B.MATHE like '%' + #MATHETHANHVIEN# + '%')
      </isNotEmpty>      
      order by B.BENHNHAN_ID asc
    </statement>
    <statement id="DAO00085_GetDichVuOfThanhVienThe" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select A.*, B.TENDICHVU, B.MADICHVU
      from TT_CSKH_THETHANHVIEN_SUDUNG A
      left join TM_DICHVU B on B.DICHVU_ID = A.DICHVU_ID and B.BENHVIEN_ID = '$BENHVIEN_ID$'
      where THE_ID = '$THE_ID$'
    </statement>
    <statement id="DAO00085_DeleteTheThanhVien" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      update TT_CSKH_THANHVIEN_CAPTHE set TAMNGUNG = '1' where THE_ID in ($THE_ID$);
      update TT_VIENPHI set ACTIVE = '0' where REF_TABLE = 'TT_CSKH_THANHVIEN_CAPTHE' and REF_ID in ($THE_ID$);
    </statement>
    <statement id="DAO00085_DeleteThanhVien" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      update TT_CSKH_THANHVIEN set TAMNGUNG = '1' where BENHNHAN_ID = '$BENHNHAN_ID$';
    </statement>
    <insert id="DAO00085_Add" parameterClass="System.Collections.IDictionary" resultClass="System.Int64">
      insert into TT_CSKH_THANHVIEN (
      MATHANHVIEN
      , BENHNHAN_ID
      , NGAYTAOHOIVIEN
      , NOICHIDINH_ID
      , BACSICHIDINH_ID
      , DATHUTIEN
      , DAXOA
      , TAMNGUNG
      , BENHVIEN_ID
      , NGAYTAO
      , NGUOITAO_ID
      , NGAYCAPNHAT
      , NGUOICAPNHAT_ID
      ) values (
      #MATHANHVIEN#
      , #BENHNHAN_ID#
      , #NGAYTAOHOIVIEN#
      , #NOICHIDINH_ID#
      , #BACSICHIDINH_ID#
      , #DATHUTIEN#
      , #DAXOA#
      , #TAMNGUNG#
      , #BENHVIEN_ID#
      , #NGAYTAO#
      , #NGUOITAO_ID#
      , #NGAYCAPNHAT#
      , #NGUOICAPNHAT_ID#
      )
      <selectKey resultClass="System.Int64" type="post" >
        SELECT @@IDENTITY as value
      </selectKey>
    </insert>
    <update id="DAO00085_Update" parameterClass="System.Collections.IDictionary">
      update TT_CSKH_THANHVIEN set
      MATHANHVIEN = #MATHANHVIEN#
      <isPropertyAvailable prepend="," property="BENHNHAN_ID">
        BENHNHAN_ID = #BENHNHAN_ID#
      </isPropertyAvailable>
      <isPropertyAvailable prepend="," property="NGAYTAOHOIVIEN">
        NGAYTAOHOIVIEN = #NGAYTAOHOIVIEN#
      </isPropertyAvailable>
      <isPropertyAvailable prepend="," property="NOICHIDINH_ID">
        NOICHIDINH_ID = #NOICHIDINH_ID#
      </isPropertyAvailable>
      <isPropertyAvailable prepend="," property="BACSICHIDINH_ID">
        BACSICHIDINH_ID = #BACSICHIDINH_ID#
      </isPropertyAvailable>
      <isPropertyAvailable prepend="," property="DATHUTIEN">
        DATHUTIEN = #DATHUTIEN#
      </isPropertyAvailable>
      <isPropertyAvailable prepend="," property="DAXOA">
        DAXOA = #DAXOA#
      </isPropertyAvailable>
      <isPropertyAvailable prepend="," property="TAMNGUNG">
        TAMNGUNG = #TAMNGUNG#
      </isPropertyAvailable>
      <isPropertyAvailable prepend="," property="BENHVIEN_ID">
        BENHVIEN_ID = #BENHVIEN_ID#
      </isPropertyAvailable>
      <isPropertyAvailable prepend="," property="NGAYTAO">
        NGAYTAO = #NGAYTAO#
      </isPropertyAvailable>
      <isPropertyAvailable prepend="," property="NGUOITAO_ID">
        NGUOITAO_ID = #NGUOITAO_ID#
      </isPropertyAvailable>
      <isPropertyAvailable prepend="," property="NGAYCAPNHAT">
        NGAYCAPNHAT = #NGAYCAPNHAT#
      </isPropertyAvailable>
      <isPropertyAvailable prepend="," property="NGUOICAPNHAT_ID">
        NGUOICAPNHAT_ID = #NGUOICAPNHAT_ID#
      </isPropertyAvailable>
      where
      THANHVIEN_ID = '$THANHVIEN_ID$'
    </update>
    <insert id="DAO00085_Add_THANHVIEN_THE" parameterClass="System.Collections.IDictionary" resultClass="System.Int64">
      insert into TT_CSKH_THANHVIEN_CAPTHE (
      MATHE
      , TAIKHOAN_ID
      , THANHVIEN_ID
      , THETHANHVIEN_ID
      , DATHUTIEN
      , NGAYDANGKY
      , NGAYHIEULUC
      , NGAYHETHAN
      , KICHHOAT
      , TAMNGUNG
      , THOIHAN
      , SOVOUCHER
      , BENHVIEN_ID
      , NGAYTAO
      , NGUOITAO_ID
      , NGAYCAPNHAT
      , NGUOICAPNHAT_ID
      ) values (
      #MATHE#
      , #TAIKHOAN_ID#
      , #THANHVIEN_ID#
      , #THETHANHVIEN_ID#
      , #DATHUTIEN#
      , #NGAYDANGKY#
      , #NGAYHIEULUC#
      , #NGAYHETHAN#
      , #KICHHOAT#
      , #TAMNGUNG#
      , #THOIHAN#
      , #SOVOUCHER#
      , #BENHVIEN_ID#
      , #NGAYTAO#
      , #NGUOITAO_ID#
      , #NGAYCAPNHAT#
      , #NGUOICAPNHAT_ID#
      )
      <selectKey resultClass="System.Int64" type="post" >
        SELECT @@IDENTITY as value
      </selectKey>
    </insert>
    <statement id="DAO00085_KichHoat_THANHVIEN_THE" parameterClass="System.Collections.IDictionary">
      update TT_CSKH_THANHVIEN_CAPTHE set
      <!--KICHHOAT = '1'
      ,--> DATHUTIEN = '1'
      <!--, NGAYHIEULUC = GETDATE()
      , NGAYHETHAN = case when (THOIHAN = 0 or THOIHAN is NULL) then null else DATEADD(day, THOIHAN,GETDATE()) end
      , NGAYKICHHOAT = GETDATE()-->
      , NGUOIKICHHOAT_ID = '$NGUOICAPNHAT_ID$'
      , NGUOICAPNHAT_ID = '$NGUOICAPNHAT_ID$'
      where
      THE_ID = '$THE_ID$'
    </statement>
    <statement id="DAO00085_thanhtoan_THANHVIEN_THE" parameterClass="System.Collections.IDictionary">
      update TT_CSKH_THANHVIEN_CAPTHE set
      DATHUTIEN = '1'
      , NGUOICAPNHAT_ID = '$NGUOICAPNHAT_ID$'
      , NGAYCAPNHAT = GETDATE()
      <!--, NGAYHIEULUC = GETDATE()
      , NGAYHETHAN = case when (THOIHAN = 0 or THOIHAN is NULL) then null else DATEADD(day, THOIHAN,GETDATE()) end-->
      where
      THE_ID = '$THE_ID$'
    </statement>
    <statement id="DAO00085_thanhtoan_kichhoat_THANHVIEN_THE" parameterClass="System.Collections.IDictionary">
      update TT_CSKH_THANHVIEN_CAPTHE set
      KICHHOAT = '1'
      , NGAYHIEULUC = '$NGAYHIEULUC$'
      , NGAYHETHAN = '$NGAYHETHAN$'
      , NGAYKICHHOAT = GETDATE()
      , NGUOIKICHHOAT_ID = '$NGUOICAPNHAT_ID$'
      , NGAYCAPNHAT = GETDATE()
      , NGUOICAPNHAT_ID = '$NGUOICAPNHAT_ID$'
      where
      THE_ID = '$THE_ID$';

      update TT_VIENPHI
      set DATHUCHIEN = '1'
      where REF_TABLE = 'TT_CSKH_THANHVIEN_CAPTHE' and REF_ID = '$THE_ID$';

      update TT_HOADON_CHITIET_NGOAITRU
      set TRANGTHAI = 'DATHUCHIEN'
      where REF_TABLE = 'TT_CSKH_THANHVIEN_CAPTHE' and REF_ID = '$THE_ID$';
    </statement>
    <update id="DAO00085_Update_THANHVIEN_THE" parameterClass="System.Collections.IDictionary">
      update TT_CSKH_THANHVIEN_CAPTHE set
      MATHE = #MATHE#
      <isPropertyAvailable prepend="," property="TAIKHOAN_ID">
        TAIKHOAN_ID = #TAIKHOAN_ID#
      </isPropertyAvailable>
      <isPropertyAvailable prepend="," property="THANHVIEN_ID">
        THANHVIEN_ID = #THANHVIEN_ID#
      </isPropertyAvailable>
      <isPropertyAvailable prepend="," property="THETHANHVIEN_ID">
        THETHANHVIEN_ID = #THETHANHVIEN_ID#
      </isPropertyAvailable>
      <isPropertyAvailable prepend="," property="DATHUTIEN">
        DATHUTIEN = #DATHUTIEN#
      </isPropertyAvailable>
      <isPropertyAvailable prepend="," property="NGAYHIEULUC">
        NGAYHIEULUC = #NGAYHIEULUC#
      </isPropertyAvailable>
      <isPropertyAvailable prepend="," property="NGAYHETHAN">
        NGAYHETHAN = #NGAYHETHAN#
      </isPropertyAvailable>
      <isPropertyAvailable prepend="," property="THOIHAN">
        THOIHAN = #THOIHAN#
      </isPropertyAvailable>
      <isPropertyAvailable prepend="," property="SOVOUCHER">
        SOVOUCHER = #SOVOUCHER#
      </isPropertyAvailable>
      <isPropertyAvailable prepend="," property="TAMNGUNG">
        TAMNGUNG = #TAMNGUNG#
      </isPropertyAvailable>
      <isPropertyAvailable prepend="," property="TAMNGUNG">
        TAMNGUNG = #TAMNGUNG#
      </isPropertyAvailable>
      <isPropertyAvailable prepend="," property="BENHVIEN_ID">
        BENHVIEN_ID = #BENHVIEN_ID#
      </isPropertyAvailable>
      <isPropertyAvailable prepend="," property="NGAYTAO">
        NGAYTAO = #NGAYTAO#
      </isPropertyAvailable>
      <isPropertyAvailable prepend="," property="NGUOITAO_ID">
        NGUOITAO_ID = #NGUOITAO_ID#
      </isPropertyAvailable>
      <isPropertyAvailable prepend="," property="NGAYCAPNHAT">
        NGAYCAPNHAT = #NGAYCAPNHAT#
      </isPropertyAvailable>
      <isPropertyAvailable prepend="," property="NGUOICAPNHAT_ID">
        NGUOICAPNHAT_ID = #NGUOICAPNHAT_ID#
      </isPropertyAvailable>
      where
      THE_ID = '$THE_ID$'
    </update>
    
    <statement id="DAO00085_GetListLoai_DichVu" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      SELECT D.DICHVU_ID, D.MADICHVU, D.TENDICHVU, N.NHOMDICHVU_ID, N.TENNHOMDICHVU, L.LOAIDICHVU_ID, L.TENLOAIDICHVU, 0 as CHON
      FROM TM_DICHVU AS D
      INNER JOIN TM_NHOMDICHVU AS N ON N.NHOMDICHVU_ID = D.NHOMDICHVU_ID AND N.TAMNGUNG = '0' AND N.BENHVIEN_ID = '$BENHVIEN_ID$'
      INNER JOIN TM_LOAIDICHVU AS L ON L.LOAIDICHVU_ID = N.LOAIDICHVU_ID AND L.TAMNGUNG = '0' AND L.BENHVIEN_ID = '$BENHVIEN_ID$'
      WHERE
      D.BENHVIEN_ID = '$BENHVIEN_ID$' AND D.TAMNGUNG = '0' 
      AND D.COGIADICHVU = '1' <!--AND (DIC2.DICTIONARY_CODE != 'BHYT' OR (DIC2.DICTIONARY_CODE = 'BHYT' AND D.BHYT = '1'))-->
      <isNotEmpty prepend="and" property="TENDICHVU">
        (D.TENDICHVU like '%' + #TENDICHVU# + '%' or D.MADICHVU like '%' + #TENDICHVU# + '%')
      </isNotEmpty>
      <isNotEmpty prepend="and" property="NHOMDICHVU_ID">
        (N.NHOMDICHVU_ID = '$NHOMDICHVU_ID$')
      </isNotEmpty>
    </statement>
    
    <statement id="DAO00085_GetListLoaiThanhVien_DichVu" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select D.DICHVU_ID, D.MADICHVU, D.TENDICHVU, N.NHOMDICHVU_ID, N.TENNHOMDICHVU, L.LOAIDICHVU_ID, L.TENLOAIDICHVU
      , TVGG.SOTIENGIAM, TVGG.TYLEGIAM, TVGG.SOLANTHUCHIEN, TVGG.THETHANHVIEN_ID, TTV.MATHETHANHVIEN
      from TM_CSKH_THETHANHVIEN_DICHVU as TVGG
      left join TM_CSKH_THETHANHVIEN TTV on TTV.THETHANHVIEN_ID = TVGG.THETHANHVIEN_ID and TTV.BENHVIEN_ID = '$BENHVIEN_ID$'
      inner join TM_DICHVU AS D on TVGG.DICHVU_ID = D.DICHVU_ID and D.BENHVIEN_ID = '$BENHVIEN_ID$' AND D.TAMNGUNG = '0' AND D.COGIADICHVU = '1'
      INNER JOIN TM_NHOMDICHVU AS N ON N.NHOMDICHVU_ID = D.NHOMDICHVU_ID AND N.TAMNGUNG = '0' AND N.BENHVIEN_ID = '$BENHVIEN_ID$'
      INNER JOIN TM_LOAIDICHVU AS L ON L.LOAIDICHVU_ID = N.LOAIDICHVU_ID AND L.TAMNGUNG = '0' AND L.BENHVIEN_ID = '$BENHVIEN_ID$'
      where TVGG.THETHANHVIEN_ID = '$THETHANHVIEN_ID$' and TVGG.BENHVIEN_ID = '$BENHVIEN_ID$'
    </statement>
    
    <statement id="DAO00085_GetLoaiGia_DichVu" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select LOAIGIA_ID from TM_LOAIGIA
      where
      CAPTREN_ID in (select LOAIGIA_ID from TM_LOAIGIA where MALOAIGIA = 'GiaDichVu' and BENHVIEN_ID = '$BENHVIEN_ID$')
      and TAMNGUNG = '0' and BENHVIEN_ID = '$BENHVIEN_ID$' and NHOMGIA_ID in (select DICTIONARY_ID from LST_DICTIONARY where DICTIONARY_TYPE_CODE = 'nhomgia' and DICTIONARY_CODE = 'binhthuong')

      <!--select LOAIGIA_ID from TM_LOAIGIA where MALOAIGIA = 'GiaDichVu' and BENHVIEN_ID = '$BENHVIEN_ID$'-->
    </statement>

    <statement id="DAO00085_GetThanhVienDaPhatHanh" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select count(THE_ID) as DAPHATHANH from TT_CSKH_THANHVIEN_CAPTHE
      where THETHANHVIEN_ID = '$THETHANHVIEN_ID$' 
    </statement>
    <statement id="DAO00085_GetMatheThanhVienDaTonTai" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select count(*) as MATHETHANHVIEN from TM_CSKH_THETHANHVIEN
      where MATHETHANHVIEN = '$TMATHETHANHVIEN$'
    </statement>
    <statement id="DAO00085_Add_TM_CSKH_THETHANHVIEN_DICHVU" parameterClass="System.Collections.IDictionary" resultClass="System.Int64">
      insert into TM_CSKH_THETHANHVIEN_DICHVU (
      THETHANHVIEN_ID
      , DICHVU_ID
      , TYLEGIAM
      , SOTIENGIAM
      , SOLANTHUCHIEN
      , NGAYTAO
      , NGUOITAO_ID
      , NGAYCAPNHAT
      , NGUOICAPNHAT_ID
      , BENHVIEN_ID
      ) values (
      #THETHANHVIEN_ID#
      , #DICHVU_ID#
      , #TYLEGIAM#
      , #SOTIENGIAM#
      , #SOLANTHUCHIEN#
      , #NGAYTAO#
      , #NGUOITAO_ID#
      , #NGAYCAPNHAT#
      , #NGUOICAPNHAT_ID#
      , #BENHVIEN_ID#
      )
      SELECT SCOPE_IDENTITY()
    </statement>
    
    <statement id="DAO00085_Delete_TM_CSKH_THETHANHVIEN_DICHVU" parameterClass="System.Collections.IDictionary" resultClass="System.Int32">
      delete from TM_CSKH_THETHANHVIEN_DICHVU
      where
      THETHANHVIEN_ID = '$THETHANHVIEN_ID$'
    </statement>
    
    <statement id="DAO00085_GetListNhomDichVuCombo" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select NHOMDICHVU_ID, MANHOMDICHVU, TENNHOMDICHVU 
      from TM_NHOMDICHVU
      where BENHVIEN_ID = '$BENHVIEN_ID$'
    </statement>

    <statement id="DAO00085_GetDSDichVuThe" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select *
      from TT_CSKH_THETHANHVIEN_SUDUNG
      where THE_ID = '$THE_ID$'
      and BENHVIEN_ID = '$BENHVIEN_ID$'
    </statement>

    <statement id="DAO00085_CapNhatSoLanSuDung" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      update TT_CSKH_THETHANHVIEN_SUDUNG set
      SOLANDASUDUNG = isnull(SOLANDASUDUNG, 0) + #SOLANDASUDUNG#,
      SOLANCONLAI =   SOLANDINHMUC - (isnull(SOLANDASUDUNG, 0) + #SOLANDASUDUNG#),
      NGAYCAPNHAT = #NGAYCAPNHAT#,
      NGUOICAPNHAT_ID = #NGUOICAPNHAT_ID#
      where THE_ID = '$THE_ID$'
      and DICHVU_ID = '$DICHVU_ID$'
      and BENHVIEN_ID = '$BENHVIEN_ID$'
    </statement>

    <statement id="DAO00085_GiamSoLanSuDung" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      update TT_CSKH_THETHANHVIEN_SUDUNG set
      SOLANDASUDUNG = SOLANDASUDUNG - #SOLUONG#,
      SOLANCONLAI = SOLANCONLAI + #SOLUONG#,
      NGAYCAPNHAT = #NGAYCAPNHAT#,
      NGUOICAPNHAT_ID = #NGUOICAPNHAT_ID#
      where THE_ID = '$THE_ID$'
      and DICHVU_ID = '$DICHVU_ID$'
      and BENHVIEN_ID = '$BENHVIEN_ID$'
    </statement>
    <statement id="DAO00085_KiemTraTheDaPhatSinhHoaDonChua" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select * from TT_CSKH_THANHVIEN_CAPTHE
      where THE_ID = '$THE_ID$' and DATHUTIEN = '1'      
      and BENHVIEN_ID = '$BENHVIEN_ID$'
    </statement>
  </statements> 
</sqlMap>