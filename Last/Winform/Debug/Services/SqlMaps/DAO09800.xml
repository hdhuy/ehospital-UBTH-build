<?xml version="1.0" encoding="utf-8" ?>
<sqlMap namespace="eHospital" xmlns="http://ibatis.apache.org/mapping" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" >
  <!--+ Author: Thucnv
      + Description: Nhập/Trả nhà cung cấp-->
  <statements>

    <!--============================================BEGIN LOAD DANH MỤC=============================================-->
    <statement id="DAO09800_TICHHOPCHUNGTUNHAPNCC" parameterClass="System.Collections.IDictionary" resultClass="System.Int64">
      INSERT INTO TM_PUR_GIAHOPDONG(NHACUNGCAP_ID,TENNHACUNGCAP,NGAYHOPDONG,TUNGAY,DENNGAY,MALOAIPHIEU,TENLOAIPHIEU,BENHVIEN_ID,NGAYTAO,NGUOITAO_ID)
      VALUES(#NHACUNGCAP_ID#,#TENNHACUNGCAP#,#NGAYHOPDONG#,#TUNGAY#,#DENNGAY#,#MALOAIPHIEU#,#TENLOAIPHIEU#,#BENHVIEN_ID#,GETDATE(),#NGUOITAO_ID#)
      SELECT SCOPE_IDENTITY()
    </statement>
    <statement id="DAO09800_GetKhoDuoc" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      SELECT KHODUOC_ID,MAKHO, TENKHO FROM dbo.TM_KHODUOC WHERE BENHVIEN_ID = '$BENHVIEN_ID$' AND TAMNGUNG = 0  ORDER BY TENKHO
    </statement>
    <statement id="DAO09800_GetKhoDuocNCC" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      SELECT KD.KHODUOC_ID,KD.MAKHO, KD.TENKHO FROM dbo.TM_KHODUOC KD
      LEFT JOIN dbo.LST_DICTIONARY LK ON KD.LOAIKHO_ID = LK.DICTIONARY_ID
      WHERE KD.BENHVIEN_ID = '$BENHVIEN_ID$' AND LK.DICTIONARY_CODE IN ('KhoChan', 'QuayThuoc') AND KD.TAMNGUNG = 0  ORDER BY KD.TENKHO
    </statement>
    <statement id="DAO09800_GetNhaCungCap" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      SELECT NHACUNGCAP_ID, MANHACUNGCAP, TENNHACUNGCAP FROM dbo.TM_NHACUNGCAP WHERE BENHVIEN_ID = '$BENHVIEN_ID$' AND TAMNGUNG = 0 ORDER BY TENNHACUNGCAP
    </statement>
    <statement id="DAO09800_GetNhanVien" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      SELECT  N.NHANVIEN_ID ,N.MANHANVIEN ,N.TENNHANVIEN
      FROM    TM_NHANVIEN N
      WHERE   N.BENHVIEN_ID = '$BENHVIEN_ID$'
      ORDER BY N.TENNHANVIEN
    </statement>
    <statement id="DAO09800_GetDMKHOVPP" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      SELECT  AA.DICTIONARY_CODE AS MAKHO ,
      AA.DICTIONARY_NAME AS TENKHO
      FROM    LST_DICTIONARY AA
      WHERE  AA.BENHVIEN_ID = '$BENHVIEN_ID$' AND  AA.DICTIONARY_TYPE_CODE = 'KhoVPP';
    </statement>
    <!--============================================END LOAD DANH MỤC=============================================-->

    <!--============================================BEGIN DƯỢC PHẨM=============================================-->
    <!--Lấy danh sách chứng từ nhập ncc-->
    <statement id="DAO09800_GetMasterNHAPNCC" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      DECLARE @TENBENHVIEN NVARCHAR(250);
      SELECT  @TENBENHVIEN = VALUE
      FROM   dbo.TM_SYS_APPSETTINGS
      WHERE  BENHVIEN_ID = '$BENHVIEN_ID$' AND CODE = 'APP_BENHVIEN_TEN';

      SELECT BTNCHECK = CAST (0 AS BIT), CT.CHUNGTU_ID ,CT.MACHUNGTU ,CT.NGAYCHUNGTU ,CT.MUCDICHCHUNGTU_CODE AS MAMUCDICHCHUNGTU,MDCT.DICTIONARY_NAME AS TENMUCDICHCHUNGTU,CT.NHACUNGCAP_ID ,NCC.MANHACUNGCAP ,NCC.TENNHACUNGCAP ,
      NCC.DIACHI AS DIACHI, NCC.MASOTHUE AS MASOTHUE,CT.MAUHOADON ,CT.SOHOADON ,CT.SOSERI ,CT.NGAYHOADON ,CT.DIENGIAI ,CT.TIENTE_ID ,CT.TYGIA ,GIATRI = CT.GIATRI ,CT.TYLEVAT ,CT.GIATRIVAT ,CT.TYLECHIETKHAU ,CT.GIATRICHIETKHAU ,
      CT.GIATRITHANHTOAN ,NN.MANHANVIEN ,NN.TENNHANVIEN , CT.MACHUNGTUREF AS MADONHANG,CT.KHONHAP_ID ,KN.MAKHO AS MAKHONHAP, KN.TENKHO AS TENKHONHAP ,CT.KHOXUAT_ID , NULL AS MAKHOXUAT, NULL AS TENKHOXUAT ,
      CT.TRANGTHAI ,CT.PHONGBAN_ID ,PB.MAPHONGBAN ,PB.TENPHONGBAN ,PB.COSTCENTER_ID , CO.MAPHONGBAN AS COSTCENTERCODE, CO.TENPHONGBAN AS COSTCENTERNAME ,CT.BENHVIEN_ID
      ,CT.BENHVIEN_ID AS MABENHVIEN, TENBENHVIEN = @TENBENHVIEN ,
      CT.IDCHUYEN ,CT.BENHNHAN_ID ,NULL AS MAYTE, NULL AS TENBENHNHAN, NULL AS GHICHU, NULL AS CHUYENTICHHOP_ID, PV.MAPHAMVI AS PHAMVI,CT.LOAICHUNGTU, STATUSROW = CAST (0 AS BIT), MESSAGEROW = NULL
      FROM   dbo.TT_DUOC_CHUNGTU CT
      JOIN dbo.TM_KHODUOC KN ON CT.KHONHAP_ID = KN.KHODUOC_ID
      JOIN dbo.TM_NHANVIEN NN ON CT.NGUOINHAN_ID = NN.NHANVIEN_ID
      JOIN dbo.LST_DICTIONARY MDCT ON CT.MUCDICHCHUNGTU_ID = MDCT.DICTIONARY_ID
      JOIN dbo.TM_NHACUNGCAP NCC ON CT.NHACUNGCAP_ID = NCC.NHACUNGCAP_ID
      JOIN dbo.TM_PHONGBAN PB ON CT.PHONGBAN_ID = PB.PHONGBAN_ID
      LEFT JOIN dbo.TM_PHONGBAN CO ON PB.COSTCENTER_ID = CO.PHONGBAN_ID
      LEFT JOIN dbo.TM_PHAMVI PV ON KN.PHAMVI_ID = PV.PHAMVI_ID
      WHERE  CT.BENHVIEN_ID = '$BENHVIEN_ID$' AND CAST(CT.NGAYCHUNGTU AS DATE) BETWEEN '$TUNGAY$' AND '$DENNGAY$'
      AND CT.MUCDICHCHUNGTU_CODE = 'N01'
      AND CT.TRANGTHAI = 'PNDNK'
      AND CT.IDCHUYEN IS NULL
      <isNotEmpty prepend="AND" property="KHONHAP_ID">
        CT.KHONHAP_ID = '$KHONHAP_ID$'
      </isNotEmpty>
      <isNotEmpty prepend="AND" property="NHACUNGCAP_ID">
        CT.NHACUNGCAP_ID = '$NHACUNGCAP_ID$'
      </isNotEmpty>
      <isNotEmpty prepend="AND" property="NGUOINHAN_ID">
        CT.NGUOINHAN_ID = '$NGUOINHAN_ID$'
      </isNotEmpty>
      <isNotEmpty prepend="AND" property="MACHUNGTU">
        CT.MACHUNGTU LIKE N'%'+#MACHUNGTU#+'%'
      </isNotEmpty>
    </statement>
    <!--Lấy danh sách chứng từ nhập ncc đã chuyển-->
    <statement id="DAO09800_GetMasterNHAPNCC_DACHUYEN" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      DECLARE @TENBENHVIEN NVARCHAR(250);
      SELECT  @TENBENHVIEN = VALUE
      FROM   dbo.TM_SYS_APPSETTINGS
      WHERE  BENHVIEN_ID = '$BENHVIEN_ID$' AND CODE = 'APP_BENHVIEN_TEN';

      SELECT BTNCHECK = CAST (0 AS BIT), CT.CHUNGTU_ID ,CT.MACHUNGTU ,CT.NGAYCHUNGTU ,CT.MUCDICHCHUNGTU_CODE AS MAMUCDICHCHUNGTU,MDCT.DICTIONARY_NAME AS TENMUCDICHCHUNGTU,CT.NHACUNGCAP_ID ,NCC.MANHACUNGCAP ,NCC.TENNHACUNGCAP ,
      NCC.DIACHI AS DIACHI, NCC.MASOTHUE AS MASOTHUE,CT.MAUHOADON ,CT.SOHOADON ,CT.SOSERI ,CT.NGAYHOADON ,CT.DIENGIAI ,CT.TIENTE_ID ,CT.TYGIA ,GIATRI = CT.GIATRI ,CT.TYLEVAT ,CT.GIATRIVAT ,CT.TYLECHIETKHAU ,CT.GIATRICHIETKHAU ,
      CT.GIATRITHANHTOAN ,NN.MANHANVIEN ,NN.TENNHANVIEN , CT.MACHUNGTUREF AS MADONHANG,CT.KHONHAP_ID ,KN.MAKHO AS MAKHONHAP, KN.TENKHO AS TENKHONHAP ,CT.KHOXUAT_ID , NULL AS MAKHOXUAT, NULL AS TENKHOXUAT ,
      CT.TRANGTHAI ,CT.PHONGBAN_ID ,PB.MAPHONGBAN ,PB.TENPHONGBAN ,PB.COSTCENTER_ID , CO.MAPHONGBAN AS COSTCENTERCODE, CO.TENPHONGBAN AS COSTCENTERNAME ,CT.BENHVIEN_ID
      ,CT.BENHVIEN_ID AS MABENHVIEN, TENBENHVIEN = @TENBENHVIEN ,
      CT.IDCHUYEN ,CT.BENHNHAN_ID ,NULL AS MAYTE, NULL AS TENBENHNHAN, NULL AS GHICHU, NULL AS CHUYENTICHHOP_ID, PV.MAPHAMVI AS PHAMVI,CT.LOAICHUNGTU, STATUSROW = CAST (0 AS BIT), MESSAGEROW = NULL
      ,TH.THOIGIANCHUYEN
      FROM   dbo.TT_DUOC_CHUNGTU CT
      JOIN VIEW_IDCHUYENTICHHOP TH on TH.CHUYENTICHHOP_ID = CT.IDCHUYEN
      JOIN dbo.TM_KHODUOC KN ON CT.KHONHAP_ID = KN.KHODUOC_ID
      JOIN dbo.TM_NHANVIEN NN ON CT.NGUOINHAN_ID = NN.NHANVIEN_ID
      JOIN dbo.LST_DICTIONARY MDCT ON CT.MUCDICHCHUNGTU_ID = MDCT.DICTIONARY_ID
      JOIN dbo.TM_NHACUNGCAP NCC ON CT.NHACUNGCAP_ID = NCC.NHACUNGCAP_ID
      JOIN dbo.TM_PHONGBAN PB ON CT.PHONGBAN_ID = PB.PHONGBAN_ID
      LEFT JOIN dbo.TM_PHONGBAN CO ON PB.COSTCENTER_ID = CO.PHONGBAN_ID
      LEFT JOIN dbo.TM_PHAMVI PV ON KN.PHAMVI_ID = PV.PHAMVI_ID
      WHERE  CT.BENHVIEN_ID = '$BENHVIEN_ID$' AND CAST(CT.NGAYCHUNGTU AS DATE) BETWEEN '$TUNGAY$' AND '$DENNGAY$'
      AND CT.MUCDICHCHUNGTU_CODE = 'N01'
      AND CT.TRANGTHAI = 'PNDNK'
      <isNotEmpty prepend="AND" property="KHONHAP_ID">
        CT.KHONHAP_ID = '$KHONHAP_ID$'
      </isNotEmpty>
      <isNotEmpty prepend="AND" property="NHACUNGCAP_ID">
        CT.NHACUNGCAP_ID = '$NHACUNGCAP_ID$'
      </isNotEmpty>
      <isNotEmpty prepend="AND" property="NGUOINHAN_ID">
        CT.NGUOINHAN_ID = '$NGUOINHAN_ID$'
      </isNotEmpty>
      <isNotEmpty prepend="AND" property="MACHUNGTU">
        CT.MACHUNGTU LIKE N'%'+#MACHUNGTU#+'%'
      </isNotEmpty>
    </statement>
    <!--Lấy chi tiết chứng từ nhập ncc-->
    <statement id="DAO09800_GetDetailNHAPNCC" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      SELECT	  TICHHOP_ID = NULL,
      CT.CHUNGTU_ID ,
      CTCT.CHUNGTUCHITIET_ID ,
      LD.LOAIVATTU_ID ,
      LD.MALOAIDUOC ,
      LD.TENLOAIDUOC ,
      D.MADUOC ,
      TD.TENDUOC  ,
      DONVITINH = DVT.TENDONVITINH,
      DONVIQUICACH = DVTQD.TENDONVITINH ,
      GIATRIQUIDOI = DVTQD.GIATRIQUIDOI ,
      SOLUONG = CTCT.SOLUONGTHUCTE  ,
      DONGIA = CTCT.DONGIAMUA,
      GIATRI = CTCT.THANHTIENMUA ,
      TYLEVAT = CTCT.TYLEVAT,
      GIATRIVAT = CTCT.GIATRIVAT ,
      TYLECHIETKHAU = CTCT.TYLECHIETKHAU ,
      GIATRICHIETKHAU = CTCT.GIATRICHIETKHAU ,
      GIATRITHANHTOAN = ISNULL(CTCT.THANHTIENMUA,0) + ISNULL(CTCT.GIATRIVAT,0),
      CTCT.KHUYENMAI
      FROM   dbo.TT_DUOC_CHUNGTU CT
      JOIN dbo.TT_DUOC_CHUNGTU_CHITIET CTCT ON CTCT.CHUNGTU_ID = CT.CHUNGTU_ID
      JOIN dbo.TT_DUOC_SOLONHAP_GIABAN GB ON CTCT.SOLONHAP_ID = GB.SOLONHAP_ID
      JOIN dbo.TM_DUOC D ON CTCT.DUOC_ID = D.DUOC_ID
      JOIN dbo.TM_TENDUOC TD ON D.TENDUOC_ID = TD.TENDUOC_ID
      JOIN dbo.TM_LOAIDUOC LD ON D.LOAIDUOC_ID = LD.LOAIDUOC_ID
      JOIN dbo.TM_DONVITINH DVT ON D.DONVITINH_ID = DVT.DONVITINH_ID
      JOIN dbo.TM_DONVITINH DVTQD ON CTCT.DONVITINH_ID = DVTQD.DONVITINH_ID
      WHERE  CT.CHUNGTU_ID = '$CHUNGTU_ID$'
    </statement>

    <!--Lấy danh sách chứng từ trả ncc-->
    <statement id="DAO09800_GetMasterTRANCC" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      DECLARE @TENBENHVIEN NVARCHAR(250);
      SELECT  @TENBENHVIEN = VALUE
      FROM   dbo.TM_SYS_APPSETTINGS
      WHERE  BENHVIEN_ID = '$BENHVIEN_ID$' AND CODE = 'APP_BENHVIEN_TEN';

      SELECT BTNCHECK = CAST (0 AS BIT), CT.CHUNGTU_ID ,CT.MACHUNGTU ,CT.NGAYCHUNGTU ,MAMUCDICHCHUNGTU = CT.MUCDICHCHUNGTU_CODE ,TENMUCDICHCHUNGTU = MDCT.DICTIONARY_NAME ,CT.NHACUNGCAP_ID ,NCC.MANHACUNGCAP ,NCC.TENNHACUNGCAP ,
      NCC.DIACHI AS DIACHI, NCC.MASOTHUE AS MASOTHUE ,CT.MAUHOADON ,CT.SOHOADON ,CT.SOSERI ,CT.NGAYHOADON ,CT.DIENGIAI ,CT.TIENTE_ID ,CT.TYGIA ,GIATRI = CT.GIATRI ,CT.TYLEVAT ,CT.GIATRIVAT ,CT.TYLECHIETKHAU ,CT.GIATRICHIETKHAU ,
      CT.GIATRITHANHTOAN ,NG.MANHANVIEN ,NG.TENNHANVIEN ,MADONHANG = NULL ,CT.KHONHAP_ID ,MAKHONHAP = NULL ,TENKHONHAP = NULL ,CT.KHOXUAT_ID ,MAKHOXUAT = KT.MAKHO ,TENKHOXUAT = KT.TENKHO ,
      CT.TRANGTHAI ,CT.PHONGBAN_ID ,PB.MAPHONGBAN ,PB.TENPHONGBAN ,PB.COSTCENTER_ID ,COSTCENTERCODE = CO.MAPHONGBAN ,COSTCENTERNAME = CO.TENPHONGBAN ,CT.BENHVIEN_ID ,MABENHVIEN = CT.BENHVIEN_ID ,
      TENBENHVIEN = @TENBENHVIEN ,CT.IDCHUYEN ,CT.BENHNHAN_ID ,MAYTE = NULL ,TENBENHNHAN = NULL ,GHICHU = NULL ,CHUYENTICHHOP_ID = NULL ,PHAMVI = PV.MAPHAMVI ,CT.LOAICHUNGTU, STATUSROW = CAST (0 AS BIT), MESSAGEROW = NULL
      FROM   dbo.TT_DUOC_CHUNGTU CT
      JOIN dbo.TT_DUOC_CHUNGTU CTLQ ON CT.CHUNGTULIENQUAN_ID = CTLQ.CHUNGTU_ID
      JOIN dbo.TM_KHODUOC KT ON CT.KHOXUAT_ID = KT.KHODUOC_ID
      JOIN dbo.TM_NHANVIEN NG ON CT.NGUOIGIAO_ID = NG.NHANVIEN_ID
      JOIN dbo.LST_DICTIONARY MDCT ON CT.MUCDICHCHUNGTU_ID = MDCT.DICTIONARY_ID
      JOIN dbo.TM_NHACUNGCAP NCC ON CTLQ.NHACUNGCAP_ID = NCC.NHACUNGCAP_ID
      JOIN dbo.TM_PHONGBAN PB ON CT.PHONGBAN_ID = PB.PHONGBAN_ID
      LEFT JOIN dbo.TM_PHONGBAN CO ON PB.COSTCENTER_ID = CO.PHONGBAN_ID
      LEFT JOIN dbo.TM_PHAMVI PV ON KT.PHAMVI_ID = PV.PHAMVI_ID
      WHERE  CT.BENHVIEN_ID = '$BENHVIEN_ID$' AND CAST(CT.NGAYCHUNGTU AS DATE) BETWEEN '$TUNGAY$' AND '$DENNGAY$'
      AND CT.MUCDICHCHUNGTU_CODE = 'X01'
      AND CT.TRANGTHAI = 'DXN'
      AND CT.IDCHUYEN IS NULL
      <isNotEmpty prepend="AND" property="KHOXUAT_ID">
        CT.KHOXUAT_ID = '$KHOXUAT_ID$'
      </isNotEmpty>
      <isNotEmpty prepend="AND" property="NHACUNGCAP_ID">
        CTLQ.NHACUNGCAP_ID = '$NHACUNGCAP_ID$'
      </isNotEmpty>
      <isNotEmpty prepend="AND" property="NGUOIXUAT_ID">
        CT.NGUOIGIAO_ID = '$NGUOIXUAT_ID$'
      </isNotEmpty>
      <isNotEmpty prepend="AND" property="MACHUNGTU">
        CT.MACHUNGTU LIKE N'%'+#MACHUNGTU#+'%'
      </isNotEmpty>
    </statement>
    <!--Lấy danh sách chứng từ trả ncc đã chuyển-->
    <statement id="DAO09800_GetMasterTRANCC_DACHUYEN" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      DECLARE @TENBENHVIEN NVARCHAR(250);
      SELECT  @TENBENHVIEN = VALUE
      FROM   dbo.TM_SYS_APPSETTINGS
      WHERE  BENHVIEN_ID = '$BENHVIEN_ID$' AND CODE = 'APP_BENHVIEN_TEN';

      SELECT BTNCHECK = CAST (0 AS BIT), CT.CHUNGTU_ID ,CT.MACHUNGTU ,CT.NGAYCHUNGTU ,MAMUCDICHCHUNGTU = CT.MUCDICHCHUNGTU_CODE ,TENMUCDICHCHUNGTU = MDCT.DICTIONARY_NAME ,CT.NHACUNGCAP_ID ,NCC.MANHACUNGCAP ,NCC.TENNHACUNGCAP ,
      NCC.DIACHI AS DIACHI, NCC.MASOTHUE AS MASOTHUE ,CT.MAUHOADON ,CT.SOHOADON ,CT.SOSERI ,CT.NGAYHOADON ,CT.DIENGIAI ,CT.TIENTE_ID ,CT.TYGIA ,GIATRI = CT.GIATRI ,CT.TYLEVAT ,CT.GIATRIVAT ,CT.TYLECHIETKHAU ,CT.GIATRICHIETKHAU ,
      CT.GIATRITHANHTOAN ,NG.MANHANVIEN ,NG.TENNHANVIEN ,MADONHANG = NULL ,CT.KHONHAP_ID ,MAKHONHAP = NULL ,TENKHONHAP = NULL ,CT.KHOXUAT_ID ,MAKHOXUAT = KT.MAKHO ,TENKHOXUAT = KT.TENKHO ,
      CT.TRANGTHAI ,CT.PHONGBAN_ID ,PB.MAPHONGBAN ,PB.TENPHONGBAN ,PB.COSTCENTER_ID ,COSTCENTERCODE = CO.MAPHONGBAN ,COSTCENTERNAME = CO.TENPHONGBAN ,CT.BENHVIEN_ID ,MABENHVIEN = CT.BENHVIEN_ID ,
      TENBENHVIEN = @TENBENHVIEN ,CT.IDCHUYEN ,CT.BENHNHAN_ID ,MAYTE = NULL ,TENBENHNHAN = NULL ,GHICHU = NULL ,CHUYENTICHHOP_ID = NULL ,PHAMVI = PV.MAPHAMVI ,CT.LOAICHUNGTU, STATUSROW = CAST (0 AS BIT), MESSAGEROW = NULL
      ,TH.THOIGIANCHUYEN
      FROM   dbo.TT_DUOC_CHUNGTU CT
      JOIN VIEW_IDCHUYENTICHHOP TH ON TH.CHUYENTICHHOP_ID = CT.IDCHUYEN
      JOIN dbo.TT_DUOC_CHUNGTU CTLQ ON CT.CHUNGTULIENQUAN_ID = CTLQ.CHUNGTU_ID
      JOIN dbo.TM_KHODUOC KT ON CT.KHOXUAT_ID = KT.KHODUOC_ID
      JOIN dbo.TM_NHANVIEN NG ON CT.NGUOIGIAO_ID = NG.NHANVIEN_ID
      JOIN dbo.LST_DICTIONARY MDCT ON CT.MUCDICHCHUNGTU_ID = MDCT.DICTIONARY_ID
      JOIN dbo.TM_NHACUNGCAP NCC ON CTLQ.NHACUNGCAP_ID = NCC.NHACUNGCAP_ID
      JOIN dbo.TM_PHONGBAN PB ON CT.PHONGBAN_ID = PB.PHONGBAN_ID
      LEFT JOIN dbo.TM_PHONGBAN CO ON PB.COSTCENTER_ID = CO.PHONGBAN_ID
      LEFT JOIN dbo.TM_PHAMVI PV ON KT.PHAMVI_ID = PV.PHAMVI_ID
      WHERE  CT.BENHVIEN_ID = '$BENHVIEN_ID$' AND CAST(CT.NGAYCHUNGTU AS DATE) BETWEEN '$TUNGAY$' AND '$DENNGAY$'
      AND CT.MUCDICHCHUNGTU_CODE = 'X01'
      AND CT.TRANGTHAI = 'DXN'
      <isNotEmpty prepend="AND" property="KHOXUAT_ID">
        CT.KHOXUAT_ID = '$KHOXUAT_ID$'
      </isNotEmpty>
      <isNotEmpty prepend="AND" property="NHACUNGCAP_ID">
        CTLQ.NHACUNGCAP_ID = '$NHACUNGCAP_ID$'
      </isNotEmpty>
      <isNotEmpty prepend="AND" property="NGUOIXUAT_ID">
        CT.NGUOIGIAO_ID = '$NGUOIXUAT_ID$'
      </isNotEmpty>
      <isNotEmpty prepend="AND" property="MACHUNGTU">
        CT.MACHUNGTU LIKE N'%'+#MACHUNGTU#+'%'
      </isNotEmpty>
    </statement>
    <!--Lấy chi tiết chứng từ chi tiết trả ncc-->
    <statement id="DAO09800_GetDetailTRANCC" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      SELECT	  TICHHOP_ID = NULL,CT.CHUNGTU_ID, CTCT.CHUNGTUCHITIET_ID ,LD.LOAIVATTU_ID ,LD.MALOAIDUOC ,LD.TENLOAIDUOC ,D.MADUOC ,TD.TENDUOC  ,DONVITINH = DVT.TENDONVITINH,DONVIQUICACH = DVTQD.TENDONVITINH ,
      GIATRIQUIDOI = DVTQD.GIATRIQUIDOI ,SOLUONG = CTCT.SOLUONGDAXUAT  ,DONGIA = CTCT.DONGIAMUA,GIATRI = CTCT.THANHTIENMUA ,TYLEVAT = CTCT.TYLEVAT,
      GIATRIVAT = CTCT.GIATRIVAT ,TYLECHIETKHAU = CTCT.TYLECHIETKHAU ,GIATRICHIETKHAU = CTCT.GIATRICHIETKHAU ,GIATRITHANHTOAN = ISNULL(CTCT.THANHTIENMUA,0) + ISNULL(CTCT.GIATRIVAT,0),CTCT.KHUYENMAI
      FROM   dbo.TT_DUOC_CHUNGTU CT
      JOIN dbo.TT_DUOC_CHUNGTU_CHITIET CTCT ON CTCT.CHUNGTU_ID = CT.CHUNGTU_ID
      JOIN dbo.TT_DUOC_SOLONHAP_GIABAN GB ON CTCT.SOLONHAP_ID = GB.SOLONHAP_ID
      JOIN dbo.TM_DUOC D ON CTCT.DUOC_ID = D.DUOC_ID
      JOIN dbo.TM_TENDUOC TD ON D.TENDUOC_ID = TD.TENDUOC_ID
      JOIN dbo.TM_LOAIDUOC LD ON D.LOAIDUOC_ID = LD.LOAIDUOC_ID
      JOIN dbo.TM_DONVITINH DVT ON D.DONVITINH_ID = DVT.DONVITINH_ID
      JOIN dbo.TM_DONVITINH DVTQD ON CTCT.DONVITINH_ID = DVTQD.DONVITINH_ID
      WHERE  CT.CHUNGTU_ID = '$CHUNGTU_ID$'
    </statement>

    <!--Lấy danh sách chứng từ bán thuốc tại quầy-->
    <statement id="DAO09800_GetMasterBANTHUOCTAIQUAY" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      DECLARE @TENBENHVIEN NVARCHAR(250);
      SELECT  @TENBENHVIEN = VALUE
      FROM   dbo.TM_SYS_APPSETTINGS
      WHERE  BENHVIEN_ID = '$BENHVIEN_ID$' AND CODE = 'APP_BENHVIEN_TEN';

      SELECT BTNCHECK = CAST (0 AS BIT), CT.CHUNGTU_ID ,CT.MACHUNGTU ,CT.NGAYCHUNGTU ,CT.MUCDICHCHUNGTU_CODE AS MAMUCDICHCHUNGTU,MDCT.DICTIONARY_NAME AS TENMUCDICHCHUNGTU,CT.NHACUNGCAP_ID ,MANHACUNGCAP = NULL,TENNHACUNGCAP = NULL ,
      NULL AS DIACHI, NULL AS MASOTHUE,CT.MAUHOADON ,CT.SOHOADON ,CT.SOSERI ,CT.NGAYHOADON ,CT.DIENGIAI ,CT.TIENTE_ID ,CT.TYGIA ,CTCT.GIATRI ,CT.TYLEVAT ,CT.GIATRIVAT ,CT.TYLECHIETKHAU ,CT.GIATRICHIETKHAU ,
      CTCT.GIATRITHANHTOAN AS GIATRITHANHTOAN ,NN.MANHANVIEN ,NN.TENNHANVIEN , NULL AS MADONHANG,CT.KHONHAP_ID ,NULL AS MAKHONHAP, NULL AS TENKHONHAP ,CT.KHOXUAT_ID , KX.MAKHO AS MAKHOXUAT, KX.TENKHO AS TENKHOXUAT ,
      CT.TRANGTHAI ,CT.PHONGBAN_ID ,PB.MAPHONGBAN ,PB.TENPHONGBAN ,PB.COSTCENTER_ID , CO.MAPHONGBAN AS COSTCENTERCODE, CO.TENPHONGBAN AS COSTCENTERNAME ,CT.BENHVIEN_ID
      ,CT.BENHVIEN_ID AS MABENHVIEN, TENBENHVIEN = @TENBENHVIEN ,
      CT.IDCHUYEN ,BN.BENHNHAN_ID ,BN.MAYTE, ISNULL(BN.TENBENHNHAN,CT.TENBENHNHAN) AS TENBENHNHAN, CT.DIENGIAI AS GHICHU, NULL AS CHUYENTICHHOP_ID, PV.MAPHAMVI AS PHAMVI,CT.LOAICHUNGTU, STATUSROW = CAST (0 AS BIT), MESSAGEROW = NULL
      FROM   dbo.TT_DUOC_CHUNGTU CT
      CROSS APPLY(SELECT SUM(CTCT.SOLUONGDAXUAT *  SLGB.DONGIAVON) AS GIATRI, GIATRITHANHTOAN = SUM(ISNULL( CTCT.SOLUONGDAXUAT *  CTCT.DONGIABAN,0)) FROM dbo.TT_DUOC_CHUNGTU_CHITIET CTCT JOIN TT_DUOC_SOLONHAP_GIABAN SLGB ON CTCT.SOLONHAP_ID = SLGB.SOLONHAP_ID WHERE CT.CHUNGTU_ID = CTCT.CHUNGTU_ID) CTCT
      JOIN dbo.TM_KHODUOC KX ON CT.KHOXUAT_ID = KX.KHODUOC_ID
      LEFT JOIN dbo.TM_NHANVIEN NN ON CT.NGUOIGIAO_ID = NN.NHANVIEN_ID
      JOIN dbo.LST_DICTIONARY MDCT ON CT.MUCDICHCHUNGTU_ID = MDCT.DICTIONARY_ID
      JOIN dbo.TM_PHONGBAN PB ON CT.PHONGBAN_ID = PB.PHONGBAN_ID
      LEFT JOIN dbo.TM_PHONGBAN CO ON PB.COSTCENTER_ID = CO.PHONGBAN_ID
      LEFT JOIN dbo.TM_PHAMVI PV ON KX.PHAMVI_ID = PV.PHAMVI_ID
      LEFT JOIN dbo.TT_BENHNHAN BN ON CT.BENHNHAN_ID = BN.BENHNHAN_ID
      WHERE  CT.BENHVIEN_ID = '$BENHVIEN_ID$' AND CAST(CT.NGAYCHUNGTU AS DATE) BETWEEN '$TUNGAY$' AND '$DENNGAY$'
      AND CT.MUCDICHCHUNGTU_CODE = 'X08'
      <!--AND CT.TRANGTHAI = 'PNDNK'-->
      <!--AND CT.DANHANTHUOC = 1-->
      AND CT.IDCHUYEN IS NULL
      <isNotEmpty prepend="AND" property="KHOXUAT_ID">
        CT.KHOXUAT_ID = '$KHOXUAT_ID$'
      </isNotEmpty>
      <isNotEmpty prepend="AND" property="NGUOIXUAT_ID">
        CT.NGUOIGIAO_ID = '$NGUOIXUAT_ID$'
      </isNotEmpty>
      <isNotEmpty prepend="AND" property="MACHUNGTU">
        CT.MACHUNGTU LIKE N'%'+#MACHUNGTU#+'%'
      </isNotEmpty>
      <isNotEmpty prepend="AND" property="TENBENHNHAN">
        ISNULL(BN.TENBENHNHAN,CT.TENBENHNHAN) LIKE N'%'+#TENBENHNHAN#+'%'
      </isNotEmpty>
    </statement>
    <!--Lấy danh sách chứng từ bán thuốc tại quầy đã chyển-->
    <statement id="DAO09800_GetMasterBANTHUOCTAIQUAY_DACHUYEN" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      DECLARE @TENBENHVIEN NVARCHAR(250);
      SELECT  @TENBENHVIEN = VALUE
      FROM   dbo.TM_SYS_APPSETTINGS
      WHERE  BENHVIEN_ID = '$BENHVIEN_ID$' AND CODE = 'APP_BENHVIEN_TEN';

      SELECT BTNCHECK = CAST (0 AS BIT), CT.CHUNGTU_ID ,CT.MACHUNGTU ,CT.NGAYCHUNGTU ,CT.MUCDICHCHUNGTU_CODE AS MAMUCDICHCHUNGTU,MDCT.DICTIONARY_NAME AS TENMUCDICHCHUNGTU,CT.NHACUNGCAP_ID ,MANHACUNGCAP = NULL,TENNHACUNGCAP = NULL ,
      NULL AS DIACHI, NULL AS MASOTHUE,CT.MAUHOADON ,CT.SOHOADON ,CT.SOSERI ,CT.NGAYHOADON ,CT.DIENGIAI ,CT.TIENTE_ID ,CT.TYGIA ,CTCT.GIATRI ,CT.TYLEVAT ,CT.GIATRIVAT ,CT.TYLECHIETKHAU ,CT.GIATRICHIETKHAU ,
      CTCT.GIATRITHANHTOAN AS GIATRITHANHTOAN ,NN.MANHANVIEN ,NN.TENNHANVIEN , NULL AS MADONHANG,CT.KHONHAP_ID ,NULL AS MAKHONHAP, NULL AS TENKHONHAP ,CT.KHOXUAT_ID , KX.MAKHO AS MAKHOXUAT, KX.TENKHO AS TENKHOXUAT ,
      CT.TRANGTHAI ,CT.PHONGBAN_ID ,PB.MAPHONGBAN ,PB.TENPHONGBAN ,PB.COSTCENTER_ID , CO.MAPHONGBAN AS COSTCENTERCODE, CO.TENPHONGBAN AS COSTCENTERNAME ,CT.BENHVIEN_ID
      ,CT.BENHVIEN_ID AS MABENHVIEN, TENBENHVIEN = @TENBENHVIEN ,
      CT.IDCHUYEN ,BN.BENHNHAN_ID ,BN.MAYTE, ISNULL(BN.TENBENHNHAN,CT.TENBENHNHAN) AS TENBENHNHAN, CT.DIENGIAI AS GHICHU, NULL AS CHUYENTICHHOP_ID, PV.MAPHAMVI AS PHAMVI,CT.LOAICHUNGTU, STATUSROW = CAST (0 AS BIT), MESSAGEROW = NULL
      ,TH.THOIGIANCHUYEN
      FROM   dbo.TT_DUOC_CHUNGTU CT
      JOIN VIEW_IDCHUYENTICHHOP TH on TH.CHUYENTICHHOP_ID = CT.IDCHUYEN
      CROSS APPLY(SELECT SUM(CTCT.SOLUONGDAXUAT *  SLGB.DONGIAVON) AS GIATRI, GIATRITHANHTOAN = SUM(ISNULL( CTCT.SOLUONGDAXUAT *  CTCT.DONGIABAN,0)) FROM dbo.TT_DUOC_CHUNGTU_CHITIET CTCT JOIN TT_DUOC_SOLONHAP_GIABAN SLGB ON CTCT.SOLONHAP_ID = SLGB.SOLONHAP_ID WHERE CT.CHUNGTU_ID = CTCT.CHUNGTU_ID) CTCT
      JOIN dbo.TM_KHODUOC KX ON CT.KHOXUAT_ID = KX.KHODUOC_ID
      LEFT JOIN dbo.TM_NHANVIEN NN ON CT.NGUOIGIAO_ID = NN.NHANVIEN_ID
      JOIN dbo.LST_DICTIONARY MDCT ON CT.MUCDICHCHUNGTU_ID = MDCT.DICTIONARY_ID
      JOIN dbo.TM_PHONGBAN PB ON CT.PHONGBAN_ID = PB.PHONGBAN_ID
      LEFT JOIN dbo.TM_PHONGBAN CO ON PB.COSTCENTER_ID = CO.PHONGBAN_ID
      LEFT JOIN dbo.TM_PHAMVI PV ON KX.PHAMVI_ID = PV.PHAMVI_ID
      LEFT JOIN dbo.TT_BENHNHAN BN ON CT.BENHNHAN_ID = BN.BENHNHAN_ID
      WHERE  CT.BENHVIEN_ID = '$BENHVIEN_ID$' AND CAST(CT.NGAYCHUNGTU AS DATE) BETWEEN '$TUNGAY$' AND '$DENNGAY$'
      AND CT.MUCDICHCHUNGTU_CODE = 'X08'
      <!--AND CT.TRANGTHAI = 'PNDNK'-->
      <!--AND CT.DANHANTHUOC = 1-->
      AND CT.IDCHUYEN IS NOT NULL
      <isNotEmpty prepend="AND" property="KHOXUAT_ID">
        CT.KHOXUAT_ID = '$KHOXUAT_ID$'
      </isNotEmpty>
      <isNotEmpty prepend="AND" property="NGUOIXUAT_ID">
        CT.NGUOIGIAO_ID = '$NGUOIXUAT_ID$'
      </isNotEmpty>
      <isNotEmpty prepend="AND" property="MACHUNGTU">
        CT.MACHUNGTU LIKE N'%'+#MACHUNGTU#+'%'
      </isNotEmpty>
      <isNotEmpty prepend="AND" property="TENBENHNHAN">
        ISNULL(BN.TENBENHNHAN,CT.TENBENHNHAN) LIKE N'%'+#TENBENHNHAN#+'%'
      </isNotEmpty>
    </statement>
    <!--Lấy danh sách chứng từ chi tiết bán thuốc tại quầy-->
    <statement id="DAO09800_GetDetailBANTHUOCTAIQUAY" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      SELECT	  TICHHOP_ID = NULL,CT.CHUNGTU_ID, CTCT.CHUNGTUCHITIET_ID ,LD.LOAIVATTU_ID ,LD.MALOAIDUOC ,LD.TENLOAIDUOC ,D.MADUOC ,TD.TENDUOC  ,DONVITINH = DVT.TENDONVITINH,
      DONVIQUICACH = DVTQD.TENDONVITINH ,GIATRIQUIDOI = DVTQD.GIATRIQUIDOI ,SOLUONG = CTCT.SOLUONGDAXUAT  ,DONGIA = GB.DONGIAVON,GIATRI = CTCT.SOLUONGDAXUAT *  GB.DONGIAVON,
      TYLEVAT = CTCT.TYLEVAT,GIATRIVAT = CTCT.GIATRIVAT ,TYLECHIETKHAU = CTCT.TYLECHIETKHAU ,GIATRICHIETKHAU = CTCT.GIATRICHIETKHAU ,GIATRITHANHTOAN = ISNULL( CTCT.SOLUONGDAXUAT *  CTCT.DONGIABAN,0) ,CTCT.KHUYENMAI
      FROM   dbo.TT_DUOC_CHUNGTU CT
      JOIN dbo.TT_DUOC_CHUNGTU_CHITIET CTCT ON CTCT.CHUNGTU_ID = CT.CHUNGTU_ID
      JOIN dbo.TT_DUOC_SOLONHAP_GIABAN GB ON CTCT.SOLONHAP_ID = GB.SOLONHAP_ID
      JOIN dbo.TM_DUOC D ON CTCT.DUOC_ID = D.DUOC_ID
      JOIN dbo.TM_TENDUOC TD ON D.TENDUOC_ID = TD.TENDUOC_ID
      JOIN dbo.TM_LOAIDUOC LD ON D.LOAIDUOC_ID = LD.LOAIDUOC_ID
      JOIN dbo.TM_DONVITINH DVT ON D.DONVITINH_ID = DVT.DONVITINH_ID
      JOIN dbo.TM_DONVITINH DVTQD ON CTCT.DONVITINH_ID = DVTQD.DONVITINH_ID
      WHERE  CT.CHUNGTU_ID = '$CHUNGTU_ID$'
    </statement>
    
    <!--Lấy danh sách chứng từ trả thuốc tại quầy-->
    <statement id="DAO09800_GetMasterTRATHUOCTAIQUAY" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      DECLARE @TENBENHVIEN NVARCHAR(250);
      SELECT  @TENBENHVIEN = VALUE
      FROM   dbo.TM_SYS_APPSETTINGS
      WHERE  BENHVIEN_ID = '$BENHVIEN_ID$' AND CODE = 'APP_BENHVIEN_TEN';

      SELECT BTNCHECK = CAST (0 AS BIT), CT.CHUNGTU_ID ,CT.MACHUNGTU ,CT.NGAYCHUNGTU ,CT.MUCDICHCHUNGTU_CODE AS MAMUCDICHCHUNGTU,MDCT.DICTIONARY_NAME AS TENMUCDICHCHUNGTU,CT.NHACUNGCAP_ID ,MANHACUNGCAP = NULL,TENNHACUNGCAP = NULL ,
      NULL AS DIACHI, NULL AS MASOTHUE,CT.MAUHOADON ,CT.SOHOADON ,CT.SOSERI ,CT.NGAYHOADON ,CT.DIENGIAI ,CT.TIENTE_ID ,CT.TYGIA ,CTCT.GIATRI ,CT.TYLEVAT ,CT.GIATRIVAT ,CT.TYLECHIETKHAU ,CT.GIATRICHIETKHAU ,
      CTCT.GIATRITHANHTOAN AS GIATRITHANHTOAN ,NN.MANHANVIEN ,NN.TENNHANVIEN , NULL AS MADONHANG,CT.KHONHAP_ID ,KN.MAKHO AS MAKHONHAP,KN.TENKHO AS TENKHONHAP ,CT.KHOXUAT_ID, NULL AS MAKHOXUAT, NULL AS TENKHOXUAT,
      CT.TRANGTHAI ,CT.PHONGBAN_ID ,PB.MAPHONGBAN ,PB.TENPHONGBAN ,PB.COSTCENTER_ID , CO.MAPHONGBAN AS COSTCENTERCODE, CO.TENPHONGBAN AS COSTCENTERNAME ,CT.BENHVIEN_ID
      ,CT.BENHVIEN_ID AS MABENHVIEN, TENBENHVIEN = @TENBENHVIEN ,
      CT.IDCHUYEN ,CT.BENHNHAN_ID ,BN.MAYTE, CT.TENBENHNHAN AS TENBENHNHAN, CT.DIENGIAI AS GHICHU, NULL AS CHUYENTICHHOP_ID, PV.MAPHAMVI AS PHAMVI,CT.LOAICHUNGTU, STATUSROW = CAST (0 AS BIT), MESSAGEROW = NULL
      FROM   dbo.TT_DUOC_CHUNGTU CT
      JOIN dbo.TM_KHODUOC KN ON CT.KHONHAP_ID = KN.KHODUOC_ID
      CROSS APPLY(SELECT SUM(ISNULL( CTCT.SOLUONGTHUCTE *  SLGB.DONGIAVON,0)) AS GIATRI, SUM(ISNULL( CTCT.SOLUONGTHUCTE *  CTCT.DONGIABAN,0)) AS GIATRITHANHTOAN FROM dbo.TT_DUOC_CHUNGTU_CHITIET CTCT JOIN TT_DUOC_SOLONHAP_GIABAN SLGB ON CTCT.SOLONHAP_ID = SLGB.SOLONHAP_ID WHERE CTCT.CHUNGTU_ID = CT.CHUNGTU_ID) CTCT
      LEFT JOIN dbo.TM_NHANVIEN NN ON CT.NGUOINHAN_ID = NN.NHANVIEN_ID
      JOIN dbo.LST_DICTIONARY MDCT ON CT.MUCDICHCHUNGTU_ID = MDCT.DICTIONARY_ID
      JOIN dbo.TM_PHONGBAN PB ON CT.PHONGBAN_ID = PB.PHONGBAN_ID
      LEFT JOIN dbo.TM_PHONGBAN CO ON PB.COSTCENTER_ID = CO.PHONGBAN_ID
      LEFT JOIN dbo.TM_PHAMVI PV ON KN.PHAMVI_ID = PV.PHAMVI_ID
      LEFT JOIN dbo.TT_BENHNHAN BN ON BN.BENHNHAN_ID = CT.BENHNHAN_ID
      WHERE  CT.BENHVIEN_ID = '$BENHVIEN_ID$' AND CAST(CT.NGAYCHUNGTU AS DATE) BETWEEN '$TUNGAY$' AND '$DENNGAY$'
      AND CT.MUCDICHCHUNGTU_CODE = 'N06'
      AND CT.IDCHUYEN IS NULL
      AND ISNULL(CTCT.GIATRITHANHTOAN,0) > 0
      <isNotEmpty prepend="AND" property="KHONHAP_ID">
        CT.KHONHAP_ID = '$KHONHAP_ID$'
      </isNotEmpty>
      <isNotEmpty prepend="AND" property="NGUOINHAP_ID">
        CT.NGUOINHAN_ID = '$NGUOINHAP_ID$'
      </isNotEmpty>
      <isNotEmpty prepend="AND" property="MACHUNGTU">
        CT.MACHUNGTU LIKE N'%'+#MACHUNGTU#+'%'
      </isNotEmpty>
      <isNotEmpty prepend="AND" property="TENBENHNHAN">
        ISNULL(CT.TENBENHNHAN,'') LIKE N'%'+#TENBENHNHAN#+'%'
      </isNotEmpty>
    </statement>
    <!--Lấy danh sách chứng từ trả thuốc tại quầy đã chuyển-->
    <statement id="DAO09800_GetMasterTRATHUOCTAIQUAY_DACHUYEN" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      DECLARE @TENBENHVIEN NVARCHAR(250);
      SELECT  @TENBENHVIEN = VALUE
      FROM   dbo.TM_SYS_APPSETTINGS
      WHERE  BENHVIEN_ID = '$BENHVIEN_ID$' AND CODE = 'APP_BENHVIEN_TEN';

      SELECT BTNCHECK = CAST (0 AS BIT), CT.CHUNGTU_ID ,CT.MACHUNGTU ,CT.NGAYCHUNGTU ,CT.MUCDICHCHUNGTU_CODE AS MAMUCDICHCHUNGTU,MDCT.DICTIONARY_NAME AS TENMUCDICHCHUNGTU,CT.NHACUNGCAP_ID ,MANHACUNGCAP = NULL,TENNHACUNGCAP = NULL ,
      NULL AS DIACHI, NULL AS MASOTHUE,CT.MAUHOADON ,CT.SOHOADON ,CT.SOSERI ,CT.NGAYHOADON ,CT.DIENGIAI ,CT.TIENTE_ID ,CT.TYGIA ,CTCT.GIATRI ,CT.TYLEVAT ,CT.GIATRIVAT ,CT.TYLECHIETKHAU ,CT.GIATRICHIETKHAU ,
      CTCT.GIATRITHANHTOAN AS GIATRITHANHTOAN ,NN.MANHANVIEN ,NN.TENNHANVIEN , NULL AS MADONHANG,CT.KHONHAP_ID ,KN.MAKHO AS MAKHONHAP,KN.TENKHO AS TENKHONHAP ,CT.KHOXUAT_ID, NULL AS MAKHOXUAT, NULL AS TENKHOXUAT,
      CT.TRANGTHAI ,CT.PHONGBAN_ID ,PB.MAPHONGBAN ,PB.TENPHONGBAN ,PB.COSTCENTER_ID , CO.MAPHONGBAN AS COSTCENTERCODE, CO.TENPHONGBAN AS COSTCENTERNAME ,CT.BENHVIEN_ID
      ,CT.BENHVIEN_ID AS MABENHVIEN, TENBENHVIEN = @TENBENHVIEN ,
      CT.IDCHUYEN ,CT.BENHNHAN_ID ,BN.MAYTE, CT.TENBENHNHAN AS TENBENHNHAN, CT.DIENGIAI AS GHICHU, NULL AS CHUYENTICHHOP_ID, PV.MAPHAMVI AS PHAMVI,CT.LOAICHUNGTU, STATUSROW = CAST (0 AS BIT), MESSAGEROW = NULL
      ,TH.THOIGIANCHUYEN
      FROM   dbo.TT_DUOC_CHUNGTU CT
      JOIN VIEW_IDCHUYENTICHHOP TH on TH.CHUYENTICHHOP_ID = CT.IDCHUYEN
      CROSS APPLY(SELECT SUM(ISNULL( CTCT.SOLUONGTHUCTE *  SLGB.DONGIAVON,0)) AS GIATRI, SUM(ISNULL( CTCT.SOLUONGTHUCTE *  CTCT.DONGIABAN,0)) AS GIATRITHANHTOAN FROM dbo.TT_DUOC_CHUNGTU_CHITIET CTCT JOIN TT_DUOC_SOLONHAP_GIABAN SLGB ON CTCT.SOLONHAP_ID = SLGB.SOLONHAP_ID WHERE CTCT.CHUNGTU_ID = CT.CHUNGTU_ID) CTCT
      JOIN dbo.TM_KHODUOC KN ON CT.KHONHAP_ID = KN.KHODUOC_ID
      LEFT JOIN dbo.TM_NHANVIEN NN ON CT.NGUOINHAP_ID = NN.NHANVIEN_ID
      JOIN dbo.LST_DICTIONARY MDCT ON CT.MUCDICHCHUNGTU_ID = MDCT.DICTIONARY_ID
      JOIN dbo.TM_PHONGBAN PB ON CT.PHONGBAN_ID = PB.PHONGBAN_ID
      LEFT JOIN dbo.TM_PHONGBAN CO ON PB.COSTCENTER_ID = CO.PHONGBAN_ID
      LEFT JOIN dbo.TM_PHAMVI PV ON KN.PHAMVI_ID = PV.PHAMVI_ID
      LEFT JOIN dbo.TT_BENHNHAN BN ON BN.BENHNHAN_ID = CT.BENHNHAN_ID
      WHERE  CT.BENHVIEN_ID = '$BENHVIEN_ID$' AND CAST(CT.NGAYCHUNGTU AS DATE) BETWEEN '$TUNGAY$' AND '$DENNGAY$'
      AND CT.MUCDICHCHUNGTU_CODE = 'N06'
      AND CT.IDCHUYEN IS NOT NULL
      AND ISNULL(CTCT.GIATRITHANHTOAN,0) > 0
      <isNotEmpty prepend="AND" property="KHONHAP_ID">
        CT.KHONHAP_ID = '$KHONHAP_ID$'
      </isNotEmpty>
      <isNotEmpty prepend="AND" property="NGUOINHAP_ID">
        CT.NGUOINHAN_ID = '$NGUOINHAP_ID$'
      </isNotEmpty>
      <isNotEmpty prepend="AND" property="MACHUNGTU">
        CT.MACHUNGTU LIKE N'%'+#MACHUNGTU#+'%'
      </isNotEmpty>
      <isNotEmpty prepend="AND" property="TENBENHNHAN">
        ISNULL(CT.TENBENHNHAN,'') LIKE N'%'+#TENBENHNHAN#+'%'
      </isNotEmpty>
    </statement>
    <!--Lấy danh sách chứng từ chi tiết trả thuốc tại quầy-->
    <statement id="DAO09800_GetDetailTRATHUOCTAIQUAY" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      SELECT	  TICHHOP_ID = NULL,CT.CHUNGTU_ID, CTCT.CHUNGTUCHITIET_ID ,LD.LOAIVATTU_ID ,LD.MALOAIDUOC ,LD.TENLOAIDUOC ,D.MADUOC ,TD.TENDUOC  ,
      DONVITINH = DVT.TENDONVITINH,DONVIQUICACH = DVTQD.TENDONVITINH ,GIATRIQUIDOI = DVTQD.GIATRIQUIDOI ,SOLUONG = CTCT.SOLUONGTHUCTE  ,DONGIA = GB.DONGIAVON,GIATRI = CTCT.SOLUONGTHUCTE *  GB.DONGIAVON,
      TYLEVAT = CTCT.TYLEVAT,GIATRIVAT = CTCT.GIATRIVAT ,TYLECHIETKHAU = CTCT.TYLECHIETKHAU ,GIATRICHIETKHAU = CTCT.GIATRICHIETKHAU ,GIATRITHANHTOAN = ISNULL( CTCT.SOLUONGTHUCTE *  CTCT.DONGIABAN,0) ,CTCT.KHUYENMAI
      FROM   dbo.TT_DUOC_CHUNGTU CT
      JOIN dbo.TT_DUOC_CHUNGTU_CHITIET CTCT ON CTCT.CHUNGTU_ID = CT.CHUNGTU_ID
      JOIN dbo.TT_DUOC_SOLONHAP_GIABAN GB ON CTCT.SOLONHAP_ID = GB.SOLONHAP_ID
      JOIN dbo.TM_DUOC D ON CTCT.DUOC_ID = D.DUOC_ID
      JOIN dbo.TM_TENDUOC TD ON D.TENDUOC_ID = TD.TENDUOC_ID
      JOIN dbo.TM_LOAIDUOC LD ON D.LOAIDUOC_ID = LD.LOAIDUOC_ID
      JOIN dbo.TM_DONVITINH DVT ON D.DONVITINH_ID = DVT.DONVITINH_ID
      JOIN dbo.TM_DONVITINH DVTQD ON CTCT.DONVITINH_ID = DVTQD.DONVITINH_ID
      WHERE  CT.CHUNGTU_ID = '$CHUNGTU_ID$'
    </statement>

    <!--Lấy danh sách chứng từ điều chỉnh tăng-->
    <statement id="DAO09800_GetMasterDuoc_DieuChinhTang" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      DECLARE @TENBENHVIEN NVARCHAR(250);
      SELECT  @TENBENHVIEN = VALUE
      FROM    dbo.TM_SYS_APPSETTINGS
      WHERE   BENHVIEN_ID = '$BENHVIEN_ID$'
      AND CODE = 'APP_BENHVIEN_TEN';

      SELECT  BTNCHECK = CAST (0 AS BIT) ,CT.CHUNGTU_ID ,CT.MACHUNGTU ,CT.NGAYCHUNGTU ,CT.MUCDICHCHUNGTU_CODE AS MAMUCDICHCHUNGTU ,MDCT.DICTIONARY_NAME AS TENMUCDICHCHUNGTU ,
      CT.NHACUNGCAP_ID ,MANHACUNGCAP = NULL ,TENNHACUNGCAP = NULL ,NULL AS DIACHI ,NULL AS MASOTHUE ,CT.MAUHOADON ,CT.SOHOADON ,CT.SOSERI ,CT.NGAYHOADON ,CT.DIENGIAI ,
      CT.TIENTE_ID ,CT.TYGIA ,CT.GIATRI ,CT.TYLEVAT ,CT.GIATRIVAT ,CT.TYLECHIETKHAU ,CT.GIATRICHIETKHAU ,ISNULL(CT.GIATRI, CTCT.GIATRITHANHTOAN) AS GIATRITHANHTOAN ,
      NN.MANHANVIEN ,NN.TENNHANVIEN ,NULL AS MADONHANG ,CT.KHONHAP_ID ,KN.MAKHO AS MAKHONHAP ,KN.TENKHO AS TENKHONHAP ,CT.KHOXUAT_ID ,NULL AS MAKHOXUAT ,NULL AS TENKHOXUAT ,
      CT.TRANGTHAI ,CT.PHONGBAN_ID ,PB.MAPHONGBAN ,PB.TENPHONGBAN ,PB.COSTCENTER_ID ,CO.MAPHONGBAN AS COSTCENTERCODE ,CO.TENPHONGBAN AS COSTCENTERNAME ,
      CT.BENHVIEN_ID ,CT.BENHVIEN_ID AS MABENHVIEN ,TENBENHVIEN = @TENBENHVIEN ,CT.IDCHUYEN ,CT.BENHNHAN_ID ,NULL AS MAYTE ,
      CT.TENBENHNHAN AS TENBENHNHAN ,CT.DIENGIAI AS GHICHU ,NULL AS CHUYENTICHHOP_ID ,PV.MAPHAMVI AS PHAMVI ,CT.LOAICHUNGTU ,STATUSROW = CAST (0 AS BIT) ,MESSAGEROW = NULL
      FROM    dbo.TT_DUOC_CHUNGTU CT
      JOIN dbo.TM_KHODUOC KN ON CT.KHONHAP_ID = KN.KHODUOC_ID
      CROSS APPLY ( SELECT    SUM(CTCT.SOLUONGTHUCTE * SLGB.DONGIAVON) AS GIATRITHANHTOAN
      FROM      dbo.TT_DUOC_CHUNGTU_CHITIET CTCT
	  JOIN TT_DUOC_SOLONHAP_GIABAN SLGB ON CTCT.SOLONHAP_ID = SLGB.SOLONHAP_ID
      WHERE     CTCT.CHUNGTU_ID = CT.CHUNGTU_ID
      ) CTCT
      LEFT JOIN dbo.TM_NHANVIEN NN ON CT.NGUOINHAN_ID = NN.NHANVIEN_ID
      JOIN dbo.LST_DICTIONARY MDCT ON CT.MUCDICHCHUNGTU_ID = MDCT.DICTIONARY_ID
      JOIN dbo.TM_PHONGBAN PB ON CT.PHONGBAN_ID = PB.PHONGBAN_ID
      LEFT JOIN dbo.TM_PHONGBAN CO ON PB.COSTCENTER_ID = CO.PHONGBAN_ID
      LEFT JOIN dbo.TM_PHAMVI PV ON KN.PHAMVI_ID = PV.PHAMVI_ID
      WHERE   CT.BENHVIEN_ID = '$BENHVIEN_ID$' AND CAST(CT.NGAYCHUNGTU AS DATE) BETWEEN '$TUNGAY$' AND '$DENNGAY$'
      AND CT.MUCDICHCHUNGTU_CODE = 'N04'
      AND CT.IDCHUYEN IS NULL
      AND ISNULL(CTCT.GIATRITHANHTOAN,0) > 0
      <isNotEmpty prepend="AND" property="KHONHAP_ID">
        CT.KHONHAP_ID = '$KHONHAP_ID$'
      </isNotEmpty>
      <isNotEmpty prepend="AND" property="NGUOINHAP_ID">
        CT.NGUOINHAN_ID = '$NGUOINHAP_ID$'
      </isNotEmpty>
      <isNotEmpty prepend="AND" property="MACHUNGTU">
        CT.MACHUNGTU LIKE N'%'+#MACHUNGTU#+'%'
      </isNotEmpty>
    </statement>
    <!--Lấy danh sách chứng từ điều chỉnh tăng đã chuyển-->
    <statement id="DAO09800_GetMasterDuoc_DieuChinhTang_DACHUYEN" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      DECLARE @TENBENHVIEN NVARCHAR(250);
      SELECT  @TENBENHVIEN = VALUE
      FROM    dbo.TM_SYS_APPSETTINGS
      WHERE   BENHVIEN_ID = '$BENHVIEN_ID$'
      AND CODE = 'APP_BENHVIEN_TEN';

      SELECT  BTNCHECK = CAST (0 AS BIT) ,
      CT.CHUNGTU_ID ,
      CT.MACHUNGTU ,
      CT.NGAYCHUNGTU ,
      CT.MUCDICHCHUNGTU_CODE AS MAMUCDICHCHUNGTU ,
      MDCT.DICTIONARY_NAME AS TENMUCDICHCHUNGTU ,
      CT.NHACUNGCAP_ID ,
      MANHACUNGCAP = NULL ,
      TENNHACUNGCAP = NULL ,
      NULL AS DIACHI ,
      NULL AS MASOTHUE ,
      CT.MAUHOADON ,
      CT.SOHOADON ,
      CT.SOSERI ,
      CT.NGAYHOADON ,
      CT.DIENGIAI ,
      CT.TIENTE_ID ,
      CT.TYGIA ,
      CT.GIATRI ,
      CT.TYLEVAT ,
      CT.GIATRIVAT ,
      CT.TYLECHIETKHAU ,
      CT.GIATRICHIETKHAU ,
      ISNULL(CT.GIATRI, CTCT.GIATRITHANHTOAN) AS GIATRITHANHTOAN ,
      NN.MANHANVIEN ,
      NN.TENNHANVIEN ,
      NULL AS MADONHANG ,
      CT.KHONHAP_ID ,
      KN.MAKHO AS MAKHONHAP ,
      KN.TENKHO AS TENKHONHAP ,
      CT.KHOXUAT_ID ,
      NULL AS MAKHOXUAT ,
      NULL AS TENKHOXUAT ,
      CT.TRANGTHAI ,
      CT.PHONGBAN_ID ,
      PB.MAPHONGBAN ,
      PB.TENPHONGBAN ,
      PB.COSTCENTER_ID ,
      CO.MAPHONGBAN AS COSTCENTERCODE ,
      CO.TENPHONGBAN AS COSTCENTERNAME ,
      CT.BENHVIEN_ID ,
      CT.BENHVIEN_ID AS MABENHVIEN ,
      TENBENHVIEN = @TENBENHVIEN ,
      CT.IDCHUYEN ,
      CT.BENHNHAN_ID ,
      NULL AS MAYTE ,
      CT.TENBENHNHAN AS TENBENHNHAN ,
      CT.DIENGIAI AS GHICHU ,
      NULL AS CHUYENTICHHOP_ID ,
      PV.MAPHAMVI AS PHAMVI ,
      CT.LOAICHUNGTU ,
      STATUSROW = CAST (0 AS BIT) ,
      MESSAGEROW = NULL
      FROM    dbo.TT_DUOC_CHUNGTU CT
      JOIN dbo.TM_KHODUOC KN ON CT.KHONHAP_ID = KN.KHODUOC_ID
      CROSS APPLY ( SELECT    SUM(CTCT.SOLUONGTHUCTE * SLGB.DONGIAVON) AS GIATRITHANHTOAN
      FROM      dbo.TT_DUOC_CHUNGTU_CHITIET CTCT
	  JOIN TT_DUOC_SOLONHAP_GIABAN SLGB ON CTCT.SOLONHAP_ID = SLGB.SOLONHAP_ID
      WHERE     CTCT.CHUNGTU_ID = CT.CHUNGTU_ID
      ) CTCT
      LEFT JOIN dbo.TM_NHANVIEN NN ON CT.NGUOINHAN_ID = NN.NHANVIEN_ID
      JOIN dbo.LST_DICTIONARY MDCT ON CT.MUCDICHCHUNGTU_ID = MDCT.DICTIONARY_ID
      JOIN dbo.TM_PHONGBAN PB ON CT.PHONGBAN_ID = PB.PHONGBAN_ID
      LEFT JOIN dbo.TM_PHONGBAN CO ON PB.COSTCENTER_ID = CO.PHONGBAN_ID
      LEFT JOIN dbo.TM_PHAMVI PV ON KN.PHAMVI_ID = PV.PHAMVI_ID
      WHERE   CT.BENHVIEN_ID = '$BENHVIEN_ID$' AND CAST(CT.NGAYCHUNGTU AS DATE) BETWEEN '$TUNGAY$' AND '$DENNGAY$'
      AND CT.MUCDICHCHUNGTU_CODE = 'N04'
      AND CT.IDCHUYEN IS NOT NULL
      AND ISNULL(CTCT.GIATRITHANHTOAN,0) > 0
      <isNotEmpty prepend="AND" property="KHONHAP_ID">
        CT.KHONHAP_ID = '$KHONHAP_ID$'
      </isNotEmpty>
      <isNotEmpty prepend="AND" property="NGUOINHAP_ID">
        CT.NGUOINHAN_ID = '$NGUOINHAP_ID$'
      </isNotEmpty>
      <isNotEmpty prepend="AND" property="MACHUNGTU">
        CT.MACHUNGTU LIKE N'%'+#MACHUNGTU#+'%'
      </isNotEmpty>
    </statement>
    <!--Lấy danh sách chứng từ chi tiết điều chỉnh tăng-->
    <statement id="DAO09800_GetDetailDuoc_DieuChinhTang" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      SELECT	  TICHHOP_ID = NULL,
      CT.CHUNGTU_ID ,
      CTCT.CHUNGTUCHITIET_ID ,
      LD.LOAIVATTU_ID ,
      LD.MALOAIDUOC ,
      LD.TENLOAIDUOC ,
      D.MADUOC ,
      TD.TENDUOC  ,
      DONVITINH = DVT.TENDONVITINH,
      DONVIQUICACH = DVTQD.TENDONVITINH ,
      GIATRIQUIDOI = DVTQD.GIATRIQUIDOI ,
      SOLUONG = CTCT.SOLUONGTHUCTE  ,
      DONGIA = GB.DONGIAVON,
      GIATRI = CTCT.SOLUONGTHUCTE *  GB.DONGIAVON,
      TYLEVAT = CTCT.TYLEVAT,
      GIATRIVAT = CTCT.GIATRIVAT ,
      TYLECHIETKHAU = CTCT.TYLECHIETKHAU ,
      GIATRICHIETKHAU = CTCT.GIATRICHIETKHAU ,
      GIATRITHANHTOAN = ISNULL( CTCT.SOLUONGTHUCTE *  GB.DONGIAVON,0) ,
      CTCT.KHUYENMAI
      FROM   dbo.TT_DUOC_CHUNGTU CT
      JOIN dbo.TT_DUOC_CHUNGTU_CHITIET CTCT ON CTCT.CHUNGTU_ID = CT.CHUNGTU_ID
      JOIN dbo.TT_DUOC_SOLONHAP_GIABAN GB ON CTCT.SOLONHAP_ID = GB.SOLONHAP_ID
      JOIN dbo.TM_DUOC D ON CTCT.DUOC_ID = D.DUOC_ID
      JOIN dbo.TM_TENDUOC TD ON D.TENDUOC_ID = TD.TENDUOC_ID
      JOIN dbo.TM_LOAIDUOC LD ON D.LOAIDUOC_ID = LD.LOAIDUOC_ID
      JOIN dbo.TM_DONVITINH DVT ON D.DONVITINH_ID = DVT.DONVITINH_ID
      JOIN dbo.TM_DONVITINH DVTQD ON CTCT.DONVITINH_ID = DVTQD.DONVITINH_ID
      WHERE  CT.CHUNGTU_ID = '$CHUNGTU_ID$'
    </statement>

    <!--Lấy danh sách chứng từ điều chỉnh giảm-->
    <statement id="DAO09800_GetMasterDuoc_DieuChinhGiam" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      DECLARE @TENBENHVIEN NVARCHAR(250);
      SELECT  @TENBENHVIEN = VALUE
      FROM    dbo.TM_SYS_APPSETTINGS
      WHERE   BENHVIEN_ID = '$BENHVIEN_ID$'
      AND CODE = 'APP_BENHVIEN_TEN';

      SELECT  BTNCHECK = CAST (0 AS BIT) ,
      CT.CHUNGTU_ID ,
      CT.MACHUNGTU ,
      CT.NGAYCHUNGTU ,
      CT.MUCDICHCHUNGTU_CODE AS MAMUCDICHCHUNGTU ,
      MDCT.DICTIONARY_NAME AS TENMUCDICHCHUNGTU ,
      CT.NHACUNGCAP_ID ,
      MANHACUNGCAP = NULL ,
      TENNHACUNGCAP = NULL ,
      NULL AS DIACHI ,
      NULL AS MASOTHUE ,
      CT.MAUHOADON ,
      CT.SOHOADON ,
      CT.SOSERI ,
      CT.NGAYHOADON ,
      CT.DIENGIAI ,
      CT.TIENTE_ID ,
      CT.TYGIA ,
      CT.GIATRI ,
      CT.TYLEVAT ,
      CT.GIATRIVAT ,
      CT.TYLECHIETKHAU ,
      CT.GIATRICHIETKHAU ,
      ISNULL(CT.GIATRI, CTCT.GIATRITHANHTOAN) AS GIATRITHANHTOAN ,
      NX.MANHANVIEN ,
      NX.TENNHANVIEN ,
      NULL AS MADONHANG ,
      CT.KHONHAP_ID ,
      NULL AS MAKHONHAP ,
      NULL AS TENKHONHAP ,
      CT.KHOXUAT_ID ,
      KX.MAKHO AS MAKHOXUAT ,
      KX.TENKHO AS TENKHOXUAT ,
      CT.TRANGTHAI ,
      CT.PHONGBAN_ID ,
      PB.MAPHONGBAN ,
      PB.TENPHONGBAN ,
      PB.COSTCENTER_ID ,
      CO.MAPHONGBAN AS COSTCENTERCODE ,
      CO.TENPHONGBAN AS COSTCENTERNAME ,
      CT.BENHVIEN_ID ,
      CT.BENHVIEN_ID AS MABENHVIEN ,
      TENBENHVIEN = @TENBENHVIEN ,
      CT.IDCHUYEN ,
      CT.BENHNHAN_ID ,
      NULL AS MAYTE ,
      CT.TENBENHNHAN AS TENBENHNHAN ,
      CT.DIENGIAI AS GHICHU ,
      NULL AS CHUYENTICHHOP_ID ,
      PV.MAPHAMVI AS PHAMVI ,
      CT.LOAICHUNGTU ,
      STATUSROW = CAST (0 AS BIT) ,
      MESSAGEROW = NULL
      FROM    dbo.TT_DUOC_CHUNGTU CT
      JOIN dbo.TM_KHODUOC KX ON CT.KHOXUAT_ID = KX.KHODUOC_ID
      CROSS APPLY ( SELECT    SUM(CTCT.SOLUONGDAXUAT * SLGB.DONGIAVON) AS GIATRITHANHTOAN
      FROM      dbo.TT_DUOC_CHUNGTU_CHITIET CTCT
	  JOIN TT_DUOC_SOLONHAP_GIABAN SLGB ON CTCT.SOLONHAP_ID = SLGB.SOLONHAP_ID
      WHERE     CTCT.CHUNGTU_ID = CT.CHUNGTU_ID
      ) CTCT
      LEFT JOIN dbo.TM_NHANVIEN NX ON CT.NGUOIGIAO_ID = NX.NHANVIEN_ID
      JOIN dbo.LST_DICTIONARY MDCT ON CT.MUCDICHCHUNGTU_ID = MDCT.DICTIONARY_ID
      JOIN dbo.TM_PHONGBAN PB ON CT.PHONGBAN_ID = PB.PHONGBAN_ID
      LEFT JOIN dbo.TM_PHONGBAN CO ON PB.COSTCENTER_ID = CO.PHONGBAN_ID
      LEFT JOIN dbo.TM_PHAMVI PV ON KX.PHAMVI_ID = PV.PHAMVI_ID
      WHERE   CT.BENHVIEN_ID = '$BENHVIEN_ID$' AND CAST(CT.NGAYCHUNGTU AS DATE) BETWEEN '$TUNGAY$' AND '$DENNGAY$'
      AND CT.MUCDICHCHUNGTU_CODE = 'X04'
      AND CT.IDCHUYEN IS NULL
      AND ISNULL(CTCT.GIATRITHANHTOAN,0) > 0
      <isNotEmpty prepend="AND" property="KHOXUAT_ID">
        CT.KHOXUAT_ID = '$KHOXUAT_ID$'
      </isNotEmpty>
      <isNotEmpty prepend="AND" property="NGUOIXUAT_ID">
        CT.NGUOIGIAO_ID = '$NGUOIXUAT_ID$'
      </isNotEmpty>
      <isNotEmpty prepend="AND" property="MACHUNGTU">
        CT.MACHUNGTU LIKE N'%'+#MACHUNGTU#+'%'
      </isNotEmpty>
    </statement>
    <!--Lấy danh sách chứng từ điều chỉnh giảm đã chuyển-->
    <statement id="DAO09800_GetMasterDuoc_DieuChinhGiam_DACHUYEN" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      DECLARE @TENBENHVIEN NVARCHAR(250);
      SELECT  @TENBENHVIEN = VALUE
      FROM    dbo.TM_SYS_APPSETTINGS
      WHERE   BENHVIEN_ID = '$BENHVIEN_ID$'
      AND CODE = 'APP_BENHVIEN_TEN';

      SELECT  BTNCHECK = CAST (0 AS BIT) ,
      CT.CHUNGTU_ID ,
      CT.MACHUNGTU ,
      CT.NGAYCHUNGTU ,
      CT.MUCDICHCHUNGTU_CODE AS MAMUCDICHCHUNGTU ,
      MDCT.DICTIONARY_NAME AS TENMUCDICHCHUNGTU ,
      CT.NHACUNGCAP_ID ,
      MANHACUNGCAP = NULL ,
      TENNHACUNGCAP = NULL ,
      NULL AS DIACHI ,
      NULL AS MASOTHUE ,
      CT.MAUHOADON ,
      CT.SOHOADON ,
      CT.SOSERI ,
      CT.NGAYHOADON ,
      CT.DIENGIAI ,
      CT.TIENTE_ID ,
      CT.TYGIA ,
      CT.GIATRI ,
      CT.TYLEVAT ,
      CT.GIATRIVAT ,
      CT.TYLECHIETKHAU ,
      CT.GIATRICHIETKHAU ,
      ISNULL(CT.GIATRI, CTCT.GIATRITHANHTOAN) AS GIATRITHANHTOAN ,
      NX.MANHANVIEN ,
      NX.TENNHANVIEN ,
      NULL AS MADONHANG ,
      CT.KHONHAP_ID ,
      NULL AS MAKHONHAP ,
      NULL AS TENKHONHAP ,
      CT.KHOXUAT_ID ,
      KX.MAKHO AS MAKHOXUAT ,
      KX.TENKHO AS TENKHOXUAT ,
      CT.TRANGTHAI ,
      CT.PHONGBAN_ID ,
      PB.MAPHONGBAN ,
      PB.TENPHONGBAN ,
      PB.COSTCENTER_ID ,
      CO.MAPHONGBAN AS COSTCENTERCODE ,
      CO.TENPHONGBAN AS COSTCENTERNAME ,
      CT.BENHVIEN_ID ,
      CT.BENHVIEN_ID AS MABENHVIEN ,
      TENBENHVIEN = @TENBENHVIEN ,
      CT.IDCHUYEN ,
      CT.BENHNHAN_ID ,
      NULL AS MAYTE ,
      CT.TENBENHNHAN AS TENBENHNHAN ,
      CT.DIENGIAI AS GHICHU ,
      NULL AS CHUYENTICHHOP_ID ,
      PV.MAPHAMVI AS PHAMVI ,
      CT.LOAICHUNGTU ,
      STATUSROW = CAST (0 AS BIT) ,
      MESSAGEROW = NULL
      ,TH.THOIGIANCHUYEN
      FROM    dbo.TT_DUOC_CHUNGTU CT
      JOIN VIEW_IDCHUYENTICHHOP TH on TH.CHUYENTICHHOP_ID = CT.IDCHUYEN
      JOIN dbo.TM_KHODUOC KX ON CT.KHOXUAT_ID = KX.KHODUOC_ID
      CROSS APPLY ( SELECT    SUM(CTCT.SOLUONGDAXUAT * SLGB.DONGIAVON) AS GIATRITHANHTOAN
      FROM      dbo.TT_DUOC_CHUNGTU_CHITIET CTCT
	  JOIN TT_DUOC_SOLONHAP_GIABAN SLGB ON CTCT.SOLONHAP_ID = SLGB.SOLONHAP_ID
      WHERE     CTCT.CHUNGTU_ID = CT.CHUNGTU_ID
      ) CTCT
      LEFT JOIN dbo.TM_NHANVIEN NX ON CT.NGUOIGIAO_ID = NX.NHANVIEN_ID
      JOIN dbo.LST_DICTIONARY MDCT ON CT.MUCDICHCHUNGTU_ID = MDCT.DICTIONARY_ID
      JOIN dbo.TM_PHONGBAN PB ON CT.PHONGBAN_ID = PB.PHONGBAN_ID
      LEFT JOIN dbo.TM_PHONGBAN CO ON PB.COSTCENTER_ID = CO.PHONGBAN_ID
      LEFT JOIN dbo.TM_PHAMVI PV ON KX.PHAMVI_ID = PV.PHAMVI_ID
      WHERE   CT.BENHVIEN_ID = '$BENHVIEN_ID$' AND CAST(CT.NGAYCHUNGTU AS DATE) BETWEEN '$TUNGAY$' AND '$DENNGAY$'
      AND CT.MUCDICHCHUNGTU_CODE = 'X04'
      AND CT.IDCHUYEN IS NOT NULL
      AND ISNULL(CTCT.GIATRITHANHTOAN,0) > 0
      <isNotEmpty prepend="AND" property="KHOXUAT_ID">
        CT.KHOXUAT_ID = '$KHOXUAT_ID$'
      </isNotEmpty>
      <isNotEmpty prepend="AND" property="NGUOIXUAT_ID">
        CT.NGUOIGIAO_ID = '$NGUOIXUAT_ID$'
      </isNotEmpty>
      <isNotEmpty prepend="AND" property="MACHUNGTU">
        CT.MACHUNGTU LIKE N'%'+#MACHUNGTU#+'%'
      </isNotEmpty>
    </statement>
    <!--Lấy danh sách chứng từ chi tiết điều chỉnh giảm-->
    <statement id="DAO09800_GetDetailDuoc_DieuChinhGiam" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      SELECT	  TICHHOP_ID = NULL,
      CT.CHUNGTU_ID , 
      CTCT.CHUNGTUCHITIET_ID ,
      LD.LOAIVATTU_ID ,
      LD.MALOAIDUOC ,
      LD.TENLOAIDUOC ,
      D.MADUOC ,
      TD.TENDUOC  ,
      DONVITINH = DVT.TENDONVITINH,
      DONVIQUICACH = DVTQD.TENDONVITINH ,
      GIATRIQUIDOI = DVTQD.GIATRIQUIDOI ,
      SOLUONG = CTCT.SOLUONGDAXUAT  ,
      DONGIA = GB.DONGIAVON,
      GIATRI = CTCT.SOLUONGDAXUAT * GB.DONGIAVON ,
      TYLEVAT = CTCT.TYLEVAT,
      GIATRIVAT = CTCT.GIATRIVAT ,
      TYLECHIETKHAU = CTCT.TYLECHIETKHAU ,
      GIATRICHIETKHAU = CTCT.GIATRICHIETKHAU ,
      GIATRITHANHTOAN = ISNULL(CTCT.SOLUONGDAXUAT * GB.DONGIAVON,0),
      CTCT.KHUYENMAI
      FROM   dbo.TT_DUOC_CHUNGTU CT
      JOIN dbo.TT_DUOC_CHUNGTU_CHITIET CTCT ON CTCT.CHUNGTU_ID = CT.CHUNGTU_ID
      JOIN dbo.TT_DUOC_SOLONHAP_GIABAN GB ON CTCT.SOLONHAP_ID = GB.SOLONHAP_ID
      JOIN dbo.TM_DUOC D ON CTCT.DUOC_ID = D.DUOC_ID
      JOIN dbo.TM_TENDUOC TD ON D.TENDUOC_ID = TD.TENDUOC_ID
      JOIN dbo.TM_LOAIDUOC LD ON D.LOAIDUOC_ID = LD.LOAIDUOC_ID
      JOIN dbo.TM_DONVITINH DVT ON D.DONVITINH_ID = DVT.DONVITINH_ID
      JOIN dbo.TM_DONVITINH DVTQD ON CTCT.DONVITINH_ID = DVTQD.DONVITINH_ID
      WHERE  CT.CHUNGTU_ID = '$CHUNGTU_ID$'
    </statement>

    <!--Lấy danh sách chứng từ thanh lý dược-->
    <statement id="DAO09800_GetMasterDuoc_ThanhLy" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      DECLARE @TENBENHVIEN NVARCHAR(250);
      SELECT  @TENBENHVIEN = VALUE
      FROM    dbo.TM_SYS_APPSETTINGS
      WHERE   BENHVIEN_ID = '$BENHVIEN_ID$'
      AND CODE = 'APP_BENHVIEN_TEN';

      SELECT  BTNCHECK = CAST (0 AS BIT) ,
      CT.CHUNGTU_ID ,
      CT.MACHUNGTU ,
      CT.NGAYCHUNGTU ,
      CT.MUCDICHCHUNGTU_CODE AS MAMUCDICHCHUNGTU ,
      MDCT.DICTIONARY_NAME AS TENMUCDICHCHUNGTU ,
      CT.NHACUNGCAP_ID ,
      MANHACUNGCAP = NULL ,
      TENNHACUNGCAP = NULL ,
      NULL AS DIACHI ,
      NULL AS MASOTHUE ,
      CT.MAUHOADON ,
      CT.SOHOADON ,
      CT.SOSERI ,
      CT.NGAYHOADON ,
      CT.DIENGIAI ,
      CT.TIENTE_ID ,
      CT.TYGIA ,
      CT.GIATRI ,
      CT.TYLEVAT ,
      CT.GIATRIVAT ,
      CT.TYLECHIETKHAU ,
      CT.GIATRICHIETKHAU ,
      CTCT.GIATRITHANHTOAN AS GIATRITHANHTOAN ,
      NX.MANHANVIEN ,
      NX.TENNHANVIEN ,
      NULL AS MADONHANG ,
      CT.KHONHAP_ID ,
      NULL AS MAKHONHAP ,
      NULL AS TENKHONHAP ,
      CT.KHOXUAT_ID ,
      KX.MAKHO AS MAKHOXUAT ,
      KX.TENKHO AS TENKHOXUAT ,
      CT.TRANGTHAI ,
      CT.PHONGBAN_ID ,
      PB.MAPHONGBAN ,
      PB.TENPHONGBAN ,
      PB.COSTCENTER_ID ,
      CO.MAPHONGBAN AS COSTCENTERCODE ,
      CO.TENPHONGBAN AS COSTCENTERNAME ,
      CT.BENHVIEN_ID ,
      CT.BENHVIEN_ID AS MABENHVIEN ,
      TENBENHVIEN = @TENBENHVIEN ,
      CT.IDCHUYEN ,
      CT.BENHNHAN_ID ,
      NULL AS MAYTE ,
      CT.TENBENHNHAN AS TENBENHNHAN ,
      CT.DIENGIAI AS GHICHU ,
      NULL AS CHUYENTICHHOP_ID ,
      PV.MAPHAMVI AS PHAMVI ,
      CT.LOAICHUNGTU ,
      STATUSROW = CAST (0 AS BIT) ,
      MESSAGEROW = NULL
      FROM    dbo.TT_DUOC_CHUNGTU CT
      JOIN dbo.TM_KHODUOC KX ON CT.KHOXUAT_ID = KX.KHODUOC_ID
      CROSS APPLY ( SELECT    SUM(CTCT.SOLUONGDAXUAT * SLGB.DONGIAVON) AS GIATRITHANHTOAN
      FROM      dbo.TT_DUOC_CHUNGTU_CHITIET CTCT
	  JOIN TT_DUOC_SOLONHAP_GIABAN SLGB ON CTCT.SOLONHAP_ID = SLGB.SOLONHAP_ID
      WHERE     CTCT.CHUNGTU_ID = CT.CHUNGTU_ID
      ) CTCT
      LEFT JOIN dbo.TM_NHANVIEN NX ON CT.NGUOIGIAO_ID = NX.NHANVIEN_ID
      JOIN dbo.LST_DICTIONARY MDCT ON CT.MUCDICHCHUNGTU_ID = MDCT.DICTIONARY_ID
      JOIN dbo.TM_PHONGBAN PB ON CT.PHONGBAN_ID = PB.PHONGBAN_ID
      LEFT JOIN dbo.TM_PHONGBAN CO ON PB.COSTCENTER_ID = CO.PHONGBAN_ID
      LEFT JOIN dbo.TM_PHAMVI PV ON KX.PHAMVI_ID = PV.PHAMVI_ID
      WHERE   CT.BENHVIEN_ID = '$BENHVIEN_ID$' AND CAST(CT.NGAYCHUNGTU AS DATE) BETWEEN '$TUNGAY$' AND '$DENNGAY$'
      AND CT.MUCDICHCHUNGTU_CODE = 'X03'
      AND CT.IDCHUYEN IS NULL
      AND ISNULL(CTCT.GIATRITHANHTOAN,0) > 0
      <isNotEmpty prepend="AND" property="KHOXUAT_ID">
        CT.KHOXUAT_ID = '$KHOXUAT_ID$'
      </isNotEmpty>
      <isNotEmpty prepend="AND" property="NGUOIXUAT_ID">
        CT.NGUOIGIAO_ID = '$NGUOIXUAT_ID$'
      </isNotEmpty>
      <isNotEmpty prepend="AND" property="MACHUNGTU">
        CT.MACHUNGTU LIKE N'%'+#MACHUNGTU#+'%'
      </isNotEmpty>
    </statement>
    <!--Lấy danh sách chứng từ thanh lý dược đã chuyển-->
    <statement id="DAO09800_GetMasterDuoc_ThanhLy_DACHUYEN" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      DECLARE @TENBENHVIEN NVARCHAR(250);
      SELECT  @TENBENHVIEN = VALUE
      FROM    dbo.TM_SYS_APPSETTINGS
      WHERE   BENHVIEN_ID = '$BENHVIEN_ID$'
      AND CODE = 'APP_BENHVIEN_TEN';

      SELECT  BTNCHECK = CAST (0 AS BIT) ,
      CT.CHUNGTU_ID ,
      CT.MACHUNGTU ,
      CT.NGAYCHUNGTU ,
      CT.MUCDICHCHUNGTU_CODE AS MAMUCDICHCHUNGTU ,
      MDCT.DICTIONARY_NAME AS TENMUCDICHCHUNGTU ,
      CT.NHACUNGCAP_ID ,
      MANHACUNGCAP = NULL ,
      TENNHACUNGCAP = NULL ,
      NULL AS DIACHI ,
      NULL AS MASOTHUE ,
      CT.MAUHOADON ,
      CT.SOHOADON ,
      CT.SOSERI ,
      CT.NGAYHOADON ,
      CT.DIENGIAI ,
      CT.TIENTE_ID ,
      CT.TYGIA ,
      CT.GIATRI ,
      CT.TYLEVAT ,
      CT.GIATRIVAT ,
      CT.TYLECHIETKHAU ,
      CT.GIATRICHIETKHAU ,
      CTCT.GIATRITHANHTOAN AS GIATRITHANHTOAN ,
      NX.MANHANVIEN ,
      NX.TENNHANVIEN ,
      NULL AS MADONHANG ,
      CT.KHONHAP_ID ,
      NULL AS MAKHONHAP ,
      NULL AS TENKHONHAP ,
      CT.KHOXUAT_ID ,
      KX.MAKHO AS MAKHOXUAT ,
      KX.TENKHO AS TENKHOXUAT ,
      CT.TRANGTHAI ,
      CT.PHONGBAN_ID ,
      PB.MAPHONGBAN ,
      PB.TENPHONGBAN ,
      PB.COSTCENTER_ID ,
      CO.MAPHONGBAN AS COSTCENTERCODE ,
      CO.TENPHONGBAN AS COSTCENTERNAME ,
      CT.BENHVIEN_ID ,
      CT.BENHVIEN_ID AS MABENHVIEN ,
      TENBENHVIEN = @TENBENHVIEN ,
      CT.IDCHUYEN ,
      CT.BENHNHAN_ID ,
      NULL AS MAYTE ,
      CT.TENBENHNHAN AS TENBENHNHAN ,
      CT.DIENGIAI AS GHICHU ,
      NULL AS CHUYENTICHHOP_ID ,
      PV.MAPHAMVI AS PHAMVI ,
      CT.LOAICHUNGTU ,
      STATUSROW = CAST (0 AS BIT) ,
      MESSAGEROW = NULL
      ,TH.THOIGIANCHUYEN
      FROM    dbo.TT_DUOC_CHUNGTU CT
      JOIN VIEW_IDCHUYENTICHHOP TH on TH.CHUYENTICHHOP_ID = CT.IDCHUYEN
      JOIN dbo.TM_KHODUOC KX ON CT.KHOXUAT_ID = KX.KHODUOC_ID
      CROSS APPLY ( SELECT    SUM(CTCT.SOLUONGDAXUAT * SLGB.DONGIAVON) AS GIATRITHANHTOAN
      FROM      dbo.TT_DUOC_CHUNGTU_CHITIET CTCT
	  JOIN TT_DUOC_SOLONHAP_GIABAN SLGB ON CTCT.SOLONHAP_ID = SLGB.SOLONHAP_ID
      WHERE     CTCT.CHUNGTU_ID = CT.CHUNGTU_ID
      ) CTCT
      LEFT JOIN dbo.TM_NHANVIEN NX ON CT.NGUOIGIAO_ID = NX.NHANVIEN_ID
      JOIN dbo.LST_DICTIONARY MDCT ON CT.MUCDICHCHUNGTU_ID = MDCT.DICTIONARY_ID
      JOIN dbo.TM_PHONGBAN PB ON CT.PHONGBAN_ID = PB.PHONGBAN_ID
      LEFT JOIN dbo.TM_PHONGBAN CO ON PB.COSTCENTER_ID = CO.PHONGBAN_ID
      LEFT JOIN dbo.TM_PHAMVI PV ON KX.PHAMVI_ID = PV.PHAMVI_ID
      WHERE   CT.BENHVIEN_ID = '$BENHVIEN_ID$' AND CAST(CT.NGAYCHUNGTU AS DATE) BETWEEN '$TUNGAY$' AND '$DENNGAY$'
      AND CT.MUCDICHCHUNGTU_CODE = 'X03'
      AND CT.IDCHUYEN IS NOT NULL
      AND ISNULL(CTCT.GIATRITHANHTOAN,0) > 0
      <isNotEmpty prepend="AND" property="KHOXUAT_ID">
        CT.KHOXUAT_ID = '$KHOXUAT_ID$'
      </isNotEmpty>
      <isNotEmpty prepend="AND" property="NGUOIXUAT_ID">
        CT.NGUOIGIAO_ID = '$NGUOIXUAT_ID$'
      </isNotEmpty>
      <isNotEmpty prepend="AND" property="MACHUNGTU">
        CT.MACHUNGTU LIKE N'%'+#MACHUNGTU#+'%'
      </isNotEmpty>
    </statement>
    <!--Lấy danh sách chứng từ chi tiết thanh lý dược-->
    <statement id="DAO09800_GetDetailDuoc_ThanhLy" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      SELECT	  TICHHOP_ID = NULL,
      CT.CHUNGTU_ID , 
      CTCT.CHUNGTUCHITIET_ID ,
      LD.LOAIVATTU_ID ,
      LD.MALOAIDUOC ,
      LD.TENLOAIDUOC ,
      D.MADUOC ,
      TD.TENDUOC  ,
      DONVITINH = DVT.TENDONVITINH,
      DONVIQUICACH = DVTQD.TENDONVITINH ,
      GIATRIQUIDOI = DVTQD.GIATRIQUIDOI ,
      SOLUONG = CTCT.SOLUONGDAXUAT  ,
      DONGIA = GB.DONGIAVON,
      GIATRI = CTCT.SOLUONGDAXUAT * GB.DONGIAVON ,
      TYLEVAT = CTCT.TYLEVAT,
      GIATRIVAT = CTCT.GIATRIVAT ,
      TYLECHIETKHAU = CTCT.TYLECHIETKHAU ,
      GIATRICHIETKHAU = CTCT.GIATRICHIETKHAU ,
      GIATRITHANHTOAN = ISNULL(CTCT.SOLUONGDAXUAT * GB.DONGIAVON,0) ,
      CTCT.KHUYENMAI
      FROM   dbo.TT_DUOC_CHUNGTU CT
      JOIN dbo.TT_DUOC_CHUNGTU_CHITIET CTCT ON CTCT.CHUNGTU_ID = CT.CHUNGTU_ID
      JOIN dbo.TT_DUOC_SOLONHAP_GIABAN GB ON CTCT.SOLONHAP_ID = GB.SOLONHAP_ID
      JOIN dbo.TM_DUOC D ON CTCT.DUOC_ID = D.DUOC_ID
      JOIN dbo.TM_TENDUOC TD ON D.TENDUOC_ID = TD.TENDUOC_ID
      JOIN dbo.TM_LOAIDUOC LD ON D.LOAIDUOC_ID = LD.LOAIDUOC_ID
      JOIN dbo.TM_DONVITINH DVT ON D.DONVITINH_ID = DVT.DONVITINH_ID
      JOIN dbo.TM_DONVITINH DVTQD ON CTCT.DONVITINH_ID = DVTQD.DONVITINH_ID
      WHERE  CT.CHUNGTU_ID = '$CHUNGTU_ID$'
    </statement>

    <!--Lấy danh sách chứng từ xuất sử dụng-->
    <statement id="DAO09800_GetMasterXuatSuDung" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      DECLARE @TENBENHVIEN NVARCHAR(250);
      SELECT  @TENBENHVIEN = VALUE
      FROM   dbo.TM_SYS_APPSETTINGS
      WHERE  BENHVIEN_ID = '$BENHVIEN_ID$' AND CODE = 'APP_BENHVIEN_TEN';

      SELECT BTNCHECK = CAST (0 AS BIT), CT.CHUNGTU_ID ,CT.MACHUNGTU ,CT.NGAYCHUNGTU ,MAMUCDICHCHUNGTU = CT.MUCDICHCHUNGTU_CODE ,TENMUCDICHCHUNGTU = MDCT.DICTIONARY_NAME ,CT.NHACUNGCAP_ID ,MANHACUNGCAP = NULL, TENNHACUNGCAP = NULL,
      DIACHI = NULL ,MASOTHUE = NULL ,CT.MAUHOADON ,CT.SOHOADON ,CT.SOSERI ,CT.NGAYHOADON ,CT.DIENGIAI ,CT.TIENTE_ID ,CT.TYGIA ,CTCT.GIATRITHANHTOAN AS GIATRI  ,CT.TYLEVAT ,CT.GIATRIVAT ,CT.TYLECHIETKHAU ,CT.GIATRICHIETKHAU ,
      CTCT.GIATRITHANHTOAN AS GIATRITHANHTOAN ,NG.MANHANVIEN ,NG.TENNHANVIEN ,MADONHANG = NULL ,CT.KHONHAP_ID ,MAKHONHAP = NULL ,TENKHONHAP = NULL ,CT.KHOXUAT_ID ,MAKHOXUAT = KT.MAKHO ,TENKHOXUAT = KT.TENKHO ,
      CT.TRANGTHAI ,CT.PHONGBAN_ID ,PB.MAPHONGBAN ,PB.TENPHONGBAN ,PB.COSTCENTER_ID ,COSTCENTERCODE = CO.MAPHONGBAN ,COSTCENTERNAME = CO.TENPHONGBAN ,CT.BENHVIEN_ID ,MABENHVIEN = CT.BENHVIEN_ID ,
      TENBENHVIEN = @TENBENHVIEN ,CT.IDCHUYEN , BENHNHAN_ID = NULL,MAYTE = NULL ,TENBENHNHAN = NULL ,GHICHU = MDCT.DICTIONARY_NAME ,CHUYENTICHHOP_ID = NULL ,PHAMVI = PV.MAPHAMVI ,CT.LOAICHUNGTU, STATUSROW = CAST (0 AS BIT), MESSAGEROW = NULL, MAMUCDICHSUDUNG = MDSD.DICTIONARY_CODE, TENMUCDICHSUDUNG = MDSD.DICTIONARY_NAME 
      FROM   dbo.TT_DUOC_CHUNGTU CT
      CROSS APPLY(SELECT SUM(ISNULL(CTCT.SOLUONGDAXUAT * SLGB.DONGIAVON,0)) AS GIATRITHANHTOAN  FROM dbo.TT_DUOC_CHUNGTU_CHITIET CTCT JOIN TT_DUOC_SOLONHAP_GIABAN SLGB ON CTCT.SOLONHAP_ID = SLGB.SOLONHAP_ID WHERE CTCT.CHUNGTU_ID = CT.CHUNGTU_ID) CTCT
      JOIN dbo.TM_KHODUOC KT ON CT.KHOXUAT_ID = KT.KHODUOC_ID
      JOIN dbo.TM_NHANVIEN NG ON CT.NGUOIGIAO_ID = NG.NHANVIEN_ID
      JOIN dbo.LST_DICTIONARY MDCT ON CT.MUCDICHCHUNGTU_ID = MDCT.DICTIONARY_ID
      JOIN dbo.TM_PHONGBAN PB ON CT.PHONGBAN_ID = PB.PHONGBAN_ID
      LEFT JOIN dbo.TM_PHONGBAN CO ON PB.COSTCENTER_ID = CO.PHONGBAN_ID
      LEFT JOIN dbo.TM_PHAMVI PV ON KT.PHAMVI_ID = PV.PHAMVI_ID
      LEFT JOIN dbo.LST_DICTIONARY MDSD ON CT.LYDOXUATSUDUNG_ID = MDSD.DICTIONARY_ID
      WHERE CT.BENHVIEN_ID = '$BENHVIEN_ID$' AND CAST(CT.NGAYCHUNGTU AS DATE) BETWEEN '$TUNGAY$' AND '$DENNGAY$'
      AND CT.MUCDICHCHUNGTU_CODE = 'X13'
      AND CT.IDCHUYEN IS NULL
      AND MDSD.DICTIONARY_CODE != '1'
      AND ISNULL(CTCT.GIATRITHANHTOAN,0) > 0
      <isNotEmpty prepend="AND" property="KHOXUAT_ID">
        CT.KHOXUAT_ID = '$KHOXUAT_ID$'
      </isNotEmpty>
      <isNotEmpty prepend="AND" property="NGUOIXUAT_ID">
        CT.NGUOIGIAO_ID = '$NGUOIXUAT_ID$'
      </isNotEmpty>      
      <isNotEmpty prepend="AND" property="MACHUNGTU">
        CT.MACHUNGTU LIKE N'%'+#MACHUNGTU#+'%'
      </isNotEmpty>
    </statement>
    <!--Lấy danh sách chứng từ xuất sử dụng-->
    <statement id="DAO09800_GetMasterXuatSuDung_DACHUYEN" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      DECLARE @TENBENHVIEN NVARCHAR(250);
      SELECT  @TENBENHVIEN = VALUE
      FROM   dbo.TM_SYS_APPSETTINGS
      WHERE  BENHVIEN_ID = '$BENHVIEN_ID$' AND CODE = 'APP_BENHVIEN_TEN';

      SELECT BTNCHECK = CAST (0 AS BIT), CT.CHUNGTU_ID ,CT.MACHUNGTU ,CT.NGAYCHUNGTU ,MAMUCDICHCHUNGTU = CT.MUCDICHCHUNGTU_CODE ,TENMUCDICHCHUNGTU = MDCT.DICTIONARY_NAME ,CT.NHACUNGCAP_ID ,MANHACUNGCAP = NULL, TENNHACUNGCAP = NULL,
      DIACHI = NULL ,MASOTHUE = NULL ,CT.MAUHOADON ,CT.SOHOADON ,CT.SOSERI ,CT.NGAYHOADON ,CT.DIENGIAI ,CT.TIENTE_ID ,CT.TYGIA ,CTCT.GIATRITHANHTOAN AS GIATRI  ,CT.TYLEVAT ,CT.GIATRIVAT ,CT.TYLECHIETKHAU ,CT.GIATRICHIETKHAU ,
      CTCT.GIATRITHANHTOAN AS GIATRITHANHTOAN ,NG.MANHANVIEN ,NG.TENNHANVIEN ,MADONHANG = NULL ,CT.KHONHAP_ID ,MAKHONHAP = NULL ,TENKHONHAP = NULL ,CT.KHOXUAT_ID ,MAKHOXUAT = KT.MAKHO ,TENKHOXUAT = KT.TENKHO ,
      CT.TRANGTHAI ,CT.PHONGBAN_ID ,PB.MAPHONGBAN ,PB.TENPHONGBAN ,PB.COSTCENTER_ID ,COSTCENTERCODE = CO.MAPHONGBAN ,COSTCENTERNAME = CO.TENPHONGBAN ,CT.BENHVIEN_ID ,MABENHVIEN = CT.BENHVIEN_ID ,
      TENBENHVIEN = @TENBENHVIEN ,CT.IDCHUYEN ,BENHNHAN_ID = NULL,MAYTE = NULL ,TENBENHNHAN = NULL ,GHICHU = MDCT.DICTIONARY_NAME ,CHUYENTICHHOP_ID = NULL ,PHAMVI = PV.MAPHAMVI ,CT.LOAICHUNGTU, STATUSROW = CAST (0 AS BIT), MESSAGEROW = NULL, MAMUCDICHSUDUNG = MDSD.DICTIONARY_CODE, TENMUCDICHSUDUNG = MDSD.DICTIONARY_NAME 
      ,TH.THOIGIANCHUYEN
      FROM   dbo.TT_DUOC_CHUNGTU CT
      JOIN VIEW_IDCHUYENTICHHOP TH on TH.CHUYENTICHHOP_ID = CT.IDCHUYEN
      CROSS APPLY(SELECT SUM(ISNULL(CTCT.SOLUONGDAXUAT * SLGB.DONGIAVON,0)) AS GIATRITHANHTOAN  FROM dbo.TT_DUOC_CHUNGTU_CHITIET CTCT JOIN TT_DUOC_SOLONHAP_GIABAN SLGB ON CTCT.SOLONHAP_ID = SLGB.SOLONHAP_ID WHERE CTCT.CHUNGTU_ID = CT.CHUNGTU_ID) CTCT
      JOIN dbo.TM_KHODUOC KT ON CT.KHOXUAT_ID = KT.KHODUOC_ID
      JOIN dbo.TM_NHANVIEN NG ON CT.NGUOIGIAO_ID = NG.NHANVIEN_ID
      JOIN dbo.LST_DICTIONARY MDCT ON CT.MUCDICHCHUNGTU_ID = MDCT.DICTIONARY_ID
      JOIN dbo.TM_PHONGBAN PB ON CT.PHONGBAN_ID = PB.PHONGBAN_ID
      LEFT JOIN dbo.TM_PHONGBAN CO ON PB.COSTCENTER_ID = CO.PHONGBAN_ID
      LEFT JOIN dbo.TM_PHAMVI PV ON KT.PHAMVI_ID = PV.PHAMVI_ID
      LEFT JOIN dbo.LST_DICTIONARY MDSD ON CT.LYDOXUATSUDUNG_ID = MDSD.DICTIONARY_ID
      WHERE CT.BENHVIEN_ID = '$BENHVIEN_ID$' AND CAST(CT.NGAYCHUNGTU AS DATE) BETWEEN '$TUNGAY$' AND '$DENNGAY$'
      AND CT.MUCDICHCHUNGTU_CODE = 'X13'
      AND CT.IDCHUYEN IS NOT NULL
      AND MDSD.DICTIONARY_CODE != '1'
      AND ISNULL(CTCT.GIATRITHANHTOAN,0) > 0
      <isNotEmpty prepend="AND" property="KHOXUAT_ID">
        CT.KHOXUAT_ID = '$KHOXUAT_ID$'
      </isNotEmpty>
      <isNotEmpty prepend="AND" property="NGUOIXUAT_ID">
        CT.NGUOIGIAO_ID = '$NGUOIXUAT_ID$'
      </isNotEmpty>      
      <isNotEmpty prepend="AND" property="MACHUNGTU">
        CT.MACHUNGTU LIKE N'%'+#MACHUNGTU#+'%'
      </isNotEmpty>
    </statement>
    <!--Lấy chi tiết chứng từ chi tiết xuất sử dụng-->
    <statement id="DAO09800_GetDetailXuatSuDung" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      SELECT	  TICHHOP_ID = NULL,CT.CHUNGTU_ID , CTCT.CHUNGTUCHITIET_ID,LD.LOAIVATTU_ID ,LD.MALOAIDUOC ,LD.TENLOAIDUOC ,D.MADUOC ,TD.TENDUOC  ,DONVITINH = DVT.TENDONVITINH,DONVIQUICACH = DVTQD.TENDONVITINH ,
      GIATRIQUIDOI = DVTQD.GIATRIQUIDOI ,SOLUONG = CTCT.SOLUONGDAXUAT  ,DONGIA = GB.DONGIAVON,GIATRI = ISNULL(CTCT.SOLUONGDAXUAT * GB.DONGIAVON,0) ,TYLEVAT = CTCT.TYLEVAT,GIATRIVAT = CTCT.GIATRIVAT ,
      TYLECHIETKHAU = CTCT.TYLECHIETKHAU ,GIATRICHIETKHAU = CTCT.GIATRICHIETKHAU ,GIATRITHANHTOAN = ISNULL(CTCT.SOLUONGDAXUAT * GB.DONGIAVON,0),CTCT.KHUYENMAI
      FROM   dbo.TT_DUOC_CHUNGTU CT
      JOIN dbo.TT_DUOC_CHUNGTU_CHITIET CTCT ON CTCT.CHUNGTU_ID = CT.CHUNGTU_ID
	  JOIN TT_DUOC_SOLONHAP_GIABAN GB ON CTCT.SOLONHAP_ID = GB.SOLONHAP_ID
      JOIN dbo.TM_DUOC D ON CTCT.DUOC_ID = D.DUOC_ID
      JOIN dbo.TM_TENDUOC TD ON D.TENDUOC_ID = TD.TENDUOC_ID
      JOIN dbo.TM_LOAIDUOC LD ON D.LOAIDUOC_ID = LD.LOAIDUOC_ID
      LEFT JOIN dbo.TM_DONVITINH DVT ON D.DONVITINH_ID = DVT.DONVITINH_ID
      LEFT JOIN dbo.TM_DONVITINH DVTQD ON CTCT.DONVITINH_ID = DVTQD.DONVITINH_ID
      WHERE  CT.CHUNGTU_ID = '$CHUNGTU_ID$'
    </statement>

    <!--Lấy danh sách chứng từ xuất bệnh nhân-->
    <statement id="DAO09800_GetMasterXuatBenhNhan" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      DECLARE @TENBENHVIEN NVARCHAR(250);
      SELECT  @TENBENHVIEN = VALUE
      FROM   dbo.TM_SYS_APPSETTINGS
      WHERE  BENHVIEN_ID = '$BENHVIEN_ID$' AND CODE = 'APP_BENHVIEN_TEN';

      SELECT BTNCHECK = CAST (0 AS BIT), CT.CHUNGTU_ID ,CT.MACHUNGTU ,CT.NGAYCHUNGTU ,MAMUCDICHCHUNGTU = CT.MUCDICHCHUNGTU_CODE ,TENMUCDICHCHUNGTU = MDCT.DICTIONARY_NAME ,CT.NHACUNGCAP_ID ,MANHACUNGCAP = NULL, TENNHACUNGCAP = NULL,
      DIACHI = NULL ,MASOTHUE = NULL ,CT.MAUHOADON ,CT.SOHOADON ,CT.SOSERI ,CT.NGAYHOADON ,CT.DIENGIAI ,CT.TIENTE_ID ,CT.TYGIA ,CTCT.GIATRI AS GIATRI  ,CT.TYLEVAT ,CT.GIATRIVAT ,CT.TYLECHIETKHAU ,CT.GIATRICHIETKHAU ,
      CTCT.GIATRITHANHTOAN AS GIATRITHANHTOAN ,NG.MANHANVIEN ,NG.TENNHANVIEN ,MADONHANG = NULL ,CT.KHONHAP_ID ,MAKHONHAP = NULL ,TENKHONHAP = NULL ,CT.KHOXUAT_ID ,MAKHOXUAT = KT.MAKHO ,TENKHOXUAT = KT.TENKHO ,
      CT.TRANGTHAI ,CT.PHONGBAN_ID ,PB.MAPHONGBAN ,PB.TENPHONGBAN ,PB.COSTCENTER_ID ,COSTCENTERCODE = CO.MAPHONGBAN ,COSTCENTERNAME = CO.TENPHONGBAN ,CT.BENHVIEN_ID ,MABENHVIEN = CT.BENHVIEN_ID ,
      TENBENHVIEN = @TENBENHVIEN ,CT.IDCHUYEN ,TTBN.BENHNHAN_ID ,MAYTE = TTBN.MAYTE ,TENBENHNHAN = TTBN.TENBENHNHAN ,GHICHU = PB.TENPHONGBAN + ' - ' + TTBN.TENBENHNHAN + ' - ' + TTBN.MAYTE + ' - ' + CONVERT(NVARCHAR, TTBN.NGAYSINH, 103) ,CHUYENTICHHOP_ID = NULL ,PHAMVI = PV.MAPHAMVI ,CT.LOAICHUNGTU, STATUSROW = CAST (0 AS BIT), MESSAGEROW = NULL, MAMUCDICHSUDUNG = MDSD.DICTIONARY_CODE, TENMUCDICHSUDUNG = MDSD.DICTIONARY_NAME
      FROM   dbo.TT_DUOC_CHUNGTU CT
      CROSS APPLY ( SELECT    SUM(ISNULL(SLGB.DONGIAVON, 0) * A.SOLUONGDAXUAT) AS GIATRITHANHTOAN, SUM(ISNULL(SLGB.DONGIAVON, 0) * A.SOLUONGDAXUAT) AS GIATRI
      FROM      dbo.TT_DUOC_CHUNGTU_CHITIET A
	  JOIN TT_DUOC_SOLONHAP_GIABAN SLGB ON A.SOLONHAP_ID = SLGB.SOLONHAP_ID
      WHERE     CHUNGTU_ID = CT.CHUNGTU_ID
      ) CTCT
      OUTER APPLY ( SELECT TOP 1
      BN.BENHNHAN_ID ,
      BN.MAYTE ,
      BN.TENBENHNHAN ,
	    BN.NGAYSINH
      FROM      dbo.TT_NOITRU_TOATHUOC TT
      JOIN dbo.TT_NOITRU_KHAMBENH KB ON KB.KHAMBENH_ID = TT.KHAMBENH_ID
      JOIN TT_NOITRU_BENHAN BA ON BA.BENHAN_ID = KB.BENHAN_ID
      JOIN dbo.TT_BENHNHAN BN ON BN.BENHNHAN_ID = BA.BENHNHAN_ID
      WHERE     TT.CHUNGTU_ID = CT.CHUNGTU_ID
      UNION
      SELECT TOP 1
      BN.BENHNHAN_ID ,
      BN.MAYTE ,
      BN.TENBENHNHAN ,
	    BN.NGAYSINH
      FROM      dbo.TT_NGOAITRU_TOATHUOC TT
      JOIN dbo.TT_NGOAITRU_KHAMBENH_TOATHUOC KBTT ON KBTT.KHAMBENH_TOATHUOC_ID = TT.KHAMBENH_TOATHUOC_ID
      JOIN dbo.TT_NGOAITRU_KHAMBENH KB ON KB.KHAMBENH_ID = KBTT.KHAMBENH_ID
      JOIN dbo.TT_TIEPNHAN TN ON TN.TIEPNHAN_ID = KB.TIEPNHAN_ID
      JOIN dbo.TT_BENHNHAN BN ON BN.BENHNHAN_ID = TN.BENHNHAN_ID
      WHERE     KBTT.CHUNGTUPHATTHUOC_ID = CT.CHUNGTU_ID
      UNION
      SELECT TOP 1
      BN.BENHNHAN_ID ,
      BN.MAYTE ,
      BN.TENBENHNHAN ,
	    BN.NGAYSINH
      FROM      dbo.TT_NGOAITRU_KHAMBENH_VTYT VTYT
      JOIN dbo.TT_NGOAITRU_KHAMBENH KB ON KB.KHAMBENH_ID = VTYT.KHAMBENH_ID
      JOIN dbo.TT_TIEPNHAN TN ON TN.TIEPNHAN_ID = KB.TIEPNHAN_ID
      JOIN dbo.TT_BENHNHAN BN ON BN.BENHNHAN_ID = TN.BENHNHAN_ID
      WHERE     VTYT.CHUNGTU_ID = CT.CHUNGTU_ID
      UNION
      SELECT TOP 1
      BN.BENHNHAN_ID ,
      BN.MAYTE ,
      BN.TENBENHNHAN ,
	    BN.NGAYSINH
      FROM      dbo.TT_PHAUTHUAT_VTYT VTYT
      JOIN dbo.TT_PHAUTHUAT PT ON PT.PHAUTHUAT_ID = VTYT.PHAUTHUAT_ID
      LEFT JOIN dbo.TT_NOITRU_BENHAN BA ON PT.BENHAN_ID = BA.BENHAN_ID AND PT.BENHAN_ID IS NOT NULL
      LEFT JOIN dbo.TT_TIEPNHAN TN ON PT.TIEPNHAN_ID = TN.TIEPNHAN_ID AND PT.BENHAN_ID IS NULL
      JOIN dbo.TT_BENHNHAN BN ON BN.BENHNHAN_ID = ISNULL(BA.BENHNHAN_ID, TN.BENHNHAN_ID)
      WHERE     VTYT.CHUNGTU_ID = CT.CHUNGTU_ID
      UNION
      SELECT TOP 1
      BN.BENHNHAN_ID ,
      BN.MAYTE ,
      BN.TENBENHNHAN ,
	    BN.NGAYSINH
      FROM      dbo.TT_CLSKETQUA_VTYT VTYT
      JOIN TT_DVYEUCAU YC on VTYT.DVYeuCau_ID = YC.DVYeuCau_ID
      LEFT JOIN dbo.TT_NOITRU_BENHAN BA ON YC.BENHAN_ID = BA.BENHAN_ID AND YC.BENHAN_ID IS NOT NULL
      LEFT JOIN dbo.TT_TIEPNHAN TN ON YC.TIEPNHAN_ID = TN.TIEPNHAN_ID AND YC.BENHAN_ID IS NULL
      JOIN dbo.TT_BENHNHAN BN ON BN.BENHNHAN_ID = ISNULL(BA.BENHNHAN_ID, TN.BENHNHAN_ID)
      WHERE     VTYT.CHUNGTU_ID = CT.CHUNGTU_ID
      ) TTBN
      JOIN dbo.TM_KHODUOC KT ON CT.KHOXUAT_ID = KT.KHODUOC_ID
      JOIN dbo.TM_NHANVIEN NG ON CT.NGUOIGIAO_ID = NG.NHANVIEN_ID
      JOIN dbo.LST_DICTIONARY MDCT ON CT.MUCDICHCHUNGTU_ID = MDCT.DICTIONARY_ID
      JOIN dbo.TM_PHONGBAN PB ON CT.PHONGBAN_ID = PB.PHONGBAN_ID
      LEFT JOIN dbo.TM_PHONGBAN CO ON PB.COSTCENTER_ID = CO.PHONGBAN_ID
      LEFT JOIN dbo.TM_PHAMVI PV ON KT.PHAMVI_ID = PV.PHAMVI_ID
      LEFT JOIN dbo.LST_DICTIONARY MDSD ON CT.LYDOXUATSUDUNG_ID = MDSD.DICTIONARY_ID
      WHERE CT.BENHVIEN_ID = '$BENHVIEN_ID$' AND CAST(CT.NGAYCHUNGTU AS DATE) BETWEEN '$TUNGAY$' AND '$DENNGAY$'
      AND CT.MUCDICHCHUNGTU_CODE = 'X13'
      AND CT.IDCHUYEN IS NULL
      AND MDSD.DICTIONARY_CODE = '1'
      AND ISNULL(CTCT.GIATRITHANHTOAN,0) > 0
      <isNotEmpty prepend="AND" property="KHOXUAT_ID">
        CT.KHOXUAT_ID = '$KHOXUAT_ID$'
      </isNotEmpty>
      <isNotEmpty prepend="AND" property="NGUOIXUAT_ID">
        CT.NGUOIGIAO_ID = '$NGUOIXUAT_ID$'
      </isNotEmpty>
      <isNotEmpty prepend="AND" property="TENBENHNHAN">
        TTBN.TENBENHNHAN LIKE N'%'+#TENBENHNHAN#+'%'
      </isNotEmpty>
      <isNotEmpty prepend="AND" property="MACHUNGTU">
        CT.MACHUNGTU LIKE N'%'+#MACHUNGTU#+'%'
      </isNotEmpty>
    
      UNION
      SELECT BTNCHECK = CAST (0 AS BIT), CT.CHUNGTU_ID ,CT.MACHUNGTU ,CT.NGAYCHUNGTU ,MAMUCDICHCHUNGTU = CT.MUCDICHCHUNGTU_CODE ,TENMUCDICHCHUNGTU = MDCT.DICTIONARY_NAME ,CT.NHACUNGCAP_ID ,MANHACUNGCAP = NULL, TENNHACUNGCAP = NULL,
      DIACHI = NULL ,MASOTHUE = NULL ,CT.MAUHOADON ,CT.SOHOADON ,CT.SOSERI ,CT.NGAYHOADON ,CT.DIENGIAI ,CT.TIENTE_ID ,CT.TYGIA ,CTCT.GIATRI AS GIATRI  ,CT.TYLEVAT ,CT.GIATRIVAT ,CT.TYLECHIETKHAU ,CT.GIATRICHIETKHAU ,
      CTCT.GIATRITHANHTOAN AS GIATRITHANHTOAN ,NG.MANHANVIEN ,NG.TENNHANVIEN ,MADONHANG = NULL ,CT.KHONHAP_ID ,MAKHONHAP = NULL ,TENKHONHAP = NULL ,CT.KHOXUAT_ID ,MAKHOXUAT = KT.MAKHO ,TENKHOXUAT = KT.TENKHO ,
      CT.TRANGTHAI ,CT.PHONGBAN_ID ,PB.MAPHONGBAN ,PB.TENPHONGBAN ,PB.COSTCENTER_ID ,COSTCENTERCODE = CO.MAPHONGBAN ,COSTCENTERNAME = CO.TENPHONGBAN ,CT.BENHVIEN_ID ,MABENHVIEN = CT.BENHVIEN_ID ,
      TENBENHVIEN = @TENBENHVIEN ,CT.IDCHUYEN ,TTBN.BENHNHAN_ID ,MAYTE = TTBN.MAYTE ,TENBENHNHAN = TTBN.TENBENHNHAN ,GHICHU = PB.TENPHONGBAN + ' - ' + TTBN.TENBENHNHAN + ' - ' + TTBN.MAYTE + ' - ' + CONVERT(NVARCHAR, TTBN.NGAYSINH, 103) ,CHUYENTICHHOP_ID = NULL ,PHAMVI = PV.MAPHAMVI ,CT.LOAICHUNGTU, STATUSROW = CAST (0 AS BIT), MESSAGEROW = NULL, MAMUCDICHSUDUNG = MDSD.DICTIONARY_CODE, TENMUCDICHSUDUNG = MDSD.DICTIONARY_NAME
      FROM   dbo.TT_DUOC_CHUNGTU CT
      CROSS APPLY ( SELECT    SUM(ISNULL(SLGB.DONGIAVON, 0) * A.SOLUONGDAXUAT) AS GIATRITHANHTOAN, SUM(ISNULL(SLGB.DONGIAVON, 0) * A.SOLUONGDAXUAT) AS GIATRI
      FROM      dbo.TT_DUOC_CHUNGTU_CHITIET A
	  JOIN TT_DUOC_SOLONHAP_GIABAN SLGB ON A.SOLONHAP_ID = SLGB.SOLONHAP_ID
      WHERE     CHUNGTU_ID = CT.CHUNGTU_ID
      ) CTCT
      OUTER APPLY ( SELECT TOP 1
      BN.BENHNHAN_ID ,
      BN.MAYTE ,
      BN.TENBENHNHAN ,
	    BN.NGAYSINH
      FROM      dbo.TT_NGOAITRU_KHAMBENH_TOATHUOC KBTT
		JOIN dbo.TT_NGOAITRU_KHAMBENH KB ON KB.KHAMBENH_ID = KBTT.KHAMBENH_ID
		JOIN dbo.TT_BENHNHAN BN ON BN.BENHNHAN_ID = KB.BENHNHAN_ID
		WHERE     KBTT.CHUNGTUPHATTHUOC_ID = CT.CHUNGTU_ID
      ) TTBN
      JOIN dbo.TM_KHODUOC KT ON CT.KHOXUAT_ID = KT.KHODUOC_ID
      JOIN dbo.TM_NHANVIEN NG ON CT.NGUOIGIAO_ID = NG.NHANVIEN_ID
      JOIN dbo.LST_DICTIONARY MDCT ON CT.MUCDICHCHUNGTU_ID = MDCT.DICTIONARY_ID
      JOIN dbo.TM_PHONGBAN PB ON CT.PHONGBAN_ID = PB.PHONGBAN_ID
      LEFT JOIN dbo.TM_PHONGBAN CO ON PB.COSTCENTER_ID = CO.PHONGBAN_ID
      LEFT JOIN dbo.TM_PHAMVI PV ON KT.PHAMVI_ID = PV.PHAMVI_ID
      LEFT JOIN dbo.LST_DICTIONARY MDSD ON CT.LYDOXUATSUDUNG_ID = MDSD.DICTIONARY_ID
      WHERE CT.BENHVIEN_ID = '$BENHVIEN_ID$' AND CAST(CT.NGAYCHUNGTU AS DATE) BETWEEN '$TUNGAY$' AND '$DENNGAY$'
      AND CT.MUCDICHCHUNGTU_CODE = 'X14'
      AND CT.IDCHUYEN IS NULL
      AND ISNULL(CTCT.GIATRITHANHTOAN,0) > 0
      <isNotEmpty prepend="AND" property="KHOXUAT_ID">
        CT.KHOXUAT_ID = '$KHOXUAT_ID$'
      </isNotEmpty>
      <isNotEmpty prepend="AND" property="NGUOIXUAT_ID">
        CT.NGUOIGIAO_ID = '$NGUOIXUAT_ID$'
      </isNotEmpty>
      <isNotEmpty prepend="AND" property="TENBENHNHAN">
        TTBN.TENBENHNHAN LIKE N'%'+#TENBENHNHAN#+'%'
      </isNotEmpty>
      <isNotEmpty prepend="AND" property="MACHUNGTU">
        CT.MACHUNGTU LIKE N'%'+#MACHUNGTU#+'%'
      </isNotEmpty>
    </statement>
    <!--Lấy danh sách chứng từ xuất bệnh nhân đã chuyển-->
    <statement id="DAO09800_GetMasterXuatBenhNhan_DACHUYEN" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      DECLARE @TENBENHVIEN NVARCHAR(250);
      SELECT  @TENBENHVIEN = VALUE
      FROM   dbo.TM_SYS_APPSETTINGS
      WHERE  BENHVIEN_ID = '$BENHVIEN_ID$' AND CODE = 'APP_BENHVIEN_TEN';

      SELECT BTNCHECK = CAST (0 AS BIT), CT.CHUNGTU_ID ,CT.MACHUNGTU ,CT.NGAYCHUNGTU ,MAMUCDICHCHUNGTU = CT.MUCDICHCHUNGTU_CODE ,TENMUCDICHCHUNGTU = MDCT.DICTIONARY_NAME ,CT.NHACUNGCAP_ID ,MANHACUNGCAP = NULL, TENNHACUNGCAP = NULL,
      DIACHI = NULL ,MASOTHUE = NULL ,CT.MAUHOADON ,CT.SOHOADON ,CT.SOSERI ,CT.NGAYHOADON ,CT.DIENGIAI ,CT.TIENTE_ID ,CT.TYGIA ,CTCT.GIATRI AS GIATRI  ,CT.TYLEVAT ,CT.GIATRIVAT ,CT.TYLECHIETKHAU ,CT.GIATRICHIETKHAU ,
      CTCT.GIATRITHANHTOAN AS GIATRITHANHTOAN ,NG.MANHANVIEN ,NG.TENNHANVIEN ,MADONHANG = NULL ,CT.KHONHAP_ID ,MAKHONHAP = NULL ,TENKHONHAP = NULL ,CT.KHOXUAT_ID ,MAKHOXUAT = KT.MAKHO ,TENKHOXUAT = KT.TENKHO ,
      CT.TRANGTHAI ,CT.PHONGBAN_ID ,PB.MAPHONGBAN ,PB.TENPHONGBAN ,PB.COSTCENTER_ID ,COSTCENTERCODE = CO.MAPHONGBAN ,COSTCENTERNAME = CO.TENPHONGBAN ,CT.BENHVIEN_ID ,MABENHVIEN = CT.BENHVIEN_ID ,
      TENBENHVIEN = @TENBENHVIEN ,CT.IDCHUYEN ,TTBN.BENHNHAN_ID ,MAYTE = TTBN.MAYTE ,TENBENHNHAN = TTBN.TENBENHNHAN ,GHICHU = PB.TENPHONGBAN + ' - ' + TTBN.TENBENHNHAN + ' - ' + TTBN.MAYTE + ' - ' + CONVERT(NVARCHAR, TTBN.NGAYSINH, 103) ,CHUYENTICHHOP_ID = NULL ,PHAMVI = PV.MAPHAMVI ,CT.LOAICHUNGTU, STATUSROW = CAST (0 AS BIT), MESSAGEROW = NULL, MAMUCDICHSUDUNG = MDSD.DICTIONARY_CODE, TENMUCDICHSUDUNG = MDSD.DICTIONARY_NAME 
      ,TH.THOIGIANCHUYEN
      FROM   dbo.TT_DUOC_CHUNGTU CT
      JOIN VIEW_IDCHUYENTICHHOP TH on TH.CHUYENTICHHOP_ID = CT.IDCHUYEN
      CROSS APPLY ( SELECT    SUM(ISNULL(SLGB.DONGIAVON, 0) * A.SOLUONGDAXUAT) AS GIATRITHANHTOAN, SUM(ISNULL(SLGB.DONGIAVON, 0) * A.SOLUONGDAXUAT) AS GIATRI
      FROM      dbo.TT_DUOC_CHUNGTU_CHITIET A
	  JOIN TT_DUOC_SOLONHAP_GIABAN SLGB ON A.SOLONHAP_ID = SLGB.SOLONHAP_ID
      WHERE     CHUNGTU_ID = CT.CHUNGTU_ID
      ) CTCT
      OUTER APPLY ( SELECT TOP 1
      BN.BENHNHAN_ID ,
      BN.MAYTE ,
      BN.TENBENHNHAN ,
	    BN.NGAYSINH
      FROM      dbo.TT_NOITRU_TOATHUOC TT
      JOIN dbo.TT_NOITRU_KHAMBENH KB ON KB.KHAMBENH_ID = TT.KHAMBENH_ID
      JOIN TT_NOITRU_BENHAN BA ON BA.BENHAN_ID = KB.BENHAN_ID
      JOIN dbo.TT_BENHNHAN BN ON BN.BENHNHAN_ID = BA.BENHNHAN_ID
      WHERE     TT.CHUNGTU_ID = CT.CHUNGTU_ID
      UNION
      SELECT TOP 1
      BN.BENHNHAN_ID ,
      BN.MAYTE ,
      BN.TENBENHNHAN ,
	    BN.NGAYSINH
      FROM      dbo.TT_NGOAITRU_TOATHUOC TT
      JOIN dbo.TT_NGOAITRU_KHAMBENH_TOATHUOC KBTT ON KBTT.KHAMBENH_TOATHUOC_ID = TT.KHAMBENH_TOATHUOC_ID
      JOIN dbo.TT_NGOAITRU_KHAMBENH KB ON KB.KHAMBENH_ID = KBTT.KHAMBENH_ID
      JOIN dbo.TT_TIEPNHAN TN ON TN.TIEPNHAN_ID = KB.TIEPNHAN_ID
      JOIN dbo.TT_BENHNHAN BN ON BN.BENHNHAN_ID = TN.BENHNHAN_ID
      WHERE     KBTT.CHUNGTUPHATTHUOC_ID = CT.CHUNGTU_ID
      UNION
      SELECT TOP 1
      BN.BENHNHAN_ID ,
      BN.MAYTE ,
      BN.TENBENHNHAN ,
	    BN.NGAYSINH
      FROM      dbo.TT_NGOAITRU_KHAMBENH_VTYT VTYT
      JOIN dbo.TT_NGOAITRU_KHAMBENH KB ON KB.KHAMBENH_ID = VTYT.KHAMBENH_ID
      JOIN dbo.TT_TIEPNHAN TN ON TN.TIEPNHAN_ID = KB.TIEPNHAN_ID
      JOIN dbo.TT_BENHNHAN BN ON BN.BENHNHAN_ID = TN.BENHNHAN_ID
      WHERE     VTYT.CHUNGTU_ID = CT.CHUNGTU_ID
      UNION
      SELECT TOP 1
      BN.BENHNHAN_ID ,
      BN.MAYTE ,
      BN.TENBENHNHAN ,
	    BN.NGAYSINH
      FROM      dbo.TT_PHAUTHUAT_VTYT VTYT
      JOIN dbo.TT_PHAUTHUAT PT ON PT.PHAUTHUAT_ID = VTYT.PHAUTHUAT_ID
      LEFT JOIN dbo.TT_NOITRU_BENHAN BA ON PT.BENHAN_ID = BA.BENHAN_ID AND PT.BENHAN_ID IS NOT NULL
      LEFT JOIN dbo.TT_TIEPNHAN TN ON PT.TIEPNHAN_ID = TN.TIEPNHAN_ID AND PT.BENHAN_ID IS NULL
      JOIN dbo.TT_BENHNHAN BN ON BN.BENHNHAN_ID = ISNULL(BA.BENHNHAN_ID, TN.BENHNHAN_ID)
      WHERE     VTYT.CHUNGTU_ID = CT.CHUNGTU_ID
      UNION
      SELECT TOP 1
      BN.BENHNHAN_ID ,
      BN.MAYTE ,
      BN.TENBENHNHAN ,
	    BN.NGAYSINH
      FROM      dbo.TT_CLSKETQUA_VTYT VTYT
      JOIN TT_DVYEUCAU YC on VTYT.DVYeuCau_ID = YC.DVYeuCau_ID
      LEFT JOIN dbo.TT_NOITRU_BENHAN BA ON YC.BENHAN_ID = BA.BENHAN_ID AND YC.BENHAN_ID IS NOT NULL
      LEFT JOIN dbo.TT_TIEPNHAN TN ON YC.TIEPNHAN_ID = TN.TIEPNHAN_ID AND YC.BENHAN_ID IS NULL
      JOIN dbo.TT_BENHNHAN BN ON BN.BENHNHAN_ID = ISNULL(BA.BENHNHAN_ID, TN.BENHNHAN_ID)
      WHERE     VTYT.CHUNGTU_ID = CT.CHUNGTU_ID
      ) TTBN
      JOIN dbo.TM_KHODUOC KT ON CT.KHOXUAT_ID = KT.KHODUOC_ID
      JOIN dbo.TM_NHANVIEN NG ON CT.NGUOIGIAO_ID = NG.NHANVIEN_ID
      JOIN dbo.LST_DICTIONARY MDCT ON CT.MUCDICHCHUNGTU_ID = MDCT.DICTIONARY_ID
      JOIN dbo.TM_PHONGBAN PB ON CT.PHONGBAN_ID = PB.PHONGBAN_ID
      LEFT JOIN dbo.TM_PHONGBAN CO ON PB.COSTCENTER_ID = CO.PHONGBAN_ID
      LEFT JOIN dbo.TM_PHAMVI PV ON KT.PHAMVI_ID = PV.PHAMVI_ID
      LEFT JOIN dbo.LST_DICTIONARY MDSD ON CT.LYDOXUATSUDUNG_ID = MDSD.DICTIONARY_ID
      WHERE CT.BENHVIEN_ID = '$BENHVIEN_ID$' AND CAST(CT.NGAYCHUNGTU AS DATE) BETWEEN '$TUNGAY$' AND '$DENNGAY$'
      AND CT.MUCDICHCHUNGTU_CODE = 'X13'
      AND CT.IDCHUYEN IS NOT NULL
      AND MDSD.DICTIONARY_CODE = '1'
      AND ISNULL(CTCT.GIATRITHANHTOAN,0) > 0
      <isNotEmpty prepend="AND" property="KHOXUAT_ID">
        CT.KHOXUAT_ID = '$KHOXUAT_ID$'
      </isNotEmpty>
      <isNotEmpty prepend="AND" property="NGUOIXUAT_ID">
        CT.NGUOIGIAO_ID = '$NGUOIXUAT_ID$'
      </isNotEmpty>
      <isNotEmpty prepend="AND" property="TENBENHNHAN">
        TTBN.TENBENHNHAN LIKE N'%'+#TENBENHNHAN#+'%'
      </isNotEmpty>
      <isNotEmpty prepend="AND" property="MACHUNGTU">
        CT.MACHUNGTU LIKE N'%'+#MACHUNGTU#+'%'
      </isNotEmpty>

      UNION
      SELECT BTNCHECK = CAST (0 AS BIT), CT.CHUNGTU_ID ,CT.MACHUNGTU ,CT.NGAYCHUNGTU ,MAMUCDICHCHUNGTU = CT.MUCDICHCHUNGTU_CODE ,TENMUCDICHCHUNGTU = MDCT.DICTIONARY_NAME ,CT.NHACUNGCAP_ID ,MANHACUNGCAP = NULL, TENNHACUNGCAP = NULL,
      DIACHI = NULL ,MASOTHUE = NULL ,CT.MAUHOADON ,CT.SOHOADON ,CT.SOSERI ,CT.NGAYHOADON ,CT.DIENGIAI ,CT.TIENTE_ID ,CT.TYGIA ,CTCT.GIATRI AS GIATRI  ,CT.TYLEVAT ,CT.GIATRIVAT ,CT.TYLECHIETKHAU ,CT.GIATRICHIETKHAU ,
      CTCT.GIATRITHANHTOAN AS GIATRITHANHTOAN ,NG.MANHANVIEN ,NG.TENNHANVIEN ,MADONHANG = NULL ,CT.KHONHAP_ID ,MAKHONHAP = NULL ,TENKHONHAP = NULL ,CT.KHOXUAT_ID ,MAKHOXUAT = KT.MAKHO ,TENKHOXUAT = KT.TENKHO ,
      CT.TRANGTHAI ,CT.PHONGBAN_ID ,PB.MAPHONGBAN ,PB.TENPHONGBAN ,PB.COSTCENTER_ID ,COSTCENTERCODE = CO.MAPHONGBAN ,COSTCENTERNAME = CO.TENPHONGBAN ,CT.BENHVIEN_ID ,MABENHVIEN = CT.BENHVIEN_ID ,
      TENBENHVIEN = @TENBENHVIEN ,CT.IDCHUYEN ,TTBN.BENHNHAN_ID ,MAYTE = TTBN.MAYTE ,TENBENHNHAN = TTBN.TENBENHNHAN ,GHICHU = PB.TENPHONGBAN + ' - ' + TTBN.TENBENHNHAN + ' - ' + TTBN.MAYTE + ' - ' + CONVERT(NVARCHAR, TTBN.NGAYSINH, 103) ,CHUYENTICHHOP_ID = NULL ,PHAMVI = PV.MAPHAMVI ,CT.LOAICHUNGTU, STATUSROW = CAST (0 AS BIT), MESSAGEROW = NULL, MAMUCDICHSUDUNG = MDSD.DICTIONARY_CODE, TENMUCDICHSUDUNG = MDSD.DICTIONARY_NAME
	  ,TH.THOIGIANCHUYEN
      FROM   dbo.TT_DUOC_CHUNGTU CT
	  JOIN VIEW_IDCHUYENTICHHOP TH on TH.CHUYENTICHHOP_ID = CT.IDCHUYEN
      CROSS APPLY ( SELECT    SUM(ISNULL(SLGB.DONGIAVON, 0) * A.SOLUONGDAXUAT) AS GIATRITHANHTOAN, SUM(ISNULL(SLGB.DONGIAVON, 0) * A.SOLUONGDAXUAT) AS GIATRI
      FROM      dbo.TT_DUOC_CHUNGTU_CHITIET A
	  JOIN TT_DUOC_SOLONHAP_GIABAN SLGB ON A.SOLONHAP_ID = SLGB.SOLONHAP_ID
      WHERE     CHUNGTU_ID = CT.CHUNGTU_ID
      ) CTCT
      OUTER APPLY ( SELECT TOP 1
      BN.BENHNHAN_ID ,
      BN.MAYTE ,
      BN.TENBENHNHAN ,
      BN.NGAYSINH
      FROM      dbo.TT_NGOAITRU_KHAMBENH_TOATHUOC KBTT
      JOIN dbo.TT_NGOAITRU_KHAMBENH KB ON KB.KHAMBENH_ID = KBTT.KHAMBENH_ID
      JOIN dbo.TT_BENHNHAN BN ON BN.BENHNHAN_ID = KB.BENHNHAN_ID
      WHERE     KBTT.CHUNGTUPHATTHUOC_ID = CT.CHUNGTU_ID
      ) TTBN
      JOIN dbo.TM_KHODUOC KT ON CT.KHOXUAT_ID = KT.KHODUOC_ID
      JOIN dbo.TM_NHANVIEN NG ON CT.NGUOIGIAO_ID = NG.NHANVIEN_ID
      JOIN dbo.LST_DICTIONARY MDCT ON CT.MUCDICHCHUNGTU_ID = MDCT.DICTIONARY_ID
      JOIN dbo.TM_PHONGBAN PB ON CT.PHONGBAN_ID = PB.PHONGBAN_ID
      LEFT JOIN dbo.TM_PHONGBAN CO ON PB.COSTCENTER_ID = CO.PHONGBAN_ID
      LEFT JOIN dbo.TM_PHAMVI PV ON KT.PHAMVI_ID = PV.PHAMVI_ID
      LEFT JOIN dbo.LST_DICTIONARY MDSD ON CT.LYDOXUATSUDUNG_ID = MDSD.DICTIONARY_ID
      WHERE CT.BENHVIEN_ID = '$BENHVIEN_ID$' AND CAST(CT.NGAYCHUNGTU AS DATE) BETWEEN '$TUNGAY$' AND '$DENNGAY$'
      AND CT.MUCDICHCHUNGTU_CODE = 'X14'
      AND CT.IDCHUYEN IS NOT NULL
      AND ISNULL(CTCT.GIATRITHANHTOAN,0) > 0
      <isNotEmpty prepend="AND" property="KHOXUAT_ID">
        CT.KHOXUAT_ID = '$KHOXUAT_ID$'
      </isNotEmpty>
      <isNotEmpty prepend="AND" property="NGUOIXUAT_ID">
        CT.NGUOIGIAO_ID = '$NGUOIXUAT_ID$'
      </isNotEmpty>
      <isNotEmpty prepend="AND" property="TENBENHNHAN">
        TTBN.TENBENHNHAN LIKE N'%'+#TENBENHNHAN#+'%'
      </isNotEmpty>
      <isNotEmpty prepend="AND" property="MACHUNGTU">
        CT.MACHUNGTU LIKE N'%'+#MACHUNGTU#+'%'
      </isNotEmpty>
    </statement>
    <!--Lấy chi tiết chứng từ chi tiết xuất bệnh nhân-->
    <statement id="DAO09800_GetDetailXuatBenhNhan" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      SELECT	  TICHHOP_ID = NULL,
      CT.CHUNGTU_ID , CTCT.CHUNGTUCHITIET_ID,LD.LOAIVATTU_ID ,LD.MALOAIDUOC ,LD.TENLOAIDUOC ,D.MADUOC ,TD.TENDUOC  ,DONVITINH = DVT.TENDONVITINH,DONVIQUICACH = DVTQD.TENDONVITINH ,GIATRIQUIDOI = DVTQD.GIATRIQUIDOI ,
      SOLUONG = CTCT.SOLUONGDAXUAT  ,DONGIA = SLGB.DONGIAVON,GIATRI =  CTCT.SOLUONGDAXUAT *  SLGB.DONGIAVON,TYLEVAT = CTCT.TYLEVAT,GIATRIVAT = CTCT.GIATRIVAT ,TYLECHIETKHAU = CTCT.TYLECHIETKHAU ,
      GIATRICHIETKHAU = CTCT.GIATRICHIETKHAU ,GIATRITHANHTOAN = ISNULL(CTCT.SOLUONGDAXUAT,0) * ISNULL(SLGB.DONGIAVON,0),CTCT.KHUYENMAI
      FROM   dbo.TT_DUOC_CHUNGTU CT
      JOIN dbo.TT_DUOC_CHUNGTU_CHITIET CTCT ON CTCT.CHUNGTU_ID = CT.CHUNGTU_ID
	  JOIN TT_DUOC_SOLONHAP_GIABAN SLGB ON CTCT.SOLONHAP_ID = SLGB.SOLONHAP_ID
      JOIN dbo.TM_DUOC D ON CTCT.DUOC_ID = D.DUOC_ID
      JOIN dbo.TM_TENDUOC TD ON D.TENDUOC_ID = TD.TENDUOC_ID
      JOIN dbo.TM_LOAIDUOC LD ON D.LOAIDUOC_ID = LD.LOAIDUOC_ID
      LEFT JOIN dbo.TM_DONVITINH DVT ON D.DONVITINH_ID = DVT.DONVITINH_ID
      LEFT JOIN dbo.TM_DONVITINH DVTQD ON CTCT.DONVITINH_ID = DVTQD.DONVITINH_ID
      JOIN dbo.LST_DICTIONARY MDCT ON CT.MUCDICHCHUNGTU_ID = MDCT.DICTIONARY_ID
      WHERE  CT.CHUNGTU_ID = '$CHUNGTU_ID$' AND CT.MUCDICHCHUNGTU_CODE = 'X13'

      UNION
      SELECT	  TICHHOP_ID = NULL,
      CT.CHUNGTU_ID , CTCT.CHUNGTUCHITIET_ID,LD.LOAIVATTU_ID ,LD.MALOAIDUOC ,LD.TENLOAIDUOC ,D.MADUOC ,TD.TENDUOC  ,DONVITINH = DVT.TENDONVITINH,DONVIQUICACH = DVTQD.TENDONVITINH ,GIATRIQUIDOI = DVTQD.GIATRIQUIDOI ,
      SOLUONG = CTCT.SOLUONGDAXUAT  ,DONGIA = SLGB.DONGIAVON,GIATRI =  CTCT.SOLUONGDAXUAT *  SLGB.DONGIAVON,TYLEVAT = CTCT.TYLEVAT,GIATRIVAT = CTCT.GIATRIVAT ,TYLECHIETKHAU = CTCT.TYLECHIETKHAU ,
      GIATRICHIETKHAU = CTCT.GIATRICHIETKHAU ,GIATRITHANHTOAN = ISNULL(CTCT.SOLUONGDAXUAT,0) * ISNULL(SLGB.DONGIAVON,0),CTCT.KHUYENMAI
      FROM   dbo.TT_DUOC_CHUNGTU CT
      JOIN dbo.TT_DUOC_CHUNGTU_CHITIET CTCT ON CTCT.CHUNGTU_ID = CT.CHUNGTU_ID
	  JOIN TT_DUOC_SOLONHAP_GIABAN SLGB ON CTCT.SOLONHAP_ID = SLGB.SOLONHAP_ID
      JOIN dbo.TM_DUOC D ON CTCT.DUOC_ID = D.DUOC_ID
      JOIN dbo.TM_TENDUOC TD ON D.TENDUOC_ID = TD.TENDUOC_ID
      JOIN dbo.TM_LOAIDUOC LD ON D.LOAIDUOC_ID = LD.LOAIDUOC_ID
      LEFT JOIN dbo.TM_DONVITINH DVT ON D.DONVITINH_ID = DVT.DONVITINH_ID
      LEFT JOIN dbo.TM_DONVITINH DVTQD ON CTCT.DONVITINH_ID = DVTQD.DONVITINH_ID
      JOIN dbo.LST_DICTIONARY MDCT ON CT.MUCDICHCHUNGTU_ID = MDCT.DICTIONARY_ID
      WHERE  CT.CHUNGTU_ID = '$CHUNGTU_ID$' AND CT.MUCDICHCHUNGTU_CODE = 'X14'
    </statement>

    
    <!--Cập nhật IDChuyen vào bảng DUOC_CHUNGTU-->
    <update id="DAO09800_UpdateDUOC_CHUNGTU_IDChuyen" parameterClass="System.Collections.IDictionary">
      UPDATE dbo.TT_DUOC_CHUNGTU SET IDCHUYEN = #CHUYENTICHHOP_ID# WHERE CHUNGTU_ID = '$CHUNGTU_ID$'
    </update>
    
    <!--Kiểm tra xem chứng từ đã được chuyển lên db trung gian chưa-->
    <statement id="DAO09800_KiemTraChungTuDuocDaChuyen" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      SELECT  1
      FROM    dbo.TT_DUOC_CHUNGTU
      WHERE   BENHVIEN_ID = '$BENHVIEN_ID$'
      AND CHUNGTU_ID = '$CHUNGTU_ID$'
      AND IDCHUYEN IS NOT NULL;
    </statement>
    
    <!--============================================END DƯỢC PHẨM=============================================-->

    <!--============================================BEGIN VĂN PHÒNG PHẨM=============================================-->
    <!--Lấy danh sách chứng từ nhập VPP-->
    <statement id="DAO09800_GetMasterNHAPVPP" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      DECLARE @TENBENHVIEN NVARCHAR(250);
      SELECT  @TENBENHVIEN = VALUE
      FROM   dbo.TM_SYS_APPSETTINGS
      WHERE  BENHVIEN_ID = '$BENHVIEN_ID$'
      AND CODE = 'APP_BENHVIEN_TEN';

      SELECT BTNCHECK = CAST (0 AS BIT), CHUNGTU_ID = CT.CHUNGTUNHAP_ID ,CT.MACHUNGTU ,CT.NGAYCHUNGTU ,LOAICHUNGTU = 'N' ,CT.KYHIEUHOADON ,CT.SOSERI ,CT.SOHOADON ,CT.NGAYHOADON ,NCC.MANHACUNGCAP ,
      NCC.TENNHACUNGCAP ,NCC.DIACHI ,NCC.MASOTHUE ,TIENTE_ID = 'VND' ,TYGIA = 1.0000 ,GIATRI = CTCT.THANHTIENTRUOCVAT ,TYLEVAT = NULL ,CTCT.GIATRIVAT ,CT.TYLECHIETKHAU ,CT.GIATRICHIETKHAU ,
      GIATRITHANHTOAN = CTCT.THANHTIENSAUVAT ,NN.MANHANVIEN ,ISNULL(NN.TENNHANVIEN, CT.TENNGUOINHAP) AS TENNHANVIEN ,MADONHANG = NULL ,KHONHAP_ID = NULL ,MAKHONHAP = CT.MAKHO ,TENKHONHAP = CT.TENKHO ,KHOXUAT_ID = NULL ,MAKHOXUAT = NULL ,
      TENKHOXUAT = NULL ,TRANGTHAI = CT.MATRANGTHAI ,PHONGBAN_ID = NULL ,MAPHONGBAN = NULL ,TENPHONGBAN = NULL ,COSTCENTER_ID = NULL ,COSTCENTERCODE = NULL ,COSTCENTERNAME = NULL ,
      CT.BENHVIEN_ID ,MABENHVIEN = CT.BENHVIEN_ID ,TENBENHVIEN = @TENBENHVIEN ,IDCHUYEN ,CHUYENTICHHOP_ID = NULL ,CT.GHICHU, CT.TENNGUOINHAP, CT.TENNGUOIGIAO, STATUSROW = CAST (0 AS BIT), MESSAGEROW = NULL
      FROM   dbo.TT_INV_CHUNGTUNHAP CT
      JOIN dbo.TM_NHACUNGCAP NCC ON CT.NHACUNGCAP_ID = NCC.NHACUNGCAP_ID
      CROSS APPLY ( SELECT    SUM(THANHTIENTRUOCVAT) THANHTIENTRUOCVAT ,
      SUM(THANHTIENSAUVAT) THANHTIENSAUVAT ,
      SUM(GIATRIVAT * SOLUONGNHAP) GIATRIVAT
      FROM      dbo.TT_INV_CHUNGTUNHAPCHITIET
      WHERE     CHUNGTUNHAP_ID = CT.CHUNGTUNHAP_ID
      ) CTCT
      LEFT JOIN dbo.TM_NHANVIEN NN ON CT.NGUOITAO_ID = NN.NHANVIEN_ID
      WHERE  CT.BENHVIEN_ID = '$BENHVIEN_ID$' AND CAST(CT.NGAYCHUNGTU AS DATE) BETWEEN '$TUNGAY$' AND '$DENNGAY$'
      AND CT.MATRANGTHAI = 'DaNhapKho'
      AND CT.IDCHUYEN IS NULL
      AND ISNULL(CTCT.THANHTIENSAUVAT,0) > 0
      <isNotEmpty prepend="AND" property="MACHUNGTU">
        CT.MACHUNGTU LIKE N'%'+#MACHUNGTU#+'%'
      </isNotEmpty>
      <isNotEmpty prepend="AND" property="MAKHO">
        CT.MAKHO ='$MAKHO$'
      </isNotEmpty>
      <isNotEmpty prepend="AND" property="NHACUNGCAP_ID">
        CT.NHACUNGCAP_ID = '$NHACUNGCAP_ID$'
      </isNotEmpty>
      <isNotEmpty prepend="AND" property="TENNGUOIGIAO">
        ISNULL(CT.TENNGUOIGIAO,'') LIKE N'%'+#TENNGUOIGIAO#+'%'
      </isNotEmpty>
      <isNotEmpty prepend="AND" property="TENNGUOINHAN">
        ISNULL(CT.TENNGUOINHAP,'') LIKE N'%'+#TENNGUOINHAN#+'%'
      </isNotEmpty>
    </statement>
    <!--Lấy danh sách chứng từ nhập VPP  đã chuyển-->
    <statement id="DAO09800_GetMasterNHAPVPP_DACHUYEN" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      DECLARE @TENBENHVIEN NVARCHAR(250);
      SELECT  @TENBENHVIEN = VALUE
      FROM   dbo.TM_SYS_APPSETTINGS
      WHERE  BENHVIEN_ID = '$BENHVIEN_ID$'
      AND CODE = 'APP_BENHVIEN_TEN';

      SELECT BTNCHECK = CAST (0 AS BIT), CHUNGTU_ID = CT.CHUNGTUNHAP_ID ,CT.MACHUNGTU ,CT.NGAYCHUNGTU ,LOAICHUNGTU = 'N' ,CT.KYHIEUHOADON ,CT.SOSERI ,CT.SOHOADON ,CT.NGAYHOADON ,NCC.MANHACUNGCAP ,
      NCC.TENNHACUNGCAP ,NCC.DIACHI ,NCC.MASOTHUE ,TIENTE_ID = 'VND' ,TYGIA = 1.0000 ,GIATRI = CTCT.THANHTIENTRUOCVAT ,TYLEVAT = NULL ,CTCT.GIATRIVAT ,CT.TYLECHIETKHAU ,CT.GIATRICHIETKHAU ,
      GIATRITHANHTOAN = CTCT.THANHTIENSAUVAT ,NN.MANHANVIEN ,ISNULL(NN.TENNHANVIEN, CT.TENNGUOINHAP) AS TENNHANVIEN ,MADONHANG = NULL ,KHONHAP_ID = NULL ,MAKHONHAP = CT.MAKHO ,TENKHONHAP = CT.TENKHO ,KHOXUAT_ID = NULL ,MAKHOXUAT = NULL ,
      TENKHOXUAT = NULL ,TRANGTHAI = CT.MATRANGTHAI ,PHONGBAN_ID = NULL ,MAPHONGBAN = NULL ,TENPHONGBAN = NULL ,COSTCENTER_ID = NULL ,COSTCENTERCODE = NULL ,COSTCENTERNAME = NULL ,
      CT.BENHVIEN_ID ,MABENHVIEN = CT.BENHVIEN_ID ,TENBENHVIEN = @TENBENHVIEN ,IDCHUYEN ,CHUYENTICHHOP_ID = NULL ,CT.GHICHU, CT.TENNGUOINHAP, CT.TENNGUOIGIAO, STATUSROW = CAST (0 AS BIT), MESSAGEROW = NULL
      ,TH.THOIGIANCHUYEN
      FROM   dbo.TT_INV_CHUNGTUNHAP CT
      JOIN VIEW_IDCHUYENTICHHOP TH on TH.CHUYENTICHHOP_ID = CT.IDCHUYEN
      JOIN dbo.TM_NHACUNGCAP NCC ON CT.NHACUNGCAP_ID = NCC.NHACUNGCAP_ID
      CROSS APPLY ( SELECT    SUM(THANHTIENTRUOCVAT) THANHTIENTRUOCVAT ,
      SUM(THANHTIENSAUVAT) THANHTIENSAUVAT ,
      SUM(GIATRIVAT * SOLUONGNHAP) GIATRIVAT
      FROM      dbo.TT_INV_CHUNGTUNHAPCHITIET
      WHERE     CHUNGTUNHAP_ID = CT.CHUNGTUNHAP_ID
      ) CTCT
      LEFT JOIN dbo.TM_NHANVIEN NN ON CT.NGUOITAO_ID = NN.NHANVIEN_ID
      WHERE  CT.BENHVIEN_ID = '$BENHVIEN_ID$' AND CAST(CT.NGAYCHUNGTU AS DATE) BETWEEN '$TUNGAY$' AND '$DENNGAY$'
      AND CT.MATRANGTHAI = 'DaNhapKho'
      AND CT.IDCHUYEN IS NOT NULL
      AND ISNULL(CTCT.THANHTIENSAUVAT,0) > 0
      <isNotEmpty prepend="AND" property="MACHUNGTU">
        CT.MACHUNGTU LIKE N'%'+#MACHUNGTU#+'%'
      </isNotEmpty>
      <isNotEmpty prepend="AND" property="MAKHO">
        CT.MAKHO ='$MAKHO$'
      </isNotEmpty>
      <isNotEmpty prepend="AND" property="NHACUNGCAP_ID">
        CT.NHACUNGCAP_ID = '$NHACUNGCAP_ID$'
      </isNotEmpty>
      <isNotEmpty prepend="AND" property="TENNGUOIGIAO">
        ISNULL(CT.TENNGUOIGIAO,'') LIKE N'%'+#TENNGUOIGIAO#+'%'
      </isNotEmpty>
      <isNotEmpty prepend="AND" property="TENNGUOINHAN">
        ISNULL(CT.TENNGUOINHAP,'') LIKE N'%'+#TENNGUOINHAN#+'%'
      </isNotEmpty>
    </statement>
    <!--Lấy danh sách chứng từ nhập VPP-->
    <statement id="DAO09800_GetDetailNHAPVPP" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      SELECT TICHHOP_ID = NULL ,CHUNGTU_ID = CT.CHUNGTUNHAP_ID, CTCT.CHUNGTUNHAPCHITIET_ID AS CHUNGTUCHITIET_ID ,MALOAI = LOAI.MA ,TENLOAI = LOAI.TEN ,MANHOM = NHOM.MA,TENNHOM = NHOM.TEN,
      MAHANG = HH.MA,TENHANG = HH.TEN,DONVITINH = HH.TENDONVITINH,SOLUONG = CTCT.SOLUONGNHAP,DONGIA = TD.DONGIA,GIATRI = CTCT.THANHTIENSAUVAT,
      TD.TYLEVAT ,GIATRIVAT = CTCT.GIATRIVAT * CTCT.SOLUONGNHAP ,GIATRITHANHTOAN = CTCT.THANHTIENSAUVAT,CT.TYLECHIETKHAU ,CT.GIATRICHIETKHAU ,CTCT.KHUYENMAI
      FROM   dbo.TT_INV_CHUNGTUNHAP CT
      JOIN dbo.TT_INV_CHUNGTUNHAPCHITIET CTCT ON CTCT.CHUNGTUNHAP_ID = CT.CHUNGTUNHAP_ID
      JOIN TT_INV_THEODOI TD ON TD.THEODOI_ID = CTCT.THEODOI_ID
      JOIN dbo.TM_PUR_HANGHOA HH ON TD.HANGHOA_ID = HH.ID
      LEFT JOIN dbo.TM_PUR_NHOM NHOM ON HH.NHOM_ID = NHOM.ID
      LEFT JOIN dbo.TM_PUR_LOAI LOAI ON HH.LOAI_ID = LOAI.ID
      WHERE  CT.CHUNGTUNHAP_ID = '$CHUNGTU_ID$'
    </statement>
    <!--Cập nhật IDChuyen vào bảng INV_CHUNGTUNHAP-->
    <update id="DAO09800_UpdateINV_CHUNGTUNHAP_IDChuyen" parameterClass="System.Collections.IDictionary">
      UPDATE dbo.TT_INV_CHUNGTUNHAP SET IDCHUYEN = #CHUYENTICHHOP_ID# WHERE CHUNGTUNHAP_ID = '$CHUNGTU_ID$'
    </update>

    <!--Lấy danh sách chứng từ xuất vpp-->
    <statement id="DAO09800_GetMasterXUATVPP" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      DECLARE @TENBENHVIEN NVARCHAR(250);
      SELECT  @TENBENHVIEN = VALUE
      FROM    dbo.TM_SYS_APPSETTINGS
      WHERE   BENHVIEN_ID = '$BENHVIEN_ID$'
      AND CODE = 'APP_BENHVIEN_TEN';

      SELECT  BTNCHECK = CAST (0 AS BIT) ,
      CT.CHUNGTUXUAT_ID AS CHUNGTU_ID ,
      CT.MACHUNGTU ,
      CT.NGAYCHUNGTU ,
      LOAICHUNGTU = 'X' ,
      NULL AS KYHIEUHOADON ,
      NULL AS SOSERI ,
      NULL AS SOHOADON ,
      NULL AS NGAYHOADON ,
      NULL AS MANHACUNGCAP ,
      NULL AS TENNHACUNGCAP ,
      NULL AS DIACHI ,
      NULL AS MASOTHUE ,
      TIENTE_ID = 'VND' ,
      TYGIA = 1.0000,
      NULL AS GIATRI ,
      NULL AS TYLEVAT ,
      NULL AS GIATRIVAT ,
      NULL AS TYLECHIETKHAU ,
      NULL AS GIATRICHIETKHAU ,
      CTCT.GIATRITHANHTOAN ,
      NV.MANHANVIEN ,
      NV.TENNHANVIEN ,
      NULL AS MADONHANG ,
      NULL AS KHONHAP_ID ,
      NULL AS MAKHONHAP ,
      NULL AS TENKHONHAP ,
      AA.DICTIONARY_ID AS KHOXUAT_ID ,
      CT.MAKHOXUAT ,
      CT.TENKHOXUAT ,
      CT.TENNGUOITAO,
      NULL AS TRANGTHAI ,
      PB.PHONGBAN_ID ,
      PB.MAPHONGBAN ,
      PB.TENPHONGBAN ,
      PB.COSTCENTER_ID ,
      CO.MAPHONGBAN AS COSTCENTERCODE ,
      CO.TENPHONGBAN AS COSTCENTERNAME ,
      CT.BENHVIEN_ID ,
      CT.BENHVIEN_ID AS MABENHVIEN ,
      TENBENHVIEN = @TENBENHVIEN ,
      CT.IDCHUYEN ,
      NULL AS CHUYENTICHHOP_ID ,
      CT.GHICHU ,
      STATUSROW = CAST (0 AS BIT) ,
      MESSAGEROW = NULL
      FROM    dbo.TT_INV_CHUNGTUXUAT CT
      CROSS APPLY ( SELECT    SUM(ISNULL(CTCT.THANHTIEN, 0)) AS GIATRITHANHTOAN
      FROM      dbo.TT_INV_CHUNGTUXUATCHITIET CTCT
      WHERE     CTCT.CHUNGTUXUAT_ID = CT.CHUNGTUXUAT_ID
      ) CTCT
      JOIN dbo.TM_PHONGBAN PB ON CT.PHONGBANNHAN_ID = PB.PHONGBAN_ID
      JOIN dbo.TM_NHANVIEN NV ON NV.NHANVIEN_ID = CT.NHANVIENNHAN_ID
      JOIN dbo.LST_DICTIONARY AA ON AA.DICTIONARY_CODE = CT.MAKHOXUAT
      LEFT JOIN dbo.TM_PHONGBAN CO ON PB.COSTCENTER_ID = CO.PHONGBAN_ID
      WHERE   CT.BENHVIEN_ID = '$BENHVIEN_ID$'  AND CAST(CT.NGAYCHUNGTU AS DATE) BETWEEN '$TUNGAY$' AND '$DENNGAY$'
      AND CT.IDCHUYEN IS NULL
      AND ISNULL(CTCT.GIATRITHANHTOAN,0) > 0
      <isNotEmpty prepend="AND" property="MAKHO">
        CT.MAKHOXUAT = '$MAKHO$'
      </isNotEmpty>
      <isNotEmpty prepend="AND" property="NGUOINHAP_ID">
        CT.NHANVIENNHAN_ID = '$NGUOINHAP_ID$'
      </isNotEmpty>
      <isNotEmpty prepend="AND" property="TENNGUOITAO">
        CT.TENNGUOITAO LIKE N'%'+#TENNGUOITAO#+'%'
      </isNotEmpty>
      <isNotEmpty prepend="AND" property="TENPHONGBANNHAN">
        CT.TENPHONGBANNHAN LIKE N'%'+#TENPHONGBANNHAN#+'%'
      </isNotEmpty>
      <isNotEmpty prepend="AND" property="MACHUNGTU">
        CT.MACHUNGTU LIKE N'%'+#MACHUNGTU#+'%'
      </isNotEmpty>
    </statement>
    <!--Lấy danh sách chứng từ xuất vpp đã chuyển-->
    <statement id="DAO09800_GetMasterXUATVPP_DACHUYEN" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      DECLARE @TENBENHVIEN NVARCHAR(250);
      SELECT  @TENBENHVIEN = VALUE
      FROM    dbo.TM_SYS_APPSETTINGS
      WHERE   BENHVIEN_ID = '$BENHVIEN_ID$'
      AND CODE = 'APP_BENHVIEN_TEN';

      SELECT  BTNCHECK = CAST (0 AS BIT) ,
      CT.CHUNGTUXUAT_ID AS CHUNGTU_ID ,
      CT.MACHUNGTU ,
      CT.NGAYCHUNGTU ,
      LOAICHUNGTU = 'X' ,
      NULL AS KYHIEUHOADON ,
      NULL AS SOSERI ,
      NULL AS SOHOADON ,
      NULL AS NGAYHOADON ,
      NULL AS MANHACUNGCAP ,
      NULL AS TENNHACUNGCAP ,
      NULL AS DIACHI ,
      NULL AS MASOTHUE ,
      TIENTE_ID = 'VND' ,
      TYGIA = 1.0000,
      NULL AS GIATRI ,
      NULL AS TYLEVAT ,
      NULL AS GIATRIVAT ,
      NULL AS TYLECHIETKHAU ,
      NULL AS GIATRICHIETKHAU ,
      CTCT.GIATRITHANHTOAN ,
      NV.MANHANVIEN ,
      NV.TENNHANVIEN ,
      NULL AS MADONHANG ,
      NULL AS KHONHAP_ID ,
      NULL AS MAKHONHAP ,
      NULL AS TENKHONHAP ,
      AA.DICTIONARY_ID AS KHOXUAT_ID ,
      CT.MAKHOXUAT ,
      CT.TENKHOXUAT ,
      CT.TENNGUOITAO,
      NULL AS TRANGTHAI ,
      PB.PHONGBAN_ID ,
      PB.MAPHONGBAN ,
      PB.TENPHONGBAN ,
      PB.COSTCENTER_ID ,
      CO.MAPHONGBAN AS COSTCENTERCODE ,
      CO.TENPHONGBAN AS COSTCENTERNAME ,
      CT.BENHVIEN_ID ,
      CT.BENHVIEN_ID AS MABENHVIEN ,
      TENBENHVIEN = @TENBENHVIEN ,
      CT.IDCHUYEN ,
      NULL AS CHUYENTICHHOP_ID ,
      CT.GHICHU ,
      STATUSROW = CAST (0 AS BIT) ,
      MESSAGEROW = NULL
      ,TH.THOIGIANCHUYEN
      FROM    dbo.TT_INV_CHUNGTUXUAT CT
      JOIN VIEW_IDCHUYENTICHHOP TH on TH.CHUYENTICHHOP_ID = CT.IDCHUYEN
      CROSS APPLY ( SELECT    SUM(ISNULL(CTCT.THANHTIEN, 0)) AS GIATRITHANHTOAN
      FROM      dbo.TT_INV_CHUNGTUXUATCHITIET CTCT
      WHERE     CTCT.CHUNGTUXUAT_ID = CT.CHUNGTUXUAT_ID
      ) CTCT
      JOIN dbo.TM_PHONGBAN PB ON CT.PHONGBANNHAN_ID = PB.PHONGBAN_ID
      JOIN dbo.TM_NHANVIEN NV ON NV.NHANVIEN_ID = CT.NHANVIENNHAN_ID
      JOIN dbo.LST_DICTIONARY AA ON AA.DICTIONARY_CODE = CT.MAKHOXUAT
      LEFT JOIN dbo.TM_PHONGBAN CO ON PB.COSTCENTER_ID = CO.PHONGBAN_ID
      WHERE   CT.BENHVIEN_ID = '$BENHVIEN_ID$'  AND CAST(CT.NGAYCHUNGTU AS DATE) BETWEEN '$TUNGAY$' AND '$DENNGAY$'
      AND CT.IDCHUYEN IS NOT NULL
      AND ISNULL(CTCT.GIATRITHANHTOAN,0) > 0
      <isNotEmpty prepend="AND" property="MAKHO">
        CT.MAKHOXUAT = '$MAKHO$'
      </isNotEmpty>
      <isNotEmpty prepend="AND" property="NGUOINHAP_ID">
        CT.NHANVIENNHAN_ID = '$NGUOINHAP_ID$'
      </isNotEmpty>
      <isNotEmpty prepend="AND" property="TENNGUOITAO">
        CT.TENNGUOITAO LIKE N'%'+#TENNGUOITAO#+'%'
      </isNotEmpty>
      <isNotEmpty prepend="AND" property="TENPHONGBANNHAN">
        CT.TENPHONGBANNHAN LIKE N'%'+#TENPHONGBANNHAN#+'%'
      </isNotEmpty>
      <isNotEmpty prepend="AND" property="MACHUNGTU">
        CT.MACHUNGTU LIKE N'%'+#MACHUNGTU#+'%'
      </isNotEmpty>
    </statement>
    <!--Lấy chi tiết chứng từ xuất vpp-->
    <statement id="DAO09800_GetDetailXUATVPP" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      SELECT  TICHHOP_ID = NULL ,
      CT.CHUNGTUXUAT_ID AS CHUNGTU_ID ,
      CTCT.CHUNGTUXUATCHITIET_ID AS CHUNGTUCHITIET_ID ,
      LOAI.MA AS MALOAI ,
      HH.TENLOAI ,
      PUR.MA AS MANHOM ,
      HH.TENNHOM ,
      TD.MAHANGHOA AS MAHANG ,
      TD.TENHANGHOA AS TENHANG ,
      HH.TENDONVITINH AS DONVITINH ,
      CTCT.SOLUONGXUAT AS SOLUONG ,
      HH.DONGIA ,
      NULL AS GIATRI ,
      TD.TYLEVAT ,
      NULL AS GIATRIVAT ,
      CTCT.THANHTIEN AS GIATRITHANHTOAN ,
      NULL AS TYLECHIETKHAU ,
      NULL AS GIATRICHIETKHAU ,
      KHUYENMAI = 0
      FROM    dbo.TT_INV_CHUNGTUXUAT CT
      JOIN dbo.TT_INV_CHUNGTUXUATCHITIET CTCT ON CTCT.CHUNGTUXUAT_ID = CT.CHUNGTUXUAT_ID
	  JOIN TT_INV_THEODOI TD ON TD.THEODOI_ID = CTCT.THEODOI_ID
      left JOIN dbo.TM_PUR_HANGHOA HH ON HH.ID = TD.HANGHOA_ID      
      LEFT JOIN dbo.TM_PUR_NHOM PUR ON PUR.ID = HH.NHOM_ID
      LEFT JOIN dbo.TM_PUR_LOAI LOAI ON HH.LOAI_ID = LOAI.ID
      WHERE   CT.CHUNGTUXUAT_ID = '$CHUNGTU_ID$'
    </statement>
    <!--Cập nhật IDChuyen vào bảng TT_INV_CHUNGTUXUAT-->
    <update id="DAO09800_UpdateTT_INV_CHUNGTUXUAT_IDChuyen" parameterClass="System.Collections.IDictionary">
      UPDATE dbo.TT_INV_CHUNGTUXUAT SET IDCHUYEN = #CHUYENTICHHOP_ID# WHERE CHUNGTUXUAT_ID = '$CHUNGTU_ID$'
    </update>

    <!--Kiểm tra xem chứng từ nhập VPP đã được chuyển lên db trung gian chưa-->
    <statement id="DAO09800_KiemTraChungTuNhapVPPDaChuyen" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      SELECT  1
      FROM    dbo.TT_INV_CHUNGTUNHAP
      WHERE   BENHVIEN_ID = '$BENHVIEN_ID$'
      AND CHUNGTUNHAP_ID = '$CHUNGTU_ID$'
      AND IDCHUYEN IS NOT NULL;
    </statement>
    <!--Kiểm tra xem chứng từ xuất VPP đã được chuyển lên db trung gian chưa-->
    <statement id="DAO09800_KiemTraChungTuXuatVPPDaChuyen" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      SELECT  1
      FROM    dbo.TT_INV_CHUNGTUXUAT
      WHERE   BENHVIEN_ID = '$BENHVIEN_ID$'
      AND CHUNGTUXUAT_ID = '$CHUNGTU_ID$'
      AND IDCHUYEN IS NOT NULL;
    </statement>
    <!--============================================END VĂN PHÒNG PHẨM=============================================-->

    <!--============================================BEGIN VIỆN PHÍ=============================================-->
    <!--Lấy danh sách Viện phí ngoại trú-->
    <statement id="DAO09800_GetMasterVienPhiNgoaiTru" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      DECLARE @TENBENHVIEN NVARCHAR(250);
      SELECT  @TENBENHVIEN = VALUE
      FROM    dbo.TM_SYS_APPSETTINGS
      WHERE   BENHVIEN_ID = '$BENHVIEN_ID$'
      AND CODE = 'APP_BENHVIEN_TEN';
      SELECT BTNCHECK = CAST (0 AS BIT) ,* FROM (
      SELECT  HD.HOADON_ID ,HD.SOHOADON ,HD.NGAYHOADON ,HD.LOAIHOADON ,HD.TIEPNHAN_ID ,HD.BENHNHAN_ID ,HD.BENHAN_ID ,BN.MAYTE ,TENBENHNHAN = ISNULL(BN.TENBENHNHAN,CTCT.TENBENHNHAN) ,BN.DIACHI ,MASOTHUE = NULL ,HD.SOSERIEVAT ,
      HD.TIENTE_ID ,HD.TYGIA ,GIATRI = HD.GIATRITHUCTHU ,HD.GIATRIVAT ,GIATRICHIETKHAU = CAST(NULL AS NUMERIC(25, 4)) ,HD.GIATRIHOADON ,NT.MANHANVIEN ,NT.TENNHANVIEN ,HD.DATHANHTOAN ,
      PHONGBAN_ID = HD.NOITHUTIEN_ID ,NL.MAPHONGBAN ,NL.TENPHONGBAN ,NL.COSTCENTER_ID ,COSTCENTERCODE = COST.MAPHONGBAN ,COSTCENTERNAME = COST.TENPHONGBAN ,HD.BENHVIEN_ID ,MABENHVIEN = HD.BENHVIEN_ID ,TENBENHVIEN = @TENBENHVIEN ,
      HD.IDCHUYEN ,HOANTRA = '0',HD.IDCHUYENHOAN ,HUYHOADON = '0' ,HD.IDCHUYENHUY ,LOAICHUNGTU = 'TH',TENLOAICHUNGTU = N'THU' ,CHUYENTICHHOP_ID = NULL ,SOBENHAN = NULL ,SOTIEPNHAN = TN.SOTIEPNHAN ,STATUSROW = CAST (0 AS BIT) ,MESSAGEROW = NULL,
      HD.HOADON_CHUNGTU_LIENQUAN_ID, CTCT.KHOXUAT_ID ,CTCT.MAKHOXUAT ,CTCT.TENKHOXUAT ,ISNULL(CTCT.NGUON,'') AS NGUON
      FROM    dbo.TT_HOADON HD
      LEFT JOIN dbo.TT_BENHNHAN BN ON BN.BENHNHAN_ID = HD.BENHNHAN_ID
      LEFT JOIN dbo.TT_TIEPNHAN TN ON HD.TIEPNHAN_ID = TN.TIEPNHAN_ID
      JOIN dbo.TM_NHANVIEN NT ON HD.NGUOITHUTIEN_ID = NT.NHANVIEN_ID
      JOIN dbo.TM_PHONGBAN NL ON HD.NOITHUTIEN_ID = NL.PHONGBAN_ID
      LEFT JOIN dbo.TM_PHONGBAN COST ON NL.COSTCENTER_ID = COST.PHONGBAN_ID
      OUTER APPLY (SELECT  TOP 1 KX.KHODUOC_ID AS KHOXUAT_ID, KX.MAKHO AS MAKHOXUAT, KX.TENKHO AS TENKHOXUAT, NGUON ='MUANGOAI', CT.TenBenhNhan
      FROM dbo.TT_HOADON_CHITIET_NGOAITRU HDCT
      JOIN TT_DUOC_CHUNGTU_CHITIET CTCT ON HDCT.REF_ID = CTCT.CHUNGTUCHITIET_ID
      JOIN dbo.TT_DUOC_CHUNGTU CT ON CT.CHUNGTU_ID = CTCT.CHUNGTU_ID
      JOIN dbo.TM_KHODUOC KX ON CT.KHOXUAT_ID = KX.KHODUOC_ID
      WHERE HDCT.HOADON_ID = HD.HOADON_ID
      AND HDCT.REF_TABLE ='TT_DUOC_CHUNGTU_CHITIET'
      )CTCT
      WHERE   HD.BENHVIEN_ID = '$BENHVIEN_ID$'  AND CAST(HD.NGAYHOADON AS DATE) BETWEEN '$TUNGAY$' AND '$DENNGAY$'
      <isNotEmpty prepend="AND" property="SOHOADON">
        HD.SOHOADON LIKE N'%'+#SOHOADON#+'%'
      </isNotEmpty>
      <isNotEmpty prepend="AND" property="SOTIEPNHAN">
        TN.SOTIEPNHAN LIKE N'%'+#SOTIEPNHAN#+'%'
      </isNotEmpty>
      <isNotEmpty prepend="AND" property="MAYTE">
        BN.MAYTE LIKE N'%'+#MAYTE#+'%'
      </isNotEmpty>
      <isNotEmpty prepend="AND" property="TENBENHNHAN">
        ISNULL(BN.TENBENHNHAN,CTCT.TENBENHNHAN) LIKE N'%'+#TENBENHNHAN#+'%'
      </isNotEmpty>
      <isNotEmpty prepend="AND" property="NGUOITHU_ID">
        HD.NGUOITHUTIEN_ID = '$NGUOITHU_ID$'
      </isNotEmpty>
      AND HD.IDCHUYEN IS NULL
      AND HD.DATHANHTOAN = 1
      AND HD.BENHAN_ID IS NULL
      
      UNION ALL
      SELECT  HD.HOADON_ID ,HD.SOHOADON ,HD.NGAYCAPNHAT AS NGAYHOADON ,HD.LOAIHOADON ,HD.TIEPNHAN_ID ,HD.BENHNHAN_ID ,HD.BENHAN_ID ,BN.MAYTE ,TENBENHNHAN = ISNULL(BN.TENBENHNHAN,CTCT.TENBENHNHAN) ,BN.DIACHI ,MASOTHUE = NULL ,HD.SOSERIEVAT ,
      HD.TIENTE_ID ,HD.TYGIA ,GIATRI = HD.GIATRITHUCTHU ,HD.GIATRIVAT ,GIATRICHIETKHAU = CAST(NULL AS NUMERIC(25, 4)) ,HD.GIATRIHOADON ,NT.MANHANVIEN ,NT.TENNHANVIEN ,HD.DATHANHTOAN ,
      PHONGBAN_ID = HD.NOITHUTIEN_ID ,NL.MAPHONGBAN ,NL.TENPHONGBAN ,NL.COSTCENTER_ID ,COSTCENTERCODE = COST.MAPHONGBAN ,COSTCENTERNAME = COST.TENPHONGBAN ,HD.BENHVIEN_ID ,MABENHVIEN = HD.BENHVIEN_ID ,TENBENHVIEN = @TENBENHVIEN ,
      HD.IDCHUYEN ,HD.HOANTRA ,HD.IDCHUYENHOAN ,HD.HUYHOADON ,HD.IDCHUYENHUY ,LOAICHUNGTU = CASE WHEN HD.HUYHOADON = 1 THEN 'HU' ELSE 'HT' END, TENLOAICHUNGTU = CASE WHEN HD.HUYHOADON = 1 THEN N'HỦY' ELSE N'HOÀN TRẢ' END ,CHUYENTICHHOP_ID = NULL ,SOBENHAN = NULL ,SOTIEPNHAN = TN.SOTIEPNHAN ,STATUSROW = CAST (0 AS BIT) ,MESSAGEROW = NULL,
      HD.HOADON_CHUNGTU_LIENQUAN_ID, CTCT.KHOXUAT_ID ,CTCT.MAKHOXUAT ,CTCT.TENKHOXUAT ,ISNULL(CTCT.NGUON,'') AS NGUON
      FROM    dbo.TT_HOADON HD
      LEFT JOIN dbo.TT_BENHNHAN BN ON BN.BENHNHAN_ID = HD.BENHNHAN_ID
      LEFT JOIN dbo.TT_TIEPNHAN TN ON HD.TIEPNHAN_ID = TN.TIEPNHAN_ID
      JOIN dbo.TM_NHANVIEN NT ON HD.NGUOITHUTIEN_ID = NT.NHANVIEN_ID
      JOIN dbo.TM_PHONGBAN NL ON HD.NOITHUTIEN_ID = NL.PHONGBAN_ID
      LEFT JOIN dbo.TM_PHONGBAN COST ON NL.COSTCENTER_ID = COST.PHONGBAN_ID
      OUTER APPLY (SELECT  TOP 1 KX.KHODUOC_ID AS KHOXUAT_ID, KX.MAKHO AS MAKHOXUAT, KX.TENKHO AS TENKHOXUAT, NGUON ='MUANGOAI', CT.TenBenhNhan
      FROM dbo.TT_HOADON_CHITIET_NGOAITRU HDCT
      JOIN TT_DUOC_CHUNGTU_CHITIET CTCT ON HDCT.REF_ID = CTCT.CHUNGTUCHITIET_ID
      JOIN dbo.TT_DUOC_CHUNGTU CT ON CT.CHUNGTU_ID = CTCT.CHUNGTU_ID
      JOIN dbo.TM_KHODUOC KX ON CT.KHOXUAT_ID = KX.KHODUOC_ID
      WHERE HDCT.HOADON_ID = HD.HOADON_ID
      AND HDCT.REF_TABLE ='TT_DUOC_CHUNGTU_CHITIET'
      )CTCT
      WHERE   HD.BENHVIEN_ID = '$BENHVIEN_ID$'  AND CAST(HD.NGAYCAPNHAT AS DATE) BETWEEN '$TUNGAY$' AND '$DENNGAY$'
      <isNotEmpty prepend="AND" property="SOHOADON">
        HD.SOHOADON LIKE N'%'+#SOHOADON#+'%'
      </isNotEmpty>
      <isNotEmpty prepend="AND" property="SOTIEPNHAN">
        TN.SOTIEPNHAN LIKE N'%'+#SOTIEPNHAN#+'%'
      </isNotEmpty>
      <isNotEmpty prepend="AND" property="MAYTE">
        BN.MAYTE LIKE N'%'+#MAYTE#+'%'
      </isNotEmpty>
      <isNotEmpty prepend="AND" property="TENBENHNHAN">
        ISNULL(BN.TENBENHNHAN,CTCT.TENBENHNHAN) LIKE N'%'+#TENBENHNHAN#+'%'
      </isNotEmpty>
      <isNotEmpty prepend="AND" property="NGUOITHU_ID">
        HD.NGUOITHUTIEN_ID = '$NGUOITHU_ID$'
      </isNotEmpty>
      AND HD.DATHANHTOAN = 1
      AND ( (HD.HUYHOADON = 1 AND HD.IDCHUYENHUY IS NULL)
      OR (HD.HOANTRA = 1 AND HD.IDCHUYENHOAN IS NULL)
      )
      AND HD.BENHAN_ID IS NULL
      
      ) HD
      ORDER BY HD.NGAYHOADON , HD.SOHOADON
    </statement>
    <!--Lấy danh sách Viện phí ngoại trú đã chuyển-->
    <statement id="DAO09800_GetMasterVienPhiNgoaiTru_DACHUYEN" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      DECLARE @TENBENHVIEN NVARCHAR(250);
      SELECT  @TENBENHVIEN = VALUE
      FROM    dbo.TM_SYS_APPSETTINGS
      WHERE   BENHVIEN_ID = '$BENHVIEN_ID$'
      AND CODE = 'APP_BENHVIEN_TEN';
      SELECT BTNCHECK = CAST (0 AS BIT) , * FROM (
      SELECT  HD.HOADON_ID ,HD.SOHOADON ,HD.NGAYHOADON ,HD.LOAIHOADON ,HD.TIEPNHAN_ID ,HD.BENHNHAN_ID ,HD.BENHAN_ID ,BN.MAYTE ,TENBENHNHAN = ISNULL(BN.TENBENHNHAN,CTCT.TENBENHNHAN) ,BN.DIACHI ,MASOTHUE = NULL ,HD.SOSERIEVAT ,
      HD.TIENTE_ID ,HD.TYGIA ,GIATRI = HD.GIATRITHUCTHU ,HD.GIATRIVAT ,GIATRICHIETKHAU = CAST(NULL AS NUMERIC(25, 4)) ,HD.GIATRIHOADON ,NT.MANHANVIEN ,NT.TENNHANVIEN ,HD.DATHANHTOAN ,
      PHONGBAN_ID = HD.NOITHUTIEN_ID ,NL.MAPHONGBAN ,NL.TENPHONGBAN ,NL.COSTCENTER_ID ,COSTCENTERCODE = COST.MAPHONGBAN ,COSTCENTERNAME = COST.TENPHONGBAN ,HD.BENHVIEN_ID ,MABENHVIEN = HD.BENHVIEN_ID ,TENBENHVIEN = @TENBENHVIEN ,
      HD.IDCHUYEN ,HOANTRA = '0',HD.IDCHUYENHOAN ,HUYHOADON = '0' ,HD.IDCHUYENHUY ,LOAICHUNGTU = 'TH',TENLOAICHUNGTU = N'THU' ,CHUYENTICHHOP_ID = NULL ,SOBENHAN = NULL ,SOTIEPNHAN = TN.SOTIEPNHAN ,STATUSROW = CAST (0 AS BIT) ,MESSAGEROW = NULL,
      HD.HOADON_CHUNGTU_LIENQUAN_ID, CTCT.KHOXUAT_ID ,CTCT.MAKHOXUAT ,CTCT.TENKHOXUAT ,ISNULL(CTCT.NGUON,'') AS NGUON
      ,TH.THOIGIANCHUYEN
      FROM    dbo.TT_HOADON HD
      JOIN VIEW_IDCHUYENTICHHOP TH on TH.CHUYENTICHHOP_ID = HD.IDCHUYEN
      LEFT JOIN dbo.TT_BENHNHAN BN ON BN.BENHNHAN_ID = HD.BENHNHAN_ID
      LEFT JOIN dbo.TT_TIEPNHAN TN ON HD.TIEPNHAN_ID = TN.TIEPNHAN_ID
      JOIN dbo.TM_NHANVIEN NT ON HD.NGUOITHUTIEN_ID = NT.NHANVIEN_ID
      JOIN dbo.TM_PHONGBAN NL ON HD.NOITHUTIEN_ID = NL.PHONGBAN_ID
      LEFT JOIN dbo.TM_PHONGBAN COST ON NL.COSTCENTER_ID = COST.PHONGBAN_ID
      OUTER APPLY (SELECT  TOP 1 KX.KHODUOC_ID AS KHOXUAT_ID, KX.MAKHO AS MAKHOXUAT, KX.TENKHO AS TENKHOXUAT, NGUON ='MUANGOAI', CT.TenBenhNhan
      FROM dbo.TT_HOADON_CHITIET_NGOAITRU HDCT
      JOIN TT_DUOC_CHUNGTU_CHITIET CTCT ON HDCT.REF_ID = CTCT.CHUNGTUCHITIET_ID
      JOIN dbo.TT_DUOC_CHUNGTU CT ON CT.CHUNGTU_ID = CTCT.CHUNGTU_ID
      JOIN dbo.TM_KHODUOC KX ON CT.KHOXUAT_ID = KX.KHODUOC_ID
      WHERE HDCT.HOADON_ID = HD.HOADON_ID
      AND HDCT.REF_TABLE ='TT_DUOC_CHUNGTU_CHITIET'
      )CTCT
      WHERE   HD.BENHVIEN_ID = '$BENHVIEN_ID$'  AND CAST(HD.NGAYHOADON AS DATE) BETWEEN '$TUNGAY$' AND '$DENNGAY$'
      <isNotEmpty prepend="AND" property="SOHOADON">
        HD.SOHOADON LIKE N'%'+#SOHOADON#+'%'
      </isNotEmpty>
      <isNotEmpty prepend="AND" property="SOTIEPNHAN">
        TN.SOTIEPNHAN LIKE N'%'+#SOTIEPNHAN#+'%'
      </isNotEmpty>
      <isNotEmpty prepend="AND" property="MAYTE">
        BN.MAYTE LIKE N'%'+#MAYTE#+'%'
      </isNotEmpty>
      <isNotEmpty prepend="AND" property="TENBENHNHAN">
        ISNULL(BN.TENBENHNHAN,CTCT.TENBENHNHAN) LIKE N'%'+#TENBENHNHAN#+'%'
      </isNotEmpty>
      <isNotEmpty prepend="AND" property="NGUOITHU_ID">
        HD.NGUOITHUTIEN_ID = '$NGUOITHU_ID$'
      </isNotEmpty>
      AND HD.IDCHUYEN IS NOT NULL
      AND HD.DATHANHTOAN = 1
      AND HD.BENHAN_ID IS NULL
      
      UNION ALL
      
      SELECT  HD.HOADON_ID ,HD.SOHOADON ,HD.NGAYCAPNHAT AS NGAYHOADON ,HD.LOAIHOADON ,HD.TIEPNHAN_ID ,HD.BENHNHAN_ID ,HD.BENHAN_ID ,BN.MAYTE ,TENBENHNHAN = ISNULL(BN.TENBENHNHAN,CTCT.TENBENHNHAN) ,BN.DIACHI ,MASOTHUE = NULL ,HD.SOSERIEVAT ,
      HD.TIENTE_ID ,HD.TYGIA ,GIATRI = HD.GIATRITHUCTHU ,HD.GIATRIVAT ,GIATRICHIETKHAU = CAST(NULL AS NUMERIC(25, 4)) ,HD.GIATRIHOADON ,NT.MANHANVIEN ,NT.TENNHANVIEN ,HD.DATHANHTOAN ,
      PHONGBAN_ID = HD.NOITHUTIEN_ID ,NL.MAPHONGBAN ,NL.TENPHONGBAN ,NL.COSTCENTER_ID ,COSTCENTERCODE = COST.MAPHONGBAN ,COSTCENTERNAME = COST.TENPHONGBAN ,HD.BENHVIEN_ID ,MABENHVIEN = HD.BENHVIEN_ID ,TENBENHVIEN = @TENBENHVIEN ,
      HD.IDCHUYEN ,HD.HOANTRA ,HD.IDCHUYENHOAN ,HD.HUYHOADON ,HD.IDCHUYENHUY ,LOAICHUNGTU = CASE WHEN HD.HUYHOADON = 1 THEN 'HU' ELSE 'HT' END, TENLOAICHUNGTU = CASE WHEN HD.HUYHOADON = 1 THEN N'HỦY' ELSE N'HOÀN TRẢ' END ,CHUYENTICHHOP_ID = NULL ,SOBENHAN = NULL ,SOTIEPNHAN = TN.SOTIEPNHAN ,STATUSROW = CAST (0 AS BIT) ,MESSAGEROW = NULL,
      HD.HOADON_CHUNGTU_LIENQUAN_ID, CTCT.KHOXUAT_ID ,CTCT.MAKHOXUAT ,CTCT.TENKHOXUAT ,ISNULL(CTCT.NGUON,'') AS NGUON
      ,TH.THOIGIANCHUYEN
      FROM    dbo.TT_HOADON HD
      JOIN VIEW_IDCHUYENTICHHOP TH on TH.CHUYENTICHHOP_ID = HD.IDCHUYEN
      LEFT JOIN dbo.TT_BENHNHAN BN ON BN.BENHNHAN_ID = HD.BENHNHAN_ID
      LEFT JOIN dbo.TT_TIEPNHAN TN ON HD.TIEPNHAN_ID = TN.TIEPNHAN_ID
      JOIN dbo.TM_NHANVIEN NT ON HD.NGUOITHUTIEN_ID = NT.NHANVIEN_ID
      JOIN dbo.TM_PHONGBAN NL ON HD.NOITHUTIEN_ID = NL.PHONGBAN_ID
      LEFT JOIN dbo.TM_PHONGBAN COST ON NL.COSTCENTER_ID = COST.PHONGBAN_ID
      OUTER APPLY (SELECT  TOP 1 KX.KHODUOC_ID AS KHOXUAT_ID, KX.MAKHO AS MAKHOXUAT, KX.TENKHO AS TENKHOXUAT, NGUON ='MUANGOAI', CT.TenBenhNhan
      FROM dbo.TT_HOADON_CHITIET_NGOAITRU HDCT
      JOIN TT_DUOC_CHUNGTU_CHITIET CTCT ON HDCT.REF_ID = CTCT.CHUNGTUCHITIET_ID
      JOIN dbo.TT_DUOC_CHUNGTU CT ON CT.CHUNGTU_ID = CTCT.CHUNGTU_ID
      JOIN dbo.TM_KHODUOC KX ON CT.KHOXUAT_ID = KX.KHODUOC_ID
      WHERE HDCT.HOADON_ID = HD.HOADON_ID
      AND HDCT.REF_TABLE ='TT_DUOC_CHUNGTU_CHITIET'
      )CTCT
      WHERE   HD.BENHVIEN_ID = '$BENHVIEN_ID$'  AND CAST(HD.NGAYCAPNHAT AS DATE) BETWEEN '$TUNGAY$' AND '$DENNGAY$'
      <isNotEmpty prepend="AND" property="SOHOADON">
        HD.SOHOADON LIKE N'%'+#SOHOADON#+'%'
      </isNotEmpty>
      <isNotEmpty prepend="AND" property="SOTIEPNHAN">
        TN.SOTIEPNHAN LIKE N'%'+#SOTIEPNHAN#+'%'
      </isNotEmpty>
      <isNotEmpty prepend="AND" property="MAYTE">
        BN.MAYTE LIKE N'%'+#MAYTE#+'%'
      </isNotEmpty>
      <isNotEmpty prepend="AND" property="TENBENHNHAN">
        ISNULL(BN.TENBENHNHAN,CTCT.TENBENHNHAN) LIKE N'%'+#TENBENHNHAN#+'%'
      </isNotEmpty>
      <isNotEmpty prepend="AND" property="NGUOITHU_ID">
        HD.NGUOITHUTIEN_ID = '$NGUOITHU_ID$'
      </isNotEmpty>
      AND HD.DATHANHTOAN = 1
      AND ( (HD.HUYHOADON = 1 AND HD.IDCHUYENHUY IS NOT NULL)
      OR (HD.HOANTRA = 1 AND HD.IDCHUYENHOAN IS NOT NULL)
      )
      AND HD.BENHAN_ID IS NULL
      )HD
      ORDER BY HD.NGAYHOADON , HD.SOHOADON
    </statement>
    <!--Lấy danh sách Viện phí ngoại trú chi tiết-->
    <statement id="DAO09800_GetDetailVienPhiNgoaiTru" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
     SELECT  TICHHOP_ID = NULL ,
      HDCT.HOADONCHITIET_ID ,
      HD.HOADON_ID ,
      MAKHOANMUCDT = NULL ,
      TENKHOANMUCDT = NULL ,
      LD.LOAIVATTU_ID,
      LD.MALOAIDUOC ,
      LD.TENLOAIDUOC ,
      D.MADUOC ,
      TENDUOC = D.TENDUOCDAYDU ,
      MALOAIDICHVU = COALESCE(LDV.MALOAIDICHVU, LKPA.MALOAIKHAUPHANAN, THE.MATHETHANHVIEN, LG.Dictionary_Code)  ,
      TENLOAIDICHVU = COALESCE(LDV.TENLOAIDICHVU, LKPA.TENLOAIKHAUPHANAN, THE.TENTHETHANHVIEN, LG.Dictionary_Name) ,
      MANHOMDICHVU = COALESCE(NDV.MANHOMDICHVU, LKPA.TENLOAIKHAUPHANAN, THE.MATHETHANHVIEN, LG.Dictionary_Code),
      TENNHOMDICHVU = COALESCE(NDV.TENNHOMDICHVU, LKPA.TENLOAIKHAUPHANAN, THE.TENTHETHANHVIEN, LG.Dictionary_Name),
      MADICHVU = COALESCE(DV.MADICHVU, KPA.MAKHAUPHANAN, THE.TENTHETHANHVIEN, GOI.MAGOI),
      TENDICHVU = COALESCE(DV.TENDICHVU, KPA.TENKHAUPHANAN, THE.MATHETHANHVIEN, GOI.TENGOI),
      DONVITINH = CASE WHEN D.DUOC_ID IS NOT NULL THEN D.DONVITINH
      WHEN DV.DICHVU_ID IS NOT NULL THEN DV.DONVITINH
	  WHEN THE.MATHETHANHVIEN IS NOT NULL THEN N'THẺ'
	  WHEN GOI.MAGOI IS NOT NULL THEN N'GÓI'
      ELSE N'PHẦN' END ,
      HDCT.SOLUONG,
      DONGIAVON = HDCT.DONGIA_DOANHTHU,
      DONGIADOANHTHU = HDCT.DONGIA_DOANHTHU ,
      THANHTIENVON = HDCT.THANHTIEN_DOANHTHU,
      THANHTIENDOANHTHU = HDCT.THANHTIEN_DOANHTHU,
      HDCT.TYLEVAT ,
      HDCT.GIATRIVAT ,
      GIATRICHIETKHAU = CAST(NULL AS NUMERIC(25,4)),
      GIATRIHOADON = HDCT.GIATRI_HOADON ,
      LOAINOIDUNG = CASE WHEN D.DUOC_ID IS NOT NULL THEN 'DU'
      WHEN DV.DICHVU_ID IS NOT NULL THEN 'DV'
	  WHEN THE.MATHETHANHVIEN IS NOT NULL THEN N'THE'
	  WHEN GOI.MAGOI IS NOT NULL THEN N'GOI'
      ELSE 'SA'END
      FROM    dbo.TT_HOADON HD
      JOIN dbo.TT_HOADON_CHITIET_NGOAITRU HDCT ON HDCT.HOADON_ID = HD.HOADON_ID
      JOIN dbo.TT_VIENPHI VP ON VP.VIENPHI_ID = HDCT.VIENPHI_ID
      LEFT JOIN dbo.TM_DICHVU DV ON VP.DICHVU_ID = DV.DICHVU_ID AND VP.DICHVU_ID IS NOT NULL and VP.REF_TABLE ='TT_DVYEUCAU'
      LEFT JOIN dbo.TM_NHOMDICHVU NDV ON NDV.NHOMDICHVU_ID = DV.NHOMDICHVU_ID
      LEFT JOIN dbo.TM_LOAIDICHVU LDV ON LDV.LOAIDICHVU_ID = NDV.LOAIDICHVU_ID

      LEFT JOIN dbo.TM_DUOC D ON VP.DUOC_ID = D.DUOC_ID AND VP.DUOC_ID IS NOT NULL
      LEFT JOIN dbo.TM_LOAIDUOC LD ON D.LOAIDUOC_ID = LD.LOAIDUOC_ID

      LEFT JOIN dbo.TT_NUT_XACNHANSUATAN_CHITIET XACT ON HDCT.REF_ID = XACT.XACNHANSUATANCHITIET_ID AND HDCT.REF_TABLE = 'TT_NUT_XACNHANSUATAN_CHITIET'
      LEFT JOIN dbo.TT_NUT_CHIDINHKHAUPHAN_CHITIET CDCT ON CDCT.CHIDINHKHAUPHANCHITIET_ID = XACT.CHIDINHKHAUPHANCHITIET_ID
      LEFT JOIN dbo.TM_NUT_KHAUPHANAN KPA ON KPA.KHAUPHANAN_ID = CDCT.KHAUPHANAN_ID
      LEFT JOIN dbo.TM_NUT_LOAIKHAUPHANAN LKPA ON LKPA.LOAIKHAUPHANAN_ID = KPA.LOAIKHAUPHANAN_ID

	  LEFT JOIN dbo.TM_CSKH_THETHANHVIEN THE ON VP.DICHVU_ID = THE.THETHANHVIEN_ID AND VP.DICHVU_ID IS NOT NULL and VP.REF_TABLE ='TT_CSKH_THANHVIEN_CAPTHE'
	  LEFT JOIN dbo.TM_CSKH_GOI GOI ON VP.DICHVU_ID = GOI.GOI_ID AND VP.DICHVU_ID IS NOT NULL and VP.REF_TABLE ='TT_CSKH_GOI_DANGKY'
	  LEFT JOIN Lst_Dictionary LG on GOI.LOAIGOI_ID = lg.Dictionary_Id
      WHERE   HD.HOADON_ID = '$HOADON_ID$'
    </statement>
    <!--Lấy danh sách Viện phí ngoại trú - Hình thức thanh toán-->
    <statement id="DAO09800_GetDetailVienPhiNgoaiTru_HTTT" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      SELECT  TICHHOP_ID = NULL ,
      HTTT.HOADON_ID ,
      MAHINHTHUCTHANHTOAN = HT.DICTIONARY_CODE ,
      TENHINHTHUCTHANHTOAN = HT.DICTIONARY_NAME ,
      GIATRI = HTTT.GIATRITHUCTHU
      FROM    dbo.TT_HOADON_HINHTHUCTHANHTOAN HTTT
      LEFT JOIN dbo.LST_DICTIONARY HT ON HTTT.HINHTHUCTHANHTOAN_ID = HT.DICTIONARY_ID
      WHERE   HTTT.HOADON_ID = '$HOADON_ID$'
    </statement>


    <!--Lấy danh sách Viện phí nội trú-->
    <statement id="DAO09800_GetMasterVienPhiNoiTru" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      DECLARE @TENBENHVIEN NVARCHAR(250);
      SELECT  @TENBENHVIEN = VALUE
      FROM    dbo.TM_SYS_APPSETTINGS
      WHERE   BENHVIEN_ID = '$BENHVIEN_ID$'
      AND CODE = 'APP_BENHVIEN_TEN';
      SELECT BTNCHECK = CAST (0 AS BIT) ,* FROM (
      SELECT  HD.HOADON_ID ,HD.SOHOADON ,HD.NGAYHOADON ,HD.LOAIHOADON ,HD.TIEPNHAN_ID ,HD.BENHNHAN_ID ,HD.BENHAN_ID ,BN.MAYTE ,BN.TENBENHNHAN ,BN.DIACHI ,MASOTHUE = NULL ,HD.SOSERIEVAT ,
      HD.TIENTE_ID ,HD.TYGIA ,GIATRI = HD.GIATRITHUCTHU ,HD.GIATRIVAT ,GIATRICHIETKHAU = CAST(NULL AS NUMERIC(25, 4)) ,HD.GIATRIHOADON ,NT.MANHANVIEN ,NT.TENNHANVIEN ,HD.DATHANHTOAN ,
      PHONGBAN_ID = HD.NOITHUTIEN_ID ,NL.MAPHONGBAN ,NL.TENPHONGBAN ,NL.COSTCENTER_ID ,COSTCENTERCODE = COST.MAPHONGBAN ,COSTCENTERNAME = COST.TENPHONGBAN ,HD.BENHVIEN_ID ,MABENHVIEN = HD.BENHVIEN_ID ,TENBENHVIEN = @TENBENHVIEN ,
      HD.IDCHUYEN ,HOANTRA = '0',HD.IDCHUYENHOAN ,HUYHOADON = '0',HD.IDCHUYENHUY ,LOAICHUNGTU = 'TH',TENLOAICHUNGTU = N'THU' ,CHUYENTICHHOP_ID = NULL ,SOBENHAN = BA.SOBENHAN ,SOTIEPNHAN = TN.SOTIEPNHAN ,STATUSROW = CAST (0 AS BIT) ,MESSAGEROW = NULL,
      HD.HOADON_CHUNGTU_LIENQUAN_ID, CTCT.KHOXUAT_ID ,CTCT.MAKHOXUAT ,CTCT.TENKHOXUAT ,ISNULL(CTCT.NGUON,'') AS NGUON
      FROM    dbo.TT_HOADON HD
      JOIN dbo.TT_BENHNHAN BN ON BN.BENHNHAN_ID = HD.BENHNHAN_ID
      JOIN dbo.TT_NOITRU_BENHAN BA ON HD.BENHAN_ID = BA.BENHAN_ID
      JOIN dbo.TT_TIEPNHAN TN ON TN.TIEPNHAN_ID = BA.TIEPNHAN_ID
      JOIN dbo.TM_NHANVIEN NT ON HD.NGUOITHUTIEN_ID = NT.NHANVIEN_ID
      JOIN dbo.TM_PHONGBAN NL ON HD.NOITHUTIEN_ID = NL.PHONGBAN_ID
      LEFT JOIN dbo.TM_PHONGBAN COST ON NL.COSTCENTER_ID = COST.PHONGBAN_ID
      OUTER APPLY (SELECT  TOP 1 KX.KHODUOC_ID AS KHOXUAT_ID, KX.MAKHO AS MAKHOXUAT, KX.TENKHO AS TENKHOXUAT, NGUON ='MUANGOAI'
      FROM dbo.TT_HOADON_CHITIET_NOITRU HDCT
      JOIN TT_DUOC_CHUNGTU_CHITIET CTCT ON HDCT.REF_ID = CTCT.CHUNGTUCHITIET_ID
      JOIN dbo.TT_DUOC_CHUNGTU CT ON CT.CHUNGTU_ID = CTCT.CHUNGTU_ID
      JOIN dbo.TM_KHODUOC KX ON CT.KHOXUAT_ID = KX.KHODUOC_ID
      WHERE HDCT.HOADON_ID = HD.HOADON_ID
      AND HDCT.REF_TABLE ='TT_DUOC_CHUNGTU_CHITIET'
      )CTCT
      WHERE   HD.BENHVIEN_ID = '$BENHVIEN_ID$'  AND CAST(HD.NGAYHOADON AS DATE) BETWEEN '$TUNGAY$' AND '$DENNGAY$'
      <isNotEmpty prepend="AND" property="SOHOADON">
        HD.SOHOADON LIKE N'%'+#SOHOADON#+'%'
      </isNotEmpty>
      <isNotEmpty prepend="AND" property="SOTIEPNHAN">
        TN.SOTIEPNHAN LIKE N'%'+#SOTIEPNHAN#+'%'
      </isNotEmpty>
      <isNotEmpty prepend="AND" property="MAYTE">
        BN.MAYTE LIKE N'%'+#MAYTE#+'%'
      </isNotEmpty>
      <isNotEmpty prepend="AND" property="TENBENHNHAN">
        BN.TENBENHNHAN LIKE N'%'+#TENBENHNHAN#+'%'
      </isNotEmpty>
      <isNotEmpty prepend="AND" property="NGUOITHU_ID">
        HD.NGUOITHUTIEN_ID = '$NGUOITHU_ID$'
      </isNotEmpty>
      AND HD.IDCHUYEN IS NULL
      AND (HD.DATHANHTOAN = 1 and HD.TRANGTHAI != 'DADUYETCONGNO')
      AND HD.BENHAN_ID IS NOT NULL
      UNION ALL
      SELECT  HD.HOADON_ID ,HD.SOHOADON ,HD.NGAYCAPNHAT AS NGAYHOADON ,HD.LOAIHOADON ,HD.TIEPNHAN_ID ,HD.BENHNHAN_ID ,HD.BENHAN_ID ,BN.MAYTE ,BN.TENBENHNHAN ,BN.DIACHI ,MASOTHUE = NULL ,HD.SOSERIEVAT ,
      HD.TIENTE_ID ,HD.TYGIA ,GIATRI = HD.GIATRITHUCTHU ,HD.GIATRIVAT ,GIATRICHIETKHAU = CAST(NULL AS NUMERIC(25, 4)) ,HD.GIATRIHOADON ,NT.MANHANVIEN ,NT.TENNHANVIEN ,HD.DATHANHTOAN ,
      PHONGBAN_ID = HD.NOITHUTIEN_ID ,NL.MAPHONGBAN ,NL.TENPHONGBAN ,NL.COSTCENTER_ID ,COSTCENTERCODE = COST.MAPHONGBAN ,COSTCENTERNAME = COST.TENPHONGBAN ,HD.BENHVIEN_ID ,MABENHVIEN = HD.BENHVIEN_ID ,TENBENHVIEN = @TENBENHVIEN ,
      HD.IDCHUYEN ,HD.HOANTRA ,HD.IDCHUYENHOAN ,HD.HUYHOADON ,HD.IDCHUYENHUY ,LOAICHUNGTU = CASE WHEN HD.HUYHOADON = 1 THEN 'HU' ELSE 'HT' END, TENLOAICHUNGTU = CASE WHEN HD.HUYHOADON = 1 THEN N'HỦY' ELSE N'HOÀN TRẢ' END ,CHUYENTICHHOP_ID = NULL ,SOBENHAN = BA.SOBENHAN ,SOTIEPNHAN = TN.SOTIEPNHAN ,STATUSROW = CAST (0 AS BIT) ,MESSAGEROW = NULL,
      HD.HOADON_CHUNGTU_LIENQUAN_ID, CTCT.KHOXUAT_ID ,CTCT.MAKHOXUAT ,CTCT.TENKHOXUAT ,ISNULL(CTCT.NGUON,'') AS NGUON
      FROM    dbo.TT_HOADON HD
      JOIN dbo.TT_BENHNHAN BN ON BN.BENHNHAN_ID = HD.BENHNHAN_ID
      JOIN dbo.TT_NOITRU_BENHAN BA ON HD.BENHAN_ID = BA.BENHAN_ID
      JOIN dbo.TT_TIEPNHAN TN ON TN.TIEPNHAN_ID = BA.TIEPNHAN_ID
      JOIN dbo.TM_NHANVIEN NT ON HD.NGUOITHUTIEN_ID = NT.NHANVIEN_ID
      JOIN dbo.TM_PHONGBAN NL ON HD.NOITHUTIEN_ID = NL.PHONGBAN_ID
      LEFT JOIN dbo.TM_PHONGBAN COST ON NL.COSTCENTER_ID = COST.PHONGBAN_ID
      OUTER APPLY (SELECT  TOP 1 KX.KHODUOC_ID AS KHOXUAT_ID, KX.MAKHO AS MAKHOXUAT, KX.TENKHO AS TENKHOXUAT, NGUON ='MUANGOAI'
      FROM dbo.TT_HOADON_CHITIET_NOITRU HDCT
      JOIN TT_DUOC_CHUNGTU_CHITIET CTCT ON HDCT.REF_ID = CTCT.CHUNGTUCHITIET_ID
      JOIN dbo.TT_DUOC_CHUNGTU CT ON CT.CHUNGTU_ID = CTCT.CHUNGTU_ID
      JOIN dbo.TM_KHODUOC KX ON CT.KHOXUAT_ID = KX.KHODUOC_ID
      WHERE HDCT.HOADON_ID = HD.HOADON_ID
      AND HDCT.REF_TABLE ='TT_DUOC_CHUNGTU_CHITIET'
      )CTCT
      WHERE   HD.BENHVIEN_ID = '$BENHVIEN_ID$'  AND CAST(HD.NGAYCAPNHAT AS DATE) BETWEEN '$TUNGAY$' AND '$DENNGAY$'
      <isNotEmpty prepend="AND" property="SOHOADON">
        HD.SOHOADON LIKE N'%'+#SOHOADON#+'%'
      </isNotEmpty>
      <isNotEmpty prepend="AND" property="SOTIEPNHAN">
        TN.SOTIEPNHAN LIKE N'%'+#SOTIEPNHAN#+'%'
      </isNotEmpty>
      <isNotEmpty prepend="AND" property="MAYTE">
        BN.MAYTE LIKE N'%'+#MAYTE#+'%'
      </isNotEmpty>
      <isNotEmpty prepend="AND" property="TENBENHNHAN">
        BN.TENBENHNHAN LIKE N'%'+#TENBENHNHAN#+'%'
      </isNotEmpty>
      <isNotEmpty prepend="AND" property="NGUOITHU_ID">
        HD.NGUOITHUTIEN_ID = '$NGUOITHU_ID$'
      </isNotEmpty>
      AND (HD.DATHANHTOAN = 1 and HD.TRANGTHAI != 'DADUYETCONGNO')
      AND ( (HD.HUYHOADON = 1 AND HD.IDCHUYENHUY IS NULL)
      OR (HD.HOANTRA = 1 AND HD.IDCHUYENHOAN IS NULL)
      )
      AND HD.BENHAN_ID IS NOT NULL
      ) HD
      ORDER BY HD.NGAYHOADON , HD.SOHOADON
    </statement>
    <!--Lấy danh sách Viện phí nội trú đã chuyển-->
    <statement id="DAO09800_GetMasterVienPhiNoiTru_DACHUYEN" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      DECLARE @TENBENHVIEN NVARCHAR(250);
      SELECT  @TENBENHVIEN = VALUE
      FROM    dbo.TM_SYS_APPSETTINGS
      WHERE   BENHVIEN_ID = '$BENHVIEN_ID$'
      AND CODE = 'APP_BENHVIEN_TEN';
      SELECT BTNCHECK = CAST (0 AS BIT) ,* FROM (
      SELECT  HD.HOADON_ID ,HD.SOHOADON ,HD.NGAYHOADON ,HD.LOAIHOADON ,HD.TIEPNHAN_ID ,HD.BENHNHAN_ID ,HD.BENHAN_ID ,BN.MAYTE ,BN.TENBENHNHAN ,BN.DIACHI ,MASOTHUE = NULL ,HD.SOSERIEVAT ,
      HD.TIENTE_ID ,HD.TYGIA ,GIATRI = HD.GIATRITHUCTHU ,HD.GIATRIVAT ,GIATRICHIETKHAU = CAST(NULL AS NUMERIC(25, 4)) ,HD.GIATRIHOADON ,NT.MANHANVIEN ,NT.TENNHANVIEN ,HD.DATHANHTOAN ,
      PHONGBAN_ID = HD.NOITHUTIEN_ID ,NL.MAPHONGBAN ,NL.TENPHONGBAN ,NL.COSTCENTER_ID ,COSTCENTERCODE = COST.MAPHONGBAN ,COSTCENTERNAME = COST.TENPHONGBAN ,HD.BENHVIEN_ID ,MABENHVIEN = HD.BENHVIEN_ID ,TENBENHVIEN = @TENBENHVIEN ,
      HD.IDCHUYEN ,HOANTRA = '0',HD.IDCHUYENHOAN ,HUYHOADON = '0',HD.IDCHUYENHUY ,LOAICHUNGTU = 'TH',TENLOAICHUNGTU = N'THU' ,CHUYENTICHHOP_ID = NULL ,SOBENHAN = BA.SOBENHAN ,SOTIEPNHAN = TN.SOTIEPNHAN ,STATUSROW = CAST (0 AS BIT) ,MESSAGEROW = NULL,
      HD.HOADON_CHUNGTU_LIENQUAN_ID, CTCT.KHOXUAT_ID ,CTCT.MAKHOXUAT ,CTCT.TENKHOXUAT ,ISNULL(CTCT.NGUON,'') AS NGUON
      ,TH.THOIGIANCHUYEN
      FROM    dbo.TT_HOADON HD
      JOIN VIEW_IDCHUYENTICHHOP TH on TH.CHUYENTICHHOP_ID = HD.IDCHUYEN
      JOIN dbo.TT_BENHNHAN BN ON BN.BENHNHAN_ID = HD.BENHNHAN_ID
      JOIN dbo.TT_NOITRU_BENHAN BA ON HD.BENHAN_ID = BA.BENHAN_ID
      JOIN dbo.TT_TIEPNHAN TN ON TN.TIEPNHAN_ID = BA.TIEPNHAN_ID
      JOIN dbo.TM_NHANVIEN NT ON HD.NGUOITHUTIEN_ID = NT.NHANVIEN_ID
      JOIN dbo.TM_PHONGBAN NL ON HD.NOITHUTIEN_ID = NL.PHONGBAN_ID
      LEFT JOIN dbo.TM_PHONGBAN COST ON NL.COSTCENTER_ID = COST.PHONGBAN_ID
      OUTER APPLY (SELECT  TOP 1 KX.KHODUOC_ID AS KHOXUAT_ID, KX.MAKHO AS MAKHOXUAT, KX.TENKHO AS TENKHOXUAT, NGUON ='MUANGOAI'
      FROM dbo.TT_HOADON_CHITIET_NOITRU HDCT
      JOIN TT_DUOC_CHUNGTU_CHITIET CTCT ON HDCT.REF_ID = CTCT.CHUNGTUCHITIET_ID
      JOIN dbo.TT_DUOC_CHUNGTU CT ON CT.CHUNGTU_ID = CTCT.CHUNGTU_ID
      JOIN dbo.TM_KHODUOC KX ON CT.KHOXUAT_ID = KX.KHODUOC_ID
      WHERE HDCT.HOADON_ID = HD.HOADON_ID
      AND HDCT.REF_TABLE ='TT_DUOC_CHUNGTU_CHITIET'
      )CTCT
      WHERE   HD.BENHVIEN_ID = '$BENHVIEN_ID$'  AND CAST(HD.NGAYHOADON AS DATE) BETWEEN '$TUNGAY$' AND '$DENNGAY$'
      <isNotEmpty prepend="AND" property="SOHOADON">
        HD.SOHOADON LIKE N'%'+#SOHOADON#+'%'
      </isNotEmpty>
      <isNotEmpty prepend="AND" property="SOTIEPNHAN">
        TN.SOTIEPNHAN LIKE N'%'+#SOTIEPNHAN#+'%'
      </isNotEmpty>
      <isNotEmpty prepend="AND" property="MAYTE">
        BN.MAYTE LIKE N'%'+#MAYTE#+'%'
      </isNotEmpty>
      <isNotEmpty prepend="AND" property="TENBENHNHAN">
        BN.TENBENHNHAN LIKE N'%'+#TENBENHNHAN#+'%'
      </isNotEmpty>
      <isNotEmpty prepend="AND" property="NGUOITHU_ID">
        HD.NGUOITHUTIEN_ID = '$NGUOITHU_ID$'
      </isNotEmpty>
      AND HD.IDCHUYEN IS NOT NULL
      AND HD.DATHANHTOAN = 1
      AND HD.BENHAN_ID IS NOT NULL
      
      UNION ALL
      
      SELECT  HD.HOADON_ID ,HD.SOHOADON ,HD.NGAYCAPNHAT AS NGAYHOADON ,HD.LOAIHOADON ,HD.TIEPNHAN_ID ,HD.BENHNHAN_ID ,HD.BENHAN_ID ,BN.MAYTE ,BN.TENBENHNHAN ,BN.DIACHI ,MASOTHUE = NULL ,HD.SOSERIEVAT ,
      HD.TIENTE_ID ,HD.TYGIA ,GIATRI = HD.GIATRITHUCTHU ,HD.GIATRIVAT ,GIATRICHIETKHAU = CAST(NULL AS NUMERIC(25, 4)) ,HD.GIATRIHOADON ,NT.MANHANVIEN ,NT.TENNHANVIEN ,HD.DATHANHTOAN ,
      PHONGBAN_ID = HD.NOITHUTIEN_ID ,NL.MAPHONGBAN ,NL.TENPHONGBAN ,NL.COSTCENTER_ID ,COSTCENTERCODE = COST.MAPHONGBAN ,COSTCENTERNAME = COST.TENPHONGBAN ,HD.BENHVIEN_ID ,MABENHVIEN = HD.BENHVIEN_ID ,TENBENHVIEN = @TENBENHVIEN ,
      HD.IDCHUYEN ,HD.HOANTRA ,HD.IDCHUYENHOAN ,HD.HUYHOADON ,HD.IDCHUYENHUY ,LOAICHUNGTU = CASE WHEN HD.HUYHOADON = 1 THEN 'HU' ELSE 'HT' END, TENLOAICHUNGTU = CASE WHEN HD.HUYHOADON = 1 THEN N'HỦY' ELSE N'HOÀN TRẢ' END ,CHUYENTICHHOP_ID = NULL ,SOBENHAN = BA.SOBENHAN ,SOTIEPNHAN = TN.SOTIEPNHAN ,STATUSROW = CAST (0 AS BIT) ,MESSAGEROW = NULL,
      HD.HOADON_CHUNGTU_LIENQUAN_ID, CTCT.KHOXUAT_ID ,CTCT.MAKHOXUAT ,CTCT.TENKHOXUAT ,ISNULL(CTCT.NGUON,'') AS NGUON
      ,TH.THOIGIANCHUYEN
      FROM    dbo.TT_HOADON HD
      JOIN VIEW_IDCHUYENTICHHOP TH on TH.CHUYENTICHHOP_ID = HD.IDCHUYEN
      JOIN dbo.TT_BENHNHAN BN ON BN.BENHNHAN_ID = HD.BENHNHAN_ID
      JOIN dbo.TT_NOITRU_BENHAN BA ON HD.BENHAN_ID = BA.BENHAN_ID
      JOIN dbo.TT_TIEPNHAN TN ON TN.TIEPNHAN_ID = BA.TIEPNHAN_ID
      JOIN dbo.TM_NHANVIEN NT ON HD.NGUOITHUTIEN_ID = NT.NHANVIEN_ID
      JOIN dbo.TM_PHONGBAN NL ON HD.NOITHUTIEN_ID = NL.PHONGBAN_ID
      LEFT JOIN dbo.TM_PHONGBAN COST ON NL.COSTCENTER_ID = COST.PHONGBAN_ID
      OUTER APPLY (SELECT  TOP 1 KX.KHODUOC_ID AS KHOXUAT_ID, KX.MAKHO AS MAKHOXUAT, KX.TENKHO AS TENKHOXUAT, NGUON ='MUANGOAI'
      FROM dbo.TT_HOADON_CHITIET_NOITRU HDCT
      JOIN TT_DUOC_CHUNGTU_CHITIET CTCT ON HDCT.REF_ID = CTCT.CHUNGTUCHITIET_ID
      JOIN dbo.TT_DUOC_CHUNGTU CT ON CT.CHUNGTU_ID = CTCT.CHUNGTU_ID
      JOIN dbo.TM_KHODUOC KX ON CT.KHOXUAT_ID = KX.KHODUOC_ID
      WHERE HDCT.HOADON_ID = HD.HOADON_ID
      AND HDCT.REF_TABLE ='TT_DUOC_CHUNGTU_CHITIET'
      )CTCT
      WHERE   HD.BENHVIEN_ID = '$BENHVIEN_ID$'  AND CAST(HD.NGAYCAPNHAT AS DATE) BETWEEN '$TUNGAY$' AND '$DENNGAY$'
      <isNotEmpty prepend="AND" property="SOHOADON">
        HD.SOHOADON LIKE N'%'+#SOHOADON#+'%'
      </isNotEmpty>
      <isNotEmpty prepend="AND" property="SOTIEPNHAN">
        TN.SOTIEPNHAN LIKE N'%'+#SOTIEPNHAN#+'%'
      </isNotEmpty>
      <isNotEmpty prepend="AND" property="MAYTE">
        BN.MAYTE LIKE N'%'+#MAYTE#+'%'
      </isNotEmpty>
      <isNotEmpty prepend="AND" property="TENBENHNHAN">
        BN.TENBENHNHAN LIKE N'%'+#TENBENHNHAN#+'%'
      </isNotEmpty>
      <isNotEmpty prepend="AND" property="NGUOITHU_ID">
        HD.NGUOITHUTIEN_ID = '$NGUOITHU_ID$'
      </isNotEmpty>
      AND HD.DATHANHTOAN = 1
      AND ( (HD.HUYHOADON = 1 AND HD.IDCHUYENHUY IS NOT NULL)
      OR (HD.HOANTRA = 1 AND HD.IDCHUYENHOAN IS NOT NULL)
      )
      AND HD.BENHAN_ID IS NOT NULL
      ) HD
      ORDER BY HD.NGAYHOADON , HD.SOHOADON
    </statement>
    <!--Lấy danh sách Viện phí ngoại trú chi tiết-->
    <statement id="DAO09800_GetDetailVienPhiNoiTru" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      SELECT  TICHHOP_ID = NULL ,
      HDCT.HOADON_CHITIET_NOITRU_ID AS HOADONCHITIET_ID ,
      HD.HOADON_ID ,
      MAKHOANMUCDT = NULL ,
      TENKHOANMUCDT = NULL ,
      LD.LOAIVATTU_ID,
      LD.MALOAIDUOC ,
      LD.TENLOAIDUOC ,
      D.MADUOC ,
      TENDUOC = D.TENDUOCDAYDU ,
      MALOAIDICHVU = COALESCE(LDV.MALOAIDICHVU, LKPA.MALOAIKHAUPHANAN)  ,
      TENLOAIDICHVU = COALESCE(LDV.TENLOAIDICHVU, LKPA.TENLOAIKHAUPHANAN) ,
      MANHOMDICHVU = COALESCE(NDV.MANHOMDICHVU, LKPA.TENLOAIKHAUPHANAN),
      TENNHOMDICHVU = COALESCE(NDV.TENNHOMDICHVU, LKPA.TENLOAIKHAUPHANAN),
      MADICHVU = COALESCE(DV.MADICHVU, KPA.MAKHAUPHANAN),
      TENDICHVU = COALESCE(DV.TENDICHVU, KPA.TENKHAUPHANAN),
      DONVITINH = CASE WHEN D.DUOC_ID IS NOT NULL THEN D.DONVITINH
      WHEN DV.DICHVU_ID IS NOT NULL THEN DV.DONVITINH
      ELSE N'PHẦN' END ,
      HDCT.SOLUONG,
      DONGIAVON = HDCT.DONGIA_DOANHTHU,
      DONGIADOANHTHU = HDCT.DONGIA_DOANHTHU ,
      THANHTIENVON = HDCT.THANHTIEN_DOANHTHU,
      THANHTIENDOANHTHU = HDCT.THANHTIEN_DOANHTHU,
      HDCT.TYLEVAT ,
      HDCT.GIATRIVAT ,
      GIATRICHIETKHAU = CAST(NULL AS NUMERIC(25,4)),
      GIATRIHOADON = HDCT.GIATRI_HOADON ,
      LOAINOIDUNG = CASE WHEN D.DUOC_ID IS NOT NULL THEN 'DU'
      WHEN DV.DICHVU_ID IS NOT NULL THEN 'DV'
      ELSE 'SA'END
      FROM    dbo.TT_HOADON HD
      JOIN dbo.TT_HOADON_CHITIET_NOITRU HDCT ON HDCT.HOADON_ID = HD.HOADON_ID
      JOIN dbo.TT_VIENPHI VP ON VP.VIENPHI_ID = HDCT.VIENPHI_ID
      LEFT JOIN dbo.TM_DICHVU DV ON VP.DICHVU_ID = DV.DICHVU_ID AND VP.DICHVU_ID IS NOT NULL
      LEFT JOIN dbo.TM_NHOMDICHVU NDV ON NDV.NHOMDICHVU_ID = DV.NHOMDICHVU_ID
      LEFT JOIN dbo.TM_LOAIDICHVU LDV ON LDV.LOAIDICHVU_ID = NDV.LOAIDICHVU_ID

      LEFT JOIN dbo.TM_DUOC D ON VP.DUOC_ID = D.DUOC_ID AND VP.DUOC_ID IS NOT NULL
      LEFT JOIN dbo.TM_LOAIDUOC LD ON D.LOAIDUOC_ID = LD.LOAIDUOC_ID

      LEFT JOIN dbo.TT_NUT_XACNHANSUATAN_CHITIET XACT ON HDCT.REF_ID = XACT.XACNHANSUATANCHITIET_ID AND HDCT.REF_TABLE = 'TT_NUT_XACNHANSUATAN_CHITIET'
      LEFT JOIN dbo.TT_NUT_CHIDINHKHAUPHAN_CHITIET CDCT ON CDCT.CHIDINHKHAUPHANCHITIET_ID = XACT.CHIDINHKHAUPHANCHITIET_ID
      LEFT JOIN dbo.TM_NUT_KHAUPHANAN KPA ON KPA.KHAUPHANAN_ID = CDCT.KHAUPHANAN_ID
      LEFT JOIN dbo.TM_NUT_LOAIKHAUPHANAN LKPA ON LKPA.LOAIKHAUPHANAN_ID = KPA.LOAIKHAUPHANAN_ID
      WHERE   HD.HOADON_ID = '$HOADON_ID$'
    </statement>
    <!--Lấy danh sách Viện phí ngoại trú - Hình thức thanh toán-->
    <statement id="DAO09800_GetDetailVienPhiNoiTru_HTTT" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      SELECT  TICHHOP_ID = NULL ,
      HTTT.HOADON_ID ,
      MAHINHTHUCTHANHTOAN = HT.DICTIONARY_CODE ,
      TENHINHTHUCTHANHTOAN = HT.DICTIONARY_NAME ,
      GIATRI = HTTT.GIATRITHUCTHU
      FROM    dbo.TT_HOADON_HINHTHUCTHANHTOAN HTTT
      LEFT JOIN dbo.LST_DICTIONARY HT ON HTTT.HINHTHUCTHANHTOAN_ID = HT.DICTIONARY_ID
      WHERE   HTTT.HOADON_ID = '$HOADON_ID$'
    </statement>

    
    <!--Cập nhật IDChuyen vào bảng TT_HOADON-->
    <update id="DAO09800_UpdateHoaDon_IDChuyen" parameterClass="System.Collections.IDictionary">
      UPDATE dbo.TT_HOADON SET IDCHUYEN = #CHUYENTICHHOP_ID#  WHERE HOADON_ID = '$HOADON_ID$'
    </update>
    <!--Cập nhật IDCHUYENHUY vào bảng TT_HOADON-->
    <update id="DAO09800_UpdateHoaDon_IDCHUYENHUY" parameterClass="System.Collections.IDictionary">
      UPDATE dbo.TT_HOADON SET IDCHUYENHUY = #CHUYENTICHHOP_ID#  WHERE HOADON_ID = '$HOADON_ID$'
    </update>
    <!--Cập nhật IDCHUYENHOAN vào bảng TT_HOADON-->
    <update id="DAO09800_UpdateHoaDon_IDCHUYENHOAN" parameterClass="System.Collections.IDictionary">
      UPDATE dbo.TT_HOADON SET IDCHUYENHOAN = #CHUYENTICHHOP_ID#  WHERE HOADON_ID = '$HOADON_ID$'
    </update>

    <!--Kiểm tra xem Biên lai viện phí đã được chuyển lên db trung gian chưa-->
    <statement id="DAO09800_KiemTraVienPhiDaChuyen" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      SELECT  1
      FROM    dbo.TT_HOADON
      WHERE   BENHVIEN_ID = '$BENHVIEN_ID$'
      AND HOADON_ID = '$HOADON_ID$'
      AND IDCHUYEN IS NOT NULL;
    </statement>
    <!--Kiểm tra xem Biên lai viện phí hủy đã được chuyển lên db trung gian chưa-->
    <statement id="DAO09800_KiemTraVienPhiHuyDaChuyen" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      SELECT  1
      FROM    dbo.TT_HOADON
      WHERE   BENHVIEN_ID = '$BENHVIEN_ID$'
      AND HOADON_ID = '$HOADON_ID$'
      AND IDCHUYENHUY IS NOT NULL;
    </statement>
    <!--Kiểm tra xem Biên lai viện phí hoàn đã được chuyển lên db trung gian chưa-->
    <statement id="DAO09800_KiemTraVienPhiHoanDaChuyen" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      SELECT  1
      FROM    dbo.TT_HOADON
      WHERE   BENHVIEN_ID = '$BENHVIEN_ID$'
      AND HOADON_ID = '$HOADON_ID$'
      AND IDCHUYENHOAN IS NOT NULL;
    </statement>
    
    <!--============================================END VIỆN PHÍ=============================================-->

    <!--============================================BEGIN VIỆN PHÍ - BÁN THUỐC TẠI QUẦY=============================================-->
    <!--Lấy danh sách doanh thu bán thuốc tại quầy-->
    <statement id="DAO09800_GetMasterDoanhThuBanThuocTaiQuay" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      DECLARE @TENBENHVIEN NVARCHAR(250);
      SELECT  @TENBENHVIEN = VALUE
      FROM    dbo.TM_SYS_APPSETTINGS
      WHERE   BENHVIEN_ID = '$BENHVIEN_ID$'
      AND CODE = 'APP_BENHVIEN_TEN';

      SELECT
      BTNCHECK = CAST (0 AS BIT),HOADON_ID ,HD.SOHOADON ,NGAYHOADON ,LOAIHOADON ,HD.TIEPNHAN_ID,HD.BENHNHAN_ID ,BENHAN_ID ,MAYTE ,TENBENHNHAN ,BN.DIACHI ,HD.KH_MASOTHUE AS MASOTHUE ,KYHIEUHOADON = NULL,SOSERIEVAT ,TIENTE_ID ,
      TYGIA ,GIATRI = HD.GIATRIHOADON ,GIATRIVAT ,GIATRICHIETKHAU =HD.GIATRIHOADON ,GIATRIHOADON ,NVT.MANHANVIEN ,NVT.TENNHANVIEN,NVL.MANHANVIEN AS MANGUOITHU ,NVL.TENNHANVIEN AS TENNGUOITHU,DATHANHTOAN ,PB.MAPHONGBAN ,PB.TENPHONGBAN ,PB.PHONGBAN_ID ,KHOXUAT_ID ,MAKHOXUAT = TT.MAKHO,
      TENKHOXUAT = TT.TENKHO ,PB.COSTCENTER_ID ,CO.MAPHONGBAN AS COSTCENTERCODE, CO.TENPHONGBAN AS COSTCENTERNAME ,HD.BENHVIEN_ID ,HD.BENHVIEN_ID AS MABENHVIEN, TENBENHVIEN = @TENBENHVIEN  ,IDCHUYEN ,HOANTRA ,IDCHUYENHOAN ,HUYHOADON ,IDCHUYENHUY ,
      LOAICHUNGTU = HD.LOAIHOADON,CHUYENTICHHOP_ID = NULL ,MACHUNGTU ,NGAYCHUNGTU ,HD.GHICHU , STATUSROW = CAST (0 AS BIT), MESSAGEROW = NULL
      FROM  dbo.TT_HOADON HD
      JOIN dbo.TT_BENHNHAN BN ON BN.BENHNHAN_ID = HD.BENHNHAN_ID
      JOIN dbo.TM_PHONGBAN PB ON PB.PHONGBAN_ID = HD.NOITHUTIEN_ID
      JOIN dbo.TM_NHANVIEN NVT ON NVT.NHANVIEN_ID = HD.NGUOITHUTIEN_ID
      JOIN dbo.TM_NHANVIEN NVL ON NVL.NHANVIEN_ID = HD.NGUOILAP_ID
      LEFT JOIN dbo.TM_PHONGBAN CO ON PB.COSTCENTER_ID = CO.PHONGBAN_ID
      CROSS APPLY(SELECT TOP 1 CT.LOAICHUNGTU,MACHUNGTU ,NGAYCHUNGTU,CT.KHOXUAT_ID,KD.MAKHO,KD.TENKHO,CT.MUCDICHCHUNGTU_CODE FROM  dbo.TT_HOADON_CHITIET_NGOAITRU HDCT
      JOIN dbo.TT_DUOC_CHUNGTU_CHITIET CTCT ON CTCT.CHUNGTUCHITIET_ID = HDCT.REF_ID
      JOIN dbo.TT_DUOC_CHUNGTU CT ON CT.CHUNGTU_ID = CTCT.CHUNGTU_ID
      JOIN dbo.TM_KHODUOC KD ON KD.KHODUOC_ID = CT.KHOXUAT_ID
      WHERE HDCT.HOADON_ID = hd.HOADON_ID) TT
      WHERE  HD.BENHVIEN_ID = '$BENHVIEN_ID$' AND CAST(HD.NGAYHOADON AS DATE) BETWEEN '$TUNGAY$' AND '$DENNGAY$'
      AND HD.IDCHUYEN IS NULL
      AND TT.MUCDICHCHUNGTU_CODE = 'X08'     
      <isNotEmpty prepend="AND" property="SOHOADON">
        HD.SOHOADON LIKE N'%'+#SOHOADON#+'%'
      </isNotEmpty>
      <isNotEmpty prepend="AND" property="MAYTE">
        BN.MAYTE LIKE N'%'+#MAYTE#+'%'
      </isNotEmpty>
      <isNotEmpty prepend="AND" property="MACHUNGTU">
        TT.MACHUNGTU LIKE N'%'+#MACHUNGTU#+'%'
      </isNotEmpty>
      <isNotEmpty prepend="AND" property="TENBENHNHAN">
        BN.TENBENHNHAN LIKE N'%'+#TENBENHNHAN#+'%'
      </isNotEmpty>
	    <isNotEmpty prepend="AND" property="NGUOILAP_ID">
        HD.NGUOILAP_ID = '$NGUOILAP_ID$'
      </isNotEmpty>
	    <isNotEmpty prepend="AND" property="NGUOITHU_ID">
        HD.NGUOITHUTIEN_ID = '$NGUOITHU_ID$'
      </isNotEmpty>

      UNION

      SELECT 
	      BTNCHECK = CAST (0 AS BIT),HOADON_ID ,SOHOADON ,NGAYHOADON ,LOAIHOADON ,HD.TIEPNHAN_ID,HD.BENHNHAN_ID ,BENHAN_ID ,MAYTE ,TENBENHNHAN ,BN.DIACHI ,HD.KH_MASOTHUE AS MASOTHUE ,KYHIEUHOADON = NULL,SOSERIEVAT ,TIENTE_ID ,
        TYGIA ,GIATRI = HD.GIATRIHOADON ,GIATRIVAT ,GIATRICHIETKHAU =HD.GIATRIHOADON ,GIATRIHOADON ,NVT.MANHANVIEN ,NVT.TENNHANVIEN,NVL.MANHANVIEN AS MANGUOITHU ,NVL.TENNHANVIEN AS TENNGUOITHU,DATHANHTOAN ,PB.MAPHONGBAN ,PB.TENPHONGBAN ,PB.PHONGBAN_ID ,KHOXUAT_ID ,MAKHOXUAT = TT.MAKHO,
        TENKHOXUAT = TT.TENKHO ,PB.COSTCENTER_ID ,CO.MAPHONGBAN AS COSTCENTERCODE, CO.TENPHONGBAN AS COSTCENTERNAME ,HD.BENHVIEN_ID ,HD.BENHVIEN_ID AS MABENHVIEN, TENBENHVIEN = @TENBENHVIEN  ,IDCHUYEN ,HOANTRA ,IDCHUYENHOAN ,HUYHOADON ,IDCHUYENHUY ,
        LOAICHUNGTU = HD.LOAIHOADON,CHUYENTICHHOP_ID = NULL ,MACHUNGTU ,NGAYCHUNGTU ,HD.GHICHU , STATUSROW = CAST (0 AS BIT), MESSAGEROW = NULL
        FROM  dbo.TT_HOADON HD
	        JOIN dbo.TT_BENHNHAN BN ON BN.BENHNHAN_ID = HD.BENHNHAN_ID
	        JOIN dbo.TM_PHONGBAN PB ON PB.PHONGBAN_ID = HD.NOITHUTIEN_ID
	        JOIN dbo.TM_NHANVIEN NVT ON NVT.NHANVIEN_ID = HD.NGUOITHUTIEN_ID
	        JOIN dbo.TM_NHANVIEN NVL ON NVL.NHANVIEN_ID = HD.NGUOILAP_ID
          LEFT JOIN dbo.TM_PHONGBAN CO ON PB.COSTCENTER_ID = CO.PHONGBAN_ID
	        CROSS APPLY(SELECT TOP 1 CT.LOAICHUNGTU,MACHUNGTU ,NGAYCHUNGTU,CT.KHOXUAT_ID,KD.MAKHO,KD.TENKHO,CT.MUCDICHCHUNGTU_CODE FROM  dbo.TT_HOADON_CHITIET_NOITRU HDCT
		                  JOIN dbo.TT_DUOC_CHUNGTU_CHITIET CTCT ON CTCT.CHUNGTUCHITIET_ID = HDCT.REF_ID
		                  JOIN dbo.TT_DUOC_CHUNGTU CT ON CT.CHUNGTU_ID = CTCT.CHUNGTU_ID
		                  JOIN dbo.TM_KHODUOC KD ON KD.KHODUOC_ID = CT.KHOXUAT_ID
		                  WHERE HDCT.HOADON_ID = hd.HOADON_ID) TT
	      WHERE  HD.BENHVIEN_ID = '$BENHVIEN_ID$' AND CAST(HD.NGAYHOADON AS DATE) BETWEEN '$TUNGAY$' AND '$DENNGAY$'
              AND HD.IDCHUYEN IS NULL
              AND TT.MUCDICHCHUNGTU_CODE = 'X08'              
	    <isNotEmpty prepend="AND" property="SOHOADON">
        HD.SOHOADON LIKE N'%'+#SOHOADON#+'%'
      </isNotEmpty>
      <isNotEmpty prepend="AND" property="MAYTE">
        BN.MAYTE LIKE N'%'+#MAYTE#+'%'
      </isNotEmpty>
      <isNotEmpty prepend="AND" property="MACHUNGTU">
        TT.MACHUNGTU LIKE N'%'+#MACHUNGTU#+'%'
      </isNotEmpty>
      <isNotEmpty prepend="AND" property="TENBENHNHAN">
        BN.TENBENHNHAN LIKE N'%'+#TENBENHNHAN#+'%'
      </isNotEmpty>
	    <isNotEmpty prepend="AND" property="NGUOILAP_ID">
        HD.NGUOILAP_ID = '$NGUOILAP_ID$'
      </isNotEmpty>
	    <isNotEmpty prepend="AND" property="NGUOITHU_ID">
        HD.NGUOITHUTIEN_ID = '$NGUOITHU_ID$'
      </isNotEmpty>
    </statement>
    <!--Lấy danh sách doanh thu bán thuốc tại quầy đã chuyển-->
    <statement id="DAO09800_GetMasterDoanhThuBanThuocTaiQuay_DACHUYEN" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      DECLARE @TENBENHVIEN NVARCHAR(250);
      SELECT  @TENBENHVIEN = VALUE
      FROM    dbo.TM_SYS_APPSETTINGS
      WHERE   BENHVIEN_ID = '$BENHVIEN_ID$'
      AND CODE = 'APP_BENHVIEN_TEN';

      SELECT 
	      BTNCHECK = CAST (0 AS BIT),HOADON_ID ,HD.SOHOADON ,NGAYHOADON ,LOAIHOADON ,HD.TIEPNHAN_ID,HD.BENHNHAN_ID ,BENHAN_ID ,MAYTE ,TENBENHNHAN ,BN.DIACHI ,HD.KH_MASOTHUE AS MASOTHUE ,KYHIEUHOADON = NULL,SOSERIEVAT ,TIENTE_ID ,
        TYGIA ,GIATRI = HD.GIATRIHOADON ,GIATRIVAT ,GIATRICHIETKHAU =HD.GIATRIHOADON ,GIATRIHOADON ,NVT.MANHANVIEN ,NVT.TENNHANVIEN,NVL.MANHANVIEN AS MANGUOITHU ,NVL.TENNHANVIEN AS TENNGUOITHU,DATHANHTOAN ,PB.MAPHONGBAN ,PB.TENPHONGBAN ,PB.PHONGBAN_ID ,KHOXUAT_ID ,MAKHOXUAT = TT.MAKHO,
        TENKHOXUAT = TT.TENKHO ,PB.COSTCENTER_ID ,CO.MAPHONGBAN AS COSTCENTERCODE, CO.TENPHONGBAN AS COSTCENTERNAME ,HD.BENHVIEN_ID ,HD.BENHVIEN_ID AS MABENHVIEN, TENBENHVIEN = @TENBENHVIEN  ,IDCHUYEN ,HOANTRA ,IDCHUYENHOAN ,HUYHOADON ,IDCHUYENHUY ,
        LOAICHUNGTU = HD.LOAIHOADON,CHUYENTICHHOP_ID = NULL ,MACHUNGTU ,NGAYCHUNGTU ,HD.GHICHU , STATUSROW = CAST (0 AS BIT), MESSAGEROW = NULL
        ,TH.THOIGIANCHUYEN
      FROM  dbo.TT_HOADON HD
        JOIN VIEW_IDCHUYENTICHHOP TH on TH.CHUYENTICHHOP_ID = HD.IDCHUYEN
	      JOIN dbo.TT_BENHNHAN BN ON BN.BENHNHAN_ID = HD.BENHNHAN_ID
	      JOIN dbo.TM_PHONGBAN PB ON PB.PHONGBAN_ID = HD.NOITHUTIEN_ID
	      JOIN dbo.TM_NHANVIEN NVT ON NVT.NHANVIEN_ID = HD.NGUOITHUTIEN_ID
	      JOIN dbo.TM_NHANVIEN NVL ON NVL.NHANVIEN_ID = HD.NGUOILAP_ID
        LEFT JOIN dbo.TM_PHONGBAN CO ON PB.COSTCENTER_ID = CO.PHONGBAN_ID
	      CROSS APPLY(SELECT TOP 1 CT.LOAICHUNGTU,MACHUNGTU ,NGAYCHUNGTU,CT.KHOXUAT_ID,KD.MAKHO,KD.TENKHO FROM  dbo.TT_HOADON_CHITIET_NGOAITRU HDCT
		                JOIN dbo.TT_DUOC_CHUNGTU_CHITIET CTCT ON CTCT.CHUNGTUCHITIET_ID = HDCT.REF_ID
		                JOIN dbo.TT_DUOC_CHUNGTU CT ON CT.CHUNGTU_ID = CTCT.CHUNGTU_ID
		                JOIN dbo.TM_KHODUOC KD ON KD.KHODUOC_ID = CT.KHOXUAT_ID
		                WHERE HDCT.HOADON_ID = hd.HOADON_ID) TT
	    WHERE  HD.BENHVIEN_ID = '$BENHVIEN_ID$' AND CAST(HD.NGAYHOADON AS DATE) BETWEEN '$TUNGAY$' AND '$DENNGAY$'
             AND HD.IDCHUYEN IS NOT NULL
	    <isNotEmpty prepend="AND" property="SOHOADON">
        HD.SOHOADON LIKE N'%'+#SOHOADON#+'%'
      </isNotEmpty>
      <isNotEmpty prepend="AND" property="MAYTE">
        BN.MAYTE LIKE N'%'+#MAYTE#+'%'
      </isNotEmpty>
      <isNotEmpty prepend="AND" property="MACHUNGTU">
        TT.MACHUNGTU LIKE N'%'+#MACHUNGTU#+'%'
      </isNotEmpty>
      <isNotEmpty prepend="AND" property="TENBENHNHAN">
        BN.TENBENHNHAN LIKE N'%'+#TENBENHNHAN#+'%'
      </isNotEmpty>
	    <isNotEmpty prepend="AND" property="NGUOILAP_ID">
        HD.NGUOILAP_ID = '$NGUOILAP_ID$'
      </isNotEmpty>
	    <isNotEmpty prepend="AND" property="NGUOITHU_ID">
        HD.NGUOITHUTIEN_ID = '$NGUOITHU_ID$'
      </isNotEmpty>

      UNION

      SELECT 
	      BTNCHECK = CAST (0 AS BIT),HOADON_ID ,SOHOADON ,NGAYHOADON ,LOAIHOADON ,HD.TIEPNHAN_ID,HD.BENHNHAN_ID ,BENHAN_ID ,MAYTE ,TENBENHNHAN ,BN.DIACHI ,HD.KH_MASOTHUE AS MASOTHUE ,KYHIEUHOADON = NULL,SOSERIEVAT ,TIENTE_ID ,
        TYGIA ,GIATRI = HD.GIATRIHOADON ,GIATRIVAT ,GIATRICHIETKHAU =HD.GIATRIHOADON ,GIATRIHOADON ,NVT.MANHANVIEN ,NVT.TENNHANVIEN,NVL.MANHANVIEN AS MANGUOITHU ,NVL.TENNHANVIEN AS TENNGUOITHU,DATHANHTOAN ,PB.MAPHONGBAN ,PB.TENPHONGBAN ,PB.PHONGBAN_ID ,KHOXUAT_ID ,MAKHOXUAT = TT.MAKHO,
        TENKHOXUAT = TT.TENKHO ,PB.COSTCENTER_ID ,CO.MAPHONGBAN AS COSTCENTERCODE, CO.TENPHONGBAN AS COSTCENTERNAME ,HD.BENHVIEN_ID ,HD.BENHVIEN_ID AS MABENHVIEN, TENBENHVIEN = @TENBENHVIEN  ,IDCHUYEN ,HOANTRA ,IDCHUYENHOAN ,HUYHOADON ,IDCHUYENHUY ,
        LOAICHUNGTU = HD.LOAIHOADON,CHUYENTICHHOP_ID = NULL ,MACHUNGTU ,NGAYCHUNGTU ,HD.GHICHU , STATUSROW = CAST (0 AS BIT), MESSAGEROW = NULL
        ,TH.THOIGIANCHUYEN
        FROM  dbo.TT_HOADON HD
          JOIN VIEW_IDCHUYENTICHHOP TH on TH.CHUYENTICHHOP_ID = HD.IDCHUYEN
	        JOIN dbo.TT_BENHNHAN BN ON BN.BENHNHAN_ID = HD.BENHNHAN_ID
	        JOIN dbo.TM_PHONGBAN PB ON PB.PHONGBAN_ID = HD.NOITHUTIEN_ID
	        JOIN dbo.TM_NHANVIEN NVT ON NVT.NHANVIEN_ID = HD.NGUOITHUTIEN_ID
	        JOIN dbo.TM_NHANVIEN NVL ON NVL.NHANVIEN_ID = HD.NGUOILAP_ID
          LEFT JOIN dbo.TM_PHONGBAN CO ON PB.COSTCENTER_ID = CO.PHONGBAN_ID
	        CROSS APPLY(SELECT TOP 1 CT.LOAICHUNGTU,MACHUNGTU ,NGAYCHUNGTU,CT.KHOXUAT_ID,KD.MAKHO,KD.TENKHO FROM  dbo.TT_HOADON_CHITIET_NOITRU HDCT
		                  JOIN dbo.TT_DUOC_CHUNGTU_CHITIET CTCT ON CTCT.CHUNGTUCHITIET_ID = HDCT.REF_ID
		                  JOIN dbo.TT_DUOC_CHUNGTU CT ON CT.CHUNGTU_ID = CTCT.CHUNGTU_ID
		                  JOIN dbo.TM_KHODUOC KD ON KD.KHODUOC_ID = CT.KHOXUAT_ID
		                  WHERE HDCT.HOADON_ID = hd.HOADON_ID) TT
	      WHERE  HD.BENHVIEN_ID = '$BENHVIEN_ID$' AND CAST(HD.NGAYHOADON AS DATE) BETWEEN '$TUNGAY$' AND '$DENNGAY$'
              AND HD.IDCHUYEN IS NOT NULL
	    <isNotEmpty prepend="AND" property="SOHOADON">
        HD.SOHOADON LIKE N'%'+#SOHOADON#+'%'
      </isNotEmpty>
      <isNotEmpty prepend="AND" property="MAYTE">
        BN.MAYTE LIKE N'%'+#MAYTE#+'%'
      </isNotEmpty>
      <isNotEmpty prepend="AND" property="MACHUNGTU">
        TT.MACHUNGTU LIKE N'%'+#MACHUNGTU#+'%'
      </isNotEmpty>
      <isNotEmpty prepend="AND" property="TENBENHNHAN">
        BN.TENBENHNHAN LIKE N'%'+#TENBENHNHAN#+'%'
      </isNotEmpty>
	    <isNotEmpty prepend="AND" property="NGUOILAP_ID">
        HD.NGUOILAP_ID = '$NGUOILAP_ID$'
      </isNotEmpty>
	    <isNotEmpty prepend="AND" property="NGUOITHU_ID">
        HD.NGUOITHUTIEN_ID = '$NGUOITHU_ID$'
      </isNotEmpty>
    </statement>
    <!--Lấy chi tiết doanh thu bán thuốc tại quầy-->
    <statement id="DAO09800_GetDetailDoanhThuBanThuocTaiQuay" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      SELECT 
	      TICHHOP_ID = NULL,HOADON_ID ,LOAIVATTU_ID ,MALOAIDUOC ,TENLOAIDUOC ,MADUOC ,TENDUOC = D.TENDUOCDAYDU ,DONVITINH ,DONVIQUICACH = NULL,GIATRIQUIDOI =D.QC_GIATRIQUIDOI,SOLUONG ,
	      DONGIA = HDCT.DONGIA_DOANHTHU  ,GIATRI = SOLUONG * HDCT.DONGIA_DOANHTHU,D.TYLE_VAT AS TYLEVAT ,HDCT.GIATRIVAT ,TYLECHIETKHAU = NULL,GIATRICHIETKHAU = NULL,GIATRITHANHTOAN = HDCT.GIATRI_HOADON 
      FROM dbo.TT_HOADON_CHITIET_NGOAITRU HDCT
	      LEFT JOIN dbo.TM_DUOC D ON D.DUOC_ID = HDCT.DUOC_ID
	      LEFT JOIN dbo.TM_LOAIDUOC LD ON LD.LOAIDUOC_ID = D.LOAIDUOC_ID
	      LEFT JOIN dbo.TM_DUOC_DONGIA DDG ON DDG.DUOC_ID = D.DUOC_ID
      WHERE HDCT.HOADON_ID = '$HOADON_ID$'

      UNION 

      SELECT 
	      TICHHOP_ID = NULL,HOADON_ID ,LOAIVATTU_ID ,MALOAIDUOC ,TENLOAIDUOC ,MADUOC ,TENDUOC = D.TENDUOCDAYDU ,DONVITINH ,DONVIQUICACH = NULL,GIATRIQUIDOI =D.QC_GIATRIQUIDOI,SOLUONG ,
	      DONGIA = HDCT.DONGIA_DOANHTHU  ,GIATRI = SOLUONG * HDCT.DONGIA_DOANHTHU,D.TYLE_VAT AS TYLEVAT ,HDCT.GIATRIVAT ,TYLECHIETKHAU = NULL,GIATRICHIETKHAU = NULL,GIATRITHANHTOAN = HDCT.GIATRI_HOADON 
      FROM dbo.TT_HOADON_CHITIET_NOITRU HDCT
	      LEFT JOIN dbo.TM_DUOC D ON D.DUOC_ID = HDCT.DUOC_ID
	      LEFT JOIN dbo.TM_LOAIDUOC LD ON LD.LOAIDUOC_ID = D.LOAIDUOC_ID
	      LEFT JOIN dbo.TM_DUOC_DONGIA DDG ON DDG.DUOC_ID = D.DUOC_ID
      WHERE HDCT.HOADON_ID = '$HOADON_ID$'
    </statement>
    <!--Lấy chi tiết doanh thu bán thuốc tại quầy httt-->
    <statement id="DAO09800_GetDetailDoanhThuBanThuocTaiQuayHTTT" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      SELECT 
	      TICHHOP_ID = NULL,HD.HOADON_ID ,MAHINHTHUCTHANHTOAN = LST.DICTIONARY_CODE,TENHINHTHUCTHANHTOAN = LST.DICTIONARY_NAME,
	      TYLEVAT =HD.TYLEVAT,GIATRIVAT = HD.GIATRIVAT,GIATRICHIETKHAU = NULL,GIATRITHANHTOAN  = HTTT.GIATRITHUCTHU
      FROM  dbo.TT_HOADON HD
	      JOIN dbo.TT_HOADON_HINHTHUCTHANHTOAN HTTT ON HD.HOADON_ID = HTTT.HOADON_ID
	      JOIN dbo.LST_DICTIONARY LST ON LST.DICTIONARY_ID = HTTT.HINHTHUCTHANHTOAN_ID
      WHERE HD.HOADON_ID = '$HOADON_ID$'
    </statement>
    <!--Cập nhật IDChuyen vào bảng doanh thu bán thuốc tại quầy-->
    <update id="DAO09800_UpdateDoanhThuBanThuocTaiQuay_IDChuyen" parameterClass="System.Collections.IDictionary">
      UPDATE dbo.TT_HOADON SET IDCHUYEN = #CHUYENTICHHOP_ID#  WHERE HOADON_ID = '$HOADON_ID$'
    </update>
    <!--============================================END VIỆN PHÍ - BÁN THUỐC TẠI QUẦY=============================================-->

    <!--============================================BEGIN BHTN=============================================-->
    <!--Lấy danh sách BHTN-->
    <statement id="DAO09800_GetMasterBHTN" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      DECLARE @TENBENHVIEN NVARCHAR(250);
      SELECT    @TENBENHVIEN = CODE
      FROM      dbo.TM_SYS_APPSETTINGS
      WHERE     BENHVIEN_ID = '$BENHVIEN_ID$'
      AND CODE = 'APP_BENHVIEN_TEN';

      SELECT    BTNCHECK = CAST (0 AS BIT) ,
      MIENGIAM_BHTN_ID ,SOPHIEUBHTN ,CT.TIEPNHAN_ID ,SOTN_BA = TN.SOTIEPNHAN ,CT.BENHAN_ID ,CT.BENHNHAN_ID ,CONGTYBHTN_ID ,MACONGTY ,
      TENCONGTY ,SOTHEBHTN ,MAYTE ,TENBENHNHAN ,BN.DIACHI ,MASOTHUE ,TIENTE_ID = 'VND' ,TYGIA = 1 ,GIATRI = CTCT.GIATRITHANHTOAN ,GIATRIVAT = NULL ,
      GIATRICHIETKHAU = NULL ,GIATRIHOADON = CTCT.GIATRITHANHTOAN ,GHICHU = NULL ,MANHANVIEN ,TENNHANVIEN ,COSTCENTER_ID = NULL ,COSTCENTERCODE = NULL ,
      COSTCENTERNAME = NULL ,CT.BENHVIEN_ID ,CT.BENHVIEN_ID AS MABENHVIEN ,TENBENHVIEN = @TENBENHVIEN ,IDCHUYEN ,IDCHUYENHUY ,IDCHUYENHOAN ,
      CHUYENTICHHOP_ID = NULL ,LOAI = N'Ngoại trú' ,LOAICHUNGTU = 'NGOAITRU' ,NGAYDUYET ,NGUOIDUYET_ID ,ND.TENNHANVIEN AS TENNGUOIDUYET ,STATUSROW = CAST (0 AS BIT) ,
      MESSAGEROW = NULL, CT.HOADON_CHUNGTU_LIENQUAN_ID
      FROM      dbo.TT_MIENGIAM_BHTN CT
      CROSS APPLY(SELECT SUM(GIATRIMIENGIAM) AS GIATRITHANHTOAN
      FROM dbo.TT_MIENGIAM_CHITIET
      WHERE MIENGIAM_ID = CT.MIENGIAM_BHTN_ID AND REF_TABLE = 'TT_MIENGIAM_BHTN') CTCT
      JOIN dbo.TT_TIEPNHAN TN ON TN.TIEPNHAN_ID = CT.TIEPNHAN_ID
      JOIN dbo.TT_BENHNHAN BN ON TN.BENHNHAN_ID = BN.BENHNHAN_ID
      JOIN dbo.TM_CONGTYBAOHIEM CTBH ON CTBH.CONGTY_ID = CT.CONGTYBHTN_ID
      LEFT JOIN dbo.TM_NHANVIEN ND ON ND.NHANVIEN_ID = CT.NGUOIDUYET_ID
      WHERE     CT.BENHVIEN_ID = '$BENHVIEN_ID$'  AND CAST(CT.NGAYDUYET AS DATE) BETWEEN '$TUNGAY$' AND '$DENNGAY$'
      AND ctct.giatrithanhtoan IS NOT null
      AND CT.IDCHUYEN IS NULL
      AND ISNULL(ct.BENHAN_ID,0) = 0
      AND ISNULL(CTCT.GIATRITHANHTOAN,0) > 0
      <isNotEmpty prepend="AND" property="MAYTE">
					BN.MAYTE LIKE N'%'+#MAYTE#+'%'
				</isNotEmpty>
				<isNotEmpty prepend="AND" property="SOTN_BA">
					TN.SOTIEPNHAN LIKE N'%'+#SOTN_BA#+'%'
				</isNotEmpty>
				<isNotEmpty prepend="AND" property="TENBENHNHAN">
					BN.TENBENHNHAN LIKE N'%'+#TENBENHNHAN#+'%'
				</isNotEmpty>
				<isNotEmpty prepend="AND" property="TENCONGTY">
					TENCONGTY LIKE N'%'+#TENCONGTY#+'%'
				</isNotEmpty>

      UNION

      SELECT    BTNCHECK = CAST (0 AS BIT) ,
      MIENGIAM_BHTN_ID ,SOPHIEUBHTN ,CT.TIEPNHAN_ID ,SOTN_BA = BA.SOBENHAN ,CT.BENHAN_ID ,CT.BENHNHAN_ID ,CONGTYBHTN_ID ,MACONGTY ,TENCONGTY ,SOTHEBHTN ,
      MAYTE ,TENBENHNHAN ,BN.DIACHI ,MASOTHUE ,TIENTE_ID = 'VND' ,TYGIA = 1 ,GIATRI = CTCT.GIATRITHANHTOAN ,GIATRIVAT = NULL ,GIATRICHIETKHAU = NULL ,
      GIATRIHOADON = CTCT.GIATRITHANHTOAN ,GHICHU = NULL ,MANHANVIEN ,TENNHANVIEN ,COSTCENTER_ID = NULL ,COSTCENTERCODE = NULL ,COSTCENTERNAME = NULL ,
      CT.BENHVIEN_ID ,CT.BENHVIEN_ID AS MABENHVIEN ,TENBENHVIEN = @TENBENHVIEN ,IDCHUYEN ,IDCHUYENHUY ,IDCHUYENHOAN ,CHUYENTICHHOP_ID = NULL ,LOAI = N'Nội trú' ,
      LOAICHUNGTU ='NOITRU' ,NGAYDUYET ,NGUOIDUYET_ID ,ND.TENNHANVIEN AS TENNGUOIDUYET ,STATUSROW = CAST (0 AS BIT) ,MESSAGEROW = NULL, CT.HOADON_CHUNGTU_LIENQUAN_ID
      FROM      dbo.TT_MIENGIAM_BHTN CT
      CROSS APPLY(SELECT SUM(GIATRIMIENGIAM) AS GIATRITHANHTOAN
      FROM dbo.TT_MIENGIAM_CHITIET
      WHERE MIENGIAM_ID = CT.MIENGIAM_BHTN_ID AND REF_TABLE = 'TT_MIENGIAM_BHTN') CTCT
      JOIN dbo.TT_NOITRU_BENHAN BA ON BA.BENHAN_ID = CT.BENHAN_ID
      JOIN dbo.TT_BENHNHAN BN ON BA.BENHNHAN_ID = BN.BENHNHAN_ID
      JOIN dbo.TM_CONGTYBAOHIEM CTBH ON CTBH.CONGTY_ID = CT.CONGTYBHTN_ID
      LEFT JOIN dbo.TM_NHANVIEN ND ON ND.NHANVIEN_ID = CT.NGUOIDUYET_ID
      WHERE     CT.BENHVIEN_ID = '$BENHVIEN_ID$'  AND CAST(CT.NGAYDUYET AS DATE) BETWEEN '$TUNGAY$' AND '$DENNGAY$'
      AND ctct.giatrithanhtoan IS NOT null
      AND CT.IDCHUYEN IS NULL
      AND ISNULL(ct.BENHAN_ID,0) > 0
      AND ISNULL(CTCT.GIATRITHANHTOAN,0) > 0
      <isNotEmpty prepend="AND" property="MAYTE">
					BN.MAYTE LIKE N'%'+#MAYTE#+'%'
				</isNotEmpty>
				<isNotEmpty prepend="AND" property="SOTN_BA">
					BA.SOBENHAN LIKE N'%'+#SOTN_BA#+'%'
				</isNotEmpty>
				<isNotEmpty prepend="AND" property="TENBENHNHAN">
					BN.TENBENHNHAN LIKE N'%'+#TENBENHNHAN#+'%'
				</isNotEmpty>
				<isNotEmpty prepend="AND" property="TENCONGTY">
					TENCONGTY LIKE N'%'+#TENCONGTY#+'%'
				</isNotEmpty>
    </statement>
    <!--Lấy danh sách BHTN đã chuyển-->
    <statement id="DAO09800_GetMasterBHTN_DACHUYEN" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      DECLARE @TENBENHVIEN NVARCHAR(250);
      SELECT    @TENBENHVIEN = CODE
      FROM      dbo.TM_SYS_APPSETTINGS
      WHERE     BENHVIEN_ID = '$BENHVIEN_ID$'
      AND CODE = 'APP_BENHVIEN_TEN';

      SELECT    BTNCHECK = CAST (0 AS BIT) ,
      MIENGIAM_BHTN_ID ,SOPHIEUBHTN ,CT.TIEPNHAN_ID ,SOTN_BA = TN.SOTIEPNHAN ,CT.BENHAN_ID ,CT.BENHNHAN_ID ,CONGTYBHTN_ID ,MACONGTY ,
      TENCONGTY ,SOTHEBHTN ,MAYTE ,TENBENHNHAN ,BN.DIACHI ,MASOTHUE ,TIENTE_ID = 'VND' ,TYGIA = 1 ,GIATRI = CTCT.GIATRITHANHTOAN ,GIATRIVAT = NULL ,
      GIATRICHIETKHAU = NULL ,GIATRIHOADON = CTCT.GIATRITHANHTOAN ,GHICHU = NULL ,MANHANVIEN ,TENNHANVIEN ,COSTCENTER_ID = NULL ,COSTCENTERCODE = NULL ,
      COSTCENTERNAME = NULL ,CT.BENHVIEN_ID ,CT.BENHVIEN_ID AS MABENHVIEN ,TENBENHVIEN = @TENBENHVIEN ,IDCHUYEN ,IDCHUYENHUY ,IDCHUYENHOAN ,
      CHUYENTICHHOP_ID = NULL ,LOAI = N'Ngoại trú' ,LOAICHUNGTU = 'NGOAITRU' ,NGAYDUYET ,NGUOIDUYET_ID ,ND.TENNHANVIEN AS TENNGUOIDUYET ,STATUSROW = CAST (0 AS BIT) ,
      MESSAGEROW = NULL, CT.HOADON_CHUNGTU_LIENQUAN_ID
      ,TH.THOIGIANCHUYEN
      FROM      dbo.TT_MIENGIAM_BHTN CT
      JOIN VIEW_IDCHUYENTICHHOP TH on TH.CHUYENTICHHOP_ID = CT.IDCHUYEN
      CROSS APPLY(SELECT SUM(GIATRIMIENGIAM) AS GIATRITHANHTOAN
      FROM dbo.TT_MIENGIAM_CHITIET
      WHERE MIENGIAM_ID = CT.MIENGIAM_BHTN_ID AND REF_TABLE = 'TT_MIENGIAM_BHTN') CTCT
      JOIN dbo.TT_TIEPNHAN TN ON TN.TIEPNHAN_ID = CT.TIEPNHAN_ID
      JOIN dbo.TT_BENHNHAN BN ON TN.BENHNHAN_ID = BN.BENHNHAN_ID
      JOIN dbo.TM_CONGTYBAOHIEM CTBH ON CTBH.CONGTY_ID = CT.CONGTYBHTN_ID
      LEFT JOIN dbo.TM_NHANVIEN ND ON ND.NHANVIEN_ID = CT.NGUOIDUYET_ID
      WHERE     CT.BENHVIEN_ID = '$BENHVIEN_ID$'  AND CAST(CT.NGAYDUYET AS DATE) BETWEEN '$TUNGAY$' AND '$DENNGAY$'
      AND ctct.giatrithanhtoan IS NOT null
      AND CT.IDCHUYEN IS NOT NULL
      AND ISNULL(ct.BENHAN_ID,0) = 0
      AND ISNULL(CTCT.GIATRITHANHTOAN,0) > 0
      <isNotEmpty prepend="AND" property="MAYTE">
					BN.MAYTE LIKE N'%'+#MAYTE#+'%'
				</isNotEmpty>
				<isNotEmpty prepend="AND" property="SOTN_BA">
					TN.SOTIEPNHAN LIKE N'%'+#SOTN_BA#+'%'
				</isNotEmpty>
				<isNotEmpty prepend="AND" property="TENBENHNHAN">
					BN.TENBENHNHAN LIKE N'%'+#TENBENHNHAN#+'%'
				</isNotEmpty>
				<isNotEmpty prepend="AND" property="TENCONGTY">
					TENCONGTY LIKE N'%'+#TENCONGTY#+'%'
				</isNotEmpty>

      UNION

      SELECT    BTNCHECK = CAST (0 AS BIT) ,
      MIENGIAM_BHTN_ID ,SOPHIEUBHTN ,CT.TIEPNHAN_ID ,SOTN_BA = BA.SOBENHAN ,CT.BENHAN_ID ,CT.BENHNHAN_ID ,CONGTYBHTN_ID ,MACONGTY ,TENCONGTY ,SOTHEBHTN ,
      MAYTE ,TENBENHNHAN ,BN.DIACHI ,MASOTHUE ,TIENTE_ID = 'VND' ,TYGIA = 1 ,GIATRI = CTCT.GIATRITHANHTOAN ,GIATRIVAT = NULL ,GIATRICHIETKHAU = NULL ,
      GIATRIHOADON = CTCT.GIATRITHANHTOAN ,GHICHU = NULL ,MANHANVIEN ,TENNHANVIEN ,COSTCENTER_ID = NULL ,COSTCENTERCODE = NULL ,COSTCENTERNAME = NULL ,
      CT.BENHVIEN_ID ,CT.BENHVIEN_ID AS MABENHVIEN ,TENBENHVIEN = @TENBENHVIEN ,IDCHUYEN ,IDCHUYENHUY ,IDCHUYENHOAN ,CHUYENTICHHOP_ID = NULL ,LOAI = N'Nội trú' ,
      LOAICHUNGTU ='NOITRU' ,NGAYDUYET ,NGUOIDUYET_ID ,ND.TENNHANVIEN AS TENNGUOIDUYET ,STATUSROW = CAST (0 AS BIT) ,MESSAGEROW = NULL, CT.HOADON_CHUNGTU_LIENQUAN_ID
      ,TH.THOIGIANCHUYEN
      FROM      dbo.TT_MIENGIAM_BHTN CT
      JOIN VIEW_IDCHUYENTICHHOP TH on TH.CHUYENTICHHOP_ID = CT.IDCHUYEN
      CROSS APPLY(SELECT SUM(GIATRIMIENGIAM) AS GIATRITHANHTOAN
      FROM dbo.TT_MIENGIAM_CHITIET
      WHERE MIENGIAM_ID = CT.MIENGIAM_BHTN_ID AND REF_TABLE = 'TT_MIENGIAM_BHTN') CTCT
      JOIN dbo.TT_NOITRU_BENHAN BA ON BA.BENHAN_ID = CT.BENHAN_ID
      JOIN dbo.TT_BENHNHAN BN ON BA.BENHNHAN_ID = BN.BENHNHAN_ID
      JOIN dbo.TM_CONGTYBAOHIEM CTBH ON CTBH.CONGTY_ID = CT.CONGTYBHTN_ID
      LEFT JOIN dbo.TM_NHANVIEN ND ON ND.NHANVIEN_ID = CT.NGUOIDUYET_ID
      WHERE     CT.BENHVIEN_ID = '$BENHVIEN_ID$'  AND CAST(CT.NGAYDUYET AS DATE) BETWEEN '$TUNGAY$' AND '$DENNGAY$'
      AND ctct.giatrithanhtoan IS NOT null
      AND CT.IDCHUYEN IS NOT NULL
      AND ISNULL(ct.BENHAN_ID,0) > 0
      AND ISNULL(CTCT.GIATRITHANHTOAN,0) > 0
      <isNotEmpty prepend="AND" property="MAYTE">
					BN.MAYTE LIKE N'%'+#MAYTE#+'%'
				</isNotEmpty>
				<isNotEmpty prepend="AND" property="SOTN_BA">
					BA.SOBENHAN LIKE N'%'+#SOTN_BA#+'%'
				</isNotEmpty>
				<isNotEmpty prepend="AND" property="TENBENHNHAN">
					BN.TENBENHNHAN LIKE N'%'+#TENBENHNHAN#+'%'
				</isNotEmpty>
				<isNotEmpty prepend="AND" property="TENCONGTY">
					TENCONGTY LIKE N'%'+#TENCONGTY#+'%'
				</isNotEmpty>
    </statement>
    <!--Lấy chi tiết BHTN-->
    <statement id="DAO09800_GetDetailBHTN" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      SELECT TICHHOP_ID =null,MIENGIAM_BHTN_ID, CTCT.MIENGIAMCHITIET_ID ,MAKHOANMUCDT = null ,TENKHOANMUCDT =null,LOAIVATTU_ID = LD.LOAIVATTU_ID ,LD.MALOAIDUOC ,LD.TENLOAIDUOC ,D.MADUOC ,TD.TENDUOC ,LDV.MALOAIDICHVU ,LDV.TENLOAIDICHVU ,NDV.MANHOMDICHVU ,
      NDV.TENNHOMDICHVU ,DV.MADICHVU ,DV.TENDICHVU ,DONVITINH = CASE WHEN VP.DICHVU_ID IS NULL THEN D.DONVITINH ELSE DV.DONVITINH END,VP.SOLUONG ,DONGIA = VP.BHTN_THANHTIEN_CHITRA ,TYLEVAT = D.TYLE_VAT ,GIATRIVAT = NULL ,GIATRICHIETKHAU = NULL,GIATRIHOADON =VP.GIATRI_HOADON_DATHANHTOAN,LOAINOIDUNG = CASE WHEN VP.DICHVU_ID IS NULL THEN 'DU' ELSE 'DV' END ,
      MANOITHUCHIEN = NTH.MAPHONGBAN, NOITHUCHIEN = NTH.TENPHONGBAN, MAKHOXUAT = KX.MAKHO,TENKHOXUAT = KX.TENKHO,MAKHOAXUAT = PBX.MAPHONGBAN,TENKHOAXUAT = PBX.TENPHONGBAN
      FROM dbo.TT_MIENGIAM_BHTN CT
      JOIN dbo.TT_MIENGIAM_CHITIET CTCT ON CTCT.MIENGIAM_ID = CT.MIENGIAM_BHTN_ID
      JOIN dbo.TT_VIENPHI VP ON VP.VIENPHI_ID = CTCT.VIENPHI_ID
      LEFT JOIN dbo.TM_DICHVU DV ON DV.DICHVU_ID = VP.DICHVU_ID
      LEFT JOIN dbo.TM_NHOMDICHVU NDV ON NDV.NHOMDICHVU_ID = DV.NHOMDICHVU_ID
      LEFT JOIN dbo.TM_LOAIDICHVU LDV ON LDV.LOAIDICHVU_ID = NDV.LOAIDICHVU_ID
      LEFT JOIN dbo.TM_DUOC D ON D.DUOC_ID = VP.DUOC_ID
      LEFT JOIN dbo.TM_LOAIDUOC LD ON LD.LOAIDUOC_ID = D.LOAIDUOC_ID
      LEFT JOIN dbo.TM_TENDUOC TD ON TD.TENDUOC_ID = D.TENDUOC_ID
      LEFT JOIN dbo.TT_DVYEUCAU YC ON VP.REF_ID = YC.DVYEUCAU_ID AND VP.REF_TABLE = 'TT_DVYEUCAU'
      LEFT JOIN dbo.TM_PHONGBAN NTH ON ISNULL(YC.NOITHUCHIENTHAYDOI_ID, YC.NOITHUCHIEN_ID) = NTH.PHONGBAN_ID

      LEFT JOIN dbo.TT_CLSKETQUA_VTYT KQ_VTYT ON VP.REF_ID = KQ_VTYT.CLSKETQUA_VTYT_ID AND VP.REF_TABLE = 'TT_CLSKETQUA_VTYT'
      LEFT JOIN dbo.TT_NGOAITRU_KHAMBENH_VTYT NTKB_VTYT ON VP.REF_ID = NTKB_VTYT.KHAMBENH_VTYT_ID AND VP.REF_TABLE = 'TT_NGOAITRU_KHAMBENH_VTYT'
      LEFT JOIN dbo.TT_NGOAITRU_TOATHUOC NGT_TT ON VP.REF_ID = NGT_TT.TOATHUOC_ID AND VP.REF_TABLE = 'TT_NGOAITRU_TOATHUOC'
      LEFT JOIN dbo.TT_NGOAITRU_KHAMBENH_TOATHUOC KB_TT ON KB_TT.KHAMBENH_TOATHUOC_ID = NGT_TT.KHAMBENH_TOATHUOC_ID
      LEFT JOIN dbo.TT_NOITRU_TOATHUOC NT_TT ON VP.REF_ID = NT_TT.TOATHUOC_ID AND VP.REF_TABLE = 'TT_NOITRU_TOATHUOC'
      LEFT JOIN dbo.TT_PHAUTHUAT_VTYT PT_VTYT ON VP.REF_ID = PT_VTYT.PHAUTHUAT_VTYT_ID AND VP.REF_TABLE = 'TT_PHAUTHUAT_VTYT'
      LEFT JOIN TT_DUOC_CHUNGTU_CHITIET CTuCT on CTuCT.CHUNGTUCHITIET_ID = VP.REF_ID and VP.REF_TABLE ='TT_DUOC_CHUNGTU_CHITIET'

	  LEFT JOIN dbo.TT_DUOC_CHUNGTU CTX ON COALESCE(KQ_VTYT.CHUNGTU_ID, NTKB_VTYT.CHUNGTU_ID, KB_TT.CHUNGTUPHATTHUOC_ID, NT_TT.CHUNGTU_ID, PT_VTYT.CHUNGTU_ID, CTuCT.CHUNGTU_ID) = CTX.CHUNGTU_ID

      LEFT JOIN dbo.TM_KHODUOC KX ON CTX.KHOXUAT_ID = KX.KHODUOC_ID
      LEFT JOIN dbo.TM_PHONGBAN PBX ON CTX.PHONGBAN_ID = PBX.PHONGBAN_ID
      WHERE CTCT.REF_TABLE = 'TT_MIENGIAM_BHTN'
      AND CT.MIENGIAM_BHTN_ID = '$MIENGIAM_BHTN_ID$'
    </statement>
    <!--Cập nhật IDChuyen vào bảng BHTN-->
    <update id="DAO09800_UpdateBHTN_IDChuyen" parameterClass="System.Collections.IDictionary">
      UPDATE dbo.TT_MIENGIAM_BHTN SET IDCHUYEN = #CHUYENTICHHOP_ID# WHERE MIENGIAM_BHTN_ID = '$MIENGIAM_BHTN_ID$'
    </update>

    <!--Kiểm tra xem BHTN đã được chuyển lên db trung gian chưa-->
    <statement id="DAO09800_KiemTraBHTNDaChuyen" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      SELECT  1
      FROM    dbo.TT_MIENGIAM_BHTN
      WHERE   BENHVIEN_ID = '$BENHVIEN_ID$'
      AND MIENGIAM_BHTN_ID = '$MIENGIAM_BHTN_ID$'
      AND IDCHUYEN IS NOT NULL;
    </statement>
    <!--============================================END BHTN=============================================-->

    <!--============================================BEGIN BHYT=============================================-->
    <!--Lấy danh sách BHYT-->
    <statement id="DAO09800_GetMasterBHYT" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      DECLARE @TENBENHVIEN NVARCHAR(250);
      SELECT  @TENBENHVIEN = VALUE
      FROM    dbo.TM_SYS_APPSETTINGS
      WHERE   BENHVIEN_ID =  '$BENHVIEN_ID$'
      AND CODE = 'APP_BENHVIEN_TEN';

      SELECT  BTNCHECK = CAST (0 AS BIT) ,CT.XACNHANCHIPHI_ID ,
      CT.SOXACNHAN ,
      CT.NGAYXACNHAN ,
      CT.THOIGIANXACNHAN ,
      CT.TIEPNHAN_ID ,
      CT.BENHAN_ID ,
      CT.BENHNHAN_ID ,
      BN.MAYTE ,
      BN.TENBENHNHAN ,
      BN.DIACHI ,
      MASOTHUE = NULL ,
      TN.SOTIEPNHAN ,
      SOBENHAN = NULL ,
      SOTN_BA = tn.SOTIEPNHAN,
      TIENTE_ID = 'VND' ,
      TYGIA = 1 ,
      GIATRI = NULL ,
      GIATRIVAT = NULL ,
      GIATRICHIETKHAU = NULL ,
      CTCT.GIATRITHANHTOAN ,
      GHICHU = NULL,
      LOAI = CT.LOAI ,
      TENLOAI = N'Ngoại trú' ,
      CT.BENHVIEN_ID ,
      CT.BENHVIEN_ID AS MABENHVIEN ,
      TENBENHVIEN = @TENBENHVIEN ,
      CT.IDCHUYEN ,
      TENPHONGBAN = NULL,
      NULL AS CHUYENTICHHOP_ID ,
      CT.SOBHYT,
      STATUSROW = CAST (0 AS BIT) ,
      MESSAGEROW = NULL ,
	  NGAYTN_RV = CAST(TN.NGAYTIEPNHAN AS DATE)
      FROM    dbo.TT_XACNHANCHIPHI CT
      CROSS APPLY(SELECT SUM(XNCT.SOLUONG * ISNULL(VP.BHYT_DONGIA_CHITRA,0)) AS GIATRITHANHTOAN  FROM dbo.TT_XACNHANCHIPHICHITIET XNCT
					JOIN dbo.TT_VIENPHI VP ON VP.VIENPHI_ID = XNCT.VIENPHI_ID
				WHERE XACNHANCHIPHI_ID = CT.XACNHANCHIPHI_ID) CTCT
      JOIN dbo.TT_TIEPNHAN TN ON TN.TIEPNHAN_ID = CT.TIEPNHAN_ID
      JOIN dbo.TT_BENHNHAN BN ON TN.BENHNHAN_ID = BN.BENHNHAN_ID
      WHERE   CT.BENHVIEN_ID = '$BENHVIEN_ID$' AND CAST(TN.NGAYTIEPNHAN AS DATE) BETWEEN '$TUNGAY$' AND '$DENNGAY$'
      AND CT.IDCHUYEN IS  NULL
      AND  ISNULL(CT.LOAI,'') = 'NGOAITRU'
      AND ISNULL(CTCT.GIATRITHANHTOAN,0) > 0
      <isNotEmpty prepend="AND" property="MAYTE">
			  BN.MAYTE LIKE N'%'+#MAYTE#+'%'
		  </isNotEmpty>
		  <isNotEmpty prepend="AND" property="SOTN_BA">
			  TN.SOTIEPNHAN LIKE N'%'+#SOTN_BA#+'%'
		  </isNotEmpty>
		  <isNotEmpty prepend="AND" property="TENBENHNHAN">
			  BN.TENBENHNHAN LIKE N'%'+#TENBENHNHAN#+'%'
		  </isNotEmpty>

      UNION all

      SELECT  BTNCHECK = CAST (0 AS BIT) ,CT.XACNHANCHIPHI_ID ,
      CT.SOXACNHAN ,
      CT.NGAYXACNHAN ,
      CT.THOIGIANXACNHAN ,
      CT.TIEPNHAN_ID ,
      CT.BENHAN_ID ,
      CT.BENHNHAN_ID ,
      BN.MAYTE ,
      BN.TENBENHNHAN ,
      BN.DIACHI ,
      MASOTHUE = NULL ,
      SOTIEPNHAN = NULL ,
      SOBENHAN = ba.SOBENHAN ,
      SOTN_BA = ba.SOBENHAN ,
      TIENTE_ID = 'VND' ,
      TYGIA = 1 ,
      GIATRI = NULL ,
      GIATRIVAT = NULL ,
      GIATRICHIETKHAU = NULL ,
      CTCT.GIATRITHANHTOAN ,
      GHICHU = NULL,
      LOAI = CT.LOAI ,
      TENLOAI = N'Nội trú' ,
      CT.BENHVIEN_ID ,
      CT.BENHVIEN_ID AS MABENHVIEN ,
      TENBENHVIEN = @TENBENHVIEN ,
      CT.IDCHUYEN ,
      TENPHONGBAN = NULL,
      NULL AS CHUYENTICHHOP_ID ,
      CT.SOBHYT,
      STATUSROW = CAST (0 AS BIT) ,
      MESSAGEROW = NULL ,
	  NGAYTN_RV = CAST(BA.NGAYRAVIEN AS DATE)
      FROM    dbo.TT_XACNHANCHIPHI CT
      CROSS APPLY(SELECT SUM(XNCT.SOLUONG * ISNULL(VP.BHYT_DONGIA_CHITRA,0)) AS GIATRITHANHTOAN  FROM dbo.TT_XACNHANCHIPHICHITIET XNCT
					JOIN dbo.TT_VIENPHI VP ON VP.VIENPHI_ID = XNCT.VIENPHI_ID
				WHERE XACNHANCHIPHI_ID = CT.XACNHANCHIPHI_ID) CTCT
      JOIN dbo.TT_NOITRU_BENHAN BA ON BA.BENHAN_ID = CT.BENHAN_ID
      JOIN dbo.TT_BENHNHAN BN ON BA.BENHNHAN_ID = BN.BENHNHAN_ID
      WHERE   CT.BENHVIEN_ID = '$BENHVIEN_ID$' AND CAST(BA.NGAYRAVIEN AS DATE) BETWEEN '$TUNGAY$' AND '$DENNGAY$'
      AND CT.IDCHUYEN IS  NULL
      AND  ISNULL(CT.LOAI,'') != 'NGOAITRU'
      AND ISNULL(CTCT.GIATRITHANHTOAN,0) > 0
      <isNotEmpty prepend="AND" property="MAYTE">
			  BN.MAYTE LIKE N'%'+#MAYTE#+'%'
		  </isNotEmpty>
		  <isNotEmpty prepend="AND" property="SOTN_BA">
			  ba.SOBENHAN LIKE N'%'+#SOTN_BA#+'%'
		  </isNotEmpty>
		  <isNotEmpty prepend="AND" property="TENBENHNHAN">
			  BN.TENBENHNHAN LIKE N'%'+#TENBENHNHAN#+'%'
		  </isNotEmpty>
    </statement>
    <!--Lấy danh sách BHYT đã chuyển-->
    <statement id="DAO09800_GetMasterBHYT_DACHUYEN" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      DECLARE @TENBENHVIEN NVARCHAR(250);
      SELECT  @TENBENHVIEN = VALUE
      FROM    dbo.TM_SYS_APPSETTINGS
      WHERE   BENHVIEN_ID =  '$BENHVIEN_ID$'
      AND CODE = 'APP_BENHVIEN_TEN';

      SELECT  BTNCHECK = CAST (0 AS BIT) ,CT.XACNHANCHIPHI_ID ,
      CT.SOXACNHAN ,
      CT.NGAYXACNHAN ,
      CT.THOIGIANXACNHAN ,
      CT.TIEPNHAN_ID ,
      CT.BENHAN_ID ,
      CT.BENHNHAN_ID ,
      BN.MAYTE ,
      BN.TENBENHNHAN ,
      BN.DIACHI ,
      MASOTHUE = NULL ,
      TN.SOTIEPNHAN ,
      SOBENHAN = NULL ,
      SOTN_BA = tn.SOTIEPNHAN,
      TIENTE_ID = 'VND' ,
      TYGIA = 1 ,
      GIATRI = NULL ,
      GIATRIVAT = NULL ,
      GIATRICHIETKHAU = NULL ,
      CTCT.GIATRITHANHTOAN ,
      GHICHU = NULL,
      LOAI = CT.LOAI ,
      TENLOAI = N'Ngoại trú' ,
      CT.BENHVIEN_ID ,
      CT.BENHVIEN_ID AS MABENHVIEN ,
      TENBENHVIEN = @TENBENHVIEN ,
      CT.IDCHUYEN ,
      TENPHONGBAN = NULL,
      NULL AS CHUYENTICHHOP_ID ,
      CT.SOBHYT,
      STATUSROW = CAST (0 AS BIT) ,
      MESSAGEROW = NULL
      ,TH.THOIGIANCHUYEN
      FROM    dbo.TT_XACNHANCHIPHI CT
      JOIN VIEW_IDCHUYENTICHHOP TH on TH.CHUYENTICHHOP_ID = CT.IDCHUYEN
      CROSS APPLY(SELECT SUM(XNCT.SOLUONG * ISNULL(VP.BHYT_DONGIA_CHITRA,0)) AS GIATRITHANHTOAN  FROM dbo.TT_XACNHANCHIPHICHITIET XNCT
      JOIN dbo.TT_VIENPHI VP ON VP.VIENPHI_ID = XNCT.VIENPHI_ID
      WHERE XACNHANCHIPHI_ID = CT.XACNHANCHIPHI_ID AND VP.BENHVIEN_ID = '$BENHVIEN_ID$') CTCT
      JOIN dbo.TT_TIEPNHAN TN ON TN.TIEPNHAN_ID = CT.TIEPNHAN_ID
      JOIN dbo.TT_BENHNHAN BN ON TN.BENHNHAN_ID = BN.BENHNHAN_ID
      WHERE   CT.BENHVIEN_ID = '$BENHVIEN_ID$' AND CAST(TN.NGAYTIEPNHAN AS DATE) BETWEEN '$TUNGAY$' AND '$DENNGAY$'
      AND CT.IDCHUYEN IS NOT NULL
      AND  ISNULL(CT.LOAI,'') = 'NGOAITRU'
      AND ISNULL(CTCT.GIATRITHANHTOAN,0) > 0
      <isNotEmpty prepend="AND" property="MAYTE">
			  BN.MAYTE LIKE N'%'+#MAYTE#+'%'
		  </isNotEmpty>
		  <isNotEmpty prepend="AND" property="SOTN_BA">
			  TN.SOTIEPNHAN LIKE N'%'+#SOTN_BA#+'%'
		  </isNotEmpty>
		  <isNotEmpty prepend="AND" property="TENBENHNHAN">
			  BN.TENBENHNHAN LIKE N'%'+#TENBENHNHAN#+'%'
		  </isNotEmpty>

      UNION all

      SELECT  BTNCHECK = CAST (0 AS BIT) ,CT.XACNHANCHIPHI_ID ,
      CT.SOXACNHAN ,
      CT.NGAYXACNHAN ,
      CT.THOIGIANXACNHAN ,
      CT.TIEPNHAN_ID ,
      CT.BENHAN_ID ,
      CT.BENHNHAN_ID ,
      BN.MAYTE ,
      BN.TENBENHNHAN ,
      BN.DIACHI ,
      MASOTHUE = NULL ,
      SOTIEPNHAN = NULL ,
      SOBENHAN = ba.SOBENHAN ,
      SOTN_BA = ba.SOBENHAN ,
      TIENTE_ID = 'VND' ,
      TYGIA = 1 ,
      GIATRI = NULL ,
      GIATRIVAT = NULL ,
      GIATRICHIETKHAU = NULL ,
      CTCT.GIATRITHANHTOAN ,
      GHICHU = NULL,
      LOAI = CT.LOAI ,
      TENLOAI = N'Nội trú' ,
      CT.BENHVIEN_ID ,
      CT.BENHVIEN_ID AS MABENHVIEN ,
      TENBENHVIEN = @TENBENHVIEN ,
      CT.IDCHUYEN ,
      TENPHONGBAN = NULL,
      NULL AS CHUYENTICHHOP_ID ,
      CT.SOBHYT,
      STATUSROW = CAST (0 AS BIT) ,
      MESSAGEROW = NULL
      ,TH.THOIGIANCHUYEN
      FROM    dbo.TT_XACNHANCHIPHI CT
      JOIN VIEW_IDCHUYENTICHHOP TH on TH.CHUYENTICHHOP_ID = CT.IDCHUYEN
      CROSS APPLY(SELECT SUM(XNCT.SOLUONG * ISNULL(VP.BHYT_DONGIA_CHITRA,0)) AS GIATRITHANHTOAN  FROM dbo.TT_XACNHANCHIPHICHITIET XNCT
      JOIN dbo.TT_VIENPHI VP ON VP.VIENPHI_ID = XNCT.VIENPHI_ID
      WHERE XACNHANCHIPHI_ID = CT.XACNHANCHIPHI_ID AND VP.BENHVIEN_ID = '$BENHVIEN_ID$') CTCT
      JOIN dbo.TT_NOITRU_BENHAN BA ON BA.BENHAN_ID = CT.BENHAN_ID
      JOIN dbo.TT_BENHNHAN BN ON BA.BENHNHAN_ID = BN.BENHNHAN_ID
      WHERE   CT.BENHVIEN_ID = '$BENHVIEN_ID$' AND CAST(BA.NGAYRAVIEN AS DATE) BETWEEN '$TUNGAY$' AND '$DENNGAY$'
      AND CT.IDCHUYEN IS NOT NULL
      AND  ISNULL(CT.LOAI,'') != 'NGOAITRU'
      AND ISNULL(CTCT.GIATRITHANHTOAN,0) > 0
      <isNotEmpty prepend="AND" property="MAYTE">
			  BN.MAYTE LIKE N'%'+#MAYTE#+'%'
		  </isNotEmpty>
		  <isNotEmpty prepend="AND" property="SOTN_BA">
			  ba.SOBENHAN LIKE N'%'+#SOTN_BA#+'%'
		  </isNotEmpty>
		  <isNotEmpty prepend="AND" property="TENBENHNHAN">
			  BN.TENBENHNHAN LIKE N'%'+#TENBENHNHAN#+'%'
		  </isNotEmpty>
    </statement>
    <!--Lấy chi tiết BHYT-->
    <statement id="DAO09800_GetDetailBHYT" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      SELECT  TICHHOP_ID =NULL,
      CT.XACNHANCHIPHI_ID ,
      CTCT.XACNHANCHIPHICHITIET_ID,
      NULL AS MAKHOANMUCDT ,
      NULL AS TENKHOANMUCDT ,
      LOAIVATTU_ID = LD.LOAIVATTU_ID,
      LD.MALOAIDUOC ,
      LD.TENLOAIDUOC ,
      D.MADUOC ,
      TD.TENDUOC ,
      LDV.MALOAIDICHVU ,
      LDV.TENLOAIDICHVU ,
      NDV.MANHOMDICHVU ,
      NDV.TENNHOMDICHVU ,
      DV.MADICHVU ,
      DV.TENDICHVU ,
      DONVITINH = CASE WHEN VP.DICHVU_ID IS NULL THEN D.DONVITINH ELSE DV.DONVITINH END,
      CTCT.SOLUONG ,
      VP.DONGIA_DOANHTHU AS DONGIADOANHTHU ,
      VP.BHYT_DONGIA AS DONGIAHOTRO ,
      VP.BHYT_DONGIA_CHITRA AS DONGIAHOTROCHITRA ,
      VP.BENHNHAN_PHAITHANHTOAN AS DONGIATHANHTOAN ,
      CTCT.SOLUONG * VP.BHYT_DONGIA AS GIATRI,
      NULL AS TYLEVAT ,
      NULL AS GIATRIVAT ,
      NULL AS GIATRICHIETKHAU ,
      CTCT.SOLUONG * VP.BHYT_DONGIA_CHITRA AS GIATRIHOADON ,
      LOAINOIDUNG = CASE WHEN VP.DICHVU_ID IS NULL THEN 'DU' ELSE 'DV' END,
      NTH.MAPHONGBAN AS MANOITHUCHIEN ,
      NTH.TENPHONGBAN AS NOITHUCHIEN ,
      KX.MAKHO AS MAKHOXUAT ,
      KX.TENKHO AS TENKHOXUAT ,
      MAKHOAXUAT = PBX.MAPHONGBAN ,
      TENKHOAXUAT = PBX.TENPHONGBAN
      FROM    dbo.TT_XACNHANCHIPHI CT
      JOIN dbo.TT_XACNHANCHIPHICHITIET CTCT ON CTCT.XACNHANCHIPHI_ID = CT.XACNHANCHIPHI_ID
      LEFT JOIN dbo.TM_PHONGBAN PB ON PB.PHONGBAN_ID = CTCT.PHONGBAN_ID
      JOIN dbo.TT_VIENPHI VP ON VP.VIENPHI_ID = CTCT.VIENPHI_ID
      LEFT JOIN dbo.TM_DICHVU DV ON DV.DICHVU_ID = VP.DICHVU_ID
      LEFT JOIN dbo.TM_NHOMDICHVU NDV ON NDV.NHOMDICHVU_ID = DV.NHOMDICHVU_ID
      LEFT JOIN dbo.TM_LOAIDICHVU LDV ON LDV.LOAIDICHVU_ID = NDV.LOAIDICHVU_ID
      LEFT JOIN dbo.TM_DUOC D ON D.DUOC_ID = VP.DUOC_ID
      LEFT JOIN dbo.TM_LOAIDUOC LD ON LD.LOAIDUOC_ID = D.LOAIDUOC_ID
      LEFT JOIN dbo.TM_TENDUOC TD ON TD.TENDUOC_ID = D.TENDUOC_ID


      LEFT JOIN dbo.TT_DVYEUCAU YC ON VP.REF_ID = YC.DVYEUCAU_ID AND VP.REF_TABLE = 'TT_DVYEUCAU'
      LEFT JOIN dbo.TM_PHONGBAN NTH ON ISNULL(YC.NOITHUCHIENTHAYDOI_ID, YC.NOITHUCHIEN_ID) = NTH.PHONGBAN_ID

      LEFT JOIN dbo.TT_CLSKETQUA_VTYT KQ_VTYT ON VP.REF_ID = KQ_VTYT.CLSKETQUA_VTYT_ID AND VP.REF_TABLE = 'TT_CLSKETQUA_VTYT'
      LEFT JOIN dbo.TT_NGOAITRU_KHAMBENH_VTYT NTKB_VTYT ON VP.REF_ID = NTKB_VTYT.KHAMBENH_VTYT_ID AND VP.REF_TABLE = 'TT_NGOAITRU_KHAMBENH_VTYT'
      LEFT JOIN dbo.TT_NGOAITRU_TOATHUOC NGT_TT ON VP.REF_ID = NGT_TT.TOATHUOC_ID AND VP.REF_TABLE = 'TT_NGOAITRU_TOATHUOC'
      LEFT JOIN dbo.TT_NGOAITRU_KHAMBENH_TOATHUOC KB_TT ON KB_TT.KHAMBENH_TOATHUOC_ID = NGT_TT.KHAMBENH_TOATHUOC_ID
      LEFT JOIN dbo.TT_NOITRU_TOATHUOC NT_TT ON VP.REF_ID = NT_TT.TOATHUOC_ID AND VP.REF_TABLE = 'TT_NOITRU_TOATHUOC'
      LEFT JOIN dbo.TT_PHAUTHUAT_VTYT PT_VTYT ON VP.REF_ID = PT_VTYT.PHAUTHUAT_VTYT_ID AND VP.REF_TABLE = 'TT_PHAUTHUAT_VTYT'
      LEFT JOIN dbo.TT_DUOC_CHUNGTU CTX ON COALESCE(KQ_VTYT.CHUNGTU_ID, NTKB_VTYT.CHUNGTU_ID, KB_TT.CHUNGTUPHATTHUOC_ID, NT_TT.CHUNGTU_ID, PT_VTYT.CHUNGTU_ID) = CTX.CHUNGTU_ID

      LEFT JOIN dbo.TM_KHODUOC KX ON CTX.KHOXUAT_ID = KX.KHODUOC_ID
      LEFT JOIN dbo.TM_PHONGBAN PBX ON CTX.PHONGBAN_ID = PBX.PHONGBAN_ID
      WHERE CT.XACNHANCHIPHI_ID = '$XACNHANCHIPHI_ID$'
    </statement>
    <!--Cập nhật IDChuyen vào bảng BHYT-->
    <update id="DAO09800_UpdateBHYT_IDChuyen" parameterClass="System.Collections.IDictionary">
       UPDATE dbo.TT_XACNHANCHIPHI SET IDCHUYEN = #CHUYENTICHHOP_ID# WHERE XACNHANCHIPHI_ID = '$XACNHANCHIPHI_ID$'
    </update>


    <!--Kiểm tra xem BHYT đã được chuyển lên db trung gian chưa-->
    <statement id="DAO09800_KiemTraBHYTDaChuyen" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      SELECT  1
      FROM    dbo.TT_XACNHANCHIPHI
      WHERE   BENHVIEN_ID = '$BENHVIEN_ID$'
      AND XACNHANCHIPHI_ID = '$XACNHANCHIPHI_ID$'
      AND IDCHUYEN IS NOT NULL;
    </statement>
    
    <!--============================================END BHYT=============================================-->

    <!--============================================BEGIN HÓA ĐƠN VAT=============================================-->
    <!--Lấy danh sách hóa đơn vat-->
    <statement id="DAO09800_GetMasterHoaDonVAT" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      DECLARE @TENBENHVIEN NVARCHAR(250);
      SELECT  @TENBENHVIEN = VALUE
      FROM    dbo.TM_SYS_APPSETTINGS
      WHERE   BENHVIEN_ID = '$BENHVIEN_ID$'
      AND CODE = 'APP_BENHVIEN_TEN';

      SELECT  BTNCHECK = CAST (0 AS BIT) ,
      STATUSROW = CAST (0 AS BIT) ,
      MESSAGEROW = NULL,
      *
      FROM    ( SELECT DISTINCT
      HOADON_ID = HD.HOADON_CHUNGTU_ID ,
      HD.SOHOADON ,
      NGAYHOADON = HD.NGAYTAO ,
      LOAIHOADON = CASE WHEN HDCT.REF_TABLE = 'TT_HOADON'
      THEN CASE WHEN HDVP.REF_TABLE IN (
      'TT_GOIDICHVU_DANGKY',
      'TT_CSKH_THANHVIEN_CAPTHE',
      'TT_CSKH_GOI_DANGKY' )
      THEN 'GOI/THETV'
      WHEN HDVP.REF_TABLE = 'TT_DUOC_CHUNGTU_CHITIET' THEN 'NHATHUOC'
      ELSE 'NOINGOAITRU'
      END
      WHEN HDCT.REF_TABLE = 'TT_MIENGIAM_BHTN'
      THEN 'BHTN'
      WHEN HDCT.REF_TABLE = 'TT_DUOC_CHUNGTU_CHITIET'
      THEN 'NHATHUOC'
      ELSE 'CONGTY'
      END ,
      TIEPNHAN_ID = NULL ,
      HD.BENHNHAN_ID ,
      BENHAN_ID = NULL ,
      BN.MAYTE ,
      ISNULL(HD.TENKHACHHANG ,BN.TENBENHNHAN) AS TENBENHNHAN ,
      ISNULL(HD.DIACHICONGTY, BN.DIACHI) AS DIACHI,
      HD.MASOTHUE ,
      KYHIEUHOADON = NULL ,
      SOSERI = NULL ,
      TIENTE_ID = 'VND' ,
      TYGIA = 1 ,
      GIATRI = HD.GIATRIHOADON ,
      GIATRIVAT = NULL ,
      GIATRICHIETKHAU = NULL ,
      HD.GIATRIHOADON ,
      NV.MANHANVIEN ,
      NV.TENNHANVIEN ,
      DATHANHTOAN = '1' ,
      PHONGBAN_ID = NULL ,
      MAPHONGBAN = NULL ,
      TENPHONGBAN = NULL ,
      COSTCENTER_ID = NULL ,
      COSTCENTERCODE = NULL ,
      COSTCENTERNAME = NULL ,
      HD.BENHVIEN_ID ,
      MABENHVIEN = HD.BENHVIEN_ID ,
      TENBENHVIEN = @TENBENHVIEN ,
      HOANTRA = NULL ,
      HUYHOADON = NULL ,
      CHUYENTICHHOP_ID = NULL ,
      MAHINHTHUCTHANHTOAN = HTTT.DICTIONARY_CODE ,
      TENHINHTHUCTHANHTOAN = HTTT.DICTIONARY_NAME ,
      MANOIDUNG = NULL ,
      TENNOIDUNG = NULL ,
      GAITRI = HD.GIATRIHOADON ,
      TYLEVAT = NULL ,
      GIATRITHANHTOAN = HD.GIATRIHOADON,
      TENCONGTY = ISNULL(CTy.TENCONGTY, HD.TENCONGTY),
      SOBANGKE = CASE WHEN HDCT.REF_TABLE IN ('TT_HOADON', 'TT_DUOC_CHUNGTU_CHITIET')  THEN STUFF( (SELECT ';' + ttHD.SOHOADON FROM dbo.TT_HOADON ttHD
                        JOIN dbo.TT_HOADON_CHUNGTU_CHITIET hdctct ON ttHD.HOADON_ID = hdctct.HOADONLIENQUAN_ID
                        WHERE hdctct.HOADON_CHUNGTU_ID = HD.HOADON_CHUNGTU_ID FOR XML PATH ('')), 1,1,'') 
						when hdct.REF_TABLE in ('TT_MIENGIAM_BHTN') then  
							STUFF( (							
								SELECT ';' + ttHD.SOHOADON FROM 
								(
										select distinct hdNg.SOHOADON from TT_MIENGIAM_BHTN bhtn 
											join TT_MIENGIAM_CHITIET mgct on bhtn.MIENGIAM_BHTN_ID = mgct.MIENGIAM_ID
											join TT_VIENPHI vp on mgct.VIENPHI_ID = vp.VIENPHI_ID
											join TT_HOADON_CHITIET_NGOAITRU vpNg on vp.VIENPHI_ID = vpNg.VIENPHI_ID
											join TT_HOADON hdNg on vpNg.HOADON_ID = hdNg.HOADON_ID and hdNg.DATHANHTOAN  =1 and hdNg.HOANTRA = 0 and hdNg.HUYHOADON = 0
										where bhtn.HOADON_CHUNGTU_LIENQUAN_ID = HD.HOADON_CHUNGTU_ID and mgct.REF_TABLE ='TT_MIENGIAM_BHTN' and isnull(bhtn.BENHAN_ID,0) = 0
										union all
										select distinct hdNo.SOHOADON from TT_MIENGIAM_BHTN bhtn 
											join TT_MIENGIAM_CHITIET mgct on bhtn.MIENGIAM_BHTN_ID = mgct.MIENGIAM_ID
											join TT_VIENPHI vp on mgct.VIENPHI_ID = vp.VIENPHI_ID
											join TT_HOADON_CHITIET_NOITRU vpNo on vp.VIENPHI_ID = vpNo.VIENPHI_ID
											join TT_HOADON hdNo on vpNo.HOADON_ID = hdNo.HOADON_ID and hdNo.DATHANHTOAN  =1 and hdNo.HOANTRA = 0 and hdNo.HUYHOADON = 0
										where bhtn.HOADON_CHUNGTU_LIENQUAN_ID = HD.HOADON_CHUNGTU_ID and mgct.REF_TABLE ='TT_MIENGIAM_BHTN' and isnull(bhtn.BENHAN_ID,0) > 0
									)ttHD
						
							FOR XML PATH ('')), 1,1,'')
						when hdct.REF_TABLE in ('TT_MIENGIAM_CONGTY') then  
							STUFF( (							
								SELECT ';' + ttHD.SOHOADON FROM 
								(
										select distinct hdNg.SOHOADON from TT_MIENGIAM_CONGTY cty 
											join TT_MIENGIAM_CHITIET mgct on cty.MIENGIAM_CONGTY_ID = mgct.MIENGIAM_ID
											join TT_VIENPHI vp on mgct.VIENPHI_ID = vp.VIENPHI_ID
											join TT_HOADON_CHITIET_NGOAITRU vpNg on vp.VIENPHI_ID = vpNg.VIENPHI_ID
											join TT_HOADON hdNg on vpNg.HOADON_ID = hdNg.HOADON_ID and hdNg.DATHANHTOAN  =1 and hdNg.HOANTRA = 0 and hdNg.HUYHOADON = 0
										where cty.HOADON_CHUNGTU_LIENQUAN_ID = HD.HOADON_CHUNGTU_ID and mgct.REF_TABLE ='TT_MIENGIAM_CONGTY' and isnull(cty.BENHAN_ID,0) = 0
										union all
										select distinct hdNo.SOHOADON from TT_MIENGIAM_CONGTY cty 
											join TT_MIENGIAM_CHITIET mgct on cty.MIENGIAM_CONGTY_ID = mgct.MIENGIAM_ID
											join TT_VIENPHI vp on mgct.VIENPHI_ID = vp.VIENPHI_ID
											join TT_HOADON_CHITIET_NOITRU vpNo on vp.VIENPHI_ID = vpNo.VIENPHI_ID
											join TT_HOADON hdNo on vpNo.HOADON_ID = hdNo.HOADON_ID and hdNo.DATHANHTOAN  =1 and hdNo.HOANTRA = 0 and hdNo.HUYHOADON = 0
										where cty.HOADON_CHUNGTU_LIENQUAN_ID = HD.HOADON_CHUNGTU_ID and mgct.REF_TABLE ='TT_MIENGIAM_CONGTY' and isnull(cty.BENHAN_ID,0) > 0
									)ttHD
						
							FOR XML PATH ('')), 1,1,'')						 
						ELSE NULL END ,
      MACONGTY = Cty.MACONGTY
      FROM      dbo.TT_HOADON_CHUNGTU HD
      LEFT JOIN dbo.TT_BENHNHAN BN ON BN.BENHNHAN_ID = HD.BENHNHAN_ID
      JOIN dbo.TT_HOADON_CHUNGTU_CHITIET HDCT ON HD.HOADON_CHUNGTU_ID = HDCT.HOADON_CHUNGTU_ID
	  LEFT JOIN TT_MIENGIAM_CONGTY mgcty on HDCT.HOADONLIENQUAN_ID = mgcty.MIENGIAM_CONGTY_ID and HDCT.REF_TABLE = 'TT_MIENGIAM_CONGTY'
	  LEFT JOIN TM_CONGTYCHITRA CTy ON mgcty.CONGTYCHITRA_ID=CTy.CONGTY_CHITRA_ID
      OUTER APPLY ( SELECT DISTINCT
      CT.REF_TABLE
      FROM      TT_HOADON HD
      INNER JOIN TT_HOADON_CHITIET_NGOAITRU CT ON CT.HOADON_ID = HD.HOADON_ID
      WHERE     HD.HOADON_ID = HDCT.HOADONLIENQUAN_ID
      UNION ALL
      SELECT DISTINCT
      CT.REF_TABLE
      FROM      TT_HOADON HD
      INNER JOIN dbo.TT_HOADON_CHITIET_NOITRU CT ON CT.HOADON_ID = HD.HOADON_ID
      WHERE     HD.HOADON_ID = HDCT.HOADONLIENQUAN_ID
      ) HDVP
      LEFT JOIN dbo.TM_NHANVIEN NV ON HD.NGUOITAO_ID = NV.NHANVIEN_ID
      LEFT JOIN dbo.LST_DICTIONARY HTTT ON HD.HINHTHUCTHANHTOAN_ID = HTTT.DICTIONARY_ID
      WHERE   HD.BENHVIEN_ID = '$BENHVIEN_ID$' AND  CAST(HD.NGAYTAO AS DATE) BETWEEN '$TUNGAY$' AND '$DENNGAY$'
      AND HD.IDCHUYEN IS NULL
      ) HD
      WHERE   1 = 1
      <isNotEmpty prepend="AND" property="LOAIHOADON">
      HD.LOAIHOADON = '$LOAIHOADON$'
    </isNotEmpty>
    <isNotEmpty prepend="AND" property="SOHOADON">
      HD.SOHOADON LIKE N'%'+#SOHOADON#+'%'
    </isNotEmpty>
    <isNotEmpty prepend="AND" property="TENBENHNHAN">
      TENBENHNHAN LIKE N'%'+#TENBENHNHAN#+'%'
    </isNotEmpty>
    </statement>
    <!--Lấy danh sách hóa đơn vat đã chuyển-->
    <statement id="DAO09800_GetMasterHoaDonVAT_DACHUYEN" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      DECLARE @TENBENHVIEN NVARCHAR(250);
      SELECT  @TENBENHVIEN = VALUE
      FROM    dbo.TM_SYS_APPSETTINGS
      WHERE   BENHVIEN_ID = '$BENHVIEN_ID$'
      AND CODE = 'APP_BENHVIEN_TEN';

      SELECT  BTNCHECK = CAST (0 AS BIT) ,
      STATUSROW = CAST (0 AS BIT) ,
      MESSAGEROW = NULL,
      *
      FROM    ( SELECT DISTINCT
      HOADON_ID = HD.HOADON_CHUNGTU_ID ,
      HD.SOHOADON ,
      NGAYHOADON = HD.NGAYTAO ,
      LOAIHOADON = CASE WHEN HDCT.REF_TABLE = 'TT_HOADON'
      THEN CASE WHEN HDVP.REF_TABLE IN (
      'TT_GOIDICHVU_DANGKY',
      'TT_CSKH_THANHVIEN_CAPTHE',
      'TT_CSKH_GOI_DANGKY' )
      THEN 'GOI/THETV'
      WHEN HDVP.REF_TABLE = 'TT_DUOC_CHUNGTU_CHITIET' THEN 'NHATHUOC'
      ELSE 'NOINGOAITRU'
      END
      WHEN HDCT.REF_TABLE = 'TT_MIENGIAM_BHTN'
      THEN 'BHTN'
      WHEN HDCT.REF_TABLE = 'TT_DUOC_CHUNGTU_CHITIET'
      THEN 'NHATHUOC'
      ELSE 'CONGTY'
      END ,
      TIEPNHAN_ID = NULL ,
      HD.BENHNHAN_ID ,
      BENHAN_ID = NULL ,
      BN.MAYTE ,
      ISNULL(HD.TENKHACHHANG ,BN.TENBENHNHAN) AS TENBENHNHAN ,
      ISNULL(HD.DIACHICONGTY, BN.DIACHI) AS DIACHI,
      HD.MASOTHUE ,
      KYHIEUHOADON = NULL ,
      SOSERI = NULL ,
      TIENTE_ID = 'VND' ,
      TYGIA = 1 ,
      GIATRI = HD.GIATRIHOADON ,
      GIATRIVAT = NULL ,
      GIATRICHIETKHAU = NULL ,
      HD.GIATRIHOADON ,
      NV.MANHANVIEN ,
      NV.TENNHANVIEN ,
      DATHANHTOAN = '1' ,
      PHONGBAN_ID = NULL ,
      MAPHONGBAN = NULL ,
      TENPHONGBAN = NULL ,
      COSTCENTER_ID = NULL ,
      COSTCENTERCODE = NULL ,
      COSTCENTERNAME = NULL ,
      HD.BENHVIEN_ID ,
      MABENHVIEN = HD.BENHVIEN_ID ,
      TENBENHVIEN = @TENBENHVIEN ,
      HOANTRA = NULL ,
      HUYHOADON = NULL ,
      CHUYENTICHHOP_ID = NULL ,
      MAHINHTHUCTHANHTOAN = HTTT.DICTIONARY_CODE ,
      TENHINHTHUCTHANHTOAN = HTTT.DICTIONARY_NAME ,
      MANOIDUNG = NULL ,
      TENNOIDUNG = NULL ,
      GAITRI = HD.GIATRIHOADON ,
      TYLEVAT = NULL ,
      GIATRITHANHTOAN = HD.GIATRIHOADON,
      TENCONGTY = CTy.TENCONGTY,
      TH.THOIGIANCHUYEN ,
	  MACONGTY = Cty.MACONGTY
      FROM      dbo.TT_HOADON_CHUNGTU HD
      Join VIEW_IDCHUYENTICHHOP TH on HD.IDCHUYEN = TH.CHUYENTICHHOP_ID
      LEFT JOIN dbo.TT_BENHNHAN BN ON BN.BENHNHAN_ID = HD.BENHNHAN_ID
      JOIN dbo.TT_HOADON_CHUNGTU_CHITIET HDCT ON HD.HOADON_CHUNGTU_ID = HDCT.HOADON_CHUNGTU_ID
	  LEFT JOIN TT_MIENGIAM_CONGTY mgcty on HDCT.HOADONLIENQUAN_ID = mgcty.MIENGIAM_CONGTY_ID and HDCT.REF_TABLE = 'TT_MIENGIAM_CONGTY'
	  LEFT JOIN TM_CONGTYCHITRA CTy ON mgcty.CONGTYCHITRA_ID=CTy.CONGTY_CHITRA_ID
      OUTER APPLY ( SELECT DISTINCT
      CT.REF_TABLE
      FROM      TT_HOADON HD
      INNER JOIN TT_HOADON_CHITIET_NGOAITRU CT ON CT.HOADON_ID = HD.HOADON_ID
      WHERE     HD.HOADON_ID = HDCT.HOADONLIENQUAN_ID
      UNION ALL
      SELECT DISTINCT
      CT.REF_TABLE
      FROM      TT_HOADON HD
      INNER JOIN dbo.TT_HOADON_CHITIET_NOITRU CT ON CT.HOADON_ID = HD.HOADON_ID
      WHERE     HD.HOADON_ID = HDCT.HOADONLIENQUAN_ID
      ) HDVP
      LEFT JOIN dbo.TM_NHANVIEN NV ON HD.NGUOITAO_ID = NV.NHANVIEN_ID
      LEFT JOIN dbo.LST_DICTIONARY HTTT ON HD.HINHTHUCTHANHTOAN_ID = HTTT.DICTIONARY_ID
      WHERE   HD.BENHVIEN_ID = '$BENHVIEN_ID$' AND  CAST(HD.NGAYTAO AS DATE) BETWEEN '$TUNGAY$' AND '$DENNGAY$'

      ) HD
      WHERE  1 = 1
      <isNotEmpty prepend="AND" property="LOAIHOADON">
        HD.LOAIHOADON = '$LOAIHOADON$'
      </isNotEmpty>
      <isNotEmpty prepend="AND" property="SOHOADON">
        HD.SOHOADON LIKE N'%'+#SOHOADON#+'%'
      </isNotEmpty>
      <isNotEmpty prepend="AND" property="TENBENHNHAN">
        TENBENHNHAN LIKE N'%'+#TENBENHNHAN#+'%'
      </isNotEmpty>
    </statement>
    <!--Lấy danh sách hóa đơn vat chi tiết-->
    <statement id="DAO09800_GetMasterHoaDonVATChiTiet" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      DECLARE @MASOTHUE VARCHAR(200), @DIACHI NVARCHAR(1000), @DIENTHOAI VARCHAR(30), @FAX VARCHAR(30), @TENBENHVIEN NVARCHAR(100)
      SET @MASOTHUE = (SELECT VALUE FROM TM_SYS_APPSETTINGS WHERE CODE = 'APP_BENHVIEN_MASOTHUE' AND BENHVIEN_ID = '$BENHVIEN_ID$')
      SET @DIACHI = (SELECT VALUE FROM TM_SYS_APPSETTINGS WHERE CODE = 'APP_BENHVIEN_DIACHI' AND BENHVIEN_ID = '$BENHVIEN_ID$')
      SET @DIENTHOAI = (SELECT VALUE FROM TM_SYS_APPSETTINGS WHERE CODE = 'APP_BENHVIEN_DIENTHOAI' AND BENHVIEN_ID = '$BENHVIEN_ID$')
      SET @FAX = (SELECT VALUE FROM TM_SYS_APPSETTINGS WHERE CODE = 'APP_BENHVIEN_FAX' AND BENHVIEN_ID = '$BENHVIEN_ID$')
      SET @TENBENHVIEN = (SELECT VALUE FROM TM_SYS_APPSETTINGS WHERE CODE = 'APP_BENHVIEN_TEN' AND BENHVIEN_ID = '$BENHVIEN_ID$')

      DECLARE @TEMDICHVU AS TABLE (HOADON_CHUNGTU_ID INT, VIENPHI_ID INT ,GIATRI MONEY, MANHOMDICHVU NVARCHAR(250), TENNHOMDICHVU NVARCHAR(500),COSTCENTER_ID INT,COSTCENTERCODE nvarchar(50),COSTCENTERNAME nvarchar(250),THANHTIEN_DOANHTHU MONEY,MIENGIAMBGD MONEY,MIENGIAMTHE MONEY, IsOP bit, TinhMienGiam bit)
      DECLARE @TEMDUOC AS TABLE (HOADON_CHUNGTU_ID INT, VIENPHI_ID INT ,GIATRI MONEY, VAT INT NULL,COSTCENTER_ID INT,COSTCENTERCODE nvarchar(50),COSTCENTERNAME nvarchar(250),THANHTIEN_DOANHTHU MONEY,MIENGIAMBGD MONEY,MIENGIAMTHE MONEY, IsOP bit, TinhMienGiam bit)

	  DECLARE @TEMDICHVUSUM AS TABLE (HOADON_CHUNGTU_ID INT, VIENPHI_ID INT ,GIATRI MONEY, MANHOMDICHVU NVARCHAR(250), TENNHOMDICHVU NVARCHAR(500),COSTCENTER_ID INT,COSTCENTERCODE nvarchar(50),COSTCENTERNAME nvarchar(250),THANHTIEN_DOANHTHU MONEY,MIENGIAMBGD MONEY,MIENGIAMTHE MONEY, IsOP bit, TinhMienGiam bit)
      DECLARE @TEMDUOCSUM AS TABLE (HOADON_CHUNGTU_ID INT, VIENPHI_ID INT ,GIATRI MONEY, VAT INT NULL,COSTCENTER_ID INT,COSTCENTERCODE nvarchar(50),COSTCENTERNAME nvarchar(250),THANHTIEN_DOANHTHU MONEY,MIENGIAMBGD MONEY,MIENGIAMTHE MONEY, IsOP bit, TinhMienGiam bit)

      DECLARE @TEMNOIDUNG AS TABLE (HOADON_CHUNGTU_ID INT, STT INT, MANOIDUNG NVARCHAR(250) , NOIDUNG NVARCHAR(500), THANHTIENCHUATHUE MONEY, VAT INT NULL ,THANHTIENCOTHUE MONEY, TIENTHUE MONEY ,COSTCENTER_ID INT,COSTCENTERCODE nvarchar(50),COSTCENTERNAME nvarchar(250),THANHTIEN5 MONEY,THANHTIEN10 MONEY,THANHTIENDOANHTHU MONEY,MIENGIAMBGD MONEY,MIENGIAMTHE MONEY)

      INSERT INTO @TEMDICHVU (HOADON_CHUNGTU_ID,VIENPHI_ID ,GIATRI,MANHOMDICHVU, TENNHOMDICHVU,COSTCENTER_ID,COSTCENTERCODE,COSTCENTERNAME, THANHTIEN_DOANHTHU, MIENGIAMBGD, MIENGIAMTHE, IsOP, TinhMienGiam)
      SELECT HD.HOADON_CHUNGTU_ID, CTBL.VIENPHI_ID,ctbl.BENHNHAN_PHAITHANHTOAN, NHOMDV.MANHOMDICHVU, NHOMDV.TENNHOMDICHVU,COS.PHONGBAN_ID,COS.MAPHONGBAN,COS.TENPHONGBAN, THANHTIEN_DOANHTHU = ctbl.BENHNHAN_PHAITHANHTOAN, NULL, NULL, 1, 1
      FROM TT_HOADON_CHUNGTU HD
      INNER JOIN TT_HOADON_CHUNGTU_CHITIET CT ON CT.HOADON_CHUNGTU_ID=HD.HOADON_CHUNGTU_ID
      INNER JOIN TT_HOADON BIENLAI ON CT.HOADONLIENQUAN_ID=BIENLAI.HOADON_ID
      INNER JOIN TT_HOADON_CHITIET_NGOAITRU CTBL ON BIENLAI.HOADON_ID=CTBL.HOADON_ID   AND CTBL.REF_TABLE ='TT_DVYEUCAU'
      INNER JOIN TT_DVYEUCAU YC ON CTBL.REF_ID= YC.DVYEUCAU_ID
      INNER JOIN dbo.TM_PHONGBAN PB ON PB.PHONGBAN_ID = ISNULL(YC.NOITHUCHIENTHAYDOI_ID,YC.NOITHUCHIEN_ID)
      LEFT JOIN dbo.TM_PHONGBAN COS ON PB.COSTCENTER_ID = COS.PHONGBAN_ID
      INNER JOIN TM_DICHVU DV ON YC.DICHVU_ID=DV.DICHVU_ID
      INNER JOIN TM_NHOMDICHVU NHOMDV ON DV.NHOMDICHVU_ID=NHOMDV.NHOMDICHVU_ID
      WHERE   HD.HOADON_CHUNGTU_ID='$HOADON_ID$' AND CT.REF_TABLE='TT_HOADON'
      UNION ALL
      SELECT HD.HOADON_CHUNGTU_ID, CTBL.VIENPHI_ID ,ctbl.BENHNHAN_PHAITHANHTOAN, MANHOMDICHVU = DM.MAGOI, TENNHOMDICHVU = DM.TENGOI,PHONGBAN_ID = NULL,MAPHONGBAN = NULL,TENPHONGBAN = NULL, THANHTIEN_DOANHTHU = ctbl.BENHNHAN_PHAITHANHTOAN, NULL, NULL, 1, 1
      FROM TT_HOADON_CHUNGTU HD
      INNER JOIN TT_HOADON_CHUNGTU_CHITIET CT ON CT.HOADON_CHUNGTU_ID=HD.HOADON_CHUNGTU_ID
      INNER JOIN TT_HOADON BIENLAI ON CT.HOADONLIENQUAN_ID=BIENLAI.HOADON_ID
      INNER JOIN TT_HOADON_CHITIET_NGOAITRU CTBL ON BIENLAI.HOADON_ID=CTBL.HOADON_ID   AND CTBL.REF_TABLE ='TT_CSKH_GOI_DANGKY'
      INNER JOIN dbo.TT_CSKH_GOI_DANGKY GOI ON CTBL.REF_ID = GOI.DANGKY_ID
      JOIN dbo.TM_CSKH_GOI DM ON DM.GOI_ID = GOI.GOI_ID
      WHERE   HD.HOADON_CHUNGTU_ID='$HOADON_ID$' AND CT.REF_TABLE='TT_HOADON'
      UNION ALL
      SELECT HD.HOADON_CHUNGTU_ID, CTBL.VIENPHI_ID ,ctbl.BENHNHAN_PHAITHANHTOAN, MANHOMDICHVU=TTV.MATHETHANHVIEN, TENNHOMDICHVU = TTV.TENTHETHANHVIEN,COS.PHONGBAN_ID,COS.MAPHONGBAN,COS.TENPHONGBAN, THANHTIEN_DOANHTHU = ctbl.BENHNHAN_PHAITHANHTOAN, NULL, NULL, 1, 1
      FROM TT_HOADON_CHUNGTU HD
      INNER JOIN TT_HOADON_CHUNGTU_CHITIET CT ON CT.HOADON_CHUNGTU_ID=HD.HOADON_CHUNGTU_ID
      INNER JOIN TT_HOADON BIENLAI ON CT.HOADONLIENQUAN_ID=BIENLAI.HOADON_ID
      INNER JOIN TT_HOADON_CHITIET_NGOAITRU CTBL ON BIENLAI.HOADON_ID=CTBL.HOADON_ID   AND CTBL.REF_TABLE ='TT_CSKH_THANHVIEN_CAPTHE'
      INNER JOIN dbo.TT_CSKH_THANHVIEN_CAPTHE THE ON CTBL.REF_ID = THE.THE_ID
      JOIN	dbo.TM_CSKH_THETHANHVIEN TTV ON TTV.THETHANHVIEN_ID = THE.THETHANHVIEN_ID
      JOIN dbo.TT_CSKH_THANHVIEN TV ON TV.THANHVIEN_ID = THE.THANHVIEN_ID
      INNER JOIN dbo.TM_PHONGBAN PB ON PB.PHONGBAN_ID = TV.NOICHIDINH_ID
      LEFT JOIN dbo.TM_PHONGBAN COS ON PB.COSTCENTER_ID = COS.PHONGBAN_ID
      WHERE   HD.HOADON_CHUNGTU_ID='$HOADON_ID$' AND CT.REF_TABLE='TT_HOADON'
      UNION ALL
      SELECT HD.HOADON_CHUNGTU_ID, CTBL.VIENPHI_ID ,ctbl.BENHNHAN_PHAITHANHTOAN, NHOMDV.MANHOMDICHVU, NHOMDV.TENNHOMDICHVU,COS.PHONGBAN_ID,COS.MAPHONGBAN,COS.TENPHONGBAN, THANHTIEN_DOANHTHU = ctbl.BENHNHAN_PHAITHANHTOAN, NULL, NULL, 0, 1
      FROM TT_HOADON_CHUNGTU HD
      INNER JOIN TT_HOADON_CHUNGTU_CHITIET CT ON CT.HOADON_CHUNGTU_ID=HD.HOADON_CHUNGTU_ID
      INNER JOIN TT_HOADON BIENLAI ON CT.HOADONLIENQUAN_ID=BIENLAI.HOADON_ID
      INNER JOIN dbo.TT_HOADON_CHITIET_NOITRU CTBL ON BIENLAI.HOADON_ID=CTBL.HOADON_ID  AND CTBL.REF_TABLE ='TT_DVYEUCAU'
      INNER JOIN TT_DVYEUCAU YC ON CTBL.REF_ID= YC.DVYEUCAU_ID
      INNER JOIN dbo.TM_PHONGBAN PB ON PB.PHONGBAN_ID = ISNULL(YC.NOITHUCHIENTHAYDOI_ID,YC.NOITHUCHIEN_ID)
      LEFT JOIN dbo.TM_PHONGBAN COS ON PB.COSTCENTER_ID = COS.PHONGBAN_ID
      INNER JOIN TM_DICHVU DV ON YC.DICHVU_ID=DV.DICHVU_ID
      INNER JOIN TM_NHOMDICHVU NHOMDV ON DV.NHOMDICHVU_ID=NHOMDV.NHOMDICHVU_ID
      WHERE   HD.HOADON_CHUNGTU_ID='$HOADON_ID$' AND CT.REF_TABLE='TT_HOADON'

      UNION ALL
      SELECT HD.HOADON_CHUNGTU_ID, CTBL.VIENPHI_ID ,ctbl.BENHNHAN_PHAITHANHTOAN, MANHOMDICHVU = NHOMDV.MALOAIKHAUPHANAN, TENNHOMDICHVU = NHOMDV.TENLOAIKHAUPHANAN,COS.PHONGBAN_ID,COS.MAPHONGBAN,COS.TENPHONGBAN, THANHTIEN_DOANHTHU = ctbl.BENHNHAN_PHAITHANHTOAN, NULL, NULL, 0, 1
      FROM TT_HOADON_CHUNGTU HD
      INNER JOIN TT_HOADON_CHUNGTU_CHITIET CT ON CT.HOADON_CHUNGTU_ID=HD.HOADON_CHUNGTU_ID
      INNER JOIN TT_HOADON BIENLAI ON CT.HOADONLIENQUAN_ID=BIENLAI.HOADON_ID
      INNER JOIN dbo.TT_HOADON_CHITIET_NOITRU CTBL ON BIENLAI.HOADON_ID=CTBL.HOADON_ID  AND CTBL.REF_TABLE ='TT_NUT_XACNHANSUATAN_CHITIET'
      INNER JOIN TT_NUT_XACNHANSUATAN_CHITIET YC ON CTBL.REF_ID= YC.XACNHANSUATANCHITIET_ID
      INNER JOIN dbo.TT_NUT_CHIDINHKHAUPHAN_CHITIET CDCT ON YC.CHIDINHKHAUPHANCHITIET_ID = CDCT.CHIDINHKHAUPHANCHITIET_ID
      INNER JOIN dbo.TT_NUT_CHIDINHKHAUPHAN CD ON CD.CHIDINHKHAUPHAN_ID = CDCT.CHIDINHKHAUPHAN_ID
      INNER JOIN dbo.TM_PHONGBAN PB ON PB.PHONGBAN_ID = CD.PHONGBAN_ID
      LEFT JOIN dbo.TM_PHONGBAN COS ON PB.COSTCENTER_ID = COS.PHONGBAN_ID
      INNER JOIN TM_NUT_KHAUPHANAN DV ON CDCT.KHAUPHANAN_ID=DV.KHAUPHANAN_ID
      INNER JOIN TM_NUT_LOAIKHAUPHANAN NHOMDV ON DV.LOAIKHAUPHANAN_ID=NHOMDV.LOAIKHAUPHANAN_ID
      WHERE   HD.HOADON_CHUNGTU_ID='$HOADON_ID$' AND CTBL.REF_TABLE='TT_NUT_XACNHANSUATAN_CHITIET'

      UNION ALL
      SELECT HD.HOADON_CHUNGTU_ID, CTBL.VIENPHI_ID ,ctbl.GIATRIMIENGIAM, NHOMDV.MANHOMDICHVU, NHOMDV.TENNHOMDICHVU,PB.PHONGBAN_ID,PB.MAPHONGBAN,PB.TENPHONGBAN, THANHTIEN_DOANHTHU = CTBL.GIATRIMIENGIAM, MIENGIAM_GIATRI = NULL	, HOIVIEN_GIATRI = NULL, IsOP = case when ISNULL(VP.BENHAN_ID,0) > 0 then 0 else 1 end, 0
      FROM TT_HOADON_CHUNGTU HD
      INNER JOIN TT_HOADON_CHUNGTU_CHITIET CT ON CT.HOADON_CHUNGTU_ID=HD.HOADON_CHUNGTU_ID
      INNER JOIN TT_MIENGIAM_BHTN BIENLAI ON CT.HOADONLIENQUAN_ID=BIENLAI.MIENGIAM_BHTN_ID
      INNER JOIN TT_MIENGIAM_CHITIET CTBL ON BIENLAI.MIENGIAM_BHTN_ID=CTBL.MIENGIAM_ID AND CTBL.REF_TABLE = 'TT_MIENGIAM_BHTN'
      INNER JOIN TT_VIENPHI VP ON ctbl.VIENPHI_ID= VP.VIENPHI_ID AND VP.REF_TABLE = 'TT_DVYEUCAU'
      INNER JOIN dbo.TT_DVYEUCAU yc ON yc.DVYEUCAU_ID = vp.REF_ID AND VP.DICHVU_ID IS NOT NULL
      INNER JOIN dbo.TM_PHONGBAN PB ON PB.PHONGBAN_ID = ISNULL(YC.NOITHUCHIENTHAYDOI_ID,YC.NOITHUCHIEN_ID)
      LEFT JOIN dbo.TM_PHONGBAN COS ON PB.COSTCENTER_ID = COS.PHONGBAN_ID
      INNER JOIN TM_DICHVU DV ON VP.DICHVU_ID=DV.DICHVU_ID
      INNER JOIN TM_NHOMDICHVU NHOMDV ON DV.NHOMDICHVU_ID=NHOMDV.NHOMDICHVU_ID
      WHERE   HD.HOADON_CHUNGTU_ID='$HOADON_ID$' AND CT.REF_TABLE='TT_MIENGIAM_BHTN'
      UNION ALL
      SELECT HD.HOADON_CHUNGTU_ID, CTBL.VIENPHI_ID ,ctbl.GIATRIMIENGIAM, MANHOMDICHVU = NHOMDV.MALOAIKHAUPHANAN, TENNHOMDICHVU = NHOMDV.TENLOAIKHAUPHANAN,COS.PHONGBAN_ID,COS.MAPHONGBAN,COS.TENPHONGBAN, THANHTIEN_DOANHTHU = CTBL.GIATRIMIENGIAM, MIENGIAM_GIATRI = NULL	, HOIVIEN_GIATRI = NULL, IsOP = case when ISNULL(Vp.BENHAN_ID,0) > 0 then 0 else 1 end, 0
      FROM TT_HOADON_CHUNGTU HD
      INNER JOIN TT_HOADON_CHUNGTU_CHITIET CT ON CT.HOADON_CHUNGTU_ID=HD.HOADON_CHUNGTU_ID
      INNER JOIN TT_MIENGIAM_BHTN BIENLAI ON CT.HOADONLIENQUAN_ID=BIENLAI.MIENGIAM_BHTN_ID
      INNER JOIN TT_MIENGIAM_CHITIET CTBL ON BIENLAI.MIENGIAM_BHTN_ID=CTBL.MIENGIAM_ID AND CTBL.REF_TABLE = 'TT_MIENGIAM_BHTN'
      INNER JOIN TT_VIENPHI VP ON ctbl.VIENPHI_ID= VP.VIENPHI_ID AND VP.REF_TABLE = 'TT_NUT_XACNHANSUATAN_CHITIET'
      INNER JOIN TT_NUT_XACNHANSUATAN_CHITIET yc ON yc.XACNHANSUATANCHITIET_ID = vp.REF_ID
      INNER JOIN dbo.TT_NUT_CHIDINHKHAUPHAN_CHITIET CDCT ON YC.CHIDINHKHAUPHANCHITIET_ID = CDCT.CHIDINHKHAUPHANCHITIET_ID
      INNER JOIN dbo.TT_NUT_CHIDINHKHAUPHAN CD ON CD.CHIDINHKHAUPHAN_ID = CDCT.CHIDINHKHAUPHAN_ID
      INNER JOIN dbo.TM_PHONGBAN PB ON PB.PHONGBAN_ID = CD.PHONGBAN_ID
      LEFT JOIN dbo.TM_PHONGBAN COS ON PB.COSTCENTER_ID = COS.PHONGBAN_ID
      INNER JOIN TM_NUT_KHAUPHANAN DV ON CDCT.KHAUPHANAN_ID=DV.KHAUPHANAN_ID
      INNER JOIN TM_NUT_LOAIKHAUPHANAN NHOMDV ON DV.LOAIKHAUPHANAN_ID=NHOMDV.LOAIKHAUPHANAN_ID
      WHERE   HD.HOADON_CHUNGTU_ID='$HOADON_ID$' AND CT.REF_TABLE='TT_MIENGIAM_BHTN' AND VP.DICHVU_ID IS NOT NULL
      UNION ALL
      SELECT HD.HOADON_CHUNGTU_ID, CTBL.VIENPHI_ID,ctbl.GIATRIMIENGIAM, NHOMDV.MANHOMDICHVU, NHOMDV.TENNHOMDICHVU,PB.PHONGBAN_ID,PB.MAPHONGBAN,PB.TENPHONGBAN, THANHTIEN_DOANHTHU = CTBL.GIATRIMIENGIAM, MIENGIAM_GIATRI = NULL	, HOIVIEN_GIATRI = NULL, IsOP = case when ISNULL(Vp.BENHAN_ID,0) > 0 then 0 else 1 end, 0
      FROM TT_HOADON_CHUNGTU HD
      INNER JOIN TT_HOADON_CHUNGTU_CHITIET CT ON CT.HOADON_CHUNGTU_ID=HD.HOADON_CHUNGTU_ID
      INNER JOIN TT_MIENGIAM_CONGTY BIENLAI ON CT.HOADONLIENQUAN_ID=BIENLAI.MIENGIAM_CONGTY_ID
      INNER JOIN TT_MIENGIAM_CHITIET CTBL ON BIENLAI.MIENGIAM_CONGTY_ID=CTBL.MIENGIAM_ID AND CTBL.REF_TABLE = 'TT_MIENGIAM_CONGTY'
      INNER JOIN TT_VIENPHI VP ON ctbl.VIENPHI_ID= VP.VIENPHI_ID AND VP.REF_TABLE = 'TT_DVYEUCAU'
      INNER JOIN dbo.TT_DVYEUCAU yc ON yc.DVYEUCAU_ID = vp.REF_ID AND VP.DICHVU_ID IS NOT NULL
      INNER JOIN dbo.TM_PHONGBAN PB ON PB.PHONGBAN_ID = ISNULL(YC.NOITHUCHIENTHAYDOI_ID,YC.NOITHUCHIEN_ID)
      LEFT JOIN dbo.TM_PHONGBAN COS ON PB.COSTCENTER_ID = COS.PHONGBAN_ID
      INNER JOIN TM_DICHVU DV ON VP.DICHVU_ID=DV.DICHVU_ID
      INNER JOIN TM_NHOMDICHVU NHOMDV ON DV.NHOMDICHVU_ID=NHOMDV.NHOMDICHVU_ID
      WHERE   HD.HOADON_CHUNGTU_ID='$HOADON_ID$' AND CT.REF_TABLE='TT_MIENGIAM_CONGTY'
      UNION ALL
      SELECT HD.HOADON_CHUNGTU_ID, CTBL.VIENPHI_ID ,ctbl.GIATRIMIENGIAM, MANHOMDICHVU = NHOMDV.MALOAIKHAUPHANAN, TENNHOMDICHVU = NHOMDV.TENLOAIKHAUPHANAN,COS.PHONGBAN_ID,COS.MAPHONGBAN,COS.TENPHONGBAN, THANHTIEN_DOANHTHU = CTBL.GIATRIMIENGIAM, MIENGIAM_GIATRI = NULL	, HOIVIEN_GIATRI = NULL, IsOP = case when ISNULL(Vp.BENHAN_ID,0) > 0 then 0 else 1 end, 0
      FROM TT_HOADON_CHUNGTU HD
      INNER JOIN TT_HOADON_CHUNGTU_CHITIET CT ON CT.HOADON_CHUNGTU_ID=HD.HOADON_CHUNGTU_ID
      INNER JOIN TT_MIENGIAM_CONGTY BIENLAI ON CT.HOADONLIENQUAN_ID=BIENLAI.MIENGIAM_CONGTY_ID
      INNER JOIN TT_MIENGIAM_CHITIET CTBL ON BIENLAI.MIENGIAM_CONGTY_ID=CTBL.MIENGIAM_ID AND CTBL.REF_TABLE = 'TT_MIENGIAM_CONGTY'
      INNER JOIN TT_VIENPHI VP ON ctbl.VIENPHI_ID= VP.VIENPHI_ID AND vp.REF_TABLE = 'TT_NUT_XACNHANSUATAN_CHITIET'
      INNER JOIN TT_NUT_XACNHANSUATAN_CHITIET yc ON yc.XACNHANSUATANCHITIET_ID = vp.REF_ID
      INNER JOIN dbo.TT_NUT_CHIDINHKHAUPHAN_CHITIET CDCT ON YC.CHIDINHKHAUPHANCHITIET_ID = CDCT.CHIDINHKHAUPHANCHITIET_ID
      INNER JOIN dbo.TT_NUT_CHIDINHKHAUPHAN CD ON CD.CHIDINHKHAUPHAN_ID = CDCT.CHIDINHKHAUPHAN_ID
      INNER JOIN dbo.TM_PHONGBAN PB ON PB.PHONGBAN_ID = CD.PHONGBAN_ID
      LEFT JOIN dbo.TM_PHONGBAN COS ON PB.COSTCENTER_ID = COS.PHONGBAN_ID
      INNER JOIN TM_NUT_KHAUPHANAN DV ON CDCT.KHAUPHANAN_ID=DV.KHAUPHANAN_ID
      INNER JOIN TM_NUT_LOAIKHAUPHANAN NHOMDV ON DV.LOAIKHAUPHANAN_ID=NHOMDV.LOAIKHAUPHANAN_ID
      WHERE   HD.HOADON_CHUNGTU_ID='$HOADON_ID$' AND CT.REF_TABLE='TT_MIENGIAM_CONGTY'


      INSERT INTO @TEMDUOC (HOADON_CHUNGTU_ID, VIENPHI_ID,GIATRI,VAT,COSTCENTER_ID,COSTCENTERCODE,COSTCENTERNAME, THANHTIEN_DOANHTHU, MIENGIAMBGD, MIENGIAMTHE, IsOP, TinhMienGiam)
      SELECT  HD.HOADON_CHUNGTU_ID, CTBL.VIENPHI_ID,ctbl.BENHNHAN_PHAITHANHTOAN,NULL,COSTCENTER_ID = COS.PHONGBAN_ID,COSTCENTERCODE = COS.MAPHONGBAN,COSTCENTERNAME = COS.TENPHONGBAN, THANHTIEN_DOANHTHU = ctbl.BENHNHAN_PHAITHANHTOAN, NULL, NULL, 1, 1
      FROM TT_HOADON_CHUNGTU HD
      INNER JOIN TT_HOADON_CHUNGTU_CHITIET CT ON CT.HOADON_CHUNGTU_ID=HD.HOADON_CHUNGTU_ID
      INNER JOIN TT_HOADON BIENLAI ON CT.HOADONLIENQUAN_ID=BIENLAI.HOADON_ID
      INNER JOIN TT_HOADON_CHITIET_NGOAITRU CTBL ON BIENLAI.HOADON_ID=CTBL.HOADON_ID
      INNER JOIN TT_VIENPHI  VP ON VP.VIENPHI_ID= CTBL.VIENPHI_ID
      INNER JOIN TM_DUOC D ON VP.DUOC_ID=D.DUOC_ID
      LEFT JOIN dbo.TT_NGOAITRU_TOATHUOC kb_tt ON VP.REF_ID = kb_tt.TOATHUOC_ID AND VP.REF_TABLE ='TT_NGOAITRU_TOATHUOC'
      LEFT JOIN dbo.TT_NGOAITRU_KHAMBENH KB_TTBH ON KB_TTBH.KHAMBENH_ID = kb_tt.KHAMBENH_ID

      LEFT JOIN dbo.TT_DUOC_CHUNGTU_CHITIET DCTCT ON CTBL.REF_ID = DCTCT.CHUNGTUCHITIET_ID AND CTBL.REF_TABLE ='TT_DUOC_CHUNGTU_CHITIET'
      outer apply(select top 1 * from TT_NGOAITRU_KHAMBENH_TOATHUOC where DCTCT.CHUNGTU_ID = CHUNGTUPHATTHUOC_ID ) KBTT
      LEFT JOIN TT_NGOAITRU_KHAMBENH KB ON KB.KHAMBENH_ID = KBTT.KHAMBENH_ID
      LEFT JOIN dbo.TT_NOITRU_TOATHUOC NTTT ON DCTCT.CHUNGTU_ID = NTTT.CHUNGTU_ID AND DCTCT.DUOC_ID = NTTT.DUOC_ID
      LEFT JOIN dbo.TT_NOITRU_KHAMBENH NTKB ON NTKB.KHAMBENH_ID = NTTT.KHAMBENH_ID

      LEFT JOIN dbo.TT_NGOAITRU_KHAMBENH_VTYT kb_vtyt ON CTBL.REF_ID = kb_vtyt.KHAMBENH_VTYT_ID AND CTBL.REF_TABLE ='TT_NGOAITRU_KHAMBENH_VTYT'
      LEFT JOIN dbo.TT_NGOAITRU_KHAMBENH kbVTYT ON kbVTYT.KHAMBENH_ID = kb_vtyt.KHAMBENH_ID
      LEFT JOIN dbo.TT_PHAUTHUAT_VTYT pt_vtyt ON CTBL.REF_ID = pt_vtyt.PHAUTHUAT_VTYT_ID AND CTBL.REF_TABLE ='TT_PHAUTHUAT_VTYT'
      LEFT JOIN dbo.TT_PHAUTHUAT pt ON pt.PHAUTHUAT_ID = pt_vtyt.PHAUTHUAT_ID
      LEFT JOIN dbo.TT_CLSKETQUA_VTYT clsKQ_vtyt ON CTBL.REF_ID = clsKQ_vtyt.CLSKETQUA_VTYT_ID AND CTBL.REF_TABLE ='TT_CLSKETQUA_VTYT'
      LEFT JOIN dbo.TT_CLSKETQUA  clsKQ ON clsKQ.CLSKETQUA_ID = clsKQ_vtyt.CLSKETQUA_ID

      LEFT JOIN dbo.TM_PHONGBAN pb ON pb.PHONGBAN_ID = COALESCE(KB_TTBH.PHONGBAN_ID ,KB.PHONGBAN_ID, NTKB.PHONGBAN_ID,kbVTYT.PHONGBAN_ID, pt.PHONGBANTHUCHIEN_ID, clsKQ.NOITHUCHIEN_ID  )
      LEFT JOIN dbo.TM_PHONGBAN COS ON pb.COSTCENTER_ID = COS.PHONGBAN_ID

      WHERE   HD.HOADON_CHUNGTU_ID='$HOADON_ID$' AND CT.REF_TABLE='TT_HOADON'

      UNION ALL
      SELECT HD.HOADON_CHUNGTU_ID, CTBL.VIENPHI_ID,ctbl.BENHNHAN_PHAITHANHTOAN,NULL,COSTCENTER_ID = COS.PHONGBAN_ID,COSTCENTERCODE = COS.MAPHONGBAN,COSTCENTERNAME = COS.TENPHONGBAN, THANHTIEN_DOANHTHU = ctbl.BENHNHAN_PHAITHANHTOAN, NULL, NULL, 0, 1
      FROM TT_HOADON_CHUNGTU HD
      INNER JOIN TT_HOADON_CHUNGTU_CHITIET CT ON CT.HOADON_CHUNGTU_ID=HD.HOADON_CHUNGTU_ID
      INNER JOIN TT_HOADON BIENLAI ON CT.HOADONLIENQUAN_ID=BIENLAI.HOADON_ID
      INNER JOIN TT_HOADON_CHITIET_NOITRU CTBL ON BIENLAI.HOADON_ID=CTBL.HOADON_ID
      INNER JOIN TT_VIENPHI  VP ON VP.VIENPHI_ID= CTBL.VIENPHI_ID
      INNER JOIN TM_DUOC D ON VP.DUOC_ID=D.DUOC_ID

      LEFT JOIN dbo.TT_NOITRU_TOATHUOC NTTT ON CTBL.REF_ID = NTTT.TOATHUOC_ID AND CTBL.REF_TABLE ='TT_NOITRU_TOATHUOC'
      LEFT JOIN dbo.TT_NOITRU_KHAMBENH NTKB ON NTKB.KHAMBENH_ID = NTTT.KHAMBENH_ID

      LEFT JOIN dbo.TT_PHAUTHUAT_VTYT pt_vtyt ON CTBL.REF_ID = pt_vtyt.PHAUTHUAT_VTYT_ID AND CTBL.REF_TABLE ='TT_PHAUTHUAT_VTYT'
      LEFT JOIN dbo.TT_PHAUTHUAT pt ON pt.PHAUTHUAT_ID = pt_vtyt.PHAUTHUAT_ID
      LEFT JOIN dbo.TT_CLSKETQUA_VTYT clsKQ_vtyt ON CTBL.REF_ID = clsKQ_vtyt.CLSKETQUA_VTYT_ID AND CTBL.REF_TABLE ='TT_CLSKETQUA_VTYT'
      LEFT JOIN dbo.TT_CLSKETQUA  clsKQ ON clsKQ.CLSKETQUA_ID = clsKQ_vtyt.CLSKETQUA_ID

	  LEFT JOIN dbo.TT_DUOC_CHUNGTU_CHITIET DCTCT ON CTBL.REF_ID = DCTCT.CHUNGTUCHITIET_ID AND CTBL.REF_TABLE ='TT_DUOC_CHUNGTU_CHITIET'
      LEFT JOIN dbo.TT_DUOC_CHUNGTU DCT ON DCTCT.CHUNGTU_ID = DCT.CHUNGTU_ID

      LEFT JOIN dbo.TM_PHONGBAN pb ON pb.PHONGBAN_ID = COALESCE( NTKB.PHONGBAN_ID, pt.PHONGBANTHUCHIEN_ID, clsKQ.NOITHUCHIEN_ID, DCT.PHONGBAN_ID )
      LEFT JOIN dbo.TM_PHONGBAN COS ON pb.COSTCENTER_ID = COS.PHONGBAN_ID

      WHERE   HD.HOADON_CHUNGTU_ID='$HOADON_ID$' AND CT.REF_TABLE='TT_HOADON'

      UNION ALL


      SELECT HD.HOADON_CHUNGTU_ID, CTBL.VIENPHI_ID ,ctbl.GIATRIMIENGIAM,TYLE_VAT = CASE WHEN BIENLAI.BENHAN_ID = 0 AND VP.REF_TABLE ='TT_DUOC_CHUNGTU_CHITIET' THEN D.TYLE_VAT ELSE NULL END,COSTCENTER_ID = COS.PHONGBAN_ID,COSTCENTERCODE = COS.MAPHONGBAN,COSTCENTERNAME = COS.TENPHONGBAN, THANHTIEN_DOANHTHU = CTBL.GIATRIMIENGIAM, MIENGIAM_GIATRI = NULL	, HOIVIEN_GIATRI = NULL, IsOP = case when ISNULL(BIENLAI.BENHAN_ID,0) > 0 then 0 else 1 end, 0
      FROM TT_HOADON_CHUNGTU HD
      INNER JOIN TT_HOADON_CHUNGTU_CHITIET CT ON CT.HOADON_CHUNGTU_ID=HD.HOADON_CHUNGTU_ID
      INNER JOIN TT_MIENGIAM_BHTN BIENLAI ON CT.HOADONLIENQUAN_ID=BIENLAI.MIENGIAM_BHTN_ID
      INNER JOIN TT_MIENGIAM_CHITIET CTBL ON BIENLAI.MIENGIAM_BHTN_ID=CTBL.MIENGIAM_ID AND CTBL.REF_TABLE = 'TT_MIENGIAM_BHTN'
      INNER JOIN TT_VIENPHI  VP ON VP.VIENPHI_ID= CTBL.VIENPHI_ID
      INNER JOIN TM_DUOC D ON VP.DUOC_ID=D.DUOC_ID

      LEFT JOIN dbo.TT_NGOAITRU_TOATHUOC kb_tt ON VP.REF_ID = kb_tt.TOATHUOC_ID AND VP.REF_TABLE ='TT_NGOAITRU_TOATHUOC'
      LEFT JOIN dbo.TT_NGOAITRU_KHAMBENH kbTT ON kbTT.KHAMBENH_ID = kb_tt.KHAMBENH_ID

      LEFT JOIN dbo.TT_NGOAITRU_KHAMBENH_VTYT kb_vtyt ON VP.REF_ID = kb_vtyt.KHAMBENH_VTYT_ID AND VP.REF_TABLE ='TT_NGOAITRU_KHAMBENH_VTYT'
      LEFT JOIN dbo.TT_NGOAITRU_KHAMBENH kbVTYT ON kbVTYT.KHAMBENH_ID = kb_vtyt.KHAMBENH_ID
      LEFT JOIN dbo.TT_NOITRU_TOATHUOC NTTT ON VP.REF_ID = NTTT.TOATHUOC_ID AND VP.REF_TABLE ='TT_NOITRU_TOATHUOC'
      LEFT JOIN dbo.TT_NOITRU_KHAMBENH NTKB ON NTKB.KHAMBENH_ID = NTTT.KHAMBENH_ID
      LEFT JOIN dbo.TT_PHAUTHUAT_VTYT pt_vtyt ON VP.REF_ID = pt_vtyt.PHAUTHUAT_VTYT_ID AND VP.REF_TABLE ='TT_PHAUTHUAT_VTYT'
      LEFT JOIN dbo.TT_PHAUTHUAT pt ON pt.PHAUTHUAT_ID = pt_vtyt.PHAUTHUAT_ID
      LEFT JOIN dbo.TT_CLSKETQUA_VTYT clsKQ_vtyt ON VP.REF_ID = clsKQ_vtyt.CLSKETQUA_VTYT_ID AND VP.REF_TABLE ='TT_CLSKETQUA_VTYT'
      LEFT JOIN dbo.TT_CLSKETQUA  clsKQ ON clsKQ.CLSKETQUA_ID = clsKQ_vtyt.CLSKETQUA_ID

	  LEFT JOIN dbo.TT_DUOC_CHUNGTU_CHITIET DCTCT ON VP.REF_ID = DCTCT.CHUNGTUCHITIET_ID AND VP.REF_TABLE ='TT_DUOC_CHUNGTU_CHITIET'
      LEFT JOIN dbo.TT_DUOC_CHUNGTU DCT ON DCTCT.CHUNGTU_ID = DCT.CHUNGTU_ID

      LEFT JOIN dbo.TM_PHONGBAN pb ON pb.PHONGBAN_ID = COALESCE(kbTT.PHONGBAN_ID, kbVTYT.PHONGBAN_ID ,NTKB.PHONGBAN_ID, pt.PHONGBANTHUCHIEN_ID, clsKQ.NOITHUCHIEN_ID , DCT.PHONGBAN_ID)
      LEFT JOIN dbo.TM_PHONGBAN COS ON pb.COSTCENTER_ID = COS.PHONGBAN_ID


      WHERE   HD.HOADON_CHUNGTU_ID='$HOADON_ID$' AND CT.REF_TABLE='TT_MIENGIAM_BHTN'
      UNION ALL
      SELECT HD.HOADON_CHUNGTU_ID, CTBL.VIENPHI_ID ,ctbl.GIATRIMIENGIAM,TYLE_VAT = CASE WHEN BIENLAI.BENHAN_ID = 0 AND VP.REF_TABLE ='TT_DUOC_CHUNGTU_CHITIET' THEN D.TYLE_VAT ELSE NULL END,COSTCENTER_ID = COS.PHONGBAN_ID,COSTCENTERCODE = COS.MAPHONGBAN,COSTCENTERNAME = COS.TENPHONGBAN, THANHTIEN_DOANHTHU = ctbl.GIATRIMIENGIAM, MIENGIAM_GIATRI = NULL	, HOIVIEN_GIATRI = NULL, IsOP = case when ISNULL(BIENLAI.BENHAN_ID,0) > 0 then 0 else 1 end, 0
      FROM TT_HOADON_CHUNGTU HD
      INNER JOIN TT_HOADON_CHUNGTU_CHITIET CT ON CT.HOADON_CHUNGTU_ID=HD.HOADON_CHUNGTU_ID
      INNER JOIN TT_MIENGIAM_CONGTY BIENLAI ON CT.HOADONLIENQUAN_ID=BIENLAI.MIENGIAM_CONGTY_ID
      INNER JOIN TT_MIENGIAM_CHITIET CTBL ON BIENLAI.MIENGIAM_CONGTY_ID=CTBL.MIENGIAM_ID AND CTBL.REF_TABLE = 'TT_MIENGIAM_CONGTY'
      INNER JOIN TT_VIENPHI  VP ON VP.VIENPHI_ID= CTBL.VIENPHI_ID
      INNER JOIN TM_DUOC D ON VP.DUOC_ID=D.DUOC_ID

      LEFT JOIN dbo.TT_NGOAITRU_TOATHUOC kb_tt ON VP.REF_ID = kb_tt.TOATHUOC_ID AND VP.REF_TABLE ='TT_NGOAITRU_TOATHUOC'
      LEFT JOIN dbo.TT_NGOAITRU_KHAMBENH kbTT ON kbTT.KHAMBENH_ID = kb_tt.KHAMBENH_ID
      LEFT JOIN dbo.TT_NGOAITRU_KHAMBENH_VTYT kb_vtyt ON VP.REF_ID = kb_vtyt.KHAMBENH_VTYT_ID AND VP.REF_TABLE ='TT_NGOAITRU_KHAMBENH_VTYT'
      LEFT JOIN dbo.TT_NGOAITRU_KHAMBENH kbVTYT ON kbVTYT.KHAMBENH_ID = kb_vtyt.KHAMBENH_ID
      LEFT JOIN dbo.TT_NOITRU_TOATHUOC NTTT ON VP.REF_ID = NTTT.TOATHUOC_ID AND VP.REF_TABLE ='TT_NOITRU_TOATHUOC'
      LEFT JOIN dbo.TT_NOITRU_KHAMBENH NTKB ON NTKB.KHAMBENH_ID = NTTT.KHAMBENH_ID
      LEFT JOIN dbo.TT_PHAUTHUAT_VTYT pt_vtyt ON VP.REF_ID = pt_vtyt.PHAUTHUAT_VTYT_ID AND VP.REF_TABLE ='TT_PHAUTHUAT_VTYT'
      LEFT JOIN dbo.TT_PHAUTHUAT pt ON pt.PHAUTHUAT_ID = pt_vtyt.PHAUTHUAT_ID
      LEFT JOIN dbo.TT_CLSKETQUA_VTYT clsKQ_vtyt ON VP.REF_ID = clsKQ_vtyt.CLSKETQUA_VTYT_ID AND VP.REF_TABLE ='TT_CLSKETQUA_VTYT'
      LEFT JOIN dbo.TT_CLSKETQUA  clsKQ ON clsKQ.CLSKETQUA_ID = clsKQ_vtyt.CLSKETQUA_ID

	  LEFT JOIN dbo.TT_DUOC_CHUNGTU_CHITIET DCTCT ON VP.REF_ID = DCTCT.CHUNGTUCHITIET_ID AND VP.REF_TABLE ='TT_DUOC_CHUNGTU_CHITIET'
      LEFT JOIN dbo.TT_DUOC_CHUNGTU DCT ON DCTCT.CHUNGTU_ID = DCT.CHUNGTU_ID

      LEFT JOIN dbo.TM_PHONGBAN pb ON pb.PHONGBAN_ID = COALESCE(kbTT.PHONGBAN_ID, kbVTYT.PHONGBAN_ID ,NTKB.PHONGBAN_ID, pt.PHONGBANTHUCHIEN_ID, clsKQ.NOITHUCHIEN_ID , DCT.PHONGBAN_ID)
      LEFT JOIN dbo.TM_PHONGBAN COS ON pb.COSTCENTER_ID = COS.PHONGBAN_ID

      WHERE   HD.HOADON_CHUNGTU_ID='$HOADON_ID$' AND CT.REF_TABLE='TT_MIENGIAM_CONGTY'
      UNION ALL
      SELECT HD.HOADON_CHUNGTU_ID, CTBL.VIENPHI_ID ,ctbl.BENHNHAN_PHAITHANHTOAN,D.TYLE_VAT,COSTCENTER_ID = COS.PHONGBAN_ID,COSTCENTERCODE = COS.MAPHONGBAN,COSTCENTERNAME = COS.TENPHONGBAN, THANHTIEN_DOANHTHU = ctbl.BENHNHAN_PHAITHANHTOAN, NULL, NULL, 1, 1
      FROM TT_HOADON_CHUNGTU HD
      INNER JOIN TT_HOADON_CHUNGTU_CHITIET CT ON CT.HOADON_CHUNGTU_ID=HD.HOADON_CHUNGTU_ID
      INNER JOIN dbo.TT_HOADON BIENLAI ON CT.HOADONLIENQUAN_ID=BIENLAI.HOADON_ID
      INNER JOIN TT_HOADON_CHITIET_NGOAITRU CTBL ON BIENLAI.HOADON_ID=CTBL.HOADON_ID
      JOIN dbo.TT_DUOC_CHUNGTU_CHITIET DCTCT ON CTBL.REF_ID = DCTCT.CHUNGTUCHITIET_ID AND CTBL.REF_TABLE ='TT_DUOC_CHUNGTU_CHITIET'
      JOIN dbo.TT_DUOC_CHUNGTU DCT ON DCTCT.CHUNGTU_ID = DCT.CHUNGTU_ID
      INNER JOIN TM_DUOC D ON DCTCT.DUOC_ID=D.DUOC_ID
      outer apply(select top 1 * from TT_NGOAITRU_KHAMBENH_TOATHUOC where DCTCT.CHUNGTU_ID = CHUNGTUPHATTHUOC_ID ) KBTT
      LEFT JOIN dbo.TT_NGOAITRU_KHAMBENH KB ON KBTT.KHAMBENH_ID = KB.KHAMBENH_ID
      LEFT JOIN dbo.TM_PHONGBAN pb ON pb.PHONGBAN_ID = ISNULL(KB.PHONGBAN_ID, DCT.PHONGBAN_ID)
      LEFT JOIN dbo.TM_PHONGBAN COS ON pb.COSTCENTER_ID = COS.PHONGBAN_ID
      WHERE   HD.HOADON_CHUNGTU_ID='$HOADON_ID$' AND CT.REF_TABLE='TT_DUOC_CHUNGTU_CHITIET'

	  INSERT INTO @TEMDICHVUSUM
	           
	  SELECT HOADON_CHUNGTU_ID ,
	        VIENPHI_ID ,
	        GIATRI = sum (GIATRI),
	        MANHOMDICHVU ,
	        TENNHOMDICHVU ,
	        COSTCENTER_ID ,
	        COSTCENTERCODE ,
	        COSTCENTERNAME ,
	        THANHTIEN_DOANHTHU = SUM (THANHTIEN_DOANHTHU) ,
			MIENGIAMBGD ,
	        MIENGIAMTHE ,
	        IsOP ,
			TinhMienGiam
	  FROM @TEMDICHVU
	  GROUP BY  HOADON_CHUNGTU_ID ,
	        VIENPHI_ID ,	        
	        MANHOMDICHVU ,
	        TENNHOMDICHVU ,
	        COSTCENTER_ID ,
	        COSTCENTERCODE ,
	        COSTCENTERNAME ,
			MIENGIAMBGD ,
	        MIENGIAMTHE ,
	        IsOP ,
			TinhMienGiam

	  INSERT INTO @TEMDUOCSUM	           
	  SELECT HOADON_CHUNGTU_ID ,
	        VIENPHI_ID ,
	        GIATRI = sum (GIATRI),
	        VAT ,
	        COSTCENTER_ID ,
	        COSTCENTERCODE ,
	        COSTCENTERNAME ,
	        THANHTIEN_DOANHTHU = SUM (THANHTIEN_DOANHTHU) ,
	        MIENGIAMBGD ,
	        MIENGIAMTHE ,
	        IsOP ,
			TinhMienGiam
	  FROM @TEMDUOC
	  GROUP BY HOADON_CHUNGTU_ID ,
	        VIENPHI_ID ,	        
	        VAT ,
	        COSTCENTER_ID ,
	        COSTCENTERCODE ,
	        COSTCENTERNAME ,	        
	        MIENGIAMBGD ,
	        MIENGIAMTHE ,
	        IsOP ,
			TinhMienGiam
	  
	  UPDATE a 
		SET a.THANHTIEN_DOANHTHU = ISNULL(a.THANHTIEN_DOANHTHU,0) + case when TinhMienGiam = 1 then ISNULL(mgBGD.MIENGIAMBGD,0) + ISNULL(mgTHE.MIENGIAMTHE,0) else 0 end , 
			a.MIENGIAMBGD = case when TinhMienGiam = 1 then mgBGD.MIENGIAMBGD else 0 end,
			a.MIENGIAMTHE = case when TinhMienGiam = 1 then mgTHE.MIENGIAMTHE else 0 end 
	  FROM @TEMDICHVUSUM a
	  OUTER APPLY (SELECT SUM(mg.GIATRIMIENGIAM) AS MIENGIAMBGD FROM dbo.TT_MIENGIAM_CHITIET(NOLOCK) mg WHERE mg.REF_TABLE ='TT_MIENGIAM' AND mg.VIENPHI_ID = a.VIENPHI_ID) mgBGD
	  OUTER APPLY (SELECT SUM(mg.GIATRIMIENGIAM) AS MIENGIAMTHE FROM dbo.TT_MIENGIAM_CHITIET(NOLOCK) mg WHERE mg.REF_TABLE ='TT_MIENGIAM_THANHVIEN' AND mg.VIENPHI_ID = a.VIENPHI_ID) mgTHE

	  UPDATE a
		SET a.THANHTIEN_DOANHTHU = ISNULL(a.THANHTIEN_DOANHTHU,0) + case when TinhMienGiam = 1 then ISNULL(mgBGD.MIENGIAMBGD,0) + ISNULL(mgTHE.MIENGIAMTHE,0) else 0 end ,
			a.MIENGIAMBGD = case when TinhMienGiam = 1 then mgBGD.MIENGIAMBGD else 0 end ,
			a.MIENGIAMTHE = case when TinhMienGiam = 1 then mgTHE.MIENGIAMTHE else 0 end 
	  FROM @TEMDUOCSUM a
	  OUTER APPLY (SELECT SUM(mg.GIATRIMIENGIAM) AS MIENGIAMBGD FROM dbo.TT_MIENGIAM_CHITIET(NOLOCK) mg WHERE mg.REF_TABLE ='TT_MIENGIAM' AND mg.VIENPHI_ID = a.VIENPHI_ID) mgBGD
	  OUTER APPLY (SELECT SUM(mg.GIATRIMIENGIAM) AS MIENGIAMTHE FROM dbo.TT_MIENGIAM_CHITIET(NOLOCK) mg WHERE mg.REF_TABLE ='TT_MIENGIAM_THANHVIEN' AND mg.VIENPHI_ID = a.VIENPHI_ID) mgTHE


	  DELETE FROM @TEMDICHVU
	  DELETE FROM @TEMDUOC

	  INSERT INTO @TEMDICHVU
	  SELECT * FROM @TEMDICHVUSUM
	  
	  INSERT INTO @TEMDUOC
	  SELECT * FROM @TEMDUOCSUM
	        
      INSERT INTO @TEMNOIDUNG
      SELECT  '$HOADON_ID$' HD_ID
      , STT = CASE WHEN dv.MANHOMDICHVU = '04' THEN 1 ELSE 2 END
      , MANOIDUNG = dv.MANHOMDICHVU
      , NoiDung = CASE WHEN dv.MANHOMDICHVU = '04' THEN N'Chi phí khám chữa bệnh'
      ELSE dv.TENNHOMDICHVU END
      , THANHTIENCHUATHUE = CASE WHEN SUM(ISNULL(GIATRI, 0)) = 0 THEN NULL ELSE SUM(ISNULL(GIATRI, 0)) END
      , VAT = NULL
      , THANHTIENCOTHUE = CASE WHEN SUM(ISNULL(GIATRI, 0)) = 0 THEN NULL ELSE SUM(ISNULL(GIATRI, 0)) END
      , TIENTHUE = NULL
      , dv.COSTCENTER_ID , dv.COSTCENTERCODE , dv.COSTCENTERNAME , THANHTIEN5 = NULL
      , THANHTIEN10 = NULL
      , THANHTIENDOANHTHU = SUM(dv.THANHTIEN_DOANHTHU)
      , MIENGIAMBGD = SUM(dv.MIENGIAMBGD)
      , MIENGIAMTHE = SUM(dv.MIENGIAMTHE)
      FROM    @TEMDICHVU dv
      GROUP BY dv.COSTCENTER_ID ,
      dv.COSTCENTERCODE ,
      dv.COSTCENTERNAME ,
      dv.MANHOMDICHVU,
      dv.TENNHOMDICHVU
      UNION
      SELECT  '$HOADON_ID$' HD_ID
      , STT = CASE WHEN VAT = 0 OR VAT IS NULL THEN 3
      WHEN VAT = 5 THEN 4
      ELSE 5 END
      , MANOIDUNG = 'DU'
      , NoiDung = CASE WHEN VAT = 0 OR VAT IS NULL THEN CASE WHEN d.IsOP = 0 then N'Thuốc,VTYT Nội trú thuế suất 0%' ELSE  N'Thuốc,VTYT thuế suất 0%' END
      WHEN  VAT = 5 THEN CASE WHEN d.IsOP = 0 THEN N'Thuốc,VTYT Nội trú thuế suất 5%' ELSE N'Thuốc,VTYT thuế suất 5%' end
      ELSE CASE WHEN d.IsOP = 0 THEN N'Thuốc,VTYT Nội trú thuế suất 10%' ELSE N'Thuốc,VTYT thuế suất 10%' END  END
      , THANHTIENCHUATHUE = CASE WHEN VAT = 0 OR VAT IS NULL THEN CASE WHEN SUM(ISNULL(GIATRI, 0)) = 0 THEN NULL ELSE SUM(ISNULL(GIATRI, 0)) END
      WHEN   VAT = 5 THEN CASE WHEN SUM(ISNULL(GIATRI, 0)) = 0 THEN NULL ELSE SUM(ISNULL(GIATRI, 0)) / ( 1 + ( 5.00 / 100 ) ) END
      ELSE CASE WHEN SUM(ISNULL(GIATRI, 0)) = 0 THEN NULL ELSE SUM(ISNULL(GIATRI, 0)) / ( 1 + ( 10.00 / 100 ) ) END END
      , VAT =  CASE WHEN VAT = 0 OR VAT IS NULL THEN CASE WHEN SUM(ISNULL(GIATRI, 0)) = 0 THEN NULL ELSE 0 END
      WHEN VAT = 5 THEN CASE WHEN SUM(ISNULL(GIATRI, 0)) = 0 THEN NULL ELSE 5 END
      ELSE CASE WHEN SUM(ISNULL(GIATRI, 0)) = 0 THEN NULL ELSE 10 END END
      , THANHTIENCOTHUE = CASE WHEN SUM(ISNULL(GIATRI, 0)) = 0 THEN NULL ELSE SUM(ISNULL(GIATRI, 0)) END
      , TIENTHUE = CASE WHEN VAT = 0 OR VAT IS NULL THEN CASE WHEN SUM(ISNULL(GIATRI, 0)) = 0 THEN NULL ELSE 0 END
      WHEN  VAT = 5 THEN CASE WHEN SUM(ISNULL(GIATRI, 0)) = 0 THEN NULL ELSE SUM(ISNULL(GIATRI, 0)) - ( SUM(ISNULL(GIATRI, 0)) / ( 1 + ( 5.00 / 100 ) ) ) END
      ELSE CASE WHEN SUM(ISNULL(GIATRI, 0)) = 0 THEN NULL ELSE SUM(ISNULL(GIATRI, 0)) - ( SUM(ISNULL(GIATRI, 0)) / ( 1 + ( 10.00 / 100 ) ) ) END END
      , d.COSTCENTER_ID , d.COSTCENTERCODE , d.COSTCENTERNAME
      , THANHTIEN5 = CASE WHEN VAT = 0 OR VAT IS NULL THEN NULL
      WHEN VAT = 5 THEN SUM(ISNULL(GIATRI, 0) - ( ISNULL(GIATRI, 0) / ( 1 + ( 5.00 / 100 ) ) ))
      ELSE NULL END
      , THANHTIEN10 = CASE WHEN VAT = 0 OR VAT IS NULL THEN NULL
      WHEN  VAT = 5 THEN  NULL
      ELSE SUM(ISNULL(GIATRI, 0) - ( ISNULL(GIATRI, 0) / ( 1 + ( 10.00 / 100 ) ) )) END
      , THANHTIENDOANHTHU = SUM(d.THANHTIEN_DOANHTHU)
      , MIENGIAMBGD = SUM(d.MIENGIAMBGD)
      , MIENGIAMTHE = SUM(d.MIENGIAMTHE)
      FROM    @TEMDUOC d
      GROUP BY d.COSTCENTER_ID ,
      d.COSTCENTERCODE ,
      d.COSTCENTERNAME ,
      d.VAT, d.IsOP

      SELECT    TICHHOP_ID = NULL ,
      HOADON_ID = HD.HOADON_CHUNGTU_ID ,
      STT ,
      T.MANOIDUNG ,
      NOIDUNG ,
      ISNULL(T.THANHTIENCHUATHUE,0) AS THANHTIENCHUATHUE,
      VAT ,
      ISNULL(THANHTIENCOTHUE,0) AS THANHTIENCOTHUE ,
      SUMTIEN10 = ISNULL(T.THANHTIEN10,0) ,
      SUMTIEN5 = ISNULL(T.THANHTIEN5,0) ,
      ISNULL(TIENTHUE,0) AS  TIENTHUE,
      @MASOTHUE AS MASOTHUEBV ,
      @DIENTHOAI AS DIENTHOAIBV ,
      @FAX AS FAXBV ,
      @DIACHI AS DIACHIBV ,
      @TENBENHVIEN AS TENBENHVIEN ,
      T.COSTCENTER_ID ,
      T.COSTCENTERCODE ,
      T.COSTCENTERNAME ,
      ISNULL(T.THANHTIENDOANHTHU,0)  THANHTIENDOANHTHU,
      ISNULL(T.MIENGIAMBGD,0) MIENGIAMBGD ,
      ISNULL(T.MIENGIAMTHE,0) MIENGIAMTHE
      FROM      TT_HOADON_CHUNGTU HD
      LEFT JOIN LST_DICTIONARY HTTT ON HD.HINHTHUCTHANHTOAN_ID = HTTT.DICTIONARY_ID
      INNER  JOIN @TEMNOIDUNG T ON T.HOADON_CHUNGTU_ID = HD.HOADON_CHUNGTU_ID
      WHERE     HD.HOADON_CHUNGTU_ID = '$HOADON_ID$'
      AND HD.BENHVIEN_ID = '$BENHVIEN_ID$'
      ORDER BY  STT;
 
    </statement>
    <!--Lấy danh sách IDChuyen vào bảng HOADON_CHUNGTU-->
    <update id="DAO09800_UpdateHoaDonVAT_IDChuyen" parameterClass="System.Collections.IDictionary">
      UPDATE dbo.TT_HOADON_CHUNGTU SET IDCHUYEN = #CHUYENTICHHOP_ID# WHERE HOADON_CHUNGTU_ID = '$HOADON_ID$'
    </update>

    <!--Kiểm tra xem hóa đơn VAT đã được chuyển lên db trung gian chưa-->
    <statement id="DAO09800_KiemTraHoaDonVATDaChuyen" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      SELECT  1
      FROM   dbo.TT_HOADON_CHUNGTU
      WHERE   BENHVIEN_ID = '$BENHVIEN_ID$'
      AND HOADON_CHUNGTU_ID = '$HOADON_ID$'
      AND IDCHUYEN IS NOT NULL;
    </statement>
    
    <!--============================================END HÓA ĐƠN VAT=============================================-->


  </statements>
</sqlMap>
