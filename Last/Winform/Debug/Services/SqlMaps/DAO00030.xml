<?xml version="1.0" encoding="utf-8" ?>
<!--iBatis Map File-->
<sqlMap namespace="eHospital" xmlns="http://ibatis.apache.org/mapping" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
    <statements>
	  
      <statement id="DAO00030_Get_lstHangHoa_byNCC" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
        select HANGHOA_ID,MAHANGHOA,TENHANGHOA,DONGIA
        from TM_PUR_GIAHOPDONGCHITIET hdct
        left join TM_PUR_GIAHOPDONG hd on hd.GIAHOPDONG_ID = hdct.GIAHOPDONG_ID
        where NHACUNGCAP_ID='$NHACUNGCAP_ID$' and hd.BENHVIEN_ID='$BENHVIEN_ID$' and '$NGAYCHUNGTU$' BETWEEN TUNGAY and DENNGAY
      </statement>
      <statement id="DAO00030_GetAll_SoHoaDon_ChungTu" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
        select SOHOADON from TT_DUOC_CHUNGTU where  TRANGTHAI != 'HUY' and MUCDICHCHUNGTU_CODE='N01'
        and BENHVIEN_ID='$BENHVIEN_ID$' and SOHOADON='$SOHOADON$' and NHACUNGCAP_ID='$NHACUNGCAP_ID$'
        <isParameterPresent>
          <isNotEmpty prepend="and" property="MAUHOADON">
            MAUHOADON='$MAUHOADON$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="SOSERI">
            SOSERI='$SOSERI$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="CHUNGTU_ID">
            CHUNGTU_ID != '$CHUNGTU_ID$'
          </isNotEmpty>
        </isParameterPresent>
      </statement>
        <!--Revision:0-->
        <statement id="DAO00030_GetList" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
            select *
            from TT_DUOC_CHUNGTU
            where BENHVIEN_ID = '$BENHVIEN_ID$'
            <isParameterPresent>
              <isNotEmpty prepend="and" property="CHUNGTU_ID">
                TT_DUOC_CHUNGTU.CHUNGTU_ID = '$CHUNGTU_ID$'
              </isNotEmpty>
              <isNotEmpty prepend="and" property="MACHUNGTU">
                TT_DUOC_CHUNGTU.MACHUNGTU = '$MACHUNGTU$'
              </isNotEmpty>
              <isNotEmpty prepend="and" property="SOCHUNGTU">
                TT_DUOC_CHUNGTU.SOCHUNGTU = '$SOCHUNGTU$'
              </isNotEmpty>
              <isNotEmpty prepend="and" property="LOAICHUNGTU">
                TT_DUOC_CHUNGTU.LOAICHUNGTU = '$LOAICHUNGTU$'
              </isNotEmpty>
              <isNotEmpty prepend="and" property="MUCDICHCHUNGTU_ID">
                TT_DUOC_CHUNGTU.MUCDICHCHUNGTU_ID = '$MUCDICHCHUNGTU_ID$'
              </isNotEmpty>
              <isNotEmpty prepend="and" property="MUCDICHCHUNGTU_CODE">
                TT_DUOC_CHUNGTU.MUCDICHCHUNGTU_CODE = '$MUCDICHCHUNGTU_CODE$'
              </isNotEmpty>
              <isNotEmpty prepend="and" property="KHOXUAT_ID">
                TT_DUOC_CHUNGTU.KHOXUAT_ID = '$KHOXUAT_ID$'
              </isNotEmpty>
              <isNotEmpty prepend="and" property="NGUOIGIAO_ID">
                TT_DUOC_CHUNGTU.NGUOIGIAO_ID = '$NGUOIGIAO_ID$'
              </isNotEmpty>
              <isNotEmpty prepend="and" property="KHONHAP_ID">
                TT_DUOC_CHUNGTU.KHONHAP_ID = '$KHONHAP_ID$'
              </isNotEmpty>
              <isNotEmpty prepend="and" property="SOCHUNGTUGOC">
                TT_DUOC_CHUNGTU.SOCHUNGTUGOC = '$SOCHUNGTUGOC$'
              </isNotEmpty>
              <isNotEmpty prepend="and" property="NGAYCHUNGTUGOC">
                TT_DUOC_CHUNGTU.NGAYCHUNGTUGOC = '$NGAYCHUNGTUGOC$'
              </isNotEmpty>
              <isNotEmpty prepend="and" property="NHACUNGCAP_ID">
                TT_DUOC_CHUNGTU.NHACUNGCAP_ID = '$NHACUNGCAP_ID$'
              </isNotEmpty>
              <isNotEmpty prepend="and" property="CHUNGTULIENQUAN_ID">
                TT_DUOC_CHUNGTU.CHUNGTULIENQUAN_ID = '$CHUNGTULIENQUAN_ID$'
              </isNotEmpty>
              <isNotEmpty prepend="and" property="KHAMBENH_ID">
                TT_DUOC_CHUNGTU.KHAMBENH_ID = '$KHAMBENH_ID$'
              </isNotEmpty>
              <isNotEmpty prepend="and" property="TOATHUOCNOITRU_ID">
                TT_DUOC_CHUNGTU.TOATHUOCNOITRU_ID = '$TOATHUOCNOITRU_ID$'
              </isNotEmpty>
              <isNotEmpty prepend="and" property="TIEPNHAN_ID">
                TT_DUOC_CHUNGTU.TIEPNHAN_ID = '$TIEPNHAN_ID$'
              </isNotEmpty>
              <isNotEmpty prepend="and" property="BENHAN_ID">
                TT_DUOC_CHUNGTU.BENHAN_ID = '$BENHAN_ID$'
              </isNotEmpty>
              <isNotEmpty prepend="and" property="DANHANTHUOC">
                TT_DUOC_CHUNGTU.DANHANTHUOC = '$DANHANTHUOC$'
              </isNotEmpty>
              <isNotEmpty prepend="and" property="NGUOINHAP_ID">
                TT_DUOC_CHUNGTU.NGUOINHAP_ID = '$NGUOINHAP_ID$'
              </isNotEmpty>
              <isNotEmpty prepend="and" property="NGAYNHAP">
                TT_DUOC_CHUNGTU.NGAYNHAP = '$NGAYNHAP$'
              </isNotEmpty>
              <isNotEmpty prepend="and" property="TRANGTHAI">
                TT_DUOC_CHUNGTU.TRANGTHAI = '$TRANGTHAI$'
              </isNotEmpty>
              <isNotEmpty prepend="and" property="PHIEULINH_ID">
                TT_DUOC_CHUNGTU.PHIEULINH_ID = '$PHIEULINH_ID$'
              </isNotEmpty>
              <isNotEmpty prepend="and" property="DONVIGIAO_ID">
                TT_DUOC_CHUNGTU.DONVIGIAO_ID = '$DONVIGIAO_ID$'
              </isNotEmpty>
              <isNotEmpty prepend="and" property="KHOSUDUNG_ID">
                TT_DUOC_CHUNGTU.KHOSUDUNG_ID = '$KHOSUDUNG_ID$'
              </isNotEmpty>
              <isNotEmpty prepend="and" property="LOAIVATTU_ID">
                TT_DUOC_CHUNGTU.LOAIVATTU_ID = '$LOAIVATTU_ID$'
              </isNotEmpty>
              <isNotEmpty prepend="and" property="BENHNHAN_ID">
                TT_DUOC_CHUNGTU.BENHNHAN_ID = '$BENHNHAN_ID$'
              </isNotEmpty>
              <isNotEmpty prepend="and" property="TENBENHNHAN">
                TT_DUOC_CHUNGTU.TENBENHNHAN = '$TENBENHNHAN$'
              </isNotEmpty>
              <isNotEmpty prepend="and" property="DOITUONG_ID">
                TT_DUOC_CHUNGTU.DOITUONG_ID = '$DOITUONG_ID$'
              </isNotEmpty>
            </isParameterPresent>
            order by CHUNGTU_ID
        </statement>
        <!--Revision:0-->
        <statement id="DAO00030_Search" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
          select TT_DUOC_CHUNGTU.*,
          CASE
          WHEN TT_DUOC_CHUNGTU.TRANGTHAI = 'PNCNK' THEN N'Chờ nhập kho'
          WHEN TT_DUOC_CHUNGTU.TRANGTHAI = 'PNDNK' THEN N'Đã nhập kho'
          WHEN TT_DUOC_CHUNGTU.TRANGTHAI = 'HUY' THEN N'Hủy'
          WHEN TT_DUOC_CHUNGTU.TRANGTHAI = 'DXN' THEN N'Đã xác nhận'
          END  AS TRANGTHAI_TEXT, PLD.MACHUNGTU AS SOPHIEULINH 
          from TT_DUOC_CHUNGTU
          LEFT JOIN TT_DUOC_PHIEULINH PLD ON PLD.CHUNGTU_ID = TT_DUOC_CHUNGTU.PHIEULINH_ID
          <dynamic prepend="where">
                <isParameterPresent>
                    <isNotEmpty prepend="and" property="MACHUNGTU">
                      (TT_DUOC_CHUNGTU.MACHUNGTU LIKE '%$MACHUNGTU$%' OR TT_DUOC_CHUNGTU.SOCHUNGTUGOC LIKE '%$MACHUNGTU$%' OR PLD.MACHUNGTU LIKE '%$MACHUNGTU$%')
                    </isNotEmpty>
                    <isNotEmpty prepend="and" property="SOCHUNGTU">
                        TT_DUOC_CHUNGTU.SOCHUNGTU LIKE '%$SOCHUNGTU$%'
                    </isNotEmpty>
                    <isNotEmpty prepend="and" property="LOAICHUNGTU">
                        TT_DUOC_CHUNGTU.LOAICHUNGTU = '$LOAICHUNGTU$'
                    </isNotEmpty>
                    <isNotEmpty prepend="and" property="MUCDICHCHUNGTU_ID">
                        TT_DUOC_CHUNGTU.MUCDICHCHUNGTU_ID = '$MUCDICHCHUNGTU_ID$'
                    </isNotEmpty>
                    <isNotEmpty prepend="and" property="KHOXUAT_ID">
                        TT_DUOC_CHUNGTU.KHOXUAT_ID = '$KHOXUAT_ID$'
                    </isNotEmpty>                    
                    <isNotEmpty prepend="and" property="KHONHAP_ID">
                        TT_DUOC_CHUNGTU.KHONHAP_ID = '$KHONHAP_ID$'
                    </isNotEmpty>                                       
                    <isNotEmpty prepend="and" property="TUNGAY">
                      CONVERT(date, TT_DUOC_CHUNGTU.NGAYCHUNGTU) BETWEEN CONVERT(date, '$TUNGAY$')  and  CONVERT(date, '$DENNGAY$')
                    </isNotEmpty>
                </isParameterPresent>
            </dynamic>
          order by TT_DUOC_CHUNGTU.CHUNGTU_ID DESC
        </statement>
        <!--Revision:0-->
        <statement id="DAO00030_Search_NhapNCC" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
          select DISTINCT
          CT.CHUNGTU_ID,
          CT.SOCHUNGTU,
          CT.MACHUNGTU,
          CT.NGAYCHUNGTU,
          CT.NGAYTAO,
          CT.SOCHUNGTUGOC,
          CT.NGAYCHUNGTUGOC,
          CT.DIENGIAI,
          CT.GIATRITHANHTOAN,
          NCC.TENNHACUNGCAP,

          CASE
          WHEN CT.TRANGTHAI = 'PNCNK' THEN N'Chờ xác nhận'
          WHEN CT.TRANGTHAI = 'PNDNK' THEN N'Đã nhập kho'
          WHEN CT.TRANGTHAI = 'HUY' THEN N'Đã hủy'
          END  AS TRANGTHAI,
          CASE
          WHEN CT.TRANGTHAI = 'PNCNK' THEN null
          WHEN CT.TRANGTHAI = 'PNDNK' THEN null
          WHEN CT.TRANGTHAI = 'HUY' THEN CT.NGUOICAPNHAT_ID
          END  AS NGUOICAPNHAT_ID,
          CASE
          WHEN CT.TRANGTHAI = 'PNCNK' THEN null
          WHEN CT.TRANGTHAI = 'PNDNK' THEN null
          WHEN CT.TRANGTHAI = 'HUY' THEN CT.NGAYCAPNHAT
          END  AS NGAYCAPNHAT,
          CASE
          WHEN CT.TRANGTHAI = 'PNCNK' THEN null
          WHEN CT.TRANGTHAI = 'PNDNK' THEN null
          WHEN CT.TRANGTHAI = 'HUY' THEN NV.TENNHANVIEN
          END  AS TENNHANVIEN,
          NGUOINHAN.TENNHANVIEN AS TENNGUOINHAN
          from TT_DUOC_CHUNGTU CT
          left join TT_DUOC_CHUNGTU_CHITIET CTCT  ON CTCT.CHUNGTU_ID = CT.CHUNGTU_ID
          left join TM_DUOC d  ON d.DUOC_ID = CTCT.DUOC_ID
          left join TM_NHANVIEN NV on CT.NGUOICAPNHAT_ID = NV.NHANVIEN_ID
          left join TM_NHACUNGCAP NCC on NCC.NHACUNGCAP_ID = CT.NHACUNGCAP_ID
          left join TM_NHANVIEN NGUOINHAN on NGUOINHAN.NHANVIEN_ID = CT.NGUOINHAN_ID
          <dynamic prepend="where">
            <isParameterPresent>
              <isNotEmpty prepend="and" property="TUKHOA">
                (CT.MACHUNGTU LIKE '%$TUKHOA$%' or d.TENDUOCDAYDU like N'%$TUKHOA$%' OR NGUOINHAN.TENNHANVIEN LIKE '%$TUKHOA$%' OR NCC.TENNHACUNGCAP LIKE '%$TUKHOA$%')
              </isNotEmpty>
              <isNotEmpty prepend="and" property="MUCDICHCHUNGTU_ID">
                CT.MUCDICHCHUNGTU_ID = '$MUCDICHCHUNGTU_ID$'
              </isNotEmpty>
              <isNotEmpty prepend="and" property="BENHVIEN_ID">
                CT.BENHVIEN_ID = '$BENHVIEN_ID$'
              </isNotEmpty>
              <isNotEmpty prepend="and" property="KHONHAP_ID">
                CT.KHONHAP_ID = '$KHONHAP_ID$'
              </isNotEmpty>
              <isNotEmpty prepend="and" property="TUNGAY">
                CONVERT(date, CT.NGAYCHUNGTU) BETWEEN CONVERT(date, '$TUNGAY$')  and  CONVERT(date, '$DENNGAY$')
              </isNotEmpty>
            </isParameterPresent>
          </dynamic>
          order by CT.CHUNGTU_ID DESC
        </statement>
        <!--Revision:0-->
        <statement id="DAO00030_Search_PhieuXuatNB" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
          select
          CT.CHUNGTU_ID,
          CT.SOCHUNGTU,
          CT.MACHUNGTU,
          CT.NGAYCHUNGTU,
          CT.NGAYTAO,
          CT.KHOXUAT_ID,
          CT.NGUOIGIAO_ID,
          CT.KHONHAP_ID,
          CT.NGUOINHAN_ID,
          PL.MACHUNGTU as MAPHIEULINH,
          PL.NGAYCHUNGTU as NGAYPHIEULINH
          from TT_DUOC_CHUNGTU CT
          left join TT_DUOC_PHIEULINH PL on PL.CHUNGTU_ID = CT.PHIEULINH_ID
          <dynamic prepend="where">
            <isParameterPresent>
              <isNotEmpty prepend="and" property="MACHUNGTU">
                (CT.MACHUNGTU LIKE '%$MACHUNGTU$%' or PL.MACHUNGTU LIKE '%$MACHUNGTU$%')
              </isNotEmpty>
              <isNotEmpty prepend="and" property="SOCHUNGTU">
                CT.SOCHUNGTU LIKE '%$SOCHUNGTU$%'
              </isNotEmpty>
              <isNotEmpty prepend="and" property="MUCDICHCHUNGTU_ID">
                CT.MUCDICHCHUNGTU_ID = '$MUCDICHCHUNGTU_ID$'
              </isNotEmpty>
              <isNotEmpty prepend="and" property="DANHANTHUOC">
                CT.DANHANTHUOC = '$DANHANTHUOC$'
              </isNotEmpty>             
              <isNotEmpty prepend="and" property="CHUNGTULIENQUAN_ID">
                CT.CHUNGTULIENQUAN_ID is null
              </isNotEmpty>
              <isNotEmpty prepend="and" property="BENHVIEN_ID">
                CT.BENHVIEN_ID = '$BENHVIEN_ID$'
              </isNotEmpty>
              <isNotEmpty prepend="and" property="KHOXUAT_ID">
                CT.KHOXUAT_ID = '$KHOXUAT_ID$'
              </isNotEmpty>
              <isNotEmpty prepend="and" property="KHONHAP_ID">
                CT.KHONHAP_ID = '$KHONHAP_ID$'
              </isNotEmpty>
              <isNotEmpty prepend="and" property="TUNGAY">
                CONVERT(date, CT.NGAYCHUNGTU) BETWEEN CONVERT(date, '$TUNGAY$')  and  CONVERT(date, '$DENNGAY$')
              </isNotEmpty>
            </isParameterPresent>
          </dynamic>
          order by CT.CHUNGTU_ID DESC          
        </statement>
      <statement id="DAO00030_Search_PhieuXuatSD" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
        SELECT DISTINCT phieuxuat.* FROM
        (
        select DISTINCT
        CT.CHUNGTU_ID,
        CT.SOCHUNGTU,
        CT.MACHUNGTU,
        CT.NGAYCHUNGTU,
        CT.NGAYTAO,
        CT.KHOXUAT_ID,
        CT.NGUOIGIAO_ID,
        CT.KHONHAP_ID,
        CT.NGUOINHAN_ID,
        PL.MACHUNGTU as MAPHIEULINH,
        PL.NGAYCHUNGTU as NGAYPHIEULINH,
        bn.MAYTE,
        bn.TENBENHNHAN,
        CONVERT(VARCHAR(10), KB.THOIGIANKHAM, 103) + ' - ' + CONVERT(VARCHAR(5), KB.THOIGIANKHAM, 108) as THOIGIANKHAM,
        nl.TENNHANVIEN as NGUOILAP,
        CT.DIENGIAI
        from TT_DUOC_CHUNGTU CT
        inner join TT_DUOC_CHUNGTU_CHITIET ctct on ct.CHUNGTU_ID = ctct.CHUNGTU_ID
        inner join TT_NOITRU_TOATHUOC TT on ctct.TOATHUOCNOITRU_ID = TT.TOATHUOC_ID
        inner join TT_NOITRU_KHAMBENH KB on kb.KHAMBENH_ID = TT.KHAMBENH_ID
        inner join TT_BENHNHAN BN on TT.BENHNHAN_ID = BN.BENHNHAN_ID
        left join TT_DUOC_PHIEULINH PL on PL.CHUNGTU_ID = CT.PHIEULINH_ID
        left join TM_NHANVIEN nl on nl.NHANVIEN_ID = TT.NGUOITAO_ID
        <dynamic prepend="where">
          <isParameterPresent>
            <isNotEmpty prepend="and" property="MACHUNGTU">
              (CT.MACHUNGTU LIKE '%$MACHUNGTU$%' or PL.MACHUNGTU LIKE '%$MACHUNGTU$%' or BN.MAYTE LIKE '%$MACHUNGTU$%' or BN.TENBENHNHAN LIKE N'%$MACHUNGTU$%')
            </isNotEmpty>           
            <isNotEmpty prepend="and" property="MUCDICHCHUNGTU_ID">
              CT.MUCDICHCHUNGTU_ID = '$MUCDICHCHUNGTU_ID$'
            </isNotEmpty>                              
            <isNotEmpty prepend="and" property="KHOXUAT_ID">
              CT.KHOXUAT_ID = '$KHOXUAT_ID$'
            </isNotEmpty>
            <isNotEmpty prepend="and" property="KHONHAP_ID">
              CT.KHONHAP_ID = '$KHONHAP_ID$'
            </isNotEmpty>
            <isNotEmpty prepend="and" property="TUNGAY">
              CONVERT(date, CT.NGAYCHUNGTU) BETWEEN CONVERT(date, '$TUNGAY$')  and  CONVERT(date, '$DENNGAY$')
            </isNotEmpty>
            <isNotEmpty prepend="and" property="BENHVIEN_ID">
              CT.BENHVIEN_ID = '$BENHVIEN_ID$'
            </isNotEmpty>
          </isParameterPresent>
        </dynamic>

        UNION

        select DISTINCT
        CT.CHUNGTU_ID,
        CT.SOCHUNGTU,
        CT.MACHUNGTU,
        CT.NGAYCHUNGTU,
        CT.NGAYTAO,
        CT.KHOXUAT_ID,
        CT.NGUOIGIAO_ID,
        CT.KHONHAP_ID,
        CT.NGUOINHAN_ID,
        PL.MACHUNGTU as MAPHIEULINH,
        PL.NGAYCHUNGTU as NGAYPHIEULINH,
        bn.MAYTE,
        bn.TENBENHNHAN,
        CONVERT(VARCHAR(10), KB.THOIGIANKHAM, 103) + ' - ' + CONVERT(VARCHAR(5), KB.THOIGIANKHAM, 108) as THOIGIANKHAM,
        nl.TENNHANVIEN as NGUOILAP,
        CT.DIENGIAI
        from TT_DUOC_CHUNGTU CT
        inner join TT_DUOC_CHUNGTU_CHITIET ctct on ct.CHUNGTU_ID = ctct.CHUNGTU_ID
        inner join TT_NGOAITRU_KHAMBENH_VTYT vt on ctct.KHAMBENH_VTYT_ID = vt.KHAMBENH_VTYT_ID
        inner join TT_NGOAITRU_KHAMBENH kb on kb.KHAMBENH_ID = vt.KHAMBENH_ID
        inner join TT_BENHNHAN BN on bn.BENHNHAN_ID = kb.BENHNHAN_ID
        left join TT_DUOC_PHIEULINH PL on PL.CHUNGTU_ID = CT.PHIEULINH_ID
        left join TM_NHANVIEN nl on nl.NHANVIEN_ID = vt.NGUOITAO_ID
        <dynamic prepend="where">
          <isParameterPresent>
            <isNotEmpty prepend="and" property="MACHUNGTU">
              (CT.MACHUNGTU LIKE '%$MACHUNGTU$%' or PL.MACHUNGTU LIKE '%$MACHUNGTU$%' or BN.MAYTE LIKE '%$MACHUNGTU$%' or BN.TENBENHNHAN LIKE N'%$MACHUNGTU$%')
            </isNotEmpty>
            <isNotEmpty prepend="and" property="MUCDICHCHUNGTU_ID">
              CT.MUCDICHCHUNGTU_ID = '$MUCDICHCHUNGTU_ID$'
            </isNotEmpty>
            <isNotEmpty prepend="and" property="KHOXUAT_ID">
              CT.KHOXUAT_ID = '$KHOXUAT_ID$'
            </isNotEmpty>
            <isNotEmpty prepend="and" property="KHONHAP_ID">
              CT.KHONHAP_ID = '$KHONHAP_ID$'
            </isNotEmpty>
            <isNotEmpty prepend="and" property="TUNGAY">
              CONVERT(date, CT.NGAYCHUNGTU) BETWEEN CONVERT(date, '$TUNGAY$')  and  CONVERT(date, '$DENNGAY$')
            </isNotEmpty>
            <isNotEmpty prepend="and" property="BENHVIEN_ID">
              CT.BENHVIEN_ID = '$BENHVIEN_ID$'
            </isNotEmpty>
          </isParameterPresent>
        </dynamic>

        UNION

        select DISTINCT
        CT.CHUNGTU_ID,
        CT.SOCHUNGTU,
        CT.MACHUNGTU,
        CT.NGAYCHUNGTU,
        CT.NGAYTAO,
        CT.KHOXUAT_ID,
        CT.NGUOIGIAO_ID,
        CT.KHONHAP_ID,
        CT.NGUOINHAN_ID,
        PL.MACHUNGTU as MAPHIEULINH,
        PL.NGAYCHUNGTU as NGAYPHIEULINH,
        bn.MAYTE,
        bn.TENBENHNHAN,
        CONVERT(VARCHAR(10), pt.NGAYTHUCHIEN, 103) + ' - ' + CONVERT(VARCHAR(5), pt.NGAYTHUCHIEN, 108) as THOIGIANKHAM,
        nl.TENNHANVIEN as NGUOILAP,
        CT.DIENGIAI
        from TT_DUOC_CHUNGTU CT
        inner join TT_DUOC_CHUNGTU_CHITIET ctct on ct.CHUNGTU_ID = ctct.CHUNGTU_ID
        inner join TT_PHAUTHUAT_VTYT vt on ctct.PHAUTHUAT_VTYT_ID = vt.PHAUTHUAT_VTYT_ID
        inner join TT_PHAUTHUAT pt on pt.PHAUTHUAT_ID = vt.PHAUTHUAT_ID
        inner join TT_TIEPNHAN tn on tn.TIEPNHAN_ID = pt.TIEPNHAN_ID
        inner join TT_BENHNHAN bn on bn.BENHNHAN_ID = tn.BENHNHAN_ID
        left join TT_DUOC_PHIEULINH PL on PL.CHUNGTU_ID = CT.PHIEULINH_ID
        left join TM_NHANVIEN nl on nl.NHANVIEN_ID = pt.NGUOITAO_ID
        <dynamic prepend="where">
          <isParameterPresent>
            <isNotEmpty prepend="and" property="MACHUNGTU">
              (CT.MACHUNGTU LIKE '%$MACHUNGTU$%' or PL.MACHUNGTU LIKE '%$MACHUNGTU$%' or BN.MAYTE LIKE '%$MACHUNGTU$%' or BN.TENBENHNHAN LIKE N'%$MACHUNGTU$%')
            </isNotEmpty>
            <isNotEmpty prepend="and" property="MUCDICHCHUNGTU_ID">
              CT.MUCDICHCHUNGTU_ID = '$MUCDICHCHUNGTU_ID$'
            </isNotEmpty>
            <isNotEmpty prepend="and" property="KHOXUAT_ID">
              CT.KHOXUAT_ID = '$KHOXUAT_ID$'
            </isNotEmpty>
            <isNotEmpty prepend="and" property="KHONHAP_ID">
              CT.KHONHAP_ID = '$KHONHAP_ID$'
            </isNotEmpty>
            <isNotEmpty prepend="and" property="TUNGAY">
              CONVERT(date, CT.NGAYCHUNGTU) BETWEEN CONVERT(date, '$TUNGAY$')  and  CONVERT(date, '$DENNGAY$')
            </isNotEmpty>
            <isNotEmpty prepend="and" property="BENHVIEN_ID">
              CT.BENHVIEN_ID = '$BENHVIEN_ID$'
            </isNotEmpty>
          </isParameterPresent>
        </dynamic>

        UNION

        select DISTINCT
        CT.CHUNGTU_ID,
        CT.SOCHUNGTU,
        CT.MACHUNGTU,
        CT.NGAYCHUNGTU,
        CT.NGAYTAO,
        CT.KHOXUAT_ID,
        CT.NGUOIGIAO_ID,
        CT.KHONHAP_ID,
        CT.NGUOINHAN_ID,
        PL.MACHUNGTU as MAPHIEULINH,
        PL.NGAYCHUNGTU as NGAYPHIEULINH,
        bn.MAYTE,
        bn.TENBENHNHAN,
        CONVERT(VARCHAR(10), cls.NGAYTAO, 103) + ' - ' + CONVERT(VARCHAR(5), cls.NGAYTAO, 108) as THOIGIANKHAM,
        nl.TENNHANVIEN as NGUOILAP,
        CT.DIENGIAI
        from TT_DUOC_CHUNGTU CT
        inner join TT_DUOC_CHUNGTU_CHITIET ctct on ct.CHUNGTU_ID = ctct.CHUNGTU_ID
        inner join TT_CLSKETQUA_VTYT cls on ctct.CLSKETQUA_VTYT_ID = cls.CLSKETQUA_VTYT_ID
        inner join TT_DVYEUCAU DV on DV.DVYEUCAU_ID = CLS.DVYEUCAU_ID
        inner join TT_BENHNHAN bn on bn.BENHNHAN_ID = DV.BENHNHAN_ID
        left join TT_DUOC_PHIEULINH PL on PL.CHUNGTU_ID = CT.PHIEULINH_ID
        left join TM_NHANVIEN nl on nl.NHANVIEN_ID = cls.NGUOITAO_ID
        <dynamic prepend="where">
          <isParameterPresent>
            <isNotEmpty prepend="and" property="MACHUNGTU">
              (CT.MACHUNGTU LIKE '%$MACHUNGTU$%' or PL.MACHUNGTU LIKE '%$MACHUNGTU$%' or BN.MAYTE LIKE '%$MACHUNGTU$%' or BN.TENBENHNHAN LIKE N'%$MACHUNGTU$%')
            </isNotEmpty>
            <isNotEmpty prepend="and" property="MUCDICHCHUNGTU_ID">
              CT.MUCDICHCHUNGTU_ID = '$MUCDICHCHUNGTU_ID$'
            </isNotEmpty>
            <isNotEmpty prepend="and" property="KHOXUAT_ID">
              CT.KHOXUAT_ID = '$KHOXUAT_ID$'
            </isNotEmpty>
            <isNotEmpty prepend="and" property="KHONHAP_ID">
              CT.KHONHAP_ID = '$KHONHAP_ID$'
            </isNotEmpty>
            <isNotEmpty prepend="and" property="TUNGAY">
              CONVERT(date, CT.NGAYCHUNGTU) BETWEEN CONVERT(date, '$TUNGAY$')  and  CONVERT(date, '$DENNGAY$')
            </isNotEmpty>
            <isNotEmpty prepend="and" property="BENHVIEN_ID">
              CT.BENHVIEN_ID = '$BENHVIEN_ID$'
            </isNotEmpty>
          </isParameterPresent>
        </dynamic>

        UNION

        select DISTINCT
        CT.CHUNGTU_ID,
        CT.SOCHUNGTU,
        CT.MACHUNGTU,
        CT.NGAYCHUNGTU,
        CT.NGAYTAO,
        CT.KHOXUAT_ID,
        CT.NGUOIGIAO_ID,
        CT.KHONHAP_ID,
        CT.NGUOINHAN_ID,
        PL.MACHUNGTU as MAPHIEULINH,
        PL.NGAYCHUNGTU as NGAYPHIEULINH,
        null as MAYTE,
        null as TENBENHNHAN,
        null as THOIGIANKHAM,
        nl.TENNHANVIEN as NGUOILAP,
        CT.DIENGIAI
        from TT_DUOC_CHUNGTU CT
        inner join TT_DUOC_CHUNGTU_CHITIET ctct on ct.CHUNGTU_ID = ctct.CHUNGTU_ID
        left join TT_DUOC_PHIEULINH PL on PL.CHUNGTU_ID = CT.PHIEULINH_ID
        left join TM_NHANVIEN nl on nl.NHANVIEN_ID = ct.NGUOITAO_ID
        WHERE (ctct.TOATHUOCNOITRU_ID IS NULL AND ctct.KHAMBENH_VTYT_ID IS NULL AND ctct.PHAUTHUAT_VTYT_ID IS NULL AND ctct.CLSKETQUA_VTYT_ID IS NULL)
        <dynamic prepend="">
          <isParameterPresent>
            <isNotEmpty prepend="and" property="MACHUNGTU">
              (CT.MACHUNGTU LIKE '%$MACHUNGTU$%' or PL.MACHUNGTU LIKE '%$MACHUNGTU$%' )
            </isNotEmpty>
            <isNotEmpty prepend="and" property="MUCDICHCHUNGTU_ID">
              CT.MUCDICHCHUNGTU_ID = '$MUCDICHCHUNGTU_ID$'
            </isNotEmpty>
            <isNotEmpty prepend="and" property="KHOXUAT_ID">
              CT.KHOXUAT_ID = '$KHOXUAT_ID$'
            </isNotEmpty>          
            <isNotEmpty prepend="and" property="TUNGAY">
              CONVERT(date, CT.NGAYCHUNGTU) BETWEEN CONVERT(date, '$TUNGAY$')  and  CONVERT(date, '$DENNGAY$')
            </isNotEmpty>
            <isNotEmpty prepend="and" property="BENHVIEN_ID">
              CT.BENHVIEN_ID = '$BENHVIEN_ID$'
            </isNotEmpty>
          </isParameterPresent>
        </dynamic>
        )PhieuXuat
        ORDER BY PhieuXuat.CHUNGTU_ID desc
      </statement>
      <!--Revision:0-->
        <statement id="DAO00030_Search_PhieuXuatThuoc" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
            select distinct
            CT.CHUNGTU_ID,
            CT.MACHUNGTU,
            CT.NGAYCHUNGTU,
            CT.KHOXUAT_ID,
            CT.NGUOIGIAO_ID,
            BN.MAYTE,
            BN.TENBENHNHAN
            from TT_DUOC_CHUNGTU CT
            inner join TT_BENHNHAN BN on BN.BENHNHAN_ID = CT.BENHNHAN_ID
            <dynamic prepend="where">
                <isParameterPresent>
                    <isNotEmpty prepend="and" property="TUKHOA">
                        (CT.MACHUNGTU LIKE '%$TUKHOA$%' or BN.MAYTE LIKE '%$TUKHOA$%'  or BN.TENBENHNHAN LIKE N'%$TUKHOA$%')
                    </isNotEmpty>
                    <isNotEmpty prepend="and" property="MUCDICHCHUNGTU_ID">
                        CT.MUCDICHCHUNGTU_ID = '$MUCDICHCHUNGTU_ID$'
                    </isNotEmpty>
                    <isNotEmpty prepend="and" property="BENHVIEN_ID">
                        CT.BENHVIEN_ID = '$BENHVIEN_ID$'
                    </isNotEmpty>
                    <isNotEmpty prepend="and" property="KHOXUAT_ID">
                        CT.KHOXUAT_ID = '$KHOXUAT_ID$'
                    </isNotEmpty>
                    <isNotEmpty prepend="and" property="TUNGAY">
                        CONVERT(date, CT.NGAYCHUNGTU) BETWEEN CONVERT(date, '$TUNGAY$')  and  CONVERT(date, '$DENNGAY$')
                    </isNotEmpty>
                </isParameterPresent>
            </dynamic>
            order by CT.CHUNGTU_ID DESC
        </statement>
        <!--Revision:0-->
        <statement id="DAO00030_KiemTraToaThuocDaThanhToan" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
            select distinct
            KBTT.CHUNGTUPHATTHUOC_ID
            from
            TT_NGOAITRU_KHAMBENH_TOATHUOC KBTT
            inner join TT_NGOAITRU_TOATHUOC TT on  TT.KHAMBENH_TOATHUOC_ID = KBTT.KHAMBENH_TOATHUOC_ID
            inner join TT_VIENPHI VP on (TT.TOATHUOC_ID = VP.REF_ID AND VP.REF_TABLE = 'TT_NGOAITRU_TOATHUOC')
            where
            KBTT.CHUNGTUPHATTHUOC_ID = '$CHUNGTU_ID$'
            and KBTT.BENHVIEN_ID = '$BENHVIEN_ID$'
            AND vp.DATHANHTOAN = '1'
            AND vp.HUY = '0'
        </statement>
        <!--Revision:0-->
        <statement id="DAO00030_KiemTraBenhNhanXNBHYT" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
            select
            KB.TIEPNHAN_ID
            from
            TT_NGOAITRU_KHAMBENH KB
            inner join TT_DUOC_CHUNGTU CT on KB.KHAMBENH_ID = CT.KHAMBENH_ID
            inner join TT_XACNHANCHIPHI XN on XN.TIEPNHAN_ID = KB.TIEPNHAN_ID
            where
            CT.CHUNGTU_ID = $CHUNGTU_ID$
            and KB.BENHVIEN_ID = '$BENHVIEN_ID$'
        </statement>
        <!--Revision:0-->
        <statement id="DAO00030_KiemTraBenhNhanXuatVien" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
            select
            TT.TOATHUOC_ID
            from
            TT_NOITRU_TOATHUOC TT
            inner join TT_NOITRU_KHAMBENH KB on TT.KHAMBENH_ID = KB.KHAMBENH_ID
            inner join TT_NOITRU_BENHAN BA on BA.BENHAN_ID = KB.BENHAN_ID
            WHERE
            BA.TRANGTHAI = 'DAXUATVIEN'
            AND kb.RAVIEN = '0'
            AND TT.CHUNGTU_ID =$CHUNGTU_ID$ 
            
            union all
            select
                        VTYT.PHAUTHUAT_VTYT_ID as TOATHUOC_ID
                        from
                        TT_PHAUTHUAT_VTYT VTYT
                        inner join TT_PHAUTHUAT PT on VTYT.PHAUTHUAT_ID = PT.PHAUTHUAT_ID
                        inner join TT_NOITRU_BENHAN BA on BA.BENHAN_ID =PT.BENHAN_ID
                        WHERE
                        BA.TRANGTHAI = 'DAXUATVIEN'
                        AND vtyt.CHUNGTU_ID =$CHUNGTU_ID$ 
            union all
            
            select
                        VTYT.CLSKETQUA_VTYT_ID as TOATHUOC_ID
                        from
                        TT_CLSKETQUA_VTYT VTYT
                        inner join TT_VIENPHI VP on vtyt.CLSKETQUA_VTYT_ID=VP.REF_ID and vp.REF_TABLE='TT_CLSKETQUA_VTYT'
                        inner join TT_NOITRU_BENHAN BA on BA.BENHAN_ID =vp.BENHAN_ID
                        WHERE
                        BA.TRANGTHAI = 'DAXUATVIEN'
                        AND vtyt.CHUNGTU_ID =$CHUNGTU_ID$
            union all
            
            select
                        VTYT.KHAMBENH_VTYT_ID as TOATHUOC_ID
                        from
                        TT_NGOAITRU_KHAMBENH_VTYT VTYT
                        inner join TT_VIENPHI VP on vtyt.KHAMBENH_VTYT_ID=VP.REF_ID and vp.REF_TABLE='TT_NGOAITRU_KHAMBENH_VTYT'
                        inner join TT_NOITRU_BENHAN BA on BA.BENHAN_ID =vp.BENHAN_ID
                        WHERE
                        BA.TRANGTHAI = 'DAXUATVIEN'
                        AND vtyt.CHUNGTU_ID =  $CHUNGTU_ID$
        </statement>
        <!--Revision:0-->
        <statement id="DAO00030_Search_PhieuLinhDaNhapKho" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
            select
            PL.CHUNGTU_ID,
            PL.MACHUNGTU,
            PL.NGAYCHUNGTU,
            PL.NGUOITAO_ID,
            CT.MACHUNGTU AS MAPHIEUNHAP
            from TT_DUOC_PHIEULINH PL
            inner join TT_DUOC_CHUNGTU CT on PL.CHUNGTU_ID = CT.PHIEULINH_ID
            where
            PL.DANHANTHUOC = 1
            AND PL.TRANGTHAI != 'DAHOANTRA'
            AND CT.LOAICHUNGTU = 'N'
            <dynamic prepend="">
                <isParameterPresent>
                    <isNotEmpty prepend="and" property="MACHUNGTU">
                        PL.MACHUNGTU LIKE '%$MACHUNGTU$%'
                    </isNotEmpty>
                    <isNotEmpty prepend="and" property="BENHVIEN_ID">
                        PL.BENHVIEN_ID = '$BENHVIEN_ID$'
                    </isNotEmpty>
                    <isNotEmpty prepend="and" property="KHONHAP_ID">
                        PL.KHONHAP_ID = '$KHONHAP_ID$'
                    </isNotEmpty>
                    <isNotEmpty prepend="and" property="TUNGAY">
                        CONVERT(date, PL.NGAYCHUNGTU) BETWEEN CONVERT(date, '$TUNGAY$')  and  CONVERT(date, '$DENNGAY$')
                    </isNotEmpty>
                </isParameterPresent>
            </dynamic>
        </statement>
        <!--Revision:0-->
        <statement id="DAO00030_SearchPhieuXuatNoiBo" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
            select *
            from TT_DUOC_CHUNGTU
            WHERE
            MUCDICHCHUNGTU_ID= '$MUCDICHCHUNGTU_ID$'
            and BENHVIEN_ID = '$BENHVIEN_ID$'
            AND KHONHAP_ID = '$KHONHAP_ID$'
            AND CONVERT(date, NGAYCHUNGTU)  BETWEEN CONVERT(date, '$TUNGAY$') and CONVERT(date, ' $DENNGAY$')
            AND MACHUNGTU NOT IN (select SOCHUNGTUGOC from TT_DUOC_CHUNGTU WHERE SOCHUNGTUGOC IS NOT NULL)
            <isNotEmpty prepend="" property="MACHUNGTU">
                AND  TT_DUOC_CHUNGTU.MACHUNGTU LIKE '%$MACHUNGTU$%'
            </isNotEmpty>
            <isNotEmpty prepend="and" property="DANHANTHUOC">
                DANHANTHUOC = $DANHANTHUOC$
            </isNotEmpty>
            order by CHUNGTU_ID DESC
        </statement>
        <!--Revision:0-->
        <statement id="DAO00030_SearchToaMuaNgoai" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
          select DISTINCT CT.CHUNGTU_ID, MACHUNGTU, CT.NGAYCHUNGTU, CT.NGUOIGIAO_ID, CT.KHOXUAT_ID, CT.BENHNHAN_ID, CT.LOAITOATHUOC,
          '' AS MAYTE2, NM.TENNGUOIMUA TENBENHNHAN2, NM.SODIENTHOAI SODIENTHOAI2,
          BN.MAYTE, BN.TENBENHNHAN, BN.SODIENTHOAI,CT.GIATRI AS TONGTIEN
          FROM TT_DUOC_CHUNGTU CT
          inner join TT_DUOC_CHUNGTU_CHITIET CTCT on CTCT.CHUNGTU_ID = CT.CHUNGTU_ID
          left join TT_NGOAITRU_TOATHUOC_NGUOIMUA NM on NM.NGOAITRU_TOATHUOC_NGUOIMUA_ID = CT.NGOAITRU_TOATHUOC_NGUOIMUA_ID
          left join TT_BENHNHAN BN on BN.BENHNHAN_ID = CT.BENHNHAN_ID
          WHERE
          CT.MUCDICHCHUNGTU_ID= '$MUCDICHCHUNGTU_ID$'
          and CT.BENHVIEN_ID = '$BENHVIEN_ID$'
          AND CT.KHOXUAT_ID = '$KHOXUAT_ID$'
          AND CONVERT(date, CT.NGAYCHUNGTU) BETWEEN CONVERT(date, '$TUNGAY$') and CONVERT(date, '$DENNGAY$')
          <isParameterPresent>
                <isNotEmpty prepend="and" property="KEYWORD">
                    (BN.TENBENHNHAN LIKE N'%$KEYWORD$%' or BN.MAYTE LIKE '%$KEYWORD$%' or NM.TENNGUOIMUA LIKE N'%$KEYWORD$%' OR CT.MACHUNGTU LIKE '%$KEYWORD$%')
                </isNotEmpty>
                <isNotEmpty prepend="and" property="TRANGTHAI">
                    CT.MACHUNGTU NOT IN (select SOCHUNGTUGOC from TT_DUOC_CHUNGTU WHERE SOCHUNGTUGOC IS NOT NULL)
                </isNotEmpty>
            </isParameterPresent>
            order by CHUNGTU_ID DESC
        </statement>
        <!--Revision:0-->
      <statement id="DAO00030_SearchToaMuaNgoaiDaThanhToan" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
        select distinct CT.CHUNGTU_ID, MACHUNGTU, CT.NGAYCHUNGTU, CT.NGUOIGIAO_ID, CT.KHOXUAT_ID, CT.BENHNHAN_ID,  CT.LOAITOATHUOC,
        '' AS MAYTE2, NM.TENNGUOIMUA TENBENHNHAN2, NM.SODIENTHOAI SODIENTHOAI2,
        BN.MAYTE, BN.TENBENHNHAN, BN.SODIENTHOAI,CT.GIATRI AS TONGTIEN
        FROM TT_DUOC_CHUNGTU CT
        inner join TT_DUOC_CHUNGTU_CHITIET CTCT on CTCT.CHUNGTU_ID = CT.CHUNGTU_ID
        inner join TT_VIENPHI vp on (vp.REF_TABLE = 'TT_DUOC_CHUNGTU_CHITIET' and vp.REF_ID = CTCT.CHUNGTUCHITIET_ID and vp.HOADON_ID IS NOT NULL and vp.DATHANHTOAN = '1' and vp.HUY = 0 )
        left join TT_NGOAITRU_TOATHUOC_NGUOIMUA NM on NM.NGOAITRU_TOATHUOC_NGUOIMUA_ID = CT.NGOAITRU_TOATHUOC_NGUOIMUA_ID
        left join TT_BENHNHAN BN on BN.BENHNHAN_ID = CT.BENHNHAN_ID
        WHERE
        CT.MUCDICHCHUNGTU_CODE = 'X08'
        and CT.MACHUNGTU NOT IN (SELECT SOCHUNGTUGOC FROM TT_DUOC_CHUNGTU WHERE MUCDICHCHUNGTU_CODE = 'N06')
        and CT.BENHVIEN_ID = '$BENHVIEN_ID$'
        AND CT.KHOXUAT_ID = '$KHOXUAT_ID$'
        AND CONVERT(date, CT.NGAYCHUNGTU) BETWEEN CONVERT(date, '$TUNGAY$') and CONVERT(date, '$DENNGAY$')
        <isParameterPresent>
          <isNotEmpty prepend="and" property="KEYWORD">
            (BN.TENBENHNHAN LIKE N'%$KEYWORD$%' or BN.MAYTE LIKE '%$KEYWORD$%' or NM.TENNGUOIMUA LIKE N'%$KEYWORD$%' OR CT.MACHUNGTU LIKE '%$KEYWORD$%')
          </isNotEmpty>
        </isParameterPresent>
        order by CHUNGTU_ID DESC
      </statement>
        <statement id="DAO00030_GetThongTinNguoiMuaNgoai" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
          SELECT TOP 1 nm.* from TT_NGOAITRU_TOATHUOC_NGUOIMUA nm
          INNER JOIN TT_DUOC_CHUNGTU ct on ct.NGOAITRU_TOATHUOC_NGUOIMUA_ID = nm.NGOAITRU_TOATHUOC_NGUOIMUA_ID
          WHERE
          ct.MACHUNGTU = '$MACHUNGTU$'
          AND ct.BENHVIEN_ID = '$BENHVIEN_ID$'
        </statement>
        <!--Revision:0-->
        <statement id="DAO00030_GetDetail" parameterClass="System.String" resultClass="DataObject">
            select *
            from TT_DUOC_CHUNGTU
            where TT_DUOC_CHUNGTU.CHUNGTU_ID  = '$value$'
            and BENHVIEN_ID = '$BENHVIEN_ID$'
            order by CHUNGTU_ID
        </statement>
        <!--Revision:0-->
        <statement id="DAO00030_GetDetailP" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
            select *
            from TT_DUOC_CHUNGTU
            where TT_DUOC_CHUNGTU.CHUNGTU_ID  = '$CHUNGTU_ID$'
            and BENHVIEN_ID = '$BENHVIEN_ID$'
            order by CHUNGTU_ID
        </statement>
        <!--Revision:0-->
        <statement id="DAO00030_Add" parameterClass="System.Collections.IDictionary" resultClass="System.Int64">
            insert into TT_DUOC_CHUNGTU (
            MACHUNGTU
            , SOCHUNGTU
            , NGAYCHUNGTU
            , LOAICHUNGTU
            , MUCDICHCHUNGTU_ID
            , MUCDICHCHUNGTU_CODE
            , KHOXUAT_ID
            , NGUOIGIAO_ID
            , NGUOIGIAO
            , KHONHAP_ID
            , NGUOINHAN_ID
            , NGUOINHAN
            , NGUOIKIEMTRA_ID
            , NGUOIKIEMTRA
            , NGUOIDUYET_ID
            , NGUOIDUYET
            , PHUONGPHAPXUAT
            , KETOANTRUONG_ID
            , KETOANTRUONG
            , THUKHO_ID
            , THUKHO
            , MAUHOADON
            , SOHOADON
            , SOSERI
            , NGAYHOADON
            , DIENGIAI
            , GIATRI
            , GIATRITHANHTOAN
            , TYLEVAT
            , GIATRIVAT
            , THUESUAT
            , GIATRITHUE
            , TYLECHIETKHAU
            , GIATRICHIETKHAU
            , TIENTE_ID
            , TYGIA
            , SOCHUNGTUGOC
            , NGAYCHUNGTUGOC
            , NHACUNGCAP_ID
            , HINHTHUCTHANHTOAN_ID
            , NGUONDUOC_ID
            , CHUNGTULIENQUAN_ID
            , KHAMBENH_ID
            , TOATHUOCNOITRU_ID
            , TIEPNHAN_ID
            , BENHAN_ID
            , DANHANTHUOC
            , NGUOINHAP_ID
            , NGAYNHAP
            , TRANGTHAI
            , LOAITOATHUOC
            , PHIEULINH_ID
            , DIENGIAINGHIEPVUPHATSINH
            , DONVIGIAO_ID
            , KHOSUDUNG_ID
            , LOAIVATTU_ID
            , BENHNHAN_ID
            , NGOAITRU_TOATHUOC_NGUOIMUA_ID
            , TENBENHNHAN
            , BACSIGIOITHIEU_ID
            , DOITUONG_ID
            , IDCHUYEN
            , CHUNGTUKETOAN
            , STATUS
            , TRANSFER_VIENPHI_ID
            , PHONGBAN_ID
            , BACSI_ID
            , TKNO
            , TKCO
            , MACHUNGTUREF
            , LOAICHUNGTUREF
            , PHIEULINHCANTRU_ID
            , KHOTHUCHIEN_ID
            , KHODOIUNG_ID
            , MENU_LOAIDUOC_ID
            , NGUOISUDUNGMAY_ID
            , GOITHAU_ID
            , XUATTHUOCBANGOAITRU
            , NGAYGIOCHUNGTU
            , NOIDAKHAM
            , HOIDONGKIEMNHAP_ID
            , HOIDONGTHANHLY_ID
            , CHUYENCHUNGTUID
            , CHUYENDOANHTHUID
            , LYDOXUATSUDUNG_ID
            , BENHVIEN_ID
            , NGAYTAO
            , NGUOITAO_ID
            , NGAYCAPNHAT
            , NGUOICAPNHAT_ID
            ) values (
            #MACHUNGTU#
            , #SOCHUNGTU#
            , #NGAYCHUNGTU#
            , #LOAICHUNGTU#
            , #MUCDICHCHUNGTU_ID#
            , #MUCDICHCHUNGTU_CODE#
            , #KHOXUAT_ID#
            , #NGUOIGIAO_ID#
            , #NGUOIGIAO#
            , #KHONHAP_ID#
            , #NGUOINHAN_ID#
            , #NGUOINHAN#
            , #NGUOIKIEMTRA_ID#
            , #NGUOIKIEMTRA#
            , #NGUOIDUYET_ID#
            , #NGUOIDUYET#
            , #PHUONGPHAPXUAT#
            , #KETOANTRUONG_ID#
            , #KETOANTRUONG#
            , #THUKHO_ID#
            , #THUKHO#
            , #MAUHOADON#
            , #SOHOADON#
            , #SOSERI#
            , #NGAYHOADON#
            , #DIENGIAI#
            , #GIATRI#
            , #GIATRITHANHTOAN#
            , #TYLEVAT#
            , #GIATRIVAT#
            , #THUESUAT#
            , #GIATRITHUE#
            , #TYLECHIETKHAU#
            , #GIATRICHIETKHAU#
            , #TIENTE_ID#
            , #TYGIA#
            , #SOCHUNGTUGOC#
            , #NGAYCHUNGTUGOC#
            , #NHACUNGCAP_ID#
            , #HINHTHUCTHANHTOAN_ID#
            , #NGUONDUOC_ID#
            , #CHUNGTULIENQUAN_ID#
            , #KHAMBENH_ID#
            , #TOATHUOCNOITRU_ID#
            , #TIEPNHAN_ID#
            , #BENHAN_ID#
            , #DANHANTHUOC#
            , #NGUOINHAP_ID#
            , #NGAYNHAP#
            , #TRANGTHAI#
            , #LOAITOATHUOC#
            , #PHIEULINH_ID#
            , #DIENGIAINGHIEPVUPHATSINH#
            , #DONVIGIAO_ID#
            , #KHOSUDUNG_ID#
            , #LOAIVATTU_ID#
            , #BENHNHAN_ID#
            , #NGOAITRU_TOATHUOC_NGUOIMUA_ID#
            , #TENBENHNHAN#
            , #BACSIGIOITHIEU_ID#
            , #DOITUONG_ID#
            , #IDCHUYEN#
            , #CHUNGTUKETOAN#
            , #STATUS#
            , #TRANSFER_VIENPHI_ID#
            , #PHONGBAN_ID#
            , #BACSI_ID#
            , #TKNO#
            , #TKCO#
            , #MACHUNGTUREF#
            , #LOAICHUNGTUREF#
            , #PHIEULINHCANTRU_ID#
            , #KHOTHUCHIEN_ID#
            , #KHODOIUNG_ID#
            , #MENU_LOAIDUOC_ID#
            , #NGUOISUDUNGMAY_ID#
            , #GOITHAU_ID#
            , #XUATTHUOCBANGOAITRU#
            , #NGAYGIOCHUNGTU#
            , #NOIDAKHAM#
            , #HOIDONGKIEMNHAP_ID#
            , #HOIDONGTHANHLY_ID#
            , #CHUYENCHUNGTUID#
            , #CHUYENDOANHTHUID#
            , #LYDOXUATSUDUNG_ID#
            , #BENHVIEN_ID#
            , #NGAYCHUNGTU#
            , #NGUOITAO_ID#
            , #NGAYCAPNHAT#
            , #NGUOICAPNHAT_ID#
            )
            select SCOPE_identity() as value
        </statement>
        <!--Revision:0-->
        <update id="DAO00030_Update" parameterClass="System.Collections.IDictionary">
            update TT_DUOC_CHUNGTU set
            NGAYCHUNGTU = #NGAYCHUNGTU#
            , LOAICHUNGTU = #LOAICHUNGTU#
            , MUCDICHCHUNGTU_ID = #MUCDICHCHUNGTU_ID#
            , MUCDICHCHUNGTU_CODE = #MUCDICHCHUNGTU_CODE#
            , KHOXUAT_ID = #KHOXUAT_ID#
            , NGUOIGIAO_ID = #NGUOIGIAO_ID#
            , NGUOIGIAO = #NGUOIGIAO#
            , KHONHAP_ID = #KHONHAP_ID#
            , NGUOINHAN_ID = #NGUOINHAN_ID#
            , NGUOINHAN = #NGUOINHAN#
            , NGUOIKIEMTRA_ID = #NGUOIKIEMTRA_ID#
            , NGUOIKIEMTRA = #NGUOIKIEMTRA#
            , NGUOIDUYET_ID = #NGUOIDUYET_ID#
            , NGUOIDUYET = #NGUOIDUYET#
            , PHUONGPHAPXUAT = #PHUONGPHAPXUAT#
            , KETOANTRUONG_ID = #KETOANTRUONG_ID#
            , KETOANTRUONG = #KETOANTRUONG#
            , THUKHO_ID = #THUKHO_ID#
            , THUKHO = #THUKHO#
            , MAUHOADON = #MAUHOADON#
            , SOHOADON = #SOHOADON#
            , SOSERI = #SOSERI#
            , NGAYHOADON = #NGAYHOADON#
            , DIENGIAI = #DIENGIAI#
            , GIATRI = #GIATRI#
            , GIATRITHANHTOAN = #GIATRITHANHTOAN#
            , TYLEVAT = #TYLEVAT#
            , GIATRIVAT = #GIATRIVAT#
            , THUESUAT = #THUESUAT#
            , GIATRITHUE = #GIATRITHUE#
            , TYLECHIETKHAU = #TYLECHIETKHAU#
            , GIATRICHIETKHAU = #GIATRICHIETKHAU#
            , TIENTE_ID = #TIENTE_ID#
            , TYGIA = #TYGIA#
            , SOCHUNGTUGOC = #SOCHUNGTUGOC#
            , NGAYCHUNGTUGOC = #NGAYCHUNGTUGOC#
            , NHACUNGCAP_ID = #NHACUNGCAP_ID#
            , HINHTHUCTHANHTOAN_ID = #HINHTHUCTHANHTOAN_ID#
            , NGUONDUOC_ID = #NGUONDUOC_ID#
            , CHUNGTULIENQUAN_ID = #CHUNGTULIENQUAN_ID#
            , KHAMBENH_ID = #KHAMBENH_ID#
            , TOATHUOCNOITRU_ID = #TOATHUOCNOITRU_ID#
            , TIEPNHAN_ID = #TIEPNHAN_ID#
            , BENHAN_ID = #BENHAN_ID#
            , DANHANTHUOC = #DANHANTHUOC#
            , NGUOINHAP_ID = #NGUOINHAP_ID#
            , NGAYNHAP = #NGAYNHAP#
            , TRANGTHAI = #TRANGTHAI#
            , PHIEULINH_ID = #PHIEULINH_ID#
            , LOAITOATHUOC = #LOAITOATHUOC#
            , DIENGIAINGHIEPVUPHATSINH = #DIENGIAINGHIEPVUPHATSINH#
            , DONVIGIAO_ID = #DONVIGIAO_ID#
            , KHOSUDUNG_ID = #KHOSUDUNG_ID#
            , LOAIVATTU_ID = #LOAIVATTU_ID#
            , BENHNHAN_ID = #BENHNHAN_ID#
            , TENBENHNHAN = #TENBENHNHAN#
            , BACSIGIOITHIEU_ID = #BACSIGIOITHIEU_ID#
            , DOITUONG_ID = #DOITUONG_ID#
            , IDCHUYEN = #IDCHUYEN#
            , CHUNGTUKETOAN = #CHUNGTUKETOAN#
            , STATUS = #STATUS#
            , TRANSFER_VIENPHI_ID = #TRANSFER_VIENPHI_ID#
            , PHONGBAN_ID = #PHONGBAN_ID#
            , BACSI_ID = #BACSI_ID#
            , TKNO = #TKNO#
            , TKCO = #TKCO#
            , MACHUNGTUREF = #MACHUNGTUREF#
            , LOAICHUNGTUREF = #LOAICHUNGTUREF#
            , PHIEULINHCANTRU_ID = #PHIEULINHCANTRU_ID#
            , KHOTHUCHIEN_ID = #KHOTHUCHIEN_ID#
            , KHODOIUNG_ID = #KHODOIUNG_ID#
            , MENU_LOAIDUOC_ID = #MENU_LOAIDUOC_ID#
            , NGUOISUDUNGMAY_ID = #NGUOISUDUNGMAY_ID#
            , GOITHAU_ID = #GOITHAU_ID#
            , XUATTHUOCBANGOAITRU = #XUATTHUOCBANGOAITRU#
            , NGAYGIOCHUNGTU = #NGAYGIOCHUNGTU#
            , NOIDAKHAM = #NOIDAKHAM#
            , HOIDONGKIEMNHAP_ID = #HOIDONGKIEMNHAP_ID#
            , HOIDONGTHANHLY_ID = #HOIDONGTHANHLY_ID#
            , CHUYENCHUNGTUID = #CHUYENCHUNGTUID#
            , CHUYENDOANHTHUID = #CHUYENDOANHTHUID#
            , LYDOXUATSUDUNG_ID = #LYDOXUATSUDUNG_ID#          
            , NGAYCAPNHAT = #NGAYCAPNHAT#
            , NGUOICAPNHAT_ID = #NGUOICAPNHAT_ID#
            where
            CHUNGTU_ID = '$CHUNGTU_ID$'
        </update>
        <!--Revision:0-->
        <update id="DAO00030_UpdateChungTuLienQuan" parameterClass="System.Collections.IDictionary">
            update
            TT_DUOC_CHUNGTU
            set
            CHUNGTULIENQUAN_ID = #CHUNGTULIENQUAN_ID#,
            NGAYCAPNHAT = getdate()
            where
            MACHUNGTU = '$MACHUNGTU$'
        </update>
        <!--Revision:0-->
        <update id="DAO00030_UpdateHoaDon" parameterClass="System.Collections.IDictionary">
            update
            TT_DUOC_CHUNGTU
            set
            MAUHOADON = #MAUHOADON#
            ,SOHOADON = #SOHOADON#
            ,SOSERI = #SOSERI#
            ,NGAYHOADON = #NGAYHOADON#
            ,NGAYCAPNHAT = #NGAYCAPNHAT#
            ,NGUOICAPNHAT_ID = #NGUOICAPNHAT_ID#
            where
            CHUNGTU_ID = '$CHUNGTU_ID$'
        </update>
        <!--Revision:0-->
        <statement id="DAO00030_Delete" parameterClass="System.Collections.IDictionary" resultClass="System.Int32">
            delete from TT_DUOC_CHUNGTU
            where
            CHUNGTU_ID = '$CHUNGTU_ID$'
        </statement>
        <!--Revision:0-->
        <statement id="DAO00030_DeleteP" parameterClass="System.Collections.IDictionary" resultClass="System.Int32">
            delete from TT_DUOC_CHUNGTU
            <dynamic prepend="where">
                <isParameterPresent>
                    <isNotEmpty prepend="and" property="CHUNGTU_ID">
                        TT_DUOC_CHUNGTU.CHUNGTU_ID = '$CHUNGTU_ID$'
                    </isNotEmpty>
                    <isNotEmpty prepend="and" property="MACHUNGTU">
                        TT_DUOC_CHUNGTU.MACHUNGTU = '$MACHUNGTU$'
                    </isNotEmpty>
                    <isNotEmpty prepend="and" property="SOCHUNGTU">
                        TT_DUOC_CHUNGTU.SOCHUNGTU = '$SOCHUNGTU$'
                    </isNotEmpty>           
                </isParameterPresent>
            </dynamic>
        </statement>
        <!--Revision:0-->
        <statement id="DAO00030_CHUNGTUCT_TON" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
            SELECT A.*, B.TONGTON FROM
            (
            SELECT
            CTCT.CHUNGTUCHITIET_ID, CTCT.CHUNGTU_ID, CTCT.SOLONHAP_ID, CTCT.DUOC_ID, CTCT.SOLUONGYEUCAU, CTCT.SOLUONGDAXUAT, CTCT.NGUONHANG_ID
            FROM
            TT_DUOC_CHUNGTU_CHITIET CTCT
            WHERE
            CTCT.CHUNGTU_ID = '$CHUNGTU_ID$'
            and CTCT.BENHVIEN_ID = '$BENHVIEN_ID$'
            )A,
            (
            SELECT
            CTCT.DUOC_ID AS DUOC_ID, SUM(SOLUONG) AS TONGTON
            FROM
            TT_DUOC_TONKHO TK, TT_DUOC_CHUNGTU_CHITIET CTCT, TT_DUOC_CHUNGTU CT
            WHERE
            TK.KHODUOC_ID = CT.KHOXUAT_ID
            and CT.BENHVIEN_ID = '$BENHVIEN_ID$'
            AND CT.CHUNGTU_ID = CTCT.CHUNGTU_ID
            AND CTCT.DUOC_ID = TK.DUOC_ID
            AND CTCT.CHUNGTU_ID = '$CHUNGTU_ID$'
            GROUP BY TK.KHODUOC_ID, CTCT.DUOC_ID
            ) B
            WHERE A.DUOC_ID = B.DUOC_ID
        </statement>
        <!--Revision:0-->
        <statement id="DAO00030_CHUNGTUCT_GetAll" resultClass="DataObject">
            select *
            from TT_DUOC_CHUNGTU_CHITIET
            WHERE BENHVIEN_ID = '$BENHVIEN_ID$'
            order by CHUNGTUCHITIET_ID
        </statement>
        <!--Revision:0-->
        <statement id="DAO00030_CHUNGTUXUAT_CHITIET_GetList" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
          SELECT
          ctct.*,
          d.MADUOC, d.TENHANG, d.TENDUOCDAYDU, dvt.TENDONVITINH as DONVITINH,n.TENNGUONDUOC as NGUONHANG,
          sln.SOLONHAP, sln.SOLOSANPHAM, sln.NGAYNHAP as NGAYNHAPLO, sln.HANDUNG as HANSUDUNG,
          isnull(tk.SOLUONG,0) as SOLUONGTON,
          LTRIM(ct.KHOXUAT_ID) + '_' + LTRIM(sln.DUOC_ID) + '_' + LTRIM(sln.NGUONDUOC_ID) as DUOC_KEY
          , NLD.MANHOMLOAIDUOC, ld.MALOAIDUOC, D.SO_QDTT
          FROM
          TT_DUOC_CHUNGTU_CHITIET ctct
          INNER JOIN TT_DUOC_CHUNGTU ct ON (ct.CHUNGTU_ID = ctct.CHUNGTU_ID)
          INNER JOIN TT_DUOC_CHUNGTU_SOLONHAP sln ON (sln.SOLONHAP_ID = ctct.SOLONHAP_ID)
          LEFT JOIN (
          select xx.DUOCTONKHO_ID, xx.KHODUOC_ID, xx.DUOC_ID, xx.SOLONHAP_ID, xx.SOLUONG, xx.NGUONDUOC_ID, xx.BENHVIEN_ID from TT_DUOC_TONKHO xx
          join ( select max(DUOCTONKHO_ID) as DUOCTONKHO_ID, KHODUOC_ID, DUOC_ID, SOLONHAP_ID, NGUONDUOC_ID
          from TT_DUOC_TONKHO group by KHODUOC_ID, DUOC_ID, SOLONHAP_ID, NGUONDUOC_ID) yy on xx.DUOCTONKHO_ID=yy.DUOCTONKHO_ID
          ) tk ON (tk.SOLONHAP_ID = sln.SOLONHAP_ID AND tk.DUOC_ID = sln.DUOC_ID and tk.KHODUOC_ID = ct.KHOXUAT_ID)
          INNER JOIN TM_DUOC d ON (d.DUOC_ID = ctct.DUOC_ID)
          INNER JOIN TM_NGUONHANG n ON (n.NGUONDUOC_ID = ctct.NGUONHANG_ID)
          LEFT JOIN TM_DONVITINH dvt ON (dvt.DONVITINH_ID = ctct.DONVITINH_ID)
          left join TM_LOAIDUOC LD on LD.LOAIDUOC_ID = D.LOAIDUOC_ID
          LEFT JOIN TM_NHOMLOAIDUOC NLD on NLD.NHOMLOAIDUOC_ID = LD.NHOMLOAIDUOC_ID
          <dynamic prepend="where">
                <isParameterPresent>
                    <isNotEmpty prepend="and" property="CHUNGTU_ID">
                        ct.CHUNGTU_ID = '$CHUNGTU_ID$'
                    </isNotEmpty>
                    <isNotEmpty prepend="and" property="BENHVIEN_ID">
                        ct.BENHVIEN_ID = '$BENHVIEN_ID$'
                    </isNotEmpty>
                </isParameterPresent>
            </dynamic>
            order by CHUNGTUCHITIET_ID
        </statement>
        <!--Revision:0-->
        <statement id="DAO00030_CHUNGTUNHAP_CHITIET_GetList" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
          SELECT
          ctct.*,
          d.MADUOC, d.TENHANG, d.TENDUOCDAYDU, d.DONVITINH,n.TENNGUONDUOC as NGUONHANG,
          sln.SOLONHAP, sln.SOLOSANPHAM, sln.NGAYNHAP as NGAYNHAPLO, sln.HANDUNG as HANSUDUNG,
          isnull(tk.SOLUONG,0) as SOLUONGTON,
          LTRIM(ct.KHONHAP_ID) + '_' + LTRIM(sln.DUOC_ID) + '_' + LTRIM(sln.NGUONDUOC_ID) as DUOC_KEY
          FROM
          TT_DUOC_CHUNGTU_CHITIET ctct
          INNER JOIN TT_DUOC_CHUNGTU ct ON (ct.CHUNGTU_ID = ctct.CHUNGTU_ID)
          LEFT JOIN TT_DUOC_CHUNGTU_SOLONHAP sln ON (sln.SOLONHAP_ID = ctct.SOLONHAP_ID)
          <!--LEFT JOIN TT_DUOC_TONKHO tk ON (tk.SOLONHAP_ID = sln.SOLONHAP_ID AND tk.DUOC_ID = sln.DUOC_ID and tk.KHODUOC_ID = ct.KHONHAP_ID)-->
          LEFT JOIN (
          select xx.DUOCTONKHO_ID, xx.KHODUOC_ID, xx.DUOC_ID, xx.SOLONHAP_ID, xx.SOLUONG, xx.NGUONDUOC_ID, xx.BENHVIEN_ID from TT_DUOC_TONKHO xx
          join ( select max(DUOCTONKHO_ID) as DUOCTONKHO_ID, KHODUOC_ID, DUOC_ID, SOLONHAP_ID, NGUONDUOC_ID
          from TT_DUOC_TONKHO group by KHODUOC_ID, DUOC_ID, SOLONHAP_ID, NGUONDUOC_ID) yy on xx.DUOCTONKHO_ID=yy.DUOCTONKHO_ID
          ) tk ON (tk.SOLONHAP_ID = sln.SOLONHAP_ID AND tk.DUOC_ID = sln.DUOC_ID and tk.KHODUOC_ID = ct.KHONHAP_ID)
          INNER JOIN TM_DUOC d ON (d.DUOC_ID = ctct.DUOC_ID)
          INNER JOIN TM_NGUONHANG n ON (n.NGUONDUOC_ID = ctct.NGUONHANG_ID)
          LEFT JOIN TM_DONVITINH dvt ON (dvt.DONVITINH_ID = ctct.DONVITINH_ID)
          <dynamic prepend="where">
                <isParameterPresent>
                    <isNotEmpty prepend="and" property="CHUNGTU_ID">
                        ct.CHUNGTU_ID = '$CHUNGTU_ID$'
                    </isNotEmpty>
                    <isNotEmpty prepend="and" property="BENHVIEN_ID">
                        ct.BENHVIEN_ID = '$BENHVIEN_ID$'
                    </isNotEmpty>
                </isParameterPresent>
            </dynamic>
            order by CHUNGTUCHITIET_ID
        </statement>
      <statement id="DAO00030_CHUNGTUNHAP_CHITIET_BAOCHE_GetList" parameterClass="System.Collections.IDictionary" resultClass="DataObject">

        DECLARE @KHODUOC_ID INT
        SELECT @KHODUOC_ID = KHONHAP_ID FROM TT_DUOC_CHUNGTU WHERE CHUNGTU_ID = #CHUNGTU_ID#

        SELECT
        ctct.*,
        d.MADUOC, d.TENHANG, d.TENDUOCDAYDU, d.DONVITINH, n.TENNGUONDUOC as NGUONHANG,
        sln.SOLONHAP,
        sln.SOLOSANPHAM,
        tk.DUOC_ID as NGUYENLIEU_ID,
        tk.TENNGUYENLIEU,
        tk.TONGTON
        FROM
        TT_DUOC_CHUNGTU_CHITIET ctct
        INNER JOIN TT_DUOC_CHUNGTU ct ON ct.CHUNGTU_ID = ctct.CHUNGTU_ID
        INNER JOIN TT_DUOC_CHUNGTU_SOLONHAP sln ON ctct.SOLONHAP_ID = sln.SOLONHAP_ID
        LEFT JOIN TM_DUOC_TYLEPHACHE pc on pc.THANHPHAM_ID = ctct.DUOC_ID
        LEFT JOIN (
        select tk.KHODUOC_ID, d.DUOC_ID, d.TENDUOCDAYDU AS TENNGUYENLIEU, SUM(SOLUONG) as TONGTON
        from TT_DUOC_TONKHO tk
        INNER JOIN TM_DUOC d ON d.DUOC_ID = tk.DUOC_ID
        where tk.KHODUOC_ID = @KHODUOC_ID
        group by tk.KHODUOC_ID, d.DUOC_ID, d.TENDUOCDAYDU
        ) tk
        ON (tk.KHODUOC_ID = ct.KHONHAP_ID and tk.DUOC_ID = pc.NGUYENLIEU_ID)

        INNER JOIN TM_DUOC d ON (d.DUOC_ID = ctct.DUOC_ID)
        INNER JOIN TM_NGUONHANG n ON (n.NGUONDUOC_ID = ctct.NGUONHANG_ID)
        WHERE
        ct.CHUNGTU_ID = #CHUNGTU_ID#
      </statement>
      <statement id="DAO00030_CHUNGTUNHAP_CHITIET_PHACHE_GetList" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
        SELECT
        ctct.*,
        d.MADUOC, d.TENHANG, d.TENDUOCDAYDU, d.DONVITINH, n.TENNGUONDUOC as NGUONHANG,
        sln.SOLONHAP,
        sln.SOLOSANPHAM
        FROM
        TT_DUOC_CHUNGTU_CHITIET ctct
        INNER JOIN TT_DUOC_CHUNGTU ct ON ct.CHUNGTU_ID = ctct.CHUNGTU_ID
        INNER JOIN TT_DUOC_CHUNGTU_SOLONHAP sln ON ctct.SOLONHAP_ID = sln.SOLONHAP_ID
        INNER JOIN TM_DUOC d ON (d.DUOC_ID = ctct.DUOC_ID)
        INNER JOIN TM_NGUONHANG n ON (n.NGUONDUOC_ID = ctct.NGUONHANG_ID)
        WHERE
        ct.CHUNGTU_ID = #CHUNGTU_ID#
      </statement>
      <statement id="DAO00030_CHUNGTUXUATBHYT_CHITIET_GetList" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
        SELECT
        ctct.*, tt.KHAMBENH_TOATHUOC_ID,
        d.MADUOC, d.TENHANG, d.TENDUOCDAYDU, dvt.TENDONVITINH as DONVITINH,n.TENNGUONDUOC as NGUONHANG,
        sln.SOLONHAP, sln.SOLOSANPHAM, sln.NGAYNHAP as NGAYNHAPLO, sln.HANDUNG as HANSUDUNG,
        isnull(tk.SOLUONG,0) as SOLUONGTON,
        LTRIM(ct.KHOXUAT_ID) + '_' + LTRIM(sln.DUOC_ID) + '_' + LTRIM(sln.NGUONDUOC_ID) as DUOC_KEY
        , NLD.MANHOMLOAIDUOC, ld.MALOAIDUOC, D.SO_QDTT
        FROM
        TT_DUOC_CHUNGTU_CHITIET ctct
        INNER JOIN TT_NGOAITRU_TOATHUOC tt ON (tt.TOATHUOC_ID = ctct.TOATHUOCNGOAITRU_ID)
        INNER JOIN TT_DUOC_CHUNGTU ct ON (ct.CHUNGTU_ID = ctct.CHUNGTU_ID)
        INNER JOIN TT_DUOC_CHUNGTU_SOLONHAP sln ON (sln.SOLONHAP_ID = ctct.SOLONHAP_ID)
        LEFT JOIN (
        select xx.DUOCTONKHO_ID, xx.KHODUOC_ID, xx.DUOC_ID, xx.SOLONHAP_ID, xx.SOLUONG, xx.NGUONDUOC_ID, xx.BENHVIEN_ID from TT_DUOC_TONKHO xx
        join ( select max(DUOCTONKHO_ID) as DUOCTONKHO_ID, KHODUOC_ID, DUOC_ID, SOLONHAP_ID, NGUONDUOC_ID
        from TT_DUOC_TONKHO group by KHODUOC_ID, DUOC_ID, SOLONHAP_ID, NGUONDUOC_ID) yy on xx.DUOCTONKHO_ID=yy.DUOCTONKHO_ID
        ) tk ON (tk.SOLONHAP_ID = sln.SOLONHAP_ID AND tk.DUOC_ID = sln.DUOC_ID and tk.KHODUOC_ID = ct.KHOXUAT_ID)
        INNER JOIN TM_DUOC d ON (d.DUOC_ID = ctct.DUOC_ID)
        INNER JOIN TM_NGUONHANG n ON (n.NGUONDUOC_ID = ctct.NGUONHANG_ID)
        LEFT JOIN TM_DONVITINH dvt ON (dvt.DONVITINH_ID = ctct.DONVITINH_ID)
        left join TM_LOAIDUOC LD on LD.LOAIDUOC_ID = D.LOAIDUOC_ID
        LEFT JOIN TM_NHOMLOAIDUOC NLD on NLD.NHOMLOAIDUOC_ID = LD.NHOMLOAIDUOC_ID
        <dynamic prepend="where">
          <isParameterPresent>
            <isNotEmpty prepend="and" property="CHUNGTU_ID">
              ct.CHUNGTU_ID = '$CHUNGTU_ID$'
            </isNotEmpty>
            <isNotEmpty prepend="and" property="BENHVIEN_ID">
              ct.BENHVIEN_ID = '$BENHVIEN_ID$'
            </isNotEmpty>
          </isParameterPresent>
        </dynamic>
        order by CHUNGTUCHITIET_ID
      </statement>
        <!--Revision:0-->
        <statement id="DAO00030_CHUNGTUCT_GetList" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
          select ctct.*, SLN.SOLONHAP, SLN.SOLOSANPHAM, D.TENDUOCDAYDU, D.SO_QDTT, d.MADUOC, d.MADUOCBV,
          dvtqc.TENDONVITINH as QUYCACH,
          DONVITINH =
          CASE
          WHEN ctct.DONVITINHBANDAU_ID is null THEN dvtqc.TENDONVITINH
          ELSE dvtcb.TENDONVITINH
          END
          ,LD.LOAIVATTU_ID          
          from TT_DUOC_CHUNGTU_CHITIET ctct
          left join TT_DUOC_CHUNGTU_SOLONHAP SLN on SLN.SOLONHAP_ID = ctct.SOLONHAP_ID
          left join TM_DUOC D on D.DUOC_ID = ctct.DUOC_ID
          left join TM_LOAIDUOC LD on LD.LOAIDUOC_ID = D.LOAIDUOC_ID
          left join TM_DONVITINH dvtqc on dvtqc.DONVITINH_ID = ctct.DONVITINH_ID
          left join TM_DONVITINH dvtcb on dvtcb.DONVITINH_ID = ctct.DONVITINHBANDAU_ID
          <dynamic prepend="where">
                <isParameterPresent>
                    <isNotEmpty prepend="and" property="CHUNGTUCHITIET_ID">
                      ctct.CHUNGTUCHITIET_ID = '$CHUNGTUCHITIET_ID$'
                    </isNotEmpty>
                    <isNotEmpty prepend="and" property="CHUNGTU_ID">
                      ctct.CHUNGTU_ID = '$CHUNGTU_ID$'
                    </isNotEmpty>                                      
                </isParameterPresent>
            </dynamic>
          order by ctct.CHUNGTUCHITIET_ID
        </statement>
        <!--Revision:0-->
        <statement id="DAO00030_CHUNGTUCT_GetDetail" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
            select *
            from TT_DUOC_CHUNGTU_CHITIET
            where CHUNGTUCHITIET_ID  = '$value$'
            and BENHVIEN_ID = '$BENHVIEN_ID$'
            order by CHUNGTUCHITIET_ID
        </statement>
        <!--Revision:0-->
        <statement id="DAO00030_CHUNGTUCT_GetDetailP" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
            select *
            from TT_DUOC_CHUNGTU_CHITIET
            where CHUNGTUCHITIET_ID  = '$CHUNGTUCHITIET_ID$'
            and BENHVIEN_ID = '$BENHVIEN_ID$'
            order by CHUNGTUCHITIET_ID
        </statement>
        <!--Revision:0-->
        <statement id="DAO00030_CHUNGTUCT_Add" parameterClass="System.Collections.IDictionary" resultClass="System.Int64">
          insert into TT_DUOC_CHUNGTU_CHITIET (
          CHUNGTU_ID
          , DUOC_ID
          , SOLONHAP_ID
          , SOKIEMSOAT
          , SOVISA
          , HANDUNG
          , DONVITINH_ID
          , SOLUONGYEUCAU
          , SOLUONGTHUCTE
          , SOLUONGDAXUAT
          , TIENTE_ID
          , TYGIA
          , DONGIAMUA
          , DONGIA_BHYT
          , DONGIABAN
          , DONGIABAN_VAT
          , DONGIAVON
          , DONGIATHANHTOAN
          , SOQUYEN
          , SOHOADONVAT
          , TYLEVAT
          , GIATRIVAT
          , TYLECHIETKHAU
          , GIATRICHIETKHAU
          , MIENPHI
          , LYDOMIENPHI_ID
          , SOCHUNGTUKETOAN
          , SOCHUNGTUTIENMAT
          , TRANGTHAI
          , DAPHATSINHPHIEUXUAT
          , DAPHATSINHPHIEUHOANTRA
          , KHUYENMAI
          , PHUONGPHAPXUAT
          , DONDATHANG_ID
          , GHICHUCHITIET
          , NGUONHANG_ID
          , DONGIAVONVAT
          , THANHTIENMUA
          , THANHTIENVON
          , THANHTIENHOPDONG
          , ISTACHLO
          , DONVITINHBANDAU_ID
          , SOLUONGBANDAU
          , GOITHAU_ID
          , DONGIATHAU
          , DONGIAPO
          , TYLEQUIDOI
          , TOATHUOCNOITRU_ID
          , KHAMBENH_VTYT_ID
          , PHAUTHUAT_VTYT_ID
          , CLSKETQUA_VTYT_ID
          , TOATHUOCNGOAITRU_ID
          , MASTER_ID
          , BENHNHAN
          , YLENH        
            <isNotEmpty prepend="" property="CHEBIEN">,CHEBIEN</isNotEmpty>
            <isNotEmpty prepend="" property="DAT">,DAT</isNotEmpty>
            <isNotEmpty prepend="" property="DONGIATRUOCTHUE">
              <isGreaterThan prepend="" property="DONGIATRUOCTHUE" compareValue="0">,DONGIATRUOCTHUE</isGreaterThan>
            </isNotEmpty>
          , BENHVIEN_ID
          , NGAYTAO
          , NGUOITAO_ID
          , NGAYCAPNHAT
          , NGUOICAPNHAT_ID
          , THANHTIENMUABANDAU
          , SOLUONGQUIDOI
          ) values (
          #CHUNGTU_ID#
          , #DUOC_ID#
          , #SOLONHAP_ID#
          , #SOKIEMSOAT#
          , #SOVISA#
          , #HANDUNG#
          , #DONVITINH_ID#
          , #SOLUONGYEUCAU#
          , #SOLUONGTHUCTE#
          , #SOLUONGDAXUAT#
          , #TIENTE_ID#
          , #TYGIA#
          , #DONGIAMUA#
          , #DONGIA_BHYT#
          , #DONGIABAN#
          , #DONGIABAN_VAT#
          , #DONGIAVON#
          , #DONGIATHANHTOAN#
          , #SOQUYEN#
          , #SOHOADONVAT#
          , #TYLEVAT#
          , #GIATRIVAT#
          , #TYLECHIETKHAU#
          , #GIATRICHIETKHAU#
          , #MIENPHI#
          , #LYDOMIENPHI_ID#
          , #SOCHUNGTUKETOAN#
          , #SOCHUNGTUTIENMAT#
          , #TRANGTHAI#
          , #DAPHATSINHPHIEUXUAT#
          , #DAPHATSINHPHIEUHOANTRA#
          , #KHUYENMAI#
          , #PHUONGPHAPXUAT#
          , #DONDATHANG_ID#
          , #GHICHUCHITIET#
          , #NGUONHANG_ID#
          , #DONGIAVONVAT#
          , #THANHTIENMUA#
          , #THANHTIENVON#
          , #THANHTIENHOPDONG#
          , #ISTACHLO#
          , #DONVITINHBANDAU_ID#
          , #SOLUONGBANDAU#
          , #GOITHAU_ID#
          , #DONGIATHAU#
          , #DONGIAPO#
          , #TYLEQUIDOI#
          , #TOATHUOCNOITRU_ID#
          , #KHAMBENH_VTYT_ID#
          , #PHAUTHUAT_VTYT_ID#
          , #CLSKETQUA_VTYT_ID#
          , #TOATHUOCNGOAITRU_ID#
          , #MASTER_ID#
          , #BENHNHAN#
          , #YLENH#
          <isNotEmpty prepend="" property="CHEBIEN">, #CHEBIEN#</isNotEmpty>
          <isNotEmpty prepend="" property="DAT"> , #DAT#</isNotEmpty>
          <isNotEmpty prepend="" property="DONGIATRUOCTHUE">
          <isGreaterThan prepend="" property="DONGIATRUOCTHUE" compareValue="0">,#DONGIATRUOCTHUE#</isGreaterThan>
          </isNotEmpty>
          , #BENHVIEN_ID#
          , #NGAYTAO#
          , #NGUOITAO_ID#
          , #NGAYCAPNHAT#
          , #NGUOICAPNHAT_ID#
          , #THANHTIENMUABANDAU#
          , #SOLUONGQUIDOI#
          )
          select SCOPE_identity() as value
        </statement>         
      
       <statement id="DAO00030_CHUNGTUCT_AddMulti" parameterClass="System.String" resultClass="System.Int32">
         declare @json nvarchar(max) =  N'$JSON_DATA$';

         INSERT INTO TT_DUOC_CHUNGTU_CHITIET
         (
         CHUNGTU_ID
         , DUOC_ID
         , SOLONHAP_ID
         , SOKIEMSOAT
         , SOVISA
         , HANDUNG
         , DONVITINH_ID
         , SOLUONGYEUCAU
         , SOLUONGTHUCTE
         , SOLUONGDAXUAT
         , TIENTE_ID
         , TYGIA
         , DONGIAMUA
         , DONGIA_BHYT
         , DONGIABAN
         , DONGIABAN_VAT
         , DONGIAVON
         , DONGIATHANHTOAN
         , SOQUYEN
         , SOHOADONVAT
         , TYLEVAT
         , GIATRIVAT
         , TYLECHIETKHAU
         , GIATRICHIETKHAU
         , MIENPHI
         , LYDOMIENPHI_ID
         , SOCHUNGTUKETOAN
         , SOCHUNGTUTIENMAT
         , TRANGTHAI
         , DAPHATSINHPHIEUXUAT
         , DAPHATSINHPHIEUHOANTRA
         , KHUYENMAI
         , PHUONGPHAPXUAT
         , DONDATHANG_ID
         , GHICHUCHITIET
         , NGUONHANG_ID
         , DONGIAVONVAT
         , THANHTIENMUA
         , THANHTIENVON
         , THANHTIENHOPDONG
         , ISTACHLO
         , DONVITINHBANDAU_ID
         , SOLUONGBANDAU
         , GOITHAU_ID
         , DONGIATHAU
         , DONGIAPO
         , TYLEQUIDOI
         , TOATHUOCNOITRU_ID
         , KHAMBENH_VTYT_ID
         , PHAUTHUAT_VTYT_ID
         , CLSKETQUA_VTYT_ID
         , TOATHUOCNGOAITRU_ID
         , CHUNGTUCHITIET_LIENQUAN_ID
         , MASTER_ID
         , BENHNHAN
         , YLENH
         , BENHVIEN_ID
         , NGAYTAO
         , NGUOITAO_ID         
         )       
         SELECT * FROM OPENJSON(@json)
         WITH (
         CHUNGTU_ID int
         , DUOC_ID int
         , SOLONHAP_ID int
         , SOKIEMSOAT varchar(20)
         , SOVISA varchar(20)
         , HANDUNG datetime
         , DONVITINH_ID int
         , SOLUONGYEUCAU numeric(25, 4)
         , SOLUONGTHUCTE numeric(25, 4)
         , SOLUONGDAXUAT numeric(25, 4)
         , TIENTE_ID nchar(3)
         , TYGIA numeric(25, 4)
         , DONGIAMUA numeric(25, 4)
         , DONGIA_BHYT numeric(25, 4)
         , DONGIABAN numeric(25, 4)
         , DONGIABAN_VAT numeric(25, 4)
         , DONGIAVON numeric(25, 4)
         , DONGIATHANHTOAN numeric(25, 4)
         , SOQUYEN varchar(20)
         , SOHOADONVAT varchar(20)
         , TYLEVAT  numeric(25, 4)
         , GIATRIVAT numeric(25, 4)
         , TYLECHIETKHAU numeric(25, 4)
         , GIATRICHIETKHAU numeric(25, 4)
         , MIENPHI char(1)
         , LYDOMIENPHI_ID int
         , SOCHUNGTUKETOAN varchar(20)
         , SOCHUNGTUTIENMAT varchar(20)
         , TRANGTHAI varchar(10)
         , DAPHATSINHPHIEUXUAT char(1)
         , DAPHATSINHPHIEUHOANTRA char(1)
         , KHUYENMAI char(1)
         , PHUONGPHAPXUAT int
         , DONDATHANG_ID int
         , GHICHUCHITIET nvarchar(255)
         , NGUONHANG_ID int
         , DONGIAVONVAT numeric(25, 4)
         , THANHTIENMUA numeric(25, 4)
         , THANHTIENVON numeric(25, 4)
         , THANHTIENHOPDONG numeric(25, 4)
         , ISTACHLO char(1)
         , DONVITINHBANDAU_ID int
         , SOLUONGBANDAU numeric(25, 4)
         , GOITHAU_ID int
         , DONGIATHAU numeric(25, 4)
         , DONGIAPO numeric(25, 4)
         , TYLEQUIDOI numeric(25, 4)
         , TOATHUOCNOITRU_ID int
         , KHAMBENH_VTYT_ID int
         , PHAUTHUAT_VTYT_ID int
         , CLSKETQUA_VTYT_ID int
         , TOATHUOCNGOAITRU_ID int
         , CHUNGTUCHITIET_LIENQUAN_ID int
         , MASTER_ID int
         , BENHNHAN nvarchar(1000)
         , YLENH nvarchar(MAX)
         , BENHVIEN_ID varchar(10)
         , NGAYTAO datetime
         , NGUOITAO_ID int       
         )
         
         IF('$MUCDICHCHUNGTU_CODE$' = 'X13')
         BEGIN
         <!--TT_NOITRU_TOATHUOC-->
         UPDATE TT_NOITRU_TOATHUOC SET CHUNGTU_ID = json.CHUNGTU_ID, TRANGTHAI = 'DAXUAT', NGAYCAPNHAT = getdate()
         FROM OPENJSON(@json)
         WITH (CHUNGTU_ID int, TOATHUOCNOITRU_ID int) json
         WHERE TT_NOITRU_TOATHUOC.TOATHUOC_ID = json.TOATHUOCNOITRU_ID and json.TOATHUOCNOITRU_ID is not NULL
     
         UPDATE TT_VIENPHI set DUYET = '1', DATHUCHIEN = '1', NGAYCAPNHAT = getdate()
         FROM OPENJSON(@json)
         WITH (TOATHUOCNOITRU_ID int) json
         WHERE TT_VIENPHI.REF_TABLE = 'TT_NOITRU_TOATHUOC' and TT_VIENPHI.REF_ID = json.TOATHUOCNOITRU_ID and json.TOATHUOCNOITRU_ID is not NULL
         
         <!--TT_NGOAITRU_KHAMBENH_VTYT-->
         UPDATE TT_NGOAITRU_KHAMBENH_VTYT SET CHUNGTU_ID = json.CHUNGTU_ID, TRANGTHAI = 'DAXUAT', NGAYCAPNHAT = getdate()
         FROM OPENJSON(@json)
         WITH (CHUNGTU_ID int, KHAMBENH_VTYT_ID int) json
         WHERE TT_NGOAITRU_KHAMBENH_VTYT.KHAMBENH_VTYT_ID = json.KHAMBENH_VTYT_ID and json.KHAMBENH_VTYT_ID is not NULL
     
         UPDATE TT_VIENPHI set DUYET = '1', DATHUCHIEN = '1', NGAYCAPNHAT = getdate()
         FROM OPENJSON(@json)
         WITH (KHAMBENH_VTYT_ID int) json
         WHERE TT_VIENPHI.REF_TABLE = 'TT_NGOAITRU_KHAMBENH_VTYT' and TT_VIENPHI.REF_ID = json.KHAMBENH_VTYT_ID and json.KHAMBENH_VTYT_ID is not NULL
         
          <!--TT_PHAUTHUAT_VTYT-->
         UPDATE TT_PHAUTHUAT_VTYT SET CHUNGTU_ID = json.CHUNGTU_ID
         FROM OPENJSON(@json)
         WITH (CHUNGTU_ID int, PHAUTHUAT_VTYT_ID int) json
         WHERE TT_PHAUTHUAT_VTYT.PHAUTHUAT_VTYT_ID = json.PHAUTHUAT_VTYT_ID and json.PHAUTHUAT_VTYT_ID is not NULL
     
         UPDATE TT_VIENPHI set DUYET = '1', DATHUCHIEN = '1', NGAYCAPNHAT = getdate()
         FROM OPENJSON(@json)
         WITH (PHAUTHUAT_VTYT_ID int) json
         WHERE TT_VIENPHI.REF_TABLE = 'TT_PHAUTHUAT_VTYT' and TT_VIENPHI.REF_ID = json.PHAUTHUAT_VTYT_ID and json.PHAUTHUAT_VTYT_ID is not NULL
      
         <!--TT_CLSKETQUA_VTYT-->
         UPDATE TT_CLSKETQUA_VTYT SET CHUNGTU_ID = json.CHUNGTU_ID, TRANGTHAI = 'DAXUAT', NGAYCAPNHAT = getdate()
         FROM OPENJSON(@json)
         WITH (CHUNGTU_ID int, CLSKETQUA_VTYT_ID int) json
         WHERE TT_CLSKETQUA_VTYT.CLSKETQUA_VTYT_ID = json.CLSKETQUA_VTYT_ID and json.CLSKETQUA_VTYT_ID is not NULL
     
         UPDATE TT_VIENPHI set DUYET = '1', DATHUCHIEN = '1', NGAYCAPNHAT = getdate()
         FROM OPENJSON(@json)
         WITH (CLSKETQUA_VTYT_ID int) json
         WHERE TT_VIENPHI.REF_TABLE = 'TT_CLSKETQUA_VTYT' and TT_VIENPHI.REF_ID = json.CLSKETQUA_VTYT_ID and json.CLSKETQUA_VTYT_ID is not NULL
         
         END      
       </statement>
      <!--Revision:0-->
        <update id="DAO00030_CHUNGTUCT_Update" parameterClass="System.Collections.IDictionary">
          update TT_DUOC_CHUNGTU_CHITIET set
          CHUNGTU_ID = #CHUNGTU_ID#
          , DUOC_ID = #DUOC_ID#
          , SOLONHAP_ID = #SOLONHAP_ID#
          , SOKIEMSOAT = #SOKIEMSOAT#
          , SOVISA = #SOVISA#
          , HANDUNG = #HANDUNG#
          , DONVITINH_ID = #DONVITINH_ID#
          , SOLUONGYEUCAU = #SOLUONGYEUCAU#
          , SOLUONGTHUCTE = #SOLUONGTHUCTE#
          , SOLUONGDAXUAT = #SOLUONGDAXUAT#
          , TIENTE_ID = #TIENTE_ID#
          , TYGIA = #TYGIA#
          , DONGIAMUA = #DONGIAMUA#
          , DONGIA_BHYT = #DONGIA_BHYT#
          , DONGIABAN = #DONGIABAN#
          , DONGIABAN_VAT = #DONGIABAN_VAT#
          , DONGIAVON = #DONGIAVON#
          , DONGIATHANHTOAN = #DONGIATHANHTOAN#
          , SOQUYEN = #SOQUYEN#
          , SOHOADONVAT = #SOHOADONVAT#
          , TYLEVAT = #TYLEVAT#
          , GIATRIVAT = #GIATRIVAT#
          , MIENPHI = #MIENPHI#
          , LYDOMIENPHI_ID = #LYDOMIENPHI_ID#
          , SOCHUNGTUKETOAN = #SOCHUNGTUKETOAN#
          , SOCHUNGTUTIENMAT = #SOCHUNGTUTIENMAT#
          , TRANGTHAI = #TRANGTHAI#
          , DAPHATSINHPHIEUXUAT = #DAPHATSINHPHIEUXUAT#
          , DAPHATSINHPHIEUHOANTRA = #DAPHATSINHPHIEUHOANTRA#
          , KHUYENMAI = #KHUYENMAI#
          , PHUONGPHAPXUAT = #PHUONGPHAPXUAT#
          , DONDATHANG_ID = #DONDATHANG_ID#
          , GHICHUCHITIET = #GHICHUCHITIET#
          , NGUONHANG_ID = #NGUONHANG_ID#
          , DONGIAVONVAT = #DONGIAVONVAT#
          , THANHTIENMUA = #THANHTIENMUA#
          , THANHTIENVON = #THANHTIENVON#
          , THANHTIENHOPDONG = #THANHTIENHOPDONG#
          , ISTACHLO = #ISTACHLO#
          , DONVITINHBANDAU_ID = #DONVITINHBANDAU_ID#
          , SOLUONGBANDAU = #SOLUONGBANDAU#
          , GOITHAU_ID = #GOITHAU_ID#
          , DONGIATHAU = #DONGIATHAU#
          , DONGIAPO = #DONGIAPO#
          , TYLEQUIDOI = #TYLEQUIDOI#
          , TOATHUOCNOITRU_ID = #TOATHUOCNOITRU_ID#
          , KHAMBENH_VTYT_ID = #KHAMBENH_VTYT_ID#
          , PHAUTHUAT_VTYT_ID = #PHAUTHUAT_VTYT_ID#
          , CLSKETQUA_VTYT_ID = #CLSKETQUA_VTYT_ID#
          , BENHNHAN = #BENHNHAN#
          , YLENH = #YLENH#
          , NGAYCAPNHAT = #NGAYCAPNHAT#
          , NGUOICAPNHAT_ID = #NGUOICAPNHAT_ID#
          where
          CHUNGTUCHITIET_ID = '$CHUNGTUCHITIET_ID$'
        </update>
        <!--Revision:0-->
        <statement id="DAO00030_CHUNGTUCT_Delete" parameterClass="System.Collections.IDictionary" resultClass="System.Int32">
            delete from TT_DUOC_CHUNGTU_CHITIET
            where
            CHUNGTUCHITIET_ID = '$CHUNGTUCHITIET_ID$'
        </statement>
        <!--Revision:0-->
        <statement id="DAO00030_CHUNGTUCT_DeleteP" parameterClass="System.Collections.IDictionary" resultClass="System.Int32">
            delete from TT_DUOC_CHUNGTU_CHITIET
            <dynamic prepend="where">
                <isParameterPresent>
                    <isNotEmpty prepend="and" property="CHUNGTUCHITIET_ID">
                        TT_DUOC_CHUNGTU_CHITIET.CHUNGTUCHITIET_ID = '$CHUNGTUCHITIET_ID$'
                    </isNotEmpty>
                    <isNotEmpty prepend="and" property="CHUNGTU_ID">
                        TT_DUOC_CHUNGTU_CHITIET.CHUNGTU_ID = '$CHUNGTU_ID$'
                    </isNotEmpty>               
                </isParameterPresent>
            </dynamic>
        </statement>
        <!--Revision:0-->
        <update id="DAO00030_Update_PhieuXuatNoiBo" parameterClass="System.Collections.IDictionary">
            update
            TT_DUOC_CHUNGTU
            set DANHANTHUOC = '$DANHANTHUOC$'
            where
            MACHUNGTU = '$MACHUNGTU$'
        </update>
        <!--Revision:0-->
        <statement id="DAO00030_GetPhieuTaiQuay" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
            select
            CT.*,
            NM.TENNGUOIMUA TENBENHNHAN2, NM.GIOITINH GIOITINH2, NM.NGAYSINH AS NGAYTHANGNAMSINH2, NM.NAMSINH AS NAMSINH2, NM.SONHA SONHA2, NM.XAPHUONG_ID XAPHUONG_ID2, NM.SODIENTHOAI SODIENTHOAI2, NM.NGHENGHIEP_ID NGHENGHIEP_ID2,
            BN.TENBENHNHAN as TENBENHNHAN1, BN.GIOITINH, BN.NGAYSINH AS NGAYTHANGNAMSINH, BN.NAMSINH, BN.SONHA, BN.XAPHUONG_ID, BN.SODIENTHOAI, BN.NGHENGHIEP_ID
            FROM TT_DUOC_CHUNGTU CT
            left join TT_NGOAITRU_TOATHUOC_NGUOIMUA NM on NM.NGOAITRU_TOATHUOC_NGUOIMUA_ID = CT.NGOAITRU_TOATHUOC_NGUOIMUA_ID
            left join TT_BENHNHAN BN on BN.BENHNHAN_ID = CT.BENHNHAN_ID
            where CT.BENHVIEN_ID = '$BENHVIEN_ID$'
            <isParameterPresent>
                <isNotEmpty prepend="and" property="CHUNGTU_ID">
                    CT.CHUNGTU_ID = '$CHUNGTU_ID$'
                </isNotEmpty>
            </isParameterPresent>
        </statement>
        <!--Revision:0-->
        <statement id="DAO00030_CTSOLONHAP_GetAll" resultClass="DataObject">
            select *
            from TT_DUOC_CHUNGTU_SOLONHAP
            WHERE BENHVIEN_ID = '$BENHVIEN_ID$'
            order by SOLONHAP_ID
        </statement>
        <statement id="DAO00030_GetList_Duoc_TonKho_NCC" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
          select a.*, isnull(b.SoLuong,0) as SOLUONG
          from
          (
          select TM_LOAIDUOC.MALOAIDUOC, TM_DUOC.*, TM_TENDUOC.TENDUOC, TM_TENDUOC.TENDUOC_EN, TM_TENDUOC.TENDUOC_RU, TM_TENDUOC.MAQUOCTE, TM_TENDUOC.MAQUOCTEBT,
          TM_LOAIDUOC.LOAIVATTU_ID,TM_LOAIVATTU.TENLOAIVATTU
          from TM_DUOC
          left join TM_TENDUOC on TM_DUOC.TENDUOC_ID = TM_TENDUOC.TENDUOC_ID and TM_TENDUOC.BENHVIEN_ID = '$BENHVIEN_ID$'
          left join TM_LOAIDUOC on TM_LOAIDUOC.LOAIDUOC_ID = TM_DUOC.LOAIDUOC_ID and TM_LOAIDUOC.BENHVIEN_ID = '$BENHVIEN_ID$'
          left join TM_LOAIVATTU on TM_LOAIDUOC.LOAIVATTU_ID=TM_LOAIVATTU.LOAIVATTU_ID and TM_LOAIVATTU.BENHVIEN_ID = '$BENHVIEN_ID$'
          where
          TM_DUOC.BENHVIEN_ID = '$BENHVIEN_ID$'
          and TM_DUOC.TAMNGUNG = '0'
          <isNotEmpty prepend="and" property="KHOQUANLY_ID">
            TM_DUOC.KHOQUANLY_ID = $KHOQUANLY_ID$
          </isNotEmpty>
          <isNotEmpty prepend="and" property="LOAIVATTU_ID">
            TM_LOAIVATTU.LOAIVATTU_ID = '$LOAIVATTU_ID$'
          </isNotEmpty>
          )a
          left join
          (
          select Duoc_ID, KhoDuoc_ID, sum(soluong) as SoLuong from tt_duoc_tonkho
          where KHODUOC_ID= #KHODUOC_ID#
          group by DUOC_ID, KHODUOC_ID
          )b on a.DUOC_ID = b.duoc_ID
        </statement>    
        <!--Revision:0-->
        <statement id="DAO00030_CTSOLONHAP_GetList" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
            select *
            from TT_DUOC_CHUNGTU_SOLONHAP
            <dynamic prepend="where">
                <isParameterPresent>
                    <isNotEmpty prepend="and" property="SOLONHAP_ID">
                        TT_DUOC_CHUNGTU_SOLONHAP.SOLONHAP_ID = '$SOLONHAP_ID$'
                    </isNotEmpty>
                    <isNotEmpty prepend="and" property="SOLONHAP">
                        TT_DUOC_CHUNGTU_SOLONHAP.SOLONHAP = '$SOLONHAP$'
                    </isNotEmpty>
                    <isNotEmpty prepend="and" property="DUOC_ID">
                        TT_DUOC_CHUNGTU_SOLONHAP.DUOC_ID = '$DUOC_ID$'
                    </isNotEmpty>                   
                </isParameterPresent>
            </dynamic>
            order by SOLONHAP_ID
        </statement>
        <!--Revision:0-->
        <statement id="DAO00030_CTSOLONHAP_GetDetail" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
            select *
            from TT_DUOC_CHUNGTU_SOLONHAP
            where SOLONHAP_ID  = '$value$'
            and BENHVIEN_ID = '$BENHVIEN_ID$'
            order by SOLONHAP_ID
        </statement>
        <!--Revision:0-->
        <statement id="DAO00030_CTSOLONHAP_GetDetailP" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
            select *
            from TT_DUOC_CHUNGTU_SOLONHAP
            where TT_DUOC_CHUNGTU_SOLONHAP.SOLONHAP_ID  = '$SOLONHAP_ID$'
            and BENHVIEN_ID = '$BENHVIEN_ID$'
            order by SOLONHAP_ID
        </statement>
        <!--Revision:0-->
        <statement id="DAO00030_CTSOLONHAP_Add" parameterClass="HashTable" resultClass="System.Int64">
            insert into TT_DUOC_CHUNGTU_SOLONHAP (
            SOLONHAP
            ,SOLOSANPHAM
            , DUOC_ID
            , NGAYNHAP
            , HANDUNG
            , NGUONDUOC_ID
            , DONGIAMUA
            , DONGIAVON
            , TIENTE_ID
            , TYGIA
            , THANG
            , NAM
            , SOKIEMSOAT
            , SOVISA            
            , DONGIATHAU
            , BENHVIEN_ID
            , NGAYTAO
            , NGUOITAO_ID
            , NGAYCAPNHAT
            , NGUOICAPNHAT_ID
            ) values (
            #SOLONHAP#
            , #SOLOSANPHAM#
            , #DUOC_ID#
            , #NGAYNHAP#
            , #HANDUNG#
            , #NGUONDUOC_ID#
            , #DONGIAMUA#
            , #DONGIAVON#
            , #TIENTE_ID#
            , #TYGIA#
            , #THANG#
            , #NAM#
            , #SOKIEMSOAT#
            , #SOVISA#            
            , #DONGIATHAU#
            , #BENHVIEN_ID#
            , #NGAYTAO#
            , #NGUOITAO_ID#
            , #NGAYCAPNHAT#
            , #NGUOICAPNHAT_ID#
            )
            select SCOPE_identity() as value
        </statement>
        <!--Revision:0-->
        <update id="DAO00030_CTSOLONHAP_Update" parameterClass="System.Collections.IDictionary">
            update TT_DUOC_CHUNGTU_SOLONHAP set
            SOLONHAP = #SOLONHAP#
            , SOLOSANPHAM = #SOLOSANPHAM#
            , DUOC_ID = #DUOC_ID#
            , NGAYNHAP = #NGAYNHAP#
            , HANDUNG = #HANDUNG#
            , NGUONDUOC_ID = #NGUONDUOC_ID#
            , DONGIAMUA = #DONGIAMUA#
            , DONGIAVON = #DONGIAVON#
            , TIENTE_ID = #TIENTE_ID#
            , TYGIA = #TYGIA#
            , THANG = #THANG#
            , NAM = #NAM#
            , SOKIEMSOAT = #SOKIEMSOAT#
            , SOVISA = #SOVISA#            
            , DONGIATHAU = #DONGIATHAU#           
            , NGAYCAPNHAT = #NGAYCAPNHAT#
            , NGUOICAPNHAT_ID = #NGUOICAPNHAT_ID#
            where
            SOLONHAP_ID = '$SOLONHAP_ID$'
        </update>
        <statement id="DAO00030_KiemTraChungTuXuatDaNhapNoiBo" parameterClass="System.String" resultClass="DataObject">
          select TOP 1 CHUNGTU_ID
          from TT_DUOC_CHUNGTU
          where 
          SOCHUNGTUGOC = '$SOCHUNGTUGOC$'
          and MUCDICHCHUNGTU_CODE = 'N05'
          and BENHVIEN_ID = '$BENHVIEN_ID$'          
        </statement>
        <!--Revision:0-->
        <statement id="DAO00030_CTSOLONHAP_Delete" parameterClass="System.Collections.IDictionary" resultClass="System.Int32">
          delete from TT_DUOC_CHUNGTU_SOLONHAP
          where
          SOLONHAP_ID = '$SOLONHAP_ID$'
        </statement>
        <!--Revision:0-->
        <statement id="DAO00030_CTSOLONHAP_DeleteP" parameterClass="System.Collections.IDictionary" resultClass="System.Int32">
          delete from TT_DUOC_SOLONHAP_GIABAN
          where
          SOLONHAP_ID = #SOLONHAP_ID#

          delete from TT_DUOC_CHUNGTU_SOLONHAP
          where
          SOLONHAP_ID = #SOLONHAP_ID#
        </statement>      
        <!--Revision:0-->
        <statement id="DAO00030_DUOCTONKHO_GetAll" resultClass="DataObject">
            select *
            from TT_DUOC_TONKHO
            WHERE BENHVIEN_ID = '$BENHVIEN_ID$'
            order by DUOCTONKHO_ID
        </statement>
        <!--Revision:0-->
        <statement id="DAO00030_DUOCTONKHO_GetList" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
            select *
            from TT_DUOC_TONKHO
            <dynamic prepend="where">
                <isParameterPresent>
                    <isNotEmpty prepend="and" property="DUOCTONKHO_ID">
                        TT_DUOC_TONKHO.DUOCTONKHO_ID = '$DUOCTONKHO_ID$'
                    </isNotEmpty>
                    <isNotEmpty prepend="and" property="KHODUOC_ID">
                        TT_DUOC_TONKHO.KHODUOC_ID = '$KHODUOC_ID$'
                    </isNotEmpty>
                    <isNotEmpty prepend="and" property="DUOC_ID">
                        TT_DUOC_TONKHO.DUOC_ID = '$DUOC_ID$'
                    </isNotEmpty>
                    <isNotEmpty prepend="and" property="NGUONDUOC_ID">
                        TT_DUOC_TONKHO.NGUONDUOC_ID = '$NGUONDUOC_ID$'
                    </isNotEmpty>
                    <isNotEmpty prepend="and" property="SOLONHAP_ID">
                        TT_DUOC_TONKHO.SOLONHAP_ID = '$SOLONHAP_ID$'
                    </isNotEmpty>                  
                </isParameterPresent>
            </dynamic>
            order by DUOCTONKHO_ID
        </statement>
        <!--Revision:0-->
        <statement id="DAO00030_DUOCTONKHO_GetDetail" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
            select *
            from TT_DUOC_TONKHO
            where DUOCTONKHO_ID  = '$value$'
            and BENHVIEN_ID = '$BENHVIEN_ID$'
            order by DUOCTONKHO_ID
        </statement>
        <!--Revision:0-->
        <statement id="DAO00030_DUOCTONKHO_GetDetailP" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
            select *
            from TT_DUOC_TONKHO
            where TT_DUOC_TONKHO.DUOCTONKHO_ID  = '$DUOCTONKHO_ID$'
            and BENHVIEN_ID = '$BENHVIEN_ID$'
            order by DUOCTONKHO_ID
        </statement>
        <!--Revision:0-->
        <statement id="DAO00030_DUOCTONKHO_Add" parameterClass="HashTable" resultClass="System.Int64">
            insert into TT_DUOC_TONKHO (
            KHODUOC_ID
            , DUOC_ID
            , NGUONDUOC_ID
            , SOLONHAP_ID
            , DONGIAMUA
            , SOLUONG
            , BENHVIEN_ID
            , NGAYTAO
            , NGUOITAO_ID
            , NGAYCAPNHAT
            , NGUOICAPNHAT_ID
            ) values (
            #KHODUOC_ID#
            , #DUOC_ID#
            , #NGUONDUOC_ID#
            , #SOLONHAP_ID#
            , #DONGIAMUA#
            , #SOLUONG#
            , #BENHVIEN_ID#
            , #NGAYTAO#
            , #NGUOITAO_ID#
            , #NGAYCAPNHAT#
            , #NGUOICAPNHAT_ID#
            )
        </statement>
        <!--Revision:0-->
        <update id="DAO00030_DUOCTONKHO_Update" parameterClass="System.Collections.IDictionary">
            update TT_DUOC_TONKHO set
            KHODUOC_ID = #KHODUOC_ID#
            , DUOC_ID = #DUOC_ID#
            , NGUONDUOC_ID = #NGUONDUOC_ID#
            , SOLONHAP_ID = #SOLONHAP_ID#
            , DONGIAMUA = #DONGIAMUA#
            , SOLUONG = #SOLUONG#
            , NGAYCAPNHAT = #NGAYCAPNHAT#
            , NGUOICAPNHAT_ID = #NGUOICAPNHAT_ID#
            where
            DUOCTONKHO_ID = '$DUOCTONKHO_ID$'
        </update>
        <!--Revision:0-->
        <update id="DAO00030_DUOCTONKHO_Tang" parameterClass="System.Collections.IDictionary">
          IF EXISTS
          (
            SELECT DUOCTONKHO_ID
            FROM TT_DUOC_TONKHO
            WHERE
            KHODUOC_ID = #KHODUOC_ID#
            AND DUOC_ID = #DUOC_ID#
            AND  SOLONHAP_ID = #SOLONHAP_ID#
          )
          BEGIN
            update TT_DUOC_TONKHO set
            SOLUONG = SOLUONG +  #SOLUONGTHAYDOI#
            , NGAYCAPNHAT = #NGAYCAPNHAT#
            , NGUOICAPNHAT_ID = #NGUOICAPNHAT_ID#
            where
            KHODUOC_ID = #KHODUOC_ID#
            AND DUOC_ID = #DUOC_ID#
            AND  SOLONHAP_ID = #SOLONHAP_ID#
          END
          ELSE
          BEGIN
            insert into TT_DUOC_TONKHO (
            KHODUOC_ID
            , DUOC_ID
            , NGUONDUOC_ID
            , SOLONHAP_ID
            , DONGIAMUA
            , SOLUONG
            , BENHVIEN_ID
            , NGAYTAO
            , NGUOITAO_ID       
            ) values (
            #KHODUOC_ID#
            , #DUOC_ID#
            , #NGUONDUOC_ID#
            , #SOLONHAP_ID#
            , #DONGIAMUA#
            , #SOLUONGTHAYDOI#
            , #BENHVIEN_ID#
            , #NGAYTAO#
            , #NGUOITAO_ID#         
            )
          END
        </update>
        <!--Revision:0-->
        <update id="DAO00030_DUOCTONKHO_Giam" parameterClass="System.Collections.IDictionary">
          update TT_DUOC_TONKHO set
          SOLUONG = SOLUONG - #SOLUONGTHAYDOI#
          , NGAYCAPNHAT =  getdate()
          , NGUOICAPNHAT_ID = #NGUOICAPNHAT_ID#
          where
          KHODUOC_ID = #KHODUOC_ID#
          and DUOC_ID = #DUOC_ID#
          and SOLONHAP_ID = #SOLONHAP_ID#
        </update>
        <!--Revision:0-->
        <update id="DAO00030_DUOC_TONKHO_BOOKING_NOITRU_Giam" parameterClass="System.Collections.IDictionary">         
          update TT_DUOC_TONKHO_BOOK_NOITRU
          set
          SOLUONG = 0
          , NGUOICAPNHAT_ID =  #NGUOICAPNHAT_ID#
          , NGAYCAPNHAT = getdate()
          where
          REF_TABLE = '$REF_TABLE$'
          AND REF_ID = '$REF_ID$'                    
          AND BENHVIEN_ID = '$BENHVIEN_ID$'          
        </update>
        <update id="DAO00030_DUOC_TONKHO_BOOKING_NGOAITRU_Giam" parameterClass="System.Collections.IDictionary">
          update TT_DUOC_TONKHO_BOOK_NGOAITRU
          set
          SOLUONG = 0         
          ,NGAYCAPNHAT = getdate()
          where
          REF_TABLE = '$REF_TABLE$'
          AND REF_ID = '$REF_ID$'    
          AND BENHVIEN_ID = '$BENHVIEN_ID$'
        </update>
        <update id="DAO00030_DUOC_TONKHO_BOOKING_NOITRU_Giam_All" parameterClass="System.Collections.IDictionary">
          UPDATE TT_DUOC_TONKHO_BOOK_NOITRU
          set
          SOLUONG = 0
          , NGUOICAPNHAT_ID =  #NGUOICAPNHAT_ID#
          , NGAYCAPNHAT = getdate()
          where
          REF_TABLE = '$REF_TABLE$'
          AND REF_ID in ($YLENH$)
          AND BENHVIEN_ID = '$BENHVIEN_ID$'

          DELETE FROM TT_DUOC_TONKHO_BOOK_NOITRU WHERE SOLUONG = 0 and NGAYHIEULUC  &lt; DATEADD(DAY, -7, getdate())
        </update>      
        <!--Revision:0-->
        <update id="DAO00030_DUOC_TONKHO_BOOKING_NOITRU_Insert" parameterClass="System.Collections.IDictionary">
          delete TT_DUOC_TONKHO_BOOK_NOITRU where REF_TABLE =  #REF_TABLE# and REF_ID = #REF_ID# and SOLUONG = 0

          insert into TT_DUOC_TONKHO_BOOK_NOITRU (
          REF_TABLE
          , REF_ID
          , PHAMVI_ID
          , KHODUOC_ID
          , DUOC_ID
          , SOLUONG
          , NGAYHIEULUC
          , NGUONHANG_ID
          , CHUYENKHOA_ID
          , TRANGTHAI
          , BENHVIEN_ID
          , NGAYTAO
          , NGUOITAO_ID
          ) values (
          #REF_TABLE#
          , #REF_ID#
          , #PHAMVI_ID#
          , #KHODUOC_ID#
          , #DUOC_ID#
          , #SOLUONGTHAYDOI#
          , getdate()
          , #NGUONHANG_ID#
          , #CHUYENKHOA_ID#
          , 'HIEULUC'
          , #BENHVIEN_ID#
          , #NGAYTAO#
          , #NGUOITAO_ID#
          )
        </update>
        <update id="DAO00030_Update_Booking_ToaThuoc" parameterClass="System.Collections.IDictionary">
          update TT_DUOC_TONKHO_BOOK_NOITRU
          set
          SOLUONG = #SOLUONG#          
          where
          REF_TABLE = '$REF_TABLE$'
          and REF_ID = #REF_ID#          
        </update>
        <update id="DAO00030_DUOC_TONKHO_BOOKING_NOITRU_Tang" parameterClass="System.Collections.IDictionary">          
          update TT_DUOC_TONKHO_BOOK_NOITRU
          set
          SOLUONG = SOLUONG + #SOLUONGTHAYDOI# 
          , NGUOICAPNHAT_ID =  #NGUOICAPNHAT_ID#
          , NGAYHIEULUC = getdate()
          , NGAYCAPNHAT = getdate()
          where
          REF_TABLE = '$REF_TABLE$'
          AND REF_ID = #REF_ID#
          AND KHODUOC_ID = #KHODUOC_ID#
          AND DUOC_ID = #DUOC_ID#
          AND SOLUONG = 0
          AND BENHVIEN_ID = #BENHVIEN_ID#
        </update>
        <update id="DAO00030_DUOC_TONKHO_BOOKING_NGOAITRU_Tang" parameterClass="System.Collections.IDictionary">
          update TT_DUOC_TONKHO_BOOK_NGOAITRU
          set
          SOLUONG = SOLUONG + #SOLUONGTHAYDOI#
          , NGUOICAPNHAT_ID = #NGUOICAPNHAT_ID#
          , NGAYCAPNHAT = getdate()
          where
          REF_TABLE = #REF_TABLE#
          AND REF_ID = #REF_ID#         
        </update>
        <!--Revision:0-->
        <update id="DAO00030_DUOC_TONKHO_BOOKING_NOITRU_Update" parameterClass="System.Collections.IDictionary">
          update TT_DUOC_TONKHO_BOOK_NOITRU
          set
          TRANGTHAI =  #TRANGTHAI#,
          GHICHU =  #GHICHU#,
          NGAYCAPNHAT = getdate(),
          NGUOICAPNHAT_ID = #NGUOICAPNHAT_ID#
          where
          BOOKING_ID = #BOOKING_ID#
        </update>
        <!--Revision:0-->
        <update id="DAO00030_DUOC_TONKHO_BOOKING_NGOAITRU_Update" parameterClass="System.Collections.IDictionary">
          update TT_DUOC_TONKHO_BOOK_NGOAITRU
          set
          TRANGTHAI =  #TRANGTHAI#,
          GHICHU =  #GHICHU#,
          NGAYCAPNHAT = getdate(),
          NGUOICAPNHAT_ID = #NGUOICAPNHAT_ID#
          where
          BOOKING_ID = #BOOKING_ID#
        </update>
        <!--Revision:0-->
        <statement id="DAO00030_DUOC_TONKHO_BOOKING_NOITRU_Delete" parameterClass="System.Collections.IDictionary" resultClass="System.Int32">
            delete from TT_DUOC_TONKHO_BOOK_NOITRU
            where
            BOOKING_ID = #BOOKING_ID#
        </statement>
        <!--Revision:0-->       
      
        <statement id="DAO00030_DUOC_TONKHO_BOOKING_Release_All" parameterClass="System.String" resultClass="System.Int32">
          MERGE TT_DUOC_TONKHO_BOOK_NOITRU AS X USING
          (
          select distinct zz.REF_ID,zz.REF_TABLE,zz.BENHVIEN_ID from (
          select AA.CHUNGTU_ID AS REF_ID, 'TT_DUOC_PHIEULINH' AS REF_TABLE,AA.BENHVIEN_ID
          from TT_DUOC_PHIEULINH AA
          INNER JOIN TT_DUOC_TONKHO_BOOK_NOITRU BB ON AA.CHUNGTU_ID=BB.REF_ID AND BB.REF_TABLE='TT_DUOC_PHIEULINH' AND BB.TRANGTHAI = 'HIEULUC' AND BB.SOLUONG>0
          where AA.DANHANTHUOC=1 AND AA.BENHVIEN_ID='$BENHVIEN_ID$'
          UNION ALL
          SELECT AA.TOATHUOC_ID AS REF_ID,'TT_NOITRU_TOATHUOC' AS REF_TABLE,AA.BENHVIEN_ID
          FROM TT_NOITRU_TOATHUOC AA
          INNER JOIN TT_DUOC_TONKHO_BOOK_NOITRU BB ON AA.TOATHUOC_ID=BB.REF_ID AND BB.REF_TABLE='TT_NOITRU_TOATHUOC' AND BB.TRANGTHAI = 'HIEULUC' AND BB.SOLUONG>0
          WHERE (AA.HUYTOATHUOC='1' OR AA.TRANGTHAI='DAXUAT') AND AA.BENHVIEN_ID='$BENHVIEN_ID$'
          UNION ALL
          SELECT AA.TOATHUOC_ID AS REF_ID,'TT_NOITRU_TOATHUOC' AS REF_TABLE,AA.BENHVIEN_ID
          FROM TT_NOITRU_TOATHUOC AA
          INNER JOIN TT_NOITRU_TRATHUOC_CHITIET CT on AA.TOATHUOC_ID=CT.TOATHUOC_ID
          INNER JOIN TT_DUOC_TONKHO_BOOK_NOITRU BB ON AA.TOATHUOC_ID=BB.REF_ID AND BB.REF_TABLE='TT_NOITRU_TOATHUOC' AND BB.TRANGTHAI = 'HIEULUC' AND BB.SOLUONG>0
          WHERE AA.PHIEULINH_ID IS NOT NULL AND AA.BENHVIEN_ID='$BENHVIEN_ID$'
          ) zz) AS Y
          ON (X.REF_ID =Y.REF_ID AND X.REF_TABLE=Y.REF_TABLE AND X.BENHVIEN_ID=Y.BENHVIEN_ID)
          WHEN MATCHED THEN UPDATE SET X.SOLUONG=0;

          MERGE TT_DUOC_TONKHO_BOOK_NGOAITRU AS X USING
          (
          select distinct zz.REF_ID,zz.REF_TABLE,zz.BENHVIEN_ID from (
          select AA.TOATHUOC_ID AS REF_ID, 'TT_NGOAITRU_TOATHUOC' AS REF_TABLE,AA.BENHVIEN_ID
          from TT_NGOAITRU_KHAMBENH_TOATHUOC KBTT
          INNER JOIN TT_NGOAITRU_TOATHUOC AA  on AA.KHAMBENH_TOATHUOC_ID = KBTT.KHAMBENH_TOATHUOC_ID
          INNER JOIN TT_DUOC_TONKHO_BOOK_NGOAITRU BB ON AA.TOATHUOC_ID=BB.REF_ID AND BB.REF_TABLE='TT_NGOAITRU_TOATHUOC' AND BB.TRANGTHAI = 'HIEULUC' AND BB.SOLUONG>0
          where (KBTT.HUYTOATHUOC='1' OR KBTT.TRANGTHAI='DAXUAT' ) AND AA.BENHVIEN_ID='$BENHVIEN_ID$'
          UNION ALL
          SELECT AA.KHAMBENH_VTYT_ID AS REF_ID,'TT_NGOAITRU_KHAMBENH_VTYT' AS REF_TABLE,AA.BENHVIEN_ID
          FROM TT_NGOAITRU_KHAMBENH_VTYT AA
          INNER JOIN TT_DUOC_TONKHO_BOOK_NGOAITRU BB ON AA.KHAMBENH_VTYT_ID=BB.REF_ID AND BB.REF_TABLE='TT_NGOAITRU_KHAMBENH_VTYT' AND BB.TRANGTHAI = 'HIEULUC' AND BB.SOLUONG>0
          WHERE AA.TRANGTHAI='DAXUAT' AND AA.BENHVIEN_ID='$BENHVIEN_ID$'
          ) zz) AS Y
          ON (X.REF_ID =Y.REF_ID AND X.REF_TABLE=Y.REF_TABLE AND X.BENHVIEN_ID=Y.BENHVIEN_ID)
          WHEN MATCHED THEN UPDATE SET X.SOLUONG=0;

          declare @SoNgayXoaBookingNgoaiTru int
          select @SoNgayXoaBookingNgoaiTru = isnull(VALUE, 0) from TM_SYS_APPSETTINGS where CODE = 'PHA_DEL_BOOK_NGOAITRU_QUANGAY'
          IF(@SoNgayXoaBookingNgoaiTru != 0)
          BEGIN
            update TT_DUOC_TONKHO_BOOK_NGOAITRU set soluong = 0
            WHERE
            convert(date,NGAYTAO) &lt;= DATEADD(DAY, - @SoNgayXoaBookingNgoaiTru, convert(date,getdate()))
          and REF_TABLE = 'TT_NGOAITRU_TOATHUOC'
          and soluong>0 and trangthai='HIEULUC'
          END

          DELETE FROM TT_DUOC_TONKHO_BOOK_NGOAITRU WHERE NGAYHIEULUC  &lt; DATEADD(DAY, -30, getdate()) or NGAYCAPNHAT  &lt; DATEADD(DAY, -30, getdate())
          DELETE FROM TT_DUOC_TONKHO_BOOK_NOITRU WHERE NGAYHIEULUC  &lt; DATEADD(DAY, -10, getdate()) or NGAYCAPNHAT  &lt; DATEADD(DAY, -10, getdate())
          DELETE FROM TT_DUOC_TONKHO_BOOK_NOITRU WHERE REF_TABLE = 'TT_NOITRU_TOATHUOC' AND REF_ID NOT IN (SELECT TOATHUOC_ID FROM TT_NOITRU_TOATHUOC)
          DELETE FROM TT_DUOC_TONKHO_BOOK_NOITRU WHERE REF_TABLE = 'TT_DUOC_PHIEULINH' AND REF_ID NOT IN (SELECT CHUNGTU_ID FROM TT_DUOC_PHIEULINH)
        </statement>

        <statement id="DAO00030_DUOC_TONKHO_BOOKING_Tang_All" parameterClass="System.String" resultClass="System.Int32">
          declare @json nvarchar(max) = #JSON_DATA#;

          UPDATE TT_DUOC_TONKHO_BOOK_NOITRU
          SET
          SOLUONG = SOLUONG + json.SOLUONGTHAYDOI
          ,NGAYCAPNHAT = getdate()
          ,NGAYHIEULUC = getdate()
          FROM OPENJSON(@json)
          WITH (
          REF_TABLE varchar(50),
          REF_ID int,
          SOLUONGTHAYDOI numeric(25, 4)
          )json
          WHERE TT_DUOC_TONKHO_BOOK_NOITRU.REF_TABLE = json.REF_TABLE AND TT_DUOC_TONKHO_BOOK_NOITRU.REF_ID = json.REF_ID and TT_DUOC_TONKHO_BOOK_NOITRU.SOLUONG = 0


          UPDATE TT_DUOC_TONKHO_BOOK_NGOAITRU
          SET
          SOLUONG = SOLUONG + json.SOLUONGTHAYDOI
          ,NGAYCAPNHAT = getdate()
          ,NGAYHIEULUC = getdate()
          FROM OPENJSON(@json)
          WITH (
          REF_TABLE varchar(50),
          REF_ID int,
          SOLUONGTHAYDOI numeric(25, 4)
          )json
          WHERE TT_DUOC_TONKHO_BOOK_NGOAITRU.REF_TABLE = json.REF_TABLE AND TT_DUOC_TONKHO_BOOK_NGOAITRU.REF_ID = json.REF_ID and TT_DUOC_TONKHO_BOOK_NGOAITRU.SOLUONG = 0
        </statement>
      
       <statement id="DAO00030_DUOCTONKHO_Delete" parameterClass="System.Collections.IDictionary" resultClass="System.Int32">
            delete from TT_DUOC_TONKHO
            where
            DUOCTONKHO_ID = '$DUOCTONKHO_ID$'
        </statement>
        <!--Revision:0-->
        <statement id="DAO00030_DUOCTONKHO_DeleteP" parameterClass="System.Collections.IDictionary" resultClass="System.Int32">
            delete from TT_DUOC_TONKHO
            <dynamic prepend="where">
                <isParameterPresent>
                    <isNotEmpty prepend="and" property="DUOCTONKHO_ID">
                        TT_DUOC_TONKHO.DUOCTONKHO_ID = '$DUOCTONKHO_ID$'
                    </isNotEmpty>
                    <isNotEmpty prepend="and" property="KHODUOC_ID">
                        TT_DUOC_TONKHO.KHODUOC_ID = '$KHODUOC_ID$'
                    </isNotEmpty>
                    <isNotEmpty prepend="and" property="DUOC_ID">
                        TT_DUOC_TONKHO.DUOC_ID = '$DUOC_ID$'
                    </isNotEmpty>
                    <isNotEmpty prepend="and" property="NGUONDUOC_ID">
                        TT_DUOC_TONKHO.NGUONDUOC_ID = '$NGUONDUOC_ID$'
                    </isNotEmpty>
                    <isNotEmpty prepend="and" property="SOLONHAP_ID">
                        TT_DUOC_TONKHO.SOLONHAP_ID = '$SOLONHAP_ID$'
                    </isNotEmpty>                    
                </isParameterPresent>
            </dynamic>
        </statement>
        <!--Revision:0-->
        <statement id="DAO00030_DUOCTONKHO_GetTonTruBooking" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
            SELECT A.SOLUONGTON - B.SOLUONGBOOKING_NGOAITRU - C.SOLUONGBOOKING_NOITRU AS SOLUONG
            FROM(
            SELECT
            SUM(SOLUONG) AS SOLUONGTON FROM TT_DUOC_TONKHO
            WHERE
            DUOC_ID = '$DUOC_ID$'
            AND KHODUOC_ID = '$KHODUOC_ID$'
            and BENHVIEN_ID = '$BENHVIEN_ID$'
            <isNotEmpty prepend="and" property="NGUONDUOC_ID">
                NGUONDUOC_ID = '$NGUONDUOC_ID$'
            </isNotEmpty>
            )A,
            (
            SELECT
            ISNULL(SUM(SOLUONG),0) AS SOLUONGBOOKING_NGOAITRU FROM TT_DUOC_TONKHO_BOOK_NGOAITRU
            WHERE
            DUOC_ID = '$DUOC_ID$'
            AND KHODUOC_ID = '$KHODUOC_ID$'
            and BENHVIEN_ID = '$BENHVIEN_ID$'
            <isNotEmpty prepend="and" property="NGUONDUOC_ID">
                NGUONHANG_ID = '$NGUONDUOC_ID$'
            </isNotEmpty>
            ) B,
            (
            SELECT
            ISNULL(SUM(SOLUONG),0) AS SOLUONGBOOKING_NOITRU FROM TT_DUOC_TONKHO_BOOK_NOITRU
            WHERE
            DUOC_ID = '$DUOC_ID$'
            AND KHODUOC_ID = '$KHODUOC_ID$'
            and BENHVIEN_ID = '$BENHVIEN_ID$'
            <isNotEmpty prepend="and" property="NGUONDUOC_ID">
                NGUONHANG_ID = '$NGUONDUOC_ID$'
            </isNotEmpty>
            ) C
        </statement>
        <!--Revision:0-->
        <statement id="DAO00030_DUOCTONKHO_GetTonThucTeTheoLo" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
            SELECT
            SUM(SOLUONG) AS SOLUONG
            FROM
            TT_DUOC_TONKHO
            WHERE
            DUOC_ID = '$DUOC_ID$'
            AND KHODUOC_ID = '$KHODUOC_ID$'
            and BENHVIEN_ID = '$BENHVIEN_ID$'
            <isNotEmpty prepend="and" property="NGUONDUOC_ID">
                NGUONDUOC_ID = '$NGUONDUOC_ID$'
            </isNotEmpty>
            <isNotEmpty prepend="and" property="SOLONHAP_ID">
                SOLONHAP_ID = '$SOLONHAP_ID$'
            </isNotEmpty>
        </statement>
        <!--Revision:0-->
        <statement id="DAO00030_DUOCTONKHO_GetTonThucTe" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
            SELECT
            SUM(SOLUONG) AS SOLUONG
            FROM
            TT_DUOC_TONKHO
            WHERE
            DUOC_ID = '$DUOC_ID$'
            AND KHODUOC_ID = '$KHODUOC_ID$'
            and BENHVIEN_ID = '$BENHVIEN_ID$'
            <isNotEmpty prepend="and" property="NGUONDUOC_ID">
                <!-- NGUONDUOC_ID = '$NGUONDUOC_ID$' -->
            </isNotEmpty>
        </statement>
        <!--Revision:0-->
        <statement id="DAO00030_DUOCTONKHO_GetSoTonTheoDuoc" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
            SELECT
            DUOC_ID,
            SUM(SOLUONG) AS TONGTON
            FROM
            TT_DUOC_TONKHO
            WHERE
            KHODUOC_ID = '$KHODUOC_ID$'
            and BENHVIEN_ID = '$BENHVIEN_ID$'
            and DUOC_ID IN ($LIST_DUOC_ID$)
            GROUP BY DUOC_ID
        </statement>
        <!--Revision:0-->
        <statement id="DAO00030_DUOCTONKHO_GetSoTonTheoDuocTruBooking" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
            SELECT A.DUOC_ID,  ISNULL(A.SOLUONGTON,0) - ISNULL(B.SOLUONGBOOKING_NGOAITRU,0) - ISNULL(C.SOLUONGBOOKING_NOITRU,0) AS TONGTON
            FROM(
            SELECT DUOC_ID, KHODUOC_ID,
            SUM(SOLUONG) AS SOLUONGTON FROM TT_DUOC_TONKHO
            WHERE
            DUOC_ID IN ($LIST_DUOC_ID$)
            AND KHODUOC_ID = '$KHODUOC_ID$'
            AND BENHVIEN_ID = '$BENHVIEN_ID$'
            GROUP BY DUOC_ID, KHODUOC_ID
            )A LEFT JOIN
            (
            SELECT DUOC_ID, KHODUOC_ID,
            ISNULL(SUM(SOLUONG),0) AS SOLUONGBOOKING_NGOAITRU FROM TT_DUOC_TONKHO_BOOK_NGOAITRU
            WHERE
            DUOC_ID IN ($LIST_DUOC_ID$)
            AND KHODUOC_ID = '$KHODUOC_ID$'
            AND TRANGTHAI = 'HIEULUC'
            AND BENHVIEN_ID = '$BENHVIEN_ID$'
            GROUP BY DUOC_ID, KHODUOC_ID
            ) B on (A.DUOC_ID = B.DUOC_ID AND A.KHODUOC_ID = B.KHODUOC_ID)
            LEFT JOIN
            (
            SELECT DUOC_ID, KHODUOC_ID,
            ISNULL(SUM(SOLUONG),0) AS SOLUONGBOOKING_NOITRU FROM TT_DUOC_TONKHO_BOOK_NOITRU
            WHERE
            DUOC_ID IN ($LIST_DUOC_ID$)
            AND KHODUOC_ID = '$KHODUOC_ID$'
            AND TRANGTHAI = 'HIEULUC'
            AND BENHVIEN_ID = '$BENHVIEN_ID$'
            GROUP BY DUOC_ID, KHODUOC_ID
            ) C on (A.DUOC_ID = C.DUOC_ID AND A.KHODUOC_ID = C.KHODUOC_ID)
        </statement>
      <statement id="DAO00030_DUOCTONKHO_GetSoTonTheoDuocTruBookingPhamVi" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
        SELECT A.DUOC_ID,  ISNULL(A.SOLUONGTON,0) - ISNULL(B.SOLUONGBOOKING_NGOAITRU,0) - ISNULL(C.SOLUONGBOOKING_NOITRU,0) AS TONGTON
        FROM(
        SELECT DUOC_ID, KHODUOC_ID,
        SUM(SOLUONG) AS SOLUONGTON FROM TT_DUOC_TONKHO
        WHERE
        DUOC_ID IN ($LIST_DUOC_ID$)
        AND KHODUOC_ID = '$KHODUOC_ID$'
        AND BENHVIEN_ID = '$BENHVIEN_ID$'
        GROUP BY DUOC_ID, KHODUOC_ID
        )A LEFT JOIN
        (
        SELECT DUOC_ID, KHODUOC_ID,
        ISNULL(SUM(SOLUONG),0) AS SOLUONGBOOKING_NGOAITRU FROM TT_DUOC_TONKHO_BOOK_NGOAITRU
        WHERE
        DUOC_ID IN ($LIST_DUOC_ID$)
        AND PHAMVI_ID = $PHAMVI_ID$
        AND TRANGTHAI = 'HIEULUC'
        AND BENHVIEN_ID = '$BENHVIEN_ID$'
        GROUP BY DUOC_ID, KHODUOC_ID
        ) B on (A.DUOC_ID = B.DUOC_ID AND A.KHODUOC_ID = B.KHODUOC_ID)
        LEFT JOIN
        (
        SELECT DUOC_ID, KHODUOC_ID,
        ISNULL(SUM(SOLUONG),0) AS SOLUONGBOOKING_NOITRU FROM TT_DUOC_TONKHO_BOOK_NOITRU
        WHERE
        DUOC_ID IN ($LIST_DUOC_ID$)
        AND PHAMVI_ID = $PHAMVI_ID$
        AND TRANGTHAI = 'HIEULUC'
        AND BENHVIEN_ID = '$BENHVIEN_ID$'
        GROUP BY DUOC_ID, KHODUOC_ID
        ) C on (A.DUOC_ID = C.DUOC_ID)
      </statement>

      <statement id="DAO00030_DUOC_KiemTraTamNgung" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
        SELECT DUOC_ID,TAMNGUNG
        FROM
        TM_DUOC
        WHERE
        DUOC_ID IN ($LIST_DUOC_ID$)
      </statement>
      
        <!--Revision:0-->
        <statement id="DAO00030_DUOCTONKHO_GetSoTonTheoDuocTheoLo" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
            SELECT
            DUOC_ID,SOLONHAP_ID,
            SUM(SOLUONG) AS SOLUONGTONLO
            FROM
            TT_DUOC_TONKHO
            WHERE
            KHODUOC_ID = '$KHODUOC_ID$'
            and BENHVIEN_ID = '$BENHVIEN_ID$'
            and DUOC_ID IN ($LIST_DUOC_ID$)
            and SOLONHAP_ID IN ($LIST_SOLONHAP_ID$)
            GROUP BY DUOC_ID, SOLONHAP_ID
        </statement>
        <!--Revision:0-->
        <statement id="DAO00030_DUOCTONKHO_GetTonKhoBySoLoNhap" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
            SELECT A.DONGIAMUA, A.HANSUDUNG, A.SOKIEMSOAT, B.*
            FROM
            (
            SELECT
            DUOC_ID,
            DONGIAMUA,
            HANSUDUNG,
            SOKIEMSOAT
            FROM
            TT_DUOC_CHUNGTU_SOLONHAP
            WHERE
            SOLONHAP = '$SOLONHAP$'
            and BENHVIEN_ID = '$BENHVIEN_ID$'
            )A left join
            (
            SELECT
            KHODUOC_ID,
            DUOC_ID,
            SUM(SOLUONG) AS TONGTON
            FROM
            TT_DUOC_TONKHO
            WHERE
            DUOC_ID = '$DUOC_ID$'
            AND KHODUOC_ID = '$KHODUOC_ID$'
            and BENHVIEN_ID = '$BENHVIEN_ID$'
            GROUP BY KHODUOC_ID, DUOC_ID
            )B on  A.DUOC_ID = B.DUOC_ID
        </statement>
        <!--Revision:0-->
        <statement id="DAO00030_GET_SOLONHAP" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
          SELECT DISTINCT
          SLN.SOLONHAP_ID, SLN.SOLONHAP, SLN.SOLOSANPHAM, SLN.SOKIEMSOAT, SLN.SOVISA, CONVERT(varchar(20), SLN.SOLOSANPHAM) + '/' + CONVERT(varchar(20), TK.SOLUONG) AS SOLOSOTON,
          SLN.NGAYNHAP AS NGAYNHAPLO, SLN.HANDUNG AS HANSUDUNG,  SLN.HANDUNG, SLN.NGUONDUOC_ID, SLN.NGUONDUOC_ID as NGUONHANG_ID,
          SLNGB.DONGIAMUA, SLNGB.DONGIAVON, SLNGB.TYLEVAT_DAUVAO as TYLEVAT, d.TYLE_VAT, SLNGB.DONGIAVONVAT, SLNGB.DONGIABAN, SLNGB.DONGIABANVAT_DAUVAO as DONGIABAN_VAT,
          TK.DUOCTONKHO_ID, TK.KHODUOC_ID, TK.DUOC_ID, TK.SOLUONG, TK.SOLUONG AS SOLUONGTON,
          D.TENDUOCDAYDU,D.DONVITINH_ID, D.DONVITINH, D.BHYT, NH.TENNGUONDUOC AS NGUONHANG,
          LTRIM(TK.KHODUOC_ID) + '_' + LTRIM(TK.DUOC_ID) + '_' + LTRIM(TK.NGUONDUOC_ID) as DUOC_KEY, D.SO_QDTT
          FROM
          TT_DUOC_CHUNGTU_SOLONHAP SLN,
          TT_DUOC_TONKHO TK,
          TT_DUOC_SOLONHAP_GIABAN SLNGB,
          TM_DUOC D,
          TM_NGUONHANG NH
          WHERE
          SLN.SOLONHAP_ID = TK.SOLONHAP_ID
          AND SLN.SOLONHAP_ID = SLNGB.SOLONHAP_ID
          AND SLN.NGUONDUOC_ID = NH.NGUONDUOC_ID
          AND SLN.DUOC_ID = D.DUOC_ID
          AND TK.DUOC_ID = '$DUOC_ID$'
          AND TK.KHODUOC_ID = '$KHODUOC_ID$'
          AND SLN.BENHVIEN_ID = '$BENHVIEN_ID$'
          AND TK.SOLUONG &gt; 0
            <dynamic prepend="">
              <isParameterPresent>
                <isNotEmpty prepend="and" property="NGUONDUOC_ID">
                  SLN.NGUONDUOC_ID = '$NGUONDUOC_ID$'
                </isNotEmpty>
                <isNotEmpty prepend="and" property="LST_SOLONHAP_ID">
                  SLN.SOLONHAP_ID NOT IN ($LST_SOLONHAP_ID$)
                </isNotEmpty>
              </isParameterPresent>
            </dynamic>
            <isEqual prepend="" property="PHUONGPHAPXUAT" compareValue="0">
                ORDER BY NGAYNHAP
            </isEqual>
            <isEqual prepend="" property="PHUONGPHAPXUAT" compareValue="1">
                ORDER BY HANSUDUNG
            </isEqual>
        </statement>
        <!--Revision:0-->
        <statement id="DAO00030_GET_SOLONHAP_ZERO" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
          SELECT DISTINCT
          SLN.SOLONHAP_ID, SLN.SOLONHAP, SLN.SOLOSANPHAM, SLN.SOKIEMSOAT, SLN.SOVISA, CONVERT(varchar(20), SLN.SOLOSANPHAM) + '/' + CONVERT(varchar(20), TK.SOLUONG) AS SOLOSOTON,
          SLN.NGAYNHAP AS NGAYNHAPLO, SLN.HANDUNG AS HANSUDUNG,  SLN.HANDUNG, SLN.NGUONDUOC_ID, SLN.NGUONDUOC_ID as NGUONHANG_ID,
          SLNGB.DONGIAMUA, SLNGB.DONGIAVON, SLNGB.TYLEVAT_DAUVAO as TYLEVAT, d.TYLE_VAT, SLNGB.DONGIAVONVAT, SLNGB.DONGIABAN,          
          SLNGB.DONGIABANVAT_DAUVAO as DONGIABAN_VAT,
          TK.DUOCTONKHO_ID, TK.KHODUOC_ID, TK.DUOC_ID, TK.SOLUONG, TK.SOLUONG AS SOLUONGTON,
          D.TENDUOCDAYDU,D.DONVITINH_ID, D.DONVITINH, D.BHYT, NH.TENNGUONDUOC AS NGUONHANG,
          LTRIM(TK.KHODUOC_ID) + '_' + LTRIM(TK.DUOC_ID) + '_' + LTRIM(TK.NGUONDUOC_ID) as DUOC_KEY, D.SO_QDTT
          FROM
          TT_DUOC_CHUNGTU_SOLONHAP SLN,
          TT_DUOC_TONKHO TK,
          TT_DUOC_SOLONHAP_GIABAN SLNGB,
          TM_DUOC D,
          TM_NGUONHANG NH
          WHERE
          SLN.SOLONHAP_ID = TK.SOLONHAP_ID
          AND SLN.SOLONHAP_ID = SLNGB.SOLONHAP_ID
          AND SLN.NGUONDUOC_ID = NH.NGUONDUOC_ID
          AND SLN.DUOC_ID = D.DUOC_ID
          AND TK.KHODUOC_ID = '$KHODUOC_ID$'
          AND TK.DUOC_ID = '$DUOC_ID$'
          AND SLN.BENHVIEN_ID = '$BENHVIEN_ID$'
          <!--AND TK.SOLUONG &gt;= 0-->
            <dynamic prepend="">
              <isParameterPresent>
                <isNotEmpty prepend="and" property="NGUONDUOC_ID">
                  SLN.NGUONDUOC_ID = '$NGUONDUOC_ID$'
                </isNotEmpty>
                <isNotEmpty prepend="and" property="LST_SOLONHAP_ID">
                  SLN.SOLONHAP_ID NOT IN ($LST_SOLONHAP_ID$)
                </isNotEmpty>
              </isParameterPresent>
            </dynamic>
            <isEqual prepend="" property="PHUONGPHAPXUAT" compareValue="0">
                ORDER BY NGAYNHAP
            </isEqual>
            <isEqual prepend="" property="PHUONGPHAPXUAT" compareValue="1">
                ORDER BY HANSUDUNG
            </isEqual>
        </statement>
        <!--Revision:0-->
        <statement id="DAO00030_CHECK_BANGGIA_BHYT" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
          SELECT
          D.DUOC_ID
          FROM
          TM_DUOC D
          INNER JOIN TM_DUOC_DONGIA dg on dg.DUOC_ID = D.DUOC_ID
          INNER JOIN TM_LOAIGIA lg on (lg.LOAIGIA_ID = dg.LOAIGIA_ID AND lg.MALOAIGIA = 'GiaduocBHYT')
          WHERE
          dg.DUOC_ID = '$DUOC_ID$'
          AND d.BHYT = '1'
          AND dg.DONGIA is not null
          AND dg.BENHVIEN_ID = '$BENHVIEN_ID$'
        </statement>
      <statement id="DAO00030_CHECK_BANGGIA_NHATHUOC" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
        SELECT
        D.DUOC_ID
        FROM
        TM_DUOC D
        INNER JOIN TM_DUOC_DONGIA dg on dg.DUOC_ID = D.DUOC_ID
        INNER JOIN TM_LOAIGIA lg on (lg.LOAIGIA_ID = dg.LOAIGIA_ID AND lg.MALOAIGIA = 'Gianhathuoc')
        WHERE
        dg.DUOC_ID = '$DUOC_ID$'
        AND dg.DONGIA is not null
        AND dg.BENHVIEN_ID = '$BENHVIEN_ID$'
      </statement>
        <!--Revision:0-->
        <statement id="DAO00030_GET_SOLONHAP_DONGIABHYT" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
          SELECT DISTINCT
          SLN.SOLONHAP_ID, SLN.SOLONHAP, SLN.SOLOSANPHAM, SLN.SOKIEMSOAT, SLN.SOVISA, CONVERT(varchar(20), SLN.SOLOSANPHAM) + '/' + CONVERT(varchar(20), TK.SOLUONG) AS SOLOSOTON,
          SLN.NGAYNHAP AS NGAYNHAPLO, SLN.HANDUNG AS HANSUDUNG,  SLN.HANDUNG, SLN.NGUONDUOC_ID, SLN.NGUONDUOC_ID as NGUONHANG_ID,
          SLNGB.DONGIAMUA, SLNGB.DONGIAVON, SLNGB.DONGIAVONVAT, dg.DONGIA AS DONGIATHAU,
          TK.KHODUOC_ID,TK.DUOC_ID, TK.SOLUONG, TK.SOLUONG AS SOLUONGTON,
          D.TENDUOCDAYDU,D.DONVITINH_ID, D.DONVITINH, D.BHYT, NH.TENNGUONDUOC AS NGUONHANG,
          LTRIM(TK.KHODUOC_ID) + '_' + LTRIM(TK.DUOC_ID) + '_' + LTRIM(TK.NGUONDUOC_ID) as DUOC_KEY
          FROM
          TT_DUOC_CHUNGTU_SOLONHAP SLN
          <!--LEFT JOIN TT_DUOC_TONKHO TK on SLN.SOLONHAP_ID = TK.SOLONHAP_ID-->
          LEFT JOIN (
          select xx.DUOCTONKHO_ID, xx.KHODUOC_ID, xx.DUOC_ID, xx.SOLONHAP_ID, xx.SOLUONG, xx.NGUONDUOC_ID, xx.BENHVIEN_ID from TT_DUOC_TONKHO xx
          join ( select max(DUOCTONKHO_ID) as DUOCTONKHO_ID, KHODUOC_ID, DUOC_ID, SOLONHAP_ID, NGUONDUOC_ID
          from TT_DUOC_TONKHO group by KHODUOC_ID, DUOC_ID, SOLONHAP_ID, NGUONDUOC_ID) yy on xx.DUOCTONKHO_ID=yy.DUOCTONKHO_ID
          ) TK on SLN.SOLONHAP_ID = TK.SOLONHAP_ID
          LEFT JOIN TT_DUOC_SOLONHAP_GIABAN SLNGB on SLN.SOLONHAP_ID = SLNGB.SOLONHAP_ID
          LEFT JOIN TM_NGUONHANG NH on SLN.NGUONDUOC_ID = NH.NGUONDUOC_ID
          LEFT JOIN TM_DUOC D on SLN.DUOC_ID = D.DUOC_ID
          LEFT JOIN TM_DUOC_DONGIA dg on dg.DUOC_ID = SLN.DUOC_ID
          LEFT JOIN TM_BANGGIA bg on (bg.BANGGIA_ID = dg.BANGGIA_ID)
          LEFT JOIN TM_LOAIGIA lg on (lg.LOAIGIA_ID = dg.LOAIGIA_ID AND lg.MALOAIGIA = 'GiaduocBHYT')
          WHERE
          SLN.DUOC_ID = '$DUOC_ID$'
          AND TK.KHODUOC_ID = '$KHODUOC_ID$'
          AND SLN.BENHVIEN_ID = '$BENHVIEN_ID$'
          AND TK.SOLUONG &gt; 0
          <!--AND DG.DONGIA != 0-->
          <dynamic prepend="">
              <isParameterPresent>
                <isNotEmpty prepend="and" property="NGUONDUOC_ID">
                  SLN.NGUONDUOC_ID = '$NGUONDUOC_ID$'
                </isNotEmpty>
                <isNotEmpty prepend="and" property="LST_SOLONHAP_ID">
                  SLN.SOLONHAP_ID NOT IN ($LST_SOLONHAP_ID$)
                </isNotEmpty>
              </isParameterPresent>
            </dynamic>
            <isEqual prepend="" property="PHUONGPHAPXUAT" compareValue="0">
                ORDER BY NGAYNHAP
            </isEqual>
            <isEqual prepend="" property="PHUONGPHAPXUAT" compareValue="1">
                ORDER BY HANSUDUNG
            </isEqual>
        </statement>
        <!--Revision:0-->
        <statement id="DAO00030_GET_SOLONHAP_XUATSUDUNG" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
          SELECT DISTINCT
          SLN.SOLONHAP_ID, SLN.SOLONHAP, SLN.SOLOSANPHAM, SLN.SOKIEMSOAT, SLN.SOVISA, CONVERT(varchar(20), SLN.SOLOSANPHAM) + '/' + CONVERT(varchar(20), TK.SOLUONG) AS SOLOSOTON,
          SLN.NGAYNHAP AS NGAYNHAPLO, SLN.HANDUNG AS HANSUDUNG,  SLN.HANDUNG, SLN.NGUONDUOC_ID, SLN.NGUONDUOC_ID as NGUONHANG_ID,
          SLNGB.DONGIAMUA, SLNGB.DONGIAVON, SLNGB.TYLEVAT_DAUVAO as TYLEVAT, d.TYLE_VAT, SLNGB.DONGIAVONVAT, SLNGB.DONGIABANVAT_DAUVAO,
          dg.DONGIA AS DONGIATHAU, dg.DONGIA AS DONGIABAN, dg.DONGIA AS DONGIABAN_VAT,          
          TK.KHODUOC_ID,TK.DUOC_ID, TK.SOLUONG, TK.SOLUONG AS SOLUONGTON,
          D.TENDUOCDAYDU,D.DONVITINH_ID, D.DONVITINH, D.BHYT, NH.TENNGUONDUOC AS NGUONHANG,
          LTRIM(TK.KHODUOC_ID) + '_' + LTRIM(TK.DUOC_ID) + '_' + LTRIM(TK.NGUONDUOC_ID) as DUOC_KEY
          FROM
          TT_DUOC_CHUNGTU_SOLONHAP SLN
          INNER JOIN TT_DUOC_TONKHO TK on SLN.SOLONHAP_ID = TK.SOLONHAP_ID
          INNER JOIN TT_DUOC_SOLONHAP_GIABAN SLNGB on SLN.SOLONHAP_ID = SLNGB.SOLONHAP_ID
          INNER JOIN TM_NGUONHANG NH on SLN.NGUONDUOC_ID = NH.NGUONDUOC_ID
          INNER JOIN TM_DUOC D on SLN.DUOC_ID = D.DUOC_ID
          LEFT JOIN TM_DUOC_DONGIA dg on dg.DUOC_ID = SLN.DUOC_ID
          LEFT JOIN TM_LOAIGIA lg on (lg.LOAIGIA_ID = dg.LOAIGIA_ID AND lg.MALOAIGIA = 'GiaduocBHYT')
          WHERE
          TK.DUOC_ID = '$DUOC_ID$'
          AND TK.KHODUOC_ID = '$KHODUOC_ID$'
          AND TK.BENHVIEN_ID = '$BENHVIEN_ID$'
          AND TK.SOLUONG &gt; 0
            <dynamic prepend="">
              <isParameterPresent>
                <isNotEmpty prepend="and" property="NGUONDUOC_ID">
                  SLN.NGUONDUOC_ID = '$NGUONDUOC_ID$'
                </isNotEmpty>
                <isNotEmpty prepend="and" property="LST_SOLONHAP_ID">
                  SLN.SOLONHAP_ID NOT IN ($LST_SOLONHAP_ID$)
                </isNotEmpty>
              </isParameterPresent>
            </dynamic>
            <isEqual prepend="" property="PHUONGPHAPXUAT" compareValue="0">
                ORDER BY NGAYNHAP
            </isEqual>
            <isEqual prepend="" property="PHUONGPHAPXUAT" compareValue="1">
                ORDER BY HANSUDUNG
            </isEqual>
        </statement>
        <statement id="DAO00030_GET_SOLONHAP_BANGGIA" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
          SELECT DISTINCT
          SLN.SOLONHAP_ID, SLN.SOLONHAP, SLN.SOLOSANPHAM, SLN.SOKIEMSOAT, SLN.SOVISA, CONVERT(varchar(20), SLN.SOLOSANPHAM) + '/' + CONVERT(varchar(20), TK.SOLUONG) AS SOLOSOTON,
          SLN.NGAYNHAP AS NGAYNHAPLO, SLN.HANDUNG AS HANSUDUNG,  SLN.HANDUNG, SLN.NGUONDUOC_ID, SLN.NGUONDUOC_ID as NGUONHANG_ID,
          SLNGB.DONGIAMUA, SLNGB.DONGIAVON, SLNGB.TYLEVAT_DAUVAO as TYLEVAT, d.TYLE_VAT, SLNGB.DONGIAVONVAT,
          dg.DONGIA AS DONGIABAN, dg.DONGIA AS DONGIABAN_VAT,
          TK.KHODUOC_ID, TK.DUOC_ID, TK.SOLUONG, TK.SOLUONG AS SOLUONGTON,
          D.TENDUOCDAYDU,D.DONVITINH_ID, D.DONVITINH, D.BHYT, NH.TENNGUONDUOC AS NGUONHANG
          FROM
          TT_DUOC_CHUNGTU_SOLONHAP SLN
          INNER JOIN TT_DUOC_TONKHO TK on SLN.SOLONHAP_ID = TK.SOLONHAP_ID
          INNER JOIN TT_DUOC_SOLONHAP_GIABAN SLNGB on SLN.SOLONHAP_ID = SLNGB.SOLONHAP_ID
          INNER JOIN TM_NGUONHANG NH on SLN.NGUONDUOC_ID = NH.NGUONDUOC_ID
          INNER JOIN TM_DUOC D on SLN.DUOC_ID = D.DUOC_ID
          INNER JOIN TM_DUOC_DONGIA dg on dg.DUOC_ID = SLN.DUOC_ID
          INNER JOIN TM_LOAIGIA lg on (lg.LOAIGIA_ID = dg.LOAIGIA_ID AND lg.MALOAIGIA = 'Gianhathuoc')
          WHERE
          SLN.DUOC_ID = '$DUOC_ID$'
          AND TK.KHODUOC_ID = '$KHODUOC_ID$'
          AND SLN.BENHVIEN_ID = '$BENHVIEN_ID$'
          AND TK.SOLUONG &gt; 0
            <dynamic prepend="">
              <isParameterPresent>
                <isNotEmpty prepend="and" property="NGUONDUOC_ID">
                  SLN.NGUONDUOC_ID = '$NGUONDUOC_ID$'
                </isNotEmpty>
                <isNotEmpty prepend="and" property="LST_SOLONHAP_ID">
                  SLN.SOLONHAP_ID NOT IN ($LST_SOLONHAP_ID$)
                </isNotEmpty>
              </isParameterPresent>
            </dynamic>
            <isEqual prepend="" property="PHUONGPHAPXUAT" compareValue="0">
                ORDER BY NGAYNHAP
            </isEqual>
            <isEqual prepend="" property="PHUONGPHAPXUAT" compareValue="1">
                ORDER BY HANSUDUNG
            </isEqual>
        </statement>
        <!--Revision:0-->
        <update id="DAO00030_Update_TrangThaiToaThuoc" parameterClass="System.Collections.IDictionary">
          declare @CHUNGTUPHATTHUOC_ID int = #CHUNGTUPHATTHUOC_ID#

          IF EXISTS
          (
          SELECT CHUNGTU_ID
          FROM
          TT_DUOC_CHUNGTU
          WHERE
          CHUNGTU_ID = #CHUNGTUPHATTHUOC_ID# or @CHUNGTUPHATTHUOC_ID is NULL
          )
          BEGIN

          update
          TT_NGOAITRU_KHAMBENH_TOATHUOC
          set
          CHUNGTUPHATTHUOC_ID = #CHUNGTUPHATTHUOC_ID#,
          TRANGTHAI = #TRANGTHAI#,
          NGAYCAPNHAT = getdate()
          where
          KHAMBENH_TOATHUOC_ID = '$KHAMBENH_TOATHUOC_ID$'

          END
        </update>
        <update id="DAO00030_Update_TrangThaiToaThuocNoiTruRaVien" parameterClass="System.Collections.IDictionary">
          update
          TT_NOITRU_TOATHUOC
          set
          CHUNGTU_ID = #CHUNGTU_ID#,
          TRANGTHAI = #TRANGTHAI#,
          NGAYCAPNHAT = getdate()
          where
          TOATHUOC_ID IN ($LIST_TOATHUOC_ID$)
        </update>
        <!--Revision:0-->
        <statement id="DAO00030_GET_BOOKING_NOITRU" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
          SELECT
          BK.BOOKING_ID,
          BK.DUOC_ID,
          D.MADUOC,
          D.TENDUOCDAYDU,
          DVT.TENDONVITINH,
          'NOITRU' LOAITOA,
          BK.REF_TABLE,
          BK.REF_ID,
          BK.PHAMVI_ID,
          BK.SOLUONG,
          BK.NGUONHANG_ID,
          isnull(pb.TENPHONGBAN,'') + ' - ' + BN.MAYTE + ' - ' + BN.TENBENHNHAN
          + CASE WHEN BN.NGAYSINH IS NOT NULL THEN ' - ' + CONVERT(VARCHAR(10), BN.NGAYSINH, 103) ELSE ' - ' + CONVERT(VARCHAR(10), BN.NAMSINH) END
          + CASE WHEN dt.TENDOITUONG IS NOT NULL THEN N' - ' + dt.TENDOITUONG  ELSE '' END
          as BENHNHAN,
          CASE
          WHEN (KB.RAVIEN = '1' and KB.ISTHUOCBV = '1' ) THEN N'Toa thuốc ra viện BHYT: ' + CONVERT(VARCHAR(30), KB.THOIGIANKHAM, 103)
          WHEN (KB.RAVIEN = '1' and KB.ISTHUOCBV = '0' ) THEN N'Toa thuốc ra viện: ' + CONVERT(VARCHAR(30), KB.THOIGIANKHAM, 103)
          WHEN (KB.RAVIEN = '0' and KB.ISYLENHVTYT = '0' ) THEN N'Y lệnh thuốc: ' + CONVERT(VARCHAR(30), KB.THOIGIANKHAM, 103)
          WHEN (KB.RAVIEN = '0' and KB.ISYLENHVTYT = '1' ) THEN N'Y lệnh VTYT: ' + CONVERT(VARCHAR(30), KB.THOIGIANKHAM, 103)
          END  AS YLENH ,
          nl.TENNHANVIEN as NGUOILAP,
          BK.GHICHU,
          BK.TRANGTHAI,
          CASE
          WHEN BK.TRANGTHAI = 'HIEULUC' THEN N'Hiệu lực'
          ELSE N'Hủy'
          END  AS TENTRANGTHAI ,
          nh.TENNHANVIEN as NGUOIHUY,
          BK.NGAYCAPNHAT
          FROM
          TT_DUOC_TONKHO_BOOK_NOITRU BK
          inner join TT_NOITRU_TOATHUOC TT on (BK.REF_TABLE = 'TT_NOITRU_TOATHUOC' AND BK.REF_ID = TT.TOATHUOC_ID)
          left join TT_BENHNHAN BN on TT.BENHNHAN_ID = BN.BENHNHAN_ID
          left join TT_NOITRU_KHAMBENH KB on KB.KHAMBENH_ID = TT.KHAMBENH_ID
          left join TT_NOITRU_BENHAN BA on BA.BENHAN_ID = KB.BENHAN_ID
          left join TM_PHONGBAN pb on pb.PHONGBAN_ID = isnull(BA.KHOACHUYENDEN_ID, BA.KHOAVAO_ID)
          left join TT_TIEPNHAN TN on TN.TIEPNHAN_ID = BA.TIEPNHAN_ID
          left join TM_DOITUONG dt on DT.DOITUONG_ID = TN.DOITUONG_ID
          left join TM_DUOC d on d.DUOC_ID = BK.DUOC_ID
          left join TM_DONVITINH dvt on dvt.DONVITINH_ID = d.DONVITINH_ID
          left join TM_NHANVIEN nl on nl.NHANVIEN_ID = TT.NGUOITAO_ID
          left join TM_NHANVIEN nh on nh.NHANVIEN_ID = BK.NGUOICAPNHAT_ID
          WHERE BK.SOLUONG &gt; 0 
            <isParameterPresent>
                <isNotEmpty prepend="and" property="PHAMVI_ID">
                  BK.PHAMVI_ID = '$PHAMVI_ID$'
                </isNotEmpty>
                <isNotEmpty prepend="and" property="PHONGBAN_ID">
                    BK.CHUYENKHOA_ID = '$PHONGBAN_ID$'
                </isNotEmpty>
                <isNotEmpty prepend="and" property="TUNGAY">
                    CONVERT(date, BK.NGAYTAO) BETWEEN  CONVERT(date, '$TUNGAY$') and  CONVERT(date, '$DENNGAY$')
                </isNotEmpty>
                <isNotEmpty prepend="and" property="TUKHOA">
                  (BN.TENBENHNHAN LIKE N'%$TUKHOA$%' or BN.MAYTE LIKE N'%$TUKHOA$%' or d.TENDUOCDAYDU LIKE N'%$TUKHOA$%' or d.MADUOC LIKE N'%$TUKHOA$%')
                </isNotEmpty>
                <isNotEmpty prepend="and" property="BENHVIEN_ID">
                    BK.BENHVIEN_ID = '$BENHVIEN_ID$'
                </isNotEmpty>
            </isParameterPresent>
        </statement>
        <!--Revision:0-->
      <update id="DAO00030_DUOC_TONKHO_BOOKING_Clear" parameterClass="System.Collections.IDictionary">
        UPDATE
        TT_DUOC_TONKHO_BOOK_NGOAITRU
        SET
        SOLUONG = 0
        ,TRANGTHAI = 'HETHIEULUC'
        ,NGAYHIEULUC = NULL
        WHERE
        REF_TABLE = 'TT_NGOAITRU_TOATHUOC'
        and SOLUONG &gt; 0
        and GETDATE() > DATEADD(DAY, 7, NGAYTAO)
      </update>
        <statement id="DAO00030_GET_BOOKING_NGOAITRU_TOATHUOC" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
          SELECT
          BK.BOOKING_ID,
          BK.DUOC_ID,
          D.MADUOC,
          d.TENDUOCDAYDU,
          DVT.TENDONVITINH,
          'NGOAITRU' LOAITOA,
          BK.REF_TABLE,
          BK.REF_ID,
          BK.PHAMVI_ID,
          BK.SOLUONG,
          BK.NGUONHANG_ID,
          pb.TENPHONGBAN + ' - ' + BN.MAYTE + ' - ' + BN.TENBENHNHAN
          + CASE WHEN BN.NGAYSINH IS NOT NULL THEN ' - ' + CONVERT(VARCHAR(10), BN.NGAYSINH, 103) ELSE ' - ' + CONVERT(VARCHAR(10), BN.NAMSINH) END
          + CASE WHEN dt.TENDOITUONG IS NOT NULL THEN N' - ' + dt.TENDOITUONG  ELSE '' END
          as BENHNHAN,
          CASE
          WHEN (KBTT.LOAITOATHUOC = 'BV') THEN N'Toa ngoại trú BHYT: ' + CONVERT(VARCHAR(30), KB.THOIGIANKHAM, 103)
          WHEN (KBTT.LOAITOATHUOC = 'MN') THEN N'Toa mua ngoài: ' + CONVERT(VARCHAR(30), KB.THOIGIANKHAM, 103)
          WHEN (KBTT.LOAITOATHUOC = 'TV') THEN N'Toa tư vấn: ' + CONVERT(VARCHAR(30), KB.THOIGIANKHAM, 103)
          WHEN (KBTT.LOAITOATHUOC = 'MP') THEN N'Toa miễn phí: ' + CONVERT(VARCHAR(30), KB.THOIGIANKHAM, 103)
          END  AS YLENH ,
          nl.TENNHANVIEN as NGUOILAP,
          BK.GHICHU,
          BK.TRANGTHAI,
          CASE
          WHEN BK.TRANGTHAI = 'HIEULUC' THEN N'Hiệu lực'
          ELSE N'Hủy'
          END  AS TENTRANGTHAI ,
          nh.TENNHANVIEN as NGUOIHUY,
          BK.NGAYCAPNHAT
          FROM
          TT_DUOC_TONKHO_BOOK_NGOAITRU BK
          inner join TT_NGOAITRU_TOATHUOC TT on (BK.REF_TABLE = 'TT_NGOAITRU_TOATHUOC' AND BK.REF_ID = TT.TOATHUOC_ID)
          left join TT_NGOAITRU_KHAMBENH_TOATHUOC KBTT on KBTT.KHAMBENH_TOATHUOC_ID = TT.KHAMBENH_TOATHUOC_ID
          left join TT_NGOAITRU_KHAMBENH KB on KB.KHAMBENH_ID = KBTT.KHAMBENH_ID
          left join TT_BENHNHAN BN on kb.BENHNHAN_ID = BN.BENHNHAN_ID
          left join TM_PHONGBAN pb on KB.PHONGBAN_ID = pb.PHONGBAN_ID
          left join TM_DOITUONG dt on KB.DOITUONG_ID = dt.DOITUONG_ID
          left join TM_DUOC d on d.DUOC_ID = BK.DUOC_ID
          left join TM_DONVITINH dvt on dvt.DONVITINH_ID = d.DONVITINH_ID
          left join TM_NHANVIEN nl on nl.NHANVIEN_ID = TT.NGUOITAO_ID
          left join TM_NHANVIEN nh on nh.NHANVIEN_ID = BK.NGUOICAPNHAT_ID
          WHERE BK.SOLUONG &gt; 0
            <isParameterPresent>
                <isNotEmpty prepend="and" property="PHAMVI_ID">
                  BK.PHAMVI_ID = '$PHAMVI_ID$'
                </isNotEmpty>
                <isNotEmpty prepend="and" property="PHONGBAN_ID">
                    KB.PHONGBAN_ID = '$PHONGBAN_ID$'
                </isNotEmpty>
                <isNotEmpty prepend="and" property="TUNGAY">
                    CONVERT(date, BK.NGAYTAO) BETWEEN  CONVERT(date, '$TUNGAY$') and  CONVERT(date, '$DENNGAY$')
                </isNotEmpty>
                <isNotEmpty prepend="and" property="TUKHOA">
                  (BN.TENBENHNHAN LIKE N'%$TUKHOA$%' or BN.MAYTE LIKE N'%$TUKHOA$%' or d.TENDUOCDAYDU LIKE N'%$TUKHOA$%' or d.MADUOC LIKE N'%$TUKHOA$%')
                </isNotEmpty>
                <isNotEmpty prepend="and" property="BENHVIEN_ID">
                    BK.BENHVIEN_ID = '$BENHVIEN_ID$'
                </isNotEmpty>
            </isParameterPresent>
        </statement>
        <!--Revision:0-->
        <statement id="DAO00030_GET_BOOKING_NGOAITRU_VTYT" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
            UPDATE
            TT_DUOC_TONKHO_BOOK_NGOAITRU
            SET
            SOLUONG = 0
            ,TRANGTHAI = 'HETHIEULUC'
            ,NGAYHIEULUC = NULL
            WHERE
            REF_TABLE = 'TT_NGOAITRU_KHAMBENH_VTYT'
            and SOLUONG &gt; 0
            and CONVERT(date, getdate()) &gt;  CONVERT(date, NGAYTAO)
          SELECT
          BK.BOOKING_ID,
          BK.DUOC_ID,
          d.MADUOC,
          d.TENDUOCDAYDU,
          DVT.TENDONVITINH,
          'NGOAITRU' LOAITOA,
          BK.REF_TABLE,
          BK.REF_ID,
          BK.PHAMVI_ID,
          BK.SOLUONG,
          BK.NGUONHANG_ID,
          pb.TENPHONGBAN + ' - ' + BN.MAYTE + ' - ' + BN.TENBENHNHAN
          + CASE WHEN BN.NGAYSINH IS NOT NULL THEN ' - ' + CONVERT(VARCHAR(10), BN.NGAYSINH, 103) ELSE ' - ' + CONVERT(VARCHAR(10), BN.NAMSINH) END
          + CASE WHEN dt.TENDOITUONG IS NOT NULL THEN N' - ' + dt.TENDOITUONG  ELSE '' END
          as BENHNHAN,
          N'Khám bệnh VTYT: ' + CONVERT(VARCHAR(30), VT.THOIGIANSUDUNG, 103) AS YLENH,
          nl.TENNHANVIEN as NGUOILAP,
          BK.GHICHU,
          BK.TRANGTHAI,
          CASE
          WHEN BK.TRANGTHAI = 'HIEULUC' THEN N'Hiệu lực'
          ELSE N'Hủy'
          END  AS TENTRANGTHAI ,
          nh.TENNHANVIEN as NGUOIHUY,
          bk.NGAYCAPNHAT
          FROM
          TT_DUOC_TONKHO_BOOK_NGOAITRU BK
          inner join TT_NGOAITRU_KHAMBENH_VTYT VT on (BK.REF_TABLE = 'TT_NGOAITRU_KHAMBENH_VTYT' AND BK.REF_ID = VT.KHAMBENH_VTYT_ID)
          inner join TT_DVYEUCAU DV on DV.DVYEUCAU_ID = VT.DVYEUCAU_ID
          left join TT_BENHNHAN BN on DV.BENHNHAN_ID = BN.BENHNHAN_ID
          left join TM_PHONGBAN pb on VT.PHONGBAN_ID = pb.PHONGBAN_ID
          left join TM_DOITUONG dt on DV.DOITUONG_ID = dt.DOITUONG_ID
          left join TM_DUOC d on d.DUOC_ID = BK.DUOC_ID
          left join TM_DONVITINH dvt on dvt.DONVITINH_ID = d.DONVITINH_ID
          left join TM_NHANVIEN nl on nl.NHANVIEN_ID = VT.NGUOITAO_ID
          left join TM_NHANVIEN nh on nh.NHANVIEN_ID = BK.NGUOICAPNHAT_ID
          WHERE BK.SOLUONG &gt; 0
            <isParameterPresent>
                <isNotEmpty prepend="and" property="PHAMVI_ID">
                  BK.PHAMVI_ID = '$PHAMVI_ID$'
                </isNotEmpty>
                <isNotEmpty prepend="and" property="PHONGBAN_ID">
                    VT.PHONGBAN_ID = '$PHONGBAN_ID$'
                </isNotEmpty>
                <isNotEmpty prepend="and" property="TUNGAY">
                    CONVERT(date, BK.NGAYTAO) BETWEEN  CONVERT(date, '$TUNGAY$') and  CONVERT(date, '$DENNGAY$')
                </isNotEmpty>
                <isNotEmpty prepend="and" property="TUKHOA">
                  (BN.TENBENHNHAN LIKE N'%$TUKHOA$%' or BN.MAYTE LIKE N'%$TUKHOA$%' or d.TENDUOCDAYDU LIKE N'%$TUKHOA$%' or d.MADUOC LIKE N'%$TUKHOA$%')
                </isNotEmpty>
                <isNotEmpty prepend="and" property="BENHVIEN_ID">
                    BK.BENHVIEN_ID = '$BENHVIEN_ID$'
                </isNotEmpty>
            </isParameterPresent>
        </statement>
        <!--Revision:0-->
        <statement id="DAO00030_GET_BOOKING_NGOAITRU_PTTT_VTYT" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
          SELECT
          BK.BOOKING_ID,
          BK.DUOC_ID,
          d.MADUOC,
          d.TENDUOCDAYDU,
          DVT.TENDONVITINH,
          'NGOAITRU' LOAITOA,
          BK.REF_TABLE,
          BK.REF_ID,
          BK.PHAMVI_ID,
          BK.SOLUONG,
          BK.NGUONHANG_ID,
          pb.TENPHONGBAN + ' - ' + BN.MAYTE + ' - ' + BN.TENBENHNHAN
          + CASE WHEN BN.NGAYSINH IS NOT NULL THEN ' - ' + CONVERT(VARCHAR(10), BN.NGAYSINH, 103) ELSE ' - ' + CONVERT(VARCHAR(10), BN.NAMSINH) END
          + CASE WHEN dt.TENDOITUONG IS NOT NULL THEN N' - ' + dt.TENDOITUONG  ELSE '' END
          as BENHNHAN,
          CASE
          WHEN PT.LOAI = 'P' THEN N'Phẫu thuật VTYT: ' + CONVERT(VARCHAR(30), VT.NGAYSUDUNG, 103)
          ELSE N'Thủ thuật VTYT: ' + CONVERT(VARCHAR(30), VT.NGAYSUDUNG, 103)
          END  AS YLENH,
          nl.TENNHANVIEN as NGUOILAP,
          BK.GHICHU,
          BK.TRANGTHAI,
          CASE
          WHEN BK.TRANGTHAI = 'HIEULUC' THEN N'Hiệu lực'
          ELSE N'Hủy'
          END  AS TENTRANGTHAI ,
          nh.TENNHANVIEN as NGUOIHUY,
          bk.NGAYCAPNHAT
          FROM
          TT_DUOC_TONKHO_BOOK_NGOAITRU BK
          inner join TT_PHAUTHUAT_VTYT VT on (BK.REF_TABLE = 'TT_PHAUTHUAT_VTYT' AND BK.REF_ID = VT.PHAUTHUAT_VTYT_ID)
          inner join TT_PHAUTHUAT PT on PT.PHAUTHUAT_ID = VT.PHAUTHUAT_ID
          left join TT_TIEPNHAN TN on TN.TIEPNHAN_ID = PT.TIEPNHAN_ID
          left join TT_BENHNHAN BN on TN.BENHNHAN_ID = BN.BENHNHAN_ID
          left join TM_PHONGBAN pb on PT.PHONGBANTHUCHIEN_ID = pb.PHONGBAN_ID
          left join TM_DOITUONG dt on TN.DOITUONG_ID = dt.DOITUONG_ID
          left join TM_DUOC d on d.DUOC_ID = BK.DUOC_ID
          left join TM_DONVITINH dvt on dvt.DONVITINH_ID = d.DONVITINH_ID
          left join TM_NHANVIEN nl on nl.NHANVIEN_ID = VT.NGUOITAO_ID
          left join TM_NHANVIEN nh on nh.NHANVIEN_ID = BK.NGUOICAPNHAT_ID
          WHERE BK.SOLUONG &gt; 0
            <isParameterPresent>
                <isNotEmpty prepend="and" property="PHAMVI_ID">
                  BK.PHAMVI_ID = '$PHAMVI_ID$'
                </isNotEmpty>
                <isNotEmpty prepend="and" property="PHONGBAN_ID">
                    PT.PHONGBANTHUCHIEN_ID = '$PHONGBAN_ID$'
                </isNotEmpty>
                <isNotEmpty prepend="and" property="TUNGAY">
                    CONVERT(date, BK.NGAYTAO) BETWEEN  CONVERT(date, '$TUNGAY$') and  CONVERT(date, '$DENNGAY$')
                </isNotEmpty>
                <isNotEmpty prepend="and" property="TUKHOA">
                    (BN.TENBENHNHAN LIKE N'%$TUKHOA$%' or BN.MAYTE LIKE N'%$TUKHOA$%' or d.TENDUOCDAYDU LIKE N'%$TUKHOA$%' or d.MADUOC LIKE N'%$TUKHOA$%')
                </isNotEmpty>
                <isNotEmpty prepend="and" property="BENHVIEN_ID">
                    BK.BENHVIEN_ID = '$BENHVIEN_ID$'
                </isNotEmpty>
            </isParameterPresent>
        </statement>
        <!--Revision:0-->
        <statement id="DAO00030_GET_BOOKING_CLS_VTYT" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
          SELECT
          BK.BOOKING_ID,
          BK.DUOC_ID,
          d.MADUOC,
          d.TENDUOCDAYDU,
          DVT.TENDONVITINH,
          'NGOAITRU' LOAITOA,
          BK.REF_TABLE,
          BK.REF_ID,
          BK.PHAMVI_ID,
          BK.SOLUONG,
          BK.NGUONHANG_ID,
          pb.TENPHONGBAN + ' - ' + BN.MAYTE + ' - ' + BN.TENBENHNHAN
          + CASE WHEN BN.NGAYSINH IS NOT NULL THEN ' - ' + CONVERT(VARCHAR(10), BN.NGAYSINH, 103) ELSE ' - ' + CONVERT(VARCHAR(10), BN.NAMSINH) END
          + CASE WHEN dt.TENDOITUONG IS NOT NULL THEN N' - ' + dt.TENDOITUONG  ELSE '' END
          as BENHNHAN,
          N'CLS VTYT: ' + CONVERT(VARCHAR(30), VT.NGAYSUDUNG, 103) AS YLENH,
          nl.TENNHANVIEN as NGUOILAP,
          BK.GHICHU,
          BK.TRANGTHAI,
          CASE
          WHEN BK.TRANGTHAI = 'HIEULUC' THEN N'Hiệu lực'
          ELSE N'Hủy'
          END  AS TENTRANGTHAI ,
          nh.TENNHANVIEN as NGUOIHUY,
          bk.NGAYCAPNHAT
          FROM
          TT_DUOC_TONKHO_BOOK_NGOAITRU BK
          inner join TT_CLSKETQUA_VTYT VT on (BK.REF_TABLE = 'TT_CLSKETQUA_VTYT' AND BK.REF_ID = VT.CLSKETQUA_VTYT_ID)
          left join TT_DVYEUCAU DV on DV.DVYEUCAU_ID = VT.DVYEUCAU_ID
          left join TT_TIEPNHAN TN on TN.TIEPNHAN_ID = DV.TIEPNHAN_ID
          left join TT_BENHNHAN BN on TN.BENHNHAN_ID = BN.BENHNHAN_ID
          left join TM_PHONGBAN pb on VT.PHONGBAN_ID = pb.PHONGBAN_ID
          left join TM_DOITUONG dt on TN.DOITUONG_ID = dt.DOITUONG_ID
          left join TM_DUOC d on d.DUOC_ID = BK.DUOC_ID
          left join TM_DONVITINH dvt on dvt.DONVITINH_ID = d.DONVITINH_ID
          left join TM_NHANVIEN nl on nl.NHANVIEN_ID = VT.NGUOITAO_ID
          left join TM_NHANVIEN nh on nh.NHANVIEN_ID = BK.NGUOICAPNHAT_ID
          WHERE BK.SOLUONG &gt; 0
            <isParameterPresent>
                <isNotEmpty prepend="and" property="PHAMVI_ID">
                  BK.PHAMVI_ID = '$PHAMVI_ID$'
                </isNotEmpty>
                <isNotEmpty prepend="and" property="PHONGBAN_ID">
                    VT.PHONGBAN_ID = '$PHONGBAN_ID$'
                </isNotEmpty>
                <isNotEmpty prepend="and" property="TUNGAY">
                    CONVERT(date, BK.NGAYTAO) BETWEEN  CONVERT(date, '$TUNGAY$') and  CONVERT(date, '$DENNGAY$')
                </isNotEmpty>
                <isNotEmpty prepend="and" property="TUKHOA">
                  (BN.TENBENHNHAN LIKE N'%$TUKHOA$%' or BN.MAYTE LIKE N'%$TUKHOA$%' or d.TENDUOCDAYDU LIKE N'%$TUKHOA$%' or d.MADUOC LIKE N'%$TUKHOA$%')
                </isNotEmpty>
                <isNotEmpty prepend="and" property="BENHVIEN_ID">
                    BK.BENHVIEN_ID = '$BENHVIEN_ID$'
                </isNotEmpty>
            </isParameterPresent>
        </statement>
        <!--Revision:0-->
        <statement id="DAO00030_GET_BOOKING_PHIEULINH" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
          SELECT
          BK.BOOKING_ID,
          BK.DUOC_ID,
          d.MADUOC,
          d.TENDUOCDAYDU,
          DVT.TENDONVITINH,
          'NOITRU' LOAITOA,
          BK.REF_TABLE,
          BK.REF_ID,
          BK.PHAMVI_ID,
          BK.SOLUONG,
          BK.NGUONHANG_ID,
          pb.TENPHONGBAN as BENHNHAN,
          N'Mã phiếu lĩnh: ' + PL.MACHUNGTU + ' - ' + CONVERT(VARCHAR(30), PL.NGAYCHUNGTU, 103) + ' ' + CONVERT(VARCHAR(30), PL.NGAYCHUNGTU, 108) AS YLENH,
          nl.TENNHANVIEN as NGUOILAP,
          BK.TRANGTHAI,
          BK.GHICHU,
          CASE
          WHEN BK.TRANGTHAI = 'HIEULUC' THEN N'Hiệu lực'
          ELSE N'Hủy'
          END  AS TENTRANGTHAI ,
          nh.TENNHANVIEN as NGUOIHUY,
          BK.NGAYCAPNHAT
          FROM
          TT_DUOC_TONKHO_BOOK_NOITRU BK
          inner join TT_DUOC_PHIEULINH PL on (BK.REF_TABLE = 'TT_DUOC_PHIEULINH' AND BK.REF_ID = PL.CHUNGTU_ID)
          left join TM_PHONGBAN pb on pb.PHONGBAN_ID = BK.CHUYENKHOA_ID
          left join TM_DUOC d on d.DUOC_ID = BK.DUOC_ID
          left join TM_DONVITINH dvt on dvt.DONVITINH_ID = d.DONVITINH_ID
          left join TM_NHANVIEN nl on nl.NHANVIEN_ID = PL.NGUOITAO_ID
          left join TM_NHANVIEN nh on nh.NHANVIEN_ID = BK.NGUOICAPNHAT_ID
          WHERE BK.SOLUONG &gt; 0
            <isParameterPresent>
                <isNotEmpty prepend="and" property="PHAMVI_ID">
                  BK.PHAMVI_ID = '$PHAMVI_ID$'
                </isNotEmpty>
                <isNotEmpty prepend="and" property="PHONGBAN_ID">
                    BK.CHUYENKHOA_ID = '$PHONGBAN_ID$'
                </isNotEmpty>
                <isNotEmpty prepend="and" property="TUNGAY">
                    CONVERT(date, BK.NGAYTAO) BETWEEN  CONVERT(date, '$TUNGAY$') and  CONVERT(date, '$DENNGAY$')
                </isNotEmpty>
                <isNotEmpty prepend="and" property="TUKHOA">
                  (PL.MACHUNGTU LIKE N'%$TUKHOA$%' or d.TENDUOCDAYDU LIKE N'%$TUKHOA$%' or d.MADUOC LIKE N'%$TUKHOA$%')
                </isNotEmpty>
                <isNotEmpty prepend="and" property="BENHVIEN_ID">
                    BK.BENHVIEN_ID = '$BENHVIEN_ID$'
                </isNotEmpty>
            </isParameterPresent>
        </statement>
      <statement id="DAO00030_DUOC_TONKHO_UpdateTheoTheKho" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
        UPDATE  DTK1
        SET
        DTK1.SOLUONG = DTK2.SoLuong
        FROM
        TT_DUOC_TONKHO DTK1
        INNER JOIN
        (
        select thekho.*, tonkho.SoLuong as SOLUONGTON from
        (
        Select '$KHODUOC_ID$' as KhoDuoc_ID, CT.Duoc_ID, CT.SoLoNhap_ID, avg(Lo.DonGiaMua) as DonGiaMua
        , sum(case when
        CTU.LoaiChungTu = 'N' then SoLuongThucTe*ISNULL(ct.TYLEQUIDOI,1)
        else - SOLUONGDAXUAT end) as SoLuong
        ,lo.NGUONDUOC_ID
        from TT_DUOC_CHUNGTU_CHITIET CT
        join TT_DUOC_CHUNGTU CTU on CT.ChungTu_ID = CTU.ChungTu_ID
        join TT_DUOC_CHUNGTU_SOLONHAP Lo on Lo.SoLoNhap_ID = CT.SoLoNhap_ID
        where
        (
        (LoaiChungTu = 'N' And KhoNhap_ID = '$KHODUOC_ID$')
        Or
        (LoaiChungTu = 'X' And KhoXuat_ID = '$KHODUOC_ID$')
        )
        And ((CTU.TrangThai not in ('PNCXN','CXN','HUY', 'PNCNK')) or CTU.TRANGTHAI IS NULL)
        And CT.DUOC_ID IN ($LIST_DUOC_ID$)

        Group by CT.Duoc_ID, CT.SoLoNhap_ID,lo.NGUONDUOC_ID
        )thekho

        left join
        (
        select * from
        TT_DUOC_TONKHO
        where
        KHODUOC_ID = '$KHODUOC_ID$'
        And DUOC_ID IN ($LIST_DUOC_ID$)
        )tonkho
        on thekho.KhoDuoc_ID = tonkho.KhoDuoc_ID and thekho.Duoc_ID = tonkho.DUOC_ID and thekho.SOLONHAP_ID = tonkho.SOLONHAP_ID
        where thekho.SoLuong != tonkho.SOLUONG
        and thekho.SoLuong >= 0
        ) DTK2
        ON DTK1.KHODUOC_ID = DTK2.KHODUOC_ID AND DTK1.DUOC_ID = DTK2.DUOC_ID AND DTK1.SOLONHAP_ID = DTK2.SOLONHAP_ID AND DTK1.NGUONDUOC_ID = DTK2.NGUONDUOC_ID
      </statement>
        <!--Revision:0-->
        <statement id="DAO00030_DUOCPHIEULINH_GetAll" resultClass="DataObject">
            select *
            from TT_DUOC_PHIEULINH
            where BENHVIEN_ID = '$BENHVIEN_ID$'
            order by CHUNGTU_ID
        </statement>
        <!--Revision:0-->
        <statement id="DAO00030_DUOCPHIEULINH_GetList" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
            select *
            from TT_DUOC_PHIEULINH
            <dynamic prepend="where">
                <isParameterPresent>
                    <isNotEmpty prepend="and" property="CHUNGTU_ID">
                        TT_DUOC_PHIEULINH.CHUNGTU_ID = '$CHUNGTU_ID$'
                    </isNotEmpty>
                    <isNotEmpty prepend="and" property="MACHUNGTU">
                        TT_DUOC_PHIEULINH.MACHUNGTU = '$MACHUNGTU$'
                    </isNotEmpty>
                    <isNotEmpty prepend="and" property="SOCHUNGTU">
                        TT_DUOC_PHIEULINH.SOCHUNGTU = '$SOCHUNGTU$'
                    </isNotEmpty>                     
                </isParameterPresent>
            </dynamic>
            order by CHUNGTU_ID
        </statement>
        <!--Revision:0-->
        <statement id="DAO00030_DUOCPHIEULINH_GetDetail" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
            select *
            from TT_DUOC_PHIEULINH
            where TT_DUOC_PHIEULINH.CHUNGTU_ID  = '$value$'
            and BENHVIEN_ID = '$BENHVIEN_ID$'
            order by CHUNGTU_ID
        </statement>
        <!--Revision:0-->
        <statement id="DAO00030_DUOCPHIEULINH_GetDetailP" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
            select *
            from TT_DUOC_PHIEULINH
            where TT_DUOC_PHIEULINH.CHUNGTU_ID  = '$CHUNGTU_ID$'
            and BENHVIEN_ID = '$BENHVIEN_ID$'
            order by CHUNGTU_ID
        </statement>
        <!--Revision:0-->
        <statement id="DAO00030_DUOCPHIEULINH_Add" parameterClass="HashTable" resultClass="System.Int64">
          insert into TT_DUOC_PHIEULINH (
          MACHUNGTU
          , SOCHUNGTU
          , NGAYCHUNGTU
          , LOAICHUNGTU
          , MUCDICHCHUNGTU_ID
          , KHOXUAT_ID
          , NGUOIGIAO_ID
          , NGUOIGIAO
          , KHONHAP_ID
          , NGUOINHAN_ID
          , NGUOINHAN
          , NGUOIKIEMTRA
          , NGUOIDUYET
          , KETOANTRUONG
          , THUKHO
          , SOSERI
          , SOHOADON
          , DIENGIAI
          , GIATRI
          , GIATRITHANHTOAN
          , TYLEVAT
          , GIATRIVAT
          , THUESUAT
          , GIATRITHUE
          , TYLECHIETKHAU
          , GIATRICHIETKHAU
          , TIENTE_ID
          , TYGIA
          , SOCHUNGTUGOC
          , NGAYCHUNGTUGOC
          , NHACUNGCAP_ID
          , HINHTHUCTHANHTOAN_ID
          , NGUONDUOC_ID
          , CHUNGTULIENQUAN_ID
          , TOATHUOC_ID
          , TOATHUOCNOITRU_ID
          , BENHAN_ID
          , DANHANTHUOC
          , NGUOINHAP_ID
          , NGAYNHAP
          , TRANGTHAI
          , PHIEULINH_ID
          , DIENGIAINGHIEPVUPHATSINH
          , TONGHOP_TUNGAY
          , TONGHOP_DENNGAY
          , COSO
          , TONGHOP
          , PHANLOAIPHIEULINH
          , DUYET
          , NGAYDUYET
          , THOIGIANDUYET
          , NGUOIDUYET_ID
          , LYDO
          , BENHVIEN_ID
          , NGAYTAO
          , NGUOITAO_ID
          , NGAYCAPNHAT
          , NGUOICAPNHAT_ID
          ) values (
          #MACHUNGTU#
          , #SOCHUNGTU#
          , #NGAYCHUNGTU#
          , #LOAICHUNGTU#
          , #MUCDICHCHUNGTU_ID#
          , #KHOXUAT_ID#
          , #NGUOIGIAO_ID#
          , #NGUOIGIAO#
          , #KHONHAP_ID#
          , #NGUOINHAN_ID#
          , #NGUOINHAN#
          , #NGUOIKIEMTRA#
          , #NGUOIDUYET#
          , #KETOANTRUONG#
          , #THUKHO#
          , #SOSERI#
          , #SOHOADON#
          , #DIENGIAI#
          , #GIATRI#
          , #GIATRITHANHTOAN#
          , #TYLEVAT#
          , #GIATRIVAT#
          , #THUESUAT#
          , #GIATRITHUE#
          , #TYLECHIETKHAU#
          , #GIATRICHIETKHAU#
          , #TIENTE_ID#
          , #TYGIA#
          , #SOCHUNGTUGOC#
          , #NGAYCHUNGTUGOC#
          , #NHACUNGCAP_ID#
          , #HINHTHUCTHANHTOAN_ID#
          , #NGUONDUOC_ID#
          , #CHUNGTULIENQUAN_ID#
          , #TOATHUOC_ID#
          , #TOATHUOCNOITRU_ID#
          , #BENHAN_ID#
          , #DANHANTHUOC#
          , #NGUOINHAP_ID#
          , #NGAYNHAP#
          , #TRANGTHAI#
          , #PHIEULINH_ID#
          , #DIENGIAINGHIEPVUPHATSINH#
          , #TONGHOP_TUNGAY#
          , #TONGHOP_DENNGAY#
          , #COSO#
          , #TONGHOP#
          , #PHANLOAIPHIEULINH#
          , #DUYET#
          , #NGAYDUYET#
          , #THOIGIANDUYET#
          , #NGUOIDUYET_ID#
          , #LYDO#
          , #BENHVIEN_ID#
          , GETDATE()
          , #NGUOITAO_ID#
          , #NGAYCAPNHAT#
          , #NGUOICAPNHAT_ID#
          )
          select SCOPE_identity() as value
        </statement>
        <!--Revision:0-->
        <update id="DAO00030_DUOCPHIEULINH_Update" parameterClass="System.Collections.IDictionary">
            update TT_DUOC_PHIEULINH set
            MACHUNGTU = #MACHUNGTU#
            , SOCHUNGTU = #SOCHUNGTU#
            , NGAYCHUNGTU = #NGAYCHUNGTU#
            , LOAICHUNGTU = #LOAICHUNGTU#
            , MUCDICHCHUNGTU_ID = #MUCDICHCHUNGTU_ID#
            , KHOXUAT_ID = #KHOXUAT_ID#
            , NGUOIGIAO_ID = #NGUOIGIAO_ID#
            , NGUOIGIAO = #NGUOIGIAO#
            , KHONHAP_ID = #KHONHAP_ID#
            , NGUOINHAN_ID = #NGUOINHAN_ID#
            , NGUOINHAN = #NGUOINHAN#
            , NGUOIKIEMTRA = #NGUOIKIEMTRA#
            , NGUOIDUYET = #NGUOIDUYET#
            , KETOANTRUONG = #KETOANTRUONG#
            , THUKHO = #THUKHO#
            , SOSERI = #SOSERI#
            , SOHOADON = #SOHOADON#
            , DIENGIAI = #DIENGIAI#
            , GIATRI = #GIATRI#
            , GIATRITHANHTOAN = #GIATRITHANHTOAN#
            , TYLEVAT = #TYLEVAT#
            , GIATRIVAT = #GIATRIVAT#
            , THUESUAT = #THUESUAT#
            , GIATRITHUE = #GIATRITHUE#
            , TYLECHIETKHAU = #TYLECHIETKHAU#
            , GIATRICHIETKHAU = #GIATRICHIETKHAU#
            , TIENTE_ID = #TIENTE_ID#
            , TYGIA = #TYGIA#
            , SOCHUNGTUGOC = #SOCHUNGTUGOC#
            , NGAYCHUNGTUGOC = #NGAYCHUNGTUGOC#
            , NHACUNGCAP_ID = #NHACUNGCAP_ID#
            , HINHTHUCTHANHTOAN_ID = #HINHTHUCTHANHTOAN_ID#
            , NGUONDUOC_ID = #NGUONDUOC_ID#
            , CHUNGTULIENQUAN_ID = null
            , TOATHUOC_ID = #TOATHUOC_ID#
            , TOATHUOCNOITRU_ID = #TOATHUOCNOITRU_ID#
            , BENHAN_ID = #BENHAN_ID#
            , DANHANTHUOC = 0
            , NGUOINHAP_ID = #NGUOINHAP_ID#
            , NGAYNHAP = #NGAYNHAP#
            , TRANGTHAI = #TRANGTHAI#
            , PHIEULINH_ID = #PHIEULINH_ID#
            , DIENGIAINGHIEPVUPHATSINH = #DIENGIAINGHIEPVUPHATSINH#
            , TONGHOP_TUNGAY = #TONGHOP_TUNGAY#
            , TONGHOP_DENNGAY = #TONGHOP_DENNGAY#
            , COSO = #COSO#
            , TONGHOP = #TONGHOP#
            , PHANLOAIPHIEULINH = #PHANLOAIPHIEULINH#
            , DUYET = #DUYET#
            , NGAYDUYET = #NGAYDUYET#
            , THOIGIANDUYET = #THOIGIANDUYET#
            , NGUOIDUYET_ID = #NGUOIDUYET_ID#
            , LYDO = #LYDO#
            <!--, BENHVIEN_ID = #BENHVIEN_ID#
				, NGAYTAO = #NGAYTAO#
				, NGUOITAO_ID = #NGUOITAO_ID#-->
            , NGAYCAPNHAT = #NGAYCAPNHAT#
            , NGUOICAPNHAT_ID = #NGUOICAPNHAT_ID#
            where
            CHUNGTU_ID = '$CHUNGTU_ID$'
        </update>
        <!--Revision:0-->
        <update id="DAO00030_DUOCPHIEULINH_Update_TinhTrang" parameterClass="System.Collections.IDictionary">
          update TT_DUOC_PHIEULINH set
          DANHANTHUOC = #DANHANTHUOC#
          ,TRANGTHAI = #TRANGTHAI#
          ,CHUNGTULIENQUAN_ID = #CHUNGTULIENQUAN_ID#
          ,NGAYCAPNHAT = getdate()
          where
          MACHUNGTU = '$MAPHIEULINH$'
        </update>
        <!--Revision:0-->
        <update id="DAO00030_DUOCPHIEULINH_Update_PhieuXuatNB" parameterClass="System.Collections.IDictionary">
            update TT_DUOC_PHIEULINH set
            TRANGTHAI = #TRANGTHAI#            
            where
            MACHUNGTU = '$MAPHIEULINH$'
        </update>
        <!--Revision:0-->
        <statement id="DAO00030_DUOCPHIEULINH_Delete" parameterClass="System.Collections.IDictionary" resultClass="System.Int32">
            delete from TT_DUOC_PHIEULINH
            where
            CHUNGTU_ID = '$CHUNGTU_ID$'
        </statement>
        <!--Revision:0-->
        <statement id="DAO00030_DUOCPHIEULINH_DeleteP" parameterClass="System.Collections.IDictionary" resultClass="System.Int32">
            delete from TT_DUOC_PHIEULINH
            <dynamic prepend="where">
                <isParameterPresent>
                    <isNotEmpty prepend="and" property="CHUNGTU_ID">
                        TT_DUOC_PHIEULINH.CHUNGTU_ID = '$CHUNGTU_ID$'
                    </isNotEmpty>
                    <isNotEmpty prepend="and" property="MACHUNGTU">
                        TT_DUOC_PHIEULINH.MACHUNGTU = '$MACHUNGTU$'
                    </isNotEmpty>
                    <isNotEmpty prepend="and" property="SOCHUNGTU">
                        TT_DUOC_PHIEULINH.SOCHUNGTU = '$SOCHUNGTU$'
                    </isNotEmpty>                   
                </isParameterPresent>
            </dynamic>
        </statement>
        <!--Revision:0-->
        <statement id="DAO00030_PHIEULINH_SEARCH" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
            select *
            from TT_DUOC_PHIEULINH
            <dynamic prepend="where">
                <isParameterPresent>
                  <isNotEmpty prepend="and" property="CHUNGTU_ID">
                    TT_DUOC_PHIEULINH.CHUNGTU_ID = '$CHUNGTU_ID$'
                  </isNotEmpty>
                  <isNotEmpty prepend="and" property="MACHUNGTU">
                    TT_DUOC_PHIEULINH.MACHUNGTU like '%$MACHUNGTU$%'
                  </isNotEmpty>
                  <isNotEmpty prepend="and" property="SOCHUNGTU">
                    TT_DUOC_PHIEULINH.SOCHUNGTU like '%$SOCHUNGTU$%'
                  </isNotEmpty>                  
                  <isNotEmpty prepend="and" property="COSO">
                    TT_DUOC_PHIEULINH.COSO = '$COSO$'
                  </isNotEmpty>
                  <isNotEmpty prepend="and" property="KHOXUAT_ID">
                    TT_DUOC_PHIEULINH.KHOXUAT_ID = '$KHOXUAT_ID$'
                  </isNotEmpty>                 
                  <isNotEmpty prepend="and" property="KHONHAP_ID">
                    TT_DUOC_PHIEULINH.KHONHAP_ID = '$KHONHAP_ID$'
                  </isNotEmpty>                
                  <isNotEmpty prepend="and" property="NGUONDUOC_ID">
                    TT_DUOC_PHIEULINH.NGUONDUOC_ID = '$NGUONDUOC_ID$'
                  </isNotEmpty>                                 
                  <isNotEmpty prepend="and" property="DANHANTHUOC">
                    TT_DUOC_PHIEULINH.DANHANTHUOC = '$DANHANTHUOC$'
                  </isNotEmpty>                
                  <isNotEmpty prepend="and" property="TRANGTHAI">
                    TT_DUOC_PHIEULINH.TRANGTHAI = '$TRANGTHAI$'
                  </isNotEmpty>                                                               
                  <isNotEmpty prepend="and" property="DUYET">
                    TT_DUOC_PHIEULINH.DUYET = '$DUYET$'
                  </isNotEmpty>                             
                  <isNotEmpty prepend="and" property="TUNGAY">
                      CONVERT(date, NGAYCHUNGTU) BETWEEN  CONVERT(date, '$TUNGAY$') and  CONVERT(date, '$DENNGAY$')
                  </isNotEmpty>
                </isParameterPresent>
            </dynamic>
            order by NGAYCHUNGTU DESC
        </statement>
        <!--Revision:0-->
        <statement id="DAO00030_LAPPHIEULINH_TOA_NOITRU" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
          declare @TuNgay datetime = CONVERT(date, '$TONGHOP_TUNGAY$')
          declare @DenNgay datetime = CONVERT(date, DATEADD(day, 1, '$TONGHOP_DENNGAY$'))

          SELECT
          TT.KHAMBENH_ID,
          TT.TOATHUOC_ID as TOATHUOC_ID,
          TT.SOTHUTUTOA as REF_ID,
          N'Người bệnh: ' + BN.MAYTE + ' - ' + BN.TENBENHNHAN
          + CASE WHEN BN.GIOITINH = 1 THEN N' - Nam ' WHEN BN.GIOITINH = 2 THEN N' - Nữ ' END
          + CASE WHEN BN.NGAYSINH IS NOT NULL THEN ' - ' + CONVERT(VARCHAR(10), BN.NGAYSINH, 103) ELSE ' - ' + CONVERT(VARCHAR(10), BN.NAMSINH) END
          + CASE WHEN BA.SOBENHAN IS NOT NULL THEN N' - Mã bệnh án: ' + BA.SOBENHAN  ELSE N'' END
          + CASE WHEN dt.TENDOITUONG IS NOT NULL THEN N' - ' + dt.TENDOITUONG  ELSE '' END
          as BENHNHAN,
          N'Y lệnh: ' + TT.SOTHUTUTOA + ' - ' + CONVERT(VARCHAR(10), KB.THOIGIANKHAM, 103) + ' - ' + CONVERT(VARCHAR(5), KB.THOIGIANKHAM, 108)  + N' - Người lập: ' + NV.TENNHANVIEN  AS YLENH,
          TT.DUOC_ID,
          D.TENDUOCDAYDU,
          D.DONVITINH,
          TT.SOLUONG as SOLUONGYEUCAU,
          NLD.TENNHOMLOAIDUOC,
          TT.KHOPHAT_ID,
          TT.NGAYTAO,
          'KHAMBENH' as LOAIPHIEU
          FROM
          TT_NOITRU_TOATHUOC TT
          left join TT_BENHNHAN BN on TT.BENHNHAN_ID = BN.BENHNHAN_ID
          left join TT_NOITRU_KHAMBENH KB on KB.KHAMBENH_ID = TT.KHAMBENH_ID
          left join TT_NOITRU_BENHAN BA on BA.BENHAN_ID = KB.BENHAN_ID
          left join TM_DOITUONG dt on BA.DOITUONG_ID = dt.DOITUONG_ID
          left join TM_DUOC D on D.DUOC_ID = TT.DUOC_ID
          left join TM_LOAIDUOC LD on LD.LOAIDUOC_ID = D.LOAIDUOC_ID
          left join TM_NHOMLOAIDUOC NLD on NLD.NHOMLOAIDUOC_ID = LD.NHOMLOAIDUOC_ID
          left join TM_NHANVIEN NV on TT.NGUOITAO_ID = NV.NHANVIEN_ID
          WHERE
          KB.NGAYKHAM >= @TuNgay AND KB.NGAYKHAM &lt; @DenNgay
          <isNotEmpty prepend="and" property="PHAMVI_ID">
          TT.PHAMVI_ID =$PHAMVI_ID$
          </isNotEmpty>
          <isNotEmpty prepend="and" property="KHOTAO_ID">
          TT.KHOTAO_ID =$KHOTAO_ID$ 
          </isNotEmpty>
          AND TT.COSO = $COSO$
          AND TT.PHONGBANRATOA_ID = $PHONGBANRATOA_ID$
          AND TT.PHIEULINH_ID is NULL
          AND TT.BENHVIEN_ID = '$BENHVIEN_ID$'
          AND (BN.TENBENHNHAN like N'%$TUKHOA$%' OR BN.MAYTE like N'%$TUKHOA$%' OR BA.SOBENHAN  like N'%$TUKHOA$%' or D.TENDUOCDAYDU like N'%$TUKHOA$%')
          <isNotEmpty prepend="and" property="LOAIVATTU_ID">
              LD.LOAIVATTU_ID = '$LOAIVATTU_ID$'
          </isNotEmpty>   
           <isEqual prepend="and" property="COSO" compareValue="0">
            BA.TRANGTHAI = 'DANGDIEUTRI'
          </isEqual>          
          <isEqual prepend="and" property="COSO" compareValue="1">
            d.TAMNGUNG = '0'
          </isEqual>
          <isNotEmpty prepend="" property="RAVIEN">
            <isEqual prepend="and" property="RAVIEN" compareValue="1">
              KB.RAVIEN = '1'
            </isEqual>
          </isNotEmpty>
          <isEmpty prepend="and" property="RAVIEN">            
              isnull(KB.RAVIEN,'0') = '0'            
          </isEmpty>          
          order by NGAYTAO DESC
        </statement>
        <!--Revision:0-->
        <statement id="DAO00030_LAPPHIEULINH_PTTT_VTYT" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
          declare @TuNgay datetime = CONVERT(date, '$TONGHOP_TUNGAY$')
          declare @DenNgay datetime = CONVERT(date, DATEADD(day, 1, '$TONGHOP_DENNGAY$'))

          SELECT DISTINCT
          VT.PHAUTHUAT_VTYT_ID AS TOATHUOC_ID,
          VT.PHAUTHUAT_ID as REF_ID,
          VT.PHAUTHUAT_ID as KHAMBENH_ID,
          N'Người bệnh: ' + BN.MAYTE + ' - ' + BN.TENBENHNHAN
          + CASE WHEN BN.GIOITINH = 1 THEN N' - Nam' WHEN BN.GIOITINH = 2 THEN N' - Nữ' END
          + CASE WHEN BN.NGAYSINH IS NOT NULL THEN ' - ' + CONVERT(VARCHAR(10), BN.NGAYSINH, 103) ELSE ' - ' + CONVERT(VARCHAR(10), BN.NAMSINH) END
          + CASE WHEN BA.SOBENHAN IS NOT NULL THEN N' - Mã bệnh án: ' + BA.SOBENHAN  ELSE N' - Số tiếp nhận: ' + TN.SOTIEPNHAN END
          + CASE WHEN dt.TENDOITUONG IS NOT NULL THEN N' - ' + dt.TENDOITUONG  ELSE '' END
          as BENHNHAN,
          CASE WHEN PT.LOAI = 'P'THEN +  N'Số phiếu phẫu thuật: ' + ISNULL(PT.SOPHIEUPHAUTHUAT,'')  + N' - Ngày: ' + CONVERT(VARCHAR(10),VT.NGAYTAO, 103) + ' - ' + CONVERT(VARCHAR(5), VT.NGAYTAO, 108) + CASE WHEN NV.TENNHANVIEN IS NOT NULL THEN + N' - Người lập: ' +  NV.TENNHANVIEN ELSE '' END
          ELSE N'Số phiếu thủ thuật: ' +  ISNULL(PT.SOPHIEUPHAUTHUAT,'')  + N' - Ngày: ' + CONVERT(VARCHAR(10), VT.NGAYTAO, 103) + ' - ' + CONVERT(VARCHAR(5), VT.NGAYTAO, 108) + CASE WHEN NV.TENNHANVIEN IS NOT NULL THEN + N' - Người lập: ' +  NV.TENNHANVIEN ELSE '' END
          END AS YLENH,
          VT.DUOC_ID,
          D.TENDUOCDAYDU,
          D.DONVITINH,
          VT.SOLUONG as SOLUONGYEUCAU,
          NLD.TENNHOMLOAIDUOC,
          VT.KHOSUDUNG_ID,
          VT.NGAYTAO,
          PT.LOAI as LOAIPHIEU
          FROM
          TT_PHAUTHUAT_VTYT VT
          left join TT_PHAUTHUAT PT on PT.PHAUTHUAT_ID = VT.PHAUTHUAT_ID
          left join TT_TIEPNHAN TN on TN.TIEPNHAN_ID = PT.TIEPNHAN_ID
          left join TT_NOITRU_BENHAN BA on PT.BENHAN_ID = BA.BENHAN_ID
          left join TM_DOITUONG dt on TN.DOITUONG_ID = dt.DOITUONG_ID
          left join TT_BENHNHAN BN on BN.BENHNHAN_ID = TN.BENHNHAN_ID
          left join TM_DUOC D on D.DUOC_ID = VT.DUOC_ID
          left join TM_LOAIDUOC LD on LD.LOAIDUOC_ID = D.LOAIDUOC_ID
          left join TM_NHOMLOAIDUOC NLD on NLD.NHOMLOAIDUOC_ID = LD.NHOMLOAIDUOC_ID
          left join TM_NHANVIEN NV on VT.NGUOITAO_ID = NV.NHANVIEN_ID
          WHERE          
          vt.NGAYTAO >= @TuNgay AND vt.NGAYTAO &lt; @DenNgay
          <isNotEmpty prepend="and" property="KHOTAO_ID">
            VT.KHOTAO_ID = $KHOTAO_ID$
          </isNotEmpty>                         
          AND PT.PHONGBANTHUCHIEN_ID = '$PHONGBANTHUCHIEN_ID$'
          AND VT.BENHVIEN_ID = '$BENHVIEN_ID$'
          AND VT.CHUNGTUTONGHOP_ID is NULL       
          <isNotEmpty prepend="and" property="LOAIVATTU_ID">
            LD.LOAIVATTU_ID = '$LOAIVATTU_ID$'
          </isNotEmpty>                    
          AND (BN.TENBENHNHAN like N'%$TUKHOA$%'  OR BN.MAYTE like N'%$TUKHOA$%' OR  PT.SOPHIEUPHAUTHUAT  like N'%$TUKHOA$%' or D.TENDUOCDAYDU like N'%$TUKHOA$%')
          order by NGAYTAO DESC
        </statement>
        <!--Revision:0-->
        <statement id="DAO00030_LAPPHIEULINH_CLS_VTYT" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
          declare @TuNgay datetime = CONVERT(date, '$TONGHOP_TUNGAY$')
          declare @DenNgay datetime = CONVERT(date, DATEADD(day, 1, '$TONGHOP_DENNGAY$'))

          SELECT
          CLS.CLSKETQUA_VTYT_ID AS TOATHUOC_ID,
          DV.DVYEUCAU_ID as REF_ID,
          DV.DVYEUCAU_ID as KHAMBENH_ID,
          N'Người bệnh: ' + BN.MAYTE + ' - ' + BN.TENBENHNHAN
          + CASE WHEN BN.GIOITINH = 1 THEN N' - Nam' WHEN BN.GIOITINH = 2 THEN N' - Nữ' END
          + CASE WHEN BN.NGAYSINH IS NOT NULL THEN ' - ' + CONVERT(VARCHAR(10), BN.NGAYSINH, 103) ELSE ' - ' + CONVERT(VARCHAR(10), BN.NAMSINH) END
          + CASE WHEN BA.SOBENHAN IS NOT NULL THEN N' - Mã bệnh án: ' + BA.SOBENHAN  ELSE N' - Số tiếp nhận: ' + TN.SOTIEPNHAN END
          + CASE WHEN dt.TENDOITUONG IS NOT NULL THEN N' - ' + dt.TENDOITUONG  ELSE '' END
          as BENHNHAN,
          CONVERT(VARCHAR(10), BN.NGAYSINH, 103) as NGAYSINH,
          N'Số phiếu CLS: ' +  dv.SOPHIEUYEUCAU  + N' - Ngày: ' +  CONVERT(VARCHAR(10), CLS.NGAYTAO, 103) + ' - ' + CONVERT(VARCHAR(5), CLS.NGAYTAO, 108)
          + CASE WHEN NV.TENNHANVIEN IS NOT NULL THEN + N' - Người lập: ' +  NV.TENNHANVIEN ELSE '' END
          AS YLENH,
          CLS.DUOC_ID,
          D.TENDUOCDAYDU,
          D.DONVITINH,
          CLS.SOLUONG as SOLUONGYEUCAU,
          NLD.TENNHOMLOAIDUOC,
          CLS.KHOSUDUNG_ID,
          CLS.NGAYTAO,
          'CLS' as LOAIPHIEU
          FROM
          TT_CLSKETQUA_VTYT CLS
          left join TT_DVYEUCAU DV on DV.DVYEUCAU_ID = CLS.DVYEUCAU_ID
          left join TT_BENHNHAN BN on DV.BENHNHAN_ID = BN.BENHNHAN_ID
          left join TT_TIEPNHAN TN on TN.TIEPNHAN_ID = DV.TIEPNHAN_ID
          left join TT_CLSKETQUA C on C.CLSKETQUA_ID = CLS.CLSKETQUA_ID
          left join TT_NOITRU_BENHAN BA on BA.BENHAN_ID = c.BENHAN_ID
          left join TM_DOITUONG dt on TN.DOITUONG_ID = dt.DOITUONG_ID
          left join TM_DUOC D on D.DUOC_ID = CLS.DUOC_ID
          left join TM_LOAIDUOC LD on LD.LOAIDUOC_ID = D.LOAIDUOC_ID
          left join TM_NHOMLOAIDUOC NLD on NLD.NHOMLOAIDUOC_ID = LD.NHOMLOAIDUOC_ID
          left join TM_NHANVIEN NV on CLS.NGUOITAO_ID = NV.NHANVIEN_ID
          WHERE         
          CLS.NGAYTAO >= @TuNgay AND CLS.NGAYTAO &lt; @DenNgay
          <isNotEmpty prepend="and" property="KHOTAO_ID">
            CLS.KHOTAO_ID = $KHOTAO_ID$
          </isNotEmpty>           
          AND CLS.BENHVIEN_ID = '$BENHVIEN_ID$'
          AND CLS.CHUNGTUTONGHOP_ID is NULL
          <isNotEmpty prepend="and" property="LOAIVATTU_ID">
            LD.LOAIVATTU_ID = '$LOAIVATTU_ID$'
          </isNotEmpty>
          AND DV.NOITHUCHIEN_ID = $PHONGBANTHUCHIEN_ID$        
          AND (BN.TENBENHNHAN like N'%$TUKHOA$%'  OR BN.MAYTE like N'%$TUKHOA$%' OR  DV.SOPHIEUYEUCAU  like N'%$TUKHOA$%' or D.TENDUOCDAYDU like N'%$TUKHOA$%')
          ORDER BY CLS.NGAYTAO DESC
        </statement>
      <statement id="DAO00030_LAPPHIEULINH_KHAMBENH_VTYT" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
        declare @TuNgay datetime = CONVERT(date, '$TONGHOP_TUNGAY$')
        declare @DenNgay datetime = CONVERT(date, DATEADD(day, 1, '$TONGHOP_DENNGAY$'))

        SELECT
        TT.KHAMBENH_ID,
        TT.KHAMBENH_VTYT_ID as TOATHUOC_ID,
        TT.KHAMBENH_ID as REF_ID,
        N'Người bệnh: ' + BN.MAYTE + ' - ' + BN.TENBENHNHAN
        + CASE WHEN BN.GIOITINH = 1 THEN N' - Nam ' WHEN BN.GIOITINH = 2 THEN N' - Nữ ' END
        + CASE WHEN BN.NGAYSINH IS NOT NULL THEN ' - ' + CONVERT(VARCHAR(10), BN.NGAYSINH, 103) ELSE ' - ' + CONVERT(VARCHAR(10), BN.NAMSINH) END
        + CASE WHEN TN.SOTIEPNHAN IS NOT NULL THEN N' - Số tiếp nhận: ' + TN.SOTIEPNHAN  ELSE N'' END
        + CASE WHEN dt.TENDOITUONG IS NOT NULL THEN N' - ' + dt.TENDOITUONG  ELSE '' END
        as BENHNHAN,
        N'Y lệnh: ' + CAST(TT.KHAMBENH_VTYT_ID as nvarchar(10)) + ' - ' + CONVERT(VARCHAR(10), KB.THOIGIANKHAM, 103) + ' - ' + CONVERT(VARCHAR(5), KB.THOIGIANKHAM, 108)  + N' - Người lập: ' + NV.TENNHANVIEN  AS YLENH,
        TT.DUOC_ID,
        D.TENDUOCDAYDU,
        D.DONVITINH,
        TT.SOLUONG as SOLUONGYEUCAU,
        NLD.TENNHOMLOAIDUOC,
        TT.KHOTAO_ID KHOPHAT_ID,
        TT.KHOSUDUNG_ID,
        TT.NGAYTAO,
        'TT_NGOAITRU_KHAMBENH_VTYT' as LOAIPHIEU
        FROM
        TT_NGOAITRU_KHAMBENH_VTYT TT
        left join TT_NGOAITRU_KHAMBENH KB on KB.KHAMBENH_ID = TT.KHAMBENH_ID
        left join TT_BENHNHAN BN on KB.BENHNHAN_ID = BN.BENHNHAN_ID
        left join TT_TIEPNHAN TN on TN.TIEPNHAN_ID = KB.TIEPNHAN_ID
        left join TM_DOITUONG dt on TN.DOITUONG_ID = dt.DOITUONG_ID
        left join TM_DUOC D on D.DUOC_ID = TT.DUOC_ID
        left join TM_LOAIDUOC LD on LD.LOAIDUOC_ID = D.LOAIDUOC_ID
        left join TM_NHOMLOAIDUOC NLD on NLD.NHOMLOAIDUOC_ID = LD.NHOMLOAIDUOC_ID
        left join TM_NHANVIEN NV on TT.NGUOITAO_ID = NV.NHANVIEN_ID
        WHERE        
        TT.NGAYSUDUNG >= @TuNgay AND TT.NGAYSUDUNG &lt; @DenNgay
        <isNotEmpty prepend="and" property="PHAMVI_ID">
          TT.PHAMVI_ID =$PHAMVI_ID$
        </isNotEmpty>
        <isNotEmpty prepend="and" property="COSO">
          TT.COSO =$COSO$
        </isNotEmpty>
        <isEqual prepend="and" property="COSO" compareValue="1">
          d.TAMNGUNG = '0'
        </isEqual>
        AND KB.PHONGBAN_ID = $PHONGBANRATOA_ID$
        AND TT.PHIEULINH_ID is NULL
        AND (TN.TRANGTHAI NOT IN ('HOANTHANH') OR ($COSO$ = 1 AND TN.TRANGTHAI = 'HOANTHANH'))
        AND TT.BENHVIEN_ID = '$BENHVIEN_ID$'
        AND (BN.TENBENHNHAN like N'%$TUKHOA$%' OR BN.MAYTE like N'%$TUKHOA$%' OR D.TENDUOCDAYDU like N'%$TUKHOA$%')
        <isNotEmpty prepend="and" property="LOAIVATTU_ID">
          LD.LOAIVATTU_ID = '$LOAIVATTU_ID$'
        </isNotEmpty>
        order by NGAYTAO DESC
      </statement>
      <statement id="DAO00030_LAPPHIEULINH_XUATSUDUNG" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
        declare @TuNgay datetime = CONVERT(date, '$TONGHOP_TUNGAY$')
        declare @DenNgay datetime = CONVERT(date, DATEADD(day, 1, '$TONGHOP_DENNGAY$'))

        SELECT
        ct.CHUNGTU_ID AS KHAMBENH_ID,
        ctct.CHUNGTUCHITIET_ID TOATHUOC_ID,
        ct.CHUNGTU_ID AS REF_ID,
        CASE WHEN ct.LYDOXUATSUDUNG_ID = 8295 THEN N'Xuất tiêu hao khoa phòng' WHEN ct.LYDOXUATSUDUNG_ID = 8312 THEN N'Xuất từ thiện' END AS BENHNHAN,
        ct.MACHUNGTU + ' - ' + CONVERT(VARCHAR(10), CT.NGAYCHUNGTU, 103) + ' - ' + CONVERT(VARCHAR(5), CT.NGAYCHUNGTU, 108)
        + CASE WHEN NV.TENNHANVIEN IS NOT NULL THEN + N' - Người lập: ' +  NV.TENNHANVIEN ELSE '' END AS YLENH,

        ctct.DUOC_ID,
        D.TENDUOCDAYDU,
        D.DONVITINH,
        ctct.SOLUONGDAXUAT as SOLUONGYEUCAU,
        NLD.TENNHOMLOAIDUOC,
        CT.KHOXUAT_ID as KHOPHAT_ID,
        CT.NGAYTAO,
        'XUATSUDUNG' as LOAIPHIEU

        FROM
        TT_DUOC_CHUNGTU ct
        inner join TT_DUOC_CHUNGTU_CHITIET ctct on ct.CHUNGTU_ID = ctct.CHUNGTU_ID
        left join TM_DUOC D on D.DUOC_ID = ctct.DUOC_ID
        left join TM_LOAIDUOC LD on LD.LOAIDUOC_ID = D.LOAIDUOC_ID
        left join TM_NHOMLOAIDUOC NLD on NLD.NHOMLOAIDUOC_ID = LD.NHOMLOAIDUOC_ID
        left join TM_NHANVIEN NV on CT.NGUOITAO_ID = NV.NHANVIEN_ID
        WHERE
        ct.PHIEULINH_ID is null        
        AND CT.NGAYCHUNGTU >= @TuNgay AND CT.NGAYCHUNGTU &lt; @DenNgay
        AND CT.LYDOXUATSUDUNG_ID in (8295, 8312)
        <isNotEmpty prepend="and" property="KHOTAO_ID">          
          ct.KHOXUAT_ID = $KHOTAO_ID$
        </isNotEmpty>
        AND LD.LOAIVATTU_ID = '$LOAIVATTU_ID$'
        AND D.TAMNGUNG = '0'
      </statement>

      <!--Revision:0-->
        <statement id="DAO00030_LAPPHIEULINH_TONGHOPTUYLENH" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
          SELECT DISTINCT
          TT.TOATHUOC_ID,
          KB.KHAMBENH_ID AS MASTER_ID,
          TT.SOTHUTUTOA,
          LTRIM(TT.PHAMVI_ID) + '_' + LTRIM(TT.DUOC_ID) + '_' + LTRIM(TT.NGUONDUOC_ID) as DUOC_KEY,
          TT.DUOC_ID,
          D.TENDUOCDAYDU,
          D.DONVITINH_ID,
          D.DONVITINH,
          TT.SOLUONG as SOLUONGYEUCAU,
          LD.MALOAIDUOC,
          NLD.TENNHOMLOAIDUOC,
          TT.NGUONDUOC_ID AS NGUONHANG_ID,
          TN.SOTIEPNHAN,
          BN.TENBENHNHAN,
          BN.MAYTE,
          N'Người bệnh: ' + BN.MAYTE + ' - ' + BN.TENBENHNHAN + ' - ' + N'Thời gian Y lệnh: ' + CONVERT(VARCHAR(10), KB.THOIGIANKHAM, 103) + ' - ' + CONVERT(VARCHAR(5), KB.THOIGIANKHAM, 108) as BENHNHAN,
          TT.NGAYTAO,
          'TT_NOITRU_TOATHUOC' as LOAIPHIEU,
          TT.NGAYCAPNHAT as REF_NGAYCAPNHAT
          FROM
          TT_NOITRU_TOATHUOC TT
          left join TT_NOITRU_KHAMBENH KB on TT.KHAMBENH_ID = KB.KHAMBENH_ID
          left join TT_NOITRU_BENHAN BA on  KB.BENHAN_ID = BA.BENHAN_ID
          left join TT_BENHNHAN BN on  TT.BENHNHAN_ID = BN.BENHNHAN_ID
          left join TT_TIEPNHAN TN on TT.TIEPNHAN_ID = TN.TIEPNHAN_ID
          left join TM_DUOC D on D.DUOC_ID = TT.DUOC_ID
          left join TM_LOAIDUOC LD on LD.LOAIDUOC_ID = D.LOAIDUOC_ID
          left join TM_NHOMLOAIDUOC NLD on NLD.NHOMLOAIDUOC_ID = LD.NHOMLOAIDUOC_ID
          WHERE
          TT.BENHVIEN_ID = '$BENHVIEN_ID$'
          AND TT.PHIEULINH_ID is NULL
          AND TT.TOATHUOC_ID IN ($LIST_TOATHUOC_ID$)
          AND TT.SOTHUTUTOA IN ($LIST_REF_ID$)

          union all

          SELECT DISTINCT
          VT.PHAUTHUAT_VTYT_ID AS TOATHUOC_ID,
          PT.PHAUTHUAT_ID AS MASTER_ID,
          1 as SOTHUTUTOA,
          LTRIM(VT.PHAMVI_ID) + '_' + LTRIM(VT.DUOC_ID) + '_' + LTRIM(VT.NGUONHANG_ID) as DUOC_KEY,
          VT.DUOC_ID,
          D.TENDUOCDAYDU,
          D.DONVITINH_ID,
          D.DONVITINH,
          VT.SOLUONG as SOLUONGYEUCAU,
          LD.MALOAIDUOC,
          NLD.TENNHOMLOAIDUOC,
          VT.NGUONHANG_ID,
          TN.SOTIEPNHAN,
          BN.TENBENHNHAN,
          BN.MAYTE,
          N'Người bệnh: ' + BN.MAYTE + ' - ' + BN.TENBENHNHAN + ' - '
          + N'Thời gian ghi nhận: ' + CONVERT(VARCHAR(10), VT.NGAYTAO, 103) + ' - ' + CONVERT(VARCHAR(5), VT.NGAYTAO, 108) as BENHNHAN,
          VT.NGAYTAO,
          'TT_PHAUTHUAT_VTYT' as LOAIPHIEU,
          VT.NGAYCAPNHAT as REF_NGAYCAPNHAT
          FROM
          TT_PHAUTHUAT_VTYT VT
          left join TT_PHAUTHUAT PT on PT.PHAUTHUAT_ID = VT.PHAUTHUAT_ID
          left join TT_PHAUTHUAT_EKIP EK on PT.PHAUTHUAT_ID = EK.PHAUTHUAT_ID
          left join TT_TIEPNHAN TN on TN.TIEPNHAN_ID = PT.TIEPNHAN_ID
          left join TT_BENHNHAN BN on BN.BENHNHAN_ID = TN.BENHNHAN_ID
          left join TM_DUOC D on D.DUOC_ID = VT.DUOC_ID
          left join TM_LOAIDUOC LD on LD.LOAIDUOC_ID = D.LOAIDUOC_ID
          left join TM_NHOMLOAIDUOC NLD on NLD.NHOMLOAIDUOC_ID = LD.NHOMLOAIDUOC_ID
          WHERE
          VT.PHAUTHUAT_VTYT_ID IN ($LIST_TOATHUOC_ID$)
          AND PT.PHAUTHUAT_ID IN ($LIST_REF_ID$)
          AND VT.BENHVIEN_ID = '$BENHVIEN_ID$'

          union all

          SELECT DISTINCT
          CLS.CLSKETQUA_VTYT_ID AS TOATHUOC_ID,
          DV.DVYEUCAU_ID AS MASTER_ID,
          0 as SOTHUTUTOA,
          LTRIM(CLS.PHAMVI_ID) + '_' + LTRIM(CLS.DUOC_ID) + '_' + LTRIM(CLS.NGUONHANG_ID) as DUOC_KEY,
          CLS.DUOC_ID,
          D.TENDUOCDAYDU,
          D.DONVITINH_ID,
          D.DONVITINH,
          CLS.SOLUONG as SOLUONGYEUCAU,
          LD.MALOAIDUOC,
          NLD.TENNHOMLOAIDUOC,
          CLS.NGUONHANG_ID,
          TN.SOTIEPNHAN,
          BN.TENBENHNHAN,
          BN.MAYTE,
          N'Người bệnh: ' + BN.MAYTE + ' - ' + BN.TENBENHNHAN + ' - ' +
          N'Thời gian ghi nhận: ' +  CONVERT(VARCHAR(10), cls.NGAYTAO, 103) + ' - ' + CONVERT(VARCHAR(5), cls.NGAYTAO, 108) AS BENHNHAN,
          CLS.NGAYTAO,
          'TT_CLSKETQUA_VTYT' as LOAIPHIEU,
          CLS.NGAYCAPNHAT as REF_NGAYCAPNHAT
          FROM
          TT_CLSKETQUA_VTYT CLS
          left join TT_CLSKETQUA KQ on KQ.CLSKETQUA_ID = CLS.CLSKETQUA_ID
          left join TT_DVYEUCAU DV on DV.DVYEUCAU_ID = CLS.DVYEUCAU_ID
          left join TT_BENHNHAN BN on DV.BENHNHAN_ID = BN.BENHNHAN_ID
          left join TT_TIEPNHAN TN on TN.TIEPNHAN_ID = DV.TIEPNHAN_ID
          left join TM_DUOC D on D.DUOC_ID = CLS.DUOC_ID
          left join TM_LOAIDUOC LD on LD.LOAIDUOC_ID = D.LOAIDUOC_ID
          left join TM_NHOMLOAIDUOC NLD on NLD.NHOMLOAIDUOC_ID = LD.NHOMLOAIDUOC_ID
          WHERE
          CLS.BENHVIEN_ID = '$BENHVIEN_ID$'
          AND CLS.CLSKETQUA_VTYT_ID IN ($LIST_TOATHUOC_ID$)
          AND DV.DVYEUCAU_ID IN ($LIST_REF_ID$)

          UNION  ALL

          SELECT DISTINCT
          TT.KHAMBENH_VTYT_ID TOATHUOC_ID,
          KB.KHAMBENH_ID AS MASTER_ID,
          TT.KHAMBENH_VTYT_ID SOTHUTUTOA,
          LTRIM(TT.PHAMVI_ID) + '_' + LTRIM(TT.DUOC_ID) + '_' + LTRIM(TT.NGUONHANG_ID) as DUOC_KEY,
          TT.DUOC_ID,
          D.TENDUOCDAYDU,
          D.DONVITINH_ID,
          D.DONVITINH,
          TT.SOLUONG as SOLUONGYEUCAU,
          LD.MALOAIDUOC,
          NLD.TENNHOMLOAIDUOC,
          TT.NGUONHANG_ID AS NGUONHANG_ID,
          TN.SOTIEPNHAN,
          BN.TENBENHNHAN,
          BN.MAYTE,
          N'Người bệnh: ' + BN.MAYTE + ' - ' + BN.TENBENHNHAN + ' - ' + N'Thời gian Y lệnh: ' + CONVERT(VARCHAR(10), KB.THOIGIANKHAM, 103) + ' - ' + CONVERT(VARCHAR(5), KB.THOIGIANKHAM, 108) as BENHNHAN,
          TT.NGAYTAO,
          'TT_NGOAITRU_KHAMBENH_VTYT' as LOAIPHIEU,
          TT.NGAYCAPNHAT as REF_NGAYCAPNHAT
          FROM
          TT_NGOAITRU_KHAMBENH_VTYT TT
          left join TT_NGOAITRU_KHAMBENH KB on KB.KHAMBENH_ID = TT.KHAMBENH_ID
          left join TT_BENHNHAN BN on  KB.BENHNHAN_ID = BN.BENHNHAN_ID
          left join TT_TIEPNHAN TN on KB.TIEPNHAN_ID = TN.TIEPNHAN_ID
          left join TM_DUOC D on D.DUOC_ID = TT.DUOC_ID
          left join TM_LOAIDUOC LD on LD.LOAIDUOC_ID = D.LOAIDUOC_ID
          left join TM_NHOMLOAIDUOC NLD on NLD.NHOMLOAIDUOC_ID = LD.NHOMLOAIDUOC_ID

          WHERE
          TT.BENHVIEN_ID = '$BENHVIEN_ID$'
          AND TT.PHIEULINH_ID is NULL
          AND TT.KHAMBENH_VTYT_ID IN ($LIST_TOATHUOC_ID$)
          AND KB.KHAMBENH_ID IN ($LIST_REF_ID$)

          UNION ALL

          SELECT DISTINCT
          ctct.CHUNGTUCHITIET_ID TOATHUOC_ID,
          ct.CHUNGTU_ID AS MASTER_ID,
          ctct.CHUNGTUCHITIET_ID SOTHUTUTOA,
          '$PHAMVI_ID$' + '_' + LTRIM(ctct.DUOC_ID) + '_' + LTRIM(ctct.NGUONHANG_ID) as DUOC_KEY,
          ctct.DUOC_ID,
          D.TENDUOCDAYDU,
          D.DONVITINH_ID,
          D.DONVITINH,
          ctct.SOLUONGDAXUAT as SOLUONGYEUCAU,
          LD.MALOAIDUOC,
          ct.MACHUNGTU + ' - ' + CONVERT(VARCHAR(10), CT.NGAYCHUNGTU, 103) + ' - ' + CONVERT(VARCHAR(5), CT.NGAYCHUNGTU, 108)
          + CASE WHEN NV.TENNHANVIEN IS NOT NULL THEN + N' - Người lập: ' +  NV.TENNHANVIEN ELSE '' END TENNHOMLOAIDUOC,
          ctct.NGUONHANG_ID AS NGUONHANG_ID,
          null SOTIEPNHAN,
          null TENBENHNHAN,
          null MAYTE,
          CASE WHEN ct.LYDOXUATSUDUNG_ID = 8295 THEN N'Xuất tiêu hao khoa phòng' WHEN ct.LYDOXUATSUDUNG_ID = 8312 THEN N'Xuất từ thiện' END AS BENHNHAN,
          ctct.NGAYTAO,
          'TT_DUOC_CHUNGTU' as LOAIPHIEU,
          ctct.NGAYCAPNHAT as REF_NGAYCAPNHAT
          FROM
          TT_DUOC_CHUNGTU ct
          inner join TT_DUOC_CHUNGTU_CHITIET ctct on ct.CHUNGTU_ID = ctct.CHUNGTU_ID
          left join TM_DUOC D on D.DUOC_ID = ctct.DUOC_ID
          left join TM_LOAIDUOC LD on LD.LOAIDUOC_ID = D.LOAIDUOC_ID
          left join TM_NHOMLOAIDUOC NLD on NLD.NHOMLOAIDUOC_ID = LD.NHOMLOAIDUOC_ID
          left join TM_NHANVIEN NV on CT.NGUOITAO_ID = NV.NHANVIEN_ID
          WHERE
          ct.BENHVIEN_ID = '$BENHVIEN_ID$'
          AND ct.PHIEULINH_ID is NULL
          AND ctct.CHUNGTUCHITIET_ID IN ($LIST_TOATHUOC_ID$)
          AND ct.CHUNGTU_ID IN ($LIST_REF_ID$)

        </statement>
        <!--Revision:0-->
        <statement id="DAO00030_YLENH_NOITRU_NGAYCAPNHAT" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
            SELECT
            TT.NGAYCAPNHAT
            FROM
            TT_NOITRU_TOATHUOC TT
            inner join TM_DUOC D on D.DUOC_ID = TT.DUOC_ID
            inner join TM_LOAIDUOC LD on LD.LOAIDUOC_ID = D.LOAIDUOC_ID
            WHERE
            tt.KHAMBENH_ID IN ($LIST_REF_ID$)
            AND tt.BENHVIEN_ID = '$BENHVIEN_ID$'
            <isNotEmpty prepend="and" property="LOAIVATTU_ID">
                LD.LOAIVATTU_ID = '$LOAIVATTU_ID$'
            </isNotEmpty>
            order by NGAYCAPNHAT
        </statement>
        <!--Revision:0-->
        <statement id="DAO00030_VTYT_PHAUTHUAT_NGAYCAPNHAT" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
          SELECT
          NGAYCAPNHAT
          FROM
          TT_PHAUTHUAT_VTYT
          WHERE
          PHAUTHUAT_ID IN ($LIST_REF_ID$)
          AND BENHVIEN_ID = '$BENHVIEN_ID$'
          order by NGAYCAPNHAT
        </statement>
        <!--Revision:0-->
        <statement id="DAO00030_VTYT_CLSKQ_NGAYCAPNHAT" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
          SELECT
          NGAYCAPNHAT
          FROM
          TT_CLSKETQUA_VTYT
          WHERE
          DVYEUCAU_ID IN ($LIST_REF_ID$)
          AND BENHVIEN_ID = '$BENHVIEN_ID$'
          order by NGAYCAPNHAT
        </statement>
        <!--Revision:0-->
        <statement id="DAO00030_VTYT_NGOAITRU_NGAYCAPNHAT" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
            SELECT
            NGAYCAPNHAT
            FROM
            TT_NGOAITRU_KHAMBENH_VTYT
            WHERE
            DVYEUCAU_ID IN ($LIST_REF_ID$)
            AND BENHVIEN_ID = '$BENHVIEN_ID$'
            order by NGAYCAPNHAT
        </statement>
        <statement id="DAO00030_TOATHUOC_NGOAITRU_NGAYCAPNHAT" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
            SELECT
            NGAYCAPNHAT
            FROM
            TT_NGOAITRU_TOATHUOC
            WHERE
            TOATHUOC_ID IN ($LIST_REF_ID$)
            AND BENHVIEN_ID = '$BENHVIEN_ID$'
            order by NGAYCAPNHAT
        </statement>
        <!--Revision:0-->
        <statement id="DAO00030_XUATSUDUNG_TOANOITRU" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
          SELECT
          N'Người bệnh: ' + BN.MAYTE + ' - ' + BN.TENBENHNHAN + ' - '  + N'Bệnh án: ' + BA.SOBENHAN  as BENHNHAN,
          CASE WHEN BN.GIOITINH = 1 THEN 'Nam' WHEN BN.GIOITINH = 2 THEN N'Nữ'  END  AS GIOITINH ,
          CASE WHEN BN.NGAYSINH IS NOT NULL THEN CONVERT(VARCHAR(10), BN.NGAYSINH, 103) ELSE CONVERT(VARCHAR(10), BN.NAMSINH) END as NGAYSINH,
          CASE WHEN dt.TENDOITUONG IS NOT NULL THEN dt.TENDOITUONG  ELSE '' END as DOITUONG,
          N'Y lệnh:' + TT.SOTHUTUTOA + ' - Ngày: ' + CONVERT(VARCHAR(10), KB.THOIGIANKHAM, 103) + ' - ' + CONVERT(VARCHAR(5), KB.THOIGIANKHAM, 108)
          + CASE WHEN NV.TENNHANVIEN IS NOT NULL THEN + N' - Người lập: ' +  NV.TENNHANVIEN ELSE '' END
          AS YLENH,
          TT.TOATHUOC_ID,
          TT.SOTHUTUTOA as REF_ID,
          PL.MACHUNGTU,
          TT.DUOC_ID,
          d.MADUOC,
          d.TENDUOCDAYDU,
          d.DONVITINH,
          TT.SOLUONG as SOLUONGYEUCAU,
          trt.SOLUONG as SOLUONGTRA,
          TT.NGAYTAO
          FROM
          TT_NOITRU_TOATHUOC TT
          inner join TT_NOITRU_KHAMBENH KB on KB.KHAMBENH_ID = TT.KHAMBENH_ID
          inner join TT_NOITRU_BENHAN BA on BA.BENHAN_ID = KB.BENHAN_ID
          inner join TT_BENHNHAN BN on BA.BENHNHAN_ID = BN.BENHNHAN_ID
          inner join TM_DUOC D on D.DUOC_ID = TT.DUOC_ID
          inner join TM_LOAIDUOC LD on LD.LOAIDUOC_ID = D.LOAIDUOC_ID
          left join TM_DOITUONG dt on BA.DOITUONG_ID = dt.DOITUONG_ID
          left join TT_DUOC_PHIEULINH PL on PL.CHUNGTU_ID = TT.PHIEULINH_ID
          left join TT_NOITRU_TRATHUOC_CHITIET trt on (trt.TOATHUOC_ID = TT.TOATHUOC_ID)
          left join TM_NHANVIEN NV on TT.NGUOITAO_ID = NV.NHANVIEN_ID
		  left join (
          SELECT ctct.TOATHUOCNOITRU_ID
          FROM TT_DUOC_CHUNGTU_CHITIET (nolock) ctct
          inner join TT_DUOC_CHUNGTU (nolock) ct on ct.CHUNGTU_ID = ctct.CHUNGTU_ID
          and ct.MUCDICHCHUNGTU_CODE = 'N05'            and ct.KHONHAP_ID =  '$KHOTAO_ID$'
          ) CTN on CTN.TOATHUOCNOITRU_ID = TT.TOATHUOC_ID
          WHERE
          CONVERT(date, KB.THOIGIANKHAM) BETWEEN  CONVERT(date, '$TONGHOP_TUNGAY$')  AND  CONVERT(date, '$TONGHOP_DENNGAY$')
          AND TT.CHUNGTU_ID is null
          AND BA.TRANGTHAI = 'DANGDIEUTRI'
          AND TT.PHONGBANRATOA_ID = '$NOILAP_ID$'
          <isNotEmpty prepend="and" property="KHOTAO_ID">
            TT.KHOTAO_ID = '$KHOTAO_ID$'
          </isNotEmpty>
          AND (
          (tt.COSO = '0'
          AND tt.PHIEULINH_ID IS NOT NULL
          <!--HaiPN6: Sử dụng câu lệnh này rất chậm-->
        <!--AND tt.TOATHUOC_ID IN
          (SELECT ctct.TOATHUOCNOITRU_ID FROM TT_DUOC_CHUNGTU_CHITIET (nolock) ctct
          inner join TT_DUOC_CHUNGTU (nolock) ct on ct.CHUNGTU_ID = ctct.CHUNGTU_ID
          and ct.MUCDICHCHUNGTU_CODE = 'N05'
          and ct.KHONHAP_ID =  '$KHOTAO_ID$'
          )-->
        AND CTN.TOATHUOCNOITRU_ID IS NOT NULL
          )
          or
          (tt.COSO = '1')
          )
          AND TT.BENHVIEN_ID = '$BENHVIEN_ID$'
          AND (BN.TENBENHNHAN like N'%$TUKHOA$%' OR BN.MAYTE like N'%$TUKHOA$%'  OR  BA.SOBENHAN  like N'%$TUKHOA$%'
          or D.TENDUOCDAYDU like N'%$TUKHOA$%'
          OR PL.MACHUNGTU like '%$TUKHOA$%'
          )
          AND LD.LOAIVATTU_ID = '$LOAIVATTU_ID$'
          order by NGAYTAO DESC
        </statement>
        <!--Revision:0-->
        <statement id="DAO00030_XUATSUDUNG_KHAMBENH_NGOAITRU_VTYT" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
          SELECT
          N'Người bệnh: ' + BN.MAYTE + ' - ' + BN.TENBENHNHAN + ' - ' + N'Số TN: ' + TN.SOTIEPNHAN  as BENHNHAN,
          CASE WHEN BN.GIOITINH = 1 THEN 'Nam' WHEN BN.GIOITINH = 2 THEN N'Nữ' END  AS GIOITINH ,
          CASE WHEN BN.NGAYSINH IS NOT NULL THEN CONVERT(VARCHAR(10), BN.NGAYSINH, 103) ELSE CONVERT(VARCHAR(10), BN.NAMSINH) END as NGAYSINH,
          CASE WHEN dt.TENDOITUONG IS NOT NULL THEN dt.TENDOITUONG  ELSE '' END as DOITUONG,
          N'VTYT Ngoại trú ngày: ' + CONVERT(VARCHAR(10), VT.NGAYTAO, 103) + ' - ' + CONVERT(VARCHAR(5), VT.NGAYTAO, 108)
          + CASE WHEN NV.TENNHANVIEN IS NOT NULL THEN + N' - Người lập: ' +  NV.TENNHANVIEN ELSE '' END
          AS YLENH,
          VT.KHAMBENH_VTYT_ID as TOATHUOC_ID,
          DV.DVYEUCAU_ID as REF_ID,
          PL.MACHUNGTU,
          VT.DUOC_ID,
          d.MADUOC,
          d.TENDUOCDAYDU,
          d.DONVITINH,
          VT.SOLUONG as SOLUONGYEUCAU,
          VT.NGAYTAO
          FROM
          TT_NGOAITRU_KHAMBENH_VTYT VT
          inner join TT_DVYEUCAU DV on DV.DVYEUCAU_ID = VT.DVYEUCAU_ID
          inner join TT_BENHNHAN BN on DV.BENHNHAN_ID = BN.BENHNHAN_ID
          inner join TT_TIEPNHAN TN on TN.TIEPNHAN_ID = DV.TIEPNHAN_ID
          left join TM_DOITUONG dt on TN.DOITUONG_ID = dt.DOITUONG_ID
          left join TM_NHANVIEN NV on VT.NGUOITAO_ID = NV.NHANVIEN_ID
          inner join TM_DUOC D on D.DUOC_ID = VT.DUOC_ID
          inner join TM_LOAIDUOC LD on LD.LOAIDUOC_ID = D.LOAIDUOC_ID
          left join TT_DUOC_PHIEULINH PL on PL.CHUNGTU_ID = VT.PHIEULINH_ID
          WHERE
          CONVERT(date, VT.NGAYTAO) BETWEEN  CONVERT(date, '$TONGHOP_TUNGAY$')  AND  CONVERT(date, '$TONGHOP_DENNGAY$')
          AND VT.CHUNGTU_ID is null
          AND VT.PHONGBAN_ID = '$NOILAP_ID$'
          <!--AND VT.KHOTAO_ID = '$KHOTAO_ID$'-->
            AND VT.BENHVIEN_ID = '$BENHVIEN_ID$'
            AND (BN.TENBENHNHAN like N'%$TUKHOA$%' OR BN.MAYTE like N'%$TUKHOA$%'
            OR  TN.SOTIEPNHAN  like N'%$TUKHOA$%' or D.TENDUOCDAYDU like N'%$TUKHOA$%'
            OR PL.MACHUNGTU like '%$TUKHOA$%'
            )
            AND LD.LOAIVATTU_ID = '$LOAIVATTU_ID$'
            order by NGAYTAO DESC
        </statement>
        <!--Revision:0-->
        <statement id="DAO00030_XUATSUDUNG_PTTT_VTYT" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
          SELECT
          N'Người bệnh: ' + BN.MAYTE + ' - ' + BN.TENBENHNHAN + ' - '  + N'Số TN: ' + TN.SOTIEPNHAN  as BENHNHAN,
          CASE WHEN BN.GIOITINH = 1 THEN 'Nam' WHEN BN.GIOITINH = 2 THEN N'Nữ' END  AS GIOITINH,
          CASE WHEN BN.NGAYSINH IS NOT NULL THEN CONVERT(VARCHAR(10), BN.NGAYSINH, 103) ELSE CONVERT(VARCHAR(10), BN.NAMSINH) END as NGAYSINH,
          CASE WHEN dt.TENDOITUONG IS NOT NULL THEN dt.TENDOITUONG  ELSE '' END as DOITUONG,
          CASE
          WHEN PT.LOAI = 'P'THEN N'Số phiếu Phẫu thuật: ' +  ISNULL(PT.SOPHIEUPHAUTHUAT,'')  + N' - Ngày: ' +  CONVERT(VARCHAR(10), ISNULL(VT.NGAYTAO,''), 103) + ' - ' + CONVERT(VARCHAR(5), ISNULL(VT.NGAYTAO,''), 108) + CASE WHEN NV.TENNHANVIEN IS NOT NULL THEN + N' - Người lập: ' +  NV.TENNHANVIEN ELSE '' END
          ELSE N'Số phiếu Thủ thuật: ' +  ISNULL(PT.SOPHIEUPHAUTHUAT,'')  + N' - Ngày: ' +  CONVERT(VARCHAR(10), ISNULL(VT.NGAYTAO,''), 103) + ' - ' + CONVERT(VARCHAR(5), ISNULL(VT.NGAYTAO,''), 108) + CASE WHEN NV.TENNHANVIEN IS NOT NULL THEN + N' - Người lập: ' +  NV.TENNHANVIEN ELSE '' END
          END  AS YLENH,
          VT.PHAUTHUAT_VTYT_ID as TOATHUOC_ID,
          VT.PHAUTHUAT_ID as REF_ID,
          PL.MACHUNGTU,
          VT.DUOC_ID,
          d.MADUOC,
          d.TENDUOCDAYDU,
          d.DONVITINH,
          VT.SOLUONG as SOLUONGYEUCAU,
          VT.NGAYTAO
          FROM
          TT_PHAUTHUAT_VTYT VT
          inner join TT_PHAUTHUAT PT on PT.PHAUTHUAT_ID = VT.PHAUTHUAT_ID
          left join TT_TIEPNHAN TN on TN.TIEPNHAN_ID = PT.TIEPNHAN_ID
          left join TT_BENHNHAN BN on BN.BENHNHAN_ID = TN.BENHNHAN_ID
          left join TM_DOITUONG dt on TN.DOITUONG_ID = dt.DOITUONG_ID
          left join TM_DUOC D on D.DUOC_ID = VT.DUOC_ID
          left join TM_LOAIDUOC LD on LD.LOAIDUOC_ID = D.LOAIDUOC_ID
          left join TM_NHANVIEN NV on VT.NGUOITAO_ID = NV.NHANVIEN_ID
          left join TT_DUOC_PHIEULINH PL on PL.CHUNGTU_ID = VT.CHUNGTU_ID
          WHERE
          CONVERT(date, VT.NGAYTAO) BETWEEN  CONVERT(date, '$TONGHOP_TUNGAY$')  AND  CONVERT(date, '$TONGHOP_DENNGAY$')
          AND VT.CHUNGTU_ID is null
          <!--AND VT.KHOTAO_ID = '$KHOTAO_ID$'-->
            AND PT.PHONGBANTHUCHIEN_ID = '$NOILAP_ID$'
            AND VT.BENHVIEN_ID = '$BENHVIEN_ID$'
            AND (BN.TENBENHNHAN like N'%$TUKHOA$%' OR BN.MAYTE like N'%$TUKHOA$%' OR  TN.SOTIEPNHAN  like N'%$TUKHOA$%' or D.TENDUOCDAYDU like N'%$TUKHOA$%'
            OR PL.MACHUNGTU like '%$TUKHOA$%'
            )
            AND LD.LOAIVATTU_ID = '$LOAIVATTU_ID$'
            order by NGAYTAO DESC
        </statement>
        <!--Revision:0-->
        <statement id="DAO00030_XUATSUDUNG_CLS_VTYT" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
          SELECT
          N'Người bệnh: ' + BN.MAYTE + ' - ' + BN.TENBENHNHAN + ' - '  + N'Số TN: ' + TN.SOTIEPNHAN  as BENHNHAN,
          CASE WHEN BN.GIOITINH = 1 THEN 'Nam' WHEN BN.GIOITINH = 2 THEN N'Nữ' END  AS GIOITINH,
          CASE WHEN BN.NGAYSINH IS NOT NULL THEN CONVERT(VARCHAR(10), BN.NGAYSINH, 103) ELSE CONVERT(VARCHAR(10), BN.NAMSINH) END as NGAYSINH,
          CASE WHEN dt.TENDOITUONG IS NOT NULL THEN dt.TENDOITUONG  ELSE '' END as DOITUONG,
          N'Số phiếu CLS: ' +  ISNULL(DV.SOPHIEUYEUCAU,'')  + N' - Ngày: ' +  CONVERT(VARCHAR(10), ISNULL(CLS_VT.NGAYTAO,''), 103) + ' - ' + CONVERT(VARCHAR(5), ISNULL(CLS_VT.NGAYTAO,''), 108) + CASE WHEN NV.TENNHANVIEN IS NOT NULL THEN + N' - Người lập: ' +  NV.TENNHANVIEN ELSE '' END
          AS YLENH,
          CLS_VT.CLSKETQUA_VTYT_ID as TOATHUOC_ID,
          DV.DVYEUCAU_ID as REF_ID,
          PL.MACHUNGTU,
          CLS_VT.DUOC_ID,
          d.MADUOC,
          d.TENDUOCDAYDU,
          d.DONVITINH,
          CLS_VT.SOLUONG as SOLUONGYEUCAU,
          CLS_VT.NGAYTAO
          FROM
          TT_CLSKETQUA_VTYT CLS_VT
          inner join TT_DVYEUCAU DV on DV.DVYEUCAU_ID = CLS_VT.DVYEUCAU_ID
          left join TT_CLSKETQUA CLS on CLS.CLSKETQUA_ID = CLS_VT.CLSKETQUA_ID
          left join TT_BENHNHAN BN on DV.BENHNHAN_ID = BN.BENHNHAN_ID
          left join TT_TIEPNHAN TN on TN.TIEPNHAN_ID = DV.TIEPNHAN_ID
          left join TM_PHONGBAN pb on pb.PHONGBAN_ID = CLS_VT.PHONGBAN_ID
          left join TM_DOITUONG dt on dt.DOITUONG_ID = DV.DOITUONG_ID
          left join TM_NHANVIEN NV on NV.NHANVIEN_ID = CLS_VT.NGUOITAO_ID
          left join TM_DUOC D on D.DUOC_ID = CLS_VT.DUOC_ID
          left join TM_LOAIDUOC LD on LD.LOAIDUOC_ID = D.LOAIDUOC_ID
          left join TT_DUOC_PHIEULINH PL on PL.CHUNGTU_ID = CLS_VT.CHUNGTU_ID
          WHERE
          CONVERT(date, CLS_VT.NGAYTAO) BETWEEN  CONVERT(date, '$TONGHOP_TUNGAY$')  AND  CONVERT(date, '$TONGHOP_DENNGAY$')
          AND CLS_VT.CHUNGTU_ID is null
          <!--AND CLS_VT.KHOTAO_ID = '$KHOTAO_ID$'-->
            AND CLS_VT.PHONGBAN_ID = '$NOILAP_ID$'
            AND CLS_VT.BENHVIEN_ID = '$BENHVIEN_ID$'
            AND (BN.TENBENHNHAN like N'%$TUKHOA$%' OR BN.MAYTE like N'%$TUKHOA$%' OR  TN.SOTIEPNHAN  like N'%$TUKHOA$%' or D.TENDUOCDAYDU like N'%$TUKHOA$%'
            OR PL.MACHUNGTU like '%$TUKHOA$%'
            )
            AND LD.LOAIVATTU_ID = '$LOAIVATTU_ID$'
            order by NGAYTAO DESC
        </statement>
        <!--Revision:0-->
        <statement id="DAO00030_XUATSUDUNG_TONGHOPTUTUYLENH" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
          select
          TT.DUOC_ID,
          d.MADUOC,
          d.TENDUOCDAYDU,
          d.DONVITINH,
          TT.TOATHUOC_ID,
          KB.KHAMBENH_ID as MASTER_ID,
          pb.TENPHONGBAN + ' - ' + BN.MAYTE + ' - ' + BN.TENBENHNHAN + ' - '
          + CASE WHEN BN.NGAYSINH IS NOT NULL THEN ' - ' + CONVERT(VARCHAR(10), BN.NGAYSINH, 103) ELSE ' - ' + CONVERT(VARCHAR(10), BN.NAMSINH) END
          + CASE WHEN dt.TENDOITUONG IS NOT NULL THEN N' - ' + dt.TENDOITUONG  ELSE '' END
          as BENHNHAN,
          dt.MADOITUONG,
          TT.BHYTDONGTIEN,
          TT.SOLUONG as SOLUONGYEUCAU,
          trt.SOLUONG as SOLUONGTRA,
          'NOITRU' as TOATHUOC,
          TT.NGUONDUOC_ID,
          TT.NGAYCAPNHAT as REF_NGAYCAPNHAT
          from
          TT_NOITRU_TOATHUOC TT
          inner join TT_NOITRU_KHAMBENH KB on KB.KHAMBENH_ID = TT.KHAMBENH_ID
          inner join TT_NOITRU_BENHAN BA on BA.BENHAN_ID = KB.BENHAN_ID
          inner join TT_BENHNHAN BN on BA.BENHNHAN_ID = BN.BENHNHAN_ID
          inner join TT_TIEPNHAN TN on TN.TIEPNHAN_ID = BA.TIEPNHAN_ID
          left join TT_NOITRU_TRATHUOC_CHITIET trt on (trt.TOATHUOC_ID = TT.TOATHUOC_ID)
          left join TM_DUOC d on TT.DUOC_ID = d.DUOC_ID
          left join TM_DOITUONG dt on TN.DOITUONG_ID = dt.DOITUONG_ID
          left join TM_PHONGBAN pb on (pb.PHONGBAN_ID = isnull(ba.KHOAVAO_ID,ba.KHOACHUYENDEN_ID))
          where
          tt.TOATHUOC_ID IN ($LIST_TOATHUOC_ID$)
          and BA.TRANGTHAI = 'DANGDIEUTRI'
          and tt.BENHVIEN_ID = '$BENHVIEN_ID$'
          and tt.SOTHUTUTOA IN ($LIST_REF_ID$)
          and 1 IN ($LIST_LOAIDUOC$)
          <!--GROUP BY tt.DUOC_ID, tt.TOATHUOC_ID, pb.TENPHONGBAN, BN.MAYTE, BN.TENBENHNHAN, BN.NGAYSINH, dt.TENDOITUONG, TT.NGAYCAPNHAT,dt.MADOITUONG, KB.KHAMBENH_ID-->
          UNION
          SELECT
          vt.DUOC_ID,
          d.MADUOC,
          d.TENDUOCDAYDU,
          d.DONVITINH,
          KHAMBENH_VTYT_ID AS TOATHUOC_ID,
          DV.DVYEUCAU_ID as MASTER_ID,
          pb.TENPHONGBAN + ' - ' + BN.MAYTE + ' - ' + BN.TENBENHNHAN + ' - '
          + CASE WHEN BN.NGAYSINH IS NOT NULL THEN ' - ' + CONVERT(VARCHAR(10), BN.NGAYSINH, 103) ELSE ' - ' + CONVERT(VARCHAR(10), BN.NAMSINH) END
          + CASE WHEN dt.TENDOITUONG IS NOT NULL THEN N' - ' + dt.TENDOITUONG  ELSE '' END
          as BENHNHAN,
          dt.MADOITUONG,
          '0' as BHYTDONGTIEN,
          vt.SOLUONG as SOLUONGYEUCAU,
          0 as SOLUONGTRA,
          'NGOAITRU' as TOATHUOC,
          VT.NGUONHANG_ID NGUONDUOC_ID,
          VT.NGAYCAPNHAT as REF_NGAYCAPNHAT
          FROM
          TT_NGOAITRU_KHAMBENH_VTYT vt
          inner join TT_DVYEUCAU DV on DV.DVYEUCAU_ID = vt.DVYEUCAU_ID
          left join TT_NGOAITRU_KHAMBENH kb on kb.KHAMBENH_ID = vt.KHAMBENH_ID
          left join TT_BENHNHAN BN on bn.BENHNHAN_ID = kb.BENHNHAN_ID
          left join TM_DOITUONG dt on kb.DOITUONG_ID = dt.DOITUONG_ID
          left join TM_PHONGBAN pb on vt.PHONGBAN_ID = pb.PHONGBAN_ID
          left join TM_DUOC d on vt.DUOC_ID = d.DUOC_ID
          WHERE
          KHAMBENH_VTYT_ID IN ($LIST_TOATHUOC_ID$)
          and vt.DVYEUCAU_ID IN ($LIST_REF_ID$)
          and 2 IN ($LIST_LOAIDUOC$)
          and vt.BENHVIEN_ID = '$BENHVIEN_ID$'
          <!--GROUP BY DUOC_ID, KHAMBENH_VTYT_ID, pb.TENPHONGBAN, BN.MAYTE, BN.TENBENHNHAN, BN.NGAYSINH, dt.TENDOITUONG, VT.NGAYCAPNHAT, dt.MADOITUONG, DV.DVYEUCAU_ID-->
          UNION

          SELECT
          vt.DUOC_ID,
          d.MADUOC,
          d.TENDUOCDAYDU,
          d.DONVITINH,
          PHAUTHUAT_VTYT_ID AS TOATHUOC_ID,
          pt.PHAUTHUAT_ID as MASTER_ID,
          pb.TENPHONGBAN + ' - ' + BN.MAYTE + ' - ' + BN.TENBENHNHAN
          + CASE WHEN BN.NGAYSINH IS NOT NULL THEN ' - ' + CONVERT(VARCHAR(10), BN.NGAYSINH, 103) ELSE ' - ' + CONVERT(VARCHAR(10), BN.NAMSINH) END
          + CASE WHEN dt.TENDOITUONG IS NOT NULL THEN N' - ' + dt.TENDOITUONG  ELSE '' END
          as BENHNHAN,
          dt.MADOITUONG,
          '0' as BHYTDONGTIEN,
          SOLUONG as SOLUONGYEUCAU,
          0 as SOLUONGTRA,
          'THUTHUAT' as TOATHUOC,
          VT.NGUONHANG_ID NGUONDUOC_ID,
          VT.NGAYCAPNHAT AS REF_NGAYCAPNHAT
          FROM
          TT_PHAUTHUAT_VTYT vt
          inner join TT_PHAUTHUAT pt on pt.PHAUTHUAT_ID = vt.PHAUTHUAT_ID
          inner join TT_TIEPNHAN tn on tn.TIEPNHAN_ID = pt.TIEPNHAN_ID
          inner join TT_BENHNHAN bn on bn.BENHNHAN_ID = tn.BENHNHAN_ID
          left join TM_DOITUONG dt on dt.DOITUONG_ID = tn.DOITUONG_ID
          left join TM_PHONGBAN pb on pb.PHONGBAN_ID = pt.PHONGBANTHUCHIEN_ID
          left join TM_DUOC d on vt.DUOC_ID = d.DUOC_ID
          WHERE
          PHAUTHUAT_VTYT_ID IN ($LIST_TOATHUOC_ID$)
          and pt.PHAUTHUAT_ID IN ($LIST_REF_ID$)
          and 3 IN ($LIST_LOAIDUOC$)
          and vt.BENHVIEN_ID = '$BENHVIEN_ID$'
          <!--GROUP BY DUOC_ID, PHAUTHUAT_VTYT_ID, pb.TENPHONGBAN, BN.MAYTE, BN.TENBENHNHAN, BN.NGAYSINH, dt.TENDOITUONG, VT.NGAYCAPNHAT, dt.MADOITUONG, pt.PHAUTHUAT_ID-->

          UNION

          SELECT
          cls.DUOC_ID,
          d.MADUOC,
          d.TENDUOCDAYDU,
          d.DONVITINH,
          CLSKETQUA_VTYT_ID AS TOATHUOC_ID,
          DV.DVYEUCAU_ID as MASTER_ID,
          pb.TENPHONGBAN + ' - ' + BN.MAYTE + ' - ' + BN.TENBENHNHAN
          + CASE WHEN BN.NGAYSINH IS NOT NULL THEN ' - ' + CONVERT(VARCHAR(10), BN.NGAYSINH, 103) ELSE ' - ' + CONVERT(VARCHAR(10), BN.NAMSINH) END
          + CASE WHEN dt.TENDOITUONG IS NOT NULL THEN N' - ' + dt.TENDOITUONG  ELSE '' END
          as BENHNHAN,
          dt.MADOITUONG,
          '0' as BHYTDONGTIEN,
          SOLUONG as SOLUONGYEUCAU,
          0 as SOLUONGTRA,
          'CLS' as TOATHUOC,
          cls.NGUONHANG_ID NGUONDUOC_ID,
          CLS.NGAYCAPNHAT as REF_NGAYCAPNHAT
          FROM
          TT_CLSKETQUA_VTYT cls
          left join TT_DVYEUCAU DV on DV.DVYEUCAU_ID = CLS.DVYEUCAU_ID
          left join TT_BENHNHAN BN on DV.BENHNHAN_ID = BN.BENHNHAN_ID
          left join TT_TIEPNHAN TN on TN.TIEPNHAN_ID = DV.TIEPNHAN_ID
          left join TM_PHONGBAN pb on pb.PHONGBAN_ID = cls.PHONGBAN_ID
          left join TM_DOITUONG dt on dt.DOITUONG_ID = DV.DOITUONG_ID
          left join TM_DUOC d on cls.DUOC_ID = d.DUOC_ID
          WHERE
          cls.CLSKETQUA_VTYT_ID IN ($LIST_TOATHUOC_ID$)
          <!--and DV.DVYEUCAU_ID IN ($LIST_REF_ID$)-->
            and 4 IN ($LIST_LOAIDUOC$)
            and cls.BENHVIEN_ID = '$BENHVIEN_ID$'
            <!--GROUP BY DUOC_ID, CLSKETQUA_VTYT_ID, pb.TENPHONGBAN, BN.MAYTE, BN.TENBENHNHAN, BN.NGAYSINH, dt.TENDOITUONG, CLS.NGAYCAPNHAT, dt.MADOITUONG, DV.DVYEUCAU_ID-->
        </statement>
        <!--Revision:0-->
        <statement id="DAO00030_HOANTRANOIBO_TONGHOPYLENH_NGUNGSUDUNG" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
          SELECT
          pb.TENPHONGBAN + ' - ' + BN.MAYTE + ' - ' + BN.TENBENHNHAN
          + CASE WHEN BN.GIOITINH = 1 THEN N' - Nam' WHEN BN.GIOITINH = 2 THEN N' - Nữ' END
          + CASE WHEN BN.NGAYSINH IS NOT NULL THEN ' - ' + CONVERT(VARCHAR(10), BN.NGAYSINH, 103) ELSE ' - ' + CONVERT(VARCHAR(10), BN.NAMSINH) END
          + CASE WHEN BA.SOBENHAN IS NOT NULL THEN N' - Mã bệnh án: ' + BA.SOBENHAN  ELSE N' - Số tiếp nhận: ' + TN.SOTIEPNHAN END
          + CASE WHEN dt.TENDOITUONG IS NOT NULL THEN N' - ' + dt.TENDOITUONG  ELSE '' END
          as BENHNHAN,
          N'Y lệnh ngày: ' + CONVERT(VARCHAR(10), KB.THOIGIANKHAM, 103) + ' - ' + CONVERT(VARCHAR(5), KB.THOIGIANKHAM, 108)
          + CASE WHEN NV.TENNHANVIEN IS NOT NULL THEN + N' - Người lập: ' +  NV.TENNHANVIEN ELSE '' END
          AS YLENH,
          TT.TOATHUOC_ID,
          TT.SOTHUTUTOA as REF_ID,
          PL.MACHUNGTU,
          TRCT.DUOC_ID,
          D.MADUOC, D.TENDUOCDAYDU, D.DONVITINH,
          TRCT.SOLUONG as SOLUONGYEUCAU,
          TT.KHOPHAT_ID,
          TT.NGAYTAO
          FROM
          TT_NOITRU_TOATHUOC TT
          inner join TT_NOITRU_TRATHUOC_CHITIET TRCT on TRCT.TOATHUOC_ID = TT.TOATHUOC_ID
          inner join TT_NOITRU_TRATHUOC TR on TR.TRATHUOC_ID = TRCT.TRATHUOC_ID
          inner join TT_NOITRU_KHAMBENH KB on KB.KHAMBENH_ID = TT.KHAMBENH_ID
          inner join TT_NOITRU_BENHAN BA on BA.BENHAN_ID = KB.BENHAN_ID
          inner join TT_BENHNHAN BN on BA.BENHNHAN_ID = BN.BENHNHAN_ID
          left join TT_TIEPNHAN TN on TN.TIEPNHAN_ID = BA.TIEPNHAN_ID

          left join TM_NHANVIEN NV on TR.NGUOITAO_ID = NV.NHANVIEN_ID
          left join TM_DOITUONG dt on BA.DOITUONG_ID = dt.DOITUONG_ID
          inner join TM_PHONGBAN pb on pb.PHONGBAN_ID = isnull(ba.KHOAVAO_ID,ba.KHOACHUYENDEN_ID)
          inner join TM_DUOC D on D.DUOC_ID = TT.DUOC_ID
          inner join TM_LOAIDUOC LD on LD.LOAIDUOC_ID = D.LOAIDUOC_ID
          left join TT_DUOC_PHIEULINH PL on PL.CHUNGTU_ID = TT.PHIEULINH_ID
          WHERE
          CONVERT(date, TR.NGAYTRA) BETWEEN  CONVERT(date, '$TONGHOP_TUNGAY$')  AND  CONVERT(date, '$TONGHOP_DENNGAY$')
          AND TRCT.DAHOANTRA = 0
          AND tt.PHIEULINH_ID IN (
          SELECT PHIEULINH_ID FROM TT_DUOC_CHUNGTU ct
          INNER JOIN TT_DUOC_CHUNGTU_CHITIET ctct on ct.CHUNGTU_ID = ctct.CHUNGTU_ID
          WHERE
          MUCDICHCHUNGTU_CODE = 'N05'
          AND ct.KHOXUAT_ID = '$KHOXUAT_ID$'
          AND ct.KHONHAP_ID = '$KHONHAP_ID$'
          AND PHIEULINH_ID IS NOT NULL)
          <!--<isNotEmpty prepend="and" property="PHAMVI_ID">
            TT.PHAMVI_ID = '$PHAMVI_ID$'
          </isNotEmpty>-->
          <!--<isNotEmpty prepend="and" property="KHOXUAT_ID">
            TT.KHOPHAT_ID = '$KHOXUAT_ID$'
          </isNotEmpty>-->
          <!--AND TT.COSO = '0'-->
          AND TT.PHONGBANRATOA_ID = '$PHONGBANRATOA_ID$'
          AND TT.BENHVIEN_ID = '$BENHVIEN_ID$'
          AND (BN.TENBENHNHAN like N'%$TUKHOA$%' OR BN.MAYTE like N'%$TUKHOA$%'  OR  BA.SOBENHAN  like N'%$TUKHOA$%'
          or D.TENDUOCDAYDU like N'%$TUKHOA$%'
          OR PL.MACHUNGTU like '%$TUKHOA$%')
          AND LD.LOAIVATTU_ID = '$LOAIVATTU_ID$'
          order by NGAYTAO DESC
        </statement>
        <!--Revision:0-->
        <statement id="DAO00030_HOANTRANOIBO_LAYTUYLENH_NGUNGSUDUNG" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
          select
          TRCT.DUOC_ID,
          TRCT.TOATHUOC_ID,
          pb.TENPHONGBAN + ' - ' + BN.MAYTE + ' - ' + BN.TENBENHNHAN
          + CASE WHEN BN.NGAYSINH IS NOT NULL THEN ' - ' + CONVERT(VARCHAR(10), BN.NGAYSINH, 103) ELSE ' - ' + CONVERT(VARCHAR(10), BN.NAMSINH) END
          + CASE WHEN dt.TENDOITUONG IS NOT NULL THEN N' - ' + dt.TENDOITUONG  ELSE '' END
          as BENHNHAN,
          'NOITRU' as TOATHUOC,
          SUM(TRCT.SOLUONG) as SOLUONGTRA,
          TRCT.NGAYCAPNHAT as REF_NGAYCAPNHAT
          from
          TT_NOITRU_TOATHUOC tt
          inner join TT_NOITRU_TRATHUOC_CHITIET TRCT on TRCT.TOATHUOC_ID = TT.TOATHUOC_ID
          inner join TT_NOITRU_TRATHUOC TR on TR.TRATHUOC_ID = TRCT.TRATHUOC_ID

          inner join TT_NOITRU_KHAMBENH KB on KB.KHAMBENH_ID = TT.KHAMBENH_ID
          inner join TT_NOITRU_BENHAN BA on BA.BENHAN_ID = KB.BENHAN_ID
          inner join TT_BENHNHAN BN on BA.BENHNHAN_ID = BN.BENHNHAN_ID

          inner join TM_DOITUONG dt on BA.DOITUONG_ID = dt.DOITUONG_ID
          inner join TM_PHONGBAN pb on pb.PHONGBAN_ID = isnull(ba.KHOAVAO_ID,ba.KHOACHUYENDEN_ID)
          where
          TRCT.TOATHUOC_ID IN ($LIST_TOATHUOC_ID$)
          and TRCT.DAHOANTRA = 0
          and TRCT.BENHVIEN_ID = '$BENHVIEN_ID$'
          and tt.SOTHUTUTOA IN ($LIST_REF_ID$)
          GROUP BY TRCT.DUOC_ID,  TRCT.TOATHUOC_ID, pb.TENPHONGBAN, BN.MAYTE, BN.TENBENHNHAN, BN.NGAYSINH, BN.NAMSINH, dt.TENDOITUONG, TRCT.NGAYCAPNHAT
          ORDER BY TRCT.TOATHUOC_ID
        </statement>
        <!--Revision:0-->
        <statement id="DAO00030_HOANTRANOIBO_LAYTUYLENH_NGUNGSUDUNG_NGAYCAPNHAT" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
          select
          TRCT.NGAYCAPNHAT
          from
          TT_NOITRU_TRATHUOC_CHITIET TRCT
          inner join TT_NOITRU_TRATHUOC TR on TR.TRATHUOC_ID = TRCT.TRATHUOC_ID
          where
          TRCT.TOATHUOC_ID IN ($LIST_REF_ID$) AND TRCT.DAHOANTRA=0
          ORDER BY TRCT.TOATHUOC_ID
        </statement>
        <!--Revision:0-->
        <update id="DAO00030_SetChungTuToaThuocNoiTru" parameterClass="System.Collections.IDictionary">
          update TT_NOITRU_TOATHUOC set
          CHUNGTU_ID = #CHUNGTU_ID#,
          NGAYCAPNHAT = GETDATE(),
          TRANGTHAI = 'DAXUAT'
          where
          TOATHUOC_ID IN ($YLENH$)
          update TT_VIENPHI set
          DUYET = '1',
          DATHUCHIEN = '1'
          where
          REF_TABLE = 'TT_NOITRU_TOATHUOC'
          AND REF_ID  IN ($YLENH$)
        </update>
        <!--Revision:0-->
        <update id="DAO00030_RemoveChungTuToaThuocNoiTru" parameterClass="System.Collections.IDictionary">
          update TT_NOITRU_TOATHUOC set
          CHUNGTU_ID = null,
          NGAYCAPNHAT = GETDATE(),
          TRANGTHAI = 'CHUAXUAT'
          where
          CHUNGTU_ID = #CHUNGTU_ID#

          update TT_VIENPHI set
          DUYET = '0',
          DATHUCHIEN = '0',
          NGAYCAPNHAT = GETDATE()
          where
          REF_TABLE = 'TT_NOITRU_TOATHUOC'
          AND REF_ID IN ($YLENH$)
        </update>
        <!--Revision:0-->
        <update id="DAO00030_SetChungTuVTYTThuThuat" parameterClass="System.Collections.IDictionary">
            update TT_PHAUTHUAT_VTYT set
            CHUNGTU_ID = #CHUNGTU_ID#
            where
            PHAUTHUAT_VTYT_ID IN ($YLENH$)
            update TT_VIENPHI
            SET
            DUYET = '1',
            DATHUCHIEN = '1'
            WHERE REF_TABLE = 'TT_PHAUTHUAT_VTYT'
            AND REF_ID IN ($YLENH$)
        </update>
        <!--Revision:0-->
        <update id="DAO00030_SetChungTuVTYTCLS" parameterClass="System.Collections.IDictionary">
          update TT_CLSKETQUA_VTYT set
          CHUNGTU_ID = #CHUNGTU_ID#,
          TRANGTHAI = 'DAXUAT'
          where
          CLSKETQUA_VTYT_ID IN ($YLENH$)
          update TT_VIENPHI
          SET
          DUYET = '1',
          DATHUCHIEN = '1'
          WHERE REF_TABLE = 'TT_CLSKETQUA_VTYT'
          AND REF_ID IN ($YLENH$)
        </update>
        <!--Revision:0-->
        <update id="DAO00030_RemoveChungTuVTYTThuThuat" parameterClass="System.Collections.IDictionary">
          update TT_PHAUTHUAT_VTYT set
          CHUNGTU_ID = null
          where
          CHUNGTU_ID =  #CHUNGTU_ID#

          update TT_VIENPHI
          SET
          DUYET = '0',
          DATHUCHIEN = '0'
          WHERE REF_TABLE = 'TT_PHAUTHUAT_VTYT'
          AND REF_ID IN ($YLENH$)
        </update>
        <!--Revision:0-->
        <update id="DAO00030_RemoveChungTuVTYTCLS" parameterClass="System.Collections.IDictionary">
          update TT_CLSKETQUA_VTYT set
          CHUNGTU_ID = null,
          TRANGTHAI = null
          where
          CHUNGTU_ID =  #CHUNGTU_ID#

          update TT_VIENPHI
          SET
          DUYET = '0',
          DATHUCHIEN = '0'
          WHERE REF_TABLE = 'TT_CLSKETQUA_VTYT'
          AND REF_ID IN ($YLENH$)
        </update>
        <!--Revision:0-->
        <update id="DAO00030_SetChungTuVTYTNgoaiTru" parameterClass="System.Collections.IDictionary">
            update TT_NGOAITRU_KHAMBENH_VTYT set
            CHUNGTU_ID = #CHUNGTU_ID#,
            TRANGTHAI = 'DAXUAT',
            NGAYCAPNHAT = GETDATE()
            where
            KHAMBENH_VTYT_ID IN ($YLENH$)
            
            update TT_VIENPHI set
            DUYET = '1',
            DATHUCHIEN = '1'
            where
            REF_TABLE = 'TT_NGOAITRU_KHAMBENH_VTYT'
            AND REF_ID IN ($YLENH$)
        </update>
        <!--Revision:0-->
        <update id="DAO00030_RemoveChungTuVTYTNgoaiTru" parameterClass="System.Collections.IDictionary">
          update TT_NGOAITRU_KHAMBENH_VTYT set
          CHUNGTU_ID = null,
          TRANGTHAI = null
          where
          CHUNGTU_ID =  #CHUNGTU_ID#

          update TT_VIENPHI set
          DUYET = '0',
          DATHUCHIEN = '0'
          where
          REF_TABLE = 'TT_NGOAITRU_KHAMBENH_VTYT'
          AND REF_ID IN ($YLENH$)
        </update>
        <!--Revision:0-->
        <statement id="DAO00030_GetTrangThaiRaVien" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
            SELECT
            ba.TRANGTHAI
            FROM
            TT_NOITRU_BENHAN BA
            inner join TT_NOITRU_TOATHUOC TT on BA.TIEPNHAN_ID = TT.TIEPNHAN_ID
            WHERE
            TT.CHUNGTU_ID = #CHUNGTU_ID#
            and BA.BENHVIEN_ID = '$BENHVIEN_ID$'
            and BA.TRANGTHAI = 'DAXUATVIEN'
            union all
            SELECT
            BA.TRANGTHAI
            FROM
            TT_NOITRU_BENHAN BA
            inner join TT_PHAUTHUAT PT on PT.BENHAN_ID = BA.BENHAN_ID
            inner join TT_PHAUTHUAT_VTYT VT on VT.PHAUTHUAT_ID = PT.PHAUTHUAT_ID
            WHERE
            VT.CHUNGTU_ID = #CHUNGTU_ID#
            and BA.BENHVIEN_ID = '$BENHVIEN_ID$'
            and BA.TRANGTHAI = 'DAXUATVIEN'
            union all
            SELECT
            ba.TRANGTHAI
            FROM
            TT_NOITRU_BENHAN BA
            inner join TT_DVYEUCAU dv on dv.BENHAN_ID = ba.BENHAN_ID
            inner join TT_CLSKETQUA_VTYT VT on VT.DVYEUCAU_ID = dv.DVYEUCAU_ID
            WHERE
            VT.CHUNGTU_ID = #CHUNGTU_ID#
            and BA.BENHVIEN_ID = '$BENHVIEN_ID$'
            and BA.TRANGTHAI = 'DAXUATVIEN'
        </statement>
        <!--Revision:0-->
        <update id="DAO00030_UpdateTrangThaiYLenhTamNgung" parameterClass="System.Collections.IDictionary">
            update TT_NOITRU_TRATHUOC_CHITIET
            set
            DAHOANTRA = #DAHOANTRA#,
            CHUNGTUTRA_ID = #CHUNGTUTRA_ID#,
            NGUOICAPNHAT_ID = #NGUOICAPNHAT_ID#
            where
            TOATHUOC_ID =  #TOATHUOC_ID#
            AND BENHVIEN_ID = '$BENHVIEN_ID$'
        </update>
        <!--Revision:0-->
        <statement id="DAO00030_DUOCPHIEULINHCT_GetAll" resultClass="DataObject">
            select *
            from TT_DUOC_PHIEULINH_CHITIET
            where BENHVIEN_ID = '$BENHVIEN_ID$'
            order by CHUNGTUCHITIET_ID
        </statement>
        <!--Revision:0-->
        <statement id="DAO00030_DUOCPHIEULINHCT_GetList" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
          select CT.*, NLD.TENNHOMLOAIDUOC, LD.MALOAIDUOC, D.TENDUOCDAYDU, D.DONVITINH, CT.TOATHUOCNOITRU_ID AS TOATHUOC_ID,
          LTRIM(PL.KHOXUAT_ID) + '_' + LTRIM(ct.DUOC_ID) + '_' + LTRIM(ct.NGUONHANG_ID) as DUOC_KEY,
          tt.SOLUONG_BUOISANG, tt.SOLUONG_BUOITRUA, tt.SOLUONG_BUOICHIEU, tt.SOLUONG_BUOITOI, tt.GHICHU
          from TT_DUOC_PHIEULINH_CHITIET CT
          inner join TT_DUOC_PHIEULINH PL ON PL.CHUNGTU_ID = CT.CHUNGTU_ID
          left join TT_NOITRU_TOATHUOC tt on tt.TOATHUOC_ID = ct.TOATHUOCNOITRU_ID and REF_TABLE = 'TT_NOITRU_TOATHUOC'
          left join TM_DUOC D on D.DUOC_ID = CT.DUOC_ID
          left join TM_LOAIDUOC LD on LD.LOAIDUOC_ID = D.LOAIDUOC_ID
          left join TM_NHOMLOAIDUOC NLD on NLD.NHOMLOAIDUOC_ID = LD.NHOMLOAIDUOC_ID
          <dynamic prepend="where">
                <isParameterPresent>
                    <isNotEmpty prepend="and" property="CHUNGTUCHITIET_ID">
                        CT.CHUNGTUCHITIET_ID = '$CHUNGTUCHITIET_ID$'
                    </isNotEmpty>
                    <isNotEmpty prepend="and" property="CHUNGTU_ID">
                        CT.CHUNGTU_ID = '$CHUNGTU_ID$'
                    </isNotEmpty>
                    <isNotEmpty prepend="and" property="DUOC_ID">
                        CT.DUOC_ID = '$DUOC_ID$'
                    </isNotEmpty>                    
                </isParameterPresent>
            </dynamic>
            order by CHUNGTUCHITIET_ID
        </statement>
        <!--Revision:0-->
        <statement id="DAO00030_DUOCPHIEULINHCT_GetDetail" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
            select *
            from TT_DUOC_PHIEULINH_CHITIET
            where CHUNGTUCHITIET_ID  = '$value$'
            and BENHVIEN_ID = '$BENHVIEN_ID$'
            order by CHUNGTUCHITIET_ID
        </statement>
        <!--Revision:0-->
        <statement id="DAO00030_DUOCPHIEULINHCT_GetDetailP" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
            select *
            from TT_DUOC_PHIEULINH_CHITIET
            where TT_DUOC_PHIEULINH_CHITIET.CHUNGTUCHITIET_ID  = '$CHUNGTUCHITIET_ID$'
            and BENHVIEN_ID = '$BENHVIEN_ID$'
            order by CHUNGTUCHITIET_ID
        </statement>
        <!--Revision:0-->
        <statement id="DAO00030_DUOCPHIEULINHCT_Add" parameterClass="HashTable" resultClass="System.Int64">
          insert into TT_DUOC_PHIEULINH_CHITIET (
          CHUNGTU_ID
          , DUOC_ID
          , SOLONHAP_ID
          , SOKIEMSOAT
          , SOVISA
          , DONVITINH_ID
          , SOLUONGYEUCAU
          , SOLUONGTHUCTE
          , SOLUONGDAXUAT
          , TIENTE_ID
          , TYGIA
          , DONGIAMUA
          , DONGIABAN
          , DONGIAVON
          , SOQUYEN
          , SOHOADONVAT
          , TYLEVAT
          , GIATRIVAT
          , MIENPHI
          , LYDOMIENPHI_ID
          , SOCHUNGTUKETOAN
          , SOCHUNGTUTIENMAT
          , TRANGTHAI
          , DAPHATSINHPHIEUXUAT
          , DAPHATSINHPHIEUHOANTRA
          , NGUONHANG_ID
          , REF_TABLE
          , TOATHUOCNOITRU_ID
          , TENBENHNHAN
          , BENHNHAN
          , YLENH
          , MASTER_ID
          , CHUNGTUHOANTRA_LE_ID
          , SOLUONGTHUCNHAN
          , SOLUONGTONGHOPTHUCTE
          , BENHVIEN_ID
          , NGAYTAO
          , NGUOITAO_ID
          , NGAYCAPNHAT
          , NGUOICAPNHAT_ID
          ) values (
          #CHUNGTU_ID#
          , #DUOC_ID#
          , #SOLONHAP_ID#
          , #SOKIEMSOAT#
          , #SOVISA#
          , #DONVITINH_ID#
          , #SOLUONGYEUCAU#
          , #SOLUONGTHUCTE#
          , #SOLUONGDAXUAT#
          , #TIENTE_ID#
          , #TYGIA#
          , #DONGIAMUA#
          , #DONGIABAN#
          , #DONGIAVON#
          , #SOQUYEN#
          , #SOHOADONVAT#
          , #TYLEVAT#
          , #GIATRIVAT#
          , #MIENPHI#
          , #LYDOMIENPHI_ID#
          , #SOCHUNGTUKETOAN#
          , #SOCHUNGTUTIENMAT#
          , #TRANGTHAI#
          , #DAPHATSINHPHIEUXUAT#
          , #DAPHATSINHPHIEUHOANTRA#
          , #NGUONHANG_ID#
          , #REF_TABLE#
          , #TOATHUOCNOITRU_ID#
          , #TENBENHNHAN#
          , #BENHNHAN#
          , #YLENH#
          , #MASTER_ID#
          , #CHUNGTUHOANTRA_LE_ID#
          , #SOLUONGTHUCNHAN#
          , #SOLUONGTONGHOPTHUCTE#
          , #BENHVIEN_ID#
          , #NGAYTAO#
          , #NGUOITAO_ID#
          , #NGAYCAPNHAT#
          , #NGUOICAPNHAT_ID#
          )
          select SCOPE_identity() as value
        </statement>    
      
        <statement id="DAO00030_DUOCPHIEULINHCT_AddMulti" parameterClass="System.String" resultClass="System.Int32">
          SET XACT_ABORT ON
          BEGIN TRANSACTION
          BEGIN TRY

          declare @json nvarchar(max) =  N'$JSON_DATA$';

          DELETE TT_DUOC_PHIEULINH_CHITIET WHERE CHUNGTU_ID = #CHUNGTU_ID#

          INSERT INTO TT_DUOC_PHIEULINH_CHITIET
          (
          CHUNGTU_ID
          , DUOC_ID
          , DONVITINH_ID
          , NGUONHANG_ID
          , SOLUONGYEUCAU
          , SOLUONGTONGHOPTHUCTE
          , REF_TABLE
          , TOATHUOCNOITRU_ID
          , TENBENHNHAN
          , BENHNHAN
          , YLENH
          , MASTER_ID
          , DAPHATSINHPHIEUXUAT
          , DAPHATSINHPHIEUHOANTRA
          , MIENPHI
          , BENHVIEN_ID
          , NGAYTAO
          , NGUOITAO_ID
          )
          SELECT * FROM OPENJSON(@json)
          WITH (
          CHUNGTU_ID int
          , DUOC_ID int
          , DONVITINH_ID int
          , NGUONHANG_ID int
          , SOLUONGYEUCAU numeric(25, 4)
          , SOLUONGTONGHOPTHUCTE numeric(25, 4)
          , REF_TABLE nvarchar(100)
          , TOATHUOCNOITRU_ID int
          , TENBENHNHAN nvarchar(100)
          , BENHNHAN nvarchar(MAX)
          , YLENH nvarchar(MAX)
          , MASTER_ID int
          , DAPHATSINHPHIEUXUAT char(1)
          , DAPHATSINHPHIEUHOANTRA char(1)
          , MIENPHI char(1)
          , BENHVIEN_ID varchar(10)
          , NGAYTAO datetime
          , NGUOITAO_ID  int
          )

          <!--TT_NOITRU_TOATHUOC-->         
         UPDATE TT_NOITRU_TOATHUOC set PHIEULINH_ID = json.CHUNGTU_ID, NGAYCAPNHAT = getdate()        
         FROM OPENJSON(@json)
         WITH (CHUNGTU_ID int, TOATHUOCNOITRU_ID int, REF_TABLE nvarchar(100)) json
         WHERE TT_NOITRU_TOATHUOC.TOATHUOC_ID = json.TOATHUOCNOITRU_ID and json.REF_TABLE = 'TT_NOITRU_TOATHUOC'         
         
          <!--TT_PHAUTHUAT_VTYT-->
         UPDATE  TT_PHAUTHUAT_VTYT set CHUNGTUTONGHOP_ID = json.CHUNGTU_ID, NGAYCAPNHAT = getdate()        
         FROM OPENJSON(@json)
         WITH (CHUNGTU_ID int, TOATHUOCNOITRU_ID int, REF_TABLE nvarchar(100)) json
         WHERE TT_PHAUTHUAT_VTYT.PHAUTHUAT_VTYT_ID = json.TOATHUOCNOITRU_ID and json.REF_TABLE = 'TT_PHAUTHUAT_VTYT'              
         
          <!--TT_CLSKETQUA_VTYT-->
         UPDATE TT_CLSKETQUA_VTYT set CHUNGTUTONGHOP_ID = json.CHUNGTU_ID, NGAYCAPNHAT = getdate()        
         FROM OPENJSON(@json)
         WITH (CHUNGTU_ID int, TOATHUOCNOITRU_ID int, REF_TABLE nvarchar(100)) json
         WHERE TT_CLSKETQUA_VTYT.CLSKETQUA_VTYT_ID = json.TOATHUOCNOITRU_ID and json.REF_TABLE = 'TT_CLSKETQUA_VTYT'         
         
         <!--TT_NGOAITRU_KHAMBENH_VTYT-->      
         UPDATE TT_NGOAITRU_KHAMBENH_VTYT set PHIEULINH_ID = json.CHUNGTU_ID, NGAYCAPNHAT = getdate()        
         FROM OPENJSON(@json)
         WITH (CHUNGTU_ID int, TOATHUOCNOITRU_ID int, REF_TABLE nvarchar(100)) json
         WHERE TT_NGOAITRU_KHAMBENH_VTYT.KHAMBENH_VTYT_ID = json.TOATHUOCNOITRU_ID and json.REF_TABLE = 'TT_NGOAITRU_KHAMBENH_VTYT'  
         
        COMMIT TRANSACTION
        END TRY
        
        BEGIN CATCH
        IF @@TRANCOUNT &gt; 0
        ROLLBACK TRANSACTION
        END CATCH        
      </statement>
      
        <!--Revision:0-->
        <update id="DAO00030_DUOCPHIEULINHCT_Update" parameterClass="System.Collections.IDictionary">
          update TT_DUOC_PHIEULINH_CHITIET set
          CHUNGTU_ID = #CHUNGTU_ID#
          , DUOC_ID = #DUOC_ID#
          , SOLONHAP_ID = #SOLONHAP_ID#
          , SOKIEMSOAT = #SOKIEMSOAT#
          , SOVISA = #SOVISA#
          , DONVITINH_ID = #DONVITINH_ID#
          , SOLUONGYEUCAU = #SOLUONGYEUCAU#
          , SOLUONGTHUCTE = #SOLUONGTHUCTE#
          , SOLUONGDAXUAT = #SOLUONGDAXUAT#
          , TIENTE_ID = #TIENTE_ID#
          , TYGIA = #TYGIA#
          , DONGIAMUA = #DONGIAMUA#
          , DONGIABAN = #DONGIABAN#
          , DONGIAVON = #DONGIAVON#
          , SOQUYEN = #SOQUYEN#
          , SOHOADONVAT = #SOHOADONVAT#
          , TYLEVAT = #TYLEVAT#
          , GIATRIVAT = #GIATRIVAT#
          , MIENPHI = #MIENPHI#
          , LYDOMIENPHI_ID = #LYDOMIENPHI_ID#
          , SOCHUNGTUKETOAN = #SOCHUNGTUKETOAN#
          , SOCHUNGTUTIENMAT = #SOCHUNGTUTIENMAT#
          , TRANGTHAI = #TRANGTHAI#
          , DAPHATSINHPHIEUXUAT = #DAPHATSINHPHIEUXUAT#
          , DAPHATSINHPHIEUHOANTRA = #DAPHATSINHPHIEUHOANTRA#
          , NGUONHANG_ID = #NGUONHANG_ID#
          , BENHNHAN = #BENHNHAN#
          , TENBENHNHAN = #TENBENHNHAN#
          , YLENH = #YLENH#
          , CHUNGTUHOANTRA_LE_ID = #CHUNGTUHOANTRA_LE_ID#
          , SOLUONGTHUCNHAN = #SOLUONGTHUCNHAN#
          , SOLUONGTONGHOPTHUCTE = #SOLUONGTONGHOPTHUCTE#          
          , NGAYCAPNHAT = #NGAYCAPNHAT#
          , NGUOICAPNHAT_ID = #NGUOICAPNHAT_ID#
            where
            CHUNGTUCHITIET_ID = '$CHUNGTUCHITIET_ID$'
        </update>
        <!--Revision:0-->
        <update id="DAO00030_DUOCPHIEULINHCT_UpdateToaThuocNoiTru" parameterClass="System.Collections.IDictionary">         
          update
          TT_NOITRU_TOATHUOC
          set
          PHIEULINH_ID = #CHUNGTU_ID#
          where
          TOATHUOC_ID = '$TOATHUOC_ID$'                          
        </update>      
        <!--Revision:0-->
        <update id="DAO00030_DUOCPHIEULINHCT_UpdatePhauThuatVTYT" parameterClass="System.Collections.IDictionary">
            update
            TT_PHAUTHUAT_VTYT
            set
            CHUNGTUTONGHOP_ID = #CHUNGTU_ID#
            where
            PHAUTHUAT_VTYT_ID = '$TOATHUOC_ID$'
        </update>
        <!--Revision:0-->
        <update id="DAO00030_DUOCPHIEULINHCT_UpdateCLSVTYT" parameterClass="System.Collections.IDictionary">
            update
            TT_CLSKETQUA_VTYT
            set
            CHUNGTUTONGHOP_ID = #CHUNGTU_ID#
            where
            CLSKETQUA_VTYT_ID = '$TOATHUOC_ID$'
        </update>
        <!--Revision:0-->
        <update id="DAO00030_DUOCPHIEULINHCT_RemoveYLenhLienQuan" parameterClass="System.Collections.IDictionary">
          update TT_NOITRU_TOATHUOC set PHIEULINH_ID = null  where  PHIEULINH_ID = '$PHIEULINH_ID$' and BENHVIEN_ID = '$BENHVIEN_ID$'
          update TT_PHAUTHUAT_VTYT set CHUNGTUTONGHOP_ID = null where CHUNGTUTONGHOP_ID = '$PHIEULINH_ID$' and BENHVIEN_ID = '$BENHVIEN_ID$'
          update TT_CLSKETQUA_VTYT set  CHUNGTUTONGHOP_ID = null where CHUNGTUTONGHOP_ID = '$PHIEULINH_ID$' and BENHVIEN_ID = '$BENHVIEN_ID$'
          update TT_NGOAITRU_KHAMBENH_VTYT set  PHIEULINH_ID = null where PHIEULINH_ID = '$PHIEULINH_ID$' and BENHVIEN_ID = '$BENHVIEN_ID$'
        </update>
                   
        <!--Revision:0-->
        <statement id="DAO00030_DUOCPHIEULINHCT_Delete" parameterClass="System.Collections.IDictionary" resultClass="System.Int32">
            delete from TT_DUOC_PHIEULINH_CHITIET
            where
            CHUNGTUCHITIET_ID = '$CHUNGTUCHITIET_ID$'
        </statement>
      
        <!--Revision:0-->
        <statement id="DAO00030_DUOCPHIEULINHCT_DeleteP" parameterClass="System.Collections.IDictionary" resultClass="System.Int32">
          update TT_NOITRU_TOATHUOC set PHIEULINH_ID = null  where  PHIEULINH_ID = '$CHUNGTU_ID$' and BENHVIEN_ID = '$BENHVIEN_ID$'
          update TT_PHAUTHUAT_VTYT set CHUNGTUTONGHOP_ID = null where CHUNGTUTONGHOP_ID = '$CHUNGTU_ID$' and BENHVIEN_ID = '$BENHVIEN_ID$'
          update TT_CLSKETQUA_VTYT set  CHUNGTUTONGHOP_ID = null where CHUNGTUTONGHOP_ID = '$CHUNGTU_ID$' and BENHVIEN_ID = '$BENHVIEN_ID$'
          update TT_NGOAITRU_KHAMBENH_VTYT set  PHIEULINH_ID = null where PHIEULINH_ID = '$CHUNGTU_ID$' and BENHVIEN_ID = '$BENHVIEN_ID$'

          delete from TT_DUOC_PHIEULINH_CHITIET where CHUNGTU_ID = '$CHUNGTU_ID$'
          delete from TT_DUOC_TONKHO_BOOK_NOITRU where REF_TABLE = 'TT_DUOC_PHIEULINH' and REF_ID = '$CHUNGTU_ID$'
        </statement>
        <statement id="DAO00030_TT_NOITRU_TOATHUOC_LOG" parameterClass="HashTable" resultClass="System.Int64">
           insert into TT_NOITRU_TOATHUOC_LOG (
            KHAMBENH_ID
          , TOATHUOC_ID
          , PHIEULINH_ID
          , PHIEULINH_ACTION
          , CHUNGTUXUAT_ID
          , CHUNGTUXUAT_ACTION
          , NGUOICAPNHAT_PHIEULINH
          , NGAYCAPNHAT_PHIEULINH
          , NGUOICAPNHAT_PHIEUXUAT
          , NGAYCAPNHAT_PHIEUXUAT          
          ) values (
            #KHAMBENH_ID#
          , #TOATHUOC_ID#
          , #PHIEULINH_ID#
          , #PHIEULINH_ACTION#
          , #CHUNGTUXUAT_ID#
          , #CHUNGTUXUAT_ACTION#
          , #NGUOICAPNHAT_PHIEULINH#
          , #NGAYCAPNHAT_PHIEULINH#
          , #NGUOICAPNHAT_PHIEUXUAT#
          , #NGAYCAPNHAT_PHIEUXUAT#    
          )
          select SCOPE_identity() as value
        </statement>
        <!--Revision:0-->
        <statement id="DAO00030_PHIEULINHDEDUYET_GetList" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
            SELECT PL.*
            FROM
            TT_DUOC_PHIEULINH PL
            WHERE
            PL.DUYET = '$DUYET$'
            and PL.BENHVIEN_ID = '$BENHVIEN_ID$'
            and PL.MACHUNGTU LIKE N'%$MACHUNGTU$%'
            <dynamic prepend="">
                <isParameterPresent>
                    <isNotEmpty prepend="and" property="KHOXUAT_ID">
                        PL.KHOXUAT_ID = '$KHOXUAT_ID$'
                    </isNotEmpty>
                    <isNotEmpty prepend="and" property="TONGHOP_TUNGAY">
                        CONVERT(date, PL.NGAYCHUNGTU) BETWEEN  CONVERT(date, '$TONGHOP_TUNGAY$') AND  CONVERT(date, '$TONGHOP_DENNGAY$')
                    </isNotEmpty>
                </isParameterPresent>
            </dynamic>
            order by PL.NGAYCHUNGTU DESC
        </statement>
        <!--Revision:0-->
        <statement id="DAO00030_PHIEULINHDEDUYET_GetChiTietPhieuLinh" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
          SELECT
          PLCT.DUOC_ID,
          d.MADUOC,
          d.TENDUOCDAYDU,
          d.DONVITINH,
          PLCT.SOLUONGYEUCAU,
          '' as BENHNHAN,
          '' as TENPHONGBAN,
          0 as REF_ID
          FROM
          TT_DUOC_PHIEULINH PL
          inner join TT_DUOC_PHIEULINH_CHITIET PLCT on PL.CHUNGTU_ID = PLCT.CHUNGTU_ID
          inner join TM_DUOC D on D.DUOC_ID = PLCT.DUOC_ID
          WHERE
          PLCT.CHUNGTU_ID = '$CHUNGTU_ID$'
          and PLCT.BENHVIEN_ID = '$BENHVIEN_ID$'
          and PL.TONGHOP != '1'

          UNION ALL

          SELECT
          PLCT.DUOC_ID,
          d.MADUOC,
          d.TENDUOCDAYDU,
          d.DONVITINH,
          PLCT.SOLUONGYEUCAU,
          PLCT.BENHNHAN,
          PB.TENPHONGBAN,
          TT.KHAMBENH_ID as REF_ID
          FROM
          TT_DUOC_PHIEULINH PL
          inner join TT_DUOC_PHIEULINH_CHITIET PLCT on PL.CHUNGTU_ID = PLCT.CHUNGTU_ID
          inner join TT_NOITRU_TOATHUOC TT on (TT.TOATHUOC_ID = PLCT.TOATHUOCNOITRU_ID AND PLCT.REF_TABLE = 'TT_NOITRU_TOATHUOC')
          left join TM_DUOC D on D.DUOC_ID = PLCT.DUOC_ID
          left join TM_PHONGBAN PB on PB.PHONGBAN_ID = TT.PHONGBANRATOA_ID
          WHERE
          PL.CHUNGTU_ID = '$CHUNGTU_ID$'
          and PL.BENHVIEN_ID = '$BENHVIEN_ID$'

          UNION ALL

          SELECT
          PLCT.DUOC_ID,
          d.MADUOC,
          d.TENDUOCDAYDU,
          d.DONVITINH,
          PLCT.SOLUONGYEUCAU,
          PLCT.BENHNHAN,
          PB.TENPHONGBAN,
          VTYT.PHAUTHUAT_ID as REF_ID
          FROM
          TT_DUOC_PHIEULINH PL
          inner join TT_DUOC_PHIEULINH_CHITIET PLCT on PL.CHUNGTU_ID = PLCT.CHUNGTU_ID
          inner join TT_PHAUTHUAT_VTYT VTYT on (PLCT.TOATHUOCNOITRU_ID = VTYT.PHAUTHUAT_VTYT_ID  AND PLCT.REF_TABLE = 'TT_PHAUTHUAT_VTYT')
          left join TM_DUOC D on D.DUOC_ID = PLCT.DUOC_ID
          left join TT_PHAUTHUAT PT on PT.PHAUTHUAT_ID = VTYT.PHAUTHUAT_ID
          left join TM_PHONGBAN PB on PB.PHONGBAN_ID = PT.PHONGBANTHUCHIEN_ID
          WHERE
          PLCT.CHUNGTU_ID = '$CHUNGTU_ID$'
          and PLCT.BENHVIEN_ID = '$BENHVIEN_ID$'

          UNION ALL

          SELECT
          PLCT.DUOC_ID,
          d.MADUOC,
          d.TENDUOCDAYDU,
          d.DONVITINH,
          PLCT.SOLUONGYEUCAU,
          PLCT.BENHNHAN,
          PB.TENPHONGBAN,
          VTYT.DVYEUCAU_ID as REF_ID
          FROM
          TT_DUOC_PHIEULINH PL
          inner join TT_DUOC_PHIEULINH_CHITIET PLCT on PL.CHUNGTU_ID = PLCT.CHUNGTU_ID
          inner join TT_CLSKETQUA_VTYT VTYT on (PLCT.TOATHUOCNOITRU_ID = VTYT.CLSKETQUA_VTYT_ID  AND PLCT.REF_TABLE = 'TT_CLSKETQUA_VTYT')
          left join TM_DUOC D on D.DUOC_ID = PLCT.DUOC_ID
          left join TM_PHONGBAN PB on PB.PHONGBAN_ID = VTYT.PHONGBAN_ID
          WHERE
          PLCT.CHUNGTU_ID = '$CHUNGTU_ID$'
          and PLCT.BENHVIEN_ID = '$BENHVIEN_ID$'

          UNION ALL

          SELECT
          PLCT.DUOC_ID,
          d.MADUOC,
          d.TENDUOCDAYDU,
          d.DONVITINH,
          PLCT.SOLUONGYEUCAU,
          PLCT.BENHNHAN,
          PB.TENPHONGBAN,
          VTYT.DVYEUCAU_ID as REF_ID
          FROM
          TT_DUOC_PHIEULINH PL
          inner join TT_DUOC_PHIEULINH_CHITIET PLCT on PL.CHUNGTU_ID = PLCT.CHUNGTU_ID
          inner join TT_NGOAITRU_KHAMBENH_VTYT VTYT on (PLCT.TOATHUOCNOITRU_ID = VTYT.KHAMBENH_VTYT_ID  AND PLCT.REF_TABLE = 'TT_NGOAITRU_KHAMBENH_VTYT')
          left join TM_DUOC D on D.DUOC_ID = PLCT.DUOC_ID
          left join TM_PHONGBAN PB on PB.PHONGBAN_ID = VTYT.PHONGBAN_ID
          WHERE
          PLCT.CHUNGTU_ID = '$CHUNGTU_ID$'
          and PLCT.BENHVIEN_ID = '$BENHVIEN_ID$'

          UNION ALL

          SELECT
          PLCT.DUOC_ID,
          d.MADUOC,
          d.TENDUOCDAYDU,
          d.DONVITINH,
          PLCT.SOLUONGYEUCAU,
          PLCT.BENHNHAN,
          '' AS TENPHONGBAN,
          PLCT.MASTER_ID as REF_ID
          FROM
          TT_DUOC_PHIEULINH PL
          inner join TT_DUOC_PHIEULINH_CHITIET PLCT on PL.CHUNGTU_ID = PLCT.CHUNGTU_ID
          inner join TT_DUOC_CHUNGTU_CHITIET TT on (TT.CHUNGTUCHITIET_ID = PLCT.TOATHUOCNOITRU_ID AND PLCT.REF_TABLE = 'TT_DUOC_CHUNGTU')
          left join TM_DUOC D on D.DUOC_ID = PLCT.DUOC_ID          
          WHERE
          PLCT.CHUNGTU_ID = '$CHUNGTU_ID$'
          and PLCT.BENHVIEN_ID = '$BENHVIEN_ID$'

        </statement>
        <!--Revision:0-->
        <update id="DAO00030_DUOCPHIEULINH_Duyet" parameterClass="System.Collections.IDictionary">
          update TT_DUOC_PHIEULINH set
          DUYET = #DUYET#
          ,TRANGTHAI =  #TRANGTHAI#
          ,LYDO = #LYDO#
          ,NGUOIDUYET = #NGUOIDUYET#
          ,NGUOIDUYET_ID = #NGUOIDUYET_ID#
          ,NGAYDUYET = #NGAYDUYET#
          ,THOIGIANDUYET = #THOIGIANDUYET#
          where
          CHUNGTU_ID = '$CHUNGTU_ID$'
          UPDATE
          TT_VIENPHI
          SET
          DUYET = #DUYET#
          WHERE
          (REF_TABLE = 'TT_NOITRU_TOATHUOC' OR REF_TABLE = 'TT_PHAUTHUAT_VTYT')
          AND REF_ID IN (SELECT TOATHUOCNOITRU_ID FROM TT_DUOC_PHIEULINH_CHITIET WHERE CHUNGTU_ID = '$CHUNGTU_ID$')
        </update>
        <!--Revision:0-->
        <statement id="DAO00030_DUOCPHIEULINHCT_GetTaoPhieuXuat" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
          SELECT
          plct.DUOC_ID, plct.SOLUONGYEUCAU, d.TENDUOCDAYDU
          ,plct.TOATHUOCNOITRU_ID, plct.REF_TABLE, plct.YLENH
          ,plct.BENHNHAN, plct.NGUONHANG_ID, plct.MASTER_ID, D.SO_QDTT,plct.TENBENHNHAN,d.SOVISA
          FROM
          TT_DUOC_PHIEULINH_CHITIET plct
          inner join TT_DUOC_PHIEULINH pl on pl.CHUNGTU_ID = plct.CHUNGTU_ID
          inner join TM_DUOC d on d.DUOC_ID = plct.DUOC_ID
          WHERE
          plct.CHUNGTU_ID = '$CHUNGTU_ID$'
          <isNotEmpty prepend="and" property="DUOC_ID">
            plct.DUOC_ID = '$DUOC_ID$'
          </isNotEmpty>
          and plct.BENHVIEN_ID = '$BENHVIEN_ID$'
        </statement>
      <statement id="DAO00030_DUOCPHIEULINHCT_GetTaoPhieuXuatCheckTon" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
        SELECT PL.*, TK.TONGTON
        FROM
        (
        SELECT
        plct.DUOC_ID, d.TENDUOCDAYDU, PL.KHOXUAT_ID, nh.TENNGUONDUOC AS NGUONHANG, dvt.TENDONVITINH AS DONVITINH, SUM(plct.SOLUONGYEUCAU) AS SOLUONGDAXUAT, SUM(plct.SOLUONGYEUCAU) AS SOLUONGYEUCAU, D.SO_QDTT
        FROM
        TT_DUOC_PHIEULINH_CHITIET plct
        inner join TT_DUOC_PHIEULINH pl on pl.CHUNGTU_ID = plct.CHUNGTU_ID
        inner join TM_DUOC d on d.DUOC_ID = plct.DUOC_ID
        left join dbo.TM_NGUONHANG nh on nh.NGUONDUOC_ID = plct.NGUONHANG_ID
        left join dbo.TM_DONVITINH dvt on dvt.DONVITINH_ID = plct.DONVITINH_ID
        WHERE
        plct.CHUNGTU_ID = '$CHUNGTU_ID$'
        GROUP BY plct.DUOC_ID, d.TENDUOCDAYDU, PL.KHOXUAT_ID, nh.TENNGUONDUOC, dvt.TENDONVITINH, D.SO_QDTT
        )PL
        LEFT JOIN
        (
        SELECT
        tk.DUOC_ID, d.TENDUOCDAYDU, TK.KHODUOC_ID, SUM(SOLUONG) AS TONGTON
        FROM
        TT_DUOC_TONKHO tk
        inner join TM_DUOC d on d.DUOC_ID = tk.DUOC_ID
        GROUP BY TK.DUOC_ID, d.TENDUOCDAYDU, KHODUOC_ID
        )TK ON PL.KHOXUAT_ID = TK.KHODUOC_ID AND PL.DUOC_ID = TK.DUOC_ID
      </statement>
        <!--Revision:0-->
        <statement id="DAO00030_TOATHUOC_GetDanhSachToaNgoaiTruDaXuat" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
            select KBTT.SOTHUTUTOA
            from
            TT_NGOAITRU_KHAMBENH_TOATHUOC KBTT
            where
            KBTT.KHAMBENH_TOATHUOC_ID  IN ($LIST_KHAMBENH_TOATHUOC_ID$)
            and KBTT.TRANGTHAI = 'DAXUAT'
            and KBTT.BENHVIEN_ID = '$BENHVIEN_ID$'
        </statement>
       <statement id="DAO00030_TOATHUOC_KiemTraToaThuocDaHuyBooking" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
         select distinct tt.SOTHUTUTOA
         from
         TT_NGOAITRU_TOATHUOC tt
         join TT_DUOC_TONKHO_BOOK_NGOAITRU bk on bk.REF_ID = tt.TOATHUOC_ID and bk.REF_TABLE = 'TT_NGOAITRU_TOATHUOC'
         where
         tt.KHAMBENH_TOATHUOC_ID  IN ($LIST_KHAMBENH_TOATHUOC_ID$)
         and (isnull(bk.TRANGTHAI,'') != 'HIEULUC' or bk.SOLUONG = 0)
         and bk.BENHVIEN_ID = '$BENHVIEN_ID$'
       </statement>
        <statement id="DAO00030_TOATHUOC_GetDanhSachToaNgoaiTruDaXacNhan" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
          select kbtt.SOTHUTUTOA
          from
          TT_NGOAITRU_KHAMBENH_TOATHUOC kbtt
          inner join TT_DUOC_CHUNGTU ct on ct.CHUNGTU_ID = kbtt.CHUNGTUPHATTHUOC_ID
          where
          kbtt.KHAMBENH_TOATHUOC_ID in ($LIST_KHAMBENH_TOATHUOC_ID$)
          and isnull(ct.DAXACNHAN, '0') != '0'
          and kbtt.BENHVIEN_ID = '$BENHVIEN_ID$'
        </statement>
        <!--Revision:0-->
        <statement id="DAO00030_TOATHUOC_GetDanhSachToaNoiTruDaXuat" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
            SELECT
            TT.SOTHUTUTOA
            FROM
            TT_NOITRU_KHAMBENH KB
            INNER JOIN TT_NOITRU_TOATHUOC TT on KB.KHAMBENH_ID = TT.KHAMBENH_ID
            WHERE
            KB.KHAMBENH_ID IN ($LIST_KHAMBENH_TOATHUOC_ID$)
            and TT.TRANGTHAI = 'DAXUAT'
            and KB.BENHVIEN_ID = '$BENHVIEN_ID$'
        </statement>
        <!--Revision:0-->
        <statement id="DAO00030_TOATHUOC_GetThongTinDuyet" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
          SELECT DISTINCT
          BN.BENHNHAN_ID,
          BN.MAYTE,
          BN.TENBENHNHAN,
          BN.SOVAOVIEN,
          CASE
          WHEN BN.GIOITINH = 1 THEN 'Nam'
          WHEN BN.GIOITINH = 2 THEN N'Nữ'
          END  AS GIOITINH,
          BN.NAMSINH,
          CONVERT(varchar(12), BN.NGAYSINH, 103) as NGAYSINH,
          DT.TENDOITUONG,
          BN.DIACHILIENLAC as DIACHI,
          KBTT.TIEPNHAN_ID,
          KBTT.KHAMBENH_TOATHUOC_ID,
          KBTT.SOTHUTUTOA,
          KBTT.PHAMVI_ID,
          KB.PHONGBAN_ID,
          KB.BACSIKHAM_ID,
          CONVERT(VARCHAR(30), KBTT.THOIGIANTOATHUOC, 103) + ' ' + CONVERT(VARCHAR(30), KBTT.THOIGIANTOATHUOC, 108) as THOIGIANRATOA,
          KBTT.NGUOIDUYET_ID,
          KBTT.NGAYDUYET,
          KBTT.THOIGIANDUYET,
          KBTT.TRANGTHAI,
          KBTT.CHUNGTUPHATTHUOC_ID,
          KBTT.LYDOHUY,
          'NGOAITRU' as MALOAITOA,
          N'Ngoại trú' as TENLOAITOA,          
          CASE
          WHEN KBTT.TRANGTHAI = 'CHUAXUAT' THEN N'Chưa xuất'
          WHEN KBTT.TRANGTHAI = 'DAXUAT' THEN N'Đã xuất'
          END  AS TRANGTHAI_TOA,

          CASE
          WHEN vp.HOADON_ID is not null THEN N'Đã thanh toán'
          ELSE N'Chưa thanh toán'
          END AS TRANGTHAI_HD

          FROM TT_NGOAITRU_KHAMBENH_TOATHUOC KBTT
          INNER join TT_TIEPNHAN tn on kbtt.TIEPNHAN_ID = tn.TIEPNHAN_ID
          INNER join TT_NGOAITRU_TOATHUOC tt on tt.KHAMBENH_TOATHUOC_ID = kbtt.KHAMBENH_TOATHUOC_ID
          INNER join TT_NGOAITRU_KHAMBENH KB on KB.KHAMBENH_ID = KBTT.KHAMBENH_ID
          INNER join TT_BENHNHAN BN on KB.BENHNHAN_ID = BN.BENHNHAN_ID
          LEFT join TM_DOITUONG DT on KB.DOITUONG_ID = DT.DOITUONG_ID
          LEFT join TT_VIENPHI vp on vp.KHAMBENH_ID = KBTT.KHAMBENH_ID and vp.DUOC_ID = tt.DUOC_ID
          and (
          (REF_TABLE = 'TT_DUOC_CHUNGTU_CHITIET' and KBTT.LOAITOATHUOC = '$LOAITOATHUOC$')
          or
          (REF_TABLE = 'TT_NGOAITRU_TOATHUOC' and KBTT.LOAITOATHUOC = '$LOAITOATHUOC$')
          )
          WHERE
          KBTT.DUYET = '$DUYET$'
          AND KBTT.HUYTOATHUOC = '0'
          <isNotEmpty prepend="and" property="KHOXUAT_ID">
                KBTT.KHOXUAT_ID = '$KHOXUAT_ID$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="PHAMVI_ID">
            KBTT.PHAMVI_ID = '$PHAMVI_ID$'
          </isNotEmpty>
          <isEqual prepend="AND" property="LOAITOATHUOC" compareValue="MN">
             (KBTT.LOAITOATHUOC = 'MN' or KBTT.LOAITOATHUOC = 'TV')
          </isEqual>
          <isNotEqual prepend="AND" property="LOAITOATHUOC" compareValue="MN">
            (
            CASE
            WHEN (
            ('$LOAITOATHUOC$' = 'KTBV' AND KBTT.LOAITOATHUOC IN ('KTBV', 'BVTT') AND len(isnull(tn.SOBHYT,'')) = 0 )
            OR
            (KBTT.LOAITOATHUOC = '$LOAITOATHUOC$' and KBTT.LOAITOATHUOC != 'KTBV')
            ) THEN 1
            ELSE 0
            END = 1
            )
          </isNotEqual>
          AND CONVERT(date, KBTT.NGAYTAO) BETWEEN CONVERT(date, '$TUNGAY$')  AND  CONVERT(date, '$DENNGAY$')
          AND (KBTT.SOTHUTUTOA LIKE '%$KEYWORD$%' or BN.TENBENHNHAN LIKE N'%$KEYWORD$%' or BN.MAYTE LIKE N'%$KEYWORD$%' or BN.SOVAOVIEN LIKE N'%$KEYWORD$%')
          AND KB.BENHVIEN_ID = '$BENHVIEN_ID$'

          UNION ALL

          SELECT DISTINCT
          BN.BENHNHAN_ID,
          BN.MAYTE,
          BN.TENBENHNHAN,
          BN.SOVAOVIEN,
          CASE
          WHEN BN.GIOITINH = 1 THEN 'Nam'
          WHEN BN.GIOITINH = 2 THEN N'Nữ'
          END  AS GIOITINH,
          BN.NAMSINH,
          CONVERT(varchar(12), BN.NGAYSINH, 103) as NGAYSINH,
          DT.TENDOITUONG,
          BN.DIACHILIENLAC as DIACHI,
          TT.TIEPNHAN_ID,
          TT.KHAMBENH_ID as KHAMBENH_TOATHUOC_ID,
          TT.SOTHUTUTOA,
          TT.PHAMVI_ID,
          KB.PHONGBAN_ID,
          KB.BACSIKHAM_ID,
          CONVERT(VARCHAR(30), KB.THOIGIANKHAM, 103) + ' ' + CONVERT(VARCHAR(30), KB.THOIGIANKHAM, 108) as THOIGIANRATOA,
          CASE
          WHEN TT.TRANGTHAI	= 'CHUAXUAT'  THEN NULL
          WHEN TT.TRANGTHAI	= 'DADUYET'  THEN KB.NGUOICAPNHAT_ID
          END  AS NGUOIDUYET_ID,
          null as NGAYDUYET,
          CASE
          WHEN TT.TRANGTHAI	= 'CHUAXUAT'  THEN NULL
          WHEN TT.TRANGTHAI	= 'DADUYET'  THEN KB.NGAYCAPNHAT
          END  AS THOIGIANDUYET,
          TT.TRANGTHAI AS TRANGTHAI,
          TT.CHUNGTU_ID as CHUNGTUPHATTHUOC_ID,
          '' AS LYDOHUY,
          'NOITRU' as MALOAITOA,
          N'Nội trú ra viện' as TENLOAITOA,          

          CASE
          WHEN TT.TRANGTHAI	= 'DAXUAT'  THEN N'Đã xuất'
          ELSE N'Chưa xuất' END
          AS TRANGTHAI_TOA,
          NULL AS TRANGTHAI_HD
          
          FROM
          TT_BENHNHAN BN,
          TT_NOITRU_KHAMBENH KB,
          TT_NOITRU_TOATHUOC TT,
          TT_NOITRU_BENHAN BA,
          TM_DOITUONG DT
          WHERE
          KB.KHAMBENH_ID = TT.KHAMBENH_ID
          AND BA.BENHAN_ID = KB.BENHAN_ID
          AND BA.BENHNHAN_ID = BN.BENHNHAN_ID
          AND BA.KHOAVAO_ID is NULL
          <!--AND BA.LOAIBENHAN = 2 BENH AN NGOAI TRU-->
          AND BA.DOITUONG_ID = DT.DOITUONG_ID
          AND KB.ISTHUOCBV = '$ISTHUOCBV$'
          AND KB.RAVIEN = '1'
          AND TT.HUYTOATHUOC = '0'
          <!--AND TT.KHOPHAT_ID = '$KHOXUAT_ID$'-->
          <isNotEmpty prepend="and" property="PHAMVI_ID">
            TT.PHAMVI_ID = '$PHAMVI_ID$'
          </isNotEmpty>
          and TT.BENHVIEN_ID = '$BENHVIEN_ID$'
          <isNotEmpty prepend="and" property="TRANGTHAI_CHUAXUAT">
                TT.TRANGTHAI	= '$TRANGTHAI_CHUAXUAT$'
            </isNotEmpty>
            <isNotEmpty prepend="and" property="TRANGTHAI_DAXUAT">
                TT.TRANGTHAI	!= 'CHUAXUAT'
            </isNotEmpty>            
            AND CONVERT(date, KB.NGAYKHAM) BETWEEN CONVERT(date, '$TUNGAY$')  AND  CONVERT(date, '$DENNGAY$')
            AND (TT.SOTHUTUTOA LIKE '%$KEYWORD$%' or BN.TENBENHNHAN LIKE N'%$KEYWORD$%'  or BN.MAYTE LIKE N'%$KEYWORD$%' or BN.SOVAOVIEN LIKE N'%$KEYWORD$%')
        </statement>

        <!--Revision:0-->
        <statement id="DAO00030_TOATHUOC_NGOAITRU_ChiTiet" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
            SELECT
            Convert(varchar(12), KB.NGAYKHAM, 103) as NGAYKHAM,
            KB.BACSIKHAM_ID,
            KB.PHONGBAN_ID,
            KB.CHANDOANKHOAKHAM,
            TT.DUOC_ID,
            TT.SOLUONG,
            TT.SONGAY,
            TT.SOLUONG_BUOISANG,
            TT.SOLUONG_BUOITRUA,
            TT.SOLUONG_BUOICHIEU,
            TT.SOLUONG_BUOITOI,
            TT.GHICHU
            FROM
            TT_NGOAITRU_KHAMBENH KB,
            TT_NGOAITRU_KHAMBENH_TOATHUOC KBTT,
            TT_NGOAITRU_TOATHUOC TT
            WHERE
            KB.KHAMBENH_ID = KBTT.KHAMBENH_ID
            AND KBTT.KHAMBENH_TOATHUOC_ID = TT.KHAMBENH_TOATHUOC_ID
            AND TT.KHAMBENH_TOATHUOC_ID = '$KHAMBENH_TOATHUOC_ID$'
            and KB.BENHVIEN_ID = '$BENHVIEN_ID$'
        </statement>
        <!--Revision:0-->
        <statement id="DAO00030_TOATHUOC_NOITRU_ChiTiet" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
            SELECT
            Convert(varchar(12), KB.NGAYKHAM, 103) as NGAYKHAM,
            KB.BACSIKHAM_ID,
            LT.PHONGBAN_ID,
            KB.DINHBENH as CHANDOANKHOAKHAM,
            TT.DUOC_ID,
            TT.SOLUONG,
            TT.SONGAY,
            TT.SOLUONG_BUOISANG,
            TT.SOLUONG_BUOITRUA,
            TT.SOLUONG_BUOICHIEU,
            TT.SOLUONG_BUOITOI,
            TT.GHICHU
            FROM
            TT_NOITRU_KHAMBENH KB,
            TT_NOITRU_TOATHUOC TT,
            TT_NOITRU_LUUTRU LT
            WHERE
            KB.KHAMBENH_ID = TT.KHAMBENH_ID
            AND KB.KHAMBENH_ID = TT.KHAMBENH_ID
            AND KB.LUUTRU_ID = LT.LUUTRU_ID
            AND KB.KHAMBENH_ID = '$KHAMBENH_TOATHUOC_ID$'
            and KB.BENHVIEN_ID = '$BENHVIEN_ID$'
        </statement>
        <!--Revision:0-->
        <statement id="DAO00030_TT_NGOAITRU_TOATHUOC_GetList" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
            select *
            from TT_NGOAITRU_TOATHUOC
            <dynamic prepend="where">
                <isParameterPresent>
                    <isNotEmpty prepend="and" property="TOATHUOC_ID">
                        TT_NGOAITRU_TOATHUOC.TOATHUOC_ID = '$TOATHUOC_ID$'
                    </isNotEmpty>
                    <isNotEmpty prepend="and" property="KHAMBENH_TOATHUOC_ID">
                        TT_NGOAITRU_TOATHUOC.KHAMBENH_TOATHUOC_ID = '$KHAMBENH_TOATHUOC_ID$'
                    </isNotEmpty>                                       
                </isParameterPresent>
            </dynamic>
            order by TOATHUOC_ID
        </statement>
        <statement id="DAO00030_TOATHUOC_KiemTraToaThuocBHYTDaHuyBooking" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
          select distinct tt.SOTHUTUTOA
          from
          TT_NGOAITRU_TOATHUOC tt
          join TT_DUOC_TONKHO_BOOK_NGOAITRU bk on bk.REF_ID = tt.TOATHUOC_ID and bk.REF_TABLE = 'TT_NGOAITRU_TOATHUOC'
          where
          tt.TIEPNHAN_ID = $TIEPNHAN_ID$
          and (bk.TRANGTHAI != 'HIEULUC' or bk.SOLUONG = 0)
          and bk.BENHVIEN_ID = '$BENHVIEN_ID$'
        </statement>
        <!--Revision:0-->
        <update id="DAO00030_NGOAITRU_TOATHUOC_DUYET" parameterClass="System.Collections.IDictionary">
            update
            TT_NGOAITRU_KHAMBENH_TOATHUOC
            set
            DUYET = #DUYET#
            , NGAYDUYET = #NGAYDUYET#
            , THOIGIANDUYET = #THOIGIANDUYET#
            , NGUOIDUYET_ID = #NGUOIDUYET_ID#
            , LYDOHUY = #LYDOHUY#
            where
            KHAMBENH_TOATHUOC_ID = '$KHAMBENH_TOATHUOC_ID$'
            update
            TT_VIENPHI
            set
            DUYET = '$DUYET$'
            FROM
            TT_VIENPHI VP, TT_NGOAITRU_KHAMBENH_TOATHUOC KBTT, TT_NGOAITRU_TOATHUOC TT
            WHERE
            TT.KHAMBENH_TOATHUOC_ID = KBTT.KHAMBENH_TOATHUOC_ID
            AND TT.TOATHUOC_ID = VP.REF_ID
            AND KBTT.KHAMBENH_TOATHUOC_ID = '$KHAMBENH_TOATHUOC_ID$'
            AND VP.REF_TABLE = 'TT_NGOAITRU_TOATHUOC'
        </update>
        <!--Revision:0-->
        <update id="DAO00030_NGOAITRU_TOATHUOC_DUYET_TUDONG" parameterClass="System.Collections.IDictionary">
            update
            TT_NGOAITRU_KHAMBENH_TOATHUOC
            set
            DUYET = #DUYET#
            , NGAYDUYET = #NGAYDUYET#
            , THOIGIANDUYET = #THOIGIANDUYET#
            , NGUOIDUYET_ID = #NGUOIDUYET_ID#
            , LYDOHUY = #LYDOHUY#
            where
            TIEPNHAN_ID = '$TIEPNHAN_ID$' and LOAITOATHUOC ='BV'
            update
            TT_VIENPHI
            set
            DUYET = '$DUYET$'
            FROM
            TT_VIENPHI VP
            WHERE
            VP.TIEPNHAN_ID = '$TIEPNHAN_ID$'
            AND VP.REF_TABLE = 'TT_NGOAITRU_TOATHUOC'
        </update>
        <!--Revision:0-->
        <update id="DAO00030_NOITRU_TOATHUOC_DUYET" parameterClass="System.Collections.IDictionary">
            update
            TT_NOITRU_TOATHUOC
            set
            TRANGTHAI = #DUYET#
            , NGAYCAPNHAT = #NGAYDUYET#
            , NGUOICAPNHAT_ID = #NGUOIDUYET_ID#
            , GHICHU = #LYDOHUY#
            where
            KHAMBENH_ID = '$KHAMBENH_TOATHUOC_ID$'
            
            update
            TT_VIENPHI
            set
            DUYET = '$VP_DUYET$'
            FROM
            TT_VIENPHI VP, TT_NOITRU_KHAMBENH KB, TT_NOITRU_TOATHUOC TT
            WHERE
            TT.KHAMBENH_ID = KB.KHAMBENH_ID
            AND TT.TOATHUOC_ID = VP.REF_ID
            AND KB.KHAMBENH_ID = '$KHAMBENH_TOATHUOC_ID$'
            AND VP.REF_TABLE = 'TT_NOITRU_TOATHUOC'
            and VP.BENHVIEN_ID = '$BENHVIEN_ID$'
        </update>
        <!--Revision:0-->
        <statement id="DAO00030_TOATHUOC_GetDanhSachThuoc" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
          select  tt.TOATHUOC_ID, kbtt.KHAMBENH_ID, tt.KHAMBENH_TOATHUOC_ID, tt.DUOC_ID, tt.NGUONHANG_ID, sum(tt.SOLUONG) as SOLUONG
          from
          TT_NGOAITRU_TOATHUOC tt
          inner join TT_NGOAITRU_KHAMBENH_TOATHUOC kbtt on kbtt.KHAMBENH_TOATHUOC_ID = tt.KHAMBENH_TOATHUOC_ID
          where
          tt.KHAMBENH_TOATHUOC_ID  IN ($LIST_KHAMBENH_TOATHUOC_ID$)
          and tt.BENHVIEN_ID = '$BENHVIEN_ID$'
          group by tt.TOATHUOC_ID, kbtt.KHAMBENH_ID, tt.KHAMBENH_TOATHUOC_ID, tt.DUOC_ID, tt.NGUONHANG_ID
        </statement>
        <!--Revision:0-->
        <statement id="DAO00030_TOATHUOC_GetDanhSachThuocChuaDuyet" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
          select TT.TOATHUOC_ID, kbtt.KHAMBENH_ID, TT.KHAMBENH_TOATHUOC_ID, TT.DUOC_ID, D.TENDUOCDAYDU, D.DONVITINH, TT.SOLUONG
          from
          TT_NGOAITRU_TOATHUOC TT
          INNER JOIN TT_NGOAITRU_KHAMBENH_TOATHUOC KBTT on TT.KHAMBENH_TOATHUOC_ID = KBTT.KHAMBENH_TOATHUOC_ID
          INNER JOIN TM_DUOC D on D.DUOC_ID = TT.DUOC_ID
          where
          TT.KHAMBENH_TOATHUOC_ID  IN ($LIST_KHAMBENH_TOATHUOC_ID$)
          and KBTT.DUYET = '0'
          and TT.BENHVIEN_ID = '$BENHVIEN_ID$'
        </statement>
        <statement id="DAO00030_TOATHUOC_GetDanhSachThuocNoiTruChuaDuyet" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
          select TT.TOATHUOC_ID, TT.DUOC_ID, D.TENDUOCDAYDU, D.DONVITINH, TT.SOLUONG
          from
          TT_NOITRU_TOATHUOC TT
          LEFT JOIN TM_DUOC D on D.DUOC_ID = TT.DUOC_ID
          where
          TT.TOATHUOC_ID  IN ($LIST_TOATHUOC_ID$)
          and TT.TRANGTHAI = 'CHUAXUAT'
          and TT.BENHVIEN_ID = '$BENHVIEN_ID$'
        </statement>
        <!--Revision:0-->
        <statement id="DAO00030_TOATHUOC_GetDanhSachThuoc_VP" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
            select  DUOC_ID, KHAMBENH_ID, sum(SOLUONG) as SOLUONG
            from
            TT_NGOAITRU_TOATHUOC
            where
            KHAMBENH_TOATHUOC_ID  IN ($LIST_KHAMBENH_TOATHUOC_ID$)
            and BENHVIEN_ID = '$BENHVIEN_ID$'
            group by DUOC_ID, KHAMBENH_ID
        </statement>
        <!--Revision:0-->
        <statement id="DAO00030_NOITRU_TOATHUOC_GetDanhSachThuoc" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
            select  TOATHUOC_ID, DUOC_ID, sum(SOLUONG) as SOLUONG
            from
            TT_NOITRU_TOATHUOC
            where
            SOTHUTUTOA  IN ($LIST_SOTHUTUTOA$)
            and BENHVIEN_ID = '$BENHVIEN_ID$'
            group by  TOATHUOC_ID, DUOC_ID
        </statement>
        <statement id="DAO00030_NOITRU_TOARAVIEN_GetDanhSachThuoc" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
          select  TOATHUOC_ID, DUOC_ID, NGUONDUOC_ID, sum(SOLUONG) as SOLUONG
          from
          TT_NOITRU_TOATHUOC
          where
          TOATHUOC_ID  IN ($LIST_TOATHUOC_ID$)
          and BENHVIEN_ID = '$BENHVIEN_ID$'
          group by  TOATHUOC_ID, DUOC_ID, NGUONDUOC_ID
        </statement>
        <!--Revision:0-->
        <statement id="DAO00030_NOITRU_TOATHUOC_GetDanhSachThuoc_VP" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
            select  DUOC_ID, KHAMBENH_ID, sum(SOLUONG) as SOLUONG
            from
            TT_NOITRU_TOATHUOC
            where
            TOATHUOC_ID  IN ($LIST_TOATHUOC_ID$)
            and BENHVIEN_ID = '$BENHVIEN_ID$'
            group by DUOC_ID, KHAMBENH_ID
        </statement>
        <!--Revision:0-->
        <statement id="DAO00030_TOATHUOC_GetThongTinDaDuyet" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
          SELECT
          KB.TIEPNHAN_ID,
          KB.KHAMBENH_ID,
          KBTT.KHAMBENH_TOATHUOC_ID,
          KBTT.SOTHUTUTOA,
          KBTT.NGAYTOATHUOC,
          CASE
          WHEN KBTT.LOAITOATHUOC = 'BV' THEN N'Bệnh viện'
          WHEN KBTT.LOAITOATHUOC = 'MN' THEN N'Mua ngoài'
          WHEN KBTT.LOAITOATHUOC = 'TV' THEN N'Tư vấn'
          WHEN KBTT.LOAITOATHUOC = 'MP' THEN N'Miễn phí'
          END  AS LOAITOATHUOC,
          KB.PHONGBAN_ID,
          KB.BACSIKHAM_ID,
          KB.CHUYENKHOA_ID
          FROM
          TT_NGOAITRU_KHAMBENH KB
          inner join TT_NGOAITRU_KHAMBENH_TOATHUOC KBTT on KB.KHAMBENH_ID = KBTT.KHAMBENH_ID
          WHERE
          KB.TIEPNHAN_ID = '$TIEPNHAN_ID$'                   
          <isEqual prepend = "AND" property="LOAITOATHUOC" compareValue="MN">
             (KBTT.LOAITOATHUOC = 'MN' or KBTT.LOAITOATHUOC = 'TV')
          </isEqual>
          <isNotEqual prepend="AND" property="LOAITOATHUOC" compareValue="MN">
             KBTT.LOAITOATHUOC = '$LOAITOATHUOC$'
          </isNotEqual>
          AND KBTT.TRANGTHAI = '$TRANGTHAI$'
          AND KBTT.DUYET = '1'
          and KB.BENHVIEN_ID = '$BENHVIEN_ID$'
          <isNotEmpty prepend="and" property="CHUNGTUPHATTHUOC_ID">
                KBTT.CHUNGTUPHATTHUOC_ID = '$CHUNGTUPHATTHUOC_ID$'
            </isNotEmpty>
          <isNotEmpty prepend="and" property="PHAMVI_ID">
            KBTT.PHAMVI_ID = '$PHAMVI_ID$'
          </isNotEmpty>
            <!--<isEqual prepend="and" property="LOAITOATHUOC" compareValue="BV">
                KBTT.KHOXUAT_ID = #KHOXUAT_ID#
            </isEqual>-->
        </statement>
        <!--Revision:0-->
        <statement id="DAO00030_TOATHUOC_RAVIEN_GetThongTinDaDuyet" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
          select
          distinct
          TT.TOATHUOC_ID,
          TT.SOTHUTUTOA,
          BA.TIEPNHAN_ID,
          KB.KHAMBENH_ID,
          KB.BACSIKHAM_ID,
          BA.KHOACHUYENDEN_ID,
          PB.TENPHONGBAN,
          TT.NGAYTAO as NGAYTOATHUOC
          from
          TT_NOITRU_KHAMBENH KB
          inner join TT_NOITRU_BENHAN BA on BA.BENHAN_ID = KB.BENHAN_ID
          inner join TT_NOITRU_TOATHUOC TT on KB.KHAMBENH_ID = TT.KHAMBENH_ID
          inner join TM_PHONGBAN pb on pb.PHONGBAN_ID = isnull(ba.KHOAVAO_ID, ba.KHOACHUYENDEN_ID)
          where
          BA.TIEPNHAN_ID = '$TIEPNHAN_ID$'
          AND KB.RAVIEN = '1'
          <!--AND TT.KHOPHAT_ID =  #KHOXUAT_ID#-->
          <isNotEmpty prepend="and" property="PHAMVI_ID">
            TT.PHAMVI_ID = '$PHAMVI_ID$'
          </isNotEmpty>
            AND TT.TRANGTHAI =  #TRANGTHAI#
            AND BA.BENHVIEN_ID = '$BENHVIEN_ID$'
            <isNotEmpty prepend="and" property="CHUNGTU_ID">
                TT.CHUNGTU_ID = '$CHUNGTU_ID$'
            </isNotEmpty>
        </statement>
        <statement id="DAO00030_TOATHUOC_GetDanhSachThuocTheoTiepNhan" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
          SELECT
          KB.TIEPNHAN_ID,
          KB.KHAMBENH_ID,
          KBTT.KHAMBENH_TOATHUOC_ID,
          KBTT.SOTHUTUTOA,
          KBTT.NGAYTOATHUOC,
          CASE
          WHEN KBTT.LOAITOATHUOC = 'BV' THEN N'Bệnh viện'
          WHEN KBTT.LOAITOATHUOC = 'MN' THEN N'Mua ngoài'
          WHEN KBTT.LOAITOATHUOC = 'TV' THEN N'Tư vấn'
          WHEN KBTT.LOAITOATHUOC = 'MP' THEN N'Miễn phí'
          END  AS LOAITOATHUOC,
          KB.PHONGBAN_ID,
          KB.BACSIKHAM_ID,
          KB.CHUYENKHOA_ID
          FROM
          TT_NGOAITRU_KHAMBENH KB
          inner join TT_NGOAITRU_KHAMBENH_TOATHUOC KBTT on KB.KHAMBENH_ID = KBTT.KHAMBENH_ID
          WHERE
          KB.TIEPNHAN_ID = '$TIEPNHAN_ID$'
          and KB.BENHVIEN_ID = '$BENHVIEN_ID$'
          <isEqual prepend = "AND" property="LOAITOATHUOC" compareValue="MN">
             (KBTT.LOAITOATHUOC = 'MN' or KBTT.LOAITOATHUOC = 'TV')
          </isEqual>
          <isNotEqual prepend="AND" property="LOAITOATHUOC" compareValue="MN">
             KBTT.LOAITOATHUOC = '$LOAITOATHUOC$'
          </isNotEqual>
          <isNotEmpty prepend="and" property="TRANGTHAI">
            AND KBTT.TRANGTHAI = '$TRANGTHAI$'
          </isNotEmpty>               
          <isNotEmpty prepend="and" property="CHUNGTUPHATTHUOC_ID">
                KBTT.CHUNGTUPHATTHUOC_ID = '$CHUNGTUPHATTHUOC_ID$'
            </isNotEmpty>
          <isNotEmpty prepend="and" property="PHAMVI_ID">
            KBTT.PHAMVI_ID = '$PHAMVI_ID$'
          </isNotEmpty>          
        </statement>
        <!--Revision:0-->
        <update id="DAO00030_Update_ToaThuocChungTuAdd" parameterClass="System.Collections.IDictionary">
          update
          TT_NGOAITRU_KHAMBENH_TOATHUOC
          set
          CHUNGTUPHATTHUOC_ID = #CHUNGTUPHATTHUOC_ID#
          ,TRANGTHAI = '$TRANGTHAI$'
          <isNotEmpty prepend="," property="DUYET">
            DUYET = '$DUYET$'
          </isNotEmpty>
          where
          KHAMBENH_TOATHUOC_ID = '$KHAMBENH_TOATHUOC_ID$'
        </update>
        <update id="DAO00030_Update_ChungTuToaThuocNgoaiTru" parameterClass="System.Collections.IDictionary">
          update
          TT_NGOAITRU_KHAMBENH_TOATHUOC
          set
          CHUNGTUPHATTHUOC_ID = #CHUNGTUPHATTHUOC_ID#
          ,TRANGTHAI = '$TRANGTHAI$'
          <isNotEmpty prepend="," property="DUYET">
            DUYET = '$DUYET$'
          </isNotEmpty>
          where
          KHAMBENH_TOATHUOC_ID = '$KHAMBENH_TOATHUOC_ID$'
        </update>
        <!--Revision:0-->
        <update id="DAO00030_Update_ToaThuocChungTuRemove" parameterClass="System.Collections.IDictionary">
          update
          TT_NGOAITRU_KHAMBENH_TOATHUOC
          set
          CHUNGTUPHATTHUOC_ID = null
          ,TRANGTHAI = 'CHUAXUAT'
          <isNotEmpty prepend="," property="DUYET">
           DUYET = '$DUYET$'
          </isNotEmpty>
            where
            KHAMBENH_TOATHUOC_ID = '$KHAMBENH_TOATHUOC_ID$'
        </update>
      <update id="DAO00030_Remove_ChungTuToaThuocNgoaiTru" parameterClass="System.Collections.IDictionary">
        update
        TT_NGOAITRU_KHAMBENH_TOATHUOC
        set
        CHUNGTUPHATTHUOC_ID = null
        ,TRANGTHAI = 'CHUAXUAT'
        <isNotEmpty prepend="," property="DUYET">
          DUYET = '$DUYET$'
        </isNotEmpty>
        where
        KHAMBENH_TOATHUOC_ID = '$KHAMBENH_TOATHUOC_ID$'
      </update>
        <update id="DAO00030_Update_VienPhiThucHien" parameterClass="System.Collections.IDictionary">          
          UPDATE TT_VIENPHI
          set DATHUCHIEN = '$DATHUCHIEN$'
          WHERE VIENPHI_ID in
          (
          select vp.VIENPHI_ID from TT_VIENPHI vp
          inner join TT_NGOAITRU_TOATHUOC tt on (tt.TOATHUOC_ID = vp.REF_ID and vp.REF_TABLE = 'TT_NGOAITRU_TOATHUOC')
          where
          tt.KHAMBENH_TOATHUOC_ID = '$KHAMBENH_TOATHUOC_ID$'
          )
        </update>
        <!--Revision:0-->
        <update id="DAO00030_Update_NoiTru_ToaThuocChungTuAdd" parameterClass="System.Collections.IDictionary">
            update
            TT_NOITRU_TOATHUOC
            set
            CHUNGTU_ID = #CHUNGTU_ID#
            ,TRANGTHAI = '$TRANGTHAI$'
            where
            TOATHUOC_ID = '$TOATHUOC_ID$'
        </update>
        <!--Revision:0-->
        <update id="DAO00030_Update_NoiTru_ToaThuocChungTuRemove" parameterClass="System.Collections.IDictionary">
            update
            TT_NOITRU_TOATHUOC
            set
            CHUNGTU_ID = null
            ,TRANGTHAI = 'DADUYET'
            where
            TOATHUOC_ID = '$TOATHUOC_ID$'
        </update>
        <!--Revision:0-->
        <statement id="DAO00030_KTDaThanhToanVP" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
            SELECT
            HOADON_ID
            FROM
            TT_VIENPHI
            WHERE
            REF_ID ='$REF_ID$'
            AND REF_TABLE = '$REF_TABLE$'
            AND HOADON_ID is not NULL
            and BENHVIEN_ID = '$BENHVIEN_ID$'
        </statement>
        <!--Revision:0-->
        <statement id="DAO00030_KTDaPhatSinhPhieuBHTN" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
            SELECT vp.VIENPHI_ID
            FROM TT_VIENPHI vp
            INNER JOIN TT_MIENGIAM_CHITIET  mgct on mgct.VIENPHI_ID = vp.VIENPHI_ID
            INNER JOIN TT_DUOC_CHUNGTU ct on ct.TIEPNHAN_ID = vp.TIEPNHAN_ID
            WHERE
            ct.CHUNGTU_ID = '$CHUNGTU_ID$'
            AND vp.DUOC_ID is not null
            AND vp.BENHVIEN_ID = '$BENHVIEN_ID$'
        </statement>
        <!--Revision:0-->
        <statement id="DAO00030_KTDaPhatSinhBienLai" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
          SELECT CHUNGTU_ID
          FROM TT_NOITRU_TOATHUOC tt
          INNER JOIN TT_VIENPHI vp on (tt.TOATHUOC_ID = vp.REF_ID and REF_TABLE = 'TT_NOITRU_TOATHUOC')
          WHERE
          CHUNGTU_ID = '$CHUNGTU_ID$'
          AND tt.BENHVIEN_ID = '$BENHVIEN_ID$'
          AND HOADON_ID is not NULL
          AND vp.HUY = '0'

          union all
          SELECT  kbtt.CHUNGTUPHATTHUOC_ID as CHUNGTU_ID
          FROM TT_NGOAITRU_TOATHUOC tt
          INNER JOIN TT_NGOAITRU_KHAMBENH_TOATHUOC kbtt on (kbtt.KHAMBENH_TOATHUOC_ID = tt.KHAMBENH_TOATHUOC_ID)
          INNER JOIN TT_VIENPHI vp on (tt.TOATHUOC_ID = vp.REF_ID and REF_TABLE = 'TT_NGOAITRU_TOATHUOC')
          WHERE
          kbtt.CHUNGTUPHATTHUOC_ID = '$CHUNGTU_ID$'
          AND tt.BENHVIEN_ID = '$BENHVIEN_ID$'
          AND HOADON_ID is not NULL
          AND vp.HUY = '0'

          union all
          SELECT ctct.CHUNGTU_ID from
          TT_DUOC_CHUNGTU_CHITIET ctct
          INNER JOIN TT_HOADON_CHITIET_NGOAITRU hdct on (hdct.REF_ID = ctct.CHUNGTUCHITIET_ID and hdct.REF_TABLE = 'TT_DUOC_CHUNGTU_CHITIET')
          INNER JOIN TT_HOADON hd on hd.HOADON_ID = hdct.HOADON_ID
          WHERE
          ctct.CHUNGTU_ID = '$CHUNGTU_ID$'
          <isEqual prepend="" property="XOAKHIHUYHOADON" compareValue="1">
            AND hd.HUYHOADON = '0'
            AND hd.HOANTRA = '0'
          </isEqual>         
          AND ctct.BENHVIEN_ID = '$BENHVIEN_ID$'
          
          union all
          SELECT CHUNGTU_ID
          FROM TT_NGOAITRU_KHAMBENH_VTYT tt
          INNER JOIN TT_VIENPHI vp on (tt.KHAMBENH_VTYT_ID = vp.REF_ID and REF_TABLE = 'TT_NGOAITRU_KHAMBENH_VTYT')
          WHERE
          CHUNGTU_ID = '$CHUNGTU_ID$'
          AND tt.BENHVIEN_ID = '$BENHVIEN_ID$'
          AND HOADON_ID is not NULL
          AND vp.HUY = '0'
          
          union all
          SELECT CHUNGTU_ID
          FROM TT_PHAUTHUAT_VTYT tt
          INNER JOIN TT_VIENPHI vp on (tt.PHAUTHUAT_VTYT_ID = vp.REF_ID and REF_TABLE = 'TT_PHAUTHUAT_VTYT')
          WHERE
          CHUNGTU_ID = '$CHUNGTU_ID$'
          AND tt.BENHVIEN_ID = '$BENHVIEN_ID$'
          AND HOADON_ID is not NULL
          AND vp.HUY = '0'
          
          union all
          SELECT CHUNGTU_ID
          FROM TT_CLSKETQUA_VTYT tt
          INNER JOIN TT_VIENPHI vp on (tt.CLSKETQUA_VTYT_ID = vp.REF_ID and REF_TABLE = 'TT_CLSKETQUA_VTYT')
          WHERE
          CHUNGTU_ID = '$CHUNGTU_ID$'
          AND tt.BENHVIEN_ID = '$BENHVIEN_ID$'
          AND HOADON_ID is not NULL
          AND vp.HUY = '0'
        </statement>
        <!--Revision:0-->
        <statement id="DAO00030_DUOC_SOLONHAP_GIABAN_GetAll" resultClass="DataObject">
            select *
            from TT_DUOC_SOLONHAP_GIABAN
            WHERE BENHVIEN_ID = '$BENHVIEN_ID$'
            order by DUOCSOLONHAPGIABAN_ID
        </statement>
        <!--Revision:0-->
        <statement id="DAO00030_DUOC_SOLONHAP_GIABAN_GetList" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
            select *
            from TT_DUOC_SOLONHAP_GIABAN
            <dynamic prepend="where">
                <isParameterPresent>
                    <isNotEmpty prepend="and" property="DUOCSOLONHAPGIABAN_ID">
                        TT_DUOC_SOLONHAP_GIABAN.DUOCSOLONHAPGIABAN_ID = '$DUOCSOLONHAPGIABAN_ID$'
                    </isNotEmpty>
                    <isNotEmpty prepend="and" property="SOLONHAP_ID">
                        TT_DUOC_SOLONHAP_GIABAN.SOLONHAP_ID = '$SOLONHAP_ID$'
                    </isNotEmpty>
                    <isNotEmpty prepend="and" property="DUOC_ID">
                        TT_DUOC_SOLONHAP_GIABAN.DUOC_ID = '$DUOC_ID$'
                    </isNotEmpty>
                    <isNotEmpty prepend="and" property="BENHVIEN_ID">
                        TT_DUOC_SOLONHAP_GIABAN.BENHVIEN_ID = '$BENHVIEN_ID$'
                    </isNotEmpty>
                </isParameterPresent>
            </dynamic>
            order by DUOCSOLONHAPGIABAN_ID
        </statement>
        <!--Revision:0-->
        <statement id="DAO00030_DUOC_SOLONHAP_GIABAN_GetDetail" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
            select *
            from TT_DUOC_SOLONHAP_GIABAN
            where TT_DUOC_SOLONHAP_GIABAN.DUOCSOLONHAPGIABAN_ID  = '$value$'
            and BENHVIEN_ID = '$BENHVIEN_ID$'
            order by DUOCSOLONHAPGIABAN_ID
        </statement>
        <!--Revision:0-->
        <statement id="DAO00030_DUOC_SOLONHAP_GIABAN_GetDetailP" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
            select *
            from TT_DUOC_SOLONHAP_GIABAN
            where TT_DUOC_SOLONHAP_GIABAN.DUOCSOLONHAPGIABAN_ID  = '$DUOCSOLONHAPGIABAN_ID$'
            and BENHVIEN_ID = '$BENHVIEN_ID$'
            order by DUOCSOLONHAPGIABAN_ID
        </statement>
        <!--Revision:0-->
        <statement id="DAO00030_DUOC_SOLONHAP_GIABAN_Add" parameterClass="System.Collections.IDictionary" resultClass="System.Int64">
          insert into TT_DUOC_SOLONHAP_GIABAN (
          SOLONHAP_ID
          , DUOC_ID
          , DONGIAMUA
          , DONGIAVON
          , TYLEVAT_DAUVAO
          , DONGIAVONVAT
          , DONGIABAN
          , DONGIABANVAT_DAUVAO
          , BENHVIEN_ID
          , NGUOITAO_ID
          , NGAYTAO
          ) values (
          #SOLONHAP_ID#
          , #DUOC_ID#
          , #DONGIAMUA#
          , #DONGIAVON#
          , #TYLEVAT_DAUVAO#
          , #DONGIAVONVAT#
          , #DONGIABAN#
          , #DONGIABANVAT_DAUVAO#
          , #BENHVIEN_ID#
          , #NGUOITAO_ID#
          , #NGAYTAO#
          )
        </statement>
        <!--Revision:0-->
        <update id="DAO00030_DUOC_SOLONHAP_GIABAN_Update" parameterClass="System.Collections.IDictionary">
            update TT_DUOC_SOLONHAP_GIABAN set
            SOLONHAP_ID = #SOLONHAP_ID#
            , DUOC_ID = #DUOC_ID#
            , DONGIAMUA = #DONGIAMUA#
            , DONGIAVON = #DONGIAVON#
            , TYLEVAT_DAUVAO = #TYLEVAT_DAUVAO#
            , DONGIAVONVAT = #DONGIAVONVAT#
            , DONGIABAN = #DONGIABAN#
            , DONGIABANVAT_DAUVAO = #DONGIABANVAT_DAUVAO#
            , BENHVIEN_ID = #BENHVIEN_ID#
            where
            DUOCSOLONHAPGIABAN_ID = '$DUOCSOLONHAPGIABAN_ID$'
        </update>
        <!--Revision:0-->
        <statement id="DAO00030_DUOC_SOLONHAP_GIABAN_Delete" parameterClass="System.Collections.IDictionary" resultClass="System.Int32">
            delete from TT_DUOC_SOLONHAP_GIABAN
            where
            DUOCSOLONHAPGIABAN_ID = '$DUOCSOLONHAPGIABAN_ID$'
        </statement>
        <!--Revision:0-->
        <statement id="DAO00030_DUOC_SOLONHAP_GIABAN_DeleteP" parameterClass="System.Collections.IDictionary" resultClass="System.Int32">
            delete from TT_DUOC_SOLONHAP_GIABAN
            <dynamic prepend="where">
                <isParameterPresent>
                    <isNotEmpty prepend="and" property="DUOCSOLONHAPGIABAN_ID">
                        TT_DUOC_SOLONHAP_GIABAN.DUOCSOLONHAPGIABAN_ID = '$DUOCSOLONHAPGIABAN_ID$'
                    </isNotEmpty>
                    <isNotEmpty prepend="and" property="SOLONHAP_ID">
                        TT_DUOC_SOLONHAP_GIABAN.SOLONHAP_ID = '$SOLONHAP_ID$'
                    </isNotEmpty>                  
                </isParameterPresent>
            </dynamic>
        </statement>
        <!--Revision:0-->
        <update id="DAO00030_DUOC_SOVISA_Upd" parameterClass="System.Collections.IDictionary">
            update TM_DUOC set
            SOVISA = #SOVISA#,
            NGAYCAPNHAT = '$NGAYCAPNHAT$',
            NGUOICAPNHAT_ID = #NGUOICAPNHAT_ID#
            where
            DUOC_ID = '$DUOC_ID$'
            and BENHVIEN_ID = '$BENHVIEN_ID$'
        </update>
        <!--Revision:0-->
        <statement id="DAO00030_DUOC_SODANGKY_Get" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
            select *
            from TM_DUOC_SODANGKY
            where TM_DUOC_SODANGKY.DUOC_ID  = '$DUOC_ID$'
            and  HIEULUC = '1'
            and BENHVIEN_ID = '$BENHVIEN_ID$'
            order by DUOC_ID
        </statement>
        <!--Revision:0-->
        <statement id="DAO00030_TT_DUOC_KYTONKHO_GetAll" resultClass="DataObject">
            select *
            from TT_DUOC_KYTONKHO
            BENHVIEN_ID = '$BENHVIEN_ID$'
            order by DUOCKYTONKHO_ID
        </statement>
        <!--Revision:0-->
        <statement id="DAO00030_TT_DUOC_KYTONKHO_GetList" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
            select *
            from TT_DUOC_KYTONKHO
            <dynamic prepend="where">
                <isParameterPresent>
                    <isNotEmpty prepend="and" property="DUOCKYTONKHO_ID">
                        TT_DUOC_KYTONKHO.DUOCKYTONKHO_ID = '$DUOCKYTONKHO_ID$'
                    </isNotEmpty>
                    <isNotEmpty prepend="and" property="MAKYTONKHO">
                        TT_DUOC_KYTONKHO.MAKYTONKHO = '$MAKYTONKHO$'
                    </isNotEmpty>                
                </isParameterPresent>
            </dynamic>
            order by DUOCKYTONKHO_ID
        </statement>
      <statement id="DAO00030_TT_DUOC_KYTONKHO_GetByKhoDuoc" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
        select distinct ktk.DUOCKYTONKHO_ID, MAKYTONKHO, THANG, NAM, KHOASO, HOIDONG_ID,
        cast(dkk.KIEMKETUNGAY as DATE) AS TUNGAY, cast(dkk.KIEMKEDENNGAY as DATE) AS DENNGAY
        from TT_DUOC_KYTONKHO ktk
        inner join TT_DUOC_KIEMKE dkk on ktk.DUOCKYTONKHO_ID = dkk.DUOCKYKIEMKE_ID
        where ktk.MAKYTONKHO = '$MAKYTONKHO$'
        and dkk.KHODUOC_ID = '$KHODUOC_ID$'
        order by DUOCKYTONKHO_ID desc
      </statement>
        <!--Revision:0-->
        <statement id="DAO00030_TT_DUOC_KYTONKHO_GetDetail" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
            select *
            from TT_DUOC_KYTONKHO
            where TT_DUOC_KYTONKHO.DUOCKYTONKHO_ID  = '$value$'
            and BENHVIEN_ID = '$BENHVIEN_ID$'
            order by DUOCKYTONKHO_ID
        </statement>
        <!--Revision:0-->
        <statement id="DAO00030_TT_DUOC_KYTONKHO_GetDetailP" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
            select *
            from TT_DUOC_KYTONKHO
            where TT_DUOC_KYTONKHO.DUOCKYTONKHO_ID  = '$DUOCKYTONKHO_ID$'
            and BENHVIEN_ID = '$BENHVIEN_ID$'
            order by DUOCKYTONKHO_ID
        </statement>
        <!--Revision:0-->
        <statement id="DAO00030_TT_DUOC_KYTONKHO_Add" parameterClass="System.Collections.IDictionary" resultClass="System.Int64">
            IF NOT EXISTS
            (
            SELECT MAKYTONKHO
            FROM TT_DUOC_KYTONKHO
            WHERE MAKYTONKHO = #MAKYTONKHO#
            and BENHVIEN_ID = '$BENHVIEN_ID$'
            )
            BEGIN
            insert into TT_DUOC_KYTONKHO (
            MAKYTONKHO
            , THANG
            , NAM
            , TUNGAY
            , DENNGAY
            , KHOASO
            , BENHVIEN_ID
            , NGAYTAO
            , NGUOITAO_ID
            , NGAYCAPNHAT
            , NGUOICAPNHAT_ID
            ) values (
            #MAKYTONKHO#
            , #THANG#
            , #NAM#
            , #TUNGAY#
            , #DENNGAY#
            , #KHOASO#
            , #BENHVIEN_ID#
            , #NGAYTAO#
            , #NGUOITAO_ID#
            , #NGAYCAPNHAT#
            , #NGUOICAPNHAT_ID#
            )
            select SCOPE_identity() as value
            END
        </statement>
        <!--Revision:0-->
        <update id="DAO00030_TT_DUOC_KYTONKHO_Update" parameterClass="System.Collections.IDictionary">
            update TT_DUOC_KYTONKHO set
            MAKYTONKHO = #MAKYTONKHO#
            , THANG = #THANG#
            , NAM = #NAM#
            , TUNGAY = #TUNGAY#
            , DENNGAY = #DENNGAY#
            , KHOASO = #KHOASO#          
            , NGAYCAPNHAT = #NGAYCAPNHAT#
            , NGUOICAPNHAT_ID = #NGUOICAPNHAT_ID#
            where
            DUOCKYTONKHO_ID = '$DUOCKYTONKHO_ID$'
        </update>
        <!--Revision:0-->
        <statement id="DAO00030_TT_DUOC_KYTONKHO_Delete" parameterClass="System.Collections.IDictionary" resultClass="System.Int32">
            delete from TT_DUOC_KYTONKHO
            where
            DUOCKYTONKHO_ID = '$DUOCKYTONKHO_ID$'
        </statement>
        <!--Revision:0-->
        <statement id="DAO00030_TT_DUOC_KYTONKHO_DeleteP" parameterClass="System.Collections.IDictionary" resultClass="System.Int32">
            delete from TT_DUOC_KYTONKHO
            <dynamic prepend="where">
                <isParameterPresent>
                    <isNotEmpty prepend="and" property="DUOCKYTONKHO_ID">
                        TT_DUOC_KYTONKHO.DUOCKYTONKHO_ID = '$DUOCKYTONKHO_ID$'
                    </isNotEmpty>
                    <isNotEmpty prepend="and" property="MAKYTONKHO">
                        TT_DUOC_KYTONKHO.MAKYTONKHO = '$MAKYTONKHO$'
                    </isNotEmpty>                    
                </isParameterPresent>
            </dynamic>
        </statement>
        <!--Revision:0-->
        <statement id="DAO00030_TT_DUOC_TONDAUKY_KiemTraChuaThucHienLanNao" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
            SELECT TOP 1 MONTH(NGAYCHUNGTU) AS THANG, YEAR(NGAYCHUNGTU) AS NAM
            FROM
            TT_DUOC_CHUNGTU
            WHERE
            ((KHONHAP_ID = '$KHODUOC_ID$' AND LOAICHUNGTU = 'N' and TRANGTHAI NOT IN ('PNCNK', 'HUY') and BENHVIEN_ID = '$BENHVIEN_ID$') or (KHOXUAT_ID = '$KHODUOC_ID$' AND LOAICHUNGTU = 'X' and BENHVIEN_ID = '$BENHVIEN_ID$'))
            AND NOT EXISTS (SELECT * FROM TT_DUOC_TONDAUKY WHERE KHODUOC_ID = '$KHODUOC_ID$' and BENHVIEN_ID = '$BENHVIEN_ID$')
            ORDER BY NGAYCHUNGTU ASC
        </statement>      
      <!--Revision:0-->
        <statement id="DAO00030_TT_DUOC_TONDAUKY_LayKyChuaChuaThucHien" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
            SELECT * FROM
            (
            SELECT
            TOP 1
            KTK.THANG,
            KTK.NAM,
            '$THANG$' - KTK.THANG + (('$NAM$' - KTK.NAM)*12 ) as KHOANGCACHTHANG,
            '$NAM$' - KTK.NAM as KHOANGCACHNAM
            FROM
            TT_DUOC_TONDAUKY TDK
            inner join TT_DUOC_KYTONKHO KTK on TDK.DUOCKYTONKHO_ID = KTK.DUOCKYTONKHO_ID
            WHERE
            TDK.KHODUOC_ID = '$KHODUOC_ID$'
            AND TDK.BENHVIEN_ID = '$BENHVIEN_ID$'
            ORDER BY KTK.DUOCKYTONKHO_ID DESC
            )a
            where
            KHOANGCACHTHANG &gt; 1
        </statement>
        <!--Revision:0-->
        <statement id="DAO00030_TT_DUOC_TONDAUKY_TinhTonDauKy" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
            DECLARE @THANGTRUOC Date
            SET @THANGTRUOC = '$THANGTRUOCLIENKE$'
            SELECT TDK.KHODUOC_ID, TDK.DUOC_ID, TDK.SOLONHAP_ID,
            SUM(TDK.SOLUONGNHAP) as SOLUONGNHAP, SUM(TDK.SOLUONGXUAT) as SOLUONGXUAT,
            SUM(TDK.SOLUONGNHAP) - SUM(TDK.SOLUONGXUAT) AS SOLUONGTON,
            SUM(TDK.TONDAUKY) as TONDAUKY,
            SUM(TDK.TONDAUKY) + (SUM(TDK.SOLUONGNHAP) - SUM(TDK.SOLUONGXUAT)) AS TONCUOI
            FROM
            (
            SELECT TDK.KHODUOC_ID, TDK.DUOC_ID, TDK.SOLONHAP_ID,
            TDK.SOLUONG AS TONDAUKY, 0 as SOLUONGNHAP, 0 as SOLUONGXUAT
            FROM
            TT_DUOC_KYTONKHO KTK 
            JOIN TT_DUOC_TONDAUKY TDK ON TDK.DUOCKYTONKHO_ID = KTK.DUOCKYTONKHO_ID
            WHERE
            KTK.NAM = YEAR(@THANGTRUOC)
            AND KTK.THANG = MONTH(@THANGTRUOC)
            AND TDK.KHODUOC_ID IN ($LIST_KHODUOC_ID$)
            AND TDK.BENHVIEN_ID = '$BENHVIEN_ID$'
            UNION ALL
            SELECT   CT.KHONHAP_ID AS KHODUOC_ID, CTCT.DUOC_ID, CTCT.SOLONHAP_ID,
            0 AS TONDAUKY, SUM(CTCT.SOLUONGTHUCTE * ISNULL(CTCT.TYLEQUIDOI,1)) as SOLUONGNHAP, 0 as SOLUONGXUAT
            FROM
            TT_DUOC_CHUNGTU CT INNER JOIN TT_DUOC_CHUNGTU_CHITIET CTCT ON CT.CHUNGTU_ID = CTCT.CHUNGTU_ID
            WHERE
            MONTH(CT.NGAYCHUNGTU) = MONTH(@THANGTRUOC)
            AND YEAR(CT.NGAYCHUNGTU) = YEAR(@THANGTRUOC)
            AND CT.LOAICHUNGTU = 'N'
            AND CTCT.SOLUONGTHUCTE &gt; 0          
            AND ISNULL(CT.TRANGTHAI,'') NOT IN ('PNCNK', 'HUY', 'CXN')
            AND CT.KHONHAP_ID IN ($LIST_KHODUOC_ID$)
            AND CT.BENHVIEN_ID = '$BENHVIEN_ID$'
          GROUP BY CT.KHONHAP_ID, CTCT.DUOC_ID, CTCT.SOLONHAP_ID
          UNION ALL
          SELECT  CT.KHOXUAT_ID AS KHODUOC_ID, CTCT.DUOC_ID, CTCT.SOLONHAP_ID,
          0 AS TONDAUKY, 0 AS SOLUONGNHAP, SUM(CTCT.SOLUONGDAXUAT) as SOLUONGXUAT
          FROM
          TT_DUOC_CHUNGTU CT INNER JOIN TT_DUOC_CHUNGTU_CHITIET CTCT ON CT.CHUNGTU_ID = CTCT.CHUNGTU_ID
          WHERE
          MONTH(CT.NGAYCHUNGTU) = MONTH(@THANGTRUOC)
          AND YEAR(CT.NGAYCHUNGTU) = YEAR(@THANGTRUOC)
          AND CT.LOAICHUNGTU = 'X'
          AND CTCT.SOLUONGDAXUAT &gt; 0          
          AND ISNULL(CT.TRANGTHAI,'') NOT IN ('PNCNK', 'HUY', 'CXN')
          AND CT.KHOXUAT_ID IN ($LIST_KHODUOC_ID$)
          AND CT.BENHVIEN_ID = '$BENHVIEN_ID$'
          GROUP BY CT.KHOXUAT_ID, CTCT.DUOC_ID, CTCT.SOLONHAP_ID
          )TDK GROUP BY KHODUOC_ID, DUOC_ID, SOLONHAP_ID
        </statement>
        <!--Revision:0-->
        <statement id="DAO00030_BoSungTonKhoCacLoKyTruoc" parameterClass="System.Collections.IDictionary" resultClass="System.Int32">
            insert into TT_DUOC_TONDAUKY
            select '$DUOCKYTONKHO_ID$' as DUOCKYTONKHO_ID, KHODUOC_ID, DUOC_ID, SOLONHAP_ID,
            SOLUONG, DONGIAMUA, DONGIAVON, BENHVIEN_ID, getdate(), '$NGUOITAO_ID$', getdate(), '$NGUOICAPNHAT_ID$'
            from
            TT_DUOC_TONDAUKY As t1
            where
            t1.DUOCKYTONKHO_ID = '$DUOCKYTONKHO_ID$' -1
            and t1.KHODUOC_ID in ($LIST_KHODUOC_ID$)
            and NOT EXISTS (
            select 1
            from TT_DUOC_TONDAUKY As t2
            where t1.SOLONHAP_ID = t2.SOLONHAP_ID and t1.KHODUOC_ID = t2.KHODUOC_ID and t1.DUOC_ID = t2.DUOC_ID
            and t2.DUOCKYTONKHO_ID = '$DUOCKYTONKHO_ID$'
            and t2.KHODUOC_ID in ($LIST_KHODUOC_ID$)
            )
        </statement>
        <!--Revision:0-->
        <statement id="DAO00030_TT_DUOC_KYTONKHO_GetKyCuoi" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
            SELECT TOP 1
            KTK.DUOCKYTONKHO_ID,
            KTK.THANG,
            KTK.NAM,
            TDK.NGAYCAPNHAT as NGAYTAO,
            NV.TENNHANVIEN as NGUOITAO,
            CONVERT(VARCHAR, KTK.TUNGAY,103) AS TUNGAY,
            CONVERT(VARCHAR, KTK.DENNGAY,103) AS DENNGAY,
            TDK.KHODUOC_ID,
            CASE
            WHEN KS.KHOASO = 1 THEN 'X'
            ELSE ''
            END  AS KHOASO
            FROM
            TT_DUOC_TONDAUKY TDK
            INNER JOIN TT_DUOC_KYTONKHO KTK on TDK.DUOCKYTONKHO_ID = KTK.DUOCKYTONKHO_ID
            LEFT JOIN TT_DUOC_KHOASOCHUNGTU KS on KS.DUOCKYTONKHO_ID = KTK.DUOCKYTONKHO_ID
            LEFT JOIN TM_NHANVIEN NV on TDK.NGUOICAPNHAT_ID = NV.NHANVIEN_ID
            WHERE
            TDK.KHODUOC_ID = '$KHODUOC_ID$'
            and TDK.BENHVIEN_ID = '$BENHVIEN_ID$'
            ORDER BY TDK.NGAYTAO DESC
        </statement>
        <!--Revision:0-->
        <statement id="DAO00030_TT_DUOC_KHOASOCHUNGTU_GetTrangThaiKhoSo" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
            SELECT
            TOP 1
            CASE
            WHEN KHOASO = 1 THEN 'X'
            ELSE ''
            END  AS KHOASO
            from TT_DUOC_KHOASOCHUNGTU
            where
            KHODUOC_ID = '$KHODUOC_ID$'
            and KYTONKHO ='$KYTONKHO$'
            and BENHVIEN_ID = '$BENHVIEN_ID$'
            ORDER BY DUOCKYTONKHO_ID DESC
        </statement>
        <!--Revision:0-->
        <statement id="DAO00030_TT_DUOC_KYTONKHO_Search" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
            SELECT TOP 1
            KTK.DUOCKYTONKHO_ID,
            KTK.NGAYTAO,
            NV.TENNHANVIEN as NGUOITAO,
            CONVERT(VARCHAR, KTK.TUNGAY,103) AS TUNGAY,
            CONVERT(VARCHAR, KTK.DENNGAY,103) AS DENNGAY,
            TDK.KHODUOC_ID
            FROM
            TT_DUOC_TONDAUKY TDK
            INNER JOIN TT_DUOC_KYTONKHO KTK on TDK.DUOCKYTONKHO_ID = KTK.DUOCKYTONKHO_ID
            LEFT JOIN TM_NHANVIEN NV on KTK.NGUOITAO_ID = NV.NHANVIEN_ID
            WHERE
            TDK.KHODUOC_ID = '$KHODUOC_ID$'
            and KTK.THANG =  '$THANG$'
            and KTK.NAM =  '$NAM$'
            and TDK.BENHVIEN_ID = '$BENHVIEN_ID$'
            ORDER BY KTK.DENNGAY DESC
        </statement>
        <!--Revision:0-->
        <statement id="DAO00030_TT_DUOC_TONDAUKY_GetAll" resultClass="DataObject">
            select *
            from TT_DUOC_TONDAUKY
            where BENHVIEN_ID = '$BENHVIEN_ID$'
            order by DUOCTONDAUKY_ID
        </statement>
        <!--Revision:0-->
        <statement id="DAO00030_TT_DUOC_TONDAUKY_GetList" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
            select *
            from TT_DUOC_TONDAUKY
            <dynamic prepend="where">
                <isParameterPresent>
                    <isNotEmpty prepend="and" property="DUOCTONDAUKY_ID">
                        TT_DUOC_TONDAUKY.DUOCTONDAUKY_ID = '$DUOCTONDAUKY_ID$'
                    </isNotEmpty>
                    <isNotEmpty prepend="and" property="DUOCKYTONKHO_ID">
                        TT_DUOC_TONDAUKY.DUOCKYTONKHO_ID = '$DUOCKYTONKHO_ID$'
                    </isNotEmpty>
                    <isNotEmpty prepend="and" property="KHODUOC_ID">
                      TT_DUOC_TONDAUKY.KHODUOC_ID = '$KHODUOC_ID$'
                    </isNotEmpty>
                    <isNotEmpty prepend="and" property="BENHVIEN_ID">
                      TT_DUOC_TONDAUKY.BENHVIEN_ID = '$BENHVIEN_ID$'
                    </isNotEmpty>
                </isParameterPresent>
            </dynamic>
            order by DUOCTONDAUKY_ID
        </statement>
        <!--Revision:0-->
        <statement id="DAO00030_TT_DUOC_TONDAUKY_GetDetail" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
            select *
            from TT_DUOC_TONDAUKY
            where TT_DUOC_TONDAUKY.DUOCTONDAUKY_ID  = '$value$'
            and BENHVIEN_ID = '$BENHVIEN_ID$'
            order by DUOCTONDAUKY_ID
        </statement>
        <!--Revision:0-->
        <statement id="DAO00030_TT_DUOC_TONDAUKY_GetDetailP" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
            select *
            from TT_DUOC_TONDAUKY
            where TT_DUOC_TONDAUKY.DUOCTONDAUKY_ID  = '$DUOCTONDAUKY_ID$'
            and BENHVIEN_ID = '$BENHVIEN_ID$'
            order by DUOCTONDAUKY_ID
        </statement>
        <!--Revision:0-->
        <statement id="DAO00030_TT_DUOC_TONDAUKY_Add" parameterClass="System.Collections.IDictionary" resultClass="System.Int64">           
            insert into TT_DUOC_TONDAUKY (
            DUOCKYTONKHO_ID
            , KHODUOC_ID
            , DUOC_ID
            , SOLONHAP_ID
            , DONGIAMUA
            , DONGIAVON
            , SOLUONG
            , BENHVIEN_ID
            , NGAYTAO
            , NGUOITAO_ID
            , NGAYCAPNHAT
            , NGUOICAPNHAT_ID
            ) values (
            #DUOCKYTONKHO_ID#
            , #KHODUOC_ID#
            , #DUOC_ID#
            , #SOLONHAP_ID#
            , #DONGIAMUA#
            , #DONGIAVON#
            , #SOLUONG#
            , #BENHVIEN_ID#
            , #NGAYTAO#
            , #NGUOITAO_ID#
            , #NGAYCAPNHAT#
            , #NGUOICAPNHAT_ID#
            )
        </statement>
      
        <!--Revision:0-->
        <update id="DAO00030_TT_DUOC_TONDAUKY_Update" parameterClass="System.Collections.IDictionary">
            update TT_DUOC_TONDAUKY set
            DUOCKYTONKHO_ID = #DUOCKYTONKHO_ID#
            , KHODUOC_ID = #KHODUOC_ID#
            , DUOC_ID = #DUOC_ID#
            , SOLONHAP_ID = #SOLONHAP_ID#
            , DONGIAMUA = #DONGIAMUA#
            , DONGIAVON = #DONGIAVON#
            , SOLUONG = #SOLUONG#
            <!--, BENHVIEN_ID = #BENHVIEN_ID#
          , NGAYTAO = #NGAYTAO#
          , NGUOITAO_ID = #NGUOITAO_ID#-->
            , NGAYCAPNHAT = #NGAYCAPNHAT#
            , NGUOICAPNHAT_ID = #NGUOICAPNHAT_ID#
            where
            DUOCTONDAUKY_ID = '$DUOCTONDAUKY_ID$'
        </update>
        <!--Revision:0-->
        <statement id="DAO00030_TT_DUOC_TONDAUKY_Delete" parameterClass="System.Collections.IDictionary" resultClass="System.Int32">
            delete from TT_DUOC_TONDAUKY
            where
            DUOCTONDAUKY_ID = '$DUOCTONDAUKY_ID$'
        </statement>
       <statement id="DAO00030_TONDAUKY_DELETE_BYKYTONKHO_KHODUOC" parameterClass="System.Collections.IDictionary" resultClass="System.Int32">
         delete
         from TT_DUOC_TONDAUKY
         where
         DUOCKYTONKHO_ID = #DUOCKYTONKHO_ID#
         and KHODUOC_ID = #KHODUOC_ID#                 
       </statement>
        <!--Revision:0-->
        <statement id="DAO00030_TT_DUOC_TONDAUKY_DeleteP" parameterClass="System.Collections.IDictionary" resultClass="System.Int32">
            delete from TT_DUOC_TONDAUKY
            <dynamic prepend="where">
                <isParameterPresent>
                    <isNotEmpty prepend="and" property="DUOCTONDAUKY_ID">
                        TT_DUOC_TONDAUKY.DUOCTONDAUKY_ID = '$DUOCTONDAUKY_ID$'
                    </isNotEmpty>
                    <isNotEmpty prepend="and" property="DUOCKYTONKHO_ID">
                        TT_DUOC_TONDAUKY.DUOCKYTONKHO_ID = '$DUOCKYTONKHO_ID$'
                    </isNotEmpty>                   
                </isParameterPresent>
            </dynamic>
        </statement>
        <!--Revision:0-->
        <statement id="DAO00030_TT_DUOC_KHOASOCHUNGTU_GetKyCuoi" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
          SELECT TOP 1
          KSCT.DUOCKHOASOCHUNGTU_ID,
          KTK.DUOCKYTONKHO_ID,
          KSCT.KHOASO,
          KTK.TUNGAY,
          KSCT.KHOADENNGAY as DENNGAY,
          KSCT.KHODUOC_ID,
          KSCT.NGUOIKHOA_ID,
          NVK.TENNHANVIEN as NGUOIKHOA,
          KSCT.NGAYKHOA,
          KSCT.NGUOIMO_ID,
          NVM.TENNHANVIEN as NGUOIMO,
          KSCT.NGAYMO
          FROM
          TT_DUOC_KHOASOCHUNGTU KSCT
          inner join TT_DUOC_KYTONKHO KTK on KSCT.DUOCKYTONKHO_ID = KTK.DUOCKYTONKHO_ID
          left join TM_NHANVIEN NVK on NVK.NHANVIEN_ID = KSCT.NGUOIKHOA_ID
          left join TM_NHANVIEN NVM on NVM.NHANVIEN_ID = KSCT.NGUOIMO_ID
          WHERE
          KHODUOC_ID = '$KHODUOC_ID$'
          and KTK.THANG = '$THANG$'
          and KTK.NAM = '$NAM$'
          and KSCT.KHOASO = '1'
          AND KSCT.BENHVIEN_ID = '$BENHVIEN_ID$'
          ORDER BY KTK.DENNGAY DESC
        </statement>
        <!--Revision:0-->
        <statement id="DAO00030_TT_DUOC_KHOASOCHUNGTU_LayKyChuaKhoaSo" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
            SELECT * FROM
            (
            SELECT
            TOP 1
            KSCT.DUOCKHOASOCHUNGTU_ID,
            KSCT.KHODUOC_ID,
            KTK.THANG,
            KTK.NAM,
            MONTH('$NGAYKIEMTRA$') - KTK.THANG + ((YEAR('$NGAYKIEMTRA$') - KTK.NAM)*12 ) as KHOANGCACHTHANG,
            YEAR('$NGAYKIEMTRA$') - KTK.NAM as KHOANGCACHNAM
            FROM
            TT_DUOC_KHOASOCHUNGTU KSCT
            inner join TT_DUOC_KYTONKHO KTK on KSCT.DUOCKYTONKHO_ID = KTK.DUOCKYTONKHO_ID
            WHERE
            KHODUOC_ID = '$KHODUOC_ID$'
            and KSCT.KHOADENNGAY &lt;= '$NGAYKIEMTRA$'
            and KSCT.KHOASO = 1
            AND KSCT.BENHVIEN_ID = '$BENHVIEN_ID$'
            ORDER BY KTK.DENNGAY DESC
            )a
            where
            KHOANGCACHTHANG &gt; 1
        </statement>
        <!--Revision:0-->
        <statement id="DAO00030_TT_DUOC_KHOASOCHUNGTU_LayKhoChuaTungKhoaSo" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
            SELECT TOP 1 MONTH(NGAYCHUNGTU) AS THANG, YEAR(NGAYCHUNGTU) AS NAM
            FROM
            TT_DUOC_CHUNGTU
            WHERE
            ((KHONHAP_ID = '$KHODUOC_ID$' AND LOAICHUNGTU = 'N' and BENHVIEN_ID = '$BENHVIEN_ID$') or (KHOXUAT_ID = '$KHODUOC_ID$' AND LOAICHUNGTU = 'X' and BENHVIEN_ID = '$BENHVIEN_ID$'))
            AND NOT EXISTS (SELECT * FROM TT_DUOC_KHOASOCHUNGTU WHERE KHODUOC_ID = '$KHODUOC_ID$' and BENHVIEN_ID = '$BENHVIEN_ID$')
            ORDER BY NGAYCHUNGTU ASC
        </statement>
        <!--Revision:0-->
        <statement id="DAO00030_TT_DUOC_KHOASOCHUNGTU_LayKyDaKhoaSo" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
            SELECT * FROM
            (
            SELECT
            TOP 1
            KSCT.DUOCKHOASOCHUNGTU_ID,
            KSCT.KHODUOC_ID,
            KTK.THANG,
            KTK.NAM,
            KTK.THANG - MONTH('$NGAYKIEMTRA$') + ((KTK.NAM - YEAR('$NGAYKIEMTRA$'))*12 ) as KHOANGCACHTHANG,
            KTK.NAM - YEAR('$NGAYKIEMTRA$') as KHOANGCACHNAM
            FROM
            TT_DUOC_KHOASOCHUNGTU KSCT
            inner join TT_DUOC_KYTONKHO KTK on KSCT.DUOCKYTONKHO_ID = KTK.DUOCKYTONKHO_ID
            WHERE
            KHODUOC_ID = '$KHODUOC_ID$'
            AND KSCT.KHOADENNGAY &gt;= '$NGAYKIEMTRA$'
            AND KSCT.KHOASO = 1
            AND KSCT.BENHVIEN_ID = '$BENHVIEN_ID$'
            ORDER BY KTK.DENNGAY DESC
            )a
            where
            KHOANGCACHTHANG &gt; 0
        </statement>
        <!--Revision:0-->
        <statement id="DAO00030_TT_DUOC_KHOASOCHUNGTU_GetAll" resultClass="DataObject">
            select *
            from TT_DUOC_KHOASOCHUNGTU
            where BENHVIEN_ID = '$BENHVIEN_ID$'
            order by DUOCKHOASOCHUNGTU_ID
        </statement>
        <!--Revision:0-->
        <statement id="DAO00030_TT_DUOC_KHOASOCHUNGTU_GetList" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
            select *
            from TT_DUOC_KHOASOCHUNGTU
            <dynamic prepend="where">
                <isParameterPresent>
                    <isNotEmpty prepend="and" property="DUOCKHOASOCHUNGTU_ID">
                        TT_DUOC_KHOASOCHUNGTU.DUOCKHOASOCHUNGTU_ID = '$DUOCKHOASOCHUNGTU_ID$'
                    </isNotEmpty>
                    <isNotEmpty prepend="and" property="DUOCKYTONKHO_ID">
                        TT_DUOC_KHOASOCHUNGTU.DUOCKYTONKHO_ID = '$DUOCKYTONKHO_ID$'
                    </isNotEmpty>                   
                </isParameterPresent>
            </dynamic>
            order by DUOCKHOASOCHUNGTU_ID
        </statement>
        <!--Revision:0-->
        <statement id="DAO00030_TT_DUOC_KHOASOCHUNGTU_GetDetail" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
            select *
            from TT_DUOC_KHOASOCHUNGTU
            where TT_DUOC_KHOASOCHUNGTU.DUOCKHOASOCHUNGTU_ID  = '$value$'
            and BENHVIEN_ID = '$BENHVIEN_ID$'
            order by DUOCKHOASOCHUNGTU_ID
        </statement>
        <!--Revision:0-->
        <statement id="DAO00030_TT_DUOC_KHOASOCHUNGTU_GetDetailP" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
            select *
            from TT_DUOC_KHOASOCHUNGTU
            where TT_DUOC_KHOASOCHUNGTU.DUOCKHOASOCHUNGTU_ID  = '$DUOCKHOASOCHUNGTU_ID$'
            and BENHVIEN_ID = '$BENHVIEN_ID$'
            order by DUOCKHOASOCHUNGTU_ID
        </statement>
        <!--Revision:0-->
        <statement id="DAO00030_TT_DUOC_KHOASOCHUNGTU_Add" parameterClass="System.Collections.IDictionary" resultClass="System.Int64">
          DELETE TT_DUOC_KHOASOCHUNGTU WHERE DUOCKYTONKHO_ID = #DUOCKYTONKHO_ID# and KHODUOC_ID = #KHODUOC_ID#
          
          insert into TT_DUOC_KHOASOCHUNGTU (
          DUOCKYTONKHO_ID
          , KHODUOC_ID
          , KYTONKHO
          , KHOADENNGAY
          , KHOASO
          , NGAYKHOA
          , NGUOIKHOA_ID
          , NGAYMO
          , NGUOIMO_ID
          , NGAYTAO
          , NGUOITAO_ID
          , BENHVIEN_ID
          ) values (
          #DUOCKYTONKHO_ID#
          , #KHODUOC_ID#
          , #KYTONKHO#
          , #KHOADENNGAY#
          , #KHOASO#
          , #NGAYKHOA#
          , #NGUOIKHOA_ID#
          , #NGAYMO#
          , #NGUOIMO_ID#
          , #NGAYTAO#
          , #NGUOITAO_ID#
          , #BENHVIEN_ID#
          )          
        </statement>
        <!--Revision:0-->
        <update id="DAO00030_TT_DUOC_KHOASOCHUNGTU_Upd" parameterClass="System.Collections.IDictionary">
            update TT_DUOC_KHOASOCHUNGTU set
            KHOADENNGAY = #KHOADENNGAY#
            , KHOASO = #KHOASO#
            , NGAYKHOA = #NGAYKHOA#
            , NGUOIKHOA_ID = #NGUOIKHOA_ID#
            , NGAYMO = null
            , NGUOIMO_ID = null
            where
            DUOCKHOASOCHUNGTU_ID = '$DUOCKHOASOCHUNGTU_ID$'
        </update>
        <!--Revision:0-->
        <statement id="DAO00030_TT_DUOC_KHOASOCHUNGTU_MoSo" parameterClass="System.Collections.IDictionary" resultClass="System.Int32">
            update TT_DUOC_KHOASOCHUNGTU
            set
            KHOASO = '0'
            , NGAYMO = #NGAYMO#
            , NGUOIMO_ID = #NGUOIMO_ID#
            where
            DUOCKHOASOCHUNGTU_ID
            IN
            (
            select
            DUOCKHOASOCHUNGTU_ID
            from
            TT_DUOC_KHOASOCHUNGTU
            where
            KYTONKHO = '$KYTONKHO$'
            AND KHOASO = '1'
            and BENHVIEN_ID ='$BENHVIEN_ID$'
            AND KHODUOC_ID IN ($LIST_KHODUOC_ID$)
            )
        </statement>
        <!--Revision:0-->
        <statement id="DAO00030_CHUNGTUCT_GetChiTietThanhLy" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
            SELECT A.*, isnull(B.TONGTON, 0) TONGTON FROM
            (
            SELECT
            CT.KHOXUAT_ID, CT.KHONHAP_ID, CT.MACHUNGTU, CT.NGUOIGIAO_ID, CT.NGUOINHAN_ID, CT.SOCHUNGTUGOC,
            CTCT.DUOC_ID, CTCT.NGUONHANG_ID AS NGUONDUOC_ID, CTCT.SOLUONGTHUCTE, CTCT.SOLUONGDAXUAT, CTCT.GHICHUCHITIET, CTCT.THANHTIENMUA as THANHTIEN,
            SLN.SOLONHAP_ID, SLN.SOLONHAP, SLN.SOLOSANPHAM, SLN.SOKIEMSOAT, SLN.SOVISA, SLN.HANDUNG AS HANSUDUNG, SLN.NGAYNHAP,
            TK.SOLUONG, GB.DONGIAVON AS DONGIAMUA
            FROM
            TT_DUOC_CHUNGTU CT, TT_DUOC_CHUNGTU_CHITIET CTCT, TT_DUOC_TONKHO TK, TT_DUOC_CHUNGTU_SOLONHAP SLN, TT_DUOC_SOLONHAP_GIABAN GB
            WHERE
            CT.CHUNGTU_ID = CTCT.CHUNGTU_ID
            AND CTCT.DUOC_ID = TK.DUOC_ID
            AND CTCT.SOLONHAP_ID = SLN.SOLONHAP_ID
            AND SLN.SOLONHAP_ID = GB.SOLONHAP_ID
            AND TK.KHODUOC_ID = CT.KHOXUAT_ID
            AND TK.SOLONHAP_ID = SLN.SOLONHAP_ID
            AND CT.MACHUNGTU = '$MACHUNGTU$'
            AND CT.BENHVIEN_ID = '$BENHVIEN_ID$'
            )A left join
            (
            SELECT
            CTCT.DUOC_ID AS DUOC_ID, SUM(SOLUONG) AS TONGTON
            FROM
            TT_DUOC_TONKHO TK, TT_DUOC_CHUNGTU_CHITIET CTCT, TT_DUOC_CHUNGTU CT
            WHERE
            TK.KHODUOC_ID = CT.KHOXUAT_ID
            AND CT.CHUNGTU_ID = CTCT.CHUNGTU_ID
            AND CTCT.DUOC_ID = TK.DUOC_ID
            AND CT.MACHUNGTU = '$MACHUNGTU$'
            AND CT.BENHVIEN_ID = '$BENHVIEN_ID$'
            GROUP BY TK.KHODUOC_ID, CTCT.DUOC_ID
            ) B on A.DUOC_ID = B.DUOC_ID
            ORDER BY DUOC_ID
        </statement>
        <!--Revision:0-->
        <statement id="DAO00030_TT_DUOC_BenhNhanTra" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
            select CTCT.*
            from
            TT_DUOC_CHUNGTU CT, TT_DUOC_CHUNGTU_CHITIET CTCT
            where
            CT.CHUNGTU_ID = CTCT.CHUNGTU_ID
            AND CT.BENHVIEN_ID = '$BENHVIEN_ID$'
            and CT.CHUNGTU_ID IN ($LIST_CHUNGTU_ID$)
        </statement>
        <!--Revision:0-->
        <update id="DAO00030_Update_PhieuTraCuaBenhNhan" parameterClass="System.Collections.IDictionary">
            update TT_DUOC_CHUNGTU
            set
            TRANGTHAI = 'LAPPHIEUTRANOIBO'
            where
            CHUNGTU_ID IN ($LIST_CHUNGTU_ID$)
        </update>
        <!--Revision:0-->
        <statement id="DAO00030_TT_DUOC_XuatThuocVTYT" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
            SELECT TOATHUOC_NGOAITRU.DUOC_ID, ISNULL(TONKHO.SOLUONG,0) AS SOTON,
            ISNULL(TOATHUOC_NGOAITRU.SOLUONG,0) + ISNULL(TOATHUOC_NOITRU.SOLUONG,0) AS SOLUONGTONGHOP
            FROM
            (
            SELECT
            DUOC_ID,
            SUM(SOLUONG) AS SOLUONG
            FROM
            TT_NGOAITRU_TOATHUOC
            WHERE
            TRANGTHAI = 'CHUAXUAT'
            AND BENHVIEN_ID = '$BENHVIEN_ID$'
            AND CONVERT(date, NGAYTAO) BETWEEN  CONVERT(date, '$TONGHOP_TUNGAY$') AND  CONVERT(date, '$TONGHOP_DENNGAY$')
            GROUP BY DUOC_ID
            )TOATHUOC_NGOAITRU
            LEFT JOIN
            (
            SELECT
            DUOC_ID,
            SUM(SOLUONG) AS SOLUONG
            FROM TT_NOITRU_TOATHUOC
            WHERE
            TRANGTHAI = 'CHUAXUAT'
            AND BENHVIEN_ID = '$BENHVIEN_ID$'
            AND CONVERT(date, NGAYTAO) BETWEEN  CONVERT(date, '$TONGHOP_TUNGAY$') AND  CONVERT(date, '$TONGHOP_DENNGAY$')
            GROUP BY DUOC_ID
            )TOATHUOC_NOITRU
            ON TOATHUOC_NGOAITRU.DUOC_ID = TOATHUOC_NOITRU.DUOC_ID
            LEFT JOIN
            (
            SELECT
            DUOC_ID,
            SUM(SOLUONG) AS SOLUONG
            FROM TT_DUOC_TONKHO
            WHERE
            KHODUOC_ID = '$KHODUOC_ID$'
            AND BENHVIEN_ID = '$BENHVIEN_ID$'
            GROUP BY
            DUOC_ID
            )TONKHO
            ON TONKHO.DUOC_ID = TOATHUOC_NOITRU.DUOC_ID OR TONKHO.DUOC_ID = TOATHUOC_NGOAITRU.DUOC_ID
        </statement>
        <!--Revision:0-->
        <statement id="DAO00030_TT_DUOC_TONKHO_KiemTraKiemKe" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
          SELECT top 1
          tdk.KHODUOC_ID,
          tdk.DUOC_ID,
          sln.SOLONHAP_ID,
          sln.SOLONHAP,
          tdk.SOLUONG TONDAU
          FROM
          TT_DUOC_TONDAUKY tdk
          inner join TT_DUOC_KYTONKHO ktk on tdk.DUOCKYTONKHO_ID = ktk.DUOCKYTONKHO_ID
          inner join TT_DUOC_CHUNGTU_SOLONHAP sln on sln.SOLONHAP_ID = tdk.SOLONHAP_ID
          WHERE
          ktk.THANG  = MONTH('$DENNGAY$') AND ktk.NAM  = YEAR('$DENNGAY$')
          AND tdk.KHODUOC_ID = '$KHODUOC_ID$'
          AND tdk.BENHVIEN_ID = '$BENHVIEN_ID$'
        </statement>
      <statement id="DAO00030_TT_DUOC_TONKHO_GetListKiemKe" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
        declare @TUNGAY datetime = CONVERT(date, '$TUNGAY$')
        declare @DENNGAY datetime = CONVERT(date, DATEADD(day, 1, '$DENNGAY$'))
        DECLARE @NGAYDAUTHANG datetime
        SELECT @NGAYDAUTHANG = DATEADD(month, DATEDIFF(month, 0, '$TUNGAY$'), 0)

        select KHODUOC_ID, DUOC_ID,TENDUOCDAYDU, DONVITINH_ID, DONVITINH, SOLONHAP_ID,SOLONHAP,SOLOSANPHAM, HANDUNG,DONGIAVON,
        SUM(kk.TONDAU + kk.NHAP_TRUOC_TUNGAY - kk.XUAT_TRUOC_TUNGAY + kk.NHAP - kk.XUAT) as SOLUONG
        FROM
        (
        <!--TONDAU THANG-->
        SELECT
        tdk.KHODUOC_ID, tdk.DUOC_ID, d.TENDUOCDAYDU, D.DONVITINH_ID, d.DONVITINH, sln.SOLONHAP_ID,sln.SOLONHAP,sln.SOLOSANPHAM, sln.HANDUNG,sln.DONGIAVON,
        sum(SOLUONG) TONDAU, 0 as NHAP_TRUOC_TUNGAY, 0 as XUAT_TRUOC_TUNGAY, 0 as NHAP, 0 as XUAT
        FROM TT_DUOC_TONDAUKY tdk
        inner join TT_DUOC_KYTONKHO ktk on tdk.DUOCKYTONKHO_ID = ktk.DUOCKYTONKHO_ID
        inner join TT_DUOC_CHUNGTU_SOLONHAP sln on sln.SOLONHAP_ID = tdk.SOLONHAP_ID
        inner join TM_DUOC d on d.DUOC_ID = tdk.DUOC_ID
        WHERE
        ktk.THANG  = MONTH(@TUNGAY) AND ktk.NAM = YEAR(@TUNGAY)
        AND tdk.KHODUOC_ID = '$KHODUOC_ID$'
        AND tdk.BENHVIEN_ID = '$BENHVIEN_ID$'
        GROUP BY tdk.KHODUOC_ID, tdk.DUOC_ID, d.TENDUOCDAYDU, D.DONVITINH_ID, d.DONVITINH, sln.SOLONHAP_ID,sln.SOLONHAP,sln.SOLOSANPHAM, sln.HANDUNG,sln.DONGIAVON

        <!--NHAP TRUOC TU NGAY-->
        UNION
        SELECT
        ct.KHONHAP_ID AS KHODUOC_ID, ctct.DUOC_ID, d.TENDUOCDAYDU, D.DONVITINH_ID, d.DONVITINH, sln.SOLONHAP_ID,sln.SOLONHAP,sln.SOLOSANPHAM, sln.HANDUNG,sln.DONGIAVON,
        0 TONDAU, sum(ctct.SOLUONGTHUCTE) as NHAP_TRUOC_TUNGAY, 0 as XUAT_TRUOC_TUNGAY, 0 as NHAP, 0 as XUAT
        FROM TT_DUOC_CHUNGTU ct
        inner join TT_DUOC_CHUNGTU_CHITIET ctct on ct.CHUNGTU_ID = ctct.CHUNGTU_ID
        inner join TT_DUOC_CHUNGTU_SOLONHAP sln on sln.SOLONHAP_ID = ctct.SOLONHAP_ID
        inner join TM_DUOC d on d.DUOC_ID = ctct.DUOC_ID
        WHERE
        ct.LOAICHUNGTU = 'N'
        AND ct.TRANGTHAI NOT IN ('PNCNK','CXN','HUY')
        AND ct.KHONHAP_ID = '$KHODUOC_ID$'
        AND ct.NGAYCHUNGTU >= @NGAYDAUTHANG and ct.NGAYCHUNGTU &lt; @TUNGAY
        AND ct.BENHVIEN_ID = '$BENHVIEN_ID$'       
        GROUP BY 
        ct.KHONHAP_ID, ctct.DUOC_ID, d.TENDUOCDAYDU, D.DONVITINH_ID, d.DONVITINH, sln.SOLONHAP_ID,sln.SOLONHAP,sln.SOLOSANPHAM, sln.HANDUNG,sln.DONGIAVON
		
		    <!--XUAT TRUOC TU NGAY-->
        UNION
        SELECT ct.KHOXUAT_ID as KHODUOC_ID, ctct.DUOC_ID, d.TENDUOCDAYDU, D.DONVITINH_ID, d.DONVITINH, sln.SOLONHAP_ID,sln.SOLONHAP,sln.SOLOSANPHAM, sln.HANDUNG,sln.DONGIAVON, 
		    0 TONDAU, 0 as NHAP_TRUOC_TUNGAY, sum(ctct.SOLUONGDAXUAT) as XUAT_TRUOC_TUNGAY, 0 as NHAP, 0 as XUAT        
        FROM  TT_DUOC_CHUNGTU ct          
        inner join TT_DUOC_CHUNGTU_CHITIET ctct on ct.CHUNGTU_ID = ctct.CHUNGTU_ID          
        inner join TT_DUOC_CHUNGTU_SOLONHAP sln on sln.SOLONHAP_ID = ctct.SOLONHAP_ID     
        inner join TM_DUOC d on d.DUOC_ID = ctct.DUOC_ID               
        WHERE
        ct.LOAICHUNGTU = 'X'
        AND ct.KHOXUAT_ID = '$KHODUOC_ID$'
        AND ct.NGAYCHUNGTU >= @NGAYDAUTHANG and ct.NGAYCHUNGTU &lt; @TUNGAY
        AND ct.BENHVIEN_ID = '$BENHVIEN_ID$'      
        GROUP BY ct.KHOXUAT_ID, ctct.DUOC_ID, d.TENDUOCDAYDU, D.DONVITINH_ID, d.DONVITINH, sln.SOLONHAP_ID,sln.SOLONHAP,sln.SOLOSANPHAM, sln.HANDUNG,sln.DONGIAVON

		    <!--NHAP TU NGAY DEN NGAY-->
        UNION		
        SELECT 
        ct.KHONHAP_ID AS KHODUOC_ID, ctct.DUOC_ID, d.TENDUOCDAYDU, D.DONVITINH_ID, d.DONVITINH, sln.SOLONHAP_ID,sln.SOLONHAP,sln.SOLOSANPHAM, sln.HANDUNG,sln.DONGIAVON, 
		    0 TONDAU, 0 as NHAP_TRUOC_TUNGAY, 0 as XUAT_TRUOC_TUNGAY, sum(ctct.SOLUONGTHUCTE) as NHAP, 0 as XUAT
        FROM TT_DUOC_CHUNGTU ct  
        inner join TT_DUOC_CHUNGTU_CHITIET ctct on ct.CHUNGTU_ID = ctct.CHUNGTU_ID          
        inner join TT_DUOC_CHUNGTU_SOLONHAP sln on sln.SOLONHAP_ID = ctct.SOLONHAP_ID
        inner join TM_DUOC d on d.DUOC_ID = ctct.DUOC_ID          
        WHERE          
        ct.LOAICHUNGTU = 'N'
        AND ct.TRANGTHAI NOT IN ('PNCNK','CXN','HUY')
        AND ct.KHONHAP_ID = '$KHODUOC_ID$'
        AND ct.NGAYCHUNGTU >= @TUNGAY and ct.NGAYCHUNGTU &lt; @DENNGAY
        AND ct.BENHVIEN_ID = '$BENHVIEN_ID$'       
        GROUP BY 
        ct.KHONHAP_ID, ctct.DUOC_ID, d.TENDUOCDAYDU, D.DONVITINH_ID, d.DONVITINH, sln.SOLONHAP_ID,sln.SOLONHAP,sln.SOLOSANPHAM, sln.HANDUNG,sln.DONGIAVON

        <!--XUAT TUNGAY-DENNGAY-->
		    UNION
        SELECT ct.KHOXUAT_ID as KHODUOC_ID, ctct.DUOC_ID, d.TENDUOCDAYDU, D.DONVITINH_ID, d.DONVITINH, sln.SOLONHAP_ID,sln.SOLONHAP,sln.SOLOSANPHAM, sln.HANDUNG,sln.DONGIAVON, 
		    0 TONDAU, 0 as NHAP_TRUOC_TUNGAY, 0 as XUAT_TRUOC_TUNGAY, 0 as NHAP,sum(ctct.SOLUONGDAXUAT) as XUAT        
        FROM  TT_DUOC_CHUNGTU ct          
        inner join TT_DUOC_CHUNGTU_CHITIET ctct on ct.CHUNGTU_ID = ctct.CHUNGTU_ID          
        inner join TT_DUOC_CHUNGTU_SOLONHAP sln on sln.SOLONHAP_ID = ctct.SOLONHAP_ID     
        inner join TM_DUOC d on d.DUOC_ID = ctct.DUOC_ID               
        WHERE
        ct.LOAICHUNGTU = 'X'
        AND ct.KHOXUAT_ID = '$KHODUOC_ID$'
        AND ct.NGAYCHUNGTU >= @TUNGAY and ct.NGAYCHUNGTU &lt; @DENNGAY
        AND ct.BENHVIEN_ID = '$BENHVIEN_ID$'      
        GROUP BY ct.KHOXUAT_ID, ctct.DUOC_ID, d.TENDUOCDAYDU, D.DONVITINH_ID, d.DONVITINH, sln.SOLONHAP_ID,sln.SOLONHAP,sln.SOLOSANPHAM, sln.HANDUNG,sln.DONGIAVON
        )KK
        GROUP BY KHODUOC_ID, DUOC_ID, TENDUOCDAYDU, DONVITINH_ID, DONVITINH, SOLONHAP_ID,SOLONHAP,SOLOSANPHAM, HANDUNG,DONGIAVON
        ORDER BY DUOC_ID,SOLONHAP_ID      
      </statement>
        <!--Revision:0-->
        <statement id="DAO00030_TT_DUOC_KIEMKE_CheckExist" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
          SELECT KK.*, D.TENDUOCDAYDU, D.DONVITINH,
          SLN.SOLONHAP, SLN.SOLOSANPHAM, SLN.HANDUNG AS HANSUDUNG
          FROM TT_DUOC_KIEMKE KK
          INNER JOIN TT_DUOC_CHUNGTU_SOLONHAP SLN on SLN.SOLONHAP_ID =  KK.SOLONHAP_ID
          INNER JOIN TT_DUOC_KYTONKHO KTK ON KK.DUOCKYKIEMKE_ID = KTK.DUOCKYTONKHO_ID
          INNER JOIN TM_DUOC D on D.DUOC_ID =  KK.DUOC_ID
          WHERE
          KTK.MAKYTONKHO = '$MAKYTONKHO$'
          AND KK.KHODUOC_ID = '$KHODUOC_ID$'
          AND KK.BENHVIEN_ID = '$BENHVIEN_ID$'
          order by
          D.TENDUOCDAYDU
        </statement>
        <!--Revision:0-->
        <statement id="DAO00030_TT_DUOC_KIEMKE_GetAll" resultClass="DataObject">
            select *
            from TT_DUOC_KIEMKE
            where CT.BENHVIEN_ID = '$BENHVIEN_ID$'
            order by DUOCKIEMKE_ID
        </statement>
        <!--Revision:0-->
        <statement id="DAO00030_TT_DUOC_KIEMKE_GetList" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
            select *
            from TT_DUOC_KIEMKE
            <dynamic prepend="where">
                <isParameterPresent>
                    <isNotEmpty prepend="and" property="DUOCKIEMKE_ID">
                        TT_DUOC_KIEMKE.DUOCKIEMKE_ID = '$DUOCKIEMKE_ID$'
                    </isNotEmpty>
                    <isNotEmpty prepend="and" property="DUOCKYKIEMKE_ID">
                        TT_DUOC_KIEMKE.DUOCKYKIEMKE_ID = '$DUOCKYKIEMKE_ID$'
                    </isNotEmpty>
                    <isNotEmpty prepend="and" property="KHODUOC_ID">
                        TT_DUOC_KIEMKE.KHODUOC_ID = '$KHODUOC_ID$'
                    </isNotEmpty>
                    <isNotEmpty prepend="and" property="DUOC_ID">
                        TT_DUOC_KIEMKE.DUOC_ID = '$DUOC_ID$'
                    </isNotEmpty>
                    <isNotEmpty prepend="and" property="SOLONHAP_ID">
                        TT_DUOC_KIEMKE.SOLONHAP_ID = '$SOLONHAP_ID$'
                    </isNotEmpty>                    
                </isParameterPresent>
            </dynamic>
            order by DUOCKIEMKE_ID
        </statement>
        <!--Revision:0-->
        <statement id="DAO00030_TT_DUOC_KIEMKE_GetDetail" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
            select *
            from TT_DUOC_KIEMKE
            where TT_DUOC_KIEMKE.DUOCKIEMKE_ID  = '$value$'
            and BENHVIEN_ID = '$BENHVIEN_ID$'
            order by DUOCKIEMKE_ID
        </statement>
        <!--Revision:0-->
        <statement id="DAO00030_TT_DUOC_KIEMKE_GetDetailP" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
            select *
            from TT_DUOC_KIEMKE
            where TT_DUOC_KIEMKE.DUOCKIEMKE_ID  = '$DUOCKIEMKE_ID$'
            and BENHVIEN_ID = '$BENHVIEN_ID$'
            order by DUOCKIEMKE_ID
        </statement>
        <!--Revision:0-->
        <statement id="DAO00030_TT_DUOC_KIEMKE_Add" parameterClass="System.Collections.IDictionary" resultClass="System.Int64">
            insert into TT_DUOC_KIEMKE (
            DUOCKYKIEMKE_ID
            , HOIDONGKIEMKE_ID
            , KHODUOC_ID
            , DUOC_ID
            , SOLONHAP_ID
            , DONGIAMUA
            , DONGIAVON
            , SOLUONG
            , TENDUOC
            , DONVITINH_ID
            , SOKIEMSOAT
            , NUOCSX
            , THANHTIEN
            , SOTHUCTE
            , THUA
            , THIEU
            , HONG
            , KIEMKETUNGAY
            , KIEMKEDENNGAY
            , GHICHU
            , NGAYTAO
            , NGUOITAO_ID
            , NGAYCAPNHAT
            , NGUOICAPNHAT_ID
            , BENHVIEN_ID
            ) values (
            #DUOCKYKIEMKE_ID#
            , #HOIDONGKIEMKE_ID#
            , #KHODUOC_ID#
            , #DUOC_ID#
            , #SOLONHAP_ID#
            , #DONGIAMUA#
            , #DONGIAVON#
            , #SOLUONG#
            , #TENDUOC#
            , #DONVITINH_ID#
            , #SOKIEMSOAT#
            , #NUOCSX#
            , #THANHTIEN#
            , #SOTHUCTE#
            , #THUA#
            , #THIEU#
            , #HONG#
            , #KIEMKETUNGAY#
            , #KIEMKEDENNGAY#
            , #GHICHU#
            , #NGAYTAO#
            , #NGUOITAO_ID#
            , #NGAYCAPNHAT#
            , #NGUOICAPNHAT_ID#
            , #BENHVIEN_ID#
            )
        </statement>
        <!--Revision:0-->
        <update id="DAO00030_TT_DUOC_KIEMKE_Update" parameterClass="System.Collections.IDictionary">
            update TT_DUOC_KIEMKE set
            DUOCKYKIEMKE_ID = #DUOCKYKIEMKE_ID#
            , HOIDONGKIEMKE_ID = #HOIDONGKIEMKE_ID#
            , KHODUOC_ID = #KHODUOC_ID#
            , DUOC_ID = #DUOC_ID#
            , SOLONHAP_ID = #SOLONHAP_ID#
            , DONGIAMUA = #DONGIAMUA#
            , DONGIAVON = #DONGIAVON#
            , SOLUONG = #SOLUONG#
            , TENDUOC = #TENDUOC#
            , DONVITINH_ID = #DONVITINH_ID#
            , SOKIEMSOAT = #SOKIEMSOAT#
            , NUOCSX = #NUOCSX#
            , THANHTIEN = #THANHTIEN#
            , SOTHUCTE = #SOTHUCTE#
            , THUA = #THUA#
            , THIEU = #THIEU#
            , HONG = #HONG#
            , GHICHU = #GHICHU#
            , KIEMKETUNGAY = #KIEMKETUNGAY#
            , KIEMKEDENNGAY = #KIEMKEDENNGAY#
            <!--, NGAYTAO = #NGAYTAO#
      , NGUOITAO_ID = #NGUOITAO_ID#-->
            , NGAYCAPNHAT = #NGAYCAPNHAT#
            , NGUOICAPNHAT_ID = #NGUOICAPNHAT_ID#
            , BENHVIEN_ID = #BENHVIEN_ID#
            where
            DUOCKIEMKE_ID = '$DUOCKIEMKE_ID$'
        </update>
        <!--Revision:0-->
        <statement id="DAO00030_TT_DUOC_KIEMKE_Delete" parameterClass="System.Collections.IDictionary" resultClass="System.Int32">
            delete from TT_DUOC_KIEMKE
            where
            DUOCKIEMKE_ID = '$DUOCKIEMKE_ID$'
        </statement>
        <!--Revision:0-->
        <statement id="DAO00030_TT_DUOC_KIEMKE_DeleteP" parameterClass="System.Collections.IDictionary" resultClass="System.Int32">
            delete from TT_DUOC_KIEMKE
            <dynamic prepend="where">
                <isParameterPresent>
                    <isNotEmpty prepend="and" property="DUOCKIEMKE_ID">
                        TT_DUOC_KIEMKE.DUOCKIEMKE_ID = '$DUOCKIEMKE_ID$'
                    </isNotEmpty>
                    <isNotEmpty prepend="and" property="DUOCKYKIEMKE_ID">
                        TT_DUOC_KIEMKE.DUOCKYKIEMKE_ID = '$DUOCKYKIEMKE_ID$'
                    </isNotEmpty>
                    <isNotEmpty prepend="and" property="KHODUOC_ID">
                        TT_DUOC_KIEMKE.KHODUOC_ID = '$KHODUOC_ID$'
                    </isNotEmpty>
                    <isNotEmpty prepend="and" property="DUOC_ID">
                        TT_DUOC_KIEMKE.DUOC_ID = '$DUOC_ID$'
                    </isNotEmpty>
                    <isNotEmpty prepend="and" property="SOLONHAP_ID">
                        TT_DUOC_KIEMKE.SOLONHAP_ID = '$SOLONHAP_ID$'
                    </isNotEmpty>                    
                </isParameterPresent>
            </dynamic>
        </statement>
        <!--Revision:0-->
        <statement id="DAO00030_TT_DUOC_KIEMKE_GetKyTonKho_DieuChinhTang" resultClass="DataObject">
            SELECT distinct KTK.*, KK.KHODUOC_ID, KD.TENKHO
            FROM
            TT_DUOC_KYTONKHO KTK
            inner join TT_DUOC_KIEMKE KK on KTK.DUOCKYTONKHO_ID = KK.DUOCKYKIEMKE_ID
            inner join TM_KHODUOC KD on KD.KHODUOC_ID = KK.KHODUOC_ID
            WHERE
            KK.THIEU &gt; 0
            and KK.KHODUOC_ID = '$KHODUOC_ID$'
            and KTK.MAKYTONKHO like '%$MAKYTONKHO$%'
            AND KTK.BENHVIEN_ID = '$BENHVIEN_ID$'
            order by KTK.NGAYTAO DESC
        </statement>
        <!--Revision:0-->
        <statement id="DAO00030_TT_DUOC_KIEMKE_GetKyTonKho_DieuChinhGiam" resultClass="DataObject">
            SELECT distinct KTK.*, KK.KHODUOC_ID, KD.TENKHO
            FROM
            TT_DUOC_KYTONKHO KTK
            inner join TT_DUOC_KIEMKE KK on KTK.DUOCKYTONKHO_ID = KK.DUOCKYKIEMKE_ID
            inner join TM_KHODUOC KD on KD.KHODUOC_ID = KK.KHODUOC_ID
            WHERE
            KK.THUA &gt; 0
            and KTK.MAKYTONKHO like '%$MAKYTONKHO$%'
            and KK.KHODUOC_ID = '$KHODUOC_ID$'
            AND KK.BENHVIEN_ID = '$BENHVIEN_ID$'
            order by KTK.NGAYTAO DESC
        </statement>
        <!--Revision:0-->
        <statement id="DAO00030_TT_DUOC_KIEMKE_GetDuocThieu" resultClass="DataObject">
            SELECT
            KK.DUOC_ID, SLN.NGUONHANG_ID AS NGUONDUOC_ID,  SLN.SOKIEMSOAT,SLN.HANDUNG AS HANSUDUNG, SLN.NGAYNHAP,SLN.SOLONHAP, SLN.SOLONHAP_ID,
            KK.DONGIAMUA, KK.THIEU AS SOLUONGTHUCTE, KK.DONGIAMUA* KK.THIEU AS THANHTIEN,
            TK.SOLUONG
            FROM
            TT_DUOC_KIEMKE KK
            left join TT_DUOC_CHUNGTU_SOLONHAP SLN on (KK.SOLONHAP_ID = SLN.SOLONHAP_ID AND KK.DUOC_ID = SLN.DUOC_ID )
            <!--left join TT_DUOC_TONKHO TK ON (KK.DUOC_ID = TK.DUOC_ID and TK.KHODUOC_ID = KK.KHODUOC_ID and TK.SOLONHAP_ID = SLN.SOLONHAP_ID)-->
          left join (
          select xx.DUOCTONKHO_ID, xx.KHODUOC_ID, xx.DUOC_ID, xx.SOLONHAP_ID, xx.SOLUONG, xx.NGUONDUOC_ID, xx.BENHVIEN_ID from TT_DUOC_TONKHO xx
          join ( select max(DUOCTONKHO_ID) as DUOCTONKHO_ID, KHODUOC_ID, DUOC_ID, SOLONHAP_ID, NGUONDUOC_ID
          from TT_DUOC_TONKHO group by KHODUOC_ID, DUOC_ID, SOLONHAP_ID, NGUONDUOC_ID) yy on xx.DUOCTONKHO_ID=yy.DUOCTONKHO_ID
          ) TK ON (KK.DUOC_ID = TK.DUOC_ID and TK.KHODUOC_ID = KK.KHODUOC_ID and TK.SOLONHAP_ID = SLN.SOLONHAP_ID)
          WHERE
          KK.DUOCKYKIEMKE_ID = '$DUOCKYKIEMKE_ID$'
          AND KK.BENHVIEN_ID = '$BENHVIEN_ID$'
          and KK.THIEU &gt; 0
        </statement>
        <!--Revision:0-->
        <statement id="DAO00030_TT_DUOC_KIEMKE_GetDuocThua" resultClass="DataObject">
            SELECT
            KK.DUOC_ID, SLN.NGUONHANG_ID AS NGUONDUOC_ID,  SLN.SOKIEMSOAT, SLN.HANDUNG AS HANSUDUNG, SLN.NGAYNHAP,SLN.SOLONHAP, SLN.SOLONHAP_ID,
            KK.DONGIAMUA, KK.THUA AS SOLUONGDAXUAT, KK.DONGIAMUA* KK.THUA AS THANHTIEN,
            TK.SOLUONG
            FROM
            TT_DUOC_KIEMKE KK
            left join TT_DUOC_CHUNGTU_SOLONHAP SLN on (KK.SOLONHAP_ID = SLN.SOLONHAP_ID AND KK.DUOC_ID = SLN.DUOC_ID )
            <!--left join TT_DUOC_TONKHO TK ON (KK.DUOC_ID = TK.DUOC_ID and TK.KHODUOC_ID = KK.KHODUOC_ID and TK.SOLONHAP_ID = SLN.SOLONHAP_ID)-->
          left join (
          select xx.DUOCTONKHO_ID, xx.KHODUOC_ID, xx.DUOC_ID, xx.SOLONHAP_ID, xx.SOLUONG, xx.NGUONDUOC_ID, xx.BENHVIEN_ID from TT_DUOC_TONKHO xx
          join ( select max(DUOCTONKHO_ID) as DUOCTONKHO_ID, KHODUOC_ID, DUOC_ID, SOLONHAP_ID, NGUONDUOC_ID
          from TT_DUOC_TONKHO group by KHODUOC_ID, DUOC_ID, SOLONHAP_ID, NGUONDUOC_ID) yy on xx.DUOCTONKHO_ID=yy.DUOCTONKHO_ID
          ) TK ON (KK.DUOC_ID = TK.DUOC_ID and TK.KHODUOC_ID = KK.KHODUOC_ID and TK.SOLONHAP_ID = SLN.SOLONHAP_ID)
          WHERE
          KK.DUOCKYKIEMKE_ID = '$DUOCKYKIEMKE_ID$'
          AND KK.BENHVIEN_ID = '$BENHVIEN_ID$'
          and KK.THUA &gt; 0
        </statement>
        <!--Revision:0-->
        <statement id="DAO00030_TT_VIENPHI_Add" parameterClass="System.Collections.IDictionary" resultClass="System.Int64">
            INSERT INTO TT_VIENPHI (
            TIEPNHAN_ID
            , BENHNHAN_ID
            , KHAMBENH_ID
            , REF_ID
            , REF_TABLE
            , DUOC_ID
            , SOLONHAP_ID
            , LOAI_CHIPHI
            , LOAIGIA_ID
            , SOLUONG
            , DONGIA_DOANHTHU
            , THANHTIEN_DOANHTHU
            , BHYT_TL
            , BENHNHAN_PHAITHANHTOAN
            , GIATRI_HOADON
            , GIATRI_HOADON_DATHANHTOAN
            , GIATRI_BIENLAI
            , GIATRI_BIENLAI_DATHANHTOAN
            , GIATRI_BENHNHAN_DATHANHTOAN
            , TYLE_VAT
            , GIAVON
            , BANGGIA_ID
            , DUOCPHEPTHUCHIEN
            , HUY
            , KHONGTHUTIEN
            , DATHANHTOAN
            , DATHUCHIEN
            , HOADON_ID
            , ACTIVE
            , DUYET
            , BENHVIEN_ID
            , NGUOITAO_ID
            , NGAYTAO
            , NGUOICAPNHAT_ID
            , NGAYCAPNHAT
            ) values (
            #TIEPNHAN_ID#
            , #BENHNHAN_ID#
            , #KHAMBENH_ID#
            , #REF_ID#
            , #REF_TABLE#
            , #DUOC_ID#
            , #SOLONHAP_ID#
            , #LOAI_CHIPHI#
            , #LOAIGIA_ID#
            , #SOLUONG#
            , #DONGIA_DOANHTHU#
            , #THANHTIEN_DOANHTHU#
            , #BHYT_TL#
            , #BENHNHAN_PHAITHANHTOAN#
            , #GIATRI_HOADON#
            , #GIATRI_HOADON_DATHANHTOAN#
            , #GIATRI_BIENLAI#
            , #GIATRI_BIENLAI_DATHANHTOAN#
            , #GIATRI_BENHNHAN_DATHANHTOAN#
            , #TYLE_VAT#
            , #GIAVON#
            , #BANGGIA_ID#
            , #DUOCPHEPTHUCHIEN#
            , #HUY#
            , #KHONGTHUTIEN#
            , #DATHANHTOAN#
            , #DATHUCHIEN#
            , #HOADON_ID#
            , #ACTIVE#
            , #DUYET#
            , #BENHVIEN_ID#
            , #NGUOITAO_ID#
            , #NGAYTAO#
            , #NGUOICAPNHAT_ID#
            , #NGAYCAPNHAT#
            )
            select SCOPE_identity() as value
        </statement>
      <statement id="DAO00030_TT_VIENPHI_Add_Multi" parameterClass="System.Collections.IDictionary" resultClass="System.Int64">
        BEGIN
       
        declare @json nvarchar(max) =  N'$JSON_VIENPHI$';

        INSERT INTO TT_VIENPHI (
        TIEPNHAN_ID
        , BENHNHAN_ID
        , KHAMBENH_ID
        , REF_ID
        , REF_TABLE
        , DUOC_ID
        , SOLONHAP_ID
        , LOAI_CHIPHI
        , LOAIGIA_ID
        , SOLUONG
        , DONGIA_DOANHTHU
        , THANHTIEN_DOANHTHU
        , BHYT_TL
        , BENHNHAN_PHAITHANHTOAN
        , GIATRI_HOADON
        , GIATRI_HOADON_DATHANHTOAN
        , GIATRI_BIENLAI
        , GIATRI_BIENLAI_DATHANHTOAN
        , GIATRI_BENHNHAN_DATHANHTOAN
        , TYLE_VAT
        , GIAVON
        , BANGGIA_ID
        , DUOCPHEPTHUCHIEN
        , HUY
        , KHONGTHUTIEN
        , DATHANHTOAN
        , DATHUCHIEN
        , HOADON_ID
        , ACTIVE
        , DUYET
        , BENHVIEN_ID
        , NGUOITAO_ID
        , NGAYTAO
        , NGUOICAPNHAT_ID
        , NGAYCAPNHAT
        )
        SELECT * FROM OPENJSON(@json)
        WITH (
        TIEPNHAN_ID int
        , BENHNHAN_ID int
        , KHAMBENH_ID int
        , REF_ID int
        , REF_TABLE varchar(100)
        , DUOC_ID int
        , SOLONHAP_ID int
        , LOAI_CHIPHI varchar(20)
        , LOAIGIA_ID int
        , SOLUONG numeric(18, 4)
        , DONGIA_DOANHTHU numeric(18, 4)
        , THANHTIEN_DOANHTHU numeric(18, 4)
        , BHYT_TL decimal(3, 2)
        , BENHNHAN_PHAITHANHTOAN decimal(18, 4)
        , GIATRI_HOADON decimal(18, 4)
        , GIATRI_HOADON_DATHANHTOAN decimal(18, 4)
        , GIATRI_BIENLAI decimal(18, 4)
        , GIATRI_BIENLAI_DATHANHTOAN decimal(18, 4)
        , GIATRI_BENHNHAN_DATHANHTOAN decimal(18, 4)
        , TYLE_VAT int
        , GIAVON decimal(18, 4)
        , BANGGIA_ID int
        , DUOCPHEPTHUCHIEN char(1)
        , HUY char(1)
        , KHONGTHUTIEN char(1)
        , DATHANHTOAN char(1)
        , DATHUCHIEN char(1)
        , HOADON_ID int
        , ACTIVE char(1)
        , DUYET char(1)
        , BENHVIEN_ID nvarchar(10)
        , NGUOITAO_ID int
        , NGAYTAO datetime
        , NGUOICAPNHAT_ID int
        , NGAYCAPNHAT datetime
        )       

        END
      </statement>
        <!--Revision:0-->
        <statement id="DAO00030_TT_VIENPHI_Delete" parameterClass="System.Collections.IDictionary" resultClass="System.Int32">          
            DELETE FROM
            TT_VIENPHI
            WHERE
            REF_ID = '$REF_ID$'
            and REF_TABLE = '$REF_TABLE$'
            and BENHVIEN_ID = '$BENHVIEN_ID$'
        </statement>
        <!--Revision:0-->
        <statement id="DAO00030_File_GetAll" resultClass="DataObject">
            select *
            from TT_FILE_DINHKEM
            order by FILE_ID
        </statement>
        <!--Revision:0-->
        <statement id="DAO00030_File_GetList" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
            select *
            from TT_FILE_DINHKEM
            <dynamic prepend="where">
                <isParameterPresent>
                    <isNotEmpty prepend="and" property="LIST_FILE_ID">
                        FILE_ID IN ($LIST_FILE_ID$)
                    </isNotEmpty>
                    <isNotEmpty prepend="and" property="REF_TABLE">
                        TT_FILE_DINHKEM.REF_TABLE = '$REF_TABLE$'
                    </isNotEmpty>
                    <isNotEmpty prepend="and" property="REF_ID">
                        TT_FILE_DINHKEM.REF_ID = '$REF_ID$'
                    </isNotEmpty>                    
                </isParameterPresent>
            </dynamic>
            order by FILE_ID
        </statement>
        <!--Revision:0-->
        <statement id="DAO00030_File_GetDetail" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
            select *
            from TT_FILE_DINHKEM
            where TT_FILE_DINHKEM.FILE_ID  = '$value$'
            order by FILE_ID
        </statement>
        <!--Revision:0-->
        <statement id="DAO00030_File_GetDetailP" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
            select *
            from TT_FILE_DINHKEM
            where TT_FILE_DINHKEM.FILE_ID  = '$FILE_ID$'
            order by FILE_ID
        </statement>
        <!--Revision:0-->
        <statement id="DAO00030_File_Add" parameterClass="System.Collections.IDictionary" resultClass="System.Int64">
            insert into TT_FILE_DINHKEM (
            REF_TABLE
            , REF_ID
            , ORIGINAL_NAME
            , UPLOAD_NAME
            , UPLOAD_FOLDER
            , TYPE
            , SIZE
            , BENHVIEN_ID
            , NGAYTAO
            , NGUOITAO_ID
            ) values (
            #REF_TABLE#
            , #REF_ID#
            , #ORIGINAL_NAME#
            , #UPLOAD_NAME#
            , #UPLOAD_FOLDER#
            , #TYPE#
            , #SIZE#
            , #BENHVIEN_ID#
            , #NGAYTAO#
            , #NGUOITAO_ID#
            )
            select SCOPE_identity() as value
        </statement>
        <!--Revision:0-->
        <update id="DAO00030_File_Update" parameterClass="System.Collections.IDictionary">
            update TT_FILE_DINHKEM set
            REF_ID = #REF_ID#
            where
            FILE_ID IN ($LIST_FILE_ID$)
        </update>
        <!--Revision:0-->
        <statement id="DAO00030_File_Delete" parameterClass="System.Collections.IDictionary" resultClass="System.Int32">
            delete from TT_FILE_DINHKEM
            <dynamic prepend="where">
                <isParameterPresent>
                    <isNotEmpty prepend="and" property="FILE_ID">
                        FILE_ID = $FILE_ID$
                    </isNotEmpty>
                    <isNotEmpty prepend="and" property="LIST_FILE_ID">
                        FILE_ID IN ($LIST_FILE_ID$)
                    </isNotEmpty>
                    <isNotEmpty prepend="and" property="REF_TABLE">
                        REF_TABLE = '$REF_TABLE$'
                    </isNotEmpty>
                    <isNotEmpty prepend="and" property="REF_ID">
                        REF_ID = '$REF_ID$'
                    </isNotEmpty>
                </isParameterPresent>
            </dynamic>
        </statement>
        <!--Revision:0-->
        <statement id="DAO00030_Search_PhieuXuatThuocBHYT_Page" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
            select *
            from
            (select distinct
            ROW_NUMBER() OVER(order by CT.CHUNGTU_ID DESC) as ROWNUMBER,
            CT.CHUNGTU_ID,
            CT.MACHUNGTU,
            CT.NGAYCHUNGTU,
            CT.KHOXUAT_ID,
            CT.NGUOIGIAO_ID,
            BN.MAYTE,
            BN.TENBENHNHAN
            from TT_DUOC_CHUNGTU CT
            inner join TT_BENHNHAN BN on BN.BENHNHAN_ID = CT.BENHNHAN_ID
            <dynamic prepend="where">
                <isParameterPresent>
                    <isNotEmpty prepend="and" property="MACHUNGTU">
                        CT.MACHUNGTU LIKE '%$MACHUNGTU$%'
                    </isNotEmpty>
                    <isNotEmpty prepend="and" property="MUCDICHCHUNGTU_ID">
                        CT.MUCDICHCHUNGTU_ID = '$MUCDICHCHUNGTU_ID$'
                    </isNotEmpty>
                    <isNotEmpty prepend="and" property="BENHVIEN_ID">
                        CT.BENHVIEN_ID = '$BENHVIEN_ID$'
                    </isNotEmpty>
                    <isNotEmpty prepend="and" property="KHOXUAT_ID">
                        CT.KHOXUAT_ID = '$KHOXUAT_ID$'
                    </isNotEmpty>
                    <isNotEmpty prepend="and" property="TUNGAY">
                        CONVERT(date, CT.NGAYCHUNGTU) BETWEEN CONVERT(date, '$TUNGAY$')  and  CONVERT(date, '$DENNGAY$')
                    </isNotEmpty>
                </isParameterPresent>
            </dynamic>
            )lst
            <isNotEmpty prepend="" property="FROMROW">
                where
                lst.ROWNUMBER between $FROMROW$ and $TOROW$
            </isNotEmpty>
            order by lst.CHUNGTU_ID DESC
        </statement>
        <!--Revision:0-->
        <statement id="DAO00030_Search_PhieuXuatThuocBHYT_CountList" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
            SELECT count(*) as TOTALROWS
            FROM (
            select distinct
            CT.CHUNGTU_ID,
            CT.MACHUNGTU,
            CT.NGAYCHUNGTU,
            CT.KHOXUAT_ID,
            CT.NGUOIGIAO_ID,
            BN.MAYTE,
            BN.TENBENHNHAN
            from TT_DUOC_CHUNGTU CT
            inner join TT_BENHNHAN BN on BN.BENHNHAN_ID = CT.BENHNHAN_ID
            <dynamic prepend="where">
                <isParameterPresent>
                    <isNotEmpty prepend="and" property="MACHUNGTU">
                        CT.MACHUNGTU LIKE '%$MACHUNGTU$%'
                    </isNotEmpty>
                    <isNotEmpty prepend="and" property="MUCDICHCHUNGTU_ID">
                        CT.MUCDICHCHUNGTU_ID = '$MUCDICHCHUNGTU_ID$'
                    </isNotEmpty>
                    <isNotEmpty prepend="and" property="BENHVIEN_ID">
                        CT.BENHVIEN_ID = '$BENHVIEN_ID$'
                    </isNotEmpty>
                    <isNotEmpty prepend="and" property="KHOXUAT_ID">
                        CT.KHOXUAT_ID = '$KHOXUAT_ID$'
                    </isNotEmpty>
                    <isNotEmpty prepend="and" property="TUNGAY">
                        CONVERT(date, CT.NGAYCHUNGTU) BETWEEN CONVERT(date, '$TUNGAY$')  and  CONVERT(date, '$DENNGAY$')
                    </isNotEmpty>
                </isParameterPresent>
            </dynamic>
            ) lst
        </statement>
        <!--Revision:0-->
        <statement id="DAO00030_TOATHUOC_GetThongTinDuyet_NgoaiTru_CountList" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
            select count(*) as TOTALROWS
            from
            (
            SELECT
            BN.TENBENHNHAN,
            BN.MAYTE,
            BN.SOVAOVIEN,
            CASE
            WHEN BN.GIOITINH = 1 THEN 'Nam'
            WHEN BN.GIOITINH = 2 THEN N'Nữ'
            END  AS GIOITINH,
            BN.NAMSINH,
            BN.DIACHILIENLAC as DIACHI,
            KBTT.KHAMBENH_TOATHUOC_ID,
            KBTT.SOTHUTUTOA,
            KB.PHONGBAN_ID,
            KB.BACSIKHAM_ID,
            KBTT.NGUOIDUYET_ID,
            KBTT.NGAYDUYET,
            KBTT.THOIGIANDUYET,
            KBTT.TRANGTHAI,
            KBTT.LYDOHUY,
            'NGOAITRU' as MALOAITOA,
            N'Ngoại trú BHYT' as TENLOAITOA
            FROM
            TT_BENHNHAN BN,
            TT_NGOAITRU_KHAMBENH KB,
            TT_NGOAITRU_KHAMBENH_TOATHUOC KBTT
            WHERE
            KB.KHAMBENH_ID = KBTT.KHAMBENH_ID
            AND KB.BENHNHAN_ID = BN.BENHNHAN_ID
            AND KBTT.DUYET = '$DUYET$'
            AND KBTT.CHUNGTUPHATTHUOC_ID is NULL
            AND KBTT.KHOXUAT_ID = '$KHOXUAT_ID$'
            AND LOAITOATHUOC = '$LOAITOATHUOC$'
            and KB.BENHVIEN_ID = '$BENHVIEN_ID$'
            AND CONVERT(date, KBTT.NGAYTOATHUOC) BETWEEN CONVERT(date, '$TUNGAY$')  AND  CONVERT(date, '$DENNGAY$')
            AND (KBTT.SOTHUTUTOA LIKE '%$KEYWORD$%' or BN.TENBENHNHAN LIKE N'%$KEYWORD$%' or BN.SOVAOVIEN LIKE N'%$KEYWORD$%')
            UNION ALL
            SELECT DISTINCT
            BN.TENBENHNHAN,
            BN.MAYTE,
            BN.SOVAOVIEN,
            CASE
            WHEN BN.GIOITINH = 1 THEN 'Nam'
            WHEN BN.GIOITINH = 2 THEN N'Nữ'
            END  AS GIOITINH,
            BN.NAMSINH,
            BN.DIACHILIENLAC as DIACHI,
            TT.KHAMBENH_ID as KHAMBENH_TOATHUOC_ID,
            TT.SOTHUTUTOA,
            KB.PHONGBAN_ID,
            KB.BACSIKHAM_ID,
            CASE
            WHEN TT.TRANGTHAI	= 'CHUAXUAT'  THEN NULL
            WHEN TT.TRANGTHAI	= 'DADUYET'  THEN KB.NGUOICAPNHAT_ID
            END  AS NGUOIDUYET_ID,
            null as NGAYDUYET,
            CASE
            WHEN TT.TRANGTHAI	= 'CHUAXUAT'  THEN NULL
            WHEN TT.TRANGTHAI	= 'DADUYET'  THEN KB.NGAYCAPNHAT
            END  AS THOIGIANDUYET,
            TT.TRANGTHAI AS TRANGTHAI,
            TT.GHICHU AS LYDOHUY,
            'NOITRU' as MALOAITOA,
            N'Nội trú ra viện' as TENLOAITOA
            FROM
            TT_BENHNHAN BN,
            TT_NOITRU_KHAMBENH KB,
            TT_NOITRU_TOATHUOC TT,
            TT_NOITRU_BENHAN BA
            WHERE
            KB.KHAMBENH_ID = TT.KHAMBENH_ID
            AND BA.BENHAN_ID = KB.BENHAN_ID
            AND BA.BENHNHAN_ID = BN.BENHNHAN_ID
            AND KB.ISTHUOCBV = '$ISTHUOCBV$'
            AND TT.KHOPHAT_ID = '$KHOXUAT_ID$'
            and TT.BENHVIEN_ID = '$BENHVIEN_ID$'
            <isNotEmpty prepend="and" property="TRANGTHAI_CHUAXUAT">
                TT.TRANGTHAI	= '$TRANGTHAI_CHUAXUAT$'
            </isNotEmpty>
            <isNotEmpty prepend="and" property="TRANGTHAI_DAXUAT">
                TT.TRANGTHAI	!= 'CHUAXUAT'
            </isNotEmpty>
            AND KB.RAVIEN = '1'
            AND CONVERT(date, TT.NGAYTAO) BETWEEN CONVERT(date, '$TUNGAY$')  AND  CONVERT(date, '$DENNGAY$')
            AND (TT.SOTHUTUTOA LIKE '%$KEYWORD$%' or BN.TENBENHNHAN LIKE N'%$KEYWORD$%' or BN.SOVAOVIEN LIKE N'%$KEYWORD$%')
            ) lst
        </statement>
        <statement id="DAO00030_KiemTraBenhNhanNoiTru" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
          SELECT BENHNHAN_ID
          FROM TT_NOITRU_BENHAN
          WHERE TIEPNHAN_ID = #TIEPNHAN_ID#
        </statement>
        <!--Revision:0-->
        <statement id="DAO00030_TOATHUOC_GetThongTinDuyet_NgoaiTru_Page" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
            select
            ROW_NUMBER() over (order by SOTHUTUTOA) as ROWNUMBER, *
            from
            (
            SELECT
            BN.TENBENHNHAN,
            BN.MAYTE,
            BN.SOVAOVIEN,
            CASE
            WHEN BN.GIOITINH = 1 THEN 'Nam'
            WHEN BN.GIOITINH = 2 THEN N'Nữ'
            END  AS GIOITINH,
            BN.NAMSINH,
            BN.DIACHILIENLAC as DIACHI,
            KBTT.KHAMBENH_TOATHUOC_ID,
            KBTT.SOTHUTUTOA,
            KB.PHONGBAN_ID,
            KB.BACSIKHAM_ID,
            KBTT.NGUOIDUYET_ID,
            KBTT.NGAYDUYET,
            KBTT.THOIGIANDUYET,
            KBTT.TRANGTHAI,
            KBTT.LYDOHUY,
            'NGOAITRU' as MALOAITOA,
            N'Ngoại trú BHYT' as TENLOAITOA
            FROM
            TT_BENHNHAN BN,
            TT_NGOAITRU_KHAMBENH KB,
            TT_NGOAITRU_KHAMBENH_TOATHUOC KBTT
            WHERE
            KB.KHAMBENH_ID = KBTT.KHAMBENH_ID
            AND KB.BENHNHAN_ID = BN.BENHNHAN_ID
            AND KBTT.DUYET = '$DUYET$'
            AND KBTT.CHUNGTUPHATTHUOC_ID is NULL
            AND KBTT.KHOXUAT_ID = '$KHOXUAT_ID$'
            AND LOAITOATHUOC = '$LOAITOATHUOC$'
            and KB.BENHVIEN_ID = '$BENHVIEN_ID$'
            AND CONVERT(date, KBTT.NGAYTOATHUOC) BETWEEN CONVERT(date, '$TUNGAY$')  AND  CONVERT(date, '$DENNGAY$')
            AND (KBTT.SOTHUTUTOA LIKE '%$KEYWORD$%' or BN.TENBENHNHAN LIKE N'%$KEYWORD$%' or BN.SOVAOVIEN LIKE N'%$KEYWORD$%')
            UNION ALL
            SELECT DISTINCT
            BN.TENBENHNHAN,
            BN.MAYTE,
            BN.SOVAOVIEN,
            CASE
            WHEN BN.GIOITINH = 1 THEN 'Nam'
            WHEN BN.GIOITINH = 2 THEN N'Nữ'
            END  AS GIOITINH,
            BN.NAMSINH,
            BN.DIACHILIENLAC as DIACHI,
            TT.KHAMBENH_ID as KHAMBENH_TOATHUOC_ID,
            TT.SOTHUTUTOA,
            KB.PHONGBAN_ID,
            KB.BACSIKHAM_ID,
            CASE
            WHEN TT.TRANGTHAI	= 'CHUAXUAT'  THEN NULL
            WHEN TT.TRANGTHAI	= 'DADUYET'  THEN KB.NGUOICAPNHAT_ID
            END  AS NGUOIDUYET_ID,
            null as NGAYDUYET,
            CASE
            WHEN TT.TRANGTHAI	= 'CHUAXUAT'  THEN NULL
            WHEN TT.TRANGTHAI	= 'DADUYET'  THEN KB.NGAYCAPNHAT
            END  AS THOIGIANDUYET,
            TT.TRANGTHAI AS TRANGTHAI,
            TT.GHICHU AS LYDOHUY,
            'NOITRU' as MALOAITOA,
            N'Nội trú ra viện' as TENLOAITOA
            FROM
            TT_BENHNHAN BN,
            TT_NOITRU_KHAMBENH KB,
            TT_NOITRU_TOATHUOC TT,
            TT_NOITRU_BENHAN BA
            WHERE
            KB.KHAMBENH_ID = TT.KHAMBENH_ID
            AND BA.BENHAN_ID = KB.BENHAN_ID
            AND BA.BENHNHAN_ID = BN.BENHNHAN_ID
            AND KB.ISTHUOCBV = '$ISTHUOCBV$'
            AND TT.KHOPHAT_ID = '$KHOXUAT_ID$'
            and TT.BENHVIEN_ID = '$BENHVIEN_ID$'
            <isNotEmpty prepend="and" property="TRANGTHAI_CHUAXUAT">
                TT.TRANGTHAI	= '$TRANGTHAI_CHUAXUAT$'
            </isNotEmpty>
            <isNotEmpty prepend="and" property="TRANGTHAI_DAXUAT">
                TT.TRANGTHAI	!= 'CHUAXUAT'
            </isNotEmpty>
            AND KB.RAVIEN = '1'
            AND CONVERT(date, TT.NGAYTAO) BETWEEN CONVERT(date, '$TUNGAY$')  AND  CONVERT(date, '$DENNGAY$')
            AND (TT.SOTHUTUTOA LIKE '%$KEYWORD$%' or BN.TENBENHNHAN LIKE N'%$KEYWORD$%' or BN.SOVAOVIEN LIKE N'%$KEYWORD$%')
            ) lst
            <isNotEmpty prepend="" property="FROMROW">
                where
                lst.ROWNUMBER between $FROMROW$ and $TOROW$
            </isNotEmpty>
        </statement>
        <!--Revision:0-->
        <statement id="DAO00030_TT_NGOAITRU_TOATHUOC_NGUOIMUA_Add" parameterClass="HashTable" resultClass="System.Int64">
          INSERT INTO TT_NGOAITRU_TOATHUOC_NGUOIMUA
          (
          TENNGUOIMUA
          ,HO
          ,TEN
          ,GIOITINH
          ,NGAYSINH
          ,NAMSINH
          ,SODIENTHOAI
          ,SONHA
          ,DIACHI
          ,DIACHICOQUAN
          ,TINHTHANH_ID
          ,QUANHUYEN_ID
          ,XAPHUONG_ID
          ,NGHENGHIEP_ID
          ,QUOCTICH_ID
          ,DANTOC_ID
          ,BENHVIEN_ID
          ,NGAYTAO
          ,NGUOITAO_ID
          ,NGAYCAPNHAT
          ,NGUOICAPNHAT_ID
          ,BACSIKEDON
          ,CHANDOAN
          )
          VALUES
          (
          #TENNGUOIMUA#
          ,#HO#
          ,#TEN#
          ,#GIOITINH#
          ,#NGAYSINH#
          ,#NAMSINH#
          ,#SODIENTHOAI#
          ,#SONHA#
          ,#DIACHI#
          ,#DIACHICOQUAN#
          ,#TINHTHANH_ID#
          ,#QUANHUYEN_ID#
          ,#XAPHUONG_ID#
          ,#NGHENGHIEP_ID#
          ,#QUOCTICH_ID#
          ,#DANTOC_ID#
          ,#BENHVIEN_ID#
          ,#NGAYTAO#
          ,#NGUOITAO_ID#
          ,#NGAYCAPNHAT#
          ,#NGUOICAPNHAT_ID#
          ,#BACSIKEDON#
          ,#CHANDOAN#
          )
          select SCOPE_identity() as value
        </statement>
        <!--Revision:0-->
        <update id="DAO00030_TT_NGOAITRU_TOATHUOC_NGUOIMUA_Upd" parameterClass="System.Collections.IDictionary">
          UPDATE TT_NGOAITRU_TOATHUOC_NGUOIMUA
          SET
          TENNGUOIMUA = #TENNGUOIMUA#
          ,HO = #HO#
          ,TEN = #TEN#
          ,GIOITINH = #GIOITINH#
          ,NGAYSINH = #NGAYSINH#
          ,NAMSINH = #NAMSINH#
          ,SODIENTHOAI = #SODIENTHOAI#
          ,SONHA = #SONHA#
          ,DIACHI = #DIACHI#
          ,DIACHICOQUAN = #DIACHICOQUAN#
          ,TINHTHANH_ID = #TINHTHANH_ID#
          ,QUANHUYEN_ID = #QUANHUYEN_ID#
          ,XAPHUONG_ID = #XAPHUONG_ID#
          ,NGHENGHIEP_ID = #NGHENGHIEP_ID#
          ,QUOCTICH_ID = #QUOCTICH_ID#
          ,DANTOC_ID = #DANTOC_ID#
          ,NGAYCAPNHAT = #NGAYCAPNHAT#
          ,NGUOICAPNHAT_ID = #NGUOICAPNHAT_ID#
          ,BACSIKEDON = #BACSIKEDON#
          ,CHANDOAN = #CHANDOAN#
          WHERE
          NGOAITRU_TOATHUOC_NGUOIMUA_ID = #NGOAITRU_TOATHUOC_NGUOIMUA_ID#
        </update>
        <!--Revision:0-->
        <statement id="DAO00030_Search_PhieuMuaHang" resultClass="DataObject">
            SELECT
            DISTINCT
            ct.CHUNGTU_ID
            ,MACHUNGTU
            ,NGAYLAPCHUNGTU as NGAYCHUNGTU
            ,ct.NGAYTAO
            ,nv.TENNHANVIEN as NGUOITAO
            ,
            CASE
            WHEN ct.STATE_CODE = 5 THEN N'Chờ nhập kho'
            WHEN ct.STATE_CODE = 6 THEN N'Đã nhập kho'
            END as TRANGTHAI
            FROM TT_PUR_CHUNGTU ct
            INNER JOIN TT_PUR_CHUNGTUCHITIET ctct on ct.CHUNGTU_ID = ctct.CHUNGTU_ID
            INNER JOIN TM_NHANVIEN nv on nv.NHANVIEN_ID = ct.NGUOITAO_ID
            WHERE
            ct.MALOAIPHIEU = 'DP'
            and ct.PROCESS_CODE = 'PO'
            and (ct.STATE_CODE = 5 or (ct.STATE_CODE = 6 and ctct.SOLUONGDANHAP &lt; ctct.SOLUONGYEUCAU))
            <isNotEmpty prepend="and" property="TUNGAY">
                CONVERT(date, ct.NGAYLAPCHUNGTU) BETWEEN CONVERT(date, '$TUNGAY$')  and  CONVERT(date, '$DENNGAY$')
            </isNotEmpty>
            <isNotEmpty prepend="and" property="TUKHOA">
                ct.MACHUNGTU LIKE '%$TUKHOA$%'
            </isNotEmpty>
            and ct.BENHVIEN_ID =  '$BENHVIEN_ID$'
            ORDER BY NGAYCHUNGTU
        </statement>
        <!--Revision:0-->
        <statement id="DAO00030_GetList_PO" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
            select *
            from TT_PUR_CHUNGTU
            where BENHVIEN_ID = '$BENHVIEN_ID$'
            <isParameterPresent>
                <isNotEmpty prepend="and" property="CHUNGTU_ID">
                    CHUNGTU_ID = '$CHUNGTU_ID$'
                </isNotEmpty>
                <isNotEmpty prepend="and" property="MACHUNGTU">
                    MACHUNGTU = '$MACHUNGTU$'
                </isNotEmpty>
            </isParameterPresent>
            order by CHUNGTU_ID
        </statement>
        <!--Revision:0-->
        <statement id="DAO00030_GetList_PO_CT" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
            SELECT
            ctct.*
            FROM
            TT_PUR_CHUNGTUCHITIET ctct
            inner join TM_PUR_LOAI loai on loai.ID = ctct.LOAI_ID
            WHERE
            CHUNGTU_ID = '$CHUNGTU_ID$'
            AND loai.MA = 'DP'
            and ISNULL(ctct.SOLUONGDANHAP,0) &lt; ISNULL(ctct.SOLUONGYEUCAU,0)
            and ctct.BENHVIEN_ID =  '$BENHVIEN_ID$'
        </statement>
        <!--Revision:0-->
        <update id="DAO00030_UpdateSoLuongDaNhap_PO" parameterClass="System.Collections.IDictionary">
            SELECT * INTO ##TempTable FROM
            (
            SELECT
            ctct.DONDATHANG_ID as CHUNGTUCHITIET_ID,
            SUM(ctct.SOLUONGTHUCTE) as SOLUONGDANHAP
            FROM
            TT_DUOC_CHUNGTU_CHITIET ctct
            INNER JOIN TT_DUOC_CHUNGTU ct on ct.CHUNGTU_ID = ctct.CHUNGTU_ID
            WHERE
            ctct.DONDATHANG_ID  IN ($LIST_CHUNGTUCHITIET_ID$)
            AND ct.TRANGTHAI = 'PNDNK'
            AND ct.BENHVIEN_ID = '$BENHVIEN_ID$'
            GROUP BY
            ctct.DONDATHANG_ID
            ) TEMP
            DECLARE @CHUNGTUCHITIET_ID int, @SOLUONGDANHAP int
            DECLARE _CURSOR CURSOR FOR  SELECT CHUNGTUCHITIET_ID, SOLUONGDANHAP FROM ##TempTable
            OPEN _CURSOR
            FETCH NEXT FROM _CURSOR
            INTO @CHUNGTUCHITIET_ID, @SOLUONGDANHAP
            WHILE @@FETCH_STATUS = 0
            BEGIN
            UPDATE TT_PUR_CHUNGTUCHITIET
            SET
            SOLUONGDANHAP = @SOLUONGDANHAP,
            NGUOICAPNHAT_ID = #NGUOICAPNHAT_ID#,
            NGAYCAPNHAT = getdate()
            WHERE
            CHUNGTUCHITIET_ID = @CHUNGTUCHITIET_ID
            AND BENHVIEN_ID = '$BENHVIEN_ID$'
            FETCH NEXT FROM _CURSOR
            INTO @CHUNGTUCHITIET_ID, @SOLUONGDANHAP;
            END
            CLOSE _CURSOR
            DEALLOCATE _CURSOR
            Drop table  ##TempTable
        </update>
        <!--Revision:0-->
        <update id="DAO00030_DeleteSoLuongDaNhap_PO" parameterClass="System.Collections.IDictionary">
            UPDATE TT_PUR_CHUNGTUCHITIET
            SET
            SOLUONGDANHAP =  SOLUONGDANHAP - #SOLUONGDANHAP#,
            NGUOICAPNHAT_ID = #NGUOICAPNHAT_ID#,
            NGAYCAPNHAT = getdate()
            WHERE
            CHUNGTUCHITIET_ID = #CHUNGTUCHITIET_ID#
            AND  SOLUONGDANHAP &gt;= #SOLUONGDANHAP#
            AND BENHVIEN_ID = '$BENHVIEN_ID$'
        </update>
        <!--Revision:0-->
        <update id="DAO00030_UpdateTrangThai_PO" parameterClass="System.Collections.IDictionary">
            IF EXISTS
            (
            SELECT ctct.CHUNGTU_ID
            FROM
            TT_PUR_CHUNGTUCHITIET ctct
            inner join TM_PUR_LOAI loai on loai.ID = ctct.LOAI_ID
            WHERE
            CHUNGTU_ID = '$CHUNGTU_ID$'
            AND loai.MA = 'DP'
            and ISNULL(ctct.SOLUONGDANHAP,0) &lt; ISNULL(ctct.SOLUONGYEUCAU,0)
            and ctct.BENHVIEN_ID =  '$BENHVIEN_ID$'
            )
            BEGIN
            UPDATE TT_PUR_CHUNGTU
            SET
            STATE_CODE = 6,
            STATE_NAME = N'Đã nhập kho',
            NGUOICAPNHAT_ID = #NGUOICAPNHAT_ID#,
            NGAYCAPNHAT = getdate()
            WHERE
            CHUNGTU_ID = '$CHUNGTU_ID$'
            END
            ELSE
            BEGIN
            UPDATE TT_PUR_CHUNGTU
            SET
            STATE_CODE = 8,
            STATE_NAME = N'Đã hoàn tất',
            NGUOICAPNHAT_ID = #NGUOICAPNHAT_ID#,
            NGAYCAPNHAT = getdate()
            WHERE
            CHUNGTU_ID = '$CHUNGTU_ID$'
            END
        </update>
        <!--Revision:0-->
        <statement id="DAO00030_KiemTraSoLoNhapDaPhatSinhLienQuan" resultClass="DataObject">
            SELECT row_count from
            (
            SELECT count(*) AS row_count
            FROM TT_DUOC_CHUNGTU_CHITIET
            WHERE SOLONHAP_ID IN ($LIST_SOLONHAP_ID$)
            and CHUNGTU_ID &gt; '$CHUNGTU_ID$'
            and BENHVIEN_ID = '$BENHVIEN_ID$'
            group by SOLONHAP_ID
            ) a
            WHERE row_count &gt;= 1
        </statement>
        <!--Revision:0-->
        <statement id="DAO00030_GetLOAITINHGIADUOC" resultClass="DataObject">
            select A.VALUE as LOAITINHGIADUOC, B.VALUE as SAPXEPTHEO
            from TM_SYS_APPSETTINGS A
            left join TM_SYS_APPSETTINGS B on B.CODE = 'PHA_CACHTINHGIADUOC_THEOLO'
            where A.CODE = 'APP_QUYTRINH_TINHGIADUOC'
        </statement>
        <!--Revision:0-->
        <statement id="DAO00030_KiemTraChungTuKhoaSo" resultClass="DataObject">
            SELECT CHUNGTU_ID
            FROM TT_DUOC_CHUNGTU
            WHERE
            MACHUNGTU = '$MACHUNGTU$'
            and BENHVIEN_ID = '$BENHVIEN_ID$'
            and
            convert(date, NGAYCHUNGTU) &lt;=
            (
            SELECT TOP 1 convert(date, KHOADENNGAY)
            FROM TT_DUOC_KHOASOCHUNGTU
            WHERE
            KHODUOC_ID = '$KHODUOC_ID$'
            and BENHVIEN_ID = '$BENHVIEN_ID$'
            AND KHOASO = '1'
            ORDER BY KHOADENNGAY DESC
            )
        </statement>
        <statement id="DAO00030_KiemTraChungTuDaChuyenKeToan" resultClass="DataObject">
          SELECT CHUNGTU_ID
          FROM TT_DUOC_CHUNGTU
          WHERE
          CHUNGTU_ID = '$CHUNGTU_ID$'
          and IDCHUYEN IS NOT NULL
          and BENHVIEN_ID = '$BENHVIEN_ID$'
        </statement>
        <statement id="DAO00030_KiemTraChungTuDaXacNhanBHYT" resultClass="DataObject">    
          select CT.MACHUNGTU, XNCT.XACNHANCHIPHICHITIET_ID from TT_XACNHANCHIPHICHITIET xnct
          join TT_VIENPHI vp on xnct.VIENPHI_ID = vp.VIENPHI_id and  (vp.REF_TABLE = 'TT_NGOAITRU_KHAMBENH_VTYT')
          join TT_DUOC_CHUNGTU_CHITIET ctct on ctct.KHAMBENH_VTYT_ID = vp.REF_ID
          join TT_DUOC_CHUNGTU ct on ct.CHUNGTU_ID = ctct.CHUNGTU_ID and ct.MUCDICHCHUNGTU_CODE = 'X13'
          WHERE
          ct.CHUNGTU_ID = '$CHUNGTU_ID$'
          and ct.BENHVIEN_ID = '$BENHVIEN_ID$'

          union all
          select CT.MACHUNGTU, XNCT.XACNHANCHIPHICHITIET_ID from TT_XACNHANCHIPHICHITIET xnct
          join TT_VIENPHI vp on xnct.VIENPHI_ID = vp.VIENPHI_id and  (vp.REF_TABLE = 'TT_NOITRU_TOATHUOC')
          join TT_DUOC_CHUNGTU_CHITIET ctct on ctct.TOATHUOCNOITRU_ID = vp.REF_ID
          join TT_DUOC_CHUNGTU ct on ct.CHUNGTU_ID = ctct.CHUNGTU_ID and ct.MUCDICHCHUNGTU_CODE = 'X13'
          WHERE
          ct.CHUNGTU_ID = '$CHUNGTU_ID$'
          and ct.BENHVIEN_ID = '$BENHVIEN_ID$'

          union all
          select CT.MACHUNGTU, XNCT.XACNHANCHIPHICHITIET_ID from TT_XACNHANCHIPHICHITIET xnct
          join TT_VIENPHI vp on xnct.VIENPHI_ID = vp.VIENPHI_id and  (vp.REF_TABLE = 'TT_CLSKETQUA_VTYT')
          join TT_DUOC_CHUNGTU_CHITIET ctct on ctct.CLSKETQUA_VTYT_ID = vp.REF_ID
          join TT_DUOC_CHUNGTU ct on ct.CHUNGTU_ID = ctct.CHUNGTU_ID and ct.MUCDICHCHUNGTU_CODE = 'X13'
          WHERE
          ct.CHUNGTU_ID = '$CHUNGTU_ID$'
          and ct.BENHVIEN_ID = '$BENHVIEN_ID$'

          union all
          select CT.MACHUNGTU, XNCT.XACNHANCHIPHICHITIET_ID from TT_XACNHANCHIPHICHITIET xnct
          join TT_VIENPHI vp on xnct.VIENPHI_ID = vp.VIENPHI_id and  (vp.REF_TABLE = 'TT_PHAUTHUAT_VTYT')
          join TT_DUOC_CHUNGTU_CHITIET ctct on ctct.PHAUTHUAT_VTYT_ID = vp.REF_ID
          join TT_DUOC_CHUNGTU ct on ct.CHUNGTU_ID = ctct.CHUNGTU_ID and ct.MUCDICHCHUNGTU_CODE = 'X13'
          WHERE
          ct.CHUNGTU_ID = '$CHUNGTU_ID$'
          and ct.BENHVIEN_ID = '$BENHVIEN_ID$'
        </statement>
        <!--Revision:0-->
        <statement id="DAO00030_LayNgayKhoaSoCuoi" resultClass="DataObject">
            SELECT TOP 1 KHOADENNGAY
            FROM TT_DUOC_KHOASOCHUNGTU
            WHERE
            KHODUOC_ID = '$KHODUOC_ID$'
            and BENHVIEN_ID = '$BENHVIEN_ID$'
            and KHOASO = '1'
            ORDER BY KHOADENNGAY DESC
        </statement>
        <!--Revision:0-->
        <statement id="DAO00030_KiemTraPhatSinhChungTuLienQuan" resultClass="DataObject">
            SELECT CHUNGTU_ID
            FROM TT_DUOC_CHUNGTU
            WHERE
            CHUNGTULIENQUAN_ID = '$CHUNGTU_ID$'
            and BENHVIEN_ID = '$BENHVIEN_ID$'
        </statement>
        <!--Revision:0-->
        <statement id="DAO00030_GetGoiThau" resultClass="DataObject">
            SELECT DISTINCT DIC.*, HD.NHACUNGCAP_ID, HD.NGAYHETHAN, HD.GIAHOPDONG_ID
            FROM
            LST_DICTIONARY DIC inner join TM_GIAHOPDONG HD on DIC.DICTIONARY_ID = HD.GOITHAU_ID
            WHERE
            DICTIONARY_TYPE_CODE = 'DM_goithau'
            and HD.NHACUNGCAP_ID = '$NHACUNGCAP_ID$'
            and HD.NGAYHETHAN &gt;= getdate()
            <!--and DIC.BENHVIEN_ID = '$BENHVIEN_ID$'-->
            ORDER BY HD.NGAYHETHAN DESC
        </statement>
        <!--Revision:0-->
        <statement id="DAO00030_GetGiaThauChiTiet" resultClass="DataObject">
            SELECT TOP 1 hdct.*
            FROM TM_GIAHOPDONGCHITIET hdct
            inner join TM_GIAHOPDONG hd on hd.GIAHOPDONG_ID = hdct.GIAHOPDONG_ID
            WHERE
            hd.NHACUNGCAP_ID = '$NHACUNGCAP_ID$'
            AND convert(date, GETDATE()) &gt;= hd.NGAYCUNGCAP
            AND hd.NGAYHETHAN &gt; convert(date, GETDATE())
            AND hdct.DUOC_ID =  '$DUOC_ID$'
            AND hdct.DONVITINH_ID = '$DONVITINH_ID$'
            AND hdct.BENHVIEN_ID = '$BENHVIEN_ID$'
            <isNotEmpty prepend="and" property="GIAHOPDONG_ID">
                hd.GIAHOPDONG_ID = '$GIAHOPDONG_ID$'
            </isNotEmpty>
            ORDER BY hdct.DONGIAHOPDONG
        </statement>
        <!--Revision:0-->
        <statement id="DAO00030_GetSoViSa" resultClass="DataObject">
            select *
            from TM_DUOC
            where
            DUOC_ID = '$DUOC_ID$'
            and BENHVIEN_ID = '$BENHVIEN_ID$'
        </statement>
        <!--Revision:0-->
        <statement id="DAO00030_GetDVTQuyDoi" resultClass="DataObject">
            select *
            from TM_DONVITINH
            where
            DONVICOBAN_ID = '$DONVITINH_ID$'
            and BENHVIEN_ID = '$BENHVIEN_ID$'
            order by DONVITINH_ID
        </statement>
        <!--Revision:0-->
        <statement id="DAO00030_GetGiaMarkup" resultClass="DataObject">
            DECLARE @TYLE NUMERIC(5,2)
            DECLARE @DONGIABAN NUMERIC(18,2)
            DECLARE @DECLAMTRON INT
            SELECT TOP 1  @DECLAMTRON = LAMTRON
            FROM  TM_DONGIA_DEFINITIONS_LAMTRON
            WHERE DONGIA &gt;=  $GIAVAO$
            ORDER BY DONGIA ASC
            SELECT TOP 1  @TYLE = TYLE
            FROM TM_DUOC_DONGIA_DEFINITIONS
            WHERE DONGIA &gt;=  $GIAVAO$ AND LOAIVATTU_ID IN (SELECT LOAIVATTU_ID FROM TM_DUOC D
            JOIN TM_LOAIDUOC LD ON D.LOAIDUOC_ID = LD.LOAIDUOC_ID
            WHERE D.DUOC_ID= $DUOC_ID$ )
            ORDER BY DONGIA ASC
            SET @DONGIABAN=ROUND(($GIAVAO$ * (1 + (@TYLE ) / 100))/@DECLAMTRON,2)*@DECLAMTRON
            SELECT @DONGIABAN
        </statement>
        <!--Revision:0-->
        <statement id="DAO00030_GetGiaMarkup_LaySoLamTron" resultClass="DataObject">
          SELECT TOP 1 LAMTRON
          FROM  TM_DONGIA_DEF_LAMTRON
          WHERE DONGIA &gt;=  $GIAVAO$
            ORDER BY DONGIA ASC
        </statement>
        <!--Revision:0-->
        <statement id="DAO00030_GetGiaMarkup_LayTyLe" resultClass="DataObject">
            SELECT TOP 1 TYLE
            FROM TM_DUOC_DONGIA_DEFINITIONS
            WHERE DONGIA &gt;=  $GIAVAO$             
            <isNotEmpty prepend="and" property="KHODUOC_ID">
                KHODUOC_ID = '$KHODUOC_ID$'
            </isNotEmpty>
            AND LOAIVATTU_ID IN (SELECT LOAIVATTU_ID FROM TM_DUOC D
            JOIN TM_LOAIDUOC LD ON D.LOAIDUOC_ID = LD.LOAIDUOC_ID
            WHERE D.DUOC_ID= $DUOC_ID$)
            ORDER BY DONGIA ASC
        </statement>
        <!--Revision:0-->
        <statement id="DAO00030_GetGiaNhapDuocGanNhat" resultClass="DataObject">
            SELECT TOP 1 DONGIAMUA
            FROM
            TT_DUOC_CHUNGTU CT
            inner join TT_DUOC_CHUNGTU_CHITIET CTCT on CT.CHUNGTU_ID = CTCT.CHUNGTU_ID
            inner join LST_DICTIONARY md on md.DICTIONARY_ID = ct.MUCDICHCHUNGTU_ID
            WHERE
            CTCT.DUOC_ID = '$DUOC_ID$'
            and CTCT.DONVITINH_ID = '$DONVITINH_ID$'
            and CT.BENHVIEN_ID = '$BENHVIEN_ID$'
            and md.DICTIONARY_CODE = 'N01'
            and md.DICTIONARY_TYPE_CODE = 'MucDichChungTu'
            ORDER BY CTCT.SOLONHAP_ID DESC
        </statement>
        <!--Revision:0-->
        <statement id="DAO00030_GetDuocVAT" resultClass="DataObject">
            SELECT *
            FROM
            TM_DUOC_VAT
            WHERE
            KHODUOC_ID = '$KHODUOC_ID$'
            AND LOAIDUOC = '$LOAIDUOC$'
            AND BENHVIEN_ID = '$BENHVIEN_ID$'
        </statement>
        <!--Revision:0-->
        <statement id="DAO00030_GetHoiDongKiemNhap" resultClass="DataObject">
            select *
            from TM_HOIDONG_KIEMNHAP
            where
            HIEULUC = '1'
            AND BENHVIEN_ID = '$BENHVIEN_ID$'
        </statement>
        <!--Revision:0-->
        <statement id="DAO00030_GetHoiDongThanhLy" resultClass="DataObject">
            select *
            from TM_HOIDONG_THANHLY
            where
            HIEULUC = '1'
            AND BENHVIEN_ID = '$BENHVIEN_ID$'
        </statement>
        <!--Revision:0-->
        <statement id="DAO00030_GetHoiDongKiemKe" resultClass="DataObject">
            select *
            from TM_HOIDONG_KIEMKE
            where
            HIEULUC = '1'
            AND BENHVIEN_ID = '$BENHVIEN_ID$'
        </statement>
        <!--Revision:0-->
        <statement id="DAO00030_GetMucDichChungTuID" resultClass="DataObject">
            SELECT DICTIONARY_ID
            FROM
            LST_DICTIONARY
            WHERE
            DICTIONARY_TYPE_CODE = 'MucDichChungTu'
            and DICTIONARY_CODE = '$MUCDICHCHUNGTU_CODE$'
            <!--and BENHVIEN_ID = '$BENHVIEN_ID$'-->
        </statement>
        <statement id="DAO00030_GetTiepNhanIDByKhamBenhToaThuocID" resultClass="DataObject">
          select TIEPNHAN_ID from TT_NGOAITRU_KHAMBENH_TOATHUOC WHERE KHAMBENH_TOATHUOC_ID = #KHAMBENH_TOATHUOC_ID#         
        </statement>
      <statement id="DAO00030_GetNguonDuocMienPhi" resultClass="DataObject">
            SELECT NGUONDUOC_ID
            FROM
            TM_NGUONHANG
            WHERE 
            TINHTIEN = 0
            AND BENHVIEN_ID = '$BENHVIEN_ID$'            
        </statement>
        <!--Revision:0-->
        <statement id="DAO00030_LayChungTuChuaPhatSinhTrongKy" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
            SELECT
            CHUNGTU_ID
            FROM TT_DUOC_CHUNGTU
            WHERE
            MONTH(NGAYCHUNGTU) = month('$KHOADENNGAY$')
            AND YEAR(NGAYCHUNGTU) = year('$KHOADENNGAY$')
            AND (KHOXUAT_ID = '$KHODUOC_ID$' OR KHONHAP_ID = '$KHODUOC_ID$')
            and BENHVIEN_ID = '$BENHVIEN_ID$'
        </statement>
        <!--Revision:0-->
        <statement id="DAO00030_LayChungTuPhatSinhTrongKyChuaHoanThien" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
            SELECT
            CHUNGTU_ID
            FROM TT_DUOC_CHUNGTU
            WHERE
            MONTH(NGAYCHUNGTU) = month('$KHOADENNGAY$')
            AND YEAR(NGAYCHUNGTU) = year('$KHOADENNGAY$')
            AND (KHOXUAT_ID = '$KHODUOC_ID$' OR KHONHAP_ID = '$KHODUOC_ID$')
            AND (TRANGTHAI = 'PNCNK' or TRANGTHAI = 'CHUATHANHTOAN' or  TRANGTHAI = 'CXN')
            and BENHVIEN_ID = '$BENHVIEN_ID$'
        </statement>
        <!--Revision:0-->
        <statement id="DAO00030_KiemTraChungTuNhapNCCChuaHoanTat" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
          SELECT
          CHUNGTU_ID,
          MACHUNGTU,
          NGAYCHUNGTU,
          KN.TENKHO AS TENKHONHAP,
          KX.TENKHO AS TENKHOXUAT,
          N'Nhập nhà cung cấp' as MUCDICHCHUNGTU,
          mdct.DICTIONARY_CODE
          FROM TT_DUOC_CHUNGTU ct
          INNER JOIN LST_DICTIONARY mdct ON mdct.DICTIONARY_ID = ct.MUCDICHCHUNGTU_ID
          LEFT JOIN TM_KHODUOC KN ON KN.KHODUOC_ID = ct.KHONHAP_ID
          LEFT JOIN TM_KHODUOC KX ON KX.KHODUOC_ID = ct.KHOXUAT_ID
          WHERE
          MONTH(ct.NGAYCHUNGTU) = month('$KHOADENNGAY$') AND YEAR(ct.NGAYCHUNGTU) = year('$KHOADENNGAY$')
          AND mdct.DICTIONARY_CODE = 'N01'
          AND ct.KHONHAP_ID = '$KHODUOC_ID$'
          AND ct.TRANGTHAI = 'PNCNK'
          AND ct.BENHVIEN_ID = '$BENHVIEN_ID$'
        </statement>
        <!--Revision:0-->
        <statement id="DAO00030_KiemTraChungTuTraNCCChuaHoanTat" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
          SELECT
          CHUNGTU_ID,
          MACHUNGTU,
          NGAYCHUNGTU,
          KN.TENKHO AS TENKHONHAP,
          KX.TENKHO AS TENKHOXUAT,
          N'Trả nhà cung cấp' as MUCDICHCHUNGTU,
          mdct.DICTIONARY_CODE
          FROM TT_DUOC_CHUNGTU ct
          INNER JOIN LST_DICTIONARY mdct ON mdct.DICTIONARY_ID = ct.MUCDICHCHUNGTU_ID
          LEFT JOIN TM_KHODUOC KN ON KN.KHODUOC_ID = ct.KHONHAP_ID
          LEFT JOIN TM_KHODUOC KX ON KX.KHODUOC_ID = ct.KHOXUAT_ID
          WHERE
          MONTH(ct.NGAYCHUNGTU) = month('$KHOADENNGAY$') AND YEAR(ct.NGAYCHUNGTU) = year('$KHOADENNGAY$')
          AND mdct.DICTIONARY_CODE = 'X01'
          AND ct.KHOXUAT_ID = '$KHODUOC_ID$'
          AND ct.TRANGTHAI = 'CXN'
          AND ct.BENHVIEN_ID = '$BENHVIEN_ID$'
        </statement>
        <!--Revision:0-->
        <statement id="DAO00030_KiemTraChungTuXuatNoiBoChuaNhapKho" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
          SELECT
          CHUNGTU_ID,
          MACHUNGTU,
          NGAYCHUNGTU,
          KN.TENKHO AS TENKHONHAP,
          KX.TENKHO AS TENKHOXUAT,
          N'Xuất nội bộ' as MUCDICHCHUNGTU,
          mdct.DICTIONARY_CODE
          FROM TT_DUOC_CHUNGTU ct
          INNER JOIN LST_DICTIONARY mdct ON mdct.DICTIONARY_ID = ct.MUCDICHCHUNGTU_ID
          LEFT JOIN TM_KHODUOC KN ON KN.KHODUOC_ID = ct.KHONHAP_ID
          LEFT JOIN TM_KHODUOC KX ON KX.KHODUOC_ID = ct.KHOXUAT_ID
          WHERE
          MONTH(ct.NGAYCHUNGTU) = month('$KHOADENNGAY$') AND YEAR(ct.NGAYCHUNGTU) = year('$KHOADENNGAY$')
          AND mdct.DICTIONARY_CODE = 'X07'
          AND ct.CHUNGTULIENQUAN_ID is null
          AND ct.KHOXUAT_ID = '$KHODUOC_ID$'
          AND ct.BENHVIEN_ID = '$BENHVIEN_ID$'
        </statement>
        <!--Revision:0-->
        <statement id="DAO00030_KiemTraChungTuHoanTraChuaNhapKho" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
          SELECT
          CHUNGTU_ID,
          MACHUNGTU,
          NGAYCHUNGTU,
          KN.TENKHO AS TENKHONHAP,
          KX.TENKHO AS TENKHOXUAT,
          N'Hoàn trả nội bộ' as MUCDICHCHUNGTU,
          mdct.DICTIONARY_CODE
          FROM TT_DUOC_CHUNGTU ct
          INNER JOIN LST_DICTIONARY mdct ON mdct.DICTIONARY_ID = ct.MUCDICHCHUNGTU_ID
          LEFT JOIN TM_KHODUOC KN ON KN.KHODUOC_ID = ct.KHONHAP_ID
          LEFT JOIN TM_KHODUOC KX ON KX.KHODUOC_ID = ct.KHOXUAT_ID
          WHERE
          MONTH(ct.NGAYCHUNGTU) = month('$KHOADENNGAY$') AND YEAR(ct.NGAYCHUNGTU) = year('$KHOADENNGAY$')
          AND mdct.DICTIONARY_CODE = 'X05'
          AND ct.CHUNGTULIENQUAN_ID is null
          AND ct.KHOXUAT_ID = '$KHODUOC_ID$'
          AND ct.BENHVIEN_ID = '$BENHVIEN_ID$'
        </statement>

        <statement id="DAO00030_GetChungTuChuaHoanTat" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
          SELECT
          CHUNGTU_ID,
          MACHUNGTU,
          NGAYCHUNGTU,
          CASE
          WHEN MUCDICHCHUNGTU_CODE = 'N01' THEN KN.TENKHO 
          WHEN MUCDICHCHUNGTU_CODE = 'X01' THEN KX.TENKHO
          WHEN MUCDICHCHUNGTU_CODE = 'X07' THEN KN.TENKHO
          WHEN MUCDICHCHUNGTU_CODE = 'X05' THEN KN.TENKHO
          END  AS KHOTHUCHIEN,

          CASE
          WHEN MUCDICHCHUNGTU_CODE = 'N01' THEN N'Chuyển trạng thái nhập kho hoặc xóa'
          WHEN MUCDICHCHUNGTU_CODE = 'X01' THEN N'Chuyển trạng thái xác nhận hoặc xóa'
          WHEN MUCDICHCHUNGTU_CODE = 'X07' THEN N'Nhập nội bộ'
          WHEN MUCDICHCHUNGTU_CODE = 'X05' THEN N'Nhập hoàn trả'
          END  AS HANHDONG

          FROM TT_DUOC_CHUNGTU ct
          LEFT JOIN TM_KHODUOC KN ON KN.KHODUOC_ID = ct.KHONHAP_ID
          LEFT JOIN TM_KHODUOC KX ON KX.KHODUOC_ID = ct.KHOXUAT_ID
          WHERE
          CT.CHUNGTU_ID IN ($LIST_CHUNGTU_ID$)
        </statement>
        <!--Revision:0-->
        <statement id="DAO00030_LayKyKhoaSoTheoKho" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
            SELECT
            KHODUOC_ID
            FROM TT_DUOC_KHOASOCHUNGTU
            WHERE
            KYTONKHO = '$KYTONKHO$'
            AND KHODUOC_ID = '$KHODUOC_ID$'
            AND KHOASO = '1'
            and BENHVIEN_ID = '$BENHVIEN_ID$'
        </statement>
        <!--Revision:0-->
        <statement id="DAO00030_GetKhoDuocDoiTuong" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
            select kd.* from TM_DOITUONG_KHODUOC kd
            inner join TM_DOITUONG dt on dt.DOITUONG_ID = kd.DOITUONG_ID
            WHERE
            kd.NGAYTRONGTUAN = '$NGAYTRONGTUAN$'            
            and dt.MADOITUONG = '$MADOITUONG$'
            and kd.KHODUOC_ID = '$KHODUOC_ID$'
            and kd.BENHVIEN_ID = '$BENHVIEN_ID$'
        </statement>
        <!--Revision:0-->
        <statement id="DAO00030_GetDanhSachToaThuoc" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
          declare @tungay datetime = CONVERT(date, '$TUNGAY$')
          declare @denngay datetime = CONVERT(date, DATEADD(day, 1, '$DENNGAY$'))
          
          select * from
          (select * , COUNT(*) OVER() as TOTALROWS,  ROW_NUMBER() OVER(order by ds.CHUNGTU_ID asc) as ROWNUMBER
          from
          (
          SELECT distinct CT.CHUNGTU_ID, CT.TIEPNHAN_ID,KB.DICHVU_ID,YC.DVYEUCAU_ID , KBTT.BACSI_ID,KBTT.KHAMBENH_TOATHUOC_ID	  ,BN.TENBENHNHAN,BN.BENHNHAN_ID
          ,BN.MAYTE,BN.NAMSINH,BN.GIOITINH AS GIOITINH_ID,TN.SOTIEPNHAN,ISNULL(CT.DAXACNHAN,'0') DAXACNHAN,CONVERT(nvarchar(10), KBTT.NGAYTOATHUOC, 103) NGAYTOATHUOC,
          tn.SOBHYT, TN.NGAYTIEPNHAN, CT.NGAYCHUNGTU, ttnt.TENTOATHUOC, pb.TENPHONGBAN
          FROM TT_DUOC_CHUNGTU CT
          INNER JOIN TT_NGOAITRU_KHAMBENH_TOATHUOC KBTT ON (CT.CHUNGTU_ID =KBTT.CHUNGTUPHATTHUOC_ID AND KBTT.LOAITOATHUOC = 'BV')
          INNER JOIN TT_NGOAITRU_TOATHUOC TT ON KBTT.KHAMBENH_TOATHUOC_ID = TT.KHAMBENH_TOATHUOC_ID
          INNER JOIN TT_TIEPNHAN TN ON CT.TIEPNHAN_ID =TN.TIEPNHAN_ID
          INNER JOIN TT_BENHNHAN BN ON TN.BENHNHAN_ID =BN.BENHNHAN_ID
          INNER JOIN TT_XACNHANCHIPHI xncp ON xncp.TIEPNHAN_ID =TN.TIEPNHAN_ID
          LEFT JOIN TT_NGOAITRU_KHAMBENH KB ON TT.KHAMBENH_ID=KB.KHAMBENH_ID
          LEFT JOIN TT_DVYEUCAU YC ON KB.KHAMBENH_ID =YC.KHAMBENH_NGOAITRU_ID
          left join TM_TOATHUOC_NGOAITRU ttnt on ttnt.MATOATHUOC = KBTT.MATOATHUOC
          left join TM_PHONGBAN pb on pb.PHONGBAN_ID = KB.PHONGBAN_ID
          <dynamic prepend="where">
                <isParameterPresent>
                    <isNotEmpty prepend="and" property="DAXACNHAN">
                      isnull(CT.DAXACNHAN,'0') = '$DAXACNHAN$'
                    </isNotEmpty>
                    <isNotEmpty prepend="and" property="TUNGAY">
                      xncp.NGAYXACNHAN &#62;&#61; @tungay
                    </isNotEmpty>
                    <isNotEmpty prepend="and" property="DENNGAY">
                      xncp.NGAYXACNHAN &#60; @denngay
                    </isNotEmpty>
                    <isNotEmpty prepend="and" property="BENHVIEN_ID">
                        CT.BENHVIEN_ID = '$BENHVIEN_ID$'
                    </isNotEmpty>
                    <isNotEmpty prepend="and" property="MAYTE">
                        (BN.MAYTE LIKE '%$MAYTE$%' OR  BN.TENBENHNHAN LIKE N'%$MAYTE$%')
                    </isNotEmpty>
                    <isNotEmpty prepend="" property="PHA_XACNHAN_LINHTHUOC_THEOKHO">
                      <isEqual prepend="" property="PHA_XACNHAN_LINHTHUOC_THEOKHO" compareValue="True">
                        AND Ct.KHOXUAT_ID = '$KHOXUAT_ID$'
                      </isEqual>
                    </isNotEmpty>
                </isParameterPresent>
            </dynamic>
          <!--UNION ALL
          SELECT distinct CT.CHUNGTU_ID, CT.TIEPNHAN_ID,yc.DICHVU_ID,YC.DVYEUCAU_ID, NULL AS BACSI_ID,NULL AS KHAMBENH_TOATHUOC_ID	  ,BN.TENBENHNHAN,BN.BENHNHAN_ID
          ,BN.MAYTE,BN.NAMSINH,BN.GIOITINH AS GIOITINH_ID,TN.SOTIEPNHAN,ISNULL(CT.DAXACNHAN,'0') DAXACNHAN,CONVERT(nvarchar(10), NT_TT.NGAYTAO, 103) NGAYTOATHUOC,
          tn.SOBHYT
          FROM TT_DUOC_CHUNGTU CT
          INNER JOIN TT_NOITRU_TOATHUOC NT_TT ON CT.CHUNGTU_ID = NT_TT.CHUNGTU_ID
          INNER JOIN TT_NOITRU_KHAMBENH KB ON (KB.KHAMBENH_ID = NT_TT.KHAMBENH_ID AND KB.RAVIEN = '1')
          INNER JOIN TT_TIEPNHAN TN ON CT.TIEPNHAN_ID =TN.TIEPNHAN_ID
          INNER JOIN TT_BENHNHAN BN ON TN.BENHNHAN_ID =BN.BENHNHAN_ID
          LEFT JOIN TT_DVYEUCAU YC ON KB.KHAMBENH_ID =YC.KHAMBENH_NGOAITRU_ID
          <dynamic prepend="where">
            <isParameterPresent>
              <isNotEmpty prepend="and" property="DAXACNHAN">
                isnull(CT.DAXACNHAN,'0') = '$DAXACNHAN$'
              </isNotEmpty>
              <isNotEmpty prepend="and" property="TUNGAY">
                convert(date, NGAYCHUNGTU) &gt;= '$TUNGAY$'
              </isNotEmpty>
              <isNotEmpty prepend="and" property="DENNGAY">
                convert(date, NGAYCHUNGTU) &lt;= '$DENNGAY$'
              </isNotEmpty>
              <isNotEmpty prepend="and" property="BENHVIEN_ID">
                CT.BENHVIEN_ID = '$BENHVIEN_ID$'
              </isNotEmpty>
              <isNotEmpty prepend="and" property="MAYTE">
                BN.MAYTE LIKE '%$MAYTE$%' OR  BN.TENBENHNHAN LIKE N'%$MAYTE$%'
              </isNotEmpty>
            </isParameterPresent>
          </dynamic>-->
          ) ds
          ) ls
          <isNotEmpty prepend="" property="FROMROW">
            where
            ls.ROWNUMBER between $FROMROW$ and $TOROW$
          </isNotEmpty>
        </statement>
      <statement id="DAO00030_GetDanhSachXacNhanPhatThuoc" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
        select * from
        (select * , COUNT(*) OVER() as TOTALROWS,  ROW_NUMBER() OVER(order by ds.CHUNGTU_ID asc) as ROWNUMBER
        from
        (
        SELECT distinct CT.CHUNGTU_ID, CT.TIEPNHAN_ID,KB.DICHVU_ID,YC.DVYEUCAU_ID , KBTT.BACSI_ID,KBTT.KHAMBENH_TOATHUOC_ID	  ,BN.TENBENHNHAN,BN.BENHNHAN_ID
        ,BN.MAYTE,BN.NAMSINH,BN.GIOITINH AS GIOITINH_ID,TN.SOTIEPNHAN,ISNULL(CT.DAXACNHAN,'0') DAXACNHAN,CONVERT(nvarchar(10), KBTT.NGAYTOATHUOC, 103) NGAYTOATHUOC,
        tn.SOBHYT, TN.NGAYTIEPNHAN, CT.NGAYCHUNGTU, ttnt.TENTOATHUOC
        FROM TT_DUOC_CHUNGTU CT
        INNER JOIN TT_NGOAITRU_KHAMBENH_TOATHUOC KBTT ON CT.CHUNGTU_ID = KBTT.CHUNGTUPHATTHUOC_ID and (KBTT.LOAITOATHUOC != 'MN' and KBTT.LOAITOATHUOC != 'BV')  AND CT.MUCDICHCHUNGTU_CODE != 'X19'
        INNER JOIN TT_NGOAITRU_TOATHUOC TT ON KBTT.KHAMBENH_TOATHUOC_ID = TT.KHAMBENH_TOATHUOC_ID
        INNER JOIN TT_TIEPNHAN TN ON CT.TIEPNHAN_ID =TN.TIEPNHAN_ID
        INNER JOIN TT_BENHNHAN BN ON TN.BENHNHAN_ID =BN.BENHNHAN_ID        
        LEFT JOIN TT_NGOAITRU_KHAMBENH KB ON TT.KHAMBENH_ID = KB.KHAMBENH_ID
        LEFT JOIN TT_DVYEUCAU YC ON KB.KHAMBENH_ID = YC.KHAMBENH_NGOAITRU_ID
        left join TM_TOATHUOC_NGOAITRU ttnt on ttnt.MATOATHUOC = KBTT.MATOATHUOC
        <dynamic prepend="where">
          <isParameterPresent>
            <isNotEmpty prepend="and" property="DAXACNHAN">
              isnull(CT.DAXACNHAN,'0') = '$DAXACNHAN$'
            </isNotEmpty>
            <isEqual prepend="and" property="DOITUONG" compareValue="BHYT">
              len(isnull(tn.SOBHYT,'')) != 0
            </isEqual>
            <isEqual prepend="and" property="DOITUONG" compareValue="VP">
              len(isnull(tn.SOBHYT,'')) = 0
            </isEqual>
            <isNotEmpty prepend="and" property="TUNGAY">
              cast(ct.NGAYCHUNGTU as date) &#62;&#61; '$TUNGAY$'
            </isNotEmpty>
            <isNotEmpty prepend="and" property="DENNGAY">
              cast(ct.NGAYCHUNGTU as date) &#60;&#61; '$DENNGAY$'
            </isNotEmpty>
            <isNotEmpty prepend="and" property="BENHVIEN_ID">
              CT.BENHVIEN_ID = '$BENHVIEN_ID$'
            </isNotEmpty>
            <isNotEmpty prepend="and" property="MAYTE">
              (BN.MAYTE LIKE '%$MAYTE$%' OR  BN.TENBENHNHAN LIKE N'%$MAYTE$%')
            </isNotEmpty>           
          </isParameterPresent>
        </dynamic>        
        ) ds
        ) ls
        <isNotEmpty prepend="" property="FROMROW">
          where
          ls.ROWNUMBER between $FROMROW$ and $TOROW$
        </isNotEmpty>
      </statement>
        <!--Revision:0-->
        <statement id="DAO00030_GetDetailToaThuoc" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
          SELECT CTCT.DUOC_ID,tmd.DONVITINH_ID,CTCT.HANDUNG,SOLO.SOLONHAP,CTCT.SOLUONGDAXUAT,SOLO.SOLOSANPHAM SOCHUNGTUGOC,CT.KHOXUAT_ID,CONVERT(nvarchar(10), CT.NGAYCHUNGTU, 103) NGAYCHUNGTU,CT.MACHUNGTU, CTCT.DONGIAVON AS DONGIA
          FROM TT_DUOC_CHUNGTU CT
          INNER JOIN TT_DUOC_CHUNGTU_CHITIET CTCT ON CT.CHUNGTU_ID=CTCT.CHUNGTU_ID
          INNER JOIN TT_DUOC_CHUNGTU_SOLONHAP SOLO ON CTCT.SOLONHAP_ID=SOLO.SOLONHAP_ID
          left join TM_DUOC tmd on tmd.DUOC_ID = CTCT.DUOC_ID
          WHERE CT.CHUNGTU_ID='$CHUNGTU_ID$' AND CT.BENHVIEN_ID='$BENHVIEN_ID$'
        </statement>
        <!--Revision:0-->
        <update id="DAO00030_XacNhanPhatThuoc" parameterClass="System.Collections.IDictionary">
            update TT_DUOC_CHUNGTU set
            DAXACNHAN = #STATUS#
            <!--<isNotEmpty prepend="," property="NGAYCHUNGTU">
              NGAYCHUNGTU = #NGAYCHUNGTU#
            </isNotEmpty>-->
            , NGAYCAPNHAT = #NGAYCAPNHAT#
            , NGUOICAPNHAT_ID = #NGUOICAPNHAT_ID#
            where
            CHUNGTU_ID = '$CHUNGTU_ID$'
        </update>

        <statement id="DAO00030_KiemTraCoTinhVATGiaVon" parameterClass="System.Collections.IDictionary" resultClass="DataObject">        
          SELECT KHODUOC_ID
            FROM TM_KHODUOC_TYLEVAT
          WHERE
	          KHODUOC_ID = $KHODUOC_ID$	   
	          and BENHVIEN_ID = '$BENHVIEN_ID$'
	          <isEqual prepend="AND" property="LOAIVATTU" compareValue="T">
                  T_TYLEVAT = '1'
            </isEqual>
	          <isEqual prepend="AND" property="LOAIVATTU" compareValue="H">
                  H_TYLEVAT = '1'
              </isEqual>
	          <isEqual prepend="AND" property="LOAIVATTU" compareValue="V">
                  V_TYLEVAT = '1'
            </isEqual>
      </statement>
      <statement id="DAO00030_GetKhoDuocMapping" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
        SELECT * FROM TM_KHODUOC_MAPPING
        WHERE
        KHONGUON_ID = $KHONGUON_ID$ 
        AND KHODICH_ID = $KHODICH_ID$
        AND BENHVIEN_ID ='$BENHVIEN_ID$'
      </statement>
       <statement id="DAO00030_GetKhoDuocTheoPhamVi" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
         SELECT TOP 1 * FROM TM_DUOC_PHAMVISD_MAPPING
         WHERE
         PHAMVI_ID = $PHAMVI_ID$       
       </statement>
      <statement id="DAO00030_GetListPhamViBy2KhoDuoc" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
        SELECT DISTINCT A.PHAMVI_ID FROM
        (
        SELECT *
        FROM TM_DUOC_PHAMVISD_MAPPING
        WHERE
        KHODUOC_ID = $KHOXUAT_ID$
        AND BENHVIEN_ID ='$BENHVIEN_ID$'
        AND TAMNGUNG = '0'
        )A
        INNER JOIN
        (
        SELECT*
        FROM TM_DUOC_PHAMVISD_MAPPING
        WHERE
        KHODUOC_ID = $KHONHAP_ID$
        AND TAMNGUNG = '0'
        AND BENHVIEN_ID ='$BENHVIEN_ID$'
        )B ON A.PHAMVI_ID = B.PHAMVI_ID       
      </statement>
      <statement id="DAO00030_GetListPhamViBy1KhoDuoc" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
        SELECT mp.* FROM
        TM_DUOC_PHAMVISD_MAPPING mp
        INNER JOIN TM_DUOC_PHAMVISUDUNG pv ON mp.PHAMVI_ID = pv.PHAMVI_ID
        WHERE
        mp.KHODUOC_ID = $KHODUOC_ID$
        AND pv.TAMNGUNG = '0'
        AND mp.PHAMVI_ID
        NOT IN
        (SELECT PHAMVI_ID
        FROM
        TM_DUOC_PHAMVISD_MAPPING
        WHERE KHODUOC_ID != $KHODUOC_ID$)
      </statement>    

      <statement id="DAO00030_GetPhamViByKhoDuoc" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
        SELECT DISTINCT pv.PHAMVI_ID
        FROM TM_DUOC_PHAMVISD_MAPPING mp
        INNER JOIN TM_DUOC_PHAMVISUDUNG pv ON mp.PHAMVI_ID = pv.PHAMVI_ID
        WHERE
        mp.KHODUOC_ID IN ($KHODUOC_ID$)
        AND mp.BENHVIEN_ID ='$BENHVIEN_ID$'
        AND mp.TAMNGUNG = '0'
        AND pv.TAMNGUNG = '0'
      </statement>

      <statement id="DAO00030_GetListPhamViByKhoDuoc" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
        SELECT DISTINCT PHAMVI_ID
        FROM TM_DUOC_PHAMVISD_MAPPING
        WHERE
        KHODUOC_ID IN ($KHODUOC_ID$)
        AND BENHVIEN_ID ='$BENHVIEN_ID$'
        AND TAMNGUNG = '0'
      </statement>

      <statement id="DAO00030_GetKhoDuocByPhamVi" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
        SELECT DISTINCT mp.KHODUOC_ID, lk.DICTIONARY_CODE as LOAIKHO
        FROM TM_DUOC_PHAMVISD_MAPPING mp
        INNER JOIN TM_KHODUOC kd on kd.KHODUOC_ID = mp.KHODUOC_ID
        INNER JOIN LST_DICTIONARY lk on lk.DICTIONARY_ID = kd.LOAIKHO_ID
        WHERE
        mp.PHAMVI_ID = $PHAMVI_ID$
        AND mp.BENHVIEN_ID ='$BENHVIEN_ID$'
        AND mp.TAMNGUNG = '0'
      </statement>

      <statement id="DAO00030_GetListKhoDuocMapping" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
        SELECT * FROM
        (
        select KHODICH_ID, KD.TENKHO AS TENKHODICH
        ,LK.DICTIONARY_CODE LOAIKHO, LK.DICTIONARY_NAME AS TENLOAIKHO
        ,NGUONTINHTIEN, NGUONMIENPHI,T,V,H,K,MP.TAMNGUNG
        FROM TM_KHODUOC_MAPPING MP
        INNER JOIN TM_KHODUOC KD on KD.KHODUOC_ID = MP.KHODICH_ID
        INNER JOIN LST_DICTIONARY LK on LK.DICTIONARY_ID = KD.LOAIKHO_ID
        WHERE
        MP.KHONGUON_ID = $KHODUOC_ID$        
        AND LK.DICTIONARY_CODE IN ($LOAIKHO$)
        AND MP.BENHVIEN_ID ='$BENHVIEN_ID$'
        UNION

        SELECT KHODUOC_ID AS KHODICH_ID, KD.TENKHO AS TENKHODICH
        ,LK.DICTIONARY_CODE LOAIKHO, LK.DICTIONARY_NAME AS TENLOAIKHO
        ,1,1,0,0,0,0,0
        FROM TM_KHODUOC KD
        INNER JOIN LST_DICTIONARY LK on LK.DICTIONARY_ID = KD.LOAIKHO_ID
        WHERE
        KHODUOC_ID NOT IN (SELECT KHODICH_ID FROM TM_KHODUOC_MAPPING WHERE KHONGUON_ID = $KHODUOC_ID$)
        and KHODUOC_ID != $KHODUOC_ID$
        AND LK.DICTIONARY_CODE IN ($LOAIKHO$)
        AND KD.BENHVIEN_ID ='$BENHVIEN_ID$'
        )A
        ORDER BY LOAIKHO DESC
      </statement>
      <statement id="DAO00030_KhoDuocMapping_Delete" parameterClass="System.Collections.IDictionary" resultClass="System.Int32">
        delete from TM_KHODUOC_MAPPING
        where
        KHONGUON_ID = $KHONGUON_ID$
      </statement>
      <statement id="DAO00030_KhoDuocMapping_Add" parameterClass="System.Collections.IDictionary" resultClass="System.Int64">
        insert into TM_KHODUOC_MAPPING (
          KHONGUON_ID
        , KHODICH_ID
        , NGUONTINHTIEN
        , NGUONMIENPHI
        , T
        , V
        , H
        , K
        , TAMNGUNG
        , BENHVIEN_ID
        , NGAYTAO
        , NGUOITAO_ID
        , NGAYCAPNHAT
        , NGUOICAPNHAT_ID
        ) values (
          #KHONGUON_ID#
        , #KHODICH_ID#
        , '1'
        , '1'
        , #T#
        , #V#
        , #H#
        , #K#
        , #TAMNGUNG#
        , #BENHVIEN_ID#
        , #NGAYTAO#
        , #NGUOITAO_ID#
        , #NGAYCAPNHAT#
        , #NGUOICAPNHAT_ID#
        )
      </statement>
      <statement id="DAO00030_GetListKhoDuocXuatMotBuoc" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
        SELECT * FROM
        (
        select KHODICH_ID, KD.TENKHO AS TENKHODICH
        ,LK.DICTIONARY_CODE LOAIKHO, LK.DICTIONARY_NAME AS TENLOAIKHO
        ,1 AS CHECKED
        FROM TM_KHODUOC_XUATMOTBUOC MP
        INNER JOIN TM_KHODUOC KD on KD.KHODUOC_ID = MP.KHODICH_ID
        INNER JOIN LST_DICTIONARY LK on LK.DICTIONARY_ID = KD.LOAIKHO_ID
        WHERE
        MP.KHONGUON_ID = $KHODUOC_ID$
        AND LK.DICTIONARY_CODE IN ($LOAIKHO$)
        AND MP.BENHVIEN_ID ='$BENHVIEN_ID$'
        UNION

        SELECT KHODUOC_ID AS KHODICH_ID, KD.TENKHO AS TENKHODICH
        ,LK.DICTIONARY_CODE LOAIKHO, LK.DICTIONARY_NAME AS TENLOAIKHO
        ,0 AS CHECKED
        FROM TM_KHODUOC KD
        INNER JOIN LST_DICTIONARY LK on LK.DICTIONARY_ID = KD.LOAIKHO_ID
        WHERE
        KHODUOC_ID NOT IN (SELECT KHODICH_ID FROM TM_KHODUOC_XUATMOTBUOC WHERE KHONGUON_ID = $KHODUOC_ID$)
        and KHODUOC_ID != $KHODUOC_ID$
        AND LK.DICTIONARY_CODE IN ($LOAIKHO$)
        AND KD.BENHVIEN_ID ='$BENHVIEN_ID$'
        )A
        ORDER BY LOAIKHO DESC
      </statement>
      <statement id="DAO00030_CheckKhoDuocXuatMotBuoc" parameterClass="System.Collections.IDictionary" resultClass="DataObject">       
        SELECT *
        FROM TM_KHODUOC_XUATMOTBUOC
        WHERE
        KHONGUON_ID = $KHONGUON_ID$
        AND KHODICH_ID = $KHODICH_ID$
        AND BENHVIEN_ID ='$BENHVIEN_ID$'
      </statement>
      <statement id="DAO00030_KhoDuocXuatMotBuoc_Delete" parameterClass="System.Collections.IDictionary" resultClass="System.Int32">
        delete from TM_KHODUOC_XUATMOTBUOC
        where
        KHONGUON_ID = $KHONGUON_ID$
      </statement>
      <statement id="DAO00030_KhoDuocXuatMotBuoc_Add" parameterClass="System.Collections.IDictionary" resultClass="System.Int64">
        insert into TM_KHODUOC_XUATMOTBUOC (
        KHONGUON_ID
        , KHODICH_ID       
        , TAMNGUNG
        , BENHVIEN_ID
        , NGAYTAO
        , NGUOITAO_ID
        , NGAYCAPNHAT
        , NGUOICAPNHAT_ID
        ) values (
        #KHONGUON_ID#
        , #KHODICH_ID#        
        , #TAMNGUNG#
        , #BENHVIEN_ID#
        , #NGAYTAO#
        , #NGUOITAO_ID#
        , #NGAYCAPNHAT#
        , #NGUOICAPNHAT_ID#
        )
      </statement>
      <statement id="DAO00030_GetListKhoDuoc" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
        select KHODUOC_ID,MAKHO, TENKHO, LOAIKHO_ID, LOAIDUOC, PHAMVI_ID, CHUYENKHOA_ID, PHONGBAN_ID,
        CASE WHEN KHOQUANLY_ID IS NULL THEN 0  ELSE KHOQUANLY_ID  END  AS KHOQUANLY_ID,
        lst.DICTIONARY_CODE  LOAIKHO
        from TM_KHODUOC kd
        left join LST_DICTIONARY lst on lst.DICTIONARY_ID = kd.LOAIKHO_ID
        where kd.TAMNGUNG = '0'
        and lst.DICTIONARY_TYPE_CODE = 'LoaiKhoDuoc'
        and (lst.DICTIONARY_CODE = 'KhoChan' or lst.DICTIONARY_CODE = 'KhoLe' or lst.DICTIONARY_CODE = 'QuayThuoc')
        and kd.BENHVIEN_ID = '$BENHVIEN_ID$'
        order by kd.TENKHO
      </statement>

      <statement id="DAO00030_CTSOLONHAP_DelList" parameterClass="System.Collections.IDictionary" resultClass="System.Int32">
        delete TT_DUOC_SOLONHAP_GIABAN where  SOLONHAP_ID IN ($LST_SOLONHAP_ID$)
        delete TT_DUOC_CHUNGTU_SOLONHAP where SOLONHAP_ID IN ($LST_SOLONHAP_ID$)
        delete TT_DUOC_TONKHO where SOLONHAP_ID IN ($LST_SOLONHAP_ID$)
      </statement>
      
      <update id="DAO00030_CTSOLONHAP_HuyList" parameterClass="System.Collections.IDictionary">
        UPDATE TT_DUOC_CHUNGTU_SOLONHAP set HUY ='1' where SOLONHAP_ID IN ($LST_SOLONHAP_ID$)
      </update>

      <statement id="DAO00030_GetListDuocTonKhoVaBookingCOM23" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
        select  distinct tk.DUOC_KEY, LTRIM(tk.PHAMVI_ID) as PHAMVI_ID, tk.NGUONDUOC_ID, nh.TENNGUONDUOC, nh.TINHTIEN, d.DUOC_ID, ld.MALOAIDUOC,
        d.SOVISA,d.TYLE_VAT,d.COTOA, d.MADUOC, d.TENHANG, d.TENDUOCDAYDU, d.DONVITINH, d.BHYT,
        d.TENHOATCHAT, d.HAMLUONG, d.HANGSANXUAT, d.QUOCGIA, d.LOAIDUOC_ID, d.DUONGDUNG_ID, d.TINHTIEN_PTTT,
        ten.TENDUOC, ten.TENDUOC_EN, ten.MAQUOCTE, ten.MAQUOCTEBT,
        CASE WHEN d.BHYT = '1' THEN 'BHYT' ELSE '' END as BHYT_TEXT
        , ld.LOAIVATTU_ID
        , d.BENHVIEN_ID,
        tk.SOLUONG as TONGTON, d.VTYT_PHANLOAI, d.PHAMVI, d.SUASOLUONGTONGHOP
        , TAMNGUNG = CASE WHEN d.TAMNGUNG = '1' OR nh.TAMNGUNG = '1' OR kd.TAMNGUNG = '1' THEN '1' ELSE '0' END
        from TM_DUOC d
        left join TM_TENDUOC ten on d.TENDUOC_ID = ten.TENDUOC_ID
        left join TM_LOAIDUOC ld on ld.LOAIDUOC_ID = d.LOAIDUOC_ID and ld.BENHVIEN_ID = '$BENHVIEN_ID$'
        left join TM_DUOC_HANDUNG hd on (ld.LOAIVATTU_ID = hd.LOAIDUOC  and hd.BENHVIEN_ID = '$BENHVIEN_ID$')
        inner join
        (
        select LTRIM(A.PHAMVI_ID) + '_' + LTRIM(A.DUOC_ID) + '_' + LTRIM(ISNULL(A.NGUONDUOC_ID,'')) as DUOC_KEY, A.PHAMVI_ID, A.NGUONDUOC_ID, A.DUOC_ID, SUM(isnull(A.SOLUONG,0) - isnull(E.SOLUONG,0) - isnull(F.SOLUONG,0)) as SOLUONG
        from
        (
        select SUM(SOLUONG) as SOLUONG, pvsd.PHAMVI_ID, dtk.NGUONDUOC_ID, dtk.DUOC_ID
        from TT_DUOC_TONKHO dtk
        inner join TM_DUOC_PHAMVISD_MAPPING pvsd on dtk.KHODUOC_ID = pvsd.KHODUOC_ID
        where dtk.BENHVIEN_ID = '$BENHVIEN_ID$' group by pvsd.PHAMVI_ID, dtk.NGUONDUOC_ID, dtk.DUOC_ID
        ) A
        left join
        (
        select SUM(SOLUONG) as SOLUONG, PHAMVI_ID, DUOC_ID, NGUONHANG_ID
        from TT_DUOC_TONKHO_BOOK_NGOAITRU where TRANGTHAI != 'HUY' and BENHVIEN_ID = '$BENHVIEN_ID$' group by PHAMVI_ID, DUOC_ID, NGUONHANG_ID
        ) E on A.PHAMVI_ID = E.PHAMVI_ID and A.DUOC_ID = E.DUOC_ID and E.NGUONHANG_ID = A.NGUONDUOC_ID
        left join
        (
        select SUM(SOLUONG) as SOLUONG, PHAMVI_ID, DUOC_ID, NGUONHANG_ID
        from TT_DUOC_TONKHO_BOOK_NOITRU where TRANGTHAI != 'HUY' and BENHVIEN_ID = '$BENHVIEN_ID$' group by PHAMVI_ID, DUOC_ID, NGUONHANG_ID
        ) F on A.PHAMVI_ID = F.PHAMVI_ID and A.DUOC_ID = F.DUOC_ID and F.NGUONHANG_ID = A.NGUONDUOC_ID
        group by LTRIM(A.PHAMVI_ID)  + '_' + LTRIM(A.DUOC_ID) + '_' + LTRIM(ISNULL(A.NGUONDUOC_ID,'')), A.PHAMVI_ID, A.NGUONDUOC_ID, A.DUOC_ID
        ) tk on tk.DUOC_ID = d.DUOC_ID
        left join TM_DUOC_PHAMVISUDUNG kd on kd.PHAMVI_ID = tk.PHAMVI_ID and kd.BENHVIEN_ID = '$BENHVIEN_ID$'
        left join TM_NGUONHANG nh on nh.NGUONDUOC_ID = tk.NGUONDUOC_ID and nh.BENHVIEN_ID = '$BENHVIEN_ID$'
        where tk.SOLUONG >= 0 and d.BENHVIEN_ID = '$BENHVIEN_ID$' and d.DUOC_ID in ($LIST_DUOC_ID$) and TK.PHAMVI_ID in ($PHAMVI_ID$)
        <!--and tk.NGUONDUOC_ID = '$NGUONDUOC_ID$'-->

      </statement>

      <statement id="DAO00030_Search_ChungTuHoiDong" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
        select
              CT.*
        from TT_DUOC_CHUNGTU CT        
        <dynamic prepend="where">
          <isParameterPresent>
            <isNotEmpty prepend="and" property="MACHUNGTU">
              CT.MACHUNGTU LIKE '%$MACHUNGTU$%'
            </isNotEmpty>
            <isNotEmpty prepend="and" property="KHONHAP_ID">
              CT.KHONHAP_ID = '$KHONHAP_ID$'
            </isNotEmpty>
            <isNotEmpty prepend="and" property="KHOXUAT_ID">
              CT.KHOXUAT_ID = '$KHOXUAT_ID$'
            </isNotEmpty>
            <isNotEmpty prepend="and" property="MUCDICHCHUNGTU_CODE">
              CT.MUCDICHCHUNGTU_CODE = '$MUCDICHCHUNGTU_CODE$'
            </isNotEmpty>            
            <isNotEmpty prepend="and" property="BENHVIEN_ID">
              CT.BENHVIEN_ID = '$BENHVIEN_ID$'
            </isNotEmpty>            
            <isNotEmpty prepend="and" property="TUNGAY">
              CONVERT(date, CT.NGAYCHUNGTU) BETWEEN CONVERT(date, '$TUNGAY$')  and  CONVERT(date, '$DENNGAY$')
            </isNotEmpty>
          </isParameterPresent>
        </dynamic>
        order by CT.CHUNGTU_ID DESC
      </statement>
      <statement id="DAO00030_HOIDONGKIEMNHAP_ListChiTiet" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
        select distinct hdknct.*
        , nv.TENNHANVIEN,
        cd.DICTIONARY_NAME as CHUCVU,
        vt.DICTIONARY_NAME as VITRI
        from TT_DUOC_CHUNGTU ct
        inner join TM_HOIDONG_KIEMNHAP hd on hd.HOIDONG_ID = ct.HOIDONGKIEMNHAP_ID
        inner join TM_HOIDONG_KIEMNHAP_CHITIET hdknct on hd.HOIDONG_ID = hdknct.HOIDONG_ID
        left join TM_NHANVIEN nv on nv.NHANVIEN_ID = hdknct.NHANVIEN_ID
        left join LST_DICTIONARY cd on cd.DICTIONARY_ID = nv.CHUCDANH_ID
        left join LST_DICTIONARY vt on vt.DICTIONARY_ID = hdknct.VITRI_ID
        WHERE
        hd.HOIDONG_ID = '$HOIDONG_ID$'
        and hd.BENHVIEN_ID = '$BENHVIEN_ID$'
      </statement>
       <statement id="DAO00030_HOIDONGTHANHLY_ListChiTiet" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select distinct hdct.*
        , nv.TENNHANVIEN,
        cd.DICTIONARY_NAME as CHUCVU,
        vt.DICTIONARY_NAME as VITRI
        from TT_DUOC_CHUNGTU ct
        inner join TM_HOIDONG_THANHLY hd on hd.HOIDONG_ID = ct.HOIDONGTHANHLY_ID
        inner join TM_HOIDONG_THANHLY_CHITIET hdct on hd.HOIDONG_ID = hdct.HOIDONG_ID
        left join TM_NHANVIEN nv on nv.NHANVIEN_ID = hdct.NHANVIEN_ID
        left join LST_DICTIONARY cd on cd.DICTIONARY_ID = nv.CHUCDANH_ID
        left join LST_DICTIONARY vt on vt.DICTIONARY_ID = hdct.VITRI_ID        
        WHERE
        hd.HOIDONG_ID = '$HOIDONG_ID$'
        and hd.BENHVIEN_ID = '$BENHVIEN_ID$'
      </statement>
      <statement id="DAO00030_HOIDONGKIEMKE_ListChiTiet" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
        select distinct hdct.*
        , nv.TENNHANVIEN,
        cd.DICTIONARY_NAME as CHUCVU,
        vt.DICTIONARY_NAME as VITRI
        from TT_DUOC_KIEMKE ct
        inner join TM_HOIDONG_KIEMKE hd on hd.HOIDONG_ID = ct.HOIDONGKIEMKE_ID
        inner join TM_HOIDONG_KIEMKE_CHITIET hdct on hd.HOIDONG_ID = hdct.HOIDONG_ID
        left join TM_NHANVIEN nv on nv.NHANVIEN_ID = hdct.NHANVIEN_ID
        left join LST_DICTIONARY cd on cd.DICTIONARY_ID = nv.CHUCDANH_ID
        left join LST_DICTIONARY vt on vt.DICTIONARY_ID = hdct.VITRI_ID
        WHERE
        hd.HOIDONG_ID = '$HOIDONG_ID$'
        and hd.BENHVIEN_ID = '$BENHVIEN_ID$'
      </statement>
      <statement id="DAO00030_VITRIHOIDONG_GetList" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
        select DICTIONARY_ID as VITRI_ID, DICTIONARY_NAME as VITRI from LST_DICTIONARY
        where DICTIONARY_TYPE_CODE = 'BienBanKiemKe_ViTri'
      </statement>
      <statement id="DAO00030_HoiDongKiemNhap_Add" parameterClass="System.Collections.IDictionary" resultClass="System.Int64">            
          DELETE FROM TM_HOIDONG_KIEMNHAP_CHITIET WHERE HOIDONG_ID IN (SELECT HOIDONG_ID FROM TM_HOIDONG_KIEMNHAP WHERE TENHOIDONG = '$MACHUNGTU_SELECTED$')                                    
          DELETE FROM TM_HOIDONG_KIEMNHAP WHERE TENHOIDONG =  '$MACHUNGTU_SELECTED$'
          
          insert into TM_HOIDONG_KIEMNHAP 
          (
          TENHOIDONG,
          MOTA,
          HIEULUC,
          BENHVIEN_ID,
          NGUOITAO_ID,
          NGAYTAO
          ) 
          values 
          (
          #TENHOIDONG#,
          #MOTA#,
          #HIEULUC#,
          #BENHVIEN_ID#,
          #NGUOITAO_ID#,
          #NGAYTAO#
          )
          select SCOPE_identity() as value
        </statement>
    
        <statement id="DAO00030_HoiDongKiemNhapChiTiet_Add" parameterClass="System.Collections.IDictionary" resultClass="System.Int64">
            insert into TM_HOIDONG_KIEMNHAP_CHITIET
            (
            HOIDONG_ID,
            NHANVIEN_ID,
            CHUCVU_ID,
            VITRI_ID,
            BENHVIEN_ID
            ) 
            values 
            (
            #HOIDONG_ID#,
            #NHANVIEN_ID#,
            #CHUCVU_ID#,
            #VITRI_ID#,
            #BENHVIEN_ID#
            )
            select SCOPE_identity() as value
        </statement>
        <update id="DAO00030_Update_HoiDongKiemNhap_ChungTu" parameterClass="System.Collections.IDictionary">
            update
            TT_DUOC_CHUNGTU
            set
            HOIDONGKIEMNHAP_ID = #HOIDONGKIEMNHAP_ID#
            where
            MACHUNGTU = '$MACHUNGTU_SELECTED$'
        </update>
        
          <statement id="DAO00030_HoiDongThanhLy_Add" parameterClass="System.Collections.IDictionary" resultClass="System.Int64">            
          DELETE FROM TM_HOIDONG_THANHLY_CHITIET WHERE HOIDONG_ID IN (SELECT HOIDONG_ID FROM TM_HOIDONG_THANHLY WHERE TENHOIDONG = '$MACHUNGTU_SELECTED$')                                    
          DELETE FROM TM_HOIDONG_THANHLY WHERE TENHOIDONG =  '$MACHUNGTU_SELECTED$'
          
          insert into TM_HOIDONG_THANHLY 
          (
          TENHOIDONG,
          MOTA,
          HIEULUC,
          BENHVIEN_ID,
          NGUOITAO_ID,
          NGAYTAO
          ) 
          values 
          (
          #TENHOIDONG#,
          #MOTA#,
          #HIEULUC#,
          #BENHVIEN_ID#,
          #NGUOITAO_ID#,
          #NGAYTAO#
          )
          select SCOPE_identity() as value
        </statement>
    
        <statement id="DAO00030_HoiDongThanhLyChiTiet_Add" parameterClass="System.Collections.IDictionary" resultClass="System.Int64">
            insert into TM_HOIDONG_THANHLY_CHITIET
            (
            HOIDONG_ID,
            NHANVIEN_ID,
            CHUCVU_ID,
            VITRI_ID,
            BENHVIEN_ID
            ) 
            values 
            (
            #HOIDONG_ID#,
            #NHANVIEN_ID#,
            #CHUCVU_ID#,
            #VITRI_ID#,
            #BENHVIEN_ID#
            )
            select SCOPE_identity() as value
        </statement>
        <update id="DAO00030_Update_HoiDongThanhLy_ChungTu" parameterClass="System.Collections.IDictionary">
            update
            TT_DUOC_CHUNGTU
            set
            HOIDONGTHANHLY_ID = #HOIDONGTHANHLY_ID#
            where
            MACHUNGTU = '$MACHUNGTU_SELECTED$'
        </update>

      <statement id="DAO00030_HoiDongKiemKe_Add" parameterClass="System.Collections.IDictionary" resultClass="System.Int64">
        DELETE FROM TM_HOIDONG_KIEMKE_CHITIET WHERE HOIDONG_ID IN (SELECT HOIDONG_ID FROM TM_HOIDONG_KIEMKE WHERE TENHOIDONG = '$TENHOIDONG$')
        DELETE FROM TM_HOIDONG_KIEMKE WHERE TENHOIDONG =  '$TENHOIDONG$'

        insert into TM_HOIDONG_KIEMKE
        (
        TENHOIDONG,
        MOTA,
        HIEULUC,
        BENHVIEN_ID,
        NGUOITAO_ID,
        NGAYTAO
        )
        values
        (
        #TENHOIDONG#,
        #MOTA#,
        #HIEULUC#,
        #BENHVIEN_ID#,
        #NGUOITAO_ID#,
        #NGAYTAO#
        )
        select SCOPE_identity() as value
      </statement>

      <statement id="DAO00030_HoiDongKiemKeChiTiet_Add" parameterClass="System.Collections.IDictionary" resultClass="System.Int64">
        insert into TM_HOIDONG_KIEMKE_CHITIET
        (
        HOIDONG_ID,
        NHANVIEN_ID,
        CHUCVU_ID,
        VITRI_ID,
        BENHVIEN_ID
        )
        values
        (
        #HOIDONG_ID#,
        #NHANVIEN_ID#,
        #CHUCVU_ID#,
        #VITRI_ID#,
        #BENHVIEN_ID#
        )
        select SCOPE_identity() as value
      </statement>
      <update id="DAO00030_Update_HoiDongKiemKe_ChungTu" parameterClass="System.Collections.IDictionary">
        update
        TT_DUOC_KIEMKE
        set
        HOIDONGKIEMKE_ID = #HOIDONGKIEMKE_ID#
        where
        DUOCKYKIEMKE_ID = '$DUOCKYKIEMKE_ID_SELECTED$'
        and KHODUOC_ID =  '$KHODUOC_ID$'
      </update>
      <statement id="DAO00030_TT_DUOC_TONKHO_LOG_Add" parameterClass="HashTable" resultClass="System.Int64">
        
             DECLARE @KHODUOC_ID int
             DECLARE @TONTRUOC numeric(18, 4)
             DECLARE @TONSAU numeric(18, 4)
             DECLARE @SOLUONGNHAP numeric(18, 4)
             DECLARE @SOLUONGXUAT numeric(18, 4)
             
             IF(#LOAICHUNGTU# = 'N')
             BEGIN
              SET @KHODUOC_ID = #KHONHAP_ID#
             END
             ELSE
             BEGIN
               SET @KHODUOC_ID = #KHOXUAT_ID#
             END
             
             SELECT @TONTRUOC = SOLUONG FROM TT_DUOC_TONKHO WHERE KHODUOC_ID = @KHODUOC_ID  AND DUOC_ID = #DUOC_ID# AND SOLONHAP_ID = #SOLONHAP_ID# AND NGUONDUOC_ID = #NGUONDUOC_ID#
             
             IF(#LOAICHUNGTU# = 'N' AND #ACTION# = 'ADD')
             BEGIN
              SET @TONSAU = ISNULL(@TONTRUOC,0) + #SOLUONGNHAP#
              SET @SOLUONGNHAP = #SOLUONGNHAP#
              SET @SOLUONGXUAT = 0
             END
             IF(#LOAICHUNGTU# = 'N' AND #ACTION# = 'DEL')
             BEGIN
              SET @TONSAU = ISNULL(@TONTRUOC,0) - #SOLUONGNHAP#
              SET @SOLUONGXUAT = #SOLUONGNHAP#
              SET @SOLUONGNHAP = 0
             END
           
           
             IF(#LOAICHUNGTU# = 'X' AND #ACTION# = 'ADD')
             BEGIN
              SET @TONSAU = ISNULL(@TONTRUOC,0) - #SOLUONGXUAT#
              SET @SOLUONGXUAT = #SOLUONGXUAT#
              SET @SOLUONGNHAP = 0
             END
             IF(#LOAICHUNGTU# = 'X' AND #ACTION# = 'DEL')
             BEGIN
              SET @TONSAU = ISNULL(@TONTRUOC,0) + #SOLUONGXUAT#
              SET @SOLUONGNHAP = #SOLUONGXUAT#
              SET @SOLUONGXUAT = 0              
             END
        
            insert into TT_DUOC_TONKHO_LOG (            
             CHUNGTUCHITIET_ID
            ,CHUNGTU_ID
            ,MACHUNGTU
            ,LOAICHUNGTU
            ,MUCDICHCHUNGTU_CODE
            ,KHONHAP_ID
            ,KHOXUAT_ID
            ,DUOC_ID
            ,SOLONHAP_ID
            ,NGUONDUOC_ID
            ,SOLUONGNHAP
            ,SOLUONGXUAT
            ,DONGIAMUA
            ,DONGIAVON
            ,TYLE_VAT
            ,DONGIAVONVAT
            ,TONTRUOC
            ,TONSAU
            ,ACTION
            ,BENHVIEN_ID
            ,NGAYTAO
            ,NGUOITAO_ID            
            ) values (
           #CHUNGTUCHITIET_ID#
            ,#CHUNGTU_ID#
            ,#MACHUNGTU#
            ,#LOAICHUNGTU#
            ,#MUCDICHCHUNGTU_CODE#
            ,#KHONHAP_ID#
            ,#KHOXUAT_ID#
            ,#DUOC_ID#
            ,#SOLONHAP_ID#
            ,#NGUONDUOC_ID#
            ,@SOLUONGNHAP
            ,@SOLUONGXUAT
            ,#DONGIAMUA#
            ,#DONGIAVON#
            ,#TYLE_VAT#
            ,#DONGIAVONVAT#
            ,@TONTRUOC
            ,@TONSAU
            ,#ACTION#
            ,#BENHVIEN_ID#
            ,#NGAYTAO#
            ,#NGUOITAO_ID#
            )
        </statement>

        <statement id="DAO00030_GetDonGiaBHYT" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
          SELECT TOP 1 NGAYNHAP, HANDUNG, SLN.DUOC_ID,
          SLNGB.DONGIAMUA, SLNGB.DONGIAVON, SLNGB.TYLEVAT_DAUVAO as TYLEVAT, d.TYLE_VAT,
          SLNGB.DONGIAVONVAT, SLNGB.DONGIABANVAT_DAUVAO,
          dg.DONGIA AS DONGIATHAU, dg.DONGIA AS DONGIABAN, dg.DONGIA AS DONGIABAN_VAT
          FROM
          TM_DUOC_DONGIA dg
          LEFT JOIN TM_LOAIGIA lg on (lg.LOAIGIA_ID = dg.LOAIGIA_ID AND lg.MALOAIGIA = 'GiaduocBHYT')
          LEFT JOIN TM_DUOC D on dg.DUOC_ID = D.DUOC_ID
          LEFT JOIN TT_DUOC_CHUNGTU_SOLONHAP SLN on dg.DUOC_ID = SLN.DUOC_ID
          LEFT JOIN TT_DUOC_SOLONHAP_GIABAN SLNGB on SLN.SOLONHAP_ID = SLNGB.SOLONHAP_ID
          WHERE
          dg.DUOC_ID = #DUOC_ID#
          and dg.DONGIA IS NOT NULL          
          <isEqual prepend="" property="PHUONGPHAPXUAT" compareValue="0">
            ORDER BY NGAYNHAP
          </isEqual>
          <isEqual prepend="" property="PHUONGPHAPXUAT" compareValue="1">
            ORDER BY HANDUNG
          </isEqual>
        </statement>

        <statement id="DAO00030_GetDonGiaTheoLo" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
          SELECT DISTINCT
          SLNGB.DUOC_ID,SLNGB.SOLONHAP_ID,SLNGB.DONGIAMUA, SLNGB.DONGIAVON, SLNGB.TYLEVAT_DAUVAO as TYLEVAT,
          SLNGB.DONGIAVONVAT, SLNGB.DONGIABANVAT_DAUVAO,
          dg.DONGIA AS DONGIATHAU, SLNGB.DONGIABAN AS DONGIABAN, SLNGB.DONGIABANVAT_DAUVAO AS DONGIABAN_VAT
          FROM
          TT_DUOC_SOLONHAP_GIABAN SLNGB
          left join TM_DUOC_DONGIA dg on dg.DUOC_ID = SLNGB.DUOC_ID
          LEFT JOIN TM_LOAIGIA lg on (lg.LOAIGIA_ID = dg.LOAIGIA_ID AND lg.MALOAIGIA = 'GiaduocBHYT')
          WHERE
          SLNGB.DUOC_ID = '$DUOC_ID$'
          AND SLNGB.SOLONHAP_ID ='$SOLONHAP_ID$'
        </statement>
        <statement id="DAO00030_GetSoLuongTamNgung" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
          SELECT TOATHUOC_ID, SUM(SOLUONG) AS SOLUONGNGUNG
          FROM
          TT_NOITRU_TRATHUOC_CHITIET
          WHERE TOATHUOC_ID = '$TOATHUOC_ID$'
          GROUP BY TOATHUOC_ID
        </statement>
        <statement id="DAO00030_GetKhoDuoc" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
          SELECT *
          FROM
          TM_KHODUOC
          WHERE
          KHODUOC_ID= '$KHODUOC_ID$'
          and BENHVIEN_ID= '$BENHVIEN_ID$'
        </statement>
        <statement id="DAO00030_GetYLenhByKhamBenhID" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
          SELECT
          N'Người bệnh: ' + bn.MAYTE + ' - ' + bn.TENBENHNHAN + ' - ' +  CONVERT(VARCHAR(10), KB.THOIGIANKHAM, 103) + ' - ' + CONVERT(VARCHAR(5), KB.THOIGIANKHAM, 108) as BENHNHAN
          ,tt.* 
          FROM TT_NOITRU_TOATHUOC tt
          INNER JOIN TT_BENHNHAN bn on bn.BENHNHAN_ID = tt.BENHNHAN_ID
          INNER JOIN TT_NOITRU_KHAMBENH kb on kb.KHAMBENH_ID = tt.KHAMBENH_ID
          WHERE
          tt.KHAMBENH_ID= '$KHAMBENH_ID$'
          and tt.COSO = '1'
        </statement>
       <statement id="DAO00030_GetGhiNhanPhauThuatVTYT" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
          SELECT
          N'Người bệnh: ' + bn.MAYTE + ' - ' + bn.TENBENHNHAN + ' - ' +  CONVERT(VARCHAR(10), pt.NGAYTHUCHIEN, 103) + ' - ' + CONVERT(VARCHAR(5), pt.NGAYTHUCHIEN, 108) as BENHNHAN
          ,vtyt.* 
          FROM TT_PHAUTHUAT_VTYT vtyt
          INNER JOIN TT_PHAUTHUAT pt on pt.PHAUTHUAT_ID = vtyt.PHAUTHUAT_ID
          INNER JOIN dbo.TT_TIEPNHAN tn on tn.TIEPNHAN_ID = pt.TIEPNHAN_ID
          INNER JOIN TT_BENHNHAN bn on bn.BENHNHAN_ID = tn.BENHNHAN_ID          
          WHERE
          pt.PHAUTHUAT_ID= '$PHAUTHUAT_ID$'
          and vtyt.COSO = '1'
		  and vtyt.CHUNGTU_ID is null
        </statement>
      <statement id="DAO00030_GetGhiNhanCanLamSangVTYT" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
        SELECT
        N'Người bệnh: ' + bn.MAYTE + ' - ' + bn.TENBENHNHAN + ' - ' +  CONVERT(VARCHAR(10), vtyt.NGAYSUDUNG, 103) + ' - ' + CONVERT(VARCHAR(5), vtyt.NGAYSUDUNG, 108) as BENHNHAN
        ,vtyt.*
        FROM TT_CLSKETQUA_VTYT vtyt
        INNER JOIN dbo.TT_DVYEUCAU dv on dv.DVYEUCAU_ID = vtyt.DVYEUCAU_ID
        INNER JOIN dbo.TT_TIEPNHAN tn on tn.TIEPNHAN_ID = dv.TIEPNHAN_ID
        INNER JOIN TT_BENHNHAN bn on bn.BENHNHAN_ID = tn.BENHNHAN_ID
        WHERE
        dv.DVYEUCAU_ID = '$DVYEUCAU_ID$'
        and vtyt.COSO = '1'
        AND vtyt.BENHVIEN_ID = '$BENHVIEN_ID$'
        and vtyt.CHUNGTU_ID is null
        <isNotEmpty prepend="and" property="DICHVU_GHINHANVTYT_ID">
          vtyt.DICHVU_GHINHANVTYT_ID = $DICHVU_GHINHANVTYT_ID$
        </isNotEmpty>
      </statement>
        <statement id="DAO00030_GetGhiNhanVTYTKhamBenhByKhamBenhID" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
          SELECT
          N'Người bệnh: ' + bn.MAYTE + ' - ' + bn.TENBENHNHAN + ' - ' +  CONVERT(VARCHAR(10), KB.THOIGIANKHAM, 103) + ' - ' + CONVERT(VARCHAR(5), KB.THOIGIANKHAM, 108) as BENHNHAN
          ,tt.*	, tt.NGUONHANG_ID AS NGUONDUOC_ID
          FROM TT_NGOAITRU_KHAMBENH_VTYT tt
          INNER JOIN TT_NGOAITRU_KHAMBENH KB on KB.KHAMBENH_ID = TT.KHAMBENH_ID AND KB.BENHVIEN_ID = TT.BENHVIEN_ID
          INNER JOIN TT_BENHNHAN bn on bn.BENHNHAN_ID = KB.BENHNHAN_ID AND BN.BENHVIEN_ID = KB.BENHVIEN_ID
          WHERE
          tt.KHAMBENH_ID= $KHAMBENH_ID$ and tt.COSO = '1' and tt.CHUNGTU_ID is null
          AND TT.BENHVIEN_ID = '$BENHVIEN_ID$'
          <isNotEmpty prepend="and" property="DICHVU_GHINHANVTYT_ID">
            tt.DICHVU_GHINHANVTYT_ID = $DICHVU_GHINHANVTYT_ID$
          </isNotEmpty>
        </statement>
        <update id="DAO00030_Update_GiaBanDuoc" parameterClass="System.Collections.IDictionary">
          update
          TT_DUOC_SOLONHAP_GIABAN
          set
          DONGIABAN = #DONGIABAN#,
          DONGIABANVAT_DAUVAO = #DONGIABAN#,
          NGUOICAPNHAT_ID = #NGUOICAPNHAT_ID#,
          NGAYCAPNHAT = #NGAYCAPNHAT#
          where
          BENHVIEN_ID = '$BENHVIEN_ID$'
          AND SOLONHAP_ID = '$SOLONHAP_ID$'
          AND DUOC_ID = '$DUOC_ID$'
        </update>         

       <statement id="DAO00030_DUOCTONKHO_Giam_All" parameterClass="System.String" resultClass="System.Int32">
        declare @json nvarchar(max) = N'$JSON_DATA$';     

        UPDATE TT_DUOC_TONKHO
        SET
        SOLUONG = SOLUONG - json.SOLUONGTHAYDOI,          
        NGAYCAPNHAT = GETDATE(),
        NGUOICAPNHAT_ID = json.NGUOICAPNHAT_ID
        FROM OPENJSON(@json)
        WITH (
        KHODUOC_ID int,
        DUOC_ID int,
        SOLONHAP_ID int,
        SOLUONGTHAYDOI numeric(25, 4),
        NGUOICAPNHAT_ID int
        )json
        WHERE TT_DUOC_TONKHO.KHODUOC_ID = json.KHODUOC_ID AND TT_DUOC_TONKHO.DUOC_ID = json.DUOC_ID and TT_DUOC_TONKHO.SOLONHAP_ID = json.SOLONHAP_ID        
      </statement>
      
      <statement id="DAO00030_DUOCTONKHO_Tang_All" parameterClass="System.String" resultClass="System.Int32">
        declare @json nvarchar(max) = N'$JSON_DATA$';

        UPDATE TT_DUOC_TONKHO
        SET
        SOLUONG = SOLUONG + json.SOLUONGTHAYDOI,
        NGAYCAPNHAT = GETDATE(),
        NGUOICAPNHAT_ID = json.NGUOICAPNHAT_ID
        FROM OPENJSON(@json)
        WITH (
        KHODUOC_ID int,
        DUOC_ID int,
        SOLONHAP_ID int,
        SOLUONGTHAYDOI numeric(25, 4),
        NGUOICAPNHAT_ID int
        )json
        WHERE TT_DUOC_TONKHO.KHODUOC_ID = json.KHODUOC_ID AND TT_DUOC_TONKHO.DUOC_ID = json.DUOC_ID and TT_DUOC_TONKHO.SOLONHAP_ID = json.SOLONHAP_ID
      </statement>

      <update id="DAO00030_DUOCPHIEULINHCT_Update_NGOAITRU_KB_VTYT" parameterClass="System.Collections.IDictionary">
        update
        TT_NGOAITRU_KHAMBENH_VTYT
        set
        PHIEULINH_ID = #CHUNGTU_ID#
        where
        KHAMBENH_VTYT_ID = '$TOATHUOC_ID$'
      </update>
      <update id="DAO00030_DUOCPHIEULINHCT_Delete_NGOAITRU_KB_VTYT" parameterClass="System.Collections.IDictionary">
        update
        TT_NGOAITRU_KHAMBENH_VTYT
        set
        PHIEULINH_ID = NULL
        where
        KHAMBENH_VTYT_ID = '$TOATHUOC_ID$'
      </update>
      <statement id="DAO00030_KiemTraConTonTaiChungTuXuatSuDung" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
        SELECT CHUNGTU_ID FROM TT_DUOC_CHUNGTU
        WHERE CHUNGTU_ID = #CHUNGTU_ID#
        AND PHIEULINH_ID
        IN
        (
        SELECT PHIEULINH_ID FROM TT_DUOC_CHUNGTU WHERE MUCDICHCHUNGTU_CODE = 'X13'
        AND KHOXUAT_ID = #KHOXUAT_ID#
        )
      </statement>
      <statement id="DAO00030_KiemTraToaThuocDaXuat" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
        SELECT * FROM
        TT_NGOAITRU_KHAMBENH_TOATHUOC
        where
        KHAMBENH_TOATHUOC_ID = '$KHAMBENH_TOATHUOC_ID$'
        AND CHUNGTUPHATTHUOC_ID IS NOT NULL
      </statement>
      <statement id="DAO00030_VienPhi_DaThucHien" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
        update TT_VIENPHI set DATHUCHIEN = '1'
        where KHAMBENH_ID = '$KHAMBENH_ID$' AND REF_TABLE='$REF_TABLE$'
      </statement>
    <statement id="DAO00030_CheckTonKhoTheoTheKho" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select thekho.SoLuong from (
      Select sum(case when CTU.LoaiChungTu = 'N' then SoLuongThucTe*ISNULL(QD.GiaTriQuiDoi,1) else - SOLUONGDAXUAT end) as SoLuong
      from TT_DUOC_CHUNGTU_CHITIET CT
      join TT_DUOC_CHUNGTU CTU on CT.ChungTu_ID = CTU.ChungTu_ID
      join TT_DUOC_CHUNGTU_SOLONHAP Lo on Lo.SoLoNhap_ID = CT.SoLoNhap_ID
      join TM_DONVITINH QD on QD.DonViTinh_ID = CT.DonViTinh_ID
      where (
      (LoaiChungTu = 'N' And KhoNhap_ID IN ($LIST_KHODUOC_ID$)) Or (LoaiChungTu = 'X' And KhoXuat_ID IN ($LIST_KHODUOC_ID$)))
      And CTU.TrangThai not in ('PNCXN','CXN','HUY','PNCNK') And CT.SOLONHAP_ID IN ($LIST_SOLONHAP_ID$)
      Group by CT.Duoc_ID, CT.SoLoNhap_ID,lo.NGUONDUOC_ID
      ) thekho where thekho.soluong &lt; 0
      </statement>
      <update id="DAO00030_PHIEULINH_Upd_TrangThai_KhiXoaXuat" parameterClass="System.Collections.IDictionary">
        update TT_DUOC_PHIEULINH set DANHANTHUOC = 0 ,TRANGTHAI = 'DADUYET' ,CHUNGTULIENQUAN_ID = null ,NGAYCAPNHAT = getdate()
        where CHUNGTULIENQUAN_ID='$CHUNGTULIENQUAN_ID$'
      </update>
      <statement id="DAO00030_MergSoLuongTonKho_All_Kho" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
        SET XACT_ABORT ON
        BEGIN TRANSACTION
        BEGIN TRY
        
        DELETE TT_DUOC_TONKHO
        
        MERGE TT_DUOC_TONKHO AS X USING
        (
        select aa.SoLoNhap_ID,aa.KHODUOC_ID,aa.DUOC_ID,  aa.NGUONDUOC_ID,aa.BENHVIEN_ID, aa.NGAYNHAP, sum(aa.soluong) as SOLUONG from (
        Select (case when CTU.LoaiChungTu = 'N' then CTU.KhoNhap_ID else ctu.KhoXuat_ID end) as KHODUOC_ID, CT.SOLONHAP_ID,
        (case when CTU.LoaiChungTu = 'N' then SoLuongThucTe*ISNULL(CT.TYLEQUIDOI,1) else - SOLUONGDAXUAT end) as SOLUONG,CT.DUOC_ID,
        Lo.NGUONDUOC_ID,CTU.BENHVIEN_ID, Lo.NGAYNHAP
        from TT_DUOC_CHUNGTU_CHITIET CT WITH (NOLOCK)
        join TT_DUOC_CHUNGTU CTU WITH (NOLOCK) on CT.ChungTu_ID = CTU.ChungTu_ID
        join TT_DUOC_CHUNGTU_SOLONHAP Lo WITH (NOLOCK) on Lo.SoLoNhap_ID = CT.SoLoNhap_ID
        join TM_DUOC duoc WITH (NOLOCK) on CT.DUOC_ID = duoc.DUOC_ID
        where ((CTU.TRANGTHAI not in ('PNCXN','CXN','HUY','PNCNK')) or CTU.TRANGTHAI is null)
        ) aa
        Group by AA.SoLoNhap_ID,AA.KHODUOC_ID,AA.DUOC_ID,  AA.NGUONDUOC_ID,AA.BENHVIEN_ID,aa.NGAYNHAP
        ) AS Y
        ON (X.KHODUOC_ID =Y.KHODUOC_ID AND X.SOLONHAP_ID=Y.SOLONHAP_ID AND X.DUOC_ID=Y.DUOC_ID AND X.NGUONDUOC_ID=Y.NGUONDUOC_ID AND X.BENHVIEN_ID=Y.BENHVIEN_ID)
        WHEN MATCHED THEN UPDATE SET X.SOLUONG=Y.SOLUONG
        WHEN NOT MATCHED THEN
        INSERT (KHODUOC_ID,DUOC_ID,SOLONHAP_ID,SOLUONG,NGUONDUOC_ID,BENHVIEN_ID,NGAYTAO,NGUOITAO_ID,NGAYCAPNHAT,NGUOICAPNHAT_ID) VALUES
        (Y.KHODUOC_ID,Y.DUOC_ID,Y.SOLONHAP_ID,Y.SOLUONG,Y.NGUONDUOC_ID,Y.BENHVIEN_ID, Y.NGAYNHAP, NULL, GETDATE(), NULL);

        DELETE TT_DUOC_TONKHO WHERE SOLUONG = 0 AND NGAYTAO  &lt; DATEADD(MONTH, -3, getdate()) ;        

        COMMIT TRANSACTION
        END TRY
        BEGIN CATCH
        IF @@TRANCOUNT &gt; 0
        ROLLBACK TRANSACTION
        END CATCH
      </statement>
      <statement id="DAO00030_MergSoLuongTonKho_TheoKho" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
        SET XACT_ABORT ON
        BEGIN TRANSACTION
        BEGIN TRY
        
        DELETE TT_DUOC_TONKHO WHERE KHODUOC_ID IN($LST_KHODUOC_ID$);
        
        MERGE TT_DUOC_TONKHO AS X USING
        (
        select aa.SoLoNhap_ID,aa.KHODUOC_ID,aa.DUOC_ID,  aa.NGUONDUOC_ID,aa.BENHVIEN_ID, aa.NGAYNHAP, sum(aa.soluong) as SOLUONG from (
        Select (case when CTU.LoaiChungTu = 'N' then CTU.KhoNhap_ID else ctu.KhoXuat_ID end) as KHODUOC_ID, CT.SOLONHAP_ID,
        (case when CTU.LoaiChungTu = 'N' then SoLuongThucTe*ISNULL(CT.TYLEQUIDOI,1) else - SOLUONGDAXUAT end) as SOLUONG,CT.DUOC_ID,
        Lo.NGUONDUOC_ID,CTU.BENHVIEN_ID, Lo.NGAYNHAP
        from TT_DUOC_CHUNGTU_CHITIET CT WITH (NOLOCK)
        join TT_DUOC_CHUNGTU CTU WITH (NOLOCK) on CT.ChungTu_ID = CTU.ChungTu_ID
        join TT_DUOC_CHUNGTU_SOLONHAP Lo WITH (NOLOCK) on Lo.SoLoNhap_ID = CT.SoLoNhap_ID
        join TM_DUOC duoc WITH (NOLOCK) on CT.DUOC_ID = duoc.DUOC_ID
        where ((CTU.TRANGTHAI not in ('PNCXN','CXN','HUY','PNCNK')) or CTU.TRANGTHAI is null)
        ) aa where aa.KHODUOC_ID IN($LST_KHODUOC_ID$)
        Group by AA.SoLoNhap_ID,AA.KHODUOC_ID,AA.DUOC_ID,  AA.NGUONDUOC_ID,AA.BENHVIEN_ID,aa.NGAYNHAP
        ) AS Y
        ON (X.KHODUOC_ID =Y.KHODUOC_ID AND X.SOLONHAP_ID=Y.SOLONHAP_ID AND X.DUOC_ID=Y.DUOC_ID AND X.NGUONDUOC_ID=Y.NGUONDUOC_ID AND X.BENHVIEN_ID=Y.BENHVIEN_ID)
        WHEN MATCHED THEN UPDATE SET X.SOLUONG=Y.SOLUONG
        WHEN NOT MATCHED THEN
        INSERT (KHODUOC_ID,DUOC_ID,SOLONHAP_ID,SOLUONG,NGUONDUOC_ID,BENHVIEN_ID,NGAYTAO,NGUOITAO_ID,NGAYCAPNHAT,NGUOICAPNHAT_ID) VALUES
        (Y.KHODUOC_ID,Y.DUOC_ID,Y.SOLONHAP_ID,Y.SOLUONG,Y.NGUONDUOC_ID,Y.BENHVIEN_ID,Y.NGAYNHAP,NULL,GETDATE(),NULL);

        DELETE TT_DUOC_TONKHO WHERE SOLUONG = 0 AND KHODUOC_ID IN($LST_KHODUOC_ID$) AND NGAYTAO  &lt; DATEADD(MONTH, -3, getdate()) ;

        COMMIT TRANSACTION
        END TRY
        BEGIN CATCH
        IF @@TRANCOUNT &gt; 0
        ROLLBACK TRANSACTION
        END CATCH        
      </statement>
      <statement id="DAO00030_MergSoLuongTonKho" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
        SET XACT_ABORT ON
        BEGIN TRANSACTION
        BEGIN TRY

        DELETE TT_DUOC_TONKHO WHERE KHODUOC_ID IN($LST_KHODUOC_ID$) AND DUOC_ID IN ($LST_DUOC_ID$);

        MERGE TT_DUOC_TONKHO AS X USING
        (
        select aa.SoLoNhap_ID,aa.KHODUOC_ID,aa.DUOC_ID,  aa.NGUONDUOC_ID,aa.BENHVIEN_ID, aa.NGAYNHAP, sum(aa.soluong) as SOLUONG from (
        Select (case when CTU.LoaiChungTu = 'N' then CTU.KhoNhap_ID else ctu.KhoXuat_ID end) as KHODUOC_ID, CT.SOLONHAP_ID,
        (case when CTU.LoaiChungTu = 'N' then SoLuongThucTe*ISNULL(CT.TYLEQUIDOI,1) else - SOLUONGDAXUAT end) as SOLUONG,CT.DUOC_ID,
        Lo.NGUONDUOC_ID,CTU.BENHVIEN_ID, Lo.NGAYNHAP
        from TT_DUOC_CHUNGTU_CHITIET CT WITH (NOLOCK)
        join TT_DUOC_CHUNGTU CTU WITH (NOLOCK) on CT.ChungTu_ID = CTU.ChungTu_ID
        join TT_DUOC_CHUNGTU_SOLONHAP Lo WITH (NOLOCK) on Lo.SoLoNhap_ID = CT.SoLoNhap_ID
        join TM_DUOC duoc WITH (NOLOCK) on CT.DUOC_ID = duoc.DUOC_ID
        where ((CTU.TRANGTHAI not in ('PNCXN','CXN','HUY','PNCNK')) or CTU.TRANGTHAI is null) AND CTU.BENHVIEN_ID='$BENHVIEN_ID$'
        AND CT.DUOC_ID IN ($LST_DUOC_ID$)
        ) aa where aa.KHODUOC_ID IN($LST_KHODUOC_ID$)
        Group by AA.SoLoNhap_ID,AA.KHODUOC_ID,AA.DUOC_ID,  AA.NGUONDUOC_ID,AA.BENHVIEN_ID,aa.NGAYNHAP
        ) AS Y
        ON (X.KHODUOC_ID =Y.KHODUOC_ID AND X.SOLONHAP_ID=Y.SOLONHAP_ID AND X.DUOC_ID=Y.DUOC_ID AND X.NGUONDUOC_ID=Y.NGUONDUOC_ID AND X.BENHVIEN_ID=Y.BENHVIEN_ID)
        WHEN MATCHED THEN UPDATE SET X.SOLUONG=Y.SOLUONG
        WHEN NOT MATCHED THEN
        INSERT (KHODUOC_ID,DUOC_ID,SOLONHAP_ID,SOLUONG,NGUONDUOC_ID,BENHVIEN_ID,NGAYTAO,NGUOITAO_ID,NGAYCAPNHAT,NGUOICAPNHAT_ID) VALUES
        (Y.KHODUOC_ID,Y.DUOC_ID,Y.SOLONHAP_ID,Y.SOLUONG,Y.NGUONDUOC_ID,Y.BENHVIEN_ID,Y.NGAYNHAP, NULL,GETDATE(),NULL);

        DELETE TT_DUOC_TONKHO WHERE SOLUONG = 0 AND KHODUOC_ID IN($LST_KHODUOC_ID$) AND NGAYTAO  &lt; DATEADD(MONTH, -3, getdate()) ;

        COMMIT TRANSACTION
        END TRY
        BEGIN CATCH
        IF @@TRANCOUNT &gt; 0
        ROLLBACK TRANSACTION
        END CATCH        
      </statement>
      <statement id="DAO00030_MergSoLuongTonKhoTheoKy" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
        SET XACT_ABORT ON
        BEGIN TRANSACTION
        BEGIN TRY

        declare @DUOCKYTONKHO_ID INT
        declare @TUNGAY DATETIME

        SELECT @DUOCKYTONKHO_ID = MAX(ISNULL(DUOCKYTONKHO_ID,0)) FROM TT_DUOC_TONDAUKY WITH (NOLOCK) WHERE KHODUOC_ID = #KHODUOC_ID#
        IF @DUOCKYTONKHO_ID is null
        BEGIN
        set @DUOCKYTONKHO_ID = 0;
        END

        SELECT @TUNGAY = CONVERT(DATE,ISNULL(TUNGAY, '01-01-2015')) FROM TT_DUOC_KYTONKHO WITH (NOLOCK) WHERE DUOCKYTONKHO_ID = @DUOCKYTONKHO_ID

        IF @DUOCKYTONKHO_ID &lt; 1
        BEGIN
        set @TUNGAY = CONVERT(DATE,'01-01-2015');
        END

        UPDATE TT_DUOC_TONKHO SET SOLUONG=0,DONGIAMUA=null WHERE KHODUOC_ID = #KHODUOC_ID#;

        MERGE TT_DUOC_TONKHO AS X USING
        (
        select
        tk.SOLONHAP_ID,tk.KHODUOC_ID,tk.DUOC_ID,  tk.NGUONDUOC_ID,tk.BENHVIEN_ID,  sum(tk.soluong) as SOLUONG
        from (
        select TDK.KHODUOC_ID, TDK.SOLONHAP_ID, SOLUONG, TDK.DUOC_ID, NGUONDUOC_ID, TDK.BENHVIEN_ID
        from
        TT_DUOC_TONDAUKY TDK WITH (NOLOCK)
        join TT_DUOC_CHUNGTU_SOLONHAP sln WITH (NOLOCK) on sln.SOLONHAP_ID = tdk.SOLONHAP_ID
        where
        TDK.DUOCKYTONKHO_ID = @DUOCKYTONKHO_ID
        and TDK.KHODUOC_ID = #KHODUOC_ID#
        and TDK.BENHVIEN_ID = '$BENHVIEN_ID$'

        UNION ALL

        Select (case when CTU.LoaiChungTu = 'N' then CTU.KhoNhap_ID else ctu.KhoXuat_ID end) as KHODUOC_ID, CT.SOLONHAP_ID,
        (case when CTU.LoaiChungTu = 'N' then SoLuongThucTe*ISNULL(CT.TYLEQUIDOI,1) else - SOLUONGDAXUAT end) as SOLUONG,
        CT.DUOC_ID, Lo.NGUONDUOC_ID,CTU.BENHVIEN_ID
        from TT_DUOC_CHUNGTU_CHITIET CT WITH (NOLOCK)
        join TT_DUOC_CHUNGTU CTU WITH (NOLOCK) on CT.ChungTu_ID = CTU.ChungTu_ID 
        join TT_DUOC_CHUNGTU_SOLONHAP Lo WITH (NOLOCK) on Lo.SoLoNhap_ID = CT.SoLoNhap_ID
        join TM_DUOC duoc WITH (NOLOCK) on CT.DUOC_ID = duoc.DUOC_ID
        where ((CTU.TRANGTHAI not in ('PNCXN','CXN','HUY','PNCNK')) or CTU.TRANGTHAI is null) AND CTU.BENHVIEN_ID = '$BENHVIEN_ID$'
        and CTU.NGAYCHUNGTU >= @TUNGAY
        and
        (
        (LoaiChungTu = 'N' And KhoNhap_ID = #KHODUOC_ID#)
        Or
        (LoaiChungTu = 'X' And KhoXuat_ID = #KHODUOC_ID#)
        )
        ) tk
        Group by tk.SoLoNhap_ID,tk.KHODUOC_ID,tk.DUOC_ID,  tk.NGUONDUOC_ID,tk.BENHVIEN_ID
        ) AS Y
        ON (X.KHODUOC_ID = Y.KHODUOC_ID AND X.SOLONHAP_ID=Y.SOLONHAP_ID AND X.DUOC_ID=Y.DUOC_ID AND X.NGUONDUOC_ID=Y.NGUONDUOC_ID AND X.BENHVIEN_ID=Y.BENHVIEN_ID)
        WHEN MATCHED THEN UPDATE SET X.SOLUONG=Y.SOLUONG
        WHEN NOT MATCHED THEN
        INSERT (KHODUOC_ID,DUOC_ID,SOLONHAP_ID,SOLUONG,NGUONDUOC_ID,BENHVIEN_ID,NGAYTAO,NGUOITAO_ID,NGAYCAPNHAT,NGUOICAPNHAT_ID) VALUES
        (Y.KHODUOC_ID,Y.DUOC_ID,Y.SOLONHAP_ID,Y.SOLUONG,Y.NGUONDUOC_ID,Y.BENHVIEN_ID,GETDATE(),NULL,GETDATE(),NULL);

        COMMIT TRANSACTION
        END TRY
        BEGIN CATCH
        IF @@TRANCOUNT &gt; 0
        ROLLBACK TRANSACTION
        END CATCH        
      </statement>
      <statement id="DAO00030_ReleaseBooking" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
        MERGE TT_DUOC_TONKHO_BOOK_NOITRU AS X USING
        (
        select AA.CHUNGTU_ID AS REF_ID, 'TT_DUOC_PHIEULINH' AS REF_TABLE,AA.BENHVIEN_ID
        from TT_DUOC_PHIEULINH AA WITH (NOLOCK)
        INNER JOIN TT_DUOC_TONKHO_BOOK_NOITRU BB WITH (NOLOCK) ON AA.CHUNGTU_ID=BB.REF_ID AND BB.REF_TABLE='TT_DUOC_PHIEULINH' AND BB.TRANGTHAI = 'HIEULUC' AND BB.SOLUONG>0
        where AA.DANHANTHUOC=1 AND AA.BENHVIEN_ID='$BENHVIEN_ID$'
        UNION ALL
        SELECT AA.TOATHUOC_ID AS REF_ID,'TT_NOITRU_TOATHUOC' AS REF_TABLE,AA.BENHVIEN_ID
        FROM TT_NOITRU_TOATHUOC AA WITH (NOLOCK)
        INNER JOIN TT_DUOC_TONKHO_BOOK_NOITRU BB WITH (NOLOCK) ON AA.TOATHUOC_ID=BB.REF_ID AND BB.REF_TABLE='TT_NOITRU_TOATHUOC' AND BB.TRANGTHAI = 'HIEULUC' AND BB.SOLUONG>0
        WHERE (AA.HUYTOATHUOC='1' OR AA.TRANGTHAI='DAXUAT') AND AA.BENHVIEN_ID='$BENHVIEN_ID$'
        ) AS Y
        ON (X.REF_ID =Y.REF_ID AND X.REF_TABLE=Y.REF_TABLE AND X.BENHVIEN_ID=Y.BENHVIEN_ID)
        WHEN MATCHED THEN UPDATE SET X.SOLUONG=0;

        MERGE TT_DUOC_TONKHO_BOOK_NGOAITRU AS X USING
        (
        select AA.TOATHUOC_ID AS REF_ID, 'TT_NGOAITRU_TOATHUOC' AS REF_TABLE,AA.BENHVIEN_ID
        from TT_NGOAITRU_KHAMBENH_TOATHUOC KBTT WITH (NOLOCK)
        INNER JOIN TT_NGOAITRU_TOATHUOC AA WITH (NOLOCK)  on AA.KHAMBENH_TOATHUOC_ID = KBTT.KHAMBENH_TOATHUOC_ID
        INNER JOIN TT_DUOC_TONKHO_BOOK_NGOAITRU BB WITH (NOLOCK) ON AA.TOATHUOC_ID=BB.REF_ID AND BB.REF_TABLE='TT_NGOAITRU_TOATHUOC' AND BB.TRANGTHAI = 'HIEULUC' AND BB.SOLUONG>0
        where (KBTT.HUYTOATHUOC='1' OR KBTT.TRANGTHAI='DAXUAT' ) AND AA.BENHVIEN_ID='$BENHVIEN_ID$'
        UNION ALL
        SELECT AA.KHAMBENH_VTYT_ID AS REF_ID,'TT_NGOAITRU_KHAMBENH_VTYT' AS REF_TABLE,AA.BENHVIEN_ID
        FROM TT_NGOAITRU_KHAMBENH_VTYT AA WITH (NOLOCK)
        INNER JOIN TT_DUOC_TONKHO_BOOK_NGOAITRU BB WITH (NOLOCK) ON AA.KHAMBENH_VTYT_ID=BB.REF_ID AND BB.REF_TABLE='TT_NGOAITRU_KHAMBENH_VTYT' AND BB.TRANGTHAI = 'HIEULUC' AND BB.SOLUONG>0
        WHERE AA.TRANGTHAI='DAXUAT' AND AA.BENHVIEN_ID='$BENHVIEN_ID$'
        ) AS Y
        ON (X.REF_ID =Y.REF_ID AND X.REF_TABLE=Y.REF_TABLE AND X.BENHVIEN_ID=Y.BENHVIEN_ID)
        WHEN MATCHED THEN UPDATE SET X.SOLUONG=0;
      </statement>
      <statement id="DAO00030_XuatNoiBo_3Buoc" parameterClass="System.Collections.IDictionary" resultClass="System.Int32">
        SET XACT_ABORT ON
        BEGIN TRANSACTION
        BEGIN TRY

        declare @xuatnoibo_chungtuID int;
        declare @nhapnoibo_chungtuID int;
        declare @xuatsudung_chungtuID int;
        declare @jsonChiTiet nvarchar(max);
        declare @jsonYLenh nvarchar(max);
        declare @jsonChiTietSD nvarchar(max);
        declare @xuatnoibo int;
        declare @nhapnoibo int;
        declare @phieulinh_id int;

        declare @xuatnoibochitiet_count int;
        declare @nhapnoibochitiet_count int;
        declare @xuatsudungchitiet_count int;

        set @jsonChiTiet = #JSON_DATA#;
        set @jsonYLenh = #JSON_DATA_YLENH#;
        set @jsonChiTietSD = #JSON_DATA_SUDUNG#;
        set @xuatnoibo = #XUAT_NOIBO#;
        set @nhapnoibo = #NHAP_NOIBO#;
        set @xuatnoibo_chungtuID = #CHUNGTU_ID#;<!--CHUNGTU_ID = CHUNGTU_ID XUAT NOI BO: dùng update chungtulienquan-->
        set @phieulinh_id = #PHIEULINH_ID#;

        set @xuatnoibochitiet_count = 1;
        set @nhapnoibochitiet_count = 1;
        set @xuatsudungchitiet_count = 1;

        begin
        IF @xuatnoibo = 1
        BEGIN
        <!--insert xuất nội bộ-->
        insert into TT_DUOC_CHUNGTU (
        MACHUNGTU,SOCHUNGTU,NGAYCHUNGTU,LOAICHUNGTU,MUCDICHCHUNGTU_ID,MUCDICHCHUNGTU_CODE,KHOXUAT_ID,NGUOIGIAO_ID,NGUOIGIAO,KHONHAP_ID,NGUOINHAN_ID,NGUOINHAN,NGUOIKIEMTRA_ID,NGUOIKIEMTRA,NGUOIDUYET_ID,NGUOIDUYET,PHUONGPHAPXUAT,KETOANTRUONG_ID,KETOANTRUONG,THUKHO_ID,THUKHO,MAUHOADON,SOHOADON,SOSERI,NGAYHOADON,DIENGIAI,GIATRI,GIATRITHANHTOAN,TYLEVAT,GIATRIVAT,THUESUAT,GIATRITHUE,TYLECHIETKHAU,GIATRICHIETKHAU,TIENTE_ID,TYGIA,SOCHUNGTUGOC,NGAYCHUNGTUGOC,NHACUNGCAP_ID,HINHTHUCTHANHTOAN_ID,NGUONDUOC_ID,CHUNGTULIENQUAN_ID,KHAMBENH_ID,TOATHUOCNOITRU_ID,TIEPNHAN_ID,BENHAN_ID,DANHANTHUOC,NGUOINHAP_ID,NGAYNHAP,TRANGTHAI,LOAITOATHUOC,PHIEULINH_ID,DIENGIAINGHIEPVUPHATSINH,DONVIGIAO_ID,KHOSUDUNG_ID,LOAIVATTU_ID,BENHNHAN_ID,NGOAITRU_TOATHUOC_NGUOIMUA_ID,TENBENHNHAN,BACSIGIOITHIEU_ID,DOITUONG_ID,IDCHUYEN,CHUNGTUKETOAN,STATUS,TRANSFER_VIENPHI_ID,PHONGBAN_ID,BACSI_ID,TKNO,TKCO,MACHUNGTUREF,LOAICHUNGTUREF,PHIEULINHCANTRU_ID,KHOTHUCHIEN_ID,KHODOIUNG_ID,MENU_LOAIDUOC_ID,NGUOISUDUNGMAY_ID,GOITHAU_ID,XUATTHUOCBANGOAITRU,NGAYGIOCHUNGTU,NOIDAKHAM,HOIDONGKIEMNHAP_ID,HOIDONGTHANHLY_ID,CHUYENCHUNGTUID,CHUYENDOANHTHUID,LYDOXUATSUDUNG_ID,BENHVIEN_ID,NGAYTAO,NGUOITAO_ID,NGAYCAPNHAT,NGUOICAPNHAT_ID)
        values (#MACHUNGTU#,#SOCHUNGTU#,#NGAYCHUNGTU#,'X',#MUCDICHCHUNGTU_ID#,'X07',#KHOXUAT_ID#,#NGUOIGIAO_ID#,#NGUOIGIAO#,#KHONHAP_ID#,#NGUOINHAN_ID#,#NGUOINHAN#,#NGUOIKIEMTRA_ID#,#NGUOIKIEMTRA#,#NGUOIDUYET_ID#,#NGUOIDUYET#,#PHUONGPHAPXUAT#,#KETOANTRUONG_ID#,#KETOANTRUONG#,#THUKHO_ID#,#THUKHO#,#MAUHOADON#,#SOHOADON#,#SOSERI#,#NGAYHOADON#,#DIENGIAI#,#GIATRI#,#GIATRITHANHTOAN#,#TYLEVAT#,#GIATRIVAT#,#THUESUAT#,#GIATRITHUE#,#TYLECHIETKHAU#,#GIATRICHIETKHAU#,#TIENTE_ID#,#TYGIA#,#SOCHUNGTUGOC#,#NGAYCHUNGTUGOC#,#NHACUNGCAP_ID#,#HINHTHUCTHANHTOAN_ID#,#NGUONDUOC_ID#,#CHUNGTULIENQUAN_ID#,#KHAMBENH_ID#,#TOATHUOCNOITRU_ID#,#TIEPNHAN_ID#,#BENHAN_ID#,#DANHANTHUOC#,#NGUOINHAP_ID#,#NGAYNHAP#,'DXK',#LOAITOATHUOC#,#PHIEULINH_ID#,#DIENGIAINGHIEPVUPHATSINH#,#DONVIGIAO_ID#,#KHOSUDUNG_ID#,#LOAIVATTU_ID#,#BENHNHAN_ID#,#NGOAITRU_TOATHUOC_NGUOIMUA_ID#,#TENBENHNHAN#,#BACSIGIOITHIEU_ID#,#DOITUONG_ID#,#IDCHUYEN#,#CHUNGTUKETOAN#,#STATUS#,#TRANSFER_VIENPHI_ID#,#PHONGBAN_ID#,#BACSI_ID#,#TKNO#,#TKCO#,#MACHUNGTUREF#,#LOAICHUNGTUREF#,#PHIEULINHCANTRU_ID#,#KHOTHUCHIEN_ID#,#KHODOIUNG_ID#,#MENU_LOAIDUOC_ID#,#NGUOISUDUNGMAY_ID#,#GOITHAU_ID#,#XUATTHUOCBANGOAITRU#,#NGAYGIOCHUNGTU#,#NOIDAKHAM#,#HOIDONGKIEMNHAP_ID#,#HOIDONGTHANHLY_ID#,#CHUYENCHUNGTUID#,#CHUYENDOANHTHUID#,#LYDOXUATSUDUNG_ID#,#BENHVIEN_ID#,#NGAYCHUNGTU#,#NGUOITAO_ID#,#NGAYCAPNHAT#,#NGUOICAPNHAT_ID#)
        set @xuatnoibo_chungtuID = SCOPE_IDENTITY()

        <!--insert chi tiet xuất nội bộ-->
        INSERT INTO TT_DUOC_CHUNGTU_CHITIET
        (CHUNGTU_ID,DUOC_ID,SOLONHAP_ID,SOKIEMSOAT,SOVISA,HANDUNG,DONVITINH_ID,SOLUONGYEUCAU,SOLUONGTHUCTE,SOLUONGDAXUAT,TIENTE_ID,TYGIA,DONGIAMUA,DONGIA_BHYT,DONGIABAN,DONGIABAN_VAT,DONGIAVON,DONGIATHANHTOAN,SOQUYEN,SOHOADONVAT,TYLEVAT,GIATRIVAT,TYLECHIETKHAU,GIATRICHIETKHAU,MIENPHI,LYDOMIENPHI_ID,SOCHUNGTUKETOAN,SOCHUNGTUTIENMAT,TRANGTHAI,DAPHATSINHPHIEUXUAT,DAPHATSINHPHIEUHOANTRA,KHUYENMAI,PHUONGPHAPXUAT,DONDATHANG_ID,GHICHUCHITIET,NGUONHANG_ID,DONGIAVONVAT,THANHTIENMUA,THANHTIENVON,THANHTIENHOPDONG,ISTACHLO,DONVITINHBANDAU_ID,SOLUONGBANDAU,GOITHAU_ID,DONGIATHAU,DONGIAPO,TYLEQUIDOI,TOATHUOCNOITRU_ID,KHAMBENH_VTYT_ID,PHAUTHUAT_VTYT_ID,CLSKETQUA_VTYT_ID,TOATHUOCNGOAITRU_ID,CHUNGTUCHITIET_LIENQUAN_ID,MASTER_ID,BENHNHAN,YLENH,BENHVIEN_ID,NGAYTAO,NGUOITAO_ID)
        SELECT @xuatnoibo_chungtuID,json.DUOC_ID, json.SOLONHAP_ID, json.SOKIEMSOAT, json.SOVISA, json.HANDUNG, json.DONVITINH_ID, json.SOLUONGYEUCAU, json.SOLUONGTHUCTE, json.SOLUONGDAXUAT, json.TIENTE_ID, json.TYGIA, json.DONGIAMUA, json.DONGIA_BHYT, json.DONGIABAN, json.DONGIABAN_VAT, json.DONGIAVON, json.DONGIATHANHTOAN, json.SOQUYEN, json.SOHOADONVAT, json.TYLEVAT, json.GIATRIVAT, json.TYLECHIETKHAU, json.GIATRICHIETKHAU, json.MIENPHI, json.LYDOMIENPHI_ID, json.SOCHUNGTUKETOAN, json.SOCHUNGTUTIENMAT, json.TRANGTHAI, json.DAPHATSINHPHIEUXUAT, json.DAPHATSINHPHIEUHOANTRA, json.KHUYENMAI, json.PHUONGPHAPXUAT, json.DONDATHANG_ID, json.GHICHUCHITIET, json.NGUONHANG_ID, json.DONGIAVONVAT, json.THANHTIENMUA, json.THANHTIENVON, json.THANHTIENHOPDONG, json.ISTACHLO, json.DONVITINHBANDAU_ID, json.SOLUONGBANDAU, json.GOITHAU_ID, json.DONGIATHAU, json.DONGIAPO, json.TYLEQUIDOI, json.TOATHUOCNOITRU_ID, json.KHAMBENH_VTYT_ID, json.PHAUTHUAT_VTYT_ID, json.CLSKETQUA_VTYT_ID, json.TOATHUOCNGOAITRU_ID, json.CHUNGTUCHITIET_LIENQUAN_ID, json.MASTER_ID, json.BENHNHAN, json.YLENH, #BENHVIEN_ID#, getdate(), json.NGUOITAO_ID
        FROM OPENJSON(@jsonChiTiet)
        WITH (DUOC_ID int,SOLONHAP_ID int,SOKIEMSOAT varchar(20),SOVISA varchar(20),HANDUNG datetime,DONVITINH_ID int,SOLUONGYEUCAU numeric(25, 4),SOLUONGTHUCTE numeric(25, 4),SOLUONGDAXUAT numeric(25, 4),TIENTE_ID nchar(3),TYGIA numeric(25, 4),DONGIAMUA numeric(25, 4),DONGIA_BHYT numeric(25, 4),DONGIABAN numeric(25, 4),DONGIABAN_VAT numeric(25, 4),DONGIAVON numeric(25, 4),DONGIATHANHTOAN numeric(25, 4),SOQUYEN varchar(20),SOHOADONVAT varchar(20),TYLEVAT  numeric(25, 4),GIATRIVAT numeric(25, 4),TYLECHIETKHAU numeric(25, 4),GIATRICHIETKHAU numeric(25, 4),MIENPHI char(1),LYDOMIENPHI_ID int,SOCHUNGTUKETOAN varchar(20),SOCHUNGTUTIENMAT varchar(20),TRANGTHAI varchar(10),DAPHATSINHPHIEUXUAT char(1),DAPHATSINHPHIEUHOANTRA char(1),KHUYENMAI char(1),PHUONGPHAPXUAT int,DONDATHANG_ID int,GHICHUCHITIET nvarchar(255),NGUONHANG_ID int,DONGIAVONVAT numeric(25, 4),THANHTIENMUA numeric(25, 4),THANHTIENVON numeric(25, 4),THANHTIENHOPDONG numeric(25, 4),ISTACHLO char(1),DONVITINHBANDAU_ID int,SOLUONGBANDAU numeric(25, 4),GOITHAU_ID int,DONGIATHAU numeric(25, 4),DONGIAPO numeric(25, 4),TYLEQUIDOI numeric(25, 4),TOATHUOCNOITRU_ID int,KHAMBENH_VTYT_ID int,PHAUTHUAT_VTYT_ID int,CLSKETQUA_VTYT_ID int,TOATHUOCNGOAITRU_ID int,CHUNGTUCHITIET_LIENQUAN_ID int,MASTER_ID int,BENHNHAN nvarchar(1000),YLENH nvarchar(MAX),BENHVIEN_ID varchar(10),NGAYTAO datetime,NGUOITAO_ID int) json

        IF @phieulinh_id > 0
        BEGIN
        update TT_DUOC_PHIEULINH set DANHANTHUOC = 1 ,TRANGTHAI = 'DANHANTHUOC' ,CHUNGTULIENQUAN_ID = @xuatnoibo_chungtuID ,NGAYCAPNHAT = getdate() where CHUNGTU_ID = @phieulinh_id
        END

        set @xuatnoibochitiet_count = (select count(*) from TT_DUOC_CHUNGTU_CHITIET where BENHVIEN_ID='$BENHVIEN_ID$' and CHUNGTU_ID=@xuatnoibo_chungtuID);
        IF (@xuatnoibochitiet_count &lt;= 0)
        BEGIN
        ROLLBACK TRANSACTION
        RETURN
        END

        END
        IF @nhapnoibo = 1
        BEGIN
      <!--insert nhập nội bộ-->
        insert into TT_DUOC_CHUNGTU (
        MACHUNGTU,SOCHUNGTU,NGAYCHUNGTU,LOAICHUNGTU,MUCDICHCHUNGTU_ID,MUCDICHCHUNGTU_CODE,KHOXUAT_ID,NGUOIGIAO_ID,NGUOIGIAO,KHONHAP_ID,NGUOINHAN_ID,NGUOINHAN,NGUOIKIEMTRA_ID,NGUOIKIEMTRA,NGUOIDUYET_ID,NGUOIDUYET,PHUONGPHAPXUAT,KETOANTRUONG_ID,KETOANTRUONG,THUKHO_ID,THUKHO,MAUHOADON,SOHOADON,SOSERI,NGAYHOADON,DIENGIAI,GIATRI,GIATRITHANHTOAN,TYLEVAT,GIATRIVAT,THUESUAT,GIATRITHUE,TYLECHIETKHAU,GIATRICHIETKHAU,TIENTE_ID,TYGIA,SOCHUNGTUGOC,NGAYCHUNGTUGOC,NHACUNGCAP_ID,HINHTHUCTHANHTOAN_ID,NGUONDUOC_ID,CHUNGTULIENQUAN_ID,KHAMBENH_ID,TOATHUOCNOITRU_ID,TIEPNHAN_ID,BENHAN_ID,DANHANTHUOC,NGUOINHAP_ID,NGAYNHAP,TRANGTHAI,LOAITOATHUOC,PHIEULINH_ID,DIENGIAINGHIEPVUPHATSINH,DONVIGIAO_ID,KHOSUDUNG_ID,LOAIVATTU_ID,BENHNHAN_ID,NGOAITRU_TOATHUOC_NGUOIMUA_ID,TENBENHNHAN,BACSIGIOITHIEU_ID,DOITUONG_ID,IDCHUYEN,CHUNGTUKETOAN,STATUS,TRANSFER_VIENPHI_ID,PHONGBAN_ID,BACSI_ID,TKNO,TKCO,MACHUNGTUREF,LOAICHUNGTUREF,PHIEULINHCANTRU_ID,KHOTHUCHIEN_ID,KHODOIUNG_ID,MENU_LOAIDUOC_ID,NGUOISUDUNGMAY_ID,GOITHAU_ID,XUATTHUOCBANGOAITRU,NGAYGIOCHUNGTU,NOIDAKHAM,HOIDONGKIEMNHAP_ID,HOIDONGTHANHLY_ID,CHUYENCHUNGTUID,CHUYENDOANHTHUID,LYDOXUATSUDUNG_ID,BENHVIEN_ID,NGAYTAO,NGUOITAO_ID,NGAYCAPNHAT,NGUOICAPNHAT_ID)
        values (#MACHUNGTUNHAP#,#SOCHUNGTUNHAP#,#NGAYCHUNGTUNHAP#,'N',#MUCDICHCHUNGTU_IDNHAP#,'N05',#KHOXUAT_ID#,#NGUOIGIAO_ID#,#NGUOIGIAO#,#KHONHAP_ID#,#NGUOINHAN_IDNHAP#,#NGUOINHAN#,#NGUOIKIEMTRA_ID#,#NGUOIKIEMTRA#,#NGUOIDUYET_ID#,#NGUOIDUYET#,#PHUONGPHAPXUAT#,#KETOANTRUONG_ID#,#KETOANTRUONG#,#THUKHO_ID#,#THUKHO#,#MAUHOADON#,#SOHOADON#,#SOSERI#,#NGAYHOADON#,#DIENGIAI#,#GIATRI#,#GIATRITHANHTOAN#,#TYLEVAT#,#GIATRIVAT#,#THUESUAT#,#GIATRITHUE#,#TYLECHIETKHAU#,#GIATRICHIETKHAU#,#TIENTE_ID#,#TYGIA#,#MACHUNGTU#,#NGAYCHUNGTU#,#NHACUNGCAP_ID#,#HINHTHUCTHANHTOAN_ID#,#NGUONDUOC_ID#,#CHUNGTULIENQUAN_ID#,#KHAMBENH_ID#,#TOATHUOCNOITRU_ID#,#TIEPNHAN_ID#,#BENHAN_ID#,#DANHANTHUOC#,#NGUOINHAP_ID#,#NGAYNHAP#,'DNK',#LOAITOATHUOC#,#PHIEULINH_ID#,#DIENGIAINGHIEPVUPHATSINH_NHAP#,#DONVIGIAO_ID#,#KHOSUDUNG_ID#,#LOAIVATTU_ID#,#BENHNHAN_ID#,#NGOAITRU_TOATHUOC_NGUOIMUA_ID#,#TENBENHNHAN#,#BACSIGIOITHIEU_ID#,#DOITUONG_ID#,#IDCHUYEN#,#CHUNGTUKETOAN#,#STATUS#,#TRANSFER_VIENPHI_ID#,#PHONGBAN_ID#,#BACSI_ID#,#TKNO#,#TKCO#,#MACHUNGTUREF#,#LOAICHUNGTUREF#,#PHIEULINHCANTRU_ID#,#KHOTHUCHIEN_ID#,#KHODOIUNG_ID#,#MENU_LOAIDUOC_ID#,#NGUOISUDUNGMAY_ID#,#GOITHAU_ID#,#XUATTHUOCBANGOAITRU#,#NGAYGIOCHUNGTU#,#NOIDAKHAM#,#HOIDONGKIEMNHAP_ID#,#HOIDONGTHANHLY_ID#,#CHUYENCHUNGTUID#,#CHUYENDOANHTHUID#,#LYDOXUATSUDUNG_ID#,#BENHVIEN_ID#,#NGAYCHUNGTU#,#NGUOITAO_ID#,#NGAYCAPNHAT#,#NGUOICAPNHAT_ID#)
        set @nhapnoibo_chungtuID = SCOPE_IDENTITY()

        <!--update chứng từ liên quan xuất nội bộ-->
        update TT_DUOC_CHUNGTU set CHUNGTULIENQUAN_ID = @nhapnoibo_chungtuID WHERE CHUNGTU_ID=@xuatnoibo_chungtuID

        <!--insert chi tiet nhập nội bộ-->
        INSERT INTO TT_DUOC_CHUNGTU_CHITIET
        (CHUNGTU_ID,DUOC_ID,SOLONHAP_ID,SOKIEMSOAT,SOVISA,HANDUNG,DONVITINH_ID,SOLUONGYEUCAU,SOLUONGTHUCTE,SOLUONGDAXUAT,TIENTE_ID,TYGIA,DONGIAMUA,DONGIA_BHYT,DONGIABAN,DONGIABAN_VAT,DONGIAVON,DONGIATHANHTOAN,SOQUYEN,SOHOADONVAT,TYLEVAT,GIATRIVAT,TYLECHIETKHAU,GIATRICHIETKHAU,MIENPHI,LYDOMIENPHI_ID,SOCHUNGTUKETOAN,SOCHUNGTUTIENMAT,TRANGTHAI,DAPHATSINHPHIEUXUAT,DAPHATSINHPHIEUHOANTRA,KHUYENMAI,PHUONGPHAPXUAT,DONDATHANG_ID,GHICHUCHITIET,NGUONHANG_ID,DONGIAVONVAT,THANHTIENMUA,THANHTIENVON,THANHTIENHOPDONG,ISTACHLO,DONVITINHBANDAU_ID,SOLUONGBANDAU,GOITHAU_ID,DONGIATHAU,DONGIAPO,TYLEQUIDOI,TOATHUOCNOITRU_ID,KHAMBENH_VTYT_ID,PHAUTHUAT_VTYT_ID,CLSKETQUA_VTYT_ID,TOATHUOCNGOAITRU_ID,CHUNGTUCHITIET_LIENQUAN_ID,MASTER_ID,BENHNHAN,YLENH,BENHVIEN_ID,NGAYTAO,NGUOITAO_ID)
        SELECT @nhapnoibo_chungtuID,json.DUOC_ID, json.SOLONHAP_ID, json.SOKIEMSOAT, json.SOVISA, json.HANDUNG, json.DONVITINH_ID, json.SOLUONGYEUCAU, json.SOLUONGDAXUAT, NULL, json.TIENTE_ID, json.TYGIA, json.DONGIAMUA, json.DONGIA_BHYT, json.DONGIABAN, json.DONGIABAN_VAT, json.DONGIAVON, json.DONGIATHANHTOAN, json.SOQUYEN, json.SOHOADONVAT, json.TYLEVAT, json.GIATRIVAT, json.TYLECHIETKHAU, json.GIATRICHIETKHAU, json.MIENPHI, json.LYDOMIENPHI_ID, json.SOCHUNGTUKETOAN, json.SOCHUNGTUTIENMAT, json.TRANGTHAI, json.DAPHATSINHPHIEUXUAT, json.DAPHATSINHPHIEUHOANTRA, json.KHUYENMAI, json.PHUONGPHAPXUAT, json.DONDATHANG_ID, json.GHICHUCHITIET, json.NGUONHANG_ID, json.DONGIAVONVAT, json.THANHTIENMUA, json.THANHTIENVON, json.THANHTIENHOPDONG, json.ISTACHLO, json.DONVITINHBANDAU_ID, json.SOLUONGBANDAU, json.GOITHAU_ID, json.DONGIATHAU, json.DONGIAPO, json.TYLEQUIDOI, json.TOATHUOCNOITRU_ID, json.KHAMBENH_VTYT_ID, json.PHAUTHUAT_VTYT_ID, json.CLSKETQUA_VTYT_ID, json.TOATHUOCNGOAITRU_ID, json.CHUNGTUCHITIET_LIENQUAN_ID, json.MASTER_ID, json.BENHNHAN, json.YLENH, #BENHVIEN_ID#, getdate(), json.NGUOITAO_ID
        FROM OPENJSON(@jsonChiTiet)
        WITH (DUOC_ID int,SOLONHAP_ID int,SOKIEMSOAT varchar(20),SOVISA varchar(20),HANDUNG datetime,DONVITINH_ID int,SOLUONGYEUCAU numeric(25, 4),SOLUONGTHUCTE numeric(25, 4),SOLUONGDAXUAT numeric(25, 4),TIENTE_ID nchar(3),TYGIA numeric(25, 4),DONGIAMUA numeric(25, 4),DONGIA_BHYT numeric(25, 4),DONGIABAN numeric(25, 4),DONGIABAN_VAT numeric(25, 4),DONGIAVON numeric(25, 4),DONGIATHANHTOAN numeric(25, 4),SOQUYEN varchar(20),SOHOADONVAT varchar(20),TYLEVAT  numeric(25, 4),GIATRIVAT numeric(25, 4),TYLECHIETKHAU numeric(25, 4),GIATRICHIETKHAU numeric(25, 4),MIENPHI char(1),LYDOMIENPHI_ID int,SOCHUNGTUKETOAN varchar(20),SOCHUNGTUTIENMAT varchar(20),TRANGTHAI varchar(10),DAPHATSINHPHIEUXUAT char(1),DAPHATSINHPHIEUHOANTRA char(1),KHUYENMAI char(1),PHUONGPHAPXUAT int,DONDATHANG_ID int,GHICHUCHITIET nvarchar(255),NGUONHANG_ID int,DONGIAVONVAT numeric(25, 4),THANHTIENMUA numeric(25, 4),THANHTIENVON numeric(25, 4),THANHTIENHOPDONG numeric(25, 4),ISTACHLO char(1),DONVITINHBANDAU_ID int,SOLUONGBANDAU numeric(25, 4),GOITHAU_ID int,DONGIATHAU numeric(25, 4),DONGIAPO numeric(25, 4),TYLEQUIDOI numeric(25, 4),TOATHUOCNOITRU_ID int,KHAMBENH_VTYT_ID int,PHAUTHUAT_VTYT_ID int,CLSKETQUA_VTYT_ID int,TOATHUOCNGOAITRU_ID int,CHUNGTUCHITIET_LIENQUAN_ID int,MASTER_ID int,BENHNHAN nvarchar(1000),YLENH nvarchar(MAX),BENHVIEN_ID varchar(10),NGAYTAO datetime,NGUOITAO_ID int) json

        set @nhapnoibochitiet_count = (select count(*) from TT_DUOC_CHUNGTU_CHITIET where BENHVIEN_ID='$BENHVIEN_ID$' and CHUNGTU_ID=@nhapnoibo_chungtuID);
        IF (@nhapnoibochitiet_count &lt;= 0)
        BEGIN
        ROLLBACK TRANSACTION
        RETURN
        END
        
        END

        <!--Xuất sử dụng-->
        declare @machungtu VARCHAR(100);
        declare @sochungtu VARCHAR(100);
        declare @diengiainghiepvu NVARCHAR(max);
        declare @master_id INT;
        declare @i INT;
        declare @numrows INT;
        declare @coChiTiet INT;
        
        SET @i = 1;
        SET @numrows = #XUAT_SUDUNG#;
        IF @numrows > 0
        WHILE (@i &lt;= @numrows)
        BEGIN

        SET @machungtu = (SELECT json.MACHUNGTU FROM OPENJSON(@jsonYLenh) WITH (STT int, MACHUNGTU varchar(100)) json where json.STT=@i)
        SET @sochungtu = (SELECT json.SOCHUNGTU FROM OPENJSON(@jsonYLenh) WITH (STT int,SOCHUNGTU varchar(100)) json where json.STT=@i)
        SET @master_id = (SELECT json.MASTER_ID FROM OPENJSON(@jsonYLenh) WITH (STT int, MASTER_ID int) json where json.STT=@i)
        SET @diengiainghiepvu = (SELECT json.DIENGIAINGHIEPVUPHATSINH FROM OPENJSON(@jsonYLenh) WITH (STT int, DIENGIAINGHIEPVUPHATSINH NVARCHAR(max)) json where json.STT=@i)

        SELECT @coChiTiet = COUNT(json.DUOC_ID)
        FROM OPENJSON(@jsonChiTietSD)
        WITH (
        DUOC_ID int, MASTER_ID int
        ) json
        WHERE json.MASTER_ID = @master_id
        
        IF(@coChiTiet > 0)
        BEGIN
        insert into TT_DUOC_CHUNGTU (
        MACHUNGTU,SOCHUNGTU,NGAYCHUNGTU,LOAICHUNGTU,MUCDICHCHUNGTU_ID,MUCDICHCHUNGTU_CODE,KHOXUAT_ID,NGUOIGIAO_ID,NGUOIGIAO,KHONHAP_ID,NGUOINHAN_ID,NGUOINHAN,NGUOIKIEMTRA_ID,NGUOIKIEMTRA,NGUOIDUYET_ID,NGUOIDUYET,PHUONGPHAPXUAT,KETOANTRUONG_ID,KETOANTRUONG,THUKHO_ID,THUKHO,MAUHOADON,SOHOADON,SOSERI,NGAYHOADON,DIENGIAI,GIATRI,GIATRITHANHTOAN,TYLEVAT,GIATRIVAT,THUESUAT,GIATRITHUE,TYLECHIETKHAU,GIATRICHIETKHAU,TIENTE_ID,TYGIA,SOCHUNGTUGOC,NGAYCHUNGTUGOC,NHACUNGCAP_ID,HINHTHUCTHANHTOAN_ID,NGUONDUOC_ID,CHUNGTULIENQUAN_ID,KHAMBENH_ID,TOATHUOCNOITRU_ID,TIEPNHAN_ID,BENHAN_ID,DANHANTHUOC,NGUOINHAP_ID,NGAYNHAP,TRANGTHAI,LOAITOATHUOC,PHIEULINH_ID,DIENGIAINGHIEPVUPHATSINH,DONVIGIAO_ID,KHOSUDUNG_ID,LOAIVATTU_ID,BENHNHAN_ID,NGOAITRU_TOATHUOC_NGUOIMUA_ID,TENBENHNHAN,BACSIGIOITHIEU_ID,DOITUONG_ID,IDCHUYEN,CHUNGTUKETOAN,STATUS,TRANSFER_VIENPHI_ID,PHONGBAN_ID,BACSI_ID,TKNO,TKCO,MACHUNGTUREF,LOAICHUNGTUREF,PHIEULINHCANTRU_ID,KHOTHUCHIEN_ID,KHODOIUNG_ID,MENU_LOAIDUOC_ID,NGUOISUDUNGMAY_ID,GOITHAU_ID,XUATTHUOCBANGOAITRU,NGAYGIOCHUNGTU,NOIDAKHAM,HOIDONGKIEMNHAP_ID,HOIDONGTHANHLY_ID,CHUYENCHUNGTUID,CHUYENDOANHTHUID,LYDOXUATSUDUNG_ID,BENHVIEN_ID,NGAYTAO,NGUOITAO_ID,NGAYCAPNHAT,NGUOICAPNHAT_ID)
        values (@machungtu,@sochungtu, DATEADD (ss, @i, #NGAYCHUNGTUXUATSUDUNG#),'X',#MUCDICHCHUNGTU_IDSUDDUNG#,'X13',#KHONHAP_ID#,#NGUOIGIAO_IDXUATSD#,#NGUOIGIAO#,NULL,NULL,#NGUOINHAN#,#NGUOIKIEMTRA_ID#,#NGUOIKIEMTRA#,#NGUOIDUYET_ID#,#NGUOIDUYET#,#PHUONGPHAPXUAT#,#KETOANTRUONG_ID#,#KETOANTRUONG#,#THUKHO_ID#,#THUKHO#,#MAUHOADON#,#SOHOADON#,#SOSERI#,#NGAYHOADON#,#DIENGIAI#,#GIATRI#,#GIATRITHANHTOAN#,#TYLEVAT#,#GIATRIVAT#,#THUESUAT#,#GIATRITHUE#,#TYLECHIETKHAU#,#GIATRICHIETKHAU#,#TIENTE_ID#,#TYGIA#,#MACHUNGTUNHAP#,#NGAYCHUNGTUNHAP#,#NHACUNGCAP_ID#,#HINHTHUCTHANHTOAN_ID#,#NGUONDUOC_ID#,#CHUNGTULIENQUAN_ID#,#KHAMBENH_ID#,1,#TIEPNHAN_ID#,#BENHAN_ID#,#DANHANTHUOC#,#NGUOINHAP_ID#,#NGAYNHAP#,'DAXUAT',#LOAITOATHUOC#,#PHIEULINH_ID#,@diengiainghiepvu,#DONVIGIAO_ID#,#KHOSUDUNG_ID#,#LOAIVATTU_ID#,#BENHNHAN_ID#,#NGOAITRU_TOATHUOC_NGUOIMUA_ID#,#TENBENHNHAN#,#BACSIGIOITHIEU_ID#,#DOITUONG_ID#,#IDCHUYEN#,#CHUNGTUKETOAN#,#STATUS#,#TRANSFER_VIENPHI_ID#,#PHONGBAN_ID#,#BACSI_ID#,#TKNO#,#TKCO#,#MACHUNGTUREF#,#LOAICHUNGTUREF#,#PHIEULINHCANTRU_ID#,#KHOTHUCHIEN_ID#,#KHODOIUNG_ID#,#MENU_LOAIDUOC_ID#,#NGUOISUDUNGMAY_ID#,#GOITHAU_ID#,#XUATTHUOCBANGOAITRU#,#NGAYGIOCHUNGTU#,#NOIDAKHAM#,#HOIDONGKIEMNHAP_ID#,#HOIDONGTHANHLY_ID#,#CHUYENCHUNGTUID#,#CHUYENDOANHTHUID#,8294,#BENHVIEN_ID#,#NGAYCHUNGTU#,#NGUOITAO_ID#,#NGAYCAPNHAT#,#NGUOICAPNHAT_ID#)

        set @xuatsudung_chungtuID = SCOPE_IDENTITY()

        IF @i = 1
        BEGIN
        update TT_DUOC_CHUNGTU set CHUNGTULIENQUAN_ID = @xuatsudung_chungtuID WHERE CHUNGTU_ID=@nhapnoibo_chungtuID
        END

        INSERT INTO TT_DUOC_CHUNGTU_CHITIET
        (CHUNGTU_ID,DUOC_ID,SOLONHAP_ID,SOKIEMSOAT,SOVISA,HANDUNG,DONVITINH_ID,SOLUONGYEUCAU,SOLUONGTHUCTE,SOLUONGDAXUAT,TIENTE_ID,TYGIA,DONGIAMUA,DONGIA_BHYT,DONGIABAN,DONGIABAN_VAT,DONGIAVON,DONGIATHANHTOAN,SOQUYEN,SOHOADONVAT,TYLEVAT,GIATRIVAT,TYLECHIETKHAU,GIATRICHIETKHAU,MIENPHI,LYDOMIENPHI_ID,SOCHUNGTUKETOAN,SOCHUNGTUTIENMAT,TRANGTHAI,DAPHATSINHPHIEUXUAT,DAPHATSINHPHIEUHOANTRA,KHUYENMAI,PHUONGPHAPXUAT,DONDATHANG_ID,GHICHUCHITIET,NGUONHANG_ID,DONGIAVONVAT,THANHTIENMUA,THANHTIENVON,THANHTIENHOPDONG,ISTACHLO,DONVITINHBANDAU_ID,SOLUONGBANDAU,GOITHAU_ID,DONGIATHAU,DONGIAPO,TYLEQUIDOI,TOATHUOCNOITRU_ID,KHAMBENH_VTYT_ID,PHAUTHUAT_VTYT_ID,CLSKETQUA_VTYT_ID,TOATHUOCNGOAITRU_ID,CHUNGTUCHITIET_LIENQUAN_ID,MASTER_ID,BENHNHAN,YLENH,BENHVIEN_ID,NGAYTAO,NGUOITAO_ID)
        SELECT @xuatsudung_chungtuID,json.DUOC_ID, json.SOLONHAP_ID, json.SOKIEMSOAT, json.SOVISA, json.HANDUNG, json.DONVITINH_ID, json.SOLUONGYEUCAU, json.SOLUONGTHUCTE, json.SOLUONGDAXUAT, json.TIENTE_ID, json.TYGIA, json.DONGIAMUA, json.DONGIA_BHYT, json.DONGIABAN, json.DONGIABAN_VAT, json.DONGIAVON, json.DONGIATHANHTOAN, json.SOQUYEN, json.SOHOADONVAT, json.TYLEVAT, json.GIATRIVAT, json.TYLECHIETKHAU, json.GIATRICHIETKHAU, json.MIENPHI, json.LYDOMIENPHI_ID, json.SOCHUNGTUKETOAN, json.SOCHUNGTUTIENMAT, json.TRANGTHAI, json.DAPHATSINHPHIEUXUAT, json.DAPHATSINHPHIEUHOANTRA, json.KHUYENMAI, json.PHUONGPHAPXUAT, json.DONDATHANG_ID, json.GHICHUCHITIET, json.NGUONHANG_ID, json.DONGIAVONVAT, json.THANHTIENMUA, json.THANHTIENVON, json.THANHTIENHOPDONG, json.ISTACHLO, json.DONVITINHBANDAU_ID, json.SOLUONGBANDAU, json.GOITHAU_ID, json.DONGIATHAU, json.DONGIAPO, json.TYLEQUIDOI, json.TOATHUOCNOITRU_ID, json.KHAMBENH_VTYT_ID, json.PHAUTHUAT_VTYT_ID, json.CLSKETQUA_VTYT_ID, json.TOATHUOCNGOAITRU_ID, json.CHUNGTUCHITIET_LIENQUAN_ID, json.MASTER_ID, json.BENHNHAN, json.YLENH, #BENHVIEN_ID#, getdate(), json.NGUOITAO_ID
        FROM OPENJSON(@jsonChiTietSD)
        WITH (
        DUOC_ID int,SOLONHAP_ID int,SOKIEMSOAT varchar(20),SOVISA varchar(20),HANDUNG datetime,DONVITINH_ID int,SOLUONGYEUCAU numeric(25, 4),SOLUONGTHUCTE numeric(25, 4),SOLUONGDAXUAT numeric(25, 4),TIENTE_ID nchar(3),TYGIA numeric(25, 4),DONGIAMUA numeric(25, 4),DONGIA_BHYT numeric(25, 4),DONGIABAN numeric(25, 4),DONGIABAN_VAT numeric(25, 4),DONGIAVON numeric(25, 4),DONGIATHANHTOAN numeric(25, 4),SOQUYEN varchar(20),SOHOADONVAT varchar(20),TYLEVAT  numeric(25, 4),GIATRIVAT numeric(25, 4),TYLECHIETKHAU numeric(25, 4),GIATRICHIETKHAU numeric(25, 4),MIENPHI char(1),LYDOMIENPHI_ID int,SOCHUNGTUKETOAN varchar(20),SOCHUNGTUTIENMAT varchar(20),TRANGTHAI varchar(10),DAPHATSINHPHIEUXUAT char(1),DAPHATSINHPHIEUHOANTRA char(1),KHUYENMAI char(1),PHUONGPHAPXUAT int,DONDATHANG_ID int,GHICHUCHITIET nvarchar(255),NGUONHANG_ID int,DONGIAVONVAT numeric(25, 4),THANHTIENMUA numeric(25, 4),THANHTIENVON numeric(25, 4),THANHTIENHOPDONG numeric(25, 4),ISTACHLO char(1),DONVITINHBANDAU_ID int,SOLUONGBANDAU numeric(25, 4),GOITHAU_ID int,DONGIATHAU numeric(25, 4),DONGIAPO numeric(25, 4),TYLEQUIDOI numeric(25, 4),TOATHUOCNOITRU_ID int,KHAMBENH_VTYT_ID int,PHAUTHUAT_VTYT_ID int,CLSKETQUA_VTYT_ID int,TOATHUOCNGOAITRU_ID int,CHUNGTUCHITIET_LIENQUAN_ID int,MASTER_ID int,BENHNHAN nvarchar(1000),YLENH nvarchar(MAX),BENHVIEN_ID varchar(10),NGAYTAO datetime,NGUOITAO_ID int
        ) json
        WHERE json.MASTER_ID = @master_id       

        <!--TT_NOITRU_TOATHUOC-->
        UPDATE TT_NOITRU_TOATHUOC SET CHUNGTU_ID = @xuatsudung_chungtuID, TRANGTHAI = 'DAXUAT', NGAYCAPNHAT = getdate()
        FROM OPENJSON(@jsonChiTietSD)
        WITH (MASTER_ID int,TOATHUOCNOITRU_ID int) json
        WHERE TT_NOITRU_TOATHUOC.TOATHUOC_ID = json.TOATHUOCNOITRU_ID and json.TOATHUOCNOITRU_ID is not NULL and json.MASTER_ID = @master_id

        UPDATE TT_VIENPHI set DUYET = '1', DATHUCHIEN = '1', NGAYCAPNHAT = getdate()
        FROM OPENJSON(@jsonChiTietSD)
        WITH (MASTER_ID int,TOATHUOCNOITRU_ID int) json
        WHERE TT_VIENPHI.REF_TABLE = 'TT_NOITRU_TOATHUOC' and TT_VIENPHI.REF_ID = json.TOATHUOCNOITRU_ID and json.TOATHUOCNOITRU_ID is not NULL and json.MASTER_ID = @master_id

        <!--TT_NGOAITRU_KHAMBENH_VTYT-->
        UPDATE TT_NGOAITRU_KHAMBENH_VTYT SET CHUNGTU_ID = @xuatsudung_chungtuID, TRANGTHAI = 'DAXUAT', NGAYCAPNHAT = getdate()
        FROM OPENJSON(@jsonChiTietSD)
        WITH (MASTER_ID int,KHAMBENH_VTYT_ID int) json
        WHERE TT_NGOAITRU_KHAMBENH_VTYT.KHAMBENH_VTYT_ID = json.KHAMBENH_VTYT_ID and json.KHAMBENH_VTYT_ID is not NULL and json.MASTER_ID = @master_id

        UPDATE TT_VIENPHI set DUYET = '1', DATHUCHIEN = '1', NGAYCAPNHAT = getdate()
        FROM OPENJSON(@jsonChiTietSD)
        WITH (MASTER_ID int,KHAMBENH_VTYT_ID int) json
        WHERE TT_VIENPHI.REF_TABLE = 'TT_NGOAITRU_KHAMBENH_VTYT' and TT_VIENPHI.REF_ID = json.KHAMBENH_VTYT_ID and json.KHAMBENH_VTYT_ID is not NULL and json.MASTER_ID = @master_id

        <!--TT_PHAUTHUAT_VTYT-->
        UPDATE TT_PHAUTHUAT_VTYT SET CHUNGTU_ID = @xuatsudung_chungtuID
        FROM OPENJSON(@jsonChiTietSD)
        WITH (MASTER_ID int,PHAUTHUAT_VTYT_ID int) json
        WHERE TT_PHAUTHUAT_VTYT.PHAUTHUAT_VTYT_ID = json.PHAUTHUAT_VTYT_ID and json.PHAUTHUAT_VTYT_ID is not NULL and json.MASTER_ID = @master_id

        UPDATE TT_VIENPHI set DUYET = '1', DATHUCHIEN = '1', NGAYCAPNHAT = getdate()
        FROM OPENJSON(@jsonChiTietSD)
        WITH (MASTER_ID int,PHAUTHUAT_VTYT_ID int) json
        WHERE TT_VIENPHI.REF_TABLE = 'TT_PHAUTHUAT_VTYT' and TT_VIENPHI.REF_ID = json.PHAUTHUAT_VTYT_ID and json.PHAUTHUAT_VTYT_ID is not NULL and json.MASTER_ID = @master_id

        <!--TT_CLSKETQUA_VTYT-->
        UPDATE TT_CLSKETQUA_VTYT SET CHUNGTU_ID = @xuatsudung_chungtuID, TRANGTHAI = 'DAXUAT', NGAYCAPNHAT = getdate()
        FROM OPENJSON(@jsonChiTietSD)
        WITH (MASTER_ID int,CLSKETQUA_VTYT_ID int) json
        WHERE TT_CLSKETQUA_VTYT.CLSKETQUA_VTYT_ID = json.CLSKETQUA_VTYT_ID and json.CLSKETQUA_VTYT_ID is not NULL and json.MASTER_ID = @master_id

        UPDATE TT_VIENPHI set DUYET = '1', DATHUCHIEN = '1', NGAYCAPNHAT = getdate()
        FROM OPENJSON(@jsonChiTietSD)
        WITH (MASTER_ID int,CLSKETQUA_VTYT_ID int) json
        WHERE TT_VIENPHI.REF_TABLE = 'TT_CLSKETQUA_VTYT' and TT_VIENPHI.REF_ID = json.CLSKETQUA_VTYT_ID and json.CLSKETQUA_VTYT_ID is not NULL and json.MASTER_ID = @master_id
        
        END
        
        SET @i = @i + 1
        
        END
        <!--END XUAT SD-->

        select @xuatnoibo_chungtuID
        end

        COMMIT TRANSACTION
        END TRY
        BEGIN CATCH
        IF @@TRANCOUNT &gt; 0
        ROLLBACK TRANSACTION
        END CATCH        
      </statement>
      <statement id="DAO00030_ThemChungTuXSD" parameterClass="System.Collections.IDictionary" resultClass="System.Int32">
        declare @jsonChiTiet nvarchar(max);
        set @jsonChiTiet = #JSON_DATA#;
        declare @type nvarchar(max);
        set @type = #REF_TABLE#;

        declare @chungtu_id int;

        SET XACT_ABORT ON
        BEGIN TRAN
        BEGIN TRY

        <!--insert CHUNGTU-->
        insert into TT_DUOC_CHUNGTU (
        MACHUNGTU,SOCHUNGTU,NGAYCHUNGTU,LOAICHUNGTU,MUCDICHCHUNGTU_ID,MUCDICHCHUNGTU_CODE,KHOXUAT_ID,NGUOIGIAO_ID,NGUOIGIAO,KHONHAP_ID,NGUOINHAN_ID,NGUOINHAN,NGUOIKIEMTRA_ID,NGUOIKIEMTRA,NGUOIDUYET_ID,NGUOIDUYET,PHUONGPHAPXUAT,KETOANTRUONG_ID,KETOANTRUONG,THUKHO_ID,THUKHO,MAUHOADON,SOHOADON,SOSERI,NGAYHOADON,DIENGIAI,GIATRI,GIATRITHANHTOAN,TYLEVAT,GIATRIVAT,THUESUAT,GIATRITHUE,TYLECHIETKHAU,GIATRICHIETKHAU,TIENTE_ID,TYGIA,SOCHUNGTUGOC,NGAYCHUNGTUGOC,NHACUNGCAP_ID,HINHTHUCTHANHTOAN_ID,NGUONDUOC_ID,CHUNGTULIENQUAN_ID,KHAMBENH_ID,TOATHUOCNOITRU_ID,TIEPNHAN_ID,BENHAN_ID,DANHANTHUOC,NGUOINHAP_ID,NGAYNHAP,TRANGTHAI,LOAITOATHUOC,PHIEULINH_ID,DIENGIAINGHIEPVUPHATSINH,DONVIGIAO_ID,KHOSUDUNG_ID,LOAIVATTU_ID,BENHNHAN_ID,NGOAITRU_TOATHUOC_NGUOIMUA_ID,TENBENHNHAN,BACSIGIOITHIEU_ID,DOITUONG_ID,IDCHUYEN,CHUNGTUKETOAN,STATUS,TRANSFER_VIENPHI_ID,PHONGBAN_ID,BACSI_ID,TKNO,TKCO,MACHUNGTUREF,LOAICHUNGTUREF,PHIEULINHCANTRU_ID,KHOTHUCHIEN_ID,KHODOIUNG_ID,MENU_LOAIDUOC_ID,NGUOISUDUNGMAY_ID,GOITHAU_ID,XUATTHUOCBANGOAITRU,NGAYGIOCHUNGTU,NOIDAKHAM,HOIDONGKIEMNHAP_ID,HOIDONGTHANHLY_ID,CHUYENCHUNGTUID,CHUYENDOANHTHUID,LYDOXUATSUDUNG_ID,BENHVIEN_ID,NGAYTAO,NGUOITAO_ID,NGAYCAPNHAT,NGUOICAPNHAT_ID)
        values (#MACHUNGTU#,#SOCHUNGTU#,#NGAYCHUNGTU#,'X',#MUCDICHCHUNGTU_ID#,#MUCDICHCHUNGTU_CODE#,#KHOXUAT_ID#,#NGUOIGIAO_ID#,#NGUOIGIAO#,#KHONHAP_ID#,#NGUOINHAN_ID#,#NGUOINHAN#,#NGUOIKIEMTRA_ID#,#NGUOIKIEMTRA#,#NGUOIDUYET_ID#,#NGUOIDUYET#,#PHUONGPHAPXUAT#,#KETOANTRUONG_ID#,#KETOANTRUONG#,#THUKHO_ID#,#THUKHO#,#MAUHOADON#,#SOHOADON#,#SOSERI#,#NGAYHOADON#,#DIENGIAI#,#GIATRI#,#GIATRITHANHTOAN#,#TYLEVAT#,#GIATRIVAT#,#THUESUAT#,#GIATRITHUE#,#TYLECHIETKHAU#,#GIATRICHIETKHAU#,#TIENTE_ID#,#TYGIA#,#SOCHUNGTUGOC#,#NGAYCHUNGTUGOC#,#NHACUNGCAP_ID#,#HINHTHUCTHANHTOAN_ID#,#NGUONDUOC_ID#,#CHUNGTULIENQUAN_ID#,#KHAMBENH_ID#,#TOATHUOCNOITRU_ID#,#TIEPNHAN_ID#,#BENHAN_ID#,#DANHANTHUOC#,#NGUOINHAP_ID#,#NGAYNHAP#,'DXK',#LOAITOATHUOC#,#PHIEULINH_ID#,#DIENGIAINGHIEPVUPHATSINH#,#DONVIGIAO_ID#,#KHOSUDUNG_ID#,#LOAIVATTU_ID#,#BENHNHAN_ID#,#NGOAITRU_TOATHUOC_NGUOIMUA_ID#,#TENBENHNHAN#,#BACSIGIOITHIEU_ID#,#DOITUONG_ID#,#IDCHUYEN#,#CHUNGTUKETOAN#,#STATUS#,#TRANSFER_VIENPHI_ID#,#PHONGBAN_ID#,#BACSI_ID#,#TKNO#,#TKCO#,#MACHUNGTUREF#,#LOAICHUNGTUREF#,#PHIEULINHCANTRU_ID#,#KHOTHUCHIEN_ID#,#KHODOIUNG_ID#,#MENU_LOAIDUOC_ID#,#NGUOISUDUNGMAY_ID#,#GOITHAU_ID#,#XUATTHUOCBANGOAITRU#,#NGAYGIOCHUNGTU#,#NOIDAKHAM#,#HOIDONGKIEMNHAP_ID#,#HOIDONGTHANHLY_ID#,#CHUYENCHUNGTUID#,#CHUYENDOANHTHUID#,#LYDOXUATSUDUNG_ID#,#BENHVIEN_ID#,#NGAYCHUNGTU#,#NGUOITAO_ID#,#NGAYCAPNHAT#,#NGUOICAPNHAT_ID#)
        set @chungtu_id = SCOPE_IDENTITY()

        <!--insert CHUNGTUCHITIET-->
        INSERT INTO TT_DUOC_CHUNGTU_CHITIET
        (CHUNGTU_ID,DUOC_ID,SOLONHAP_ID,SOKIEMSOAT,SOVISA,HANDUNG,DONVITINH_ID
        ,SOLUONGYEUCAU,SOLUONGDAXUAT,THANHTIENVON
        ,DONGIABAN,DONGIAVON,TRANGTHAI,NGUONHANG_ID
        ,TOATHUOCNOITRU_ID,KHAMBENH_VTYT_ID
        ,PHAUTHUAT_VTYT_ID,CLSKETQUA_VTYT_ID,TOATHUOCNGOAITRU_ID
        ,MASTER_ID,BENHNHAN,BENHVIEN_ID,NGAYTAO,NGUOITAO_ID)

        SELECT @chungtu_id, json.DUOC_ID, json.SOLONHAP_ID, json.SOKIEMSOAT, json.SOVISA, json.HANDUNG, json.DONVITINH_ID
        ,json.SOLUONGYEUCAU, json.SOLUONGDAXUAT, json.THANHTIENVON
        ,json.DONGIABAN, json.DONGIAVON, json.TRANGTHAI, json.NGUONHANG_ID
        ,json.TOATHUOCNOITRU_ID, json.KHAMBENH_VTYT_ID
        ,json.PHAUTHUAT_VTYT_ID, json.CLSKETQUA_VTYT_ID, json.TOATHUOCNGOAITRU_ID
        ,json.MASTER_ID, json.BENHNHAN, #BENHVIEN_ID#, getdate(), json.NGUOITAO_ID
        FROM OPENJSON(@jsonChiTiet)
        WITH (
        DUOC_ID int,SOLONHAP_ID int,SOKIEMSOAT varchar(20),SOVISA varchar(20),HANDUNG datetime,DONVITINH_ID int,
        SOLUONGYEUCAU numeric(25, 4),SOLUONGDAXUAT numeric(25, 4),THANHTIENVON numeric(25, 4),
        DONGIABAN numeric(25, 4),DONGIAVON numeric(25, 4),TRANGTHAI varchar(10),NGUONHANG_ID int,
        TOATHUOCNOITRU_ID int,KHAMBENH_VTYT_ID int,
        PHAUTHUAT_VTYT_ID int,CLSKETQUA_VTYT_ID int,TOATHUOCNGOAITRU_ID int,
        MASTER_ID int,BENHNHAN nvarchar(1000), BENHVIEN_ID varchar(10),NGAYTAO datetime,NGUOITAO_ID int
        ) json

        
        if(@type = 'TT_NOITRU_TOATHUOC')<!--PHA35 - update TT_NOITRU_TOATHUOC-->
        BEGIN
        <!--update TT_NOITRU_TOATHUOC-->
        UPDATE TT_NOITRU_TOATHUOC SET CHUNGTU_ID = @chungtu_id, TRANGTHAI = 'DAXUAT', NGAYCAPNHAT = getdate()
        FROM OPENJSON(@jsonChiTiet)
        WITH (MASTER_ID int, TOATHUOCNOITRU_ID int) json
        WHERE TT_NOITRU_TOATHUOC.TOATHUOC_ID = json.TOATHUOCNOITRU_ID and json.TOATHUOCNOITRU_ID is not NULL and json.MASTER_ID = TT_NOITRU_TOATHUOC.KHAMBENH_ID

        <!--release BOOKING NOITRU-->
        UPDATE TT_DUOC_TONKHO_BOOK_NOITRU SET SOLUONG = 0
        FROM OPENJSON(@jsonChiTiet)
        WITH (TOATHUOCNOITRU_ID int) json
        WHERE TT_DUOC_TONKHO_BOOK_NOITRU.REF_ID = json.TOATHUOCNOITRU_ID and json.TOATHUOCNOITRU_ID is not NULL and TT_DUOC_TONKHO_BOOK_NOITRU.REF_TABLE = 'TT_NOITRU_TOATHUOC'
        END
                
        if(@type = 'TT_PHAUTHUAT_VTYT')<!--PHA36 - update TT_PHAUTHUAT_VTYT-->
        BEGIN
        UPDATE TT_PHAUTHUAT_VTYT SET CHUNGTU_ID = @chungtu_id
        FROM OPENJSON(@jsonChiTiet)
        WITH (PHAUTHUAT_VTYT_ID int) json
        WHERE TT_PHAUTHUAT_VTYT.PHAUTHUAT_VTYT_ID = json.PHAUTHUAT_VTYT_ID and json.PHAUTHUAT_VTYT_ID is not NULL
        
        <!--update VIENPHI-->
        UPDATE TT_VIENPHI set DUYET = '1', DATHUCHIEN = '1', NGAYCAPNHAT = getdate()
        FROM OPENJSON(@jsonChiTiet)
        WITH (PHAUTHUAT_VTYT_ID int) json
        WHERE TT_VIENPHI.REF_TABLE = 'TT_PHAUTHUAT_VTYT' and TT_VIENPHI.REF_ID = json.PHAUTHUAT_VTYT_ID and json.PHAUTHUAT_VTYT_ID is not NULL

        <!--release BOOKING NGOAITRU-->
        UPDATE TT_DUOC_TONKHO_BOOK_NGOAITRU SET SOLUONG = 0
        FROM OPENJSON(@jsonChiTiet)
        WITH (PHAUTHUAT_VTYT_ID int) json
        WHERE TT_DUOC_TONKHO_BOOK_NGOAITRU.REF_ID = json.PHAUTHUAT_VTYT_ID and json.PHAUTHUAT_VTYT_ID is not NULL
        and TT_DUOC_TONKHO_BOOK_NGOAITRU.REF_TABLE = 'TT_PHAUTHUAT_VTYT'
        END
        
        if(@type = 'TT_CLSKETQUA_VTYT')<!--PHA37 - update TT_CLSKETQUA_VTYT-->
        BEGIN
        <!--TT_CLSKETQUA_VTYT-->
        UPDATE TT_CLSKETQUA_VTYT SET CHUNGTU_ID = @chungtu_id, TRANGTHAI = 'DAXUAT', NGAYCAPNHAT = getdate()
        FROM OPENJSON(@jsonChiTiet)
        WITH (CLSKETQUA_VTYT_ID int) json
        WHERE TT_CLSKETQUA_VTYT.CLSKETQUA_VTYT_ID = json.CLSKETQUA_VTYT_ID and json.CLSKETQUA_VTYT_ID is not NULL

        UPDATE TT_VIENPHI set DUYET = '1', DATHUCHIEN = '1', NGAYCAPNHAT = getdate()
        FROM OPENJSON(@jsonChiTiet)
        WITH (CLSKETQUA_VTYT_ID int) json
        WHERE TT_VIENPHI.REF_TABLE = 'TT_CLSKETQUA_VTYT' and TT_VIENPHI.REF_ID = json.CLSKETQUA_VTYT_ID and json.CLSKETQUA_VTYT_ID is not NULL

         <!--release BOOKINH NGOAITRU-->
        UPDATE TT_DUOC_TONKHO_BOOK_NGOAITRU SET SOLUONG = 0
        FROM OPENJSON(@jsonChiTiet)
        WITH (CLSKETQUA_VTYT_ID int) json
        WHERE TT_DUOC_TONKHO_BOOK_NGOAITRU.REF_ID = json.CLSKETQUA_VTYT_ID and json.CLSKETQUA_VTYT_ID is not NULL
        and TT_DUOC_TONKHO_BOOK_NGOAITRU.REF_TABLE = 'TT_CLSKETQUA_VTYT'
        END


        SELECT @chungtu_id

        COMMIT TRANSACTION
        END TRY

        BEGIN CATCH
        ROLLBACK TRANSACTION
        DECLARE @ErrorMessage VARCHAR(2000)
        SELECT @ErrorMessage = 'Lỗi: ' + ERROR_MESSAGE()
        RAISERROR(@ErrorMessage, 16, 1)
        END CATCH
      </statement>
      
      <statement id="DAO00030_ThemChungTuXuatToaNgoaiTru" parameterClass="System.Collections.IDictionary" resultClass="System.Int32">
        declare @jsonChiTiet nvarchar(max);
        set @jsonChiTiet = #JSON_DATA#;
        declare @chungtu_id int;

        SET XACT_ABORT ON
        BEGIN TRANSACTION
        BEGIN TRY

        insert into TT_DUOC_CHUNGTU (
        MACHUNGTU,SOCHUNGTU,NGAYCHUNGTU,LOAICHUNGTU,MUCDICHCHUNGTU_ID,MUCDICHCHUNGTU_CODE,KHOXUAT_ID,NGUOIGIAO_ID,NGUOIGIAO,KHONHAP_ID,NGUOINHAN_ID,NGUOINHAN,NGUOIKIEMTRA_ID,NGUOIKIEMTRA,NGUOIDUYET_ID,NGUOIDUYET,PHUONGPHAPXUAT,KETOANTRUONG_ID,KETOANTRUONG,THUKHO_ID,THUKHO,MAUHOADON,SOHOADON,SOSERI,NGAYHOADON,DIENGIAI,GIATRI,GIATRITHANHTOAN,TYLEVAT,GIATRIVAT,THUESUAT,GIATRITHUE,TYLECHIETKHAU,GIATRICHIETKHAU,TIENTE_ID,TYGIA,SOCHUNGTUGOC,NGAYCHUNGTUGOC,NHACUNGCAP_ID,HINHTHUCTHANHTOAN_ID,NGUONDUOC_ID,CHUNGTULIENQUAN_ID,KHAMBENH_ID,TIEPNHAN_ID,BENHAN_ID,DANHANTHUOC,NGUOINHAP_ID,NGAYNHAP,TRANGTHAI,LOAITOATHUOC,PHIEULINH_ID,DIENGIAINGHIEPVUPHATSINH,DONVIGIAO_ID,KHOSUDUNG_ID,LOAIVATTU_ID,BENHNHAN_ID,NGOAITRU_TOATHUOC_NGUOIMUA_ID,TENBENHNHAN,BACSIGIOITHIEU_ID,DOITUONG_ID,IDCHUYEN,CHUNGTUKETOAN,STATUS,TRANSFER_VIENPHI_ID,PHONGBAN_ID,BACSI_ID,TKNO,TKCO,MACHUNGTUREF,LOAICHUNGTUREF,PHIEULINHCANTRU_ID,KHOTHUCHIEN_ID,KHODOIUNG_ID,MENU_LOAIDUOC_ID,NGUOISUDUNGMAY_ID,GOITHAU_ID,XUATTHUOCBANGOAITRU,NGAYGIOCHUNGTU,NOIDAKHAM,HOIDONGKIEMNHAP_ID,HOIDONGTHANHLY_ID,CHUYENCHUNGTUID,CHUYENDOANHTHUID,LYDOXUATSUDUNG_ID,BENHVIEN_ID,NGAYTAO,NGUOITAO_ID,NGAYCAPNHAT,NGUOICAPNHAT_ID)
        values (#MACHUNGTU#,#SOCHUNGTU#,#NGAYCHUNGTU#,'X',#MUCDICHCHUNGTU_ID#,#MUCDICHCHUNGTU_CODE#,#KHOXUAT_ID#,#NGUOIGIAO_ID#,#NGUOIGIAO#,#KHONHAP_ID#,#NGUOINHAN_ID#,#NGUOINHAN#,#NGUOIKIEMTRA_ID#,#NGUOIKIEMTRA#,#NGUOIDUYET_ID#,#NGUOIDUYET#,#PHUONGPHAPXUAT#,#KETOANTRUONG_ID#,#KETOANTRUONG#,#THUKHO_ID#,#THUKHO#,#MAUHOADON#,#SOHOADON#,#SOSERI#,#NGAYHOADON#,#DIENGIAI#,#GIATRI#,#GIATRITHANHTOAN#,#TYLEVAT#,#GIATRIVAT#,#THUESUAT#,#GIATRITHUE#,#TYLECHIETKHAU#,#GIATRICHIETKHAU#,#TIENTE_ID#,#TYGIA#,#SOCHUNGTUGOC#,#NGAYCHUNGTUGOC#,#NHACUNGCAP_ID#,#HINHTHUCTHANHTOAN_ID#,#NGUONDUOC_ID#,#CHUNGTULIENQUAN_ID#,#KHAMBENH_ID#,#TIEPNHAN_ID#,#BENHAN_ID#,#DANHANTHUOC#,#NGUOINHAP_ID#,#NGAYNHAP#,'DXK',#LOAITOATHUOC#,#PHIEULINH_ID#,#DIENGIAINGHIEPVUPHATSINH#,#DONVIGIAO_ID#,#KHOSUDUNG_ID#,#LOAIVATTU_ID#,#BENHNHAN_ID#,#NGOAITRU_TOATHUOC_NGUOIMUA_ID#,#TENBENHNHAN#,#BACSIGIOITHIEU_ID#,#DOITUONG_ID#,#IDCHUYEN#,#CHUNGTUKETOAN#,#STATUS#,#TRANSFER_VIENPHI_ID#,#PHONGBAN_ID#,#BACSI_ID#,#TKNO#,#TKCO#,#MACHUNGTUREF#,#LOAICHUNGTUREF#,#PHIEULINHCANTRU_ID#,#KHOTHUCHIEN_ID#,#KHODOIUNG_ID#,#MENU_LOAIDUOC_ID#,#NGUOISUDUNGMAY_ID#,#GOITHAU_ID#,#XUATTHUOCBANGOAITRU#,#NGAYGIOCHUNGTU#,#NOIDAKHAM#,#HOIDONGKIEMNHAP_ID#,#HOIDONGTHANHLY_ID#,#CHUYENCHUNGTUID#,#CHUYENDOANHTHUID#,#LYDOXUATSUDUNG_ID#,#BENHVIEN_ID#,#NGAYCHUNGTU#,#NGUOITAO_ID#,#NGAYCAPNHAT#,#NGUOICAPNHAT_ID#)
        set @chungtu_id = SCOPE_IDENTITY()

        <!--insert chi tiet-->
        INSERT INTO TT_DUOC_CHUNGTU_CHITIET
        (CHUNGTU_ID,DUOC_ID,SOLONHAP_ID,SOKIEMSOAT,SOVISA,HANDUNG,DONVITINH_ID
        ,SOLUONGYEUCAU,SOLUONGDAXUAT,THANHTIENVON
        ,DONGIABAN,DONGIAVON,TRANGTHAI,NGUONHANG_ID
        ,KHAMBENH_VTYT_ID
        ,PHAUTHUAT_VTYT_ID,CLSKETQUA_VTYT_ID,TOATHUOCNGOAITRU_ID
        ,MASTER_ID,BENHNHAN,BENHVIEN_ID,NGAYTAO,NGUOITAO_ID)
 
        SELECT @chungtu_id, json.DUOC_ID, json.SOLONHAP_ID, json.SOKIEMSOAT, json.SOVISA, json.HANDUNG, json.DONVITINH_ID
        ,json.SOLUONGYEUCAU, json.SOLUONGDAXUAT, json.THANHTIENVON
        ,json.DONGIABAN, json.DONGIAVON, json.TRANGTHAI, json.NGUONHANG_ID
        ,json.KHAMBENH_VTYT_ID
        ,json.PHAUTHUAT_VTYT_ID, json.CLSKETQUA_VTYT_ID, json.TOATHUOCNGOAITRU_ID
        ,json.MASTER_ID, json.BENHNHAN, #BENHVIEN_ID#, getdate(), json.NGUOITAO_ID
        FROM OPENJSON(@jsonChiTiet)
        WITH (
        DUOC_ID int,SOLONHAP_ID int,SOKIEMSOAT varchar(20),SOVISA varchar(20),HANDUNG datetime,DONVITINH_ID int,
        SOLUONGYEUCAU numeric(25, 4),SOLUONGDAXUAT numeric(25, 4),THANHTIENVON numeric(25, 4),
        DONGIABAN numeric(25, 4),DONGIAVON numeric(25, 4),TRANGTHAI varchar(10),NGUONHANG_ID int,
        KHAMBENH_VTYT_ID int,
        PHAUTHUAT_VTYT_ID int,CLSKETQUA_VTYT_ID int,TOATHUOCNGOAITRU_ID int,
        MASTER_ID int,BENHNHAN nvarchar(1000), BENHVIEN_ID varchar(10),NGAYTAO datetime,NGUOITAO_ID int
        ) json

        <!--update TT_NGOAITRU_KHAMBENH_TOATHUOC-->
         UPDATE TT_NGOAITRU_KHAMBENH_TOATHUOC SET CHUNGTUPHATTHUOC_ID = @chungtu_id, TRANGTHAI = 'DAXUAT', DUYET = '1', NGAYCAPNHAT = getdate()
         FROM OPENJSON(@jsonChiTiet)
         WITH (KHAMBENH_TOATHUOC_ID int) json
         WHERE TT_NGOAITRU_KHAMBENH_TOATHUOC.KHAMBENH_TOATHUOC_ID = json.KHAMBENH_TOATHUOC_ID and json.KHAMBENH_TOATHUOC_ID is not NULL

         <!--update TT_VIENPHI-->
         UPDATE TT_VIENPHI SET DATHUCHIEN = '1', NGAYCAPNHAT = getdate()
         FROM OPENJSON(@jsonChiTiet)
         WITH (KHAMBENH_TOATHUOC_ID int) json
         WHERE
         VIENPHI_ID in
         (
         select vp.VIENPHI_ID from TT_VIENPHI vp
         inner join TT_NGOAITRU_TOATHUOC tt on (tt.TOATHUOC_ID = vp.REF_ID and vp.REF_TABLE = 'TT_NGOAITRU_TOATHUOC')
         where
         tt.KHAMBENH_TOATHUOC_ID = json.KHAMBENH_TOATHUOC_ID
         )

         <!--release TT_DUOC_TONKHO_BOOK_NGOAITRU-->
        UPDATE TT_DUOC_TONKHO_BOOK_NGOAITRU SET SOLUONG = 0
        FROM OPENJSON(@jsonChiTiet)
        WITH (TOATHUOCNGOAITRU_ID int) json
        WHERE TT_DUOC_TONKHO_BOOK_NGOAITRU.REF_ID = json.TOATHUOCNGOAITRU_ID and json.TOATHUOCNGOAITRU_ID is not NULL and TT_DUOC_TONKHO_BOOK_NGOAITRU.REF_TABLE = 'TT_NGOAITRU_TOATHUOC'

        select @chungtu_id

        COMMIT TRANSACTION
        END TRY
        
        BEGIN CATCH
        IF @@TRANCOUNT &gt; 0
        ROLLBACK TRANSACTION
        END CATCH
      </statement>
      <statement id="DAO00030_XoaChungTuXuatToaNgoaiTru" parameterClass="System.Collections.IDictionary" resultClass="System.Int32">
        SET XACT_ABORT ON
        BEGIN TRANSACTION
        BEGIN TRY

        <!--VIEN PHI-->
        UPDATE TT_VIENPHI SET DATHUCHIEN = '0', NGAYCAPNHAT = getdate() 
        WHERE
        VIENPHI_ID in
        (
        select vp.VIENPHI_ID from TT_VIENPHI vp
        inner join TT_NGOAITRU_TOATHUOC tt on (tt.TOATHUOC_ID = vp.REF_ID and vp.REF_TABLE = 'TT_NGOAITRU_TOATHUOC')
        where
        tt.KHAMBENH_TOATHUOC_ID = #KHAMBENH_TOATHUOC_ID#
        )
        
        <!--TT_NGOAITRU_KHAMBENH_TOATHUOC-->
        UPDATE TT_NGOAITRU_KHAMBENH_TOATHUOC SET CHUNGTUPHATTHUOC_ID = null, TRANGTHAI = 'CHUAXUAT', DUYET = #DUYET#, NGAYCAPNHAT = getdate()
        WHERE KHAMBENH_TOATHUOC_ID = #KHAMBENH_TOATHUOC_ID#
        
        <!--CHUNG TU-->
        DELETE FROM TT_DUOC_CHUNGTU_CHITIET WHERE CHUNGTU_ID = #CHUNGTU_ID#
        DELETE FROM TT_DUOC_CHUNGTU WHERE CHUNGTU_ID = #CHUNGTU_ID#

        COMMIT TRANSACTION
        END TRY
        BEGIN CATCH
        IF @@TRANCOUNT &gt; 0
        ROLLBACK TRANSACTION
        END CATCH

      </statement>
      <statement id="DAO00030_ThemChungTuXuatToaMuaNgoai" parameterClass="System.Collections.IDictionary" resultClass="System.Int32">
        declare @jsonChiTiet nvarchar(max);
        set @jsonChiTiet = #JSON_DATA#;
        declare @chungtu_id int;

        SET XACT_ABORT ON
        BEGIN TRANSACTION
        BEGIN TRY

        insert into TT_DUOC_CHUNGTU (
        MACHUNGTU,SOCHUNGTU,NGAYCHUNGTU,LOAICHUNGTU,MUCDICHCHUNGTU_ID,MUCDICHCHUNGTU_CODE,KHOXUAT_ID,NGUOIGIAO_ID,NGUOIGIAO,KHONHAP_ID,NGUOINHAN_ID,NGUOINHAN,NGUOIKIEMTRA_ID,NGUOIKIEMTRA,NGUOIDUYET_ID,NGUOIDUYET,PHUONGPHAPXUAT,KETOANTRUONG_ID,KETOANTRUONG,THUKHO_ID,THUKHO,MAUHOADON,SOHOADON,SOSERI,NGAYHOADON,DIENGIAI,GIATRI,GIATRITHANHTOAN,TYLEVAT,GIATRIVAT,THUESUAT,GIATRITHUE,TYLECHIETKHAU,GIATRICHIETKHAU,TIENTE_ID,TYGIA,SOCHUNGTUGOC,NGAYCHUNGTUGOC,NHACUNGCAP_ID,HINHTHUCTHANHTOAN_ID,NGUONDUOC_ID,CHUNGTULIENQUAN_ID,KHAMBENH_ID,TIEPNHAN_ID,BENHAN_ID,DANHANTHUOC,NGUOINHAP_ID,NGAYNHAP,TRANGTHAI,LOAITOATHUOC,PHIEULINH_ID,DIENGIAINGHIEPVUPHATSINH,DONVIGIAO_ID,KHOSUDUNG_ID,LOAIVATTU_ID,BENHNHAN_ID,NGOAITRU_TOATHUOC_NGUOIMUA_ID,TENBENHNHAN,BACSIGIOITHIEU_ID,DOITUONG_ID,IDCHUYEN,CHUNGTUKETOAN,STATUS,TRANSFER_VIENPHI_ID,PHONGBAN_ID,BACSI_ID,TKNO,TKCO,MACHUNGTUREF,LOAICHUNGTUREF,PHIEULINHCANTRU_ID,KHOTHUCHIEN_ID,KHODOIUNG_ID,MENU_LOAIDUOC_ID,NGUOISUDUNGMAY_ID,GOITHAU_ID,XUATTHUOCBANGOAITRU,NGAYGIOCHUNGTU,NOIDAKHAM,HOIDONGKIEMNHAP_ID,HOIDONGTHANHLY_ID,CHUYENCHUNGTUID,CHUYENDOANHTHUID,LYDOXUATSUDUNG_ID,BENHVIEN_ID,NGAYTAO,NGUOITAO_ID,NGAYCAPNHAT,NGUOICAPNHAT_ID)
        values (#MACHUNGTU#,#SOCHUNGTU#,#NGAYCHUNGTU#,'X',#MUCDICHCHUNGTU_ID#,#MUCDICHCHUNGTU_CODE#,#KHOXUAT_ID#,#NGUOIGIAO_ID#,#NGUOIGIAO#,#KHONHAP_ID#,#NGUOINHAN_ID#,#NGUOINHAN#,#NGUOIKIEMTRA_ID#,#NGUOIKIEMTRA#,#NGUOIDUYET_ID#,#NGUOIDUYET#,#PHUONGPHAPXUAT#,#KETOANTRUONG_ID#,#KETOANTRUONG#,#THUKHO_ID#,#THUKHO#,#MAUHOADON#,#SOHOADON#,#SOSERI#,#NGAYHOADON#,#DIENGIAI#,#GIATRI#,#GIATRITHANHTOAN#,#TYLEVAT#,#GIATRIVAT#,#THUESUAT#,#GIATRITHUE#,#TYLECHIETKHAU#,#GIATRICHIETKHAU#,#TIENTE_ID#,#TYGIA#,#SOCHUNGTUGOC#,#NGAYCHUNGTUGOC#,#NHACUNGCAP_ID#,#HINHTHUCTHANHTOAN_ID#,#NGUONDUOC_ID#,#CHUNGTULIENQUAN_ID#,#KHAMBENH_ID#,#TIEPNHAN_ID#,#BENHAN_ID#,#DANHANTHUOC#,#NGUOINHAP_ID#,#NGAYNHAP#,'DXK',#LOAITOATHUOC#,#PHIEULINH_ID#,#DIENGIAINGHIEPVUPHATSINH#,#DONVIGIAO_ID#,#KHOSUDUNG_ID#,#LOAIVATTU_ID#,#BENHNHAN_ID#,#NGOAITRU_TOATHUOC_NGUOIMUA_ID#,#TENBENHNHAN#,#BACSIGIOITHIEU_ID#,#DOITUONG_ID#,#IDCHUYEN#,#CHUNGTUKETOAN#,#STATUS#,#TRANSFER_VIENPHI_ID#,#PHONGBAN_ID#,#BACSI_ID#,#TKNO#,#TKCO#,#MACHUNGTUREF#,#LOAICHUNGTUREF#,#PHIEULINHCANTRU_ID#,#KHOTHUCHIEN_ID#,#KHODOIUNG_ID#,#MENU_LOAIDUOC_ID#,#NGUOISUDUNGMAY_ID#,#GOITHAU_ID#,#XUATTHUOCBANGOAITRU#,#NGAYGIOCHUNGTU#,#NOIDAKHAM#,#HOIDONGKIEMNHAP_ID#,#HOIDONGTHANHLY_ID#,#CHUYENCHUNGTUID#,#CHUYENDOANHTHUID#,#LYDOXUATSUDUNG_ID#,#BENHVIEN_ID#,#NGAYCHUNGTU#,#NGUOITAO_ID#,#NGAYCAPNHAT#,#NGUOICAPNHAT_ID#)
        set @chungtu_id = SCOPE_IDENTITY()

        <!--insert chi tiet-->
        INSERT INTO TT_DUOC_CHUNGTU_CHITIET
        (CHUNGTU_ID,DUOC_ID,SOLONHAP_ID,SOKIEMSOAT,SOVISA,HANDUNG,DONVITINH_ID
        ,SOLUONGYEUCAU,SOLUONGDAXUAT,THANHTIENVON
        ,DONGIABAN,DONGIAVON,TRANGTHAI,NGUONHANG_ID
        ,KHAMBENH_VTYT_ID
        ,PHAUTHUAT_VTYT_ID,CLSKETQUA_VTYT_ID,TOATHUOCNGOAITRU_ID
        ,MASTER_ID,BENHNHAN,BENHVIEN_ID,NGAYTAO,NGUOITAO_ID)
 
        SELECT @chungtu_id, json.DUOC_ID, json.SOLONHAP_ID, json.SOKIEMSOAT, json.SOVISA, json.HANDUNG, json.DONVITINH_ID
        ,json.SOLUONGYEUCAU, json.SOLUONGDAXUAT, json.THANHTIENVON
        ,json.DONGIABAN, json.DONGIAVON, json.TRANGTHAI, json.NGUONHANG_ID
        ,json.KHAMBENH_VTYT_ID
        ,json.PHAUTHUAT_VTYT_ID, json.CLSKETQUA_VTYT_ID, json.TOATHUOCNGOAITRU_ID
        ,json.MASTER_ID, json.BENHNHAN, #BENHVIEN_ID#, getdate(), json.NGUOITAO_ID
        FROM OPENJSON(@jsonChiTiet)
        WITH (
        DUOC_ID int,SOLONHAP_ID int,SOKIEMSOAT varchar(20),SOVISA varchar(20),HANDUNG datetime,DONVITINH_ID int,
        SOLUONGYEUCAU numeric(25, 4),SOLUONGDAXUAT numeric(25, 4),THANHTIENVON numeric(25, 4),
        DONGIABAN numeric(25, 4),DONGIAVON numeric(25, 4),TRANGTHAI varchar(10),NGUONHANG_ID int,
        KHAMBENH_VTYT_ID int,
        PHAUTHUAT_VTYT_ID int,CLSKETQUA_VTYT_ID int,TOATHUOCNGOAITRU_ID int,
        MASTER_ID int,BENHNHAN nvarchar(1000), BENHVIEN_ID varchar(10),NGAYTAO datetime,NGUOITAO_ID int
        ) json

        <!--update TT_NGOAITRU_KHAMBENH_TOATHUOC-->
         UPDATE TT_NGOAITRU_KHAMBENH_TOATHUOC SET CHUNGTUPHATTHUOC_ID = @chungtu_id, TRANGTHAI = 'DAXUAT', DUYET = '1', NGAYCAPNHAT = getdate()
         FROM OPENJSON(@jsonChiTiet)
         WITH (KHAMBENH_TOATHUOC_ID int) json
         WHERE TT_NGOAITRU_KHAMBENH_TOATHUOC.KHAMBENH_TOATHUOC_ID = json.KHAMBENH_TOATHUOC_ID and json.KHAMBENH_TOATHUOC_ID is not NULL         

         <!--release TT_DUOC_TONKHO_BOOK_NGOAITRU-->
        UPDATE TT_DUOC_TONKHO_BOOK_NGOAITRU SET SOLUONG = 0
        FROM OPENJSON(@jsonChiTiet)
        WITH (TOATHUOCNGOAITRU_ID int) json
        WHERE TT_DUOC_TONKHO_BOOK_NGOAITRU.REF_ID = json.TOATHUOCNGOAITRU_ID and json.TOATHUOCNGOAITRU_ID is not NULL and TT_DUOC_TONKHO_BOOK_NGOAITRU.REF_TABLE = 'TT_NGOAITRU_TOATHUOC'

        select @chungtu_id

        COMMIT TRANSACTION
        END TRY
        BEGIN CATCH
        IF @@TRANCOUNT &gt; 0
        ROLLBACK TRANSACTION
        END CATCH
      </statement>
      <statement id="DAO00030_ThemChungTuHoanTra" parameterClass="System.Collections.IDictionary" resultClass="System.Int32">
        declare @jsonChiTiet nvarchar(max);
        set @jsonChiTiet = #JSON_DATA#;
        declare @chungtu_id int;

        SET XACT_ABORT ON
        BEGIN TRANSACTION
        BEGIN TRY

        insert into TT_DUOC_CHUNGTU (
        MACHUNGTU,SOCHUNGTU,NGAYCHUNGTU,LOAICHUNGTU,MUCDICHCHUNGTU_ID,MUCDICHCHUNGTU_CODE,KHOXUAT_ID,NGUOIGIAO_ID,NGUOIGIAO,KHONHAP_ID,NGUOINHAN_ID,NGUOINHAN,NGUOIKIEMTRA_ID,NGUOIKIEMTRA,NGUOIDUYET_ID,NGUOIDUYET,PHUONGPHAPXUAT,KETOANTRUONG_ID,KETOANTRUONG,THUKHO_ID,THUKHO,MAUHOADON,SOHOADON,SOSERI,NGAYHOADON,DIENGIAI,GIATRI,GIATRITHANHTOAN,TYLEVAT,GIATRIVAT,THUESUAT,GIATRITHUE,TYLECHIETKHAU,GIATRICHIETKHAU,TIENTE_ID,TYGIA,SOCHUNGTUGOC,NGAYCHUNGTUGOC,NHACUNGCAP_ID,HINHTHUCTHANHTOAN_ID,NGUONDUOC_ID,CHUNGTULIENQUAN_ID,KHAMBENH_ID,TOATHUOCNOITRU_ID,TIEPNHAN_ID,BENHAN_ID,DANHANTHUOC,NGUOINHAP_ID,NGAYNHAP,TRANGTHAI,LOAITOATHUOC,PHIEULINH_ID,DIENGIAINGHIEPVUPHATSINH,DONVIGIAO_ID,KHOSUDUNG_ID,LOAIVATTU_ID,BENHNHAN_ID,NGOAITRU_TOATHUOC_NGUOIMUA_ID,TENBENHNHAN,BACSIGIOITHIEU_ID,DOITUONG_ID,IDCHUYEN,CHUNGTUKETOAN,STATUS,TRANSFER_VIENPHI_ID,PHONGBAN_ID,BACSI_ID,TKNO,TKCO,MACHUNGTUREF,LOAICHUNGTUREF,PHIEULINHCANTRU_ID,KHOTHUCHIEN_ID,KHODOIUNG_ID,MENU_LOAIDUOC_ID,NGUOISUDUNGMAY_ID,GOITHAU_ID,XUATTHUOCBANGOAITRU,NGAYGIOCHUNGTU,NOIDAKHAM,HOIDONGKIEMNHAP_ID,HOIDONGTHANHLY_ID,CHUYENCHUNGTUID,CHUYENDOANHTHUID,LYDOXUATSUDUNG_ID,BENHVIEN_ID,NGAYTAO,NGUOITAO_ID,NGAYCAPNHAT,NGUOICAPNHAT_ID)
        values (#MACHUNGTU#,#SOCHUNGTU#,#NGAYCHUNGTU#,'X',#MUCDICHCHUNGTU_ID#,#MUCDICHCHUNGTU_CODE#,#KHOXUAT_ID#,#NGUOIGIAO_ID#,#NGUOIGIAO#,#KHONHAP_ID#,#NGUOINHAN_ID#,#NGUOINHAN#,#NGUOIKIEMTRA_ID#,#NGUOIKIEMTRA#,#NGUOIDUYET_ID#,#NGUOIDUYET#,#PHUONGPHAPXUAT#,#KETOANTRUONG_ID#,#KETOANTRUONG#,#THUKHO_ID#,#THUKHO#,#MAUHOADON#,#SOHOADON#,#SOSERI#,#NGAYHOADON#,#DIENGIAI#,#GIATRI#,#GIATRITHANHTOAN#,#TYLEVAT#,#GIATRIVAT#,#THUESUAT#,#GIATRITHUE#,#TYLECHIETKHAU#,#GIATRICHIETKHAU#,#TIENTE_ID#,#TYGIA#,#SOCHUNGTUGOC#,#NGAYCHUNGTUGOC#,#NHACUNGCAP_ID#,#HINHTHUCTHANHTOAN_ID#,#NGUONDUOC_ID#,#CHUNGTULIENQUAN_ID#,#KHAMBENH_ID#,#TOATHUOCNOITRU_ID#,#TIEPNHAN_ID#,#BENHAN_ID#,#DANHANTHUOC#,#NGUOINHAP_ID#,#NGAYNHAP#,'DXK',#LOAITOATHUOC#,#PHIEULINH_ID#,#DIENGIAINGHIEPVUPHATSINH#,#DONVIGIAO_ID#,#KHOSUDUNG_ID#,#LOAIVATTU_ID#,#BENHNHAN_ID#,#NGOAITRU_TOATHUOC_NGUOIMUA_ID#,#TENBENHNHAN#,#BACSIGIOITHIEU_ID#,#DOITUONG_ID#,#IDCHUYEN#,#CHUNGTUKETOAN#,#STATUS#,#TRANSFER_VIENPHI_ID#,#PHONGBAN_ID#,#BACSI_ID#,#TKNO#,#TKCO#,#MACHUNGTUREF#,#LOAICHUNGTUREF#,#PHIEULINHCANTRU_ID#,#KHOTHUCHIEN_ID#,#KHODOIUNG_ID#,#MENU_LOAIDUOC_ID#,#NGUOISUDUNGMAY_ID#,#GOITHAU_ID#,#XUATTHUOCBANGOAITRU#,#NGAYGIOCHUNGTU#,#NOIDAKHAM#,#HOIDONGKIEMNHAP_ID#,#HOIDONGTHANHLY_ID#,#CHUYENCHUNGTUID#,#CHUYENDOANHTHUID#,#LYDOXUATSUDUNG_ID#,#BENHVIEN_ID#,#NGAYCHUNGTU#,#NGUOITAO_ID#,#NGAYCAPNHAT#,#NGUOICAPNHAT_ID#)
        set @chungtu_id = SCOPE_IDENTITY()

        <!--insert chi tiet-->
        INSERT INTO TT_DUOC_CHUNGTU_CHITIET
        (CHUNGTU_ID,DUOC_ID,SOLONHAP_ID,SOKIEMSOAT,SOVISA,HANDUNG,DONVITINH_ID
        ,SOLUONGYEUCAU,SOLUONGDAXUAT,THANHTIENVON
        ,DONGIABAN,DONGIAVON,TRANGTHAI,NGUONHANG_ID
        ,TOATHUOCNOITRU_ID,KHAMBENH_VTYT_ID
        ,PHAUTHUAT_VTYT_ID,CLSKETQUA_VTYT_ID,TOATHUOCNGOAITRU_ID
        ,MASTER_ID,BENHNHAN,BENHVIEN_ID,NGAYTAO,NGUOITAO_ID)

        SELECT @chungtu_id, json.DUOC_ID, json.SOLONHAP_ID, json.SOKIEMSOAT, json.SOVISA, json.HANDUNG, json.DONVITINH_ID
        ,json.SOLUONGYEUCAU, json.SOLUONGDAXUAT, json.THANHTIENVON
        ,json.DONGIABAN, json.DONGIAVON, json.TRANGTHAI, json.NGUONHANG_ID
        ,json.TOATHUOCNOITRU_ID, json.KHAMBENH_VTYT_ID
        ,json.PHAUTHUAT_VTYT_ID, json.CLSKETQUA_VTYT_ID, json.TOATHUOCNGOAITRU_ID
        ,json.MASTER_ID, json.BENHNHAN, #BENHVIEN_ID#, getdate(), json.NGUOITAO_ID
        FROM OPENJSON(@jsonChiTiet)
        WITH (
        DUOC_ID int,SOLONHAP_ID int,SOKIEMSOAT varchar(20),SOVISA varchar(20),HANDUNG datetime,DONVITINH_ID int,
        SOLUONGYEUCAU numeric(25, 4),SOLUONGDAXUAT numeric(25, 4),THANHTIENVON numeric(25, 4),
        DONGIABAN numeric(25, 4),DONGIAVON numeric(25, 4),TRANGTHAI varchar(10),NGUONHANG_ID int,
        TOATHUOCNOITRU_ID int,KHAMBENH_VTYT_ID int,
        PHAUTHUAT_VTYT_ID int,CLSKETQUA_VTYT_ID int,TOATHUOCNGOAITRU_ID int,
        MASTER_ID int,BENHNHAN nvarchar(1000), BENHVIEN_ID varchar(10),NGAYTAO datetime,NGUOITAO_ID int
        ) json

        <!--update TT_NOITRU_TRATHUOC_CHITIET-->
        UPDATE TT_NOITRU_TRATHUOC_CHITIET SET CHUNGTUTRA_ID = @chungtu_id, DAHOANTRA = '1', NGAYCAPNHAT = getdate()
        FROM OPENJSON(@jsonChiTiet)
        WITH (TOATHUOCNOITRU_ID int) json
        WHERE TT_NOITRU_TRATHUOC_CHITIET.TOATHUOC_ID = json.TOATHUOCNOITRU_ID and json.TOATHUOCNOITRU_ID is not NULL

        select @chungtu_id

        COMMIT TRANSACTION
        END TRY
        BEGIN CATCH
        IF @@TRANCOUNT &gt; 0
        ROLLBACK TRANSACTION
        END CATCH
      </statement>
      <statement id="DAO00030_XoaChungTuHoanTra" parameterClass="System.Collections.IDictionary" resultClass="System.Int32">
        SET XACT_ABORT ON
        BEGIN TRANSACTION
        BEGIN TRY
        <!--TT_NOITRU_TRATHUOC_CHITIET-->
        UPDATE TT_NOITRU_TRATHUOC_CHITIET SET CHUNGTUTRA_ID = null, DAHOANTRA = '0', NGAYCAPNHAT = getdate()
        WHERE CHUNGTUTRA_ID = #CHUNGTU_ID#
        
        <!--CHUNG TU-->
        DELETE FROM TT_DUOC_CHUNGTU_CHITIET WHERE CHUNGTU_ID = #CHUNGTU_ID#
        DELETE FROM TT_DUOC_CHUNGTU WHERE CHUNGTU_ID = #CHUNGTU_ID#

        COMMIT TRANSACTION
        END TRY
        BEGIN CATCH
        IF @@TRANCOUNT &gt; 0
        ROLLBACK TRANSACTION
        END CATCH

      </statement>
      <statement id="DAO00030_ThemChungTuHoanTraChiTiet" parameterClass="System.Collections.IDictionary" resultClass="System.Int32">
        declare @jsonChiTiet nvarchar(max);
        set @jsonChiTiet = #JSON_DATA#;

        SET XACT_ABORT ON
        BEGIN TRANSACTION
        BEGIN TRY

        <!--insert chi tiet-->
        INSERT INTO TT_DUOC_CHUNGTU_CHITIET
        (CHUNGTU_ID,DUOC_ID,SOLONHAP_ID,SOKIEMSOAT,SOVISA,HANDUNG,DONVITINH_ID
        ,SOLUONGYEUCAU,SOLUONGDAXUAT,THANHTIENVON
        ,DONGIABAN,DONGIAVON,TRANGTHAI,NGUONHANG_ID
        ,TOATHUOCNOITRU_ID,KHAMBENH_VTYT_ID
        ,PHAUTHUAT_VTYT_ID,CLSKETQUA_VTYT_ID,TOATHUOCNGOAITRU_ID
        ,MASTER_ID,BENHNHAN,BENHVIEN_ID,NGAYTAO,NGUOITAO_ID)

        SELECT #CHUNGTU_ID#, json.DUOC_ID, json.SOLONHAP_ID, json.SOKIEMSOAT, json.SOVISA, json.HANDUNG, json.DONVITINH_ID
        ,json.SOLUONGYEUCAU, json.SOLUONGDAXUAT, json.THANHTIENVON
        ,json.DONGIABAN, json.DONGIAVON, json.TRANGTHAI, json.NGUONHANG_ID
        ,json.TOATHUOCNOITRU_ID, json.KHAMBENH_VTYT_ID
        ,json.PHAUTHUAT_VTYT_ID, json.CLSKETQUA_VTYT_ID, json.TOATHUOCNGOAITRU_ID
        ,json.MASTER_ID, json.BENHNHAN, #BENHVIEN_ID#, getdate(), json.NGUOITAO_ID
        FROM OPENJSON(@jsonChiTiet)
        WITH (
        CHUNGTU_ID int, DUOC_ID int,SOLONHAP_ID int,SOKIEMSOAT varchar(20),SOVISA varchar(20),HANDUNG datetime,DONVITINH_ID int,
        SOLUONGYEUCAU numeric(25, 4),SOLUONGDAXUAT numeric(25, 4),THANHTIENVON numeric(25, 4),
        DONGIABAN numeric(25, 4),DONGIAVON numeric(25, 4),TRANGTHAI varchar(10),NGUONHANG_ID int,
        TOATHUOCNOITRU_ID int,KHAMBENH_VTYT_ID int,
        PHAUTHUAT_VTYT_ID int,CLSKETQUA_VTYT_ID int,TOATHUOCNGOAITRU_ID int,
        MASTER_ID int,BENHNHAN nvarchar(1000), BENHVIEN_ID varchar(10),NGAYTAO datetime,NGUOITAO_ID int
        ) json

        <!--update TT_NOITRU_TRATHUOC_CHITIET-->
        UPDATE TT_NOITRU_TRATHUOC_CHITIET SET CHUNGTUTRA_ID = json.CHUNGTU_ID, DAHOANTRA = '1', NGAYCAPNHAT = getdate()
        FROM OPENJSON(@jsonChiTiet)
        WITH (TOATHUOCNOITRU_ID int, CHUNGTU_ID int) json
        WHERE TT_NOITRU_TRATHUOC_CHITIET.TOATHUOC_ID = json.TOATHUOCNOITRU_ID and json.TOATHUOCNOITRU_ID is not NULL

        COMMIT TRANSACTION
        END TRY
        BEGIN CATCH
        IF @@TRANCOUNT &gt; 0
        ROLLBACK TRANSACTION
        END CATCH        
      </statement>      
      <statement id="DAO00030_XoaChungTuHoanTraChiTiet" parameterClass="System.Collections.IDictionary" resultClass="System.Int32">
        SET XACT_ABORT ON
        BEGIN TRANSACTION
        BEGIN TRY

        <!--TT_NOITRU_TRATHUOC_CHITIET-->
        UPDATE TT_NOITRU_TRATHUOC_CHITIET SET CHUNGTUTRA_ID = null, DAHOANTRA = '0', NGAYCAPNHAT = getdate()
        WHERE CHUNGTUTRA_ID = #CHUNGTU_ID#
        <!--CHUNG TU-->
        DELETE FROM TT_DUOC_CHUNGTU_CHITIET WHERE CHUNGTU_ID = #CHUNGTU_ID#

        COMMIT TRANSACTION
        END TRY
        BEGIN CATCH
        IF @@TRANCOUNT &gt; 0
        ROLLBACK TRANSACTION
        END CATCH        
      </statement>
      <statement id="DAO00030_ThemChungTuNhanHoanTra" parameterClass="System.Collections.IDictionary" resultClass="System.Int32">
        declare @jsonChiTiet nvarchar(max);
        set @jsonChiTiet = #JSON_DATA#;
        declare @chungtu_id int;

        SET XACT_ABORT ON
        BEGIN TRANSACTION
        BEGIN TRY

        <!--insert chung tu-->
        insert into TT_DUOC_CHUNGTU (
        MACHUNGTU,SOCHUNGTU,NGAYCHUNGTU,LOAICHUNGTU,MUCDICHCHUNGTU_ID,MUCDICHCHUNGTU_CODE,KHOXUAT_ID,NGUOIGIAO_ID,NGUOIGIAO,KHONHAP_ID,NGUOINHAN_ID,NGUOINHAN,NGUOIKIEMTRA_ID,NGUOIKIEMTRA,NGUOIDUYET_ID,NGUOIDUYET,PHUONGPHAPXUAT,KETOANTRUONG_ID,KETOANTRUONG,THUKHO_ID,THUKHO,MAUHOADON,SOHOADON,SOSERI,NGAYHOADON,DIENGIAI,GIATRI,GIATRITHANHTOAN,TYLEVAT,GIATRIVAT,THUESUAT,GIATRITHUE,TYLECHIETKHAU,GIATRICHIETKHAU,TIENTE_ID,TYGIA,SOCHUNGTUGOC,NGAYCHUNGTUGOC,NHACUNGCAP_ID,HINHTHUCTHANHTOAN_ID,NGUONDUOC_ID,CHUNGTULIENQUAN_ID,KHAMBENH_ID,TOATHUOCNOITRU_ID,TIEPNHAN_ID,BENHAN_ID,DANHANTHUOC,NGUOINHAP_ID,NGAYNHAP,TRANGTHAI,LOAITOATHUOC,PHIEULINH_ID,DIENGIAINGHIEPVUPHATSINH,DONVIGIAO_ID,KHOSUDUNG_ID,LOAIVATTU_ID,BENHNHAN_ID,NGOAITRU_TOATHUOC_NGUOIMUA_ID,TENBENHNHAN,BACSIGIOITHIEU_ID,DOITUONG_ID,IDCHUYEN,CHUNGTUKETOAN,STATUS,TRANSFER_VIENPHI_ID,PHONGBAN_ID,BACSI_ID,TKNO,TKCO,MACHUNGTUREF,LOAICHUNGTUREF,PHIEULINHCANTRU_ID,KHOTHUCHIEN_ID,KHODOIUNG_ID,MENU_LOAIDUOC_ID,NGUOISUDUNGMAY_ID,GOITHAU_ID,XUATTHUOCBANGOAITRU,NGAYGIOCHUNGTU,NOIDAKHAM,HOIDONGKIEMNHAP_ID,HOIDONGTHANHLY_ID,CHUYENCHUNGTUID,CHUYENDOANHTHUID,LYDOXUATSUDUNG_ID,BENHVIEN_ID,NGAYTAO,NGUOITAO_ID,NGAYCAPNHAT,NGUOICAPNHAT_ID)
        values (#MACHUNGTU#,#SOCHUNGTU#,#NGAYCHUNGTU#,'N',#MUCDICHCHUNGTU_ID#,#MUCDICHCHUNGTU_CODE#,#KHOXUAT_ID#,#NGUOIGIAO_ID#,#NGUOIGIAO#,#KHONHAP_ID#,#NGUOINHAN_ID#,#NGUOINHAN#,#NGUOIKIEMTRA_ID#,#NGUOIKIEMTRA#,#NGUOIDUYET_ID#,#NGUOIDUYET#,#PHUONGPHAPXUAT#,#KETOANTRUONG_ID#,#KETOANTRUONG#,#THUKHO_ID#,#THUKHO#,#MAUHOADON#,#SOHOADON#,#SOSERI#,#NGAYHOADON#,#DIENGIAI#,#GIATRI#,#GIATRITHANHTOAN#,#TYLEVAT#,#GIATRIVAT#,#THUESUAT#,#GIATRITHUE#,#TYLECHIETKHAU#,#GIATRICHIETKHAU#,#TIENTE_ID#,#TYGIA#,#SOCHUNGTUGOC#,#NGAYCHUNGTUGOC#,#NHACUNGCAP_ID#,#HINHTHUCTHANHTOAN_ID#,#NGUONDUOC_ID#,#CHUNGTULIENQUAN_ID#,#KHAMBENH_ID#,#TOATHUOCNOITRU_ID#,#TIEPNHAN_ID#,#BENHAN_ID#,#DANHANTHUOC#,#NGUOINHAP_ID#,#NGAYNHAP#,'DNK',#LOAITOATHUOC#,#PHIEULINH_ID#,#DIENGIAINGHIEPVUPHATSINH#,#DONVIGIAO_ID#,#KHOSUDUNG_ID#,#LOAIVATTU_ID#,#BENHNHAN_ID#,#NGOAITRU_TOATHUOC_NGUOIMUA_ID#,#TENBENHNHAN#,#BACSIGIOITHIEU_ID#,#DOITUONG_ID#,#IDCHUYEN#,#CHUNGTUKETOAN#,#STATUS#,#TRANSFER_VIENPHI_ID#,#PHONGBAN_ID#,#BACSI_ID#,#TKNO#,#TKCO#,#MACHUNGTUREF#,#LOAICHUNGTUREF#,#PHIEULINHCANTRU_ID#,#KHOTHUCHIEN_ID#,#KHODOIUNG_ID#,#MENU_LOAIDUOC_ID#,#NGUOISUDUNGMAY_ID#,#GOITHAU_ID#,#XUATTHUOCBANGOAITRU#,#NGAYGIOCHUNGTU#,#NOIDAKHAM#,#HOIDONGKIEMNHAP_ID#,#HOIDONGTHANHLY_ID#,#CHUYENCHUNGTUID#,#CHUYENDOANHTHUID#,#LYDOXUATSUDUNG_ID#,#BENHVIEN_ID#,#NGAYCHUNGTU#,#NGUOITAO_ID#,#NGAYCAPNHAT#,#NGUOICAPNHAT_ID#)
        set @chungtu_id = SCOPE_IDENTITY()

        <!--insert chung tu chi tiet-->
        INSERT INTO TT_DUOC_CHUNGTU_CHITIET
        (CHUNGTU_ID,DUOC_ID,SOLONHAP_ID,SOKIEMSOAT,SOVISA,HANDUNG,DONVITINH_ID
        ,SOLUONGYEUCAU,SOLUONGTHUCTE, SOLUONGDAXUAT,THANHTIENVON
        ,DONGIABAN,DONGIAVON,TRANGTHAI,NGUONHANG_ID
        ,TOATHUOCNOITRU_ID,KHAMBENH_VTYT_ID
        ,PHAUTHUAT_VTYT_ID,CLSKETQUA_VTYT_ID,TOATHUOCNGOAITRU_ID
        ,MASTER_ID,BENHNHAN,BENHVIEN_ID,NGAYTAO,NGUOITAO_ID)

        SELECT @chungtu_id, json.DUOC_ID, json.SOLONHAP_ID, json.SOKIEMSOAT, json.SOVISA, json.HANDUNG, json.DONVITINH_ID
        ,json.SOLUONGYEUCAU, json.SOLUONGTHUCTE, json.SOLUONGDAXUAT, json.THANHTIENVON
        ,json.DONGIABAN, json.DONGIAVON, json.TRANGTHAI, json.NGUONHANG_ID
        ,json.TOATHUOCNOITRU_ID, json.KHAMBENH_VTYT_ID
        ,json.PHAUTHUAT_VTYT_ID, json.CLSKETQUA_VTYT_ID, json.TOATHUOCNGOAITRU_ID
        ,json.MASTER_ID, json.BENHNHAN, #BENHVIEN_ID#, getdate(), json.NGUOITAO_ID
        FROM OPENJSON(@jsonChiTiet)
        WITH (
        DUOC_ID int,SOLONHAP_ID int,SOKIEMSOAT varchar(20),SOVISA varchar(20),HANDUNG datetime,DONVITINH_ID int,
        SOLUONGYEUCAU numeric(25, 4),SOLUONGTHUCTE numeric(25, 4), SOLUONGDAXUAT numeric(25, 4),THANHTIENVON numeric(25, 4),
        DONGIABAN numeric(25, 4),DONGIAVON numeric(25, 4),TRANGTHAI varchar(10),NGUONHANG_ID int,
        TOATHUOCNOITRU_ID int,KHAMBENH_VTYT_ID int,
        PHAUTHUAT_VTYT_ID int,CLSKETQUA_VTYT_ID int,TOATHUOCNGOAITRU_ID int,
        MASTER_ID int,BENHNHAN nvarchar(1000), BENHVIEN_ID varchar(10),NGAYTAO datetime,NGUOITAO_ID int
        ) json

        <!--update CHUNGTU liên quan hoàn trả-->
        UPDATE TT_DUOC_CHUNGTU SET CHUNGTULIENQUAN_ID = @chungtu_id, DANHANTHUOC = '1', NGAYCAPNHAT = getdate()
        WHERE
        MACHUNGTU = '$SOCHUNGTUGOC$'

        select @chungtu_id

        COMMIT TRANSACTION
        END TRY
        BEGIN CATCH
        IF @@TRANCOUNT &gt; 0
        ROLLBACK TRANSACTION
        END CATCH
      </statement>
      <statement id="DAO00030_XoaChungTuNhanHoanTra" parameterClass="System.Collections.IDictionary" resultClass="System.Int32">
        SET XACT_ABORT ON
        BEGIN TRANSACTION
        BEGIN TRY
        <!--update trangthai chung tu xuat hoan tra-->
        UPDATE TT_DUOC_CHUNGTU SET CHUNGTULIENQUAN_ID = NULL, DANHANTHUOC = '0', NGAYCAPNHAT = getdate()
        WHERE
        MACHUNGTU = '$SOCHUNGTUGOC$'

        <!--xoa chung tu nhan hoan tra-->
        DELETE FROM TT_DUOC_CHUNGTU_CHITIET WHERE CHUNGTU_ID = #CHUNGTU_ID#
        DELETE FROM TT_DUOC_CHUNGTU WHERE CHUNGTU_ID = #CHUNGTU_ID#

        COMMIT TRANSACTION
        END TRY
        BEGIN CATCH
        IF @@TRANCOUNT &gt; 0
        ROLLBACK TRANSACTION
        END CATCH        
      </statement>
      <statement id="DAO00030_GetChanDoan_BacSiKeDon" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
        declare @BACSIKEDON nvarchar(1000), @CHANDOAN nvarchar(2000)

        select @BACSIKEDON = COALESCE(@BACSIKEDON + ' ,' + BACSIKEDON, BACSIKEDON)
        , @CHANDOAN = COALESCE(@CHANDOAN +' ,' + CHANDOAN, CHANDOAN)
        from (
        select NV.TENNHANVIEN AS BACSIKEDON, KB.CHANDOANKHOAKHAM AS CHANDOAN
        from TT_NGOAITRU_KHAMBENH KB
        left join TT_NGOAITRU_KHAMBENH_TOATHUOC TT on TT.KHAMBENH_ID = KB.KHAMBENH_ID and TT.BENHVIEN_ID = KB.BENHVIEN_ID
        left join TM_NHANVIEN NV on NV.NHANVIEN_ID = TT.BACSI_ID and TT.BENHVIEN_ID = NV.BENHVIEN_ID
        where TT.LOAITOATHUOC = 'MN'
        and KB.TIEPNHAN_ID = $TIEPNHAN_ID$
        and KB.BENHVIEN_ID = '$BENHVIEN_ID$'
        union all
        select NV.TENNHANVIEN AS BACSIKEDON, BA.CHANDOANRAVIEN AS CHANDOAN
        from TT_NOITRU_BENHAN BA
        left join TT_NOITRU_KHAMBENH KB on KB.BENHAN_ID = BA.BENHAN_ID and KB.BENHVIEN_ID = BA.BENHVIEN_ID
        left join TT_NOITRU_TOATHUOC TT on TT.KHAMBENH_ID = KB.KHAMBENH_ID and TT.BENHVIEN_ID = KB.BENHVIEN_ID
        left join TM_NHANVIEN NV on NV.NHANVIEN_ID = KB.BACSIKHAM_ID and NV.BENHVIEN_ID = KB.BENHVIEN_ID
        where KB.RAVIEN = 1
        and BA.TIEPNHAN_ID = $TIEPNHAN_ID$
        and BA.BENHVIEN_ID = '$BENHVIEN_ID$'
        ) temp
        select @BACSIKEDON AS BACSIKEDON, @CHANDOAN AS CHANDOAN
      </statement>
      <statement id="DAO00030_GetChanDoan_BacSiKeDon_NguoiMua" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
        select *
        from TT_NGOAITRU_TOATHUOC_NGUOIMUA
        where NGOAITRU_TOATHUOC_NGUOIMUA_ID = $NGOAITRU_TOATHUOC_NGUOIMUA_ID$
      </statement>
      <update id="DAO00030_Upd_null_ChungTuLienQuanID" parameterClass="System.Collections.IDictionary">
        update TT_DUOC_CHUNGTU set CHUNGTULIENQUAN_ID = null,DANHANTHUOC=0, NGAYCAPNHAT = getdate()
        where CHUNGTULIENQUAN_ID = '$CHUNGTULIENQUAN_ID$'
      </update>
      <statement id="DAO00030_GetDuocTonKhoAll" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
        select AA.DUOC_ID, SUM(BB.SOLUONG) AS SOLUONG
        from TM_DUOC AA inner join TT_DUOC_TONKHO BB ON AA.DUOC_ID=BB.DUOC_ID AND AA.BENHVIEN_ID = BB.BENHVIEN_ID
        where AA.BENHVIEN_ID = '$BENHVIEN_ID$' AND BB.KHODUOC_ID='$KHODUOC_ID$'
        GROUP BY AA.DUOC_ID
      </statement>
      <statement id="DAO00030_GetPhieuLinh_TonKho" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
        SELECT (CASE WHEN PL.REF_TABLE='TT_DUOC_CHUNGTU' THEN NULL ELSE PL.TOATHUOCNOITRU_ID END) AS TOATHUOCNOITRU_ID,
        pl.CHUNGTU_ID, PL.DUOC_ID, PL.TENDUOCDAYDU, PL.KHOXUAT_ID, PL.NGUONHANG, TK.DONVITINH, TK.DONVITINH_ID,PL.SOLUONGDAXUAT, PL.SO_QDTT,PL.SOLUONGYEUCAU, PL.LIST_YLENH
        ,PL.BENHNHAN, PL.NGUONHANG_ID, PL.MASTER_ID,PL.YLENH, PL.THANHTIENMUA,PL.TENBENHNHAN
        ,XX.SOLUONGXUAT, isnull(TK.TONGTON,0) TONGTON,(CASE WHEN XX.SOLUONGXUAT>TK.TONGTON THEN '1' ELSE '0' END) AS HIGHLIGHT,
        (CASE WHEN '#TONGHOP#'='0' THEN 'TT_DUOC_PHIEULINH' ELSE PL.REF_TABLE END) AS REF_TABLE,
        (CASE WHEN '#TONGHOP#'='0' THEN PL.CHUNGTU_ID ELSE PL.TOATHUOCNOITRU_ID END) AS REF_ID,
        (CASE WHEN PL.REF_TABLE='TT_DUOC_CHUNGTU' THEN PL.TOATHUOCNOITRU_ID ELSE NULL END) AS CHUNGTUCHITIET_LIENQUAN_ID,
        (CASE WHEN LEN(PL.BENHNHAN)>8 THEN SUBSTRING(PL.BENHNHAN,LEN(PL.BENHNHAN)-8,LEN(PL.BENHNHAN)-(LEN(PL.BENHNHAN)-8)) ELSE NULL END) AS  BENHNHAN_SHORTNAME,
        LTRIM(TK.KHODUOC_ID) + '_' + LTRIM(TK.DUOC_ID) + '_' + LTRIM(TK.NGUONDUOC_ID) as DUOC_KEY

        FROM (
        SELECT pl.CHUNGTU_ID, plct.DUOC_ID, d.TENDUOCDAYDU, PL.KHOXUAT_ID, nh.TENNGUONDUOC AS NGUONHANG, dvt.TENDONVITINH AS DONVITINH,
        plct.SOLUONGYEUCAU AS SOLUONGDAXUAT, D.SO_QDTT,plct.SOLUONGYEUCAU,plct.TOATHUOCNOITRU_ID, plct.REF_TABLE, plct.YLENH AS LIST_YLENH
        ,plct.BENHNHAN, plct.NGUONHANG_ID, plct.MASTER_ID,'' AS YLENH, 0 AS THANHTIENMUA, plct.TENBENHNHAN
        FROM
        TT_DUOC_PHIEULINH_CHITIET plct
        inner join TT_DUOC_PHIEULINH pl on pl.CHUNGTU_ID = plct.CHUNGTU_ID
        inner join TM_DUOC d on d.DUOC_ID = plct.DUOC_ID
        left join dbo.TM_NGUONHANG nh on nh.NGUONDUOC_ID = plct.NGUONHANG_ID
        left join dbo.TM_DONVITINH dvt on dvt.DONVITINH_ID = plct.DONVITINH_ID
        WHERE pl.CHUNGTU_ID = '$CHUNGTU_ID$'
        )PL
        LEFT JOIN
        (SELECT tk.DUOC_ID, d.TENDUOCDAYDU, TK.KHODUOC_ID, SUM(SOLUONG) AS TONGTON,D.DONVITINH_ID,D.DONVITINH,TK.NGUONDUOC_ID
        FROM TT_DUOC_TONKHO TK inner join TM_DUOC D on D.DUOC_ID = tk.DUOC_ID
        GROUP BY TK.DUOC_ID, d.TENDUOCDAYDU, KHODUOC_ID,D.DONVITINH_ID,D.DONVITINH,TK.NGUONDUOC_ID
        HAVING SUM(SOLUONG) > 0
        )TK ON PL.KHOXUAT_ID = TK.KHODUOC_ID AND PL.DUOC_ID = TK.DUOC_ID
        LEFT JOIN
        (SELECT PLCT.DUOC_ID, PL.KHOXUAT_ID,SUM(plct.SOLUONGYEUCAU) AS SOLUONGXUAT
        FROM TT_DUOC_PHIEULINH PL
        inner join TT_DUOC_PHIEULINH_CHITIET PLCT on PL.CHUNGTU_ID = PLCT.CHUNGTU_ID AND PL.CHUNGTU_ID = #CHUNGTU_ID#
        WHERE PLCT.BENHVIEN_ID='#BENHVIEN_ID#' GROUP BY PLCT.DUOC_ID, PL.KHOXUAT_ID
        ) XX ON PL.KHOXUAT_ID = XX.KHOXUAT_ID AND PL.DUOC_ID = XX.DUOC_ID
      </statement>
      <statement id="DAO00030_GetTonKhoTheoKhoDuocID" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
        SELECT SLN.SOLONHAP_ID, SLN.SOLONHAP, SLN.SOLOSANPHAM, SLN.SOKIEMSOAT, SLN.SOVISA, CONVERT(varchar(20), SLN.SOLOSANPHAM) + '/' + CONVERT(varchar(20), TK.SOLUONG) AS SOLOSOTON,
        SLN.NGAYNHAP AS NGAYNHAPLO, SLN.HANDUNG AS HANSUDUNG,  SLN.HANDUNG, SLN.NGUONDUOC_ID, SLN.NGUONDUOC_ID as NGUONHANG_ID,SLNGB.DONGIAMUA, SLNGB.DONGIAVON,
        SLNGB.TYLEVAT_DAUVAO as TYLEVAT, d.TYLE_VAT, SLNGB.DONGIAVONVAT, SLNGB.DONGIABAN, SLNGB.DONGIABANVAT_DAUVAO as DONGIABAN_VAT,TK.DUOCTONKHO_ID, TK.KHODUOC_ID, TK.DUOC_ID,
        TK.SOLUONG, TK.SOLUONG AS SOLUONGTON,D.TENDUOCDAYDU,D.DONVITINH_ID, D.DONVITINH, D.BHYT, NH.TENNGUONDUOC AS NGUONHANG,
        LTRIM(TK.KHODUOC_ID) + '_' + LTRIM(TK.DUOC_ID) + '_' + LTRIM(TK.NGUONDUOC_ID) as DUOC_KEY, D.SO_QDTT
        FROM TT_DUOC_CHUNGTU_SOLONHAP SLN
        JOIN TT_DUOC_TONKHO TK ON SLN.SOLONHAP_ID = TK.SOLONHAP_ID AND TK.KHODUOC_ID = #KHODUOC_ID# AND  TK.SOLUONG > 0
        JOIN TT_DUOC_SOLONHAP_GIABAN SLNGB ON SLNGB.SOLONHAP_ID = SLN.SOLONHAP_ID
        JOIN TM_DUOC D ON SLN.DUOC_ID = D.DUOC_ID
        LEFT JOIN TM_NGUONHANG NH ON NH.NGUONDUOC_ID = SLN.NGUONDUOC_ID
        WHERE SLN.BENHVIEN_ID ='$BENHVIEN_ID$'
        <!--ORDER BY NGAYNHAP-->
      </statement>
      <statement id="DAO00030_XUATSUDUNG_CHECK" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
        select *
        from TT_DUOC_CHUNGTU_CHITIET
        where
        MASTER_ID = #KHAMBENH_ID#
        and TOATHUOCNOITRU_ID is not null
      </statement>
      <statement id="DAO00030_GetList_DuocCanhBao" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
        select TM_DUOC_CANHBAO_ICD.DUOCCANHBAO_ID, TM_DUOC_CANHBAO_ICD.HOATCHAT_ID, TM_DUOC_CANHBAO_ICD.MAHOATCHAT, HC.TENHOATCHAT
        , TM_DUOC_CANHBAO_ICD.ICD_ID, TM_DUOC_CANHBAO_ICD.MAICD, ICD.TENICD, TM_DUOC_CANHBAO_ICD.NOIDUNGCANHBAO
        , TM_DUOC_CANHBAO_ICD.GHICHU, CAST(TM_DUOC_CANHBAO_ICD.TAMNGUNG AS BIT) AS TAMNGUNG
        from TM_DUOC_CANHBAO_ICD
        left join TM_DUOC_HOATCHAT HC on HC.HOATCHAT_ID = TM_DUOC_CANHBAO_ICD.HOATCHAT_ID
        left join TM_ICD ICD on ICD.ICD_ID = TM_DUOC_CANHBAO_ICD.ICD_ID
        where TM_DUOC_CANHBAO_ICD.BENHVIEN_ID = '$BENHVIEN_ID$'
        <isNotEmpty prepend="and" property="HOATCHAT_ID">
          TM_DUOC_CANHBAO_ICD.HOATCHAT_ID = $HOATCHAT_ID$
        </isNotEmpty>
        <isNotEmpty prepend="and" property="ICD_ID">
          TM_DUOC_CANHBAO_ICD.ICD_ID = $ICD_ID$
        </isNotEmpty>
        order by TM_DUOC_CANHBAO_ICD.MAHOATCHAT, TM_DUOC_CANHBAO_ICD.MAICD, TM_DUOC_CANHBAO_ICD.NOIDUNGCANHBAO
      </statement>
      <statement id="DAO00030_Delete_DuocCanhBao" parameterClass="System.String" resultClass="System.Int32">
        delete from TM_DUOC_CANHBAO_ICD
        where DUOCCANHBAO_ID IN ($LST_DUOCCANHBAO_ID$) and BENHVIEN_ID = '$BENHVIEN_ID$'
      </statement>
      <update id="DAO00030_Update_DuocCanhBao" parameterClass="HashTable">
        update TM_DUOC_CANHBAO_ICD set
        HOATCHAT_ID = #HOATCHAT_ID#
        , MAHOATCHAT = #MAHOATCHAT#
        , ICD_ID = #ICD_ID#
        , MAICD = #MAICD#
        , NOIDUNGCANHBAO = #NOIDUNGCANHBAO#
        , GHICHU = #GHICHU#
        , TAMNGUNG = #TAMNGUNG#
        , NGAYCAPNHAT = #NGAYCAPNHAT#
        , NGUOICAPNHAT = #NGUOICAPNHAT#
        where
        DUOCCANHBAO_ID = $DUOCCANHBAO_ID$
      </update>
      <statement id="DAO00030_Insert_DuocCanhBao" parameterClass="DataObject" resultClass="DataObject">
        INSERT INTO TM_DUOC_CANHBAO_ICD (HOATCHAT_ID, MAHOATCHAT, ICD_ID, MAICD, NOIDUNGCANHBAO, GHICHU, TAMNGUNG, BENHVIEN_ID, NGAYTAO, NGUOITAO)
        VALUES (#HOATCHAT_ID#, #MAHOATCHAT#, #ICD_ID#, #MAICD#, #NOIDUNGCANHBAO#, #GHICHU#, #TAMNGUNG#, #BENHVIEN_ID#, #NGAYTAO#, #NGUOITAO#)

        SELECT SCOPE_IDENTITY()
      </statement>
      <statement id="DAO00030_Get_DuocCanhBaoICD_ByBenhAn_ID" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
        select A.*
        from TM_DUOC_CANHBAO_ICD A
        inner join TM_DUOC_HOATCHAT B on B.HOATCHAT_ID = A.HOATCHAT_ID
        inner join TM_DUOC_THANHPHANHOATCHAT C on C.HOATCHAT_ID = B.HOATCHAT_ID
        inner join TM_DUOC D on D.DUOC_ID = C.DUOC_ID
        inner join TT_NOITRU_BENHAN BA on (BA.ICD_VAOKHOA = A.ICD_ID or BA.ICD_KHAMBENH = A.ICD_ID or BA.ICD_BENHCHINH = A.ICD_ID or BA.ICDRAVIEN_CHINH = A.ICD_ID
        or A.MAICD in (select part from fnSplit(BA.ICD_BENHPHU, ';')) 
        or A.MAICD in (select part from fnSplit(BA.ICDRAVIEN_PHU, ';'))
        or A.MAICD in (select part from fnSplit(BA.ICD_PHU_VAOKHOA, ';'))) and BA.BENHAN_ID = $BENHAN_ID$
        where C.DUOC_ID = $DUOC_ID$
        and A.TAMNGUNG = '0'
        and A.BENHVIEN_ID = '$BENHVIEN_ID$'
      </statement>
      <statement id="DAO00030_Get_DuocCanhBaoICD_ByMAICD" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
        select A.*
        from TM_DUOC_CANHBAO_ICD A
        inner join TM_DUOC_HOATCHAT B on B.HOATCHAT_ID = A.HOATCHAT_ID
        inner join TM_DUOC_THANHPHANHOATCHAT C on C.HOATCHAT_ID = B.HOATCHAT_ID
        inner join TM_DUOC D on D.DUOC_ID = C.DUOC_ID
        where C.DUOC_ID = $DUOC_ID$
        and A.TAMNGUNG = '0'
        and A.BENHVIEN_ID = '$BENHVIEN_ID$'
        and A.MAICD in (select part from fnSplit('$LST_MAICD$', ';'))
      </statement>
      <statement id="DAO00030_KiemTraTonTaiToaThuocChuaXuat" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
        select KHAMBENH_TOATHUOC_ID from TT_NGOAITRU_KHAMBENH_TOATHUOC
        where
        TRANGTHAI != 'DAXUAT'
        and KHAMBENH_ID IN (SELECT KHAMBENH_ID FROM TT_NGOAITRU_KHAMBENH_TOATHUOC WHERE KHAMBENH_TOATHUOC_ID = $KHAMBENH_TOATHUOC_ID$)
      </statement>
      <statement id="DAO00030_GetListDuocHetHan" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
        SELECT
        D.MADUOC,
        D.TENHANG,
        NH.TENNGUONDUOC,
        SLN.SOLONHAP,
        SLN.SOLOSANPHAM,
        SLN.SOKIEMSOAT,
        SLN.HANDUNG,
        D.GIATHAU,
        SLNGB.DONGIAMUA,
        SLNGB.DONGIAVON,
        SLNGB.DONGIABAN,
        TK.SOLUONG,
        DATEDIFF(DAY, SLN.HANDUNG, GETDATE()) as SONGAY
        FROM
        TT_DUOC_TONKHO TK
        join TT_DUOC_CHUNGTU_SOLONHAP SLN on SLN.SOLONHAP_ID = TK.SOLONHAP_ID
        join TT_DUOC_SOLONHAP_GIABAN SLNGB on SLN.SOLONHAP_ID = SLNGB.SOLONHAP_ID
        join TM_DUOC D on SLN.DUOC_ID = D.DUOC_ID
        join TM_NGUONHANG NH on SLN.NGUONDUOC_ID = NH.NGUONDUOC_ID
        WHERE
            TK.SOLUONG > 0
        AND TK.KHODUOC_ID = $KHODUOC_ID$
        AND TK.BENHVIEN_ID = '$BENHVIEN_ID$'              
        AND SLN.HANDUNG &lt; DATEADD(DAY, $SONGAYHETHAN$, GETDATE())
        ORDER BY HANDUNG, TENHANG
      </statement>
      <statement id="DAO00030_GetListDuocTonToiThieu" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
        SELECT
        tk.*,
        d.SOLUONGTOITHIEU,
        d.MADUOC,
        td.TENDUOC as TENHANG,
        d.TENHOATCHAT,
        dvt.TENDONVITINH as DONVITINH,
        LD.TENLOAIDUOC,
        NLD.TENNHOMLOAIDUOC
        FROM
        (
        SELECT KHODUOC_ID, DUOC_ID , cast(SUM(SOLUONG) as numeric(18,0)) AS TONGTON
        FROM
        TT_DUOC_TONKHO tk
        GROUP BY KHODUOC_ID, DUOC_ID
        )tk
        join TM_DUOC d on tk.DUOC_ID = d.DUOC_ID
        left join TM_TENDUOC td on d.TENDUOC_ID=td.TENDUOC_ID
        left join TM_LOAIDUOC LD on LD.LOAIDUOC_ID = D.LOAIDUOC_ID
        left join TM_NHOMLOAIDUOC NLD on NLD.NHOMLOAIDUOC_ID = LD.NHOMLOAIDUOC_ID
        left join TM_DONVITINH dvt on dvt.DONVITINH_ID = d.DONVITINH_ID
        WHERE
        tk.KHODUOC_ID =  $KHODUOC_ID$
        and tk.TONGTON &lt; d.SOLUONGTOITHIEU
        ORDER BY D.MADUOC
      </statement>
      <statement id="DAO00030_CheckLoaiPhongBan" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
        select pb.*  from TM_PHONGBAN pb
        join LST_DICTIONARY dic on pb.LOAIPHONGBAN_ID = dic.DICTIONARY_ID
        where
        pb.PHONGBAN_ID = $PHONGBAN_ID$
        and dic.DICTIONARY_CODE = '$LOAIPHONGBAN_CODE$'
      </statement>
      <statement id="DAO00030_GetList_DuocCanhBao_TT30" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
        select CB.DUOCCANHBAO_ID, CB.HOATCHAT_ID, CB.MAHOATCHAT, HC.TENHOATCHAT, CB.MAICD, CB.NOIDUNGCANHBAO, CB.GHICHU, CAST(CB.TAMNGUNG AS BIT) AS TAMNGUNG
        from TM_DUOC_CANHBAO_TT30 (nolock) CB
        left join TM_DUOC_HOATCHAT (nolock) HC on HC.HOATCHAT_ID = CB.HOATCHAT_ID
        where CB.BENHVIEN_ID = '$BENHVIEN_ID$'
        order by CB.MAHOATCHAT, CB.NOIDUNGCANHBAO
      </statement>
      <statement id="DAO00030_Delete_DuocCanhBao_TT30" parameterClass="System.String" resultClass="System.Int32">
        delete from TM_DUOC_CANHBAO_TT30
        where DUOCCANHBAO_ID IN ($LST_DUOCCANHBAO_ID$) and BENHVIEN_ID = '$BENHVIEN_ID$'
      </statement>
      <update id="DAO00030_Update_DuocCanhBao_TT30" parameterClass="HashTable">
        update TM_DUOC_CANHBAO_TT30 set
        HOATCHAT_ID = #HOATCHAT_ID#
        , MAHOATCHAT = #MAHOATCHAT#
        , MAICD = #MAICD#
        , NOIDUNGCANHBAO = #NOIDUNGCANHBAO#
        , GHICHU = #GHICHU#
        , TAMNGUNG = #TAMNGUNG#
        , NGAYCAPNHAT = #NGAYCAPNHAT#
        , NGUOICAPNHAT = #NGUOICAPNHAT#
        where
        DUOCCANHBAO_ID = $DUOCCANHBAO_ID$
      </update>
      <statement id="DAO00030_Insert_DuocCanhBao_TT30" parameterClass="DataObject" resultClass="DataObject">
        INSERT INTO TM_DUOC_CANHBAO_TT30 (HOATCHAT_ID, MAHOATCHAT, MAICD, NOIDUNGCANHBAO, GHICHU, TAMNGUNG, BENHVIEN_ID, NGAYTAO, NGUOITAO)
        VALUES (#HOATCHAT_ID#, #MAHOATCHAT#, #MAICD#, #NOIDUNGCANHBAO#, #GHICHU#, #TAMNGUNG#, #BENHVIEN_ID#, #NGAYTAO#, #NGUOITAO#)

        SELECT SCOPE_IDENTITY()
      </statement>
      <statement id="DAO00030_CheckCanhBaoDuoc_DKTT_NgoaiTru" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
        IF EXISTS (SELECT CB.DUOCCANHBAO_ID
        FROM TM_DUOC_CANHBAO_TT30 (nolock) CB
        join TM_DUOC_THANHPHANHOATCHAT (nolock) TPHC on TPHC.HOATCHAT_ID = CB.HOATCHAT_ID
        WHERE TPHC.DUOC_ID = $DUOC_ID$ and CB.TAMNGUNG = '0')
        BEGIN
        DECLARE @MAICD varchar(1000), @NOIDUNGCANHBAO nvarchar(2000)

        SELECT top 1 @MAICD = MAICD, @NOIDUNGCANHBAO = NOIDUNGCANHBAO
        FROM TM_DUOC_CANHBAO_TT30 (nolock) CB
        join TM_DUOC_THANHPHANHOATCHAT (nolock) TPHC on TPHC.HOATCHAT_ID = CB.HOATCHAT_ID
        WHERE TPHC.DUOC_ID = $DUOC_ID$ and CB.TAMNGUNG = '0'

        IF @MAICD IS NULL
        BEGIN
        SELECT -1 AS RESULT, @NOIDUNGCANHBAO AS NOIDUNGCANHBAO
        RETURN
        END
        ELSE IF EXISTS (select KB.KHAMBENH_ID
        from TT_NGOAITRU_KHAMBENH (nolock) KB
        inner join TM_ICD (nolock) ICD on ICD.ICD_ID = KB.CHANDOANICD_ID
        left join TT_NGOAITRU_KHAMBENH_ICD (nolock) KB_ICD on KB_ICD.KHAMBENH_ID = KB.KHAMBENH_ID
        left join TM_ICD (nolock) ICD_P on ICD_P.ICD_ID = KB_ICD.ICD_ID
        where KB.TIEPNHAN_ID = $TIEPNHAN_ID$
        and (ICD.MAICD in (select part from fnSplit(@MAICD, ';'))
        or ICD_P.MAICD in (select part from fnSplit(@MAICD, ';'))
        )
        )
        BEGIN
        SELECT 1 AS RESULT
        RETURN
        END
        ELSE
        BEGIN
        SELECT -1 AS RESULT, @NOIDUNGCANHBAO AS NOIDUNGCANHBAO
        END
        END
        ELSE
        BEGIN
        SELECT 1 AS RESULT
        RETURN
        END
      </statement>
      <statement id="DAO00030_CheckCanhBaoDuoc_DKTT_NoiTru" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
        IF EXISTS (SELECT CB.DUOCCANHBAO_ID
        FROM TM_DUOC_CANHBAO_TT30 (nolock) CB
        join TM_DUOC_THANHPHANHOATCHAT (nolock) TPHC on TPHC.HOATCHAT_ID = CB.HOATCHAT_ID
        WHERE TPHC.DUOC_ID = $DUOC_ID$ and CB.TAMNGUNG = '0')
        BEGIN
        DECLARE @MAICD varchar(1000), @NOIDUNGCANHBAO nvarchar(2000)

        SELECT top 1 @MAICD = MAICD, @NOIDUNGCANHBAO = NOIDUNGCANHBAO
        FROM TM_DUOC_CANHBAO_TT30 (nolock) CB
        join TM_DUOC_THANHPHANHOATCHAT (nolock) TPHC on TPHC.HOATCHAT_ID = CB.HOATCHAT_ID
        WHERE TPHC.DUOC_ID = $DUOC_ID$ and CB.TAMNGUNG = '0'

        IF @MAICD IS NULL
        BEGIN
        SELECT -1 AS RESULT, @NOIDUNGCANHBAO AS NOIDUNGCANHBAO
        RETURN
        END
        ELSE IF EXISTS (select BENHAN_ID
        from TT_NOITRU_BENHAN (nolock) BA
        left join TM_ICD (nolock) ICD_1 on ICD_1.ICD_ID = BA.ICD_VAOKHOA
        left join TM_ICD (nolock) ICD_2 on ICD_2.ICD_ID = BA.ICD_BENHCHINH
        left join TM_ICD (nolock) ICD_3 on ICD_3.ICD_ID = BA.ICDRAVIEN_CHINH
        left join TM_ICD (nolock) ICD_P on ICD_P.MAICD in (select part from fnSplit(BA.ICD_BENHPHU, ';'))
        where BA.BENHAN_ID = $BENHAN_ID$
        and (ICD_1.MAICD in (select part from fnSplit(@MAICD, ';'))
        or ICD_2.MAICD in (select part from fnSplit(@MAICD, ';'))
        or ICD_3.MAICD in (select part from fnSplit(@MAICD, ';'))
        or ICD_P.MAICD in (select part from fnSplit(@MAICD, ';'))
        )
        )
        BEGIN
        SELECT 1 AS RESULT
        RETURN
        END
        ELSE
        BEGIN
        SELECT -1 AS RESULT, @NOIDUNGCANHBAO AS NOIDUNGCANHBAO
        END
        END
        ELSE
        BEGIN
        SELECT 1 AS RESULT
        RETURN
        END
      </statement>    
      
      <statement id="DAO00030_UpdateToaThuocChungTu_ID" parameterClass="System.Collections.IDictionary" resultClass="System.Int32">
        update TT_NOITRU_TOATHUOC
        set CHUNGTU_ID = #CHUNGTU_ID#, TRANGTHAI = 'DAXUAT'        
        where
        CHUNGTU_ID IS NULL
        and TOATHUOC_ID in ($LIST_TOATHUOC_ID$)        
      </statement>
      
      <!--PHA CHE-->
      <statement id="DAO00030_Add_TM_DUOC_TYLEPHACHE" parameterClass="DataObject" resultClass="DataObject">
        IF NOT EXISTS
        (
        SELECT *
        FROM TM_DUOC_TYLEPHACHE
        WHERE
        THANHPHAM_ID = #THANHPHAM_ID#
        and NGUYENLIEU_ID = #NGUYENLIEU_ID#
        )
        
        BEGIN
        INSERT INTO TM_DUOC_TYLEPHACHE
        (THANHPHAM_ID, NGUYENLIEU_ID, TYLE, NGAYTAO, ACTIVE)
        VALUES
        (#THANHPHAM_ID#, #NGUYENLIEU_ID#, #TYLE#, GETDATE(), 1)
        END

        ELSE

        BEGIN
        update TM_DUOC_TYLEPHACHE
        set TYLE = #TYLE#
        ,NGAYCAPNHAT = GETDATE()
        where
        THANHPHAM_ID = #THANHPHAM_ID#
        and NGUYENLIEU_ID = #NGUYENLIEU_ID#
        END
      </statement>
      <statement id="DAO00030_Del_TM_DUOC_TYLEPHACHE" parameterClass="DataObject" resultClass="DataObject">
        DELETE
        TM_DUOC_TYLEPHACHE
        WHERE
        THANHPHAM_ID = #THANHPHAM_ID#
        and NGUYENLIEU_ID = #NGUYENLIEU_ID#       
      </statement>

      <statement id="DAO00030_GetCauHinhPhaCheByID" parameterClass="DataObject" resultClass="DataObject">
        select * from TM_DUOC_TYLEPHACHE
        where
        THANHPHAM_ID = #THANHPHAM_ID#
        and NGUYENLIEU_ID = #NGUYENLIEU_ID#        
      </statement>
      <statement id="DAO00030_GetListCauHinhPhaCheByID" parameterClass="DataObject" resultClass="DataObject">
        delete TM_DUOC_TYLEPHACHE
        where
        THANHPHAM_ID = #THANHPHAM_ID#
        and NGUYENLIEU_ID not in
        (
          select DUOC_ID FROM TM_DUOC
        )

        select pc.*,tp.MADUOC as MATHANHPHAM,tp.TENDUOCDAYDU as TENTHANHPHAM,tp.DONVITINH as DONVITINHTHANHPHAM,nl.MADUOC as MANGUYENLIEU,nl.TENDUOCDAYDU as TENNGUYENLIEU, nl.DONVITINH as DONVITINHNGUYENLIEU
        from TM_DUOC_TYLEPHACHE pc
        join TM_DUOC tp on tp.DUOC_ID = pc.THANHPHAM_ID
        join TM_DUOC nl on nl.DUOC_ID = pc.NGUYENLIEU_ID
        where
        THANHPHAM_ID = #THANHPHAM_ID#
        <isParameterPresent>
          <isNotEmpty prepend="and" property="NGUYENLIEU_ID">
            NGUYENLIEU_ID = #NGUYENLIEU_ID#
          </isNotEmpty>
        </isParameterPresent>
      </statement>
      <statement id="DAO00030_Search_ThanhPham" parameterClass="DataObject" resultClass="DataObject">
        select distinct pc.THANHPHAM_ID	, tp.MADUOC, tp.MADUOCBV, ttp.TENDUOC as TENTHANHPHAM , tp.TENHOATCHAT, tp.HAMLUONG, dvt.TENDONVITINH, tp.SO_QDTT
        from TM_DUOC_TYLEPHACHE pc
        join TM_DUOC tp on tp.DUOC_ID = pc.THANHPHAM_ID
        join TM_TENDUOC ttp on tp.TENDUOC_ID=ttp.TENDUOC_ID
        left join TM_DONVITINH dvt on tp.DONVITINH_ID=dvt.DONVICOBAN_ID

        <isParameterPresent>
          <isNotEmpty prepend="Where" property="TUKHOA">
            ttp.TENDUOC like N'%$TUKHOA$%'
          </isNotEmpty>
        </isParameterPresent>
        ORDER BY ttp.TENDUOC
      </statement>
      <statement id="DAO00030_DelCauHinh" parameterClass="DataObject" resultClass="DataObject">
        delete TM_DUOC_TYLEPHACHE
        where
        THANHPHAM_ID = #THANHPHAM_ID#
        and NGUYENLIEU_ID = #NGUYENLIEU_ID#
      </statement>
      <statement id="DAO00030_GetTonKhoTheoTyLe" parameterClass="DataObject" resultClass="DataObject">
        select
        TK.DUOC_ID,
        TK.SOLONHAP_ID,
        TK.SOLUONG,
        TK.NGUONDUOC_ID,
        TK.NGUONDUOC_ID AS NGUONHANG_ID,
        d.DONVITINH_ID,
        d.DONVITINH,
        gb.DONGIAMUA,
        gb.DONGIAVONVAT,
        gb.DONGIABAN,
        sln.HANDUNG AS HANSUDUNG,
        pc.TYLE,
        pc.TYLE*SOLUONG/100 as SOLUONG_TP,
        gb.DONGIAMUA*100/pc.TYLE as DONGIAMUA_TP,
        gb.DONGIAVONVAT*100/pc.TYLE as DONGIAVONVAT_TP,
        gb.DONGIABAN*100/pc.TYLE as DONGIABAN_TP,
        pc.NGUYENLIEU_ID,
        nl.TENDUOCDAYDU as TENNGUYENLIEU,
        pc.THANHPHAM_ID,
        tp.TENDUOCDAYDU as TENTHANHPHAM,
        sln.NGAYNHAP as NGAYNHAPLO,
        sln.HANDUNG,
        sln.SOLOSANPHAM
        FROM
        TT_DUOC_TONKHO tk
        join TM_DUOC_TYLEPHACHE pc on pc.NGUYENLIEU_ID = tk.DUOC_ID
        join TT_DUOC_SOLONHAP_GIABAN gb on gb.SOLONHAP_ID = tk.SOLONHAP_ID
        join TT_DUOC_CHUNGTU_SOLONHAP sln on sln.SOLONHAP_ID = tk.SOLONHAP_ID
        join TM_DUOC d on d.DUOC_ID = pc.THANHPHAM_ID
        join TM_DUOC nl on nl.DUOC_ID = pc.NGUYENLIEU_ID
        join TM_DUOC tp on tp.DUOC_ID = pc.THANHPHAM_ID
        where
        KHODUOC_ID = #KHODUOC_ID#
        and SOLUONG > 0
        <isParameterPresent>
          <isNotEmpty prepend="and" property="THANHPHAM_ID">
            pc.THANHPHAM_ID IN ($THANHPHAM_ID$)
          </isNotEmpty>
        </isParameterPresent>
        order by sln.NGAYNHAP
      </statement>
      <statement id="DAO00030_GetDonGiaVonNguyenLieuGanNhat" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
        select top 1 gb.*, sln.HANDUNG, sln.SOLOSANPHAM from TT_DUOC_SOLONHAP_GIABAN gb
        join TT_DUOC_CHUNGTU_SOLONHAP sln on gb.SOLONHAP_ID = sln.SOLONHAP_ID
        where gb.DUOC_ID = #DUOC_ID#
        order by sln.NGAYNHAP desc
      </statement>
      <statement id="DAO00030_GetListThanhPhamID" parameterClass="DataObject" resultClass="DataObject">
        SELECT
        THANHPHAM_ID
        FROM TM_DUOC_TYLEPHACHE
        GROUP BY THANHPHAM_ID
        <isEqual prepend="" property="LOAITONGHOP" compareValue="N21">
          HAVING COUNT(NGUYENLIEU_ID) = 1
        </isEqual>
        <isEqual prepend="" property="LOAITONGHOP" compareValue="N22">
          HAVING COUNT(NGUYENLIEU_ID) > 1
        </isEqual>
      </statement>
      <statement id="DAO00030_ThemChungTuXuatNguyenLieu" parameterClass="System.Collections.IDictionary" resultClass="System.Int32">
         declare @jsonChiTiet nvarchar(max);
         set @jsonChiTiet = #JSON_DATA#;
         declare @chungtu_id int;

         INSERT INTO TT_DUOC_CHUNGTU (
         MACHUNGTU,SOCHUNGTU,NGAYCHUNGTU,LOAICHUNGTU,MUCDICHCHUNGTU_ID,MUCDICHCHUNGTU_CODE,KHOXUAT_ID,NGUOIGIAO_ID,NGUOIGIAO,KHONHAP_ID,NGUOINHAN_ID,NGUOINHAN,NGUOIKIEMTRA_ID,NGUOIKIEMTRA,NGUOIDUYET_ID,NGUOIDUYET,PHUONGPHAPXUAT,KETOANTRUONG_ID,KETOANTRUONG,THUKHO_ID,THUKHO,MAUHOADON,SOHOADON,SOSERI,NGAYHOADON,DIENGIAI,GIATRI,GIATRITHANHTOAN,TYLEVAT,GIATRIVAT,THUESUAT,GIATRITHUE,TYLECHIETKHAU,GIATRICHIETKHAU,TIENTE_ID,TYGIA,SOCHUNGTUGOC,NGAYCHUNGTUGOC,NHACUNGCAP_ID,HINHTHUCTHANHTOAN_ID,NGUONDUOC_ID,CHUNGTULIENQUAN_ID,KHAMBENH_ID,TOATHUOCNOITRU_ID,TIEPNHAN_ID,BENHAN_ID,DANHANTHUOC,NGUOINHAP_ID,NGAYNHAP,TRANGTHAI,LOAITOATHUOC,PHIEULINH_ID,DIENGIAINGHIEPVUPHATSINH,DONVIGIAO_ID,KHOSUDUNG_ID,LOAIVATTU_ID,BENHNHAN_ID,NGOAITRU_TOATHUOC_NGUOIMUA_ID,TENBENHNHAN,BACSIGIOITHIEU_ID,DOITUONG_ID,IDCHUYEN,CHUNGTUKETOAN,STATUS,TRANSFER_VIENPHI_ID,PHONGBAN_ID,BACSI_ID,TKNO,TKCO,MACHUNGTUREF,LOAICHUNGTUREF,PHIEULINHCANTRU_ID,KHOTHUCHIEN_ID,KHODOIUNG_ID,MENU_LOAIDUOC_ID,NGUOISUDUNGMAY_ID,GOITHAU_ID,XUATTHUOCBANGOAITRU,NGAYGIOCHUNGTU,NOIDAKHAM,HOIDONGKIEMNHAP_ID,HOIDONGTHANHLY_ID,CHUYENCHUNGTUID,CHUYENDOANHTHUID,LYDOXUATSUDUNG_ID,BENHVIEN_ID,NGAYTAO,NGUOITAO_ID,NGAYCAPNHAT,NGUOICAPNHAT_ID)
         values (#MACHUNGTU#,#SOCHUNGTU#,#NGAYCHUNGTU#,'X',#MUCDICHCHUNGTU_ID#,#MUCDICHCHUNGTU_CODE#,#KHOXUAT_ID#,#NGUOIGIAO_ID#,#NGUOIGIAO#,#KHONHAP_ID#,#NGUOINHAN_ID#,#NGUOINHAN#,#NGUOIKIEMTRA_ID#,#NGUOIKIEMTRA#,#NGUOIDUYET_ID#,#NGUOIDUYET#,#PHUONGPHAPXUAT#,#KETOANTRUONG_ID#,#KETOANTRUONG#,#THUKHO_ID#,#THUKHO#,#MAUHOADON#,#SOHOADON#,#SOSERI#,#NGAYHOADON#,#DIENGIAI#,#GIATRI#,#GIATRITHANHTOAN#,#TYLEVAT#,#GIATRIVAT#,#THUESUAT#,#GIATRITHUE#,#TYLECHIETKHAU#,#GIATRICHIETKHAU#,#TIENTE_ID#,#TYGIA#,#SOCHUNGTUGOC#,#NGAYCHUNGTUGOC#,#NHACUNGCAP_ID#,#HINHTHUCTHANHTOAN_ID#,#NGUONDUOC_ID#,#CHUNGTULIENQUAN_ID#,#KHAMBENH_ID#,#TOATHUOCNOITRU_ID#,#TIEPNHAN_ID#,#BENHAN_ID#,#DANHANTHUOC#,#NGUOINHAP_ID#,#NGAYNHAP#,'DXK',#LOAITOATHUOC#,#PHIEULINH_ID#,#DIENGIAINGHIEPVUPHATSINH#,#DONVIGIAO_ID#,#KHOSUDUNG_ID#,#LOAIVATTU_ID#,#BENHNHAN_ID#,#NGOAITRU_TOATHUOC_NGUOIMUA_ID#,#TENBENHNHAN#,#BACSIGIOITHIEU_ID#,#DOITUONG_ID#,#IDCHUYEN#,#CHUNGTUKETOAN#,#STATUS#,#TRANSFER_VIENPHI_ID#,#PHONGBAN_ID#,#BACSI_ID#,#TKNO#,#TKCO#,#MACHUNGTUREF#,#LOAICHUNGTUREF#,#PHIEULINHCANTRU_ID#,#KHOTHUCHIEN_ID#,#KHODOIUNG_ID#,#MENU_LOAIDUOC_ID#,#NGUOISUDUNGMAY_ID#,#GOITHAU_ID#,#XUATTHUOCBANGOAITRU#,#NGAYGIOCHUNGTU#,#NOIDAKHAM#,#HOIDONGKIEMNHAP_ID#,#HOIDONGTHANHLY_ID#,#CHUYENCHUNGTUID#,#CHUYENDOANHTHUID#,#LYDOXUATSUDUNG_ID#,#BENHVIEN_ID#,#NGAYCHUNGTU#,#NGUOITAO_ID#,#NGAYCAPNHAT#,#NGUOICAPNHAT_ID#)
         set @chungtu_id = SCOPE_IDENTITY()

         <!--insert chi tiet-->
        INSERT INTO TT_DUOC_CHUNGTU_CHITIET
        (CHUNGTU_ID,DUOC_ID,SOLONHAP_ID,SOKIEMSOAT,SOVISA,HANDUNG,DONVITINH_ID
        ,SOLUONGYEUCAU,SOLUONGDAXUAT,THANHTIENVON
        ,DONGIABAN,DONGIAVON,TRANGTHAI,NGUONHANG_ID        
        ,BENHVIEN_ID,NGAYTAO,NGUOITAO_ID)

        SELECT @chungtu_id, json.DUOC_ID, json.SOLONHAP_ID, json.SOKIEMSOAT, json.SOVISA, json.HANDUNG, json.DONVITINH_ID
        ,json.SOLUONGYEUCAU, json.SOLUONGDAXUAT, json.THANHTIENVON
        ,json.DONGIABAN, json.DONGIAVON, json.TRANGTHAI, json.NGUONHANG_ID       
        ,#BENHVIEN_ID#, getdate(), json.NGUOITAO_ID
        FROM OPENJSON(@jsonChiTiet)
        WITH (
        DUOC_ID int,SOLONHAP_ID int,SOKIEMSOAT varchar(20),SOVISA varchar(20),HANDUNG datetime,DONVITINH_ID int,
        SOLUONGYEUCAU numeric(25, 4),SOLUONGDAXUAT numeric(25, 4),THANHTIENVON numeric(25, 4),
        DONGIABAN numeric(25, 4),DONGIAVON numeric(25, 4),TRANGTHAI varchar(10),NGUONHANG_ID int,        
        BENHVIEN_ID varchar(10),NGAYTAO datetime,NGUOITAO_ID int
        ) json

        select @chungtu_id
      </statement>
      <statement id="DAO00030_XoaChungTuXuatNguyenLieu" parameterClass="System.Collections.IDictionary" resultClass="System.Int32">       
        DELETE  TT_DUOC_CHUNGTU_CHITIET WHERE CHUNGTU_ID = #CHUNGTU_ID#
        DELETE  TT_DUOC_CHUNGTU WHERE CHUNGTU_ID = #CHUNGTU_ID#
      </statement>
      <statement id="DAO00030_ThemChungTuXuatNguyenLieuChiTiet" parameterClass="System.Collections.IDictionary" resultClass="System.Int32">
        declare @jsonChiTiet nvarchar(max);
        set @jsonChiTiet = #JSON_DATA#;       
        
        <!--insert chi tiet-->
        INSERT INTO TT_DUOC_CHUNGTU_CHITIET
        (CHUNGTU_ID,DUOC_ID,SOLONHAP_ID,SOKIEMSOAT,SOVISA,HANDUNG,DONVITINH_ID
        ,SOLUONGYEUCAU,SOLUONGDAXUAT,THANHTIENVON
        ,DONGIABAN,DONGIAVON,TRANGTHAI,NGUONHANG_ID
        ,BENHVIEN_ID,NGAYTAO,NGUOITAO_ID)

        SELECT #CHUNGTU_ID#, json.DUOC_ID, json.SOLONHAP_ID, json.SOKIEMSOAT, json.SOVISA, json.HANDUNG, json.DONVITINH_ID
        ,json.SOLUONGYEUCAU, json.SOLUONGDAXUAT, json.THANHTIENVON
        ,json.DONGIABAN, json.DONGIAVON, json.TRANGTHAI, json.NGUONHANG_ID
        ,#BENHVIEN_ID#, getdate(), json.NGUOITAO_ID
        FROM OPENJSON(@jsonChiTiet)
        WITH (
        DUOC_ID int, SOLONHAP_ID int,SOKIEMSOAT varchar(20),SOVISA varchar(20),HANDUNG datetime,DONVITINH_ID int,
        SOLUONGYEUCAU numeric(25, 4),SOLUONGDAXUAT numeric(25, 4),THANHTIENVON numeric(25, 4),
        DONGIABAN numeric(25, 4),DONGIAVON numeric(25, 4),TRANGTHAI varchar(10),NGUONHANG_ID int,
        BENHVIEN_ID varchar(10),NGAYTAO datetime,NGUOITAO_ID int
        ) json
      </statement>      
      <statement id="DAO00030_XoaChungTuXuatNguyenLieuChiTiet" parameterClass="System.Collections.IDictionary" resultClass="System.Int32">       
        DELETE FROM TT_DUOC_CHUNGTU_CHITIET WHERE CHUNGTU_ID = #CHUNGTU_ID#      
      </statement>
      
      <statement id="DAO00030_Del_CTXuatNguyenLieuRac" parameterClass="System.Collections.IDictionary" resultClass="System.Int32">
        DELETE TT_DUOC_CHUNGTU_CHITIET WHERE CHUNGTU_ID IN
        (
        select CHUNGTU_ID from TT_DUOC_CHUNGTU Where
        MUCDICHCHUNGTU_CODE = 'X21'
        AND CHUNGTU_ID NOT IN
        (
        SELECT ISNULL(CHUNGTULIENQUAN_ID,0) FROM TT_DUOC_CHUNGTU Where
        MUCDICHCHUNGTU_CODE = 'N21'
        )
        )

        DELETE TT_DUOC_CHUNGTU WHERE CHUNGTU_ID IN
        (
        select CHUNGTU_ID from TT_DUOC_CHUNGTU Where
        MUCDICHCHUNGTU_CODE = 'X21'
        AND CHUNGTU_ID NOT IN
        (
        SELECT ISNULL(CHUNGTULIENQUAN_ID,0) FROM TT_DUOC_CHUNGTU Where
        MUCDICHCHUNGTU_CODE = 'N21'
        )
        )
      </statement>
      <statement id="DAO00030_Search_CTNhapBaoChe" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
        select DISTINCT
        CT.CHUNGTU_ID,
        CT.SOCHUNGTU,
        CT.MACHUNGTU,
        CT.NGAYCHUNGTU,
        CT.NGAYTAO,
        CTXuat.MACHUNGTU as SOCHUNGTUGOC,
        CTXuat.NGAYCHUNGTU as NGAYCHUNGTUGOC,       
        CASE
        WHEN CT.TRANGTHAI = 'DNK' THEN N'Đã nhập kho'
        END  AS TRANGTHAI
        from TT_DUOC_CHUNGTU CT
        left join TT_DUOC_CHUNGTU_CHITIET CTCT  ON CTCT.CHUNGTU_ID = CT.CHUNGTU_ID
        left join TT_DUOC_CHUNGTU ctXuat on CTXuat.CHUNGTU_ID = ct.CHUNGTULIENQUAN_ID
        left join TM_DUOC d  ON d.DUOC_ID = CTCT.DUOC_ID
        left join TM_NHANVIEN NV on CT.NGUOICAPNHAT_ID = NV.NHANVIEN_ID        
        left join TM_NHANVIEN NGUOINHAN on NGUOINHAN.NHANVIEN_ID = CT.NGUOINHAN_ID
        <dynamic prepend="where">
          <isParameterPresent>
            <isNotEmpty prepend="and" property="TUKHOA">
              (CT.MACHUNGTU LIKE '%$TUKHOA$%' or d.TENDUOCDAYDU like N'%$TUKHOA$%' OR NGUOINHAN.TENNHANVIEN LIKE '%$TUKHOA$%')
            </isNotEmpty>            
            <isNotEmpty prepend="and" property="BENHVIEN_ID">
              CT.BENHVIEN_ID = '$BENHVIEN_ID$'
            </isNotEmpty>
            <isNotEmpty prepend="and" property="KHONHAP_ID">
              CT.KHONHAP_ID = '$KHONHAP_ID$'
            </isNotEmpty>
            <isNotEmpty prepend="and" property="MUCDICHCHUNGTU_CODE">
              CT.MUCDICHCHUNGTU_CODE = '$MUCDICHCHUNGTU_CODE$'
            </isNotEmpty>
            <isNotEmpty prepend="and" property="TUNGAY">
              CONVERT(date, CT.NGAYCHUNGTU) BETWEEN CONVERT(date, '$TUNGAY$')  and  CONVERT(date, '$DENNGAY$')
            </isNotEmpty>
          </isParameterPresent>
        </dynamic>
        order by CT.CHUNGTU_ID DESC
      </statement>
     
      <!--END PHA CHE-->          
    </statements>
</sqlMap>
