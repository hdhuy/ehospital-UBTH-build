<?xml version="1.0" encoding="utf-8" ?>
<!--============================================================================
//	CAUTION: This file is generated by IBatisNetGen.3.SQLMap.cst at 11/11/2015 9:27:48 AM
//				Any manual editing will be lost in re-generation.
//===========================================================================-->
<sqlMap namespace="eHospital" xmlns="http://ibatis.apache.org/mapping" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" >

  <statements>
    <statement id="DAO00119_TM_CONGTYCHITRA_GetList" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select * from TM_CONGTYCHITRA
      where BENHVIEN_ID = '$BENHVIEN_ID$'
      and TAMNGUNG = '$TAMNGUNG$'
    </statement>
    <statement id="DAO00119_TT_VIENPHI_GetList_BenhNhanThanhVienGoiPhaiThanhToan" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select VP.*
      from TT_VIENPHI VP
      where Vp.BENHNHAN_ID = '$BENHNHAN_ID$' and Vp.ACTIVE = '1' and
      REF_TABLE in ('TT_CSKH_GOI_DANGKY', 'TT_CSKH_THANHVIEN_CAPTHE') and
      ((vp.DATHANHTOAN = '0') or (vp.BENHNHAN_PHAITHANHTOAN > vp.GIATRI_BENHNHAN_DATHANHTOAN and vp.DATHANHTOAN = '1'))
    </statement>
    <statement id="DAO00119_TT_VIENPHI_GetList_TiepNhanPhaiThanhToan" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select distinct  a.*, b.GIATRIMIENGIAM_BH, c.GIATRIMIENGIAM_BHTN, f.GIATRIMIENGIAM_THANHVIEN, g.GIATRIMIENGIAM_CTCT,
      isnull(dv.TENDICHVU, dc.TENDUOCDAYDU) NOIDUNG, isnull(dv.MADICHVU, dc.MADUOC) MADICHVU, dv.NORESULT, dc.DONVITINH, ld.MALOAIDUOC, dc.BHYT DUOC_BHYT, ld.LOAIVATTU_ID, ndv.MANHOMDICHVU
      from
      (select VP.*, isnull(c.TRANGTHAI, '') TRANGTHAI, c.THUTIENSAU, c.NOITHUCHIEN_ID,
      CASE
      when REF_TABLE = 'TT_NGOAITRU_TOATHUOC' then ntkb.PHONGBAN_ID
      when REF_TABLE = 'TT_CLSKETQUA_VTYT' then clsvtyt.PHONGBAN_ID
      when REF_TABLE = 'TT_NGOAITRU_KHAMBENH_VTYT' then kbd.PHONGBAN_ID
      ELSE
      c.NOIYEUCAU_ID
      END NOIYEUCAU_ID,
      CASE
      when REF_TABLE = 'TT_NGOAITRU_TOATHUOC' then ngtd.KHOXUAT_ID
      when REF_TABLE = 'TT_CLSKETQUA_VTYT' then clsvtyt.KHOTAO_ID
      when REF_TABLE = 'TT_NGOAITRU_KHAMBENH_VTYT' then kbd.KHOTAO_ID
      ELSE null
      END KHODUOC_ID

      from TT_VIENPHI VP
      left join TT_DVYEUCAU c on c.DVYEUCAU_ID = VP.REF_ID  and vp.REF_TABLE = 'TT_DVYEUCAU'
      left join TT_NGOAITRU_TOATHUOC nttt on nttt.TOATHUOC_ID = vp.REF_ID and vp.REF_TABLE = 'TT_NGOAITRU_TOATHUOC'
      left join TT_NGOAITRU_KHAMBENH_TOATHUOC ngtd on ngtd.KHAMBENH_TOATHUOC_ID = nttt.KHAMBENH_TOATHUOC_ID
      left join TT_CLSKETQUA_VTYT clsvtyt on clsvtyt.CLSKETQUA_ID = vp.REF_ID and REF_TABLE = 'TT_CLSKETQUA_VTYT'
      left join TT_NGOAITRU_KHAMBENH_VTYT kbd on kbd.KHAMBENH_VTYT_ID = vp.REF_ID and REF_TABLE = 'TT_NGOAITRU_KHAMBENH_VTYT'
      left join TT_NGOAITRU_KHAMBENH ntkb on ntkb.KHAMBENH_ID = vp.KHAMBENH_ID and REF_TABLE = 'TT_NGOAITRU_TOATHUOC'

      where Vp.TIEPNHAN_ID = '$TIEPNHAN_ID$' and Vp.ACTIVE = '1' and ((c.HUYYEUCAU != '1' and vp.DICHVU_ID is not null) or (vp.DUOC_ID is not null)) and
      ((vp.DATHANHTOAN = '0') or (vp.BENHNHAN_PHAITHANHTOAN > vp.GIATRI_BENHNHAN_DATHANHTOAN and vp.DATHANHTOAN = '1')) and c.DANGKY_CHITIET_ID is null
      and vp.REF_TABLE != 'TT_MAU_CHUNGTU_CHITIET'
      and vp.REF_TABLE != 'TT_DUOC_CHUNGTU_CHITIET'
      <isPropertyAvailable  prepend="" property="BIL_THUDICHVU_KHONGTHUTIEN">
        <isEqual prepend="AND" property="BIL_THUDICHVU_KHONGTHUTIEN" compareValue="False">
          VP.KHONGTHUTIEN != '1'
        </isEqual>
      </isPropertyAvailable>
      <isNotPropertyAvailable prepend="AND" property="BIL_THUDICHVU_KHONGTHUTIEN" >
        VP.KHONGTHUTIEN != '1'
      </isNotPropertyAvailable>
      ) a
      left join TM_DUOC dc on a.DUOC_ID = dc.DUOC_ID
      left join TM_LOAIDUOC ld on dc.LOAIDUOC_ID = ld.LOAIDUOC_ID
      left join TM_DICHVU dv on a.DICHVU_ID = dv.DICHVU_ID and a.REF_TABLE = 'TT_DVYEUCAU'
      left join TM_NHOMDICHVU ndv on ndv.NHOMDICHVU_ID = dv.NHOMDICHVU_ID
      left join (select VIENPHI_ID,
      sum(MGCT.GIATRIMIENGIAM) AS GIATRIMIENGIAM_BH from TT_MIENGIAM MG
      INNER JOIN TT_MIENGIAM_CHITIET MGCT ON MG.MIENGIAM_ID = MGCT.MIENGIAM_ID
      where MG.TIEPNHAN_ID= '$TIEPNHAN_ID$' and MGCT.REF_TABLE = 'TT_MIENGIAM' and MG.TINHTRANG = 1 group by VIENPHI_ID
      ) b on a.VIENPHI_ID = b.VIENPHI_ID

      left join (select VIENPHI_ID, sum(MGCT.GIATRIMIENGIAM) AS GIATRIMIENGIAM_BHTN
      from TT_MIENGIAM_BHTN MG
      INNER JOIN TT_MIENGIAM_CHITIET MGCT ON MG.MIENGIAM_BHTN_ID = MGCT.MIENGIAM_ID
      where  MG.TIEPNHAN_ID= '$TIEPNHAN_ID$' and MGCT.REF_TABLE = 'TT_MIENGIAM_BHTN' and MG.TINHTRANG = 1 group by VIENPHI_ID
      )c on a.VIENPHI_ID = c.VIENPHI_ID

      left join (select VIENPHI_ID, sum(MGCT.GIATRIMIENGIAM) AS GIATRIMIENGIAM_THANHVIEN
      from TT_MIENGIAM_THANHVIEN MG
      INNER JOIN TT_MIENGIAM_CHITIET MGCT ON MG.MIENGIAM_THANHVIEN_ID = MGCT.MIENGIAM_ID
      where MG.TIEPNHAN_ID= '$TIEPNHAN_ID$' and MGCT.REF_TABLE = 'TT_MIENGIAM_THANHVIEN' and MG.TINHTRANG = 1 group by VIENPHI_ID
      )f on a.VIENPHI_ID = f.VIENPHI_ID

      left join(select VIENPHI_ID, sum(MGCT.GIATRIMIENGIAM) AS GIATRIMIENGIAM_CTCT
      from TT_MIENGIAM_CONGTY MG
      INNER JOIN TT_MIENGIAM_CHITIET MGCT ON MG.MIENGIAM_CONGTY_ID = MGCT.MIENGIAM_ID
      where MG.TIEPNHAN_ID= '$TIEPNHAN_ID$' and MGCT.REF_TABLE = 'TT_MIENGIAM_CONGTY' and MG.TINHTRANG = 1 group by VIENPHI_ID
      )g on a.VIENPHI_ID = g.VIENPHI_ID

    </statement>
    <statement id="DAO00119_TT_VIENPHI_GetList_TiepNhanPhaiThanhToanWithVienphiId" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select  a.*, b.GIATRIMIENGIAM_BH, c.GIATRIMIENGIAM_BHTN, f.GIATRIMIENGIAM_THANHVIEN, g.GIATRIMIENGIAM_CTCT
      from
      (select VP.*, c.NOITHUCHIEN_ID, c.NOIYEUCAU_ID, c.HUYYEUCAU
      from TT_VIENPHI VP
      left join TT_DVYEUCAU c on c.DVYEUCAU_ID = VP.REF_ID  and vp.REF_TABLE = 'TT_DVYEUCAU'
      where
      VP.REF_TABLE != 'TT_MAU_CHUNGTU_CHITIET' and
      Vp.TIEPNHAN_ID = '$TIEPNHAN_ID$' and Vp.ACTIVE = '1' and ((c.HUYYEUCAU != '1' and vp.DICHVU_ID is not null) or (vp.DUOC_ID is not null)) and
      ((vp.DATHANHTOAN = '0') or (vp.BENHNHAN_PHAITHANHTOAN > vp.GIATRI_BENHNHAN_DATHANHTOAN and vp.DATHANHTOAN = '1')) and c.DANGKY_CHITIET_ID is null
      and vp.VIENPHI_ID in ($LIST_VIENPHI$)) a

      left join (select VIENPHI_ID,
      sum(MGCT.GIATRIMIENGIAM) AS GIATRIMIENGIAM_BH from TT_MIENGIAM MG
      INNER JOIN TT_MIENGIAM_CHITIET MGCT ON MG.MIENGIAM_ID = MGCT.MIENGIAM_ID
      where MG.TIEPNHAN_ID= '$TIEPNHAN_ID$' and MGCT.REF_TABLE = 'TT_MIENGIAM' and MG.TINHTRANG = 1 group by VIENPHI_ID
      ) b on a.VIENPHI_ID = b.VIENPHI_ID

      left join (select VIENPHI_ID, sum(MGCT.GIATRIMIENGIAM) AS GIATRIMIENGIAM_BHTN
      from TT_MIENGIAM_BHTN MG
      INNER JOIN TT_MIENGIAM_CHITIET MGCT ON MG.MIENGIAM_BHTN_ID = MGCT.MIENGIAM_ID
      where  MG.TIEPNHAN_ID= '$TIEPNHAN_ID$' and MGCT.REF_TABLE = 'TT_MIENGIAM_BHTN' and MG.TINHTRANG = 1 group by VIENPHI_ID
      )c on a.VIENPHI_ID = c.VIENPHI_ID

      left join (select VIENPHI_ID, sum(MGCT.GIATRIMIENGIAM) AS GIATRIMIENGIAM_THANHVIEN
      from TT_MIENGIAM_THANHVIEN MG
      INNER JOIN TT_MIENGIAM_CHITIET MGCT ON MG.MIENGIAM_THANHVIEN_ID = MGCT.MIENGIAM_ID
      where MG.TIEPNHAN_ID= '$TIEPNHAN_ID$' and MGCT.REF_TABLE = 'TT_MIENGIAM_THANHVIEN' and MG.TINHTRANG = 1 group by VIENPHI_ID
      )f on a.VIENPHI_ID = f.VIENPHI_ID

      left join(select VIENPHI_ID, sum(MGCT.GIATRIMIENGIAM) AS GIATRIMIENGIAM_CTCT
      from TT_MIENGIAM_CONGTY MG
      INNER JOIN TT_MIENGIAM_CHITIET MGCT ON MG.MIENGIAM_CONGTY_ID = MGCT.MIENGIAM_ID
      where MG.TIEPNHAN_ID= '$TIEPNHAN_ID$' and MGCT.REF_TABLE = 'TT_MIENGIAM_CONGTY' and MG.TINHTRANG = 1 group by VIENPHI_ID
      )g on a.VIENPHI_ID = g.VIENPHI_ID
      WHERE a.REF_TABLE!='TT_MAU_CHUNGTU_CHITIET'
    </statement>

    <statement id="DAO00119_TT_VIENPHI_GetList_TiepNhanPhaiThanhToanDeDuyet" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select * from
      (
      select distinct
      a.VIENPHI_ID
      ,a.TIEPNHAN_ID
      ,a.BENHAN_ID
      ,a.BENHNHAN_ID
      ,a.KHAMBENH_ID
      ,a.REF_ID
      ,a.REF_TABLE
      ,a.DICHVU_ID
      ,a.HUY
      ,a.DATHANHTOAN
      ,a.DATHUCHIEN
      ,a.BHYTDONGTIEN
      ,isnull(dv.TENDICHVU, dc.TENDUOCDAYDU) NOIDUNG
      ,isnull(dv.MADICHVU, dc.MADUOC) MADICHVU
      ,case when ndv.CAPTREN_ID is null then ndv.TENNHOMDICHVU else ndv1.TENNHOMDICHVU end as LOAIDICHVU
      ,case when ndv.CAPTREN_ID is null then ndv.NHOMDICHVU_ID else ndv1.NHOMDICHVU_ID end as NHOMDICHVU
      ,a.ISDUYET
      ,a.NGUOIDUYET_ID
      ,a.THOIGIANDUYET
      ,a.NGUOIHUY_ID
      ,a.THOIGIANHUY
      ,A.NGAYTAO
      ,A.DVYEUCAU_ID
      ,A.NGUOIDUYET
      ,A.NGUOIHUY

      from
      (select VP.*, isnull(c.TRANGTHAI, '') TRANGTHAI, c.THUTIENSAU, c.ISDUYET, c.NGUOIDUYET_ID, C.THOIGIANDUYET, C.NGUOIHUY_ID, C.THOIGIANHUY, C.DVYEUCAU_ID, us.FULLNAME as NGUOIDUYET, us1.FULLNAME as NGUOIHUY
      from TT_VIENPHI VP
      left join TT_DVYEUCAU c on c.DVYEUCAU_ID = VP.REF_ID  and vp.REF_TABLE = 'TT_DVYEUCAU'
      left join TT_CLSKETQUA_VTYT clsvtyt on clsvtyt.CLSKETQUA_ID = vp.REF_ID and REF_TABLE = 'TT_CLSKETQUA_VTYT'
      left join TBL_USER us on us.EMPLOYEEID = c.NGUOIDUYET_ID
      left join TBL_USER us1 on us1.EMPLOYEEID = c.NGUOIHUY_ID
      where Vp.TIEPNHAN_ID = '$TIEPNHAN_ID$' and Vp.ACTIVE = '1' and ((c.HUYYEUCAU != '1' and vp.DICHVU_ID is not null) or (vp.DUOC_ID is not null))
      and c.DANGKY_CHITIET_ID is null
      and vp.REF_TABLE != 'TT_MAU_CHUNGTU_CHITIET'
      and vp.REF_TABLE != 'TT_DUOC_CHUNGTU_CHITIET'

      ) a
      left join TM_DUOC dc on a.DUOC_ID = dc.DUOC_ID
      left join TM_LOAIDUOC ld on dc.LOAIDUOC_ID = ld.LOAIDUOC_ID
      left join TM_DICHVU dv on a.DICHVU_ID = dv.DICHVU_ID and a.REF_TABLE = 'TT_DVYEUCAU'
      left join TM_NHOMDICHVU ndv on ndv.NHOMDICHVU_ID = dv.NHOMDICHVU_ID
      left join TM_NHOMDICHVU ndv1 on ndv1.NHOMDICHVU_ID = ndv.CAPTREN_ID
      ) B
      WHERE B.NHOMDICHVU != 5

    </statement>
    
    <!--<statement id="DAO00119_TT_VIENPHI_GetList_BenhAnPhaiThanhToan" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select  a.*, b.GIATRIMIENGIAM_BH, c.GIATRIMIENGIAM_BHTN, f.GIATRIMIENGIAM_THANHVIEN, g.GIATRIMIENGIAM_CTCT
      from
      (select VP.*, c.NOITHUCHIEN_ID, c.NOIYEUCAU_ID
      from TT_VIENPHI VP
      left join TT_DVYEUCAU c on c.DVYEUCAU_ID = VP.REF_ID  and vp.REF_TABLE = 'TT_DVYEUCAU'
      where Vp.BENHAN_ID = '$BENHAN_ID$' and Vp.ACTIVE = '1' and ((c.HUYYEUCAU != '1' and vp.DICHVU_ID is not null) or 
      (vp.DUOC_ID is not null) or (REF_TABLE = 'TT_NUT_XACNHANSUATAN_CHITIET')) and
      ((vp.DATHANHTOAN = '0') or (vp.BENHNHAN_PHAITHANHTOAN > vp.GIATRI_BENHNHAN_DATHANHTOAN and vp.DATHANHTOAN = '1')) and c.DANGKY_ID is null
      ) a

      left join (select VIENPHI_ID,
      sum(MGCT.GIATRIMIENGIAM) AS GIATRIMIENGIAM_BH from TT_MIENGIAM MG
      INNER JOIN TT_MIENGIAM_CHITIET MGCT ON MG.MIENGIAM_ID = MGCT.MIENGIAM_ID
      where MG.BENHAN_ID = '$BENHAN_ID$' and MGCT.REF_TABLE = 'TT_MIENGIAM' and MG.TINHTRANG = 1 group by VIENPHI_ID
      ) b on a.VIENPHI_ID = b.VIENPHI_ID

      left join (select VIENPHI_ID, sum(MGCT.GIATRIMIENGIAM) AS GIATRIMIENGIAM_BHTN
      from TT_MIENGIAM_BHTN MG
      INNER JOIN TT_MIENGIAM_CHITIET MGCT ON MG.MIENGIAM_BHTN_ID = MGCT.MIENGIAM_ID
      where  MG.BENHAN_ID = '$BENHAN_ID$' and MGCT.REF_TABLE = 'TT_MIENGIAM_BHTN' and MG.TINHTRANG = 1 group by VIENPHI_ID
      )c on a.VIENPHI_ID = c.VIENPHI_ID

      left join (select VIENPHI_ID, sum(MGCT.GIATRIMIENGIAM) AS GIATRIMIENGIAM_THANHVIEN
      from TT_MIENGIAM_THANHVIEN MG
      INNER JOIN TT_MIENGIAM_CHITIET MGCT ON MG.MIENGIAM_THANHVIEN_ID = MGCT.MIENGIAM_ID
      where MG.TIEPNHAN_ID = '$TIEPNHAN_ID$' and MGCT.REF_TABLE = 'TT_MIENGIAM_THANHVIEN' and MG.TINHTRANG = 1 group by VIENPHI_ID
      )f on a.VIENPHI_ID = f.VIENPHI_ID

      left join(select VIENPHI_ID, sum(MGCT.GIATRIMIENGIAM) AS GIATRIMIENGIAM_CTCT
      from TT_MIENGIAM_CONGTY MG
      INNER JOIN TT_MIENGIAM_CHITIET MGCT ON MG.MIENGIAM_CONGTY_ID = MGCT.MIENGIAM_ID
      where MG.BENHAN_ID = '$BENHAN_ID$' and MGCT.REF_TABLE = 'TT_MIENGIAM_CONGTY' and MG.TINHTRANG = 1 group by VIENPHI_ID
      )g on a.VIENPHI_ID = g.VIENPHI_ID      
    </statement>-->
    <statement id="DAO00119_TT_DVYEUCAU_GetList_BenhAn" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select
      B.MADICHVU, B.TENDICHVU NOIDUNG, A.NGAYGIOYEUCAU, A.SODICHVUYEUCAU SOLUONG,
      E.TENPHONGBAN NOIYEUCAU, F.TENPHONGBAN NOITHUCHIEN, B.DONVITINH,
      <!--Format(A.NGAYGIOYEUCAU, 'dd/MM/yyyy, hh:mm:ss') as THOIGIAN,-->
      CASE
      WHEN A.TRANGTHAI =  'HOANTAT' THEN N'Hoàn thành'
      WHEN A.TRANGTHAI =  'DALAYMAU' THEN N'Đã lấy mẫu'
      WHEN A.TRANGTHAI =  'CHOXACNHAN' THEN N'Chờ xác nhận'
      WHEN A.TRANGTHAI =  'DANGTHUCHIEN' THEN N'Đang thực hiện'
      WHEN A.TRANGTHAI =  'DACHUYENTUYEN' THEN N'Đã chuyển tuyến'
      ELSE N'Chưa kết quả'
      END TRANGTHAI
      from TT_DVYEUCAU A
      left join TM_DICHVU B on B.DICHVU_ID = A.DICHVU_ID
      left join TM_NHOMDICHVU C on B.NHOMDICHVU_ID = C.NHOMDICHVU_ID
      left join TM_PHONGBAN E on E.PHONGBAN_ID = A.NOIYEUCAU_ID
      left join TM_PHONGBAN F on F.PHONGBAN_ID = A.NOITHUCHIEN_ID
      where
      A.BENHAN_ID = '$BENHAN_ID$' and A.HUYYEUCAU != '1'
    </statement>
    <statement id="DAO00119_TT_NOITRU_TOATHUOC_GetList_BenhAn" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select duoc.MADUOC MADICHVU, duoc.TENDUOCDAYDU NOIDUNG, B.SOLUONG, duoc.DONVITINH,
      A.THOIGIANKHAM NGAYGIOYEUCAU, Format(A.THOIGIANKHAM, 'dd/MM/yyyy, hh:mm:ss') as THOIGIAN,
      CASE
      WHEN (B.PHIEULINH_ID is not null and B.CHUNGTU_ID is null) THEN N'Đã lập phiếu lĩnh'
      WHEN B.CHUNGTU_ID is not null  THEN N'Đã xuất thuốc'
      ELSE N'Chưa lập phiếu lĩnh'
      END TRANGTHAI,
      tt.SOLUONG SOLUONG_NGUNG,
      E.TENPHONGBAN NOIYEUCAU
      from TT_NOITRU_KHAMBENH A
      left join TT_NOITRU_TOATHUOC B on A.KHAMBENH_ID = B.KHAMBENH_ID
      left join TT_NOITRU_TRATHUOC_CHITIET tt on B.TOATHUOC_ID = tt.TOATHUOC_ID and B.DUOC_ID = tt.DUOC_ID
      left join TM_DUOC duoc on duoc.DUOC_ID = B.DUOC_ID
      left join TM_PHONGBAN E on E.PHONGBAN_ID = A.PHONGBAN_ID
      where
      A.BENHAN_ID = '$BENHAN_ID$'
    </statement>
    <statement id="DAO00119_TT_VTYT_GetList_BenhAn" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select duoc.MADUOC MADICHVU, duoc.TENDUOCDAYDU NOIDUNG, B.SOLUONG, duoc.DONVITINH,
      B.THOIGIANSUDUNG NGAYGIOYEUCAU, Format(B.THOIGIANSUDUNG, 'dd/MM/yyyy, hh:mm:ss') as THOIGIAN,
      CASE
      WHEN B.CHUNGTU_ID is not null  THEN N'Đã xuất thuốc'
      ELSE N'Chưa xuất thuốc'
      END TRANGTHAI,
      E.TENPHONGBAN NOIYEUCAU
      from TT_CLSKETQUA A
      left join TT_CLSKETQUA_VTYT B on A.CLSKETQUA_ID = B.CLSKETQUA_ID
      left join TM_DUOC duoc on duoc.DUOC_ID = B.DUOC_ID
      left join TM_PHONGBAN E on E.PHONGBAN_ID = B.PHONGBAN_ID
      where A.BENHAN_ID = '$BENHAN_ID$' and B.CLSKETQUA_VTYT_ID is not null
      union
      select duoc.MADUOC MADICHVU, duoc.TENDUOCDAYDU NOIDUNG, B.SOLUONG, duoc.DONVITINH,
      B.NGAYSUDUNG NGAYGIOYEUCAU, Format(B.NGAYSUDUNG, 'dd/MM/yyyy, hh:mm:ss') as THOIGIAN,
      CASE
      WHEN B.CHUNGTU_ID is not null  THEN N'Đã xuất thuốc'
      ELSE N'Chưa xuất thuốc'
      END TRANGTHAI,
      E.TENPHONGBAN NOIYEUCAU
      from TT_PHAUTHUAT A
      left join TT_PHAUTHUAT_VTYT B on A.PHAUTHUAT_ID = B.PHAUTHUAT_ID
      left join TM_DUOC duoc on duoc.DUOC_ID = B.DUOC_ID
      left join TM_PHONGBAN E on E.PHONGBAN_ID = A.PHONGBANTHUCHIEN_ID
      where A.BENHAN_ID = '$BENHAN_ID$' and B.PHAUTHUAT_VTYT_ID is not null
    </statement>
    <statement id="DAO00119_TT_Xuatan_GetList_BenhAn" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select C.XACNHANSUATANCHITIET_ID, A.BENHAN_ID, A.CHIDINHKHAUPHAN_ID, A.CHIDINHKHAUPHANCHITIET_ID, A.NGAYCHIDINH,
      B.TONGHOPSUATANCHITIET_ID,
      kp.MAKHAUPHANAN MADICHVU, kp.TENKHAUPHANAN NOIDUNG,
      A.NGAYCHIDINH NGAYGIOYEUCAU, Format(A.NGAYCHIDINH, 'dd/MM/yyyy, hh:mm:ss') as THOIGIAN,
      CASE
      WHEN A.CHIDINHKHAUPHANCHITIET_ID is not null and B.TONGHOPSUATANCHITIET_ID is not null and C.XACNHANSUATANCHITIET_ID is not null  THEN N'Đã xác nhận'
      WHEN A.CHIDINHKHAUPHANCHITIET_ID is not null and B.TONGHOPSUATANCHITIET_ID is not null and C.XACNHANSUATANCHITIET_ID is null  THEN N'Đã tổng hợp'
      ELSE N'Đã chỉ định'
      END TRANGTHAI,
      E.TENPHONGBAN NOIYEUCAU
      from TT_NUT_CHIDINHKHAUPHAN_CHITIET A
      left join TT_NUT_TONGHOPSUATAN_CHITIET B on A.CHIDINHKHAUPHANCHITIET_ID = B.CHIDINHKHAUPHANCHITIET_ID
      left join TT_NUT_XACNHANSUATAN_CHITIET C on C.TONGHOPSUATANCHITIET_ID = B.TONGHOPSUATANCHITIET_ID
      left join TM_NUT_KHAUPHANAN kp on kp.KHAUPHANAN_ID = A.KHAUPHANAN_ID
      left join TT_NOITRU_BENHAN D on D.BENHAN_ID = A.BENHAN_ID
      left join TM_PHONGBAN E on E.PHONGBAN_ID = D.KHOACHUYENDEN_ID
      where A.XOA != '1' and (C.HUY != '1') and A.BENHAN_ID = '$BENHAN_ID$'
    </statement>
    <statement id="DAO00119_TT_VIENPHI_GetList_BenhAnPhaiThanhToan" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      <!--dich vu yeu cau-->
      select  a.*, b.GIATRIMIENGIAM_BH, c.GIATRIMIENGIAM_BHTN, f.GIATRIMIENGIAM_THANHVIEN, g.GIATRIMIENGIAM_CTCT
      from
      (select VP.*, c.NOITHUCHIEN_ID, c.NOIYEUCAU_ID
      from TT_VIENPHI VP
      left join TT_DVYEUCAU c on c.DVYEUCAU_ID = VP.REF_ID  and vp.REF_TABLE = 'TT_DVYEUCAU'
      where Vp.BENHAN_ID = '$BENHAN_ID$' and Vp.ACTIVE = '1' and vp.KHONGTHUTIEN = '0' and ((c.HUYYEUCAU != '1' and vp.DICHVU_ID is not null) and
      (vp.DUOC_ID is null)) and
      ((vp.DATHANHTOAN = '0') or (vp.BENHNHAN_PHAITHANHTOAN > vp.GIATRI_BENHNHAN_DATHANHTOAN and vp.DATHANHTOAN = '1')) and c.DANGKY_CHITIET_ID is null
      ) a

      left join (select VIENPHI_ID,
      sum(MGCT.GIATRIMIENGIAM) AS GIATRIMIENGIAM_BH from TT_MIENGIAM MG
      INNER JOIN TT_MIENGIAM_CHITIET MGCT ON MG.MIENGIAM_ID = MGCT.MIENGIAM_ID
      where MG.BENHAN_ID = '$BENHAN_ID$' and MGCT.REF_TABLE = 'TT_MIENGIAM' and MG.TINHTRANG = 1 group by VIENPHI_ID
      ) b on a.VIENPHI_ID = b.VIENPHI_ID

      left join (select VIENPHI_ID, sum(MGCT.GIATRIMIENGIAM) AS GIATRIMIENGIAM_BHTN
      from TT_MIENGIAM_BHTN MG
      INNER JOIN TT_MIENGIAM_CHITIET MGCT ON MG.MIENGIAM_BHTN_ID = MGCT.MIENGIAM_ID
      where  MG.BENHAN_ID = '$BENHAN_ID$' and MGCT.REF_TABLE = 'TT_MIENGIAM_BHTN' and MG.TINHTRANG = 1 group by VIENPHI_ID
      )c on a.VIENPHI_ID = c.VIENPHI_ID

      left join (select VIENPHI_ID, sum(MGCT.GIATRIMIENGIAM) AS GIATRIMIENGIAM_THANHVIEN
      from TT_MIENGIAM_THANHVIEN MG
      INNER JOIN TT_MIENGIAM_CHITIET MGCT ON MG.MIENGIAM_THANHVIEN_ID = MGCT.MIENGIAM_ID
      where MG.TIEPNHAN_ID = '$TIEPNHAN_ID$' and MGCT.REF_TABLE = 'TT_MIENGIAM_THANHVIEN' and MG.TINHTRANG = 1 group by VIENPHI_ID
      )f on a.VIENPHI_ID = f.VIENPHI_ID

      left join(select VIENPHI_ID, sum(MGCT.GIATRIMIENGIAM) AS GIATRIMIENGIAM_CTCT
      from TT_MIENGIAM_CONGTY MG
      INNER JOIN TT_MIENGIAM_CHITIET MGCT ON MG.MIENGIAM_CONGTY_ID = MGCT.MIENGIAM_ID
      where MG.BENHAN_ID = '$BENHAN_ID$' and MGCT.REF_TABLE = 'TT_MIENGIAM_CONGTY' and MG.TINHTRANG = 1 group by VIENPHI_ID
      )g on a.VIENPHI_ID = g.VIENPHI_ID

      union
      <!--thuoc-->
      select  a.*, b.GIATRIMIENGIAM_BH, c.GIATRIMIENGIAM_BHTN, f.GIATRIMIENGIAM_THANHVIEN, g.GIATRIMIENGIAM_CTCT
      from
      (select VP.*, nttt.PHONGBANRATOA_ID NOITHUCHIEN_ID, nttt.PHONGBANRATOA_ID NOIYEUCAU_ID
      from TT_VIENPHI VP
      left join TT_NOITRU_TOATHUOC nttt on nttt.TOATHUOC_ID = vp.REF_ID and vp.REF_TABLE = 'TT_NOITRU_TOATHUOC'
      where Vp.BENHAN_ID = '$BENHAN_ID$' and Vp.ACTIVE = '1' and vp.DICHVU_ID is null and
      vp.DUOC_ID is not null and REF_TABLE = 'TT_NOITRU_TOATHUOC' and
      ((vp.DATHANHTOAN = '0') or (vp.BENHNHAN_PHAITHANHTOAN > vp.GIATRI_BENHNHAN_DATHANHTOAN and vp.DATHANHTOAN = '1'))
      and (VP.KHONGTHUTIEN = '0' or VP.KHONGTHUTIEN is null)  and vp.REF_ID > 0 and vp.SOLUONG > 0) a
      <!--inner join TT_NOITRU_TOATHUOC nttt ON nttt.TOATHUOC_ID = a.REF_ID and nttt.DUOC_ID = a.DUOC_ID-->

      left join (select VIENPHI_ID,
      sum(MGCT.GIATRIMIENGIAM) AS GIATRIMIENGIAM_BH from TT_MIENGIAM MG
      INNER JOIN TT_MIENGIAM_CHITIET MGCT ON MG.MIENGIAM_ID = MGCT.MIENGIAM_ID
      where MG.BENHAN_ID = '$BENHAN_ID$' and MGCT.REF_TABLE = 'TT_MIENGIAM' and MG.TINHTRANG = 1 group by VIENPHI_ID
      ) b on a.VIENPHI_ID = b.VIENPHI_ID

      left join (select VIENPHI_ID, sum(MGCT.GIATRIMIENGIAM) AS GIATRIMIENGIAM_BHTN
      from TT_MIENGIAM_BHTN MG
      INNER JOIN TT_MIENGIAM_CHITIET MGCT ON MG.MIENGIAM_BHTN_ID = MGCT.MIENGIAM_ID
      where  MG.BENHAN_ID = '$BENHAN_ID$' and MGCT.REF_TABLE = 'TT_MIENGIAM_BHTN' and MG.TINHTRANG = 1 group by VIENPHI_ID
      )c on a.VIENPHI_ID = c.VIENPHI_ID

      left join (select VIENPHI_ID, sum(MGCT.GIATRIMIENGIAM) AS GIATRIMIENGIAM_THANHVIEN
      from TT_MIENGIAM_THANHVIEN MG
      INNER JOIN TT_MIENGIAM_CHITIET MGCT ON MG.MIENGIAM_THANHVIEN_ID = MGCT.MIENGIAM_ID
      where MG.TIEPNHAN_ID = '$TIEPNHAN_ID$' and MGCT.REF_TABLE = 'TT_MIENGIAM_THANHVIEN' and MG.TINHTRANG = 1 group by VIENPHI_ID
      )f on a.VIENPHI_ID = f.VIENPHI_ID

      left join(select VIENPHI_ID, sum(MGCT.GIATRIMIENGIAM) AS GIATRIMIENGIAM_CTCT
      from TT_MIENGIAM_CONGTY MG
      INNER JOIN TT_MIENGIAM_CHITIET MGCT ON MG.MIENGIAM_CONGTY_ID = MGCT.MIENGIAM_ID
      where MG.BENHAN_ID = '$BENHAN_ID$' and MGCT.REF_TABLE = 'TT_MIENGIAM_CONGTY' and MG.TINHTRANG = 1 group by VIENPHI_ID
      )g on a.VIENPHI_ID = g.VIENPHI_ID

      union
      <!--Xuất ăn-->
      select  a.*, b.GIATRIMIENGIAM_BH, c.GIATRIMIENGIAM_BHTN, f.GIATRIMIENGIAM_THANHVIEN, g.GIATRIMIENGIAM_CTCT
      from
      (select VP.*, c.KHOACHUYENDEN_ID NOITHUCHIEN_ID, c.KHOACHUYENDEN_ID NOIYEUCAU_ID
      from TT_VIENPHI VP
      left join TT_NOITRU_BENHAN c on c.BENHAN_ID = VP.BENHAN_ID
      where Vp.BENHAN_ID = '$BENHAN_ID$' and Vp.ACTIVE = '1' and vp.DUOC_ID is null and REF_TABLE = 'TT_NUT_XACNHANSUATAN_CHITIET' and
      ((vp.DATHANHTOAN = '0') or (vp.BENHNHAN_PHAITHANHTOAN > vp.GIATRI_BENHNHAN_DATHANHTOAN and vp.DATHANHTOAN = '1'))
      and VP.KHONGTHUTIEN != '1') a

      left join (select VIENPHI_ID,
      sum(MGCT.GIATRIMIENGIAM) AS GIATRIMIENGIAM_BH from TT_MIENGIAM MG
      INNER JOIN TT_MIENGIAM_CHITIET MGCT ON MG.MIENGIAM_ID = MGCT.MIENGIAM_ID
      where MG.BENHAN_ID = '$BENHAN_ID$' and MGCT.REF_TABLE = 'TT_MIENGIAM' and MG.TINHTRANG = 1 group by VIENPHI_ID
      ) b on a.VIENPHI_ID = b.VIENPHI_ID

      left join (select VIENPHI_ID, sum(MGCT.GIATRIMIENGIAM) AS GIATRIMIENGIAM_BHTN
      from TT_MIENGIAM_BHTN MG
      INNER JOIN TT_MIENGIAM_CHITIET MGCT ON MG.MIENGIAM_BHTN_ID = MGCT.MIENGIAM_ID
      where  MG.BENHAN_ID = '$BENHAN_ID$' and MGCT.REF_TABLE = 'TT_MIENGIAM_BHTN' and MG.TINHTRANG = 1 group by VIENPHI_ID
      )c on a.VIENPHI_ID = c.VIENPHI_ID

      left join (select VIENPHI_ID, sum(MGCT.GIATRIMIENGIAM) AS GIATRIMIENGIAM_THANHVIEN
      from TT_MIENGIAM_THANHVIEN MG
      INNER JOIN TT_MIENGIAM_CHITIET MGCT ON MG.MIENGIAM_THANHVIEN_ID = MGCT.MIENGIAM_ID
      where MG.TIEPNHAN_ID = '$TIEPNHAN_ID$' and MGCT.REF_TABLE = 'TT_MIENGIAM_THANHVIEN' and MG.TINHTRANG = 1 group by VIENPHI_ID
      )f on a.VIENPHI_ID = f.VIENPHI_ID

      left join(select VIENPHI_ID, sum(MGCT.GIATRIMIENGIAM) AS GIATRIMIENGIAM_CTCT
      from TT_MIENGIAM_CONGTY MG
      INNER JOIN TT_MIENGIAM_CHITIET MGCT ON MG.MIENGIAM_CONGTY_ID = MGCT.MIENGIAM_ID
      where MG.BENHAN_ID = '$BENHAN_ID$' and MGCT.REF_TABLE = 'TT_MIENGIAM_CONGTY' and MG.TINHTRANG = 1 group by VIENPHI_ID
      )g on a.VIENPHI_ID = g.VIENPHI_ID

      union
      <!--thuoc, vtyt khac-->
      select  a.*, b.GIATRIMIENGIAM_BH, c.GIATRIMIENGIAM_BHTN, f.GIATRIMIENGIAM_THANHVIEN, g.GIATRIMIENGIAM_CTCT
      from
      (select VP.*, 0 NOITHUCHIEN_ID, 0 NOIYEUCAU_ID
      from TT_VIENPHI VP
      left join TT_PHAUTHUAT_VTYT D on VP.REF_ID = D.PHAUTHUAT_VTYT_ID and VP.REF_TABLE = 'TT_PHAUTHUAT_VTYT'
      left join TT_CLSKETQUA_VTYT E on VP.REF_ID = E.CLSKETQUA_VTYT_ID and VP.REF_TABLE = 'TT_CLSKETQUA_VTYT'
      left join TT_NGOAITRU_KHAMBENH_VTYT KB on VP.REF_ID = KB.KHAMBENH_VTYT_ID and VP.REF_TABLE = 'TT_NGOAITRU_KHAMBENH_VTYT'
      where Vp.BENHAN_ID = '$BENHAN_ID$' and Vp.ACTIVE = '1' and vp.DICHVU_ID is null and
      REF_TABLE not in ('TT_NOITRU_TOATHUOC', 'TT_NUT_XACNHANSUATAN_CHITIET', 'TT_DVYEUCAU') and
      ((vp.DUOC_ID is not null and D.PHAUTHUAT_VTYT_ID is not null and vp.REF_TABLE = 'TT_PHAUTHUAT_VTYT') or
      (vp.DUOC_ID is not null and E.CLSKETQUA_VTYT_ID is not null and vp.REF_TABLE = 'TT_CLSKETQUA_VTYT') or
      (vp.DUOC_ID is not null and KB.KHAMBENH_VTYT_ID is not null and vp.REF_TABLE = 'TT_NGOAITRU_KHAMBENH_VTYT')) and
      ((vp.DATHANHTOAN = '0') or (vp.BENHNHAN_PHAITHANHTOAN > vp.GIATRI_BENHNHAN_DATHANHTOAN and vp.DATHANHTOAN = '1'))
      and (VP.KHONGTHUTIEN = '0' or VP.KHONGTHUTIEN is null)) a

      left join (select VIENPHI_ID,
      sum(MGCT.GIATRIMIENGIAM) AS GIATRIMIENGIAM_BH from TT_MIENGIAM MG
      INNER JOIN TT_MIENGIAM_CHITIET MGCT ON MG.MIENGIAM_ID = MGCT.MIENGIAM_ID
      where MG.BENHAN_ID = '$BENHAN_ID$' and MGCT.REF_TABLE = 'TT_MIENGIAM' and MG.TINHTRANG = 1 group by VIENPHI_ID
      ) b on a.VIENPHI_ID = b.VIENPHI_ID

      left join (select VIENPHI_ID, sum(MGCT.GIATRIMIENGIAM) AS GIATRIMIENGIAM_BHTN
      from TT_MIENGIAM_BHTN MG
      INNER JOIN TT_MIENGIAM_CHITIET MGCT ON MG.MIENGIAM_BHTN_ID = MGCT.MIENGIAM_ID
      where  MG.BENHAN_ID = '$BENHAN_ID$' and MGCT.REF_TABLE = 'TT_MIENGIAM_BHTN' and MG.TINHTRANG = 1 group by VIENPHI_ID
      )c on a.VIENPHI_ID = c.VIENPHI_ID

      left join (select VIENPHI_ID, sum(MGCT.GIATRIMIENGIAM) AS GIATRIMIENGIAM_THANHVIEN
      from TT_MIENGIAM_THANHVIEN MG
      INNER JOIN TT_MIENGIAM_CHITIET MGCT ON MG.MIENGIAM_THANHVIEN_ID = MGCT.MIENGIAM_ID
      where MG.TIEPNHAN_ID = '$TIEPNHAN_ID$' and MGCT.REF_TABLE = 'TT_MIENGIAM_THANHVIEN' and MG.TINHTRANG = 1 group by VIENPHI_ID
      )f on a.VIENPHI_ID = f.VIENPHI_ID

      left join(select VIENPHI_ID, sum(MGCT.GIATRIMIENGIAM) AS GIATRIMIENGIAM_CTCT
      from TT_MIENGIAM_CONGTY MG
      INNER JOIN TT_MIENGIAM_CHITIET MGCT ON MG.MIENGIAM_CONGTY_ID = MGCT.MIENGIAM_ID
      where MG.BENHAN_ID = '$BENHAN_ID$' and MGCT.REF_TABLE = 'TT_MIENGIAM_CONGTY' and MG.TINHTRANG = 1 group by VIENPHI_ID
      )g on a.VIENPHI_ID = g.VIENPHI_ID

      where KHONGTHUTIEN = '0' and REF_ID != 0
    </statement>
    <statement id="DAO00119_TT_VIENPHI_GetList_BenhAnPhaiThanhToanWithVienPhiId" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select  a.*, b.GIATRIMIENGIAM_BH, c.GIATRIMIENGIAM_BHTN, f.GIATRIMIENGIAM_THANHVIEN, g.GIATRIMIENGIAM_CTCT
      from
      (select VP.*, c.NOITHUCHIEN_ID, c.NOIYEUCAU_ID
      from TT_VIENPHI VP
      left join TT_DVYEUCAU c on c.DVYEUCAU_ID = VP.REF_ID  and vp.REF_TABLE = 'TT_DVYEUCAU'
      where Vp.BENHAN_ID = '$BENHAN_ID$' and Vp.ACTIVE = '1' and ((c.HUYYEUCAU != '1' and vp.DICHVU_ID is not null) or (vp.DUOC_ID is not null)  or (REF_TABLE = 'TT_NUT_XACNHANSUATAN_CHITIET')) and
      ((vp.DATHANHTOAN = '0') or (vp.BENHNHAN_PHAITHANHTOAN > vp.GIATRI_BENHNHAN_DATHANHTOAN and vp.DATHANHTOAN = '1')) and c.DANGKY_CHITIET_ID is null
      and vp.VIENPHI_ID in ($LIST_VIENPHI$)) a

      left join (select VIENPHI_ID,
      sum(MGCT.GIATRIMIENGIAM) AS GIATRIMIENGIAM_BH from TT_MIENGIAM MG
      INNER JOIN TT_MIENGIAM_CHITIET MGCT ON MG.MIENGIAM_ID = MGCT.MIENGIAM_ID
      where MG.TIEPNHAN_ID= '$TIEPNHAN_ID$' and MGCT.REF_TABLE = 'TT_MIENGIAM' and MG.TINHTRANG = 1 group by VIENPHI_ID
      ) b on a.VIENPHI_ID = b.VIENPHI_ID

      left join (select VIENPHI_ID, sum(MGCT.GIATRIMIENGIAM) AS GIATRIMIENGIAM_BHTN
      from TT_MIENGIAM_BHTN MG
      INNER JOIN TT_MIENGIAM_CHITIET MGCT ON MG.MIENGIAM_BHTN_ID = MGCT.MIENGIAM_ID
      where  MG.TIEPNHAN_ID= '$TIEPNHAN_ID$' and MGCT.REF_TABLE = 'TT_MIENGIAM_BHTN' and MG.TINHTRANG = 1 group by VIENPHI_ID
      )c on a.VIENPHI_ID = c.VIENPHI_ID

      left join (select VIENPHI_ID, sum(MGCT.GIATRIMIENGIAM) AS GIATRIMIENGIAM_THANHVIEN
      from TT_MIENGIAM_THANHVIEN MG
      INNER JOIN TT_MIENGIAM_CHITIET MGCT ON MG.MIENGIAM_THANHVIEN_ID = MGCT.MIENGIAM_ID
      where MG.TIEPNHAN_ID = '$TIEPNHAN_ID$' and MGCT.REF_TABLE = 'TT_MIENGIAM_THANHVIEN' and MG.TINHTRANG = 1 group by VIENPHI_ID
      )f on a.VIENPHI_ID = f.VIENPHI_ID

      left join(select VIENPHI_ID, sum(MGCT.GIATRIMIENGIAM) AS GIATRIMIENGIAM_CTCT
      from TT_MIENGIAM_CONGTY MG
      INNER JOIN TT_MIENGIAM_CHITIET MGCT ON MG.MIENGIAM_CONGTY_ID = MGCT.MIENGIAM_ID
      where MG.TIEPNHAN_ID= '$TIEPNHAN_ID$' and MGCT.REF_TABLE = 'TT_MIENGIAM_CONGTY' and MG.TINHTRANG = 1 group by VIENPHI_ID
      )g on a.VIENPHI_ID = g.VIENPHI_ID
    </statement>
    <statement id="DAO00119_TT_VIENPHI_GetList_TiepNhanByHoadon" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select  a.*, a.MIENGIAM_GIATRI as GIATRIMIENGIAM_BH, a.BHTN_GIATRI as GIATRIMIENGIAM_BHTN, a.HOIVIEN_GIATRI as GIATRIMIENGIAM_THANHVIEN, a.CONGTYCHITRA_GIATRI as GIATRIMIENGIAM_CTCT,
      isnull(dv.TENDICHVU, dc.TENDUOCDAYDU) NOIDUNG, isnull(dv.MADICHVU, dc.MADUOC) MADICHVU, dv.NORESULT, dc.DONVITINH, ld.MALOAIDUOC, dc.BHYT DUOC_BHYT, ld.LOAIVATTU_ID, ndv.MANHOMDICHVU
      from
      (select
      vp.HOADONCHITIET_ID, vp.HOADON_ID, vp.VIENPHI_ID, vp.REF_ID, vp.REF_TABLE, vp.DICHVU_ID, vp.DUOC_ID
      , vp.LOAI_CHIPHI, vp.LOAIGIA_ID, vp.SOLUONG, vp.DONGIA_DOANHTHU, vp.THANHTIEN_DOANHTHU, vp.BHYT_TL, vpp.BHYT_DONGIA, vpp.BHYT_THANHTIEN, vpp.BHYT_DONGIA_CHITRA
      , vp.BHYT_THANHTIEN_CHITRA, vp.BENHNHAN_PHAITHANHTOAN, vp.GIATRI_HOADON, vp.GIATRI_HOADON_DATHANHTOAN, vp.GIATRI_BIENLAI
      , vp.GIATRI_BIENLAI_DATHANHTOAN, vp.GIATRI_BENHNHAN_DATHANHTOAN, vp.TYLE_THATTHU, vp.GIATRI_THATTHU, vp.MIENGIAM_TL, vp.MIENGIAM_GIATRI, vp.NGANSACH_TL, vp.NGANSACH_GIATRI
      , vp.TAITRO_TL, vp.TAITRO_GIATRI, vp.BHTN_GIATRI, vp.NOIDUNGTHU, vp.CHUNGTUXUATBN_ID, vp.TYLEVAT, vp.GIATRIVAT, vp.MASOTHUE, vp.SOCHUNGTUKETOAN, vp.DAHOANTRA, c.TRANGTHAI
      , vp.PHONGBAN_ID, vp.PHONGBAN_THAYDOI_ID, vp.CONGTYCHITRA_GIATRI, vp.HOIVIEN_GIATRI, vp.BENHVIEN_ID, isnull(c.NGAYGIOYEUCAU, vp.NGAYTAO) NGAYTAO, vp.NGUOITAO_ID, vp.NGAYCAPNHAT, vp.NGUOICAPNHAT_ID
      , c.NOITHUCHIEN_ID, c.NOIYEUCAU_ID, vpp.DATHUCHIEN, vpp.TIEPNHAN_ID, vpp.BENHAN_ID
      from TT_HOADON_CHITIET_NGOAITRU VP
      left join TT_VIENPHI vpp on vpp.VIENPHI_ID = VP.VIENPHI_ID
      left join TT_DVYEUCAU c on c.DVYEUCAU_ID = VP.REF_ID
      where
      vp.HOADON_ID = '$HOADON_ID$'
      ) a
      left join TM_DUOC dc on a.DUOC_ID = dc.DUOC_ID
      left join TM_LOAIDUOC ld on dc.LOAIDUOC_ID = ld.LOAIDUOC_ID
      left join TM_DICHVU dv on a.DICHVU_ID = dv.DICHVU_ID and a.REF_TABLE = 'TT_DVYEUCAU'
      left join TM_NHOMDICHVU ndv on ndv.NHOMDICHVU_ID = dv.NHOMDICHVU_ID
      WHERE a.REF_TABLE!='TT_MAU_CHUNGTU_CHITIET'
    </statement>
    <statement id="DAO00119_TT_VIENPHI_GetList_BenhAnByHoadon" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select  a.*, a.MIENGIAM_GIATRI as GIATRIMIENGIAM_BH, a.BHTN_GIATRI as GIATRIMIENGIAM_BHTN,
      a.HOIVIEN_GIATRI as GIATRIMIENGIAM_THANHVIEN, a.CONGTYCHITRA_GIATRI as GIATRIMIENGIAM_CTCT,
      isnull(dv.TENDICHVU, dc.TENDUOCDAYDU) NOIDUNG, isnull(dv.MADICHVU, dc.MADUOC) MADICHVU, dv.NORESULT, dc.DONVITINH, ld.MALOAIDUOC, dc.BHYT DUOC_BHYT, ld.LOAIVATTU_ID, ndv.MANHOMDICHVU
      from
      (
      select * from (
      select vp.*, c.NOITHUCHIEN_ID, c.NOIYEUCAU_ID, vpp.DATHUCHIEN, vpp.TIEPNHAN_ID, vpp.BENHAN_ID
      from TT_HOADON_CHITIET_NOITRU VP
      left join TT_VIENPHI vpp on vpp.VIENPHI_ID = VP.VIENPHI_ID
      inner join TT_DVYEUCAU c on c.DVYEUCAU_ID = VP.REF_ID and vpp.REF_TABLE = 'TT_DVYEUCAU'
      union
      select vp.*, C.PHONGBANRATOA_ID as NOITHUCHIEN_ID, D.PHONGBAN_ID NOIYEUCAU_ID, vpp.DATHUCHIEN, vpp.TIEPNHAN_ID, vpp.BENHAN_ID
      from TT_HOADON_CHITIET_NOITRU VP
      left join TT_VIENPHI vpp on vpp.VIENPHI_ID = VP.VIENPHI_ID
      inner join TT_NOITRU_TOATHUOC c on c.TOATHUOC_ID = VP.REF_ID and vpp.REF_TABLE = 'TT_NOITRU_TOATHUOC'
      inner join TT_NOITRU_KHAMBENH D on D.KHAMBENH_ID = C.KHAMBENH_ID
      union
      select vp.*, C.PHONGBAN_ID as NOITHUCHIEN_ID, C.PHONGBAN_ID as NOIYEUCAU_ID, vpp.DATHUCHIEN, vpp.TIEPNHAN_ID, vpp.BENHAN_ID
      from TT_HOADON_CHITIET_NOITRU VP
      left join TT_VIENPHI vpp on vpp.VIENPHI_ID = VP.VIENPHI_ID
      inner join TT_CLSKETQUA_VTYT c on c.CLSKETQUA_VTYT_ID = VP.REF_ID and vpp.REF_TABLE = 'TT_CLSKETQUA_VTYT'
      union
      select vp.*, ISNULL(D.PHONGBANTHUCHIEN_ID,d.PHONGBANCHIDINH_ID) as NOITHUCHIEN_ID, ISNULL(D.PHONGBANCHIDINH_ID,D.PHONGBANTHUCHIEN_ID) as NOIYEUCAU_ID, vpp.DATHUCHIEN, vpp.TIEPNHAN_ID, vpp.BENHAN_ID
      from TT_HOADON_CHITIET_NOITRU VP
      left join TT_VIENPHI vpp on vpp.VIENPHI_ID = VP.VIENPHI_ID
      inner join TT_PHAUTHUAT_VTYT c on c.PHAUTHUAT_VTYT_ID = VP.REF_ID and vpp.REF_TABLE = 'TT_PHAUTHUAT_VTYT'
      inner join TT_PHAUTHUAT D on D.PHAUTHUAT_ID = C.PHAUTHUAT_ID
      union
      select vp.*, c.PHONGBAN_ID as NOITHUCHIEN_ID, c.PHONGBAN_ID as NOIYEUCAU_ID, vpp.DATHUCHIEN, vpp.TIEPNHAN_ID, vpp.BENHAN_ID
      from TT_HOADON_CHITIET_NOITRU VP
      left join TT_VIENPHI vpp on vpp.VIENPHI_ID = VP.VIENPHI_ID
      inner join TT_NGOAITRU_KHAMBENH_VTYT c on c.KHAMBENH_VTYT_ID = VP.REF_ID and vpp.REF_TABLE = 'TT_NGOAITRU_KHAMBENH_VTYT'
      union
      select vp.*, E.PHONGBAN_ID as NOITHUCHIEN_ID, E.PHONGBAN_ID as NOIYEUCAU_ID, vpp.DATHUCHIEN, vpp.TIEPNHAN_ID, vpp.BENHAN_ID
      from TT_HOADON_CHITIET_NOITRU VP
      left join TT_VIENPHI vpp on vpp.VIENPHI_ID = VP.VIENPHI_ID
      inner join TT_NUT_XACNHANSUATAN_CHITIET XNC on XNC.XACNHANSUATANCHITIET_ID = vp.REF_ID and vpp.REF_TABLE = 'TT_NUT_XACNHANSUATAN_CHITIET'
      inner join TT_NUT_CHIDINHKHAUPHAN_CHITIET D on D.CHIDINHKHAUPHANCHITIET_ID = XNC.CHIDINHKHAUPHANCHITIET_ID
      inner join TM_NUT_KHAUPHANAN c on C.KHAUPHANAN_ID = D.KHAUPHANAN_ID
      inner join TT_NUT_CHIDINHKHAUPHAN E on E.CHIDINHKHAUPHAN_ID = D.CHIDINHKHAUPHAN_ID
      ) B
      where B.HOADON_ID = '$HOADON_ID$'
      ) a
      left join TM_DUOC dc on a.DUOC_ID = dc.DUOC_ID
      left join TM_LOAIDUOC ld on dc.LOAIDUOC_ID = ld.LOAIDUOC_ID
      left join TM_DICHVU dv on a.DICHVU_ID = dv.DICHVU_ID and a.REF_TABLE = 'TT_DVYEUCAU'
      left join TM_NHOMDICHVU ndv on ndv.NHOMDICHVU_ID = dv.NHOMDICHVU_ID
    </statement>
    <statement id="DAO00119_TT_VIENPHI_GetList_TiepNhanDaThanhToan" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select * from TT_VIENPHI
      where
      TIEPNHAN_ID = '$TIEPNHAN_ID$' and
      (BENHNHAN_PHAITHANHTOAN = GIATRI_BENHNHAN_DATHANHTOAN and DATHANHTOAN = '1')
      and VIENPHI_ID in ($LIST_VIENPHI$)
    </statement>
    <statement id="DAO00119_TT_VIENPHI_GetList_BenhAnDaThanhToan" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select * from TT_VIENPHI
      where
      TIEPNHAN_ID = '$TIEPNHAN_ID$' and BENHAN_ID = '$BENHAN_ID$' and
      (BENHNHAN_PHAITHANHTOAN = GIATRI_BENHNHAN_DATHANHTOAN and DATHANHTOAN = '1')
      and VIENPHI_ID in ($LIST_VIENPHI$)
    </statement>
    <statement id="DAO00119_TT_VIENPHI_GetList_BenhNhanDaThanhToan" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select * from TT_VIENPHI
      where
      BENHNHAN_ID = '$BENHNHAN_ID$' and
      (BENHNHAN_PHAITHANHTOAN = GIATRI_BENHNHAN_DATHANHTOAN and DATHANHTOAN = '1')
      and VIENPHI_ID in ($LIST_VIENPHI$)
    </statement>
    <statement id="DAO00119_TT_VIENPHI_GetList_DVYeuCauDaThanhToan" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select * from TT_VIENPHI vp
      where
      TIEPNHAN_ID = '$TIEPNHAN_ID$' and
      (vp.DATHANHTOAN = '1') and REF_ID in ($LIST_REFID$)
    </statement>
    <statement id="DAO00119_TT_VIENPHI_GetList_DVYeuCauDaPhatSinhMienGiam" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select * from TT_MIENGIAM_CHITIET
      where
      exists ( select VIENPHI_ID from TT_VIENPHI vp where TIEPNHAN_ID = '$TIEPNHAN_ID$'
      and REF_ID in (SELECT * FROM DBO.SPLIT('$DS_DVYEUCAU$',', ')) and REF_TABLE = 'TT_DVYEUCAU' and TT_MIENGIAM_CHITIET.VIENPHI_ID = VIENPHI_ID)
      and REF_TABLE != 'TT_MIENGIAM_THANHVIEN'
    </statement>
    <statement id="DAO00119_TT_VIENPHI_GetList_VPHienTai" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select * from TT_VIENPHI vp
      where
      ((vp.DATHANHTOAN = '0') or (vp.BENHNHAN_PHAITHANHTOAN > vp.GIATRI_BENHNHAN_DATHANHTOAN and vp.DATHANHTOAN = '1'))
      and VIENPHI_ID in ($LIST_VIENPHI$)
      <isNotEmpty prepend="and" property="TIEPNHAN_ID">
        TIEPNHAN_ID = '$TIEPNHAN_ID$'
      </isNotEmpty>
      <isNotEmpty prepend="and" property="BENHNHAN_ID">
        BENHNHAN_ID = '$BENHNHAN_ID$' and REF_TABLE in ('TT_CSKH_GOI_DANGKY', 'TT_CSKH_THANHVIEN_CAPTHE')
      </isNotEmpty>
    </statement>
    <statement id="DAO00119_TT_VIENPHI_GetList_VPHienTai_MuaNgoaiTT" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select * from TT_VIENPHI vp
      where
      ((vp.DATHANHTOAN = '0') or (vp.BENHNHAN_PHAITHANHTOAN > vp.GIATRI_BENHNHAN_DATHANHTOAN and vp.DATHANHTOAN = '1'))
      and VIENPHI_ID in ($LIST_VIENPHI$)
      <!--<isNotEmpty prepend="and" property="TIEPNHAN_ID">
        TIEPNHAN_ID = '$TIEPNHAN_ID$'
      </isNotEmpty>
      <isNotEmpty prepend="and" property="BENHNHAN_ID">
        BENHNHAN_ID = '$BENHNHAN_ID$' and REF_TABLE in ('TT_DUOC_CHUNGTU_CHITIET')
      </isNotEmpty>-->
    </statement>
    <statement id="DAO00119_TT_VIENPHI_GetList_TiepNhanChuaMienGiamBHTN" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select A.* from
      TT_MIENGIAM_BHTN A
      left join TT_MIENGIAM_CHITIET B on B.MIENGIAM_ID = A.MIENGIAM_BHTN_ID and B.REF_TABLE = 'TT_MIENGIAM_BHTN'
      where  A.TINHTRANG = '0' and B.VIENPHI_ID in ($LIST_VIENPHI$) and A.TIEPNHAN_ID = '$TIEPNHAN_ID$'
    </statement>
    <statement id="DAO00119_TT_VIENPHI_GetList_TiepNhanDaThucHien" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select * from TT_VIENPHI
      where
      (DATHUCHIEN = '0' or DICHVU_ID is null) and VIENPHI_ID in ($LIST_VIENPHI$)
      <isNotEmpty prepend="and" property="TIEPNHAN_ID">
        TIEPNHAN_ID = '$TIEPNHAN_ID$'
      </isNotEmpty>
      <isNotEmpty prepend="and" property="BENHNHAN_ID">
        BENHNHAN_ID = '$BENHNHAN_ID$' and REF_TABLE in ('TT_CSKH_GOI_DANGKY', 'TT_CSKH_THANHVIEN_CAPTHE')
      </isNotEmpty>
    </statement>
    <statement id="DAO00119_TT_VIENPHI_GetList_DVDaLayMau" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select A.* from TT_VIENPHI A
      left join TT_DVYEUCAU B on A.REF_ID = B.DVYEUCAU_ID
      where
      A.HOADON_ID = '$HOADON_ID$' and A.DATHUCHIEN = '0' and A.VIENPHI_ID in ($LIST_VIENPHI$) and A.REF_TABLE = 'TT_DVYEUCAU' and B.TRANGTHAI = 'DALAYMAU'
      <isNotEmpty prepend="and" property="TIEPNHAN_ID">
        A.TIEPNHAN_ID = '$TIEPNHAN_ID$'
      </isNotEmpty>
    </statement>
    <statement id="DAO00119_KiemtraTiepnhanCoTrongBenhanNT" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select count(*) TOTAL_ROWS from TT_NOITRU_BENHAN where TIEPNHAN_ID = #TIEPNHAN_ID#
    </statement>
    <statement id="DAO00119_TT_VIENPHI_GetList_SauKhiHuyThuThay" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select A.* from TT_VIENPHI A
      where A.VIENPHI_ID in ($LIST_VIENPHI$)
      <isNotEmpty prepend="and" property="TIEPNHAN_ID">
        A.TIEPNHAN_ID = '$TIEPNHAN_ID$'
      </isNotEmpty>
    </statement>
    <statement id="DAO00119_TT_VIENPHI_XoaBienLaiTamNgoaiTru" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      delete from TT_HOADON_HINHTHUCTHANHTOAN
      where HOADON_ID = '$HOADON_ID$'

      delete from TT_HOADON_CHITIET_NGOAITRU
      where HOADON_ID = '$HOADON_ID$'

      delete from TT_HOADON
      where HOADON_ID = '$HOADON_ID$' and TRANGTHAI in ('CHUATHUTIEN', 'CHODUYETCONGNO', 'CHOXACNHANTTVIDT')

      update TT_VIENPHI set HOADON_ID = null where HOADON_ID = '$HOADON_ID$'
    </statement>
    <statement id="DAO00119_TT_VIENPHI_XoaBienLaiTamNoiTru" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      delete from TT_HOADON_HINHTHUCTHANHTOAN
      where HOADON_ID = '$HOADON_ID$'

      delete from TT_HOADON_CHITIET_NOITRU
      where HOADON_ID = '$HOADON_ID$'

      delete from TT_HOADON
      where HOADON_ID = '$HOADON_ID$' and TRANGTHAI in ('CHUATHUTIEN', 'CHODUYETCONGNO', 'CHOXACNHANTTVIDT')

      update TT_VIENPHI set HOADON_ID = null where HOADON_ID = '$HOADON_ID$'
    </statement>
    <update id="DAO00119_TT_HOADON_Update_GhiNhanHuy" parameterClass="System.Collections.IDictionary">
      update TT_HOADON set
      NGUOI_GHINHANHUY_ID = #NGUOI_GHINHANHUY_ID#
      , NGUOICAPNHAT_ID = #NGUOICAPNHAT_ID#
      , THOIGIAN_GHINHANHUY = #THOIGIAN_GHINHANHUY#
      , NGAYCAPNHAT = #NGAYCAPNHAT#
      , TRANGTHAI = 'CHODUYET'
      , BENHVIEN_ID = #BENHVIEN_ID#
      , LYDOHUY_ID = #LYDOHUY_ID#
      , GHICHU = #GHICHU#
      where
      HOADON_ID in ($HOADON_ID$)
    </update>
    <statement id="DAO00119_TT_HOADON_KiemTra_DaGhiNhanHuy" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select * from TT_HOADON
      where HOADON_ID in ($HOADON_ID$) and (TRANGTHAI = 'CHODUYET' or (TRANGTHAI = 'DADUYET' and HUYHOADON = '1'))
    </statement>
    <update id="DAO00119_TT_HOADON_Update_HuyGhiNhanHuy" parameterClass="System.Collections.IDictionary">
      update TT_HOADON set
      NGUOI_GHINHANHUY_ID = null
      , NGUOICAPNHAT_ID = #NGUOICAPNHAT_ID#
      , THOIGIAN_GHINHANHUY = null
      , NGAYCAPNHAT = #NGAYCAPNHAT#
      , TRANGTHAI = 'DATHUTIEN'
      , BENHVIEN_ID = #BENHVIEN_ID#
      , LYDOHUY_ID = null
      , GHICHU = null
      where
      HOADON_ID in ($HOADON_ID$)
    </update>
    <statement id="DAO00119_TT_HOADON_Huy_BienLaiNgoaiTru" parameterClass="System.Collections.IDictionary">
      begin
      <!--update vien phi-->
      update TT_VIENPHI set TT_VIENPHI.HOADON_ID = null, TT_VIENPHI.DATHANHTOAN = '0', TT_VIENPHI.GIATRI_BIENLAI_DATHANHTOAN = 0,
      TT_VIENPHI.GIATRI_HOADON_DATHANHTOAN = 0,
      TT_VIENPHI.GIATRI_BENHNHAN_DATHANHTOAN = isnull(TT_VIENPHI.GIATRI_BENHNHAN_DATHANHTOAN,0) - hdnt.GIATRI_BENHNHAN_DATHANHTOAN,
      TT_VIENPHI.NGUOICAPNHAT_ID = #NGUOICAPNHAT_ID#, TT_VIENPHI.NGAYCAPNHAT = #NGAYCAPNHAT#
      FROM (SELECT VIENPHI_ID, GIATRI_BENHNHAN_DATHANHTOAN FROM TT_HOADON_CHITIET_NGOAITRU
      where HOADON_ID = #HOADON_ID#) hdnt
      where TT_VIENPHI.VIENPHI_ID = hdnt.VIENPHI_ID
      and (TT_VIENPHI.GIATRI_BENHNHAN_DATHANHTOAN >= hdnt.GIATRI_BENHNHAN_DATHANHTOAN)

      <!--update hoa don-->
		update TT_HOADON set
		SOHOADON = #SOHOADON#,
		HUYHOADON = #HUYHOADON#,
		HOANTRA = #HOANTRA#,
		NGUOICAPNHAT_ID = #NGUOICAPNHAT_ID#,
		NGAYCAPNHAT = #NGAYCAPNHAT#,
		THOIGIAN_HUY_HOANTRA = #NGAYCAPNHAT#,
		NGUOI_HUY_HOANTRA_ID = #NGUOICAPNHAT_ID#
		<isNotEmpty prepend="," property="LYDOHUY_ID">
        LYDOHUY_ID = '$LYDOHUY_ID$'
      </isNotEmpty>
      where HOADON_ID = $HOADON_ID$

      <!--Update các biên lai tạm ứng-->
      update TT_HOADON set
      TRANGTHAI = 'DATHUTIEN',
      NGUOICAPNHAT_ID = #NGUOICAPNHAT_ID#,
      NGAYCAPNHAT = #NGAYCAPNHAT#
      where HOADONLIENQUAN_ID = #HOADON_ID#
      end
    </statement>
    <statement id="DAO00119_TT_HOADON_Huy_BienLaiNoiTru" parameterClass="System.Collections.IDictionary">
      begin
      <!--update vien phi-->
      update TT_VIENPHI set TT_VIENPHI.HOADON_ID = null, TT_VIENPHI.DATHANHTOAN = '0', TT_VIENPHI.GIATRI_BIENLAI_DATHANHTOAN = 0,
      TT_VIENPHI.GIATRI_HOADON_DATHANHTOAN = 0,
      TT_VIENPHI.GIATRI_BENHNHAN_DATHANHTOAN = isnull(TT_VIENPHI.GIATRI_BENHNHAN_DATHANHTOAN,0) - hdnt.GIATRI_BENHNHAN_DATHANHTOAN,
      TT_VIENPHI.NGUOICAPNHAT_ID = #NGUOICAPNHAT_ID#, TT_VIENPHI.NGAYCAPNHAT = #NGAYCAPNHAT#
      FROM (SELECT VIENPHI_ID, GIATRI_BENHNHAN_DATHANHTOAN FROM TT_HOADON_CHITIET_NOITRU
      where HOADON_ID = #HOADON_ID#) hdnt
      where TT_VIENPHI.VIENPHI_ID = hdnt.VIENPHI_ID and TT_VIENPHI.GIATRI_BENHNHAN_DATHANHTOAN >= hdnt.GIATRI_BENHNHAN_DATHANHTOAN

      <!--update hoa don-->
		update TT_HOADON set
		SOHOADON = #SOHOADON#,
		HUYHOADON = '$HUYHOADON$',
		HOANTRA = '$HOANTRA$',
		NGUOICAPNHAT_ID = #NGUOICAPNHAT_ID#,
		NGAYCAPNHAT = #NGAYCAPNHAT#,
		THOIGIAN_HUY_HOANTRA = #NGAYCAPNHAT#,
		NGUOI_HUY_HOANTRA_ID = #NGUOICAPNHAT_ID#
		where HOADON_ID = $HOADON_ID$

		<!--Update các biên lai tạm ứng-->
      update TT_HOADON set
      TRANGTHAI = 'DATHUTIEN',
      NGUOICAPNHAT_ID = #NGUOICAPNHAT_ID#,
      NGAYCAPNHAT = #NGAYCAPNHAT#
      where HOADONLIENQUAN_ID = #HOADON_ID#

      end
    </statement>
    <statement id="DAO00119_TT_HOADON_Huy_BienLaiNoiTru_ThuDichvu" parameterClass="System.Collections.IDictionary">
      <!--update vien phi-->
		begin
		update TT_VIENPHI set TT_VIENPHI.HOADON_ID = null, TT_VIENPHI.DATHANHTOAN = '0',
		TT_VIENPHI.GIATRI_BENHNHAN_DATHANHTOAN = TT_VIENPHI.GIATRI_BENHNHAN_DATHANHTOAN - hdnt.GIATRI_BENHNHAN_DATHANHTOAN,
		TT_VIENPHI.NGUOICAPNHAT_ID = #NGUOICAPNHAT_ID#, TT_VIENPHI.NGAYCAPNHAT = #NGAYCAPNHAT#
		FROM (SELECT VIENPHI_ID, GIATRI_BENHNHAN_DATHANHTOAN FROM TT_HOADON_CHITIET_NOITRU
		where HOADON_ID = #HOADON_ID#) hdnt
		where TT_VIENPHI.VIENPHI_ID = hdnt.VIENPHI_ID

		update TT_HOADON set SOHOADON = #SOHOADON#,HUYHOADON = '$HUYHOADON$', HOANTRA = '$HOANTRA$',
		NGUOICAPNHAT_ID = #NGUOICAPNHAT_ID#,  NGAYCAPNHAT = #NGAYCAPNHAT#
		where HOADON_ID = #HOADON_ID#
		end
	</statement>
    <statement id="DAO00119_TT_HOADON_GetDanhSachHoaDonThanhToanDaDuyetHuyNgoaiTru" parameterClass="System.Collections.IDictionary"  resultClass="DataObject">
      <!--select *
      from TT_HOADON
      where
      TIEPNHAN_ID = '$TIEPNHAN_ID$' and BENHAN_ID is null and DATHANHTOAN = '1' and HUYHOADON = '0'-->
      select distinct A.*
      from TT_HOADON A
      inner join TT_TIEPNHAN tn on tn.TIEPNHAN_ID = a.TIEPNHAN_ID
      inner join TM_DOITUONG dt on dt.DOITUONG_ID = tn.DOITUONG_ID
      left join TT_HOADON_CHITIET_NGOAITRU B on A.HOADON_ID = B.HOADON_ID
      where
      A.TIEPNHAN_ID = '$TIEPNHAN_ID$' and A.BENHAN_ID is null and A.DATHANHTOAN = '1' and A.HUYHOADON = '0'
      and B.REF_TABLE not in ('TT_CSKH_GOI_DANGKY', 'TT_CSKH_THANHVIEN_CAPTHE', 'TT_DUOC_CHUNGTU_CHITIET')
      and dt.MADOITUONG != 'VP'
    </statement>
    <statement id="DAO00119_TT_HOADON_GetHoaDonThanhToanDaDuyetHuyNgoaiTru" parameterClass="System.Collections.IDictionary"  resultClass="DataObject">
      select distinct A.*
      from TT_HOADON A
      inner join TT_TIEPNHAN tn on tn.TIEPNHAN_ID = a.TIEPNHAN_ID
      inner join TM_DOITUONG dt on dt.DOITUONG_ID = tn.DOITUONG_ID
      left join TT_HOADON_CHITIET_NGOAITRU B on A.HOADON_ID = B.HOADON_ID
      where
      A.TIEPNHAN_ID = '$TIEPNHAN_ID$' and A.BENHAN_ID is null and A.DATHANHTOAN = '1' and A.HUYHOADON = '0'
      and B.REF_TABLE not in ('TT_CSKH_GOI_DANGKY', 'TT_CSKH_THANHVIEN_CAPTHE', 'TT_DUOC_CHUNGTU_CHITIET')
      and dt.MADOITUONG != 'VP'
      and CONVERT(Date,A.NGAYPHATSINH) = CONVERT(Date,GETDATE())
      and A.NGUOITAO_ID = '$NGUOITAO_ID$'
    </statement>
    <statement id="DAO00119_TT_HOADON_GetHoaDonThanhToanDaDuyetHoanTraNgoaiTru" parameterClass="System.Collections.IDictionary"  resultClass="DataObject">
      select distinct A.*
      from TT_HOADON A
      inner join TT_TIEPNHAN tn on tn.TIEPNHAN_ID = a.TIEPNHAN_ID
      inner join TM_DOITUONG dt on dt.DOITUONG_ID = tn.DOITUONG_ID
      left join TT_HOADON_CHITIET_NGOAITRU B on A.HOADON_ID = B.HOADON_ID
      where
      A.TIEPNHAN_ID = '$TIEPNHAN_ID$' and A.BENHAN_ID is null and A.DATHANHTOAN = '1' and A.HOANTRA = '0'
      and B.REF_TABLE not in ('TT_CSKH_GOI_DANGKY', 'TT_CSKH_THANHVIEN_CAPTHE', 'TT_DUOC_CHUNGTU_CHITIET')
      and dt.MADOITUONG != 'VP'
      and (CONVERT(Date,A.NGAYPHATSINH) != CONVERT(Date,GETDATE()) or A.NGUOITAO_ID != '$NGUOITAO_ID$')
    </statement>

    <statement id="DAO00119_TT_NOITRU_BENHAN_Update_TrangThai" parameterClass="System.Collections.IDictionary"  resultClass="DataObject">
      update TT_NOITRU_BENHAN
      set
      TRANGTHAI = '$TRANGTHAI$'
      , NGAYCAPNHAT = getdate()
      , NGUOICAPNHAT_ID = #NGUOICAPNHAT_ID#
      where TIEPNHAN_ID = '$TIEPNHAN_ID$'
      <isNotEmpty prepend="AND" property="BENHAN_ID">
        BENHAN_ID = '$BENHAN_ID$'
      </isNotEmpty>
    </statement>

    <statement id="DAO00119_GetDanhSachDichVuChuaThanhToan" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select    VP.*
      FROM TT_NGOAITRU_KHAMBENH_TOATHUOC KBTT
      inner join TT_NGOAITRU_TOATHUOC TT on  TT.KHAMBENH_TOATHUOC_ID = KBTT.KHAMBENH_TOATHUOC_ID
      inner join TT_VIENPHI VP on (TT.TOATHUOC_ID = VP.REF_ID AND VP.REF_TABLE = 'TT_NGOAITRU_TOATHUOC')
      where
      KBTT.CHUNGTUPHATTHUOC_ID = '$CHUNGTU_ID$'
      and KBTT.BENHVIEN_ID = '$BENHVIEN_ID$'
      AND (vp.DATHANHTOAN = '0'
      or ( vp.DATHANHTOAN = '1' and vp.HUY = '1')
      )
      union
      select    VP.*
      FROM TT_NOITRU_KHAMBENH KBTT
      inner join TT_NOITRU_TOATHUOC TT on  TT.KHAMBENH_ID = KBTT.KHAMBENH_ID
      inner join TT_VIENPHI VP on (TT.TOATHUOC_ID = VP.REF_ID AND VP.REF_TABLE = 'TT_NOITRU_TOATHUOC')
      where
      TT.CHUNGTU_ID = '$CHUNGTU_ID$'
      and KBTT.BENHVIEN_ID = '$BENHVIEN_ID$'
      AND (vp.DATHANHTOAN = '0'
      or ( vp.DATHANHTOAN = '1' and vp.HUY = '1')
      )
    </statement>
    <statement id="DAO00119_TT_NOITRU_XACNHAN_CHIPHI_Update_TrangThai" parameterClass="System.Collections.IDictionary"  resultClass="DataObject">
      update TT_NOITRU_XACNHAN_CHIPHI
      set
      TRANGTHAI = '$TRANGTHAI$'
      <isNotEmpty prepend="," property="NGAYHUYXACNHAN">
        NGAYHUYXACNHAN = #NGAYHUYXACNHAN#
      </isNotEmpty>
      <isNotEmpty prepend="," property="NGAYXACNHAN">
        NGAYXACNHAN = #NGAYXACNHAN#
      </isNotEmpty>
      , NGAYCAPNHAT = getdate()
      , NGUOICAPNHAT_ID = #NGUOICAPNHAT_ID#
      where TIEPNHAN_ID = '$TIEPNHAN_ID$'
    </statement>
    <statement id="DAO00119_TT_NOITRU_XACNHAN_CHIPHI_Insert" parameterClass="System.Collections.IDictionary"  resultClass="DataObject">
      insert
      TT_NOITRU_XACNHAN_CHIPHI
      (
      BENHAN_ID
      , TIEPNHAN_ID
      , BENHNHAN_ID
      , TRANGTHAI
      , NGAYXACNHAN
      , NGAYTAO
      , NGUOITAO_ID
      , NGAYCAPNHAT
      , NGUOICAPNHAT_ID
      )
      values
      (
      #BENHAN_ID#
      , #TIEPNHAN_ID#
      , #BENHNHAN_ID#
      , #TRANGTHAI#
      , getdate()
      , getdate()
      , #NGUOITAO_ID#
      , getdate()
      , #NGUOITAO_ID#
      )
      SELECT SCOPE_IDENTITY()
    </statement>
    <statement id="DAO00119_TT_NOITRU_XACNHAN_CHIPHI_Select" parameterClass="System.Collections.IDictionary"  resultClass="DataObject">
      select * from TT_NOITRU_XACNHAN_CHIPHI
      where TIEPNHAN_ID = '$TIEPNHAN_ID$'
    </statement>
    <statement id="DAO00119_TT_NOITRU_BENHAN_VP_Select" parameterClass="System.Collections.IDictionary"  resultClass="DataObject">
      select Count(*) as TOTAL from TT_VIENPHI
      where BENHAN_ID = '$BENHAN_ID$' and HOADON_ID is not null and HOADON_ID in (select HOADON_ID from TT_HOADON where BENHAN_ID = '$BENHAN_ID$')
    </statement>
    <statement id="DAO00119_TT_HOADON_List_Thanhtoan" parameterClass="System.Collections.IDictionary"  resultClass="DataObject">
      select * from TT_HOADON
      where BENHAN_ID is not null and TIEPNHAN_ID = '$TIEPNHAN_ID$' and DATHANHTOAN = '1' and HUYHOADON = '0' and HOADON_ID = '$HOADON_ID$'
    </statement>
    <statement id="DAO00119_GetDanhsachDichvuThutiensau_Chuathu" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select DICHVU_ID from TT_VIENPHI
      where
      REF_TABLE = 'TT_DVYEUCAU'
      and REF_ID in (select DVYEUCAU_ID from TT_DVYEUCAU where
      TIEPNHAN_ID = (select TIEPNHAN_ID from TT_DUOC_CHUNGTU
      where BENHNHAN_ID = '$BENHNHAN_ID$' and CHUNGTU_ID = '$CHUNGTU_ID$') AND THUTIENSAU = '1') and BENHNHAN_PHAITHANHTOAN != GIATRI_BENHNHAN_DATHANHTOAN
    </statement>
    <statement id="DAO00119_TT_XACNHANCHIPHI_Benhan" parameterClass="System.Collections.IDictionary"  resultClass="DataObject">
      select * from TT_XACNHANCHIPHI
      where BENHAN_ID = '$BENHAN_ID$'
      <isNotEmpty prepend="and" property="DOTDIEUTRI_ID">
        DOTDIEUTRI_ID = #DOTDIEUTRI_ID#
      </isNotEmpty>
    </statement>
    <statement id="DAO00119_TT_HOADON_KiemtraHoadonCoToathuocKhongBHYTDaXacnhan" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select * from TT_DUOC_CHUNGTU where exists (
      select CHUNGTUPHATTHUOC_ID
      from TT_NGOAITRU_KHAMBENH_TOATHUOC
      where exists (select  B.KHAMBENH_TOATHUOC_ID
      from TT_HOADON_CHITIET_NGOAITRU A
      left join TT_NGOAITRU_TOATHUOC B on A.REF_ID = B.TOATHUOC_ID
      where A.HOADON_ID = '$HOADON_ID$' and A.REF_TABLE = 'TT_NGOAITRU_TOATHUOC' and TT_NGOAITRU_KHAMBENH_TOATHUOC.KHAMBENH_TOATHUOC_ID = B.KHAMBENH_TOATHUOC_ID)
      and LOAITOATHUOC not in ('TV', 'MN', 'MP', 'BV') and DAXACNHAN = '1' and TT_DUOC_CHUNGTU.CHUNGTU_ID = CHUNGTUPHATTHUOC_ID)
    </statement>
    <statement id="DAO00119_CanhBaoSoBienLai_Conlai" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      declare @intSohdConlai int = null;
      declare @intCanhbanSohdConlai int = null;

      begin
      select @intCanhbanSohdConlai = VALUE from TM_SYS_APPSETTINGS where CODE = 'BIL_SOLUONG_CANHBAO_SAPHET_HOADON'
      if @intCanhbanSohdConlai is null set @intCanhbanSohdConlai = 0

      select top 1
      BLCT.CURRENT_NUMBER, BLCT.START_NUMBER
      , BL.MAX_NUMBER, (BL.KYHIEU + '/' + SERIES) KYHIEU_SOQUYEN, (BL.MAX_NUMBER - BLCT.CURRENT_NUMBER) SOCONLAI
      from
      TT_BIENLAI BL,TT_BIENLAICHITIET BLCT
      where
      BL.BIENLAI_ID = BLCT.BIENLAI_ID
      and BLCT.HIEULUC = 1
      and exists (select BIENLAI_ID from TT_BIENLAICHITIET where BIENLAICHITIET_ID = '$BIENLAICHITIET_ID$' and BLCT.BIENLAI_ID = BIENLAI_ID)
      and @intCanhbanSohdConlai >= (BL.MAX_NUMBER - BLCT.CURRENT_NUMBER)
      order by CURRENT_NUMBER DESC
      end
    </statement>
    <statement id="DAO00119_KiemtraHoaDonTamDaDuyetCongNo" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select count(*) TOTAL_ROW from TT_HOADON where HOADON_ID = #HOADON_ID# and TRANGTHAI = 'DADUYETCONGNO' and (HUYHOADON = '0' and  HOANTRA = '0')
    </statement>
    <statement id="DAO00119_KiemtraHoaDonTamDaThanhtoanQuaViDT" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select count(*) TOTAL_ROW from TT_HOADON where HOADON_ID = #HOADON_ID# and TRANGTHAI = 'DAXACNHANTTVIDT' and (HUYHOADON = '0' and  HOANTRA = '0')
    </statement>
    <statement id="DAO00119_KiemtraHoaDonTamCongnoDaThanhtoan" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select count(*) as TOTALROW from TT_HOADON where HOADONLIENQUAN_ID = #HOADON_ID# and (HUYHOADON = '0' and  HOANTRA = '0')
    </statement>
    <statement id="DAO00119_GetSobienlaiTruyvet" parameterClass="System.Collections.IDictionary" resultClass="System.String">
      select SOHOADON from TT_HOADON where HOADON_ID IN ($HOADON_ID$)
    </statement>
    <statement id="DAO00119_UpdateHoaDonTamCongnoDaThanhtoan" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      update TT_HOADON
      <!--set DATHANHTOAN = '1'-->
      set DATHANHTOAN = '0'
      where HOADON_ID = '$HOADON_ID$'
    </statement>
    <statement id="DAO00119_GetChiphi_VienphiDichvu_theoBenhan" parameterClass="System.Collections.IDictionary" resultClass="System.Int64">
      select  VP.*, c.NOITHUCHIEN_ID, c.NOIYEUCAU_ID, th.TENPHONGBAN NOITHUCHIEN, yc.TENPHONGBAN NOIPHATSINH,
      dv.TENDICHVU, dv.MADICHVU
      from TT_VIENPHI VP
      left join TT_DVYEUCAU c on c.DVYEUCAU_ID = VP.REF_ID  and vp.REF_TABLE = 'TT_DVYEUCAU'
      left join TM_DICHVU DV on dv.DICHVU_ID = VP.DICHVU_ID
      left join TM_PHONGBAN th on th.PHONGBAN_ID = c.NOITHUCHIEN_ID
      left join TM_PHONGBAN yc on th.PHONGBAN_ID = c.NOIYEUCAU_ID
      where Vp.BENHAN_ID = #BENHAN_ID# and Vp.ACTIVE = '1'
      and (c.HUYYEUCAU != '1' and vp.DICHVU_ID is not null) and (REF_TABLE = 'TT_DVYEUCAU') and
      ((vp.DATHANHTOAN = '0') or (vp.BENHNHAN_PHAITHANHTOAN > vp.GIATRI_BENHNHAN_DATHANHTOAN and vp.DATHANHTOAN = '1'))
      and c.DANGKY_CHITIET_ID is null and isnull(vp.BHYT_DONGIA,0) = 0
    </statement>
    <statement id="DAO00119_KiemtraHoaDonDaHuy" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select * from TT_HOADON where HOADON_ID = #HOADON_ID# and (HUYHOADON = '1' or HOANTRA = '1')
    </statement>
    <statement id="DAO00119_TaoPhieuChi" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      declare @HOADON_CHI_ID int;

      <!--Hoa don-->
      insert into TT_HOADON_CHI
      select #SOPHIEUCHI#, GETDATE(), LOAIHOADON, TIEPNHAN_ID, BENHNHAN_ID, BENHAN_ID, BENHAN_NGOAITRU_ID, #GIATRIHOADON_CHI#, TYLEVAT, GIATRIVAT, #GIATRIHOADON_CHI#, TIENTE_ID,
      TYGIA, #GIATRIHOADON_CHI#, SOSERIEVAT, SOHOADONVAT, THUHD_BL, DANGKYHOADON_ID, GETDATE(), NOIPHATSINH_ID, NGUOILAP_ID, NOITHUTIEN_ID, NGUOITHUTIEN_ID, NOITRA_ID,
      NGAYTRA, NGUOITRA_ID, NGOAIGIO, DOITUONG_ID, HUYHOADON, LYDOHUY_ID, NGAYHUY, IDCHUYENHUY, HOANTRA, IDCHUYENHOAN, IDCHUYEN, HOADONDOIUNG, #HOADON_HUY_ID#,
      HOADON_CHUNGTU_LIENQUAN_ID, CHUYENCHUNGTUID, CHUYENCHUNGTUHOANID, CHUYENCHUNGTUHUYID, CHUYENDOANHTHUID, CHUYENDOANHTHUHOANID, CHUYENDOANHTHUHUYID, NHOMTHANHTOAN_ID,
      NGAYKHOAGOI, TRANSFER_VIENPHI_ID, KH_TENKHACHHANG, KH_TENCONGTY, KH_MASOTHUE, KH_DIACHI, KH_NGUOIDAIDIEN, INLAI, INLAI_USER_ID, GHICHU, DATHANHTOAN, TRANGTHAI,
      NGUOI_GHINHANHUY_ID, THOIGIAN_GHINHANHUY, NGUOI_DUYET_HUY_ID, THOIGIAN_DUYET_HUY, BENHVIEN_ID, getdate(), NGUOITAO_ID, getdate(), NGUOICAPNHAT_ID, YEUCAUVP
      from TT_HOADON where HOADON_ID = #HOADON_HUY_ID#
      set @HOADON_CHI_ID = SCOPE_IDENTITY()

      <!--hoa don chi tiet-->
      insert into TT_HOADON_CHI_CHITIET
      select @HOADON_CHI_ID, VIENPHI_ID, REF_ID, REF_TABLE, DICHVU_ID, DUOC_ID, LOAI_CHIPHI, LOAIGIA_ID, SOLUONG, DONGIA_DOANHTHU, THANHTIEN_DOANHTHU, BHYT_TL, BHYT_DONGIA, BHYT_THANHTIEN,
      BHYT_DONGIA_CHITRA, BHYT_THANHTIEN_CHITRA, BENHNHAN_PHAITHANHTOAN, GIATRI_HOADON, GIATRI_HOADON_DATHANHTOAN, GIATRI_BIENLAI, GIATRI_BIENLAI_DATHANHTOAN, GIATRI_BENHNHAN_DATHANHTOAN,
      TYLE_THATTHU, GIATRI_THATTHU, MIENGIAM_TL, MIENGIAM_GIATRI, NGANSACH_TL, NGANSACH_GIATRI, TAITRO_TL, TAITRO_GIATRI, BHTN_GIATRI, NOIDUNGTHU, CHUNGTUXUATBN_ID, TYLEVAT, GIATRIVAT, MASOTHUE,
      SOCHUNGTUKETOAN, DAHOANTRA, TRANGTHAI, PHONGBAN_ID, PHONGBAN_THAYDOI_ID, CONGTYCHITRA_GIATRI, HOIVIEN_GIATRI, BENHVIEN_ID, getdate(), NGUOITAO_ID, getdate(), NGUOICAPNHAT_ID
      from TT_HOADON_CHITIET_NGOAITRU where VIENPHI_ID in ($LST_VIENPHI_CHI$)  and HOADON_ID = #HOADON_HUY_ID#
    </statement>
    <statement id="DAO00119_TaoPhieuThuBienLaiHoaDon" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      declare @HOADON_ID int;

      <!--Hoa don-->
      insert into TT_HOADON
      select #SOHOADON#, GETDATE(), LOAIHOADON, TIEPNHAN_ID, BENHNHAN_ID, BENHAN_ID, BENHAN_NGOAITRU_ID, #GIATRIHOADON_THU#, TYLEVAT, GIATRIVAT, #GIATRIHOADON_THU#, TIENTE_ID,
      TYGIA, #GIATRIHOADON_THU#, SOSERIEVAT, SOHOADONVAT, THUHD_BL, DANGKYHOADON_ID, GETDATE(), NOIPHATSINH_ID, NGUOILAP_ID, NOITHUTIEN_ID, NGUOITHUTIEN_ID, NOITRA_ID,
      NGAYTRA, NGUOITRA_ID, NGOAIGIO, DOITUONG_ID, '0', NULL, NGAYHUY, IDCHUYENHUY, '0', IDCHUYENHOAN, IDCHUYEN, HOADONDOIUNG, #HOADON_HUY_ID#,
      HOADON_CHUNGTU_LIENQUAN_ID, CHUYENCHUNGTUID, CHUYENCHUNGTUHOANID, CHUYENCHUNGTUHUYID, CHUYENDOANHTHUID, CHUYENDOANHTHUHOANID, CHUYENDOANHTHUHUYID, NHOMTHANHTOAN_ID,
      NGAYKHOAGOI, TRANSFER_VIENPHI_ID, KH_TENKHACHHANG, KH_TENCONGTY, KH_MASOTHUE, KH_DIACHI, KH_NGUOIDAIDIEN, INLAI, INLAI_USER_ID, GHICHU, DATHANHTOAN, TRANGTHAI,
      NGUOI_GHINHANHUY_ID, THOIGIAN_GHINHANHUY, NGUOI_DUYET_HUY_ID, THOIGIAN_DUYET_HUY, BENHVIEN_ID, getdate(), NGUOITAO_ID, getdate(), NGUOICAPNHAT_ID, YEUCAUVP, NGUOICAPNHAT_ID, getdate(),
      NULL,NULL, TRANGTHAIBENHAN, MACHINENAME
      from TT_HOADON where HOADON_ID = #HOADON_HUY_ID#
      set @HOADON_ID = SCOPE_IDENTITY()

      <!--hoa don chi tiet-->
      insert into TT_HOADON_CHITIET_NGOAITRU
      select @HOADON_ID, VIENPHI_ID, REF_ID, REF_TABLE, DICHVU_ID, DUOC_ID, LOAI_CHIPHI, LOAIGIA_ID, SOLUONG, DONGIA_DOANHTHU, THANHTIEN_DOANHTHU, BHYT_TL, BHYT_DONGIA, BHYT_THANHTIEN,
      BHYT_DONGIA_CHITRA, BHYT_THANHTIEN_CHITRA, BENHNHAN_PHAITHANHTOAN, GIATRI_HOADON, GIATRI_HOADON_DATHANHTOAN, GIATRI_BIENLAI, GIATRI_BIENLAI_DATHANHTOAN, GIATRI_BENHNHAN_DATHANHTOAN,
      TYLE_THATTHU, GIATRI_THATTHU, MIENGIAM_TL, MIENGIAM_GIATRI, NGANSACH_TL, NGANSACH_GIATRI, TAITRO_TL, TAITRO_GIATRI, BHTN_GIATRI, NOIDUNGTHU, CHUNGTUXUATBN_ID, TYLEVAT, GIATRIVAT, MASOTHUE,
      SOCHUNGTUKETOAN, DAHOANTRA, TRANGTHAI, PHONGBAN_ID, PHONGBAN_THAYDOI_ID, CONGTYCHITRA_GIATRI, HOIVIEN_GIATRI, BENHVIEN_ID, getdate(), NGUOITAO_ID, getdate(), NGUOICAPNHAT_ID
      from TT_HOADON_CHITIET_NGOAITRU where VIENPHI_ID in ($LST_VIENPHI_THU$) and HOADON_ID = #HOADON_HUY_ID#

      <!--hinh thuc thanh toan-->
      insert into TT_HOADON_HINHTHUCTHANHTOAN
      select @HOADON_ID, HINHTHUCTHANHTOAN_ID, TENHINHTHUCTHANHTOAN, #GIATRIHOADON_THU#, TIENTE, TIENTE_ID, TYGIA, GIATRIVND, BENHVIEN_ID
      from TT_HOADON_HINHTHUCTHANHTOAN where HOADON_ID = #HOADON_HUY_ID# and HINHTHUCTHANHTOAN_ID = 443

      <!--vien phi-->
      update TT_VIENPHI
      set
      TT_VIENPHI.HOADON_ID = @HOADON_ID, TT_VIENPHI.DATHANHTOAN = '1', TT_VIENPHI.DUOCPHEPTHUCHIEN = '1',
      TT_VIENPHI.GIATRI_HOADON_DATHANHTOAN = hdnt.GIATRI_HOADON_DATHANHTOAN, TT_VIENPHI.GIATRI_BENHNHAN_DATHANHTOAN = hdnt.GIATRI_BENHNHAN_DATHANHTOAN
      FROM (select VIENPHI_ID, GIATRI_HOADON_DATHANHTOAN, GIATRI_BENHNHAN_DATHANHTOAN from TT_HOADON_CHITIET_NGOAITRU where  VIENPHI_ID in ($LST_VIENPHI_THU$)) hdnt
      where  TT_VIENPHI.VIENPHI_ID = hdnt.VIENPHI_ID
    </statement>
    <statement id="DAO00119_GetDataTamUng_HoaUng" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select SUM(TAMUNG) AS TONGTIEN_TU, SUM(HOANUNG) AS TONGTIEN_HU, TIEPNHAN_ID
      from (
      select HD.TIEPNHAN_ID,
      CASE WHEN LOAIHOADON = 'TU' then HD.GIATRIHOADON ELSE 0 END TAMUNG,
      CASE WHEN LOAIHOADON = 'HU' then HD.GIATRIHOADON ELSE 0 END HOANUNG
      from TT_HOADON HD
      where HD.DATHANHTOAN = '1' and HD.HUYHOADON = '0' and HD.HOANTRA = '0'
      and HD.TIEPNHAN_ID = $TIEPNHAN_ID$
      and HD.BENHVIEN_ID = '$BENHVIEN_ID$'
      ) temp
      group by temp.TIEPNHAN_ID
    </statement>
    <statement id="DAO00119_GetLichSuThanhToan" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select
      SUM(THANHTOAN) AS TONGDATHANHTOAN, SUM(TAMUNG) AS TONGTAMUNG, SUM(HOANUNG) AS TONGHOANUNG,
      SUM(MIENGIAM) AS TONGMIENGIAM, SUM(THATTHU) AS TONGTHATTHU, TIEPNHAN_ID
      from (
      select HD.TIEPNHAN_ID,
      CASE WHEN LOAIHOADON = 'TU' then HD.GIATRIHOADON ELSE 0 END TAMUNG,
      CASE WHEN LOAIHOADON = 'HU' then HD.GIATRIHOADON ELSE 0 END HOANUNG,
      CASE WHEN LOAIHOADON = 'BL' then HD.GIATRIHOADON ELSE 0 END THANHTOAN,
      0 MIENGIAM,
      0 THATTHU
      from TT_HOADON HD
      where HD.DATHANHTOAN = '1' and HD.HUYHOADON = '0' and HD.HOANTRA = '0'
      and HD.TIEPNHAN_ID = $TIEPNHAN_ID$
      and HD.BENHVIEN_ID = '$BENHVIEN_ID$'

      Union All

      select HD.TIEPNHAN_ID,
      0 TAMUNG,
      0 HOANUNG,
      0 THANHTOAN,
      SUM(hdct.MIENGIAM_GIATRI) AS MIENGIAM,
      SUM(hdct.BENHNHAN_PHAITHANHTOAN) - SUM(hdct.GIATRI_HOADON_DATHANHTOAN) AS THATTHU
      from TT_HOADON HD
      join TT_HOADON_CHITIET_NGOAITRU hdct on HD.HOADON_ID = hdct.HOADON_ID
      where HD.DATHANHTOAN = '1' and HD.HUYHOADON = '0' and HD.HOANTRA = '0'
      and HD.TIEPNHAN_ID = $TIEPNHAN_ID$
      and HD.BENHVIEN_ID = '$BENHVIEN_ID$'
      group by TIEPNHAN_ID
      ) temp
      group by temp.TIEPNHAN_ID
    </statement>
    <statement id="DAO00119_GetHoadonHoanungDathanhtoan" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select HOADON_ID from TT_HOADON
      where BENHAN_ID = #BENHAN_ID# and DATHANHTOAN = '1' and HUYHOADON = '0' and HOANTRA = '0' and LOAIHOADON = 'HU'
    </statement>
    <statement id="DAO00119_HuyHoadonHoanungDathanhtoan" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      begin
      update TT_HOADON set
      DATHANHTOAN = '0',
      HUYHOADON = '1'
      where HOADON_ID in ('$LST_HOADON_HU_ID$')

      update TT_HOADON set
      DATHANHTOAN = '1',
      HUYHOADON = '0',
      HOANTRA = '0',
      TRANGTHAI = 'DATHUTIEN',
      HOADONLIENQUAN_ID = null
      where HOADONLIENQUAN_ID in ('$LST_HOADON_HU_ID$')
      end
    </statement>
    <statement id="DAO00119_Insert_TT_BENHNHAN_NO_THANHTOAN" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      INSERT INTO TT_BENHNHAN_NO_THANHTOAN
      (BENHNHAN_ID
      ,TIEPNHAN_ID
      ,BENHAN_ID
      ,HOADON_ID
      ,GIATRINO
      ,HUY
      ,NGUOITAO_ID
      ,NGAYTAO)
      VALUES
      (#BENHNHAN_ID#
      ,#TIEPNHAN_ID#
      ,#BENHAN_ID#
      ,#HOADON_ID#
      ,#GIATRINO#
      ,'0'
      ,#NGUOITAO_ID#
      ,Getdate())
    </statement>
    <statement id="DAO00119_Update_HUY_TT_BENHNHAN_NO_THANHTOAN" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      update TT_BENHNHAN_NO_THANHTOAN
      set HUY = '1', NGUOICAPNHAT_ID = #NGUOICAPNHAT_ID#, NGAYCAPNHAT = getdate()
      where TT_BENHNHAN_NO_THANHTOAN = #TT_BENHNHAN_NO_THANHTOAN#
    </statement>
    <statement id="DAO00119_GetDanhsachHTTT" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select * from LST_DICTIONARY where DICTIONARY_TYPE_CODE = 'HinhThucThanhToan' and ENABLED = '1' and BENHVIEN_ID = '$BENHVIEN_ID$'
    </statement>
    <statement id="DAO00119_GetDanhsachHTTTOnline" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select * from LST_DICTIONARY
      where DICTIONARY_TYPE_CODE = 'HinhThucThanhToan'
      and DICTIONARY_CODE like 'TTONLINE%'
      and ENABLED = '1' and BENHVIEN_ID = '$BENHVIEN_ID$'
    </statement>
    <statement id="DAO00119_GetDanhsachLoaiGiaoDichATM" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select * from LST_DICTIONARY
      where DICTIONARY_TYPE_CODE = 'LoaiGiaoDichATM'
      and ENABLED = '1' and BENHVIEN_ID = '$BENHVIEN_ID$'
    </statement>
    <statement id="DAO00119_GetListHoadonDientu" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select distinct hd.HOADON_ID,
      case
      when vp.HOADON_ID is not null then 'NHATHUOC'
      when isnull(hd.BENHAN_ID, 0) > 0 then 'NOITRU'
      else 'NGOAITRU' end LOAIHOADON,
      isnull(bn.MAYTE, '') MAYTE, isnull(bn.TENBENHNHAN, bntt.TENNGUOIMUA) TENBENHNHAN,
      hd.KH_DIACHI DIACHI, isnull(bn.SODIENTHOAI, bntt.SODIENTHOAI) SODIENTHOAI,
      hd.KH_TENCONGTY TENCONGTY , hd.KH_MASOTHUE MASOTHUE, httt.TENHINHTHUCTHANHTOAN HINHTHUCTHANHTOAN, null SOTAIKHOAN, null TENNGANHANG,
      hd.SOSERIEVAT , hd.SOHOADON SOHOADONVAT, hd.GIATRIHOADON, nv.TENNHANVIEN USER_HOADON, hd.NGAYPHATSINH, GETDATE() NGAYTAO, 0 NGUOITAO_ID,
      case
      when hd.HOANTRA = '0' and hd.HUYHOADON = '0' then 'NEW'
      else 'DELETE' end TRANGTHAI,
      ntba.SOBENHAN, isnull(bn.MAYTE, null) SOVAOVIEN, N'Thu tiền viện phí' LYDOTHU, nv.TENNHANVIEN TENNGUOITHUTIEN, hd.LOAIHOADON LOAICHUNGTU,
      '$LENH_DATA$' LENH ,
      hd.TIEPNHAN_ID, hd.BENHAN_ID, tn.SOTIEPNHAN,
      case
      when isnull(tn.SOBHYT,'') = '' then 'VP'
      else 'BHYT' end DOITUONG
      from TT_HOADON hd
      left join TT_TIEPNHAN tn on hd.TIEPNHAN_ID = tn.TIEPNHAN_ID
      left join TT_BENHNHAN bn on bn.BENHNHAN_ID = tn.BENHNHAN_ID
      left join
      (select distinct vp.HOADON_ID, CT.NGOAITRU_TOATHUOC_NGUOIMUA_ID from TT_VIENPHI vp
      left join TT_DUOC_CHUNGTU_CHITIET ctct on ctct.CHUNGTUCHITIET_ID= vp.REF_ID
      left join TT_DUOC_CHUNGTU ct on ct.CHUNGTU_ID = ctct.CHUNGTU_ID
      where vp.REF_TABLE = 'TT_DUOC_CHUNGTU_CHITIET') vp
      on vp.HOADON_ID = hd.HOADON_ID
      left join TT_NGOAITRU_TOATHUOC_NGUOIMUA bntt on bntt.NGOAITRU_TOATHUOC_NGUOIMUA_ID = vp.NGOAITRU_TOATHUOC_NGUOIMUA_ID
      left join TT_HOADON_HINHTHUCTHANHTOAN httt on httt.HOADON_ID = hd.HOADON_ID
      left join TM_NHANVIEN nv on nv.NHANVIEN_ID = hd.NGUOITAO_ID
      left join TT_NOITRU_BENHAN ntba on ntba.BENHAN_ID = hd.BENHAN_ID
      where isnull(bn.TENBENHNHAN, bntt.TENNGUOIMUA) is not null
      and hd.TRANGTHAI = 'DATHUTIEN' and hd.LOAIHOADON in ('BL', 'HD')
      <isNotEmpty prepend="and" property="HOADON_ID">
        hd.HOADON_ID = '$HOADON_ID$'
      </isNotEmpty>
      <isNotEmpty prepend="and" property="TIEPNHAN_ID">
        hd.TIEPNHAN_ID = '$TIEPNHAN_ID$'
      </isNotEmpty>
      <isNotEmpty prepend=" and " property="HUYHOADON">
        <isEqual prepend="" property="HUYHOADON" compareValue="false">
          isnull(hd.DANGKYHOADON_ID, 0) = 0
        </isEqual>
        <isEqual prepend="" property="HUYHOADON" compareValue="true">
          isnull(hd.DANGKYHOADON_ID, 0) = 1
        </isEqual>
      </isNotEmpty>
      <isNotEmpty prepend="and" property="APP_DAYS_UPDATE_TO_HOADONDIENTU">
        cast(GETDATE() as date) >= cast(dateadd(day, cast((select VALUE from TM_SYS_APPSETTINGS where CODE = 'APP_DAYS_UPDATE_TO_HOADONDIENTU') as int), hd.NGAYPHATSINH) as date)
      </isNotEmpty>
    </statement>
    <statement id="DAO00119_GetHoadonDientuChitiet_Ngoaitru" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select
      hdct.HOADONCHITIET_ID, hdct.VIENPHI_ID, hdct.HOADON_ID,
      ROW_NUMBER() Over(order by hdct.HOADONCHITIET_ID) SOTHUTU,
      ISNULL(dv.MADICHVU, dc.MADUOC) MAHANG, ISNULL(dv.TENDICHVU, dc.TENDUOCDAYDU) TENHANG,
      isnull(dv.DONVITINH, dc.DONVITINH) DONVITINH, ROUND((hdct.GIATRI_BENHNHAN_DATHANHTOAN/ hdct.SOLUONG),4) DONGIA,
      hdct.SOLUONG, hdct.GIATRI_BENHNHAN_DATHANHTOAN THANHTIEN, 0 PHANTRAMTHUE, 0 TIENTHUE, 0 PHANTRAMCHIETKHAU, 0 TIENCHIETKHAU,
      hdct.GIATRI_BENHNHAN_DATHANHTOAN TONGTIEN
      from TT_HOADON_CHITIET_NGOAITRU hdct
      left join TM_DICHVU dv on dv.DICHVU_ID = hdct.DICHVU_ID
      left join TM_DUOC dc on dc.DUOC_ID = hdct.DUOC_ID
      where exists(select distinct hd.HOADON_ID,
      case
      when vp.HOADON_ID is not null then 'NHATHUOC'
      when isnull(hd.BENHAN_ID, 0) > 0 then 'NOITRU'
      else 'NGOAITRU' end LOAIHOADON

      from TT_HOADON hd
      left join TT_TIEPNHAN tn on hd.TIEPNHAN_ID = tn.TIEPNHAN_ID
      left join TT_BENHNHAN bn on bn.BENHNHAN_ID = tn.BENHNHAN_ID
      left join
      (select distinct vp.HOADON_ID, CT.NGOAITRU_TOATHUOC_NGUOIMUA_ID from TT_VIENPHI vp
      left join TT_DUOC_CHUNGTU_CHITIET ctct on ctct.CHUNGTUCHITIET_ID= vp.REF_ID
      left join TT_DUOC_CHUNGTU ct on ct.CHUNGTU_ID = ctct.CHUNGTU_ID
      where vp.REF_TABLE = 'TT_DUOC_CHUNGTU_CHITIET') vp
      on vp.HOADON_ID = hd.HOADON_ID
      left join TT_NGOAITRU_TOATHUOC_NGUOIMUA bntt on bntt.NGOAITRU_TOATHUOC_NGUOIMUA_ID = vp.NGOAITRU_TOATHUOC_NGUOIMUA_ID
      left join TT_NOITRU_BENHAN ntba on ntba.BENHAN_ID = hd.BENHAN_ID
      where isnull(bn.TENBENHNHAN, bntt.TENNGUOIMUA) is not null
      and hd.TRANGTHAI = 'DATHUTIEN' and hd.HOADON_ID = hdct.HOADON_ID and isnull(hd.DANGKYHOADON_ID, 0) = 0 and hd.LOAIHOADON in ('BL', 'HD')
      <isNotEmpty prepend="and" property="HOADON_ID">
        hd.HOADON_ID = '$HOADON_ID$'
      </isNotEmpty>
      <isNotEmpty prepend="and" property="TIEPNHAN_ID">
        hd.TIEPNHAN_ID = '$TIEPNHAN_ID$'
      </isNotEmpty>
      <isNotEmpty prepend="and" property="APP_DAYS_UPDATE_TO_HOADONDIENTU">
        cast(GETDATE() as date) >= cast(dateadd(day, cast((select VALUE from TM_SYS_APPSETTINGS where CODE = 'APP_DAYS_UPDATE_TO_HOADONDIENTU') as int), hd.NGAYPHATSINH) as date)

      </isNotEmpty>
      )  and hdct.GIATRI_BENHNHAN_DATHANHTOAN > 0
    </statement>
    <statement id="DAO00119_GetHoadonDientuChitiet_Noitru" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select
      hdct.HOADON_CHITIET_NOITRU_ID as HOADONCHITIET_ID, hdct.VIENPHI_ID, hdct.HOADON_ID,
      ROW_NUMBER() Over(order by hdct.HOADON_CHITIET_NOITRU_ID) SOTHUTU,
      ISNULL(dv.MADICHVU, dc.MADUOC) MAHANG, ISNULL(dv.TENDICHVU, dc.TENDUOCDAYDU) TENHANG,
      isnull(dv.DONVITINH, dc.DONVITINH) DONVITINH, ROUND((hdct.GIATRI_BENHNHAN_DATHANHTOAN/ hdct.SOLUONG),4) DONGIA,
      hdct.SOLUONG, hdct.GIATRI_BENHNHAN_DATHANHTOAN THANHTIEN, 0 PHANTRAMTHUE, 0 TIENTHUE, 0 PHANTRAMCHIETKHAU, 0 TIENCHIETKHAU,
      hdct.GIATRI_BENHNHAN_DATHANHTOAN TONGTIEN
      from TT_HOADON_CHITIET_NOITRU hdct
      left join TM_DICHVU dv on dv.DICHVU_ID = hdct.DICHVU_ID
      left join TM_DUOC dc on dc.DUOC_ID = hdct.DUOC_ID
      where exists(select distinct hd.HOADON_ID,
      case
      when vp.HOADON_ID is not null then 'NHATHUOC'
      when isnull(hd.BENHAN_ID, 0) > 0 then 'NOITRU'
      else 'NGOAITRU' end LOAIHOADON

      from TT_HOADON hd
      left join TT_TIEPNHAN tn on hd.TIEPNHAN_ID = tn.TIEPNHAN_ID
      left join TT_BENHNHAN bn on bn.BENHNHAN_ID = tn.BENHNHAN_ID
      left join
      (select distinct vp.HOADON_ID, CT.NGOAITRU_TOATHUOC_NGUOIMUA_ID from TT_VIENPHI vp
      left join TT_DUOC_CHUNGTU_CHITIET ctct on ctct.CHUNGTUCHITIET_ID= vp.REF_ID
      left join TT_DUOC_CHUNGTU ct on ct.CHUNGTU_ID = ctct.CHUNGTU_ID
      where vp.REF_TABLE = 'TT_DUOC_CHUNGTU_CHITIET') vp
      on vp.HOADON_ID = hd.HOADON_ID
      left join TT_NGOAITRU_TOATHUOC_NGUOIMUA bntt on bntt.NGOAITRU_TOATHUOC_NGUOIMUA_ID = vp.NGOAITRU_TOATHUOC_NGUOIMUA_ID
      left join TT_NOITRU_BENHAN ntba on ntba.BENHAN_ID = hd.BENHAN_ID
      where isnull(bn.TENBENHNHAN, bntt.TENNGUOIMUA) is not null and ntba.BENHAN_ID is not null
      and hd.TRANGTHAI = 'DATHUTIEN' and hd.HOADON_ID = hdct.HOADON_ID and isnull(hd.DANGKYHOADON_ID, 0) = 0 and hd.LOAIHOADON in ('BL', 'HD')
      <isNotEmpty prepend="and" property="HOADON_ID">
        hd.HOADON_ID = '$HOADON_ID$'
      </isNotEmpty>
      <isNotEmpty prepend="and" property="TIEPNHAN_ID">
        hd.TIEPNHAN_ID = '$TIEPNHAN_ID$'
      </isNotEmpty>
      <isNotEmpty prepend="and" property="APP_DAYS_UPDATE_TO_HOADONDIENTU">
        cast(GETDATE() as date) >= cast(dateadd(day, cast((select VALUE from TM_SYS_APPSETTINGS where CODE = 'APP_DAYS_UPDATE_TO_HOADONDIENTU') as int), hd.NGAYPHATSINH) as date)
      </isNotEmpty>
      ) and hdct.GIATRI_BENHNHAN_DATHANHTOAN > 0
    </statement>
    <statement id="DAO00119_Update1HoadonChuyenHDDT" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      update TT_HOADON set DANGKYHOADON_ID = 1 where HOADON_ID in ($LST_HOADON$)
    </statement>
    <statement id="DAO00119_UpdateNhieuHoadonChuyenHDDT" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      update TT_HOADON
      set DANGKYHOADON_ID = 1
      from(select distinct hd.HOADON_ID

      from TT_HOADON hd
      left join TT_TIEPNHAN tn on hd.TIEPNHAN_ID = tn.TIEPNHAN_ID
      left join TT_BENHNHAN bn on bn.BENHNHAN_ID = tn.BENHNHAN_ID
      left join
      (select distinct vp.HOADON_ID, CT.NGOAITRU_TOATHUOC_NGUOIMUA_ID from TT_VIENPHI vp
      left join TT_DUOC_CHUNGTU_CHITIET ctct on ctct.CHUNGTUCHITIET_ID= vp.REF_ID
      left join TT_DUOC_CHUNGTU ct on ct.CHUNGTU_ID = ctct.CHUNGTU_ID
      where vp.REF_TABLE = 'TT_DUOC_CHUNGTU_CHITIET') vp
      on vp.HOADON_ID = hd.HOADON_ID
      left join TT_NGOAITRU_TOATHUOC_NGUOIMUA bntt on bntt.NGOAITRU_TOATHUOC_NGUOIMUA_ID = vp.NGOAITRU_TOATHUOC_NGUOIMUA_ID
      left join TT_HOADON_HINHTHUCTHANHTOAN httt on httt.HOADON_ID = hd.HOADON_ID
      left join TM_NHANVIEN nv on nv.NHANVIEN_ID = hd.NGUOITAO_ID
      left join TT_NOITRU_BENHAN ntba on ntba.TIEPNHAN_ID = hd.BENHAN_ID
      where isnull(bn.TENBENHNHAN, bntt.TENNGUOIMUA) is not null
      and hd.TRANGTHAI = 'DATHUTIEN' and hd.LOAIHOADON in ('BL', 'HD') and isnull(hd.DANGKYHOADON_ID, 0) = 0
      and cast(GETDATE() as date) >= cast(dateadd(day, cast((select VALUE from TM_SYS_APPSETTINGS where CODE = 'APP_DAYS_UPDATE_TO_HOADONDIENTU') as int), hd.NGAYPHATSINH) as date) ) hd1
      where hd1.HOADON_ID = TT_HOADON.HOADON_ID
    </statement>
    <statement id="DAO00119_GetDichVuThanhToan" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select a.*
      from TT_DVYEUCAU a
      inner join TT_VIENPHI b on a.DVYEUCAU_ID = b.REF_ID and b.REF_TABLE = 'TT_DVYEUCAU'
      <isNotEmpty prepend="" property="INPATIENT">
        <isEqual prepend="" property="INPATIENT" compareValue="True">
          inner join TT_HOADON_CHITIET_NGOAITRU c on c.VIENPHI_ID = b.VIENPHI_ID
          inner join TT_HOADON e on e.HOADON_ID = c.HOADON_ID
        </isEqual>
        <isEqual prepend="" property="INPATIENT" compareValue="False">
          inner join TT_HOADON_CHITIET_NOITRU d on d.VIENPHI_ID = b.VIENPHI_ID
          inner join TT_HOADON f on f.HOADON_ID = d.HOADON_ID
        </isEqual>
      </isNotEmpty>
      where a.DVYEUCAU_ID = '$DVYEUCAU_ID$'
    </statement>
    <statement id="DAO00119_exeStoreNoidung1HD" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
        sp_NoidungHoadonDT $HOADON_ID$
    </statement>
    <statement id="DAO00119_InsertNoidungHoadonDientu" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      declare @jsonData nvarchar(max) = N'$JSON_DATA$';
      insert into TT_HOADONDT_NOIDUNG_CHITIET
      select json.*
      FROM OPENJSON(@jsonData)
      WITH (
      HOADON_ID int,
      NOIDUNG nvarchar(2000),
      THANHTIEN numeric(18,2),
      DONGIA numeric(18,2),
      SOLUONG numeric(18,2),
      DVT nvarchar(100),
      NHOM nvarchar(50)
      ) json
    </statement>
    <statement id="DAO00119_Update_HuyDichVuCLS" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      UPDATE TT_DVYEUCAU SET
      ISDUYET = 0
      ,NGUOIDUYET_ID = NULL
      ,THOIGIANDUYET = NULL
      ,NGUOIHUY_ID = #NGUOIHUY_ID#
      ,THOIGIANHUY = #THOIGIANHUY#
      WHERE DVYEUCAU_ID = #DVYEUCAU_ID#
    </statement>
    <statement id="DAO00119_Update_DuyetDichVuCLS" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      UPDATE TT_DVYEUCAU SET
      ISDUYET = 1
      ,NGUOIDUYET_ID = #NGUOIDUYET_ID#
      ,THOIGIANDUYET = #THOIGIANDUYET#
      ,NGUOIHUY_ID = NULL
      ,THOIGIANHUY = NULL
      WHERE DVYEUCAU_ID = #DVYEUCAU_ID#
    </statement>
    <statement id="DAO00119_CheckTrangThaiDuyetDichVu" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      SELECT ISNULL(ISDUYET, 0) AS ISDUYET
      FROM TT_DVYEUCAU
      WHERE DVYEUCAU_ID = #DVYEUCAU_ID#
    </statement>
	<!--THAO TÁC VỚI BẢNG TT_BIENLAI_COSAN -->
	<statement id="DAO00119_AddHoaDonCoSan" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
    INSERT INTO TT_BIENLAICHITIET_COSAN
    (BIENLAICHITIET_ID,BIENLAI_ID,NGUOISUDUNG_ID,MACHINENAME
    ,START_NUMBER,CURRENT_NUMBER,THOIGIANSUDUNG,HIEULUC,BENHVIEN_ID)
    SELECT
    BIENLAICHITIET_ID,BIENLAI_ID,NGUOISUDUNG_ID,MACHINENAME
    ,START_NUMBER,
    (SELECT SOBIENLAI FROM TT_HOADON WHERE HOADON_ID=#HOADON_ID#)
    ,THOIGIANSUDUNG,HIEULUC,BENHVIEN_ID
    FROM TT_BIENLAICHITIET
    WHERE BIENLAICHITIET_ID=#BIENLAICHITIET_ID#

    SELECT TOP 1 * FROM TT_BIENLAICHITIET_COSAN ORDER BY BIENLAICHITIET_COSAN_ID
  </statement>
  </statements>
</sqlMap>