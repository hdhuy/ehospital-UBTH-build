<?xml version="1.0" encoding="utf-8" ?>
<!--============================================================================
//	CAUTION: This file is generated by IBatisNetGen.3.SQLMap.cst at 4/1/2016 9:22:01 AM
//				Any manual editing will be lost in re-generation.
//===========================================================================-->
<sqlMap namespace="eHospital" xmlns="http://ibatis.apache.org/mapping" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
  <statements>
    <statement id="DAO00217_Execute_Stored" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      exec $PROCEDURE_NAME$
      <iterate property="PARAMETERS" open="" close="" conjunction=",">
        #PARAMETERS[]#
      </iterate>
    </statement>
    <statement id="DAO00217_Get_ListMaYTe" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select MAYTE from TT_BENHNHAN
    </statement>
    <statement id="DAO00217_LoadThongTinLichSuKetQuaXetNghiem" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      DECLARE @DICHVU_ID INT
      SET @DICHVU_ID =(SELECT TOP 1 DICHVU_ID FROM TT_DVYEUCAU A WHERE A.DVYEUCAU_ID='$DVYEUCAU_ID$')

      SELECT CT.MUCBINHTHUONG GIOIHAN, CT.KETQUA,KQ.CLSKETQUA_ID,convert(date,KQ.NGAYTAO)as NGAYTAO
      ,CASE WHEN  DVCT.CAPTREN_ID IS NULL THEN DVCT.DICHVU_ID ELSE DVCT.CAPTREN_ID END CAPTREN,DVCT.DICHVU_ID
      ,CT.MUCBINHTHUONGMIN,CT.MUCBINHTHUONGMAX,TM.TENDICHVU DICHVUCHA,isnull(DVCT.TENDICHVU,tm.tendichvu) TENDICHVU,YC.DVYEUCAU_ID, KQ.NGAYKHOADULIEU
      FROM TM_DICHVU TM
      INNER JOIN TT_DVYEUCAU YC ON TM.DICHVU_ID=YC.DICHVU_ID
      INNER JOIN TT_BENHNHAN BN ON YC.BENHNHAN_ID=BN.BENHNHAN_ID
      INNER JOIN VIEW_CLS_KETQUA_DICHVU VKQ  on YC.DVYEUCAU_ID =VKQ.DVYEUCAU_ID
      <isNotEmpty prepend="AND" property="DVYEUCAU_ID">
        VKQ.DICHVUCHA_ID=@DICHVU_ID
      </isNotEmpty>
      LEFT JOIN TT_CLSKETQUACHITIET CT ON VKQ .CLSKETQUACHITIET_ID = CT.CLSKETQUACHITIET_ID
      LEFT JOIN TT_CLSKETQUA KQ ON CT.CLSKETQUA_ID =KQ.CLSKETQUA_ID
      LEFT JOIN TM_DICHVU DVCT ON CT.DICHVU_ID= DVCT.DICHVU_ID
      WHERE BN.BENHNHAN_ID='$BENHNHAN_ID$'
      AND convert(date,yc.NGAYTAO) between convert(date,'$TUNGAY$') and convert(date,'$DENNGAY$')
      <isNotEmpty prepend="AND" property="DVYEUCAU_ID">
        YC.DICHVU_ID=@DICHVU_ID
      </isNotEmpty>
      AND KQ.CLSKETQUA_ID is not null
      order by yc.DVYEUCAU_ID DESC
      <!--where dv.dichvu_id=10328 OR DV.CAPTREN_ID=10328-->

    </statement>
    <statement id="DAO00217_GetDSTTDichVuByBenhNhanID" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select ba.SOBENHAN
      , case when dv.KHAMBENH_NGOAITRU_ID is not null then kb.THOIGIANKHAM
      when dv.DVYEUCAU_ID in (select DVYEUCAU_ID from TT_CLSKETQUA) then clskq.THOIGIANTHUCHIEN
      else isnull(isnull(dv.THOIGIANKHOADULIEU, dv.NGAYCAPNHAT), dv.NGAYGIOYEUCAU) end as THOIGIANTHUCHIEN
      , isnull(dv.NGUOIKHOA_ID,dv.NGUOICAPNHAT_ID) as BACSITHUCHIEN_ID,
      tn.SOTIEPNHAN, dv.*, vp.SOLUONG
      , nv.TENNHANVIEN as TENBACSICHIDINH
      , nv2.TENNHANVIEN as TENNGUOITHUCHIEN
      from TT_DVYEUCAU dv
      left join TT_NOITRU_BENHAN ba on dv.BENHAN_ID = ba.BENHAN_ID
      left join TT_CLSKETQUA clskq on clskq.DVYEUCAU_ID = dv.DVYEUCAU_ID
      left join TT_NGOAITRU_KHAMBENH kb on dv.KHAMBENH_NGOAITRU_ID = kb.KHAMBENH_ID
      left join TT_PHAUTHUAT pt on pt.PHAUTHUAT_ID in (select PHAUTHUAT_ID from TT_PHAUTHUAT_YEUCAU where DVYEUCAU_ID = dv.DVYEUCAU_ID)
      left join TT_TIEPNHAN tn on dv.TIEPNHAN_ID = tn.TIEPNHAN_ID
      left join TT_VIENPHI vp on vp.REF_ID = dv.DVYEUCAU_ID and REF_TABLE = 'TT_DVYEUCAU'
      inner join TM_NHANVIEN nv on nv.NHANVIEN_ID = dv.BACSICHIDINH_ID
      left join TM_NHANVIEN nv2 on nv2.NHANVIEN_ID = dv.NGUOIKHOA_ID
      where tn.BENHNHAN_ID = '$BENHNHAN_ID$'
      and dv.BENHVIEN_ID = '$BENHVIEN_ID$' and dv.HUYYEUCAU='0'

      <isNotEmpty prepend="and" property="TUNGAY">
        convert(date, NGAYGIOYEUCAU) &#62;&#61; convert(date, '$TUNGAY$')
      </isNotEmpty>
      <isNotEmpty prepend="and" property="DENNGAY">
        convert(date, NGAYGIOYEUCAU) &#60;&#61; convert(date, '$DENNGAY$')
      </isNotEmpty>
      <isNotEmpty prepend="and" property="BACSICHIDINH_ID">
        dv.BACSICHIDINH_ID = '$BACSICHIDINH_ID$'
      </isNotEmpty>
      <isNotEmpty prepend="and" property="NOIYEUCAU_ID">
        dv.NOIYEUCAU_ID = '$NOIYEUCAU_ID$'
      </isNotEmpty>
      order by DVYEUCAU_ID
      desc
    </statement>
    <statement id="DAO00217_GetDepartmentAll" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select * from TM_PHONGBAN
    </statement>
    <statement id="DAO00217_GetEmployeeAll" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select * from TM_NHANVIEN
    </statement>
    <statement id="DAO00217_GetDefaultTreeView" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      SELECT cast(2 as varchar(10)) CATEGORY_ID, cast(0 as varchar(10)) PARENT_ID, 'KHAMBENH' CATEGORY_CODE, N'Thông tin khám bệnh' CATEGORY_NAME, 0 FOLDER_LEVEL, 1 IS_FOLDER, 'ROOT' FOLDER_CODE, NULL PARENT_CODE, 1 CATEGORY_TYPE

      SELECT cast(21 as varchar(10)) CATEGORY_ID, cast(2 as varchar(10)) PARENT_ID, 'KHAMBENH21' CATEGORY_CODE, N'Sinh hiệu' CATEGORY_NAME, 0 FOLDER_LEVEL, 1 IS_FOLDER, 'KHAMBENH' FOLDER_CODE, 'KHAMBENH' PARENT_CODE, 1 CATEGORY_TYPE

      SELECT cast(22 as varchar(10)) CATEGORY_ID, cast(2 as varchar(10)) PARENT_ID, 'KHAMBENH22' CATEGORY_CODE, N'Cận lâm sàng' CATEGORY_NAME, 0 FOLDER_LEVEL, 1 IS_FOLDER, 'KHAMBENH' FOLDER_CODE, 'KHAMBENH' PARENT_CODE, 1 CATEGORY_TYPE

      SELECT cast(3 as varchar(10)) CATEGORY_ID, cast(0 as varchar(10)) PARENT_ID, 'DIEUTRI' CATEGORY_CODE, N'Thông tin điều trị nội trú' CATEGORY_NAME, 0 FOLDER_LEVEL, 1 IS_FOLDER, 'ROOT' FOLDER_CODE, NULL PARENT_CODE, 1 CATEGORY_TYPE

      SELECT cast(31 as varchar(10)) CATEGORY_ID, cast(3 as varchar(10)) PARENT_ID, 'DIEUTRI23' CATEGORY_CODE, N'Hồ sơ bệnh án' CATEGORY_NAME, 0 FOLDER_LEVEL, 1 IS_FOLDER, 'DIEUTRI' FOLDER_CODE, 'DIEUTRI' PARENT_CODE, 1 CATEGORY_TYPE

      SELECT cast(32 as varchar(10)) CATEGORY_ID, cast(3 as varchar(10)) PARENT_ID, 'DIEUTRI21' CATEGORY_CODE, N'Phiếu điều trị' CATEGORY_NAME, 0 FOLDER_LEVEL, 1 IS_FOLDER, 'DIEUTRI' FOLDER_CODE, 'DIEUTRI' PARENT_CODE, 1 CATEGORY_TYPE

      SELECT cast(33 as varchar(10)) CATEGORY_ID, cast(3 as varchar(10)) PARENT_ID, 'DIEUTRI22' CATEGORY_CODE, N'Cận lâm sàng' CATEGORY_NAME, 0 FOLDER_LEVEL, 1 IS_FOLDER, 'DIEUTRI' FOLDER_CODE, 'DIEUTRI' PARENT_CODE, 1 CATEGORY_TYPE

      SELECT cast(4 as varchar(10)) CATEGORY_ID, cast(0 as varchar(10)) PARENT_ID, 'FILEDINHKEM' CATEGORY_CODE, N'File đính kèm' CATEGORY_NAME, 0 FOLDER_LEVEL, 1 IS_FOLDER, 'ROOT' FOLDER_CODE, NULL PARENT_CODE, 1 CATEGORY_TYPE
    </statement>
    <statement id="DAO00217_GetAllTiepNhanBenhAn" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      SELECT cast(2 as varchar(10)) CATEGORY_ID, cast(0 as varchar(10)) PARENT_ID, 'KHAMBENH' CATEGORY_CODE, N'Thông tin khám bệnh' CATEGORY_NAME, 0 FOLDER_LEVEL, 1 IS_FOLDER, 'ROOT' FOLDER_CODE, NULL PARENT_CODE, 1 CATEGORY_TYPE
      SELECT cast(3 as varchar(10)) CATEGORY_ID, cast(0 as varchar(10)) PARENT_ID, 'DIEUTRI' CATEGORY_CODE, N'Thông tin điều trị nội trú' CATEGORY_NAME, 0 FOLDER_LEVEL, 1 IS_FOLDER, 'ROOT' FOLDER_CODE, NULL PARENT_CODE, 1 CATEGORY_TYPE
      SELECT cast(4 as varchar(10)) CATEGORY_ID, cast(0 as varchar(10)) PARENT_ID, 'FILEDINHKEM' CATEGORY_CODE, N'File đính kèm' CATEGORY_NAME, 0 FOLDER_LEVEL, 1 IS_FOLDER, 'ROOT' FOLDER_CODE, NULL PARENT_CODE, 1 CATEGORY_TYPE
      
      <!--tiep nhan-->
      select distinct C.SOBENHAN, C.BENHAN_ID, A.SOTIEPNHAN, A.NGAYTIEPNHAN, A.TIEPNHAN_ID,
      A.SOTIEPNHAN CATEGORY_ID,
      cast(2 as varchar(10)) PARENT_ID,
      A.SOTIEPNHAN CATEGORY_CODE,
      A.SOTIEPNHAN +' (' + FORMAT (A.NGAYTIEPNHAN, 'dd/MM/yyyy') + ')' CATEGORY_NAME,
      0 FOLDER_LEVEL, 1 IS_FOLDER, 'KHAMBENH' FOLDER_CODE, 'KHAMBENH' PARENT_CODE, 1 CATEGORY_TYPE
      from TT_TIEPNHAN A
      left join TT_BENHNHAN B on A.BENHNHAN_ID = B.BENHNHAN_ID
      left join TT_NOITRU_BENHAN C on C.TIEPNHAN_ID = A.TIEPNHAN_ID
      where A.BENHNHAN_ID = $BENHNHAN_ID$ <!--and C.SOBENHAN is null-->
      <!--kham benh-->
      select distinct dv.TENDICHVU, kb.KHAMBENH_ID, 'KHAMBENH' ACTION,
      'KBNT_' + cast(kb.KHAMBENH_ID as varchar(20)) CATEGORY_ID,
      TN.SOTIEPNHAN PARENT_ID,
      'KBNT_' + cast(kb.KHAMBENH_ID as varchar(20)) CATEGORY_CODE,
      dv.TENDICHVU CATEGORY_NAME,
      0 FOLDER_LEVEL, 0 IS_FOLDER, TN.SOTIEPNHAN FOLDER_CODE, TN.SOTIEPNHAN PARENT_CODE, 1 CATEGORY_TYPE
      , kb.KHAMBENH_ID as REF_ID
      , 'TT_NGOAITRU_KHAMBENH' as REF_TABLE
      from TT_NGOAITRU_KHAMBENH KB
      inner join TT_TIEPNHAN TN ON TN.TIEPNHAN_ID = KB.TIEPNHAN_ID
      left join TM_DICHVU dv on dv.DICHVU_ID = kb.DICHVU_ID
      where TN.BENHNHAN_ID = $BENHNHAN_ID$
      <!--Phieu chuyen vien-->
      select distinct CV.CHUYENVIEN_ID, 'GIAYCHUYENVIEN' ACTION,
      'PCV' + TN.SOTIEPNHAN as CATEGORY_ID,
      TN.SOTIEPNHAN PARENT_ID,
      'PCV' + TN.SOTIEPNHAN CATEGORY_CODE,
      N'Phiếu chuyển viện' CATEGORY_NAME,
      0 FOLDER_LEVEL, 0 IS_FOLDER, TN.SOTIEPNHAN FOLDER_CODE, TN.SOTIEPNHAN PARENT_CODE, 1 CATEGORY_TYPE
      , CV.CHUYENVIEN_ID as REF_ID
      , 'TT_CHUYENVIEN' as REF_TABLE
      from TT_CHUYENVIEN CV
      inner join TT_TIEPNHAN TN ON TN.TIEPNHAN_ID = CV.TIEPNHAN_ID
      where TN.BENHNHAN_ID = $BENHNHAN_ID$ and CV.TIEPNHAN_ID not in (select TIEPNHAN_ID from TT_NOITRU_BENHAN)
      <!--toa thuoc-->
      select distinct kbtt.KHAMBENH_TOATHUOC_ID SOTOATHUOC, 'TOATHUOC' ACTION, kbtt.LOAITOATHUOC,
      tn.TIEPNHAN_ID SOTIEPNHAN, kbtt.KHAMBENH_ID SOKHAMBENH, kbtt.KHAMBENH_ID,
      kbtt.SOTHUTUTOA CATEGORY_ID,
      'KBNT_' + cast(kbtt.KHAMBENH_ID as varchar(20)) PARENT_ID,
      kbtt.SOTHUTUTOA CATEGORY_CODE,
      N'Toa thuốc ' + kbtt.MATOATHUOC CATEGORY_NAME,
      0 FOLDER_LEVEL, 0 IS_FOLDER, 'KBNT_' + cast(kbtt.KHAMBENH_ID as varchar(20)) FOLDER_CODE, kbtt.KHAMBENH_ID PARENT_CODE, 1 CATEGORY_TYPE
      , kbtt.KHAMBENH_TOATHUOC_ID as REF_ID
      , 'TT_NGOAITRU_KHAMBENH_TOATHUOC' as REF_TABLE
      from TT_NGOAITRU_KHAMBENH KB
      inner join TT_TIEPNHAN TN ON TN.TIEPNHAN_ID = KB.TIEPNHAN_ID
      left join TT_NGOAITRU_KHAMBENH_TOATHUOC kbtt on kbtt.KHAMBENH_ID = kb.KHAMBENH_ID
      where TN.BENHNHAN_ID = $BENHNHAN_ID$ and KHAMBENH_TOATHUOC_ID is not null
      <!--can lam san menu tiep nhan-->
      select distinct C.SOBENHAN, C.BENHAN_ID, A.SOTIEPNHAN, A.NGAYTIEPNHAN, A.TIEPNHAN_ID, 'CANLAMSANG_MENU' ACTION,
      'KBCLS' + A.SOTIEPNHAN CATEGORY_ID,
      A.SOTIEPNHAN PARENT_ID,
      'KBCLS' + A.SOTIEPNHAN CATEGORY_CODE,
      N'Cận lâm sàng' CATEGORY_NAME,
      0 FOLDER_LEVEL, 1 IS_FOLDER, 'KHAMBENH' FOLDER_CODE, A.SOTIEPNHAN PARENT_CODE, 1 CATEGORY_TYPE
      from TT_TIEPNHAN A
      left join TT_BENHNHAN B on A.BENHNHAN_ID = B.BENHNHAN_ID
      left join TT_NOITRU_BENHAN C on C.TIEPNHAN_ID = A.TIEPNHAN_ID
      where A.BENHNHAN_ID = $BENHNHAN_ID$
      <!--Can lam sang-->
      select distinct tn.TIEPNHAN_ID, ba.SOBENHAN, ketqua.CLSKETQUA_ID, dv.DICHVU_ID, dv.TENDICHVU,'CANLAMSANG' ACTION,
      ketqua.CLSKETQUA_ID SOPHIEU, ketqua.CLSKETQUA_ID as KETQUA_ID,
      'KBCLS_' + cast(ketqua.CLSKETQUA_ID as varchar(20)) CATEGORY_ID,
      'KBCLS' + tn.SOTIEPNHAN PARENT_ID,
      'KBCLS_' + cast(ketqua.CLSKETQUA_ID as varchar(20)) CATEGORY_CODE,
      dv.TENDICHVU CATEGORY_NAME,
      0 FOLDER_LEVEL, 0 IS_FOLDER, 'KBCLS_' + cast(ketqua.CLSKETQUA_ID as varchar(20)) FOLDER_CODE, 'KBCLS' + tn.SOTIEPNHAN PARENT_CODE, 1 CATEGORY_TYPE
      , ketqua.CLSKETQUA_ID as REF_ID
      , 'TT_CLSKETQUA' as REF_TABLE
      from TT_DVYEUCAU dvyc
      inner join TM_DICHVU dv on dvyc.DICHVU_ID =dv.DICHVU_ID
      inner join TM_NHOMDICHVU nhom on dv.NHOMDICHVU_ID =nhom.NHOMDICHVU_ID
      inner join TT_TIEPNHAN tn on tn.TIEPNHAN_ID = dvyc.TIEPNHAN_ID
      left join TT_NOITRU_BENHAN ba on tn.TIEPNHAN_ID = ba.TIEPNHAN_ID
      inner join TT_CLSKETQUA ketqua on dvyc.dvyeucau_id=ketqua.dvyeucau_id
      where  tn.BENHNHAN_ID = $BENHNHAN_ID$ and dvyc.HUYYEUCAU='0'
      and exists (select DICHVU_ID from TM_DICHVU a join TM_NHOMDICHVU b on a.NHOMDICHVU_ID = b.NHOMDICHVU_ID
      where dvyc.DICHVU_ID = DICHVU_ID and left(b.MANHOMDICHVU,2) in ('02', '03'))
      and dvyc.BENHAN_ID is null

      <!--xet nghiem-->
      select distinct dvyc.DICHVU_ID ,dvyc.DICHVU_ID as DICHVUCHINH_ID, dvyc.TIEPNHAN_ID, dvyc.NOIYEUCAU_ID,clskq.CLSKETQUA_ID,'CANLAMSANG' ACTION,
      clskq.CLSKETQUA_ID as KETQUA_ID,
      'KBCLS_' + cast(clskq.CLSKETQUA_ID as varchar(20)) CATEGORY_ID,
      'KBCLS' + tn.SOTIEPNHAN PARENT_ID,
      'KBCLS_' + cast(clskq.CLSKETQUA_ID as varchar(20)) CATEGORY_CODE,
      dv.TENDICHVU CATEGORY_NAME,
      0 FOLDER_LEVEL, 0 IS_FOLDER, 'KBCLS_' + cast(clskq.CLSKETQUA_ID as varchar(20)) FOLDER_CODE, 'KBCLS' + tn.SOTIEPNHAN PARENT_CODE, 1 CATEGORY_TYPE
      , clskq.CLSKETQUA_ID as REF_ID
      , 'TT_CLSKETQUA' as REF_TABLE
      from TT_DVYEUCAU dvyc
      left join
      (
      select isnull(clskq.CLSKETQUA_ID, ct.CLSKETQUA_ID) as CLSKETQUA_ID, isnull(clskq.DVYEUCAU_ID, ct.DVYEUCAU_ID) as DVYEUCAU_ID, clskq.BENHAN_ID
      from TT_CLSKETQUA clskq join TT_CLSKETQUACHITIET ct on clskq.CLSKETQUA_ID = ct.CLSKETQUA_ID
      ) clskq on clskq.DVYEUCAU_ID = dvyc.DVYEUCAU_ID
      inner join TM_DICHVU dv on dvyc.DICHVU_ID =dv.DICHVU_ID
      inner join TM_NHOMDICHVU nhom on dv.NHOMDICHVU_ID =nhom.NHOMDICHVU_ID
      inner join TT_TIEPNHAN tn on tn.TIEPNHAN_ID = dvyc.TIEPNHAN_ID
      left join TT_NOITRU_BENHAN ba on tn.TIEPNHAN_ID = ba.TIEPNHAN_ID
      where  tn.BENHNHAN_ID = $BENHNHAN_ID$ and dvyc.HUYYEUCAU='0' and
      left(nhom.MANHOMDICHVU,2) != '04'  and left(nhom.MANHOMDICHVU,2)='01'
      and dvyc.BENHAN_ID is null

      <!--noi tru ************************************************************************-->
      select distinct C.SOBENHAN, C.BENHAN_ID, A.SOTIEPNHAN, A.NGAYTIEPNHAN, A.TIEPNHAN_ID,'NOITRU_MENU' ACTION,
      C.SOBENHAN CATEGORY_ID,
      cast(3 as varchar(10)) PARENT_ID,
      C.SOBENHAN CATEGORY_CODE,
      C.SOBENHAN +' (' + FORMAT (A.NGAYTIEPNHAN, 'dd/MM/yyyy') + ')' CATEGORY_NAME,
      0 FOLDER_LEVEL, 1 IS_FOLDER, 'DIEUTRI' FOLDER_CODE, 'DIEUTRI' PARENT_CODE, 1 CATEGORY_TYPE
      from TT_TIEPNHAN A
      left join TT_BENHNHAN B on A.BENHNHAN_ID = B.BENHNHAN_ID
      left join TT_NOITRU_BENHAN C on C.TIEPNHAN_ID = A.TIEPNHAN_ID
      where A.BENHNHAN_ID = $BENHNHAN_ID$ and C.SOBENHAN is not null
      <!--ho so noi tru-->
      select distinct C.SOBENHAN, C.BENHAN_ID, A.TIEPNHAN_ID SOTIEPNHAN, A.NGAYTIEPNHAN, A.TIEPNHAN_ID,'HOSO_NOITRU' ACTION, C.LOAIBENHAN_ID,
      'HSNT' + C.SOBENHAN CATEGORY_ID,
      C.SOBENHAN PARENT_ID,
      'HSNT' + C.SOBENHAN CATEGORY_CODE,
      N'Bệnh án' CATEGORY_NAME,
      0 FOLDER_LEVEL, 0 IS_FOLDER, 'DIEUTRI' FOLDER_CODE, C.SOBENHAN PARENT_CODE, 1 CATEGORY_TYPE
      , C.BENHAN_ID as REF_ID
      , 'TT_NOITRU_BENHAN' as REF_TABLE
      from TT_TIEPNHAN A
      left join TT_BENHNHAN B on A.BENHNHAN_ID = B.BENHNHAN_ID
      left join TT_NOITRU_BENHAN C on C.TIEPNHAN_ID = A.TIEPNHAN_ID
      where A.BENHNHAN_ID = $BENHNHAN_ID$ and C.SOBENHAN is not null

      <!--Benh an chuyen khoa-->
      select distinct C.SOBENHAN, C.BENHAN_ID, A.TIEPNHAN_ID SOTIEPNHAN, A.NGAYTIEPNHAN, A.TIEPNHAN_ID, C.LOAIBENHAN_ID,
      'BACK' + C.SOBENHAN CATEGORY_ID,
      C.SOBENHAN PARENT_ID,
      'BACK' + C.SOBENHAN CATEGORY_CODE,
      N'Bệnh án chuyên khoa' CATEGORY_NAME,
      0 FOLDER_LEVEL, 1 IS_FOLDER, 'DIEUTRI' FOLDER_CODE, C.SOBENHAN PARENT_CODE, 1 CATEGORY_TYPE
      from TT_TIEPNHAN A
      inner join TT_BENHNHAN B on A.BENHNHAN_ID = B.BENHNHAN_ID
      inner join TT_NOITRU_BENHAN C on C.TIEPNHAN_ID = A.TIEPNHAN_ID
      inner join TT_NOITRU_BENHANCHUYENKHOA_CHITIET ct on ct.BENHAN_ID = C.BENHAN_ID
      where A.BENHNHAN_ID = $BENHNHAN_ID$ and C.SOBENHAN is not null

      <!--Chuyen khoa mat-->
      select distinct top 1 C.SOBENHAN, C.BENHAN_ID, A.TIEPNHAN_ID
      , A.NGAYTIEPNHAN, C.LOAIBENHAN_ID
      , 'CHUYENKHOAMAT' ACTION
      , 'CKMCT_' + C.SOBENHAN CATEGORY_ID
      , 'BACK' + C.SOBENHAN PARENT_ID
      , 'CKMCT_' + C.SOBENHAN CATEGORY_CODE
      , N'Bệnh án chuyên khoa mắt' CATEGORY_NAME
      , 0 FOLDER_LEVEL, 0 IS_FOLDER, 'DIEUTRI' FOLDER_CODE, 'BACK' + C.SOBENHAN PARENT_CODE, 1 CATEGORY_TYPE
      , c.BENHAN_ID as REF_ID
      , 'BENHAN_CHUYENKHOAMAT' as REF_TABLE
      from TT_TIEPNHAN A
      inner join TT_BENHNHAN B on A.BENHNHAN_ID = B.BENHNHAN_ID
      inner join TT_NOITRU_BENHAN C on C.TIEPNHAN_ID = A.TIEPNHAN_ID
      inner join TT_NOITRU_BENHANCHUYENKHOA_CHITIET ct on ct.BENHAN_ID = C.BENHAN_ID
      where A.BENHNHAN_ID = $BENHNHAN_ID$ and C.SOBENHAN is not null and ct.LOAIBENHAN = 'BA_MAT'

      <!--Chuyen khoa tai mui hong-->
      select distinct top 1 C.SOBENHAN, C.BENHAN_ID, A.TIEPNHAN_ID
      , A.NGAYTIEPNHAN, C.LOAIBENHAN_ID
      , 'CHUYENKHOATMH' ACTION
      , 'CKTMHCT_' + C.SOBENHAN CATEGORY_ID
      , 'BACK' + C.SOBENHAN PARENT_ID
      , 'CKTMHCT_' + C.SOBENHAN CATEGORY_CODE
      , N'Bệnh án chuyên khoa tai mũi họng' CATEGORY_NAME
      , 0 FOLDER_LEVEL, 0 IS_FOLDER, 'DIEUTRI' FOLDER_CODE, 'BACK' + C.SOBENHAN PARENT_CODE, 1 CATEGORY_TYPE
      , c.BENHAN_ID as REF_ID
      , 'BENHAN_CHUYENKHOATMH' as REF_TABLE
      from TT_TIEPNHAN A
      inner join TT_BENHNHAN B on A.BENHNHAN_ID = B.BENHNHAN_ID
      inner join TT_NOITRU_BENHAN C on C.TIEPNHAN_ID = A.TIEPNHAN_ID
      inner join TT_NOITRU_BENHANCHUYENKHOA_CHITIET ct on ct.BENHAN_ID = C.BENHAN_ID
      where A.BENHNHAN_ID = $BENHNHAN_ID$ and C.SOBENHAN is not null and ct.LOAIBENHAN = 'BA_TMH'
      
      <!--Chuyen khoa rang ham mat-->
      select distinct top 1 C.SOBENHAN, C.BENHAN_ID, A.TIEPNHAN_ID
      , A.NGAYTIEPNHAN, C.LOAIBENHAN_ID
      , 'CHUYENKHOARHM' ACTION
      , 'CKRMTCT_' + C.SOBENHAN CATEGORY_ID
      , 'BACK' + C.SOBENHAN PARENT_ID
      , 'CKRMTCT_' + C.SOBENHAN CATEGORY_CODE
      , N'Bệnh án chuyên khoa răng hàm mặt' CATEGORY_NAME
      , 0 FOLDER_LEVEL, 0 IS_FOLDER, 'DIEUTRI' FOLDER_CODE, 'BACK' + C.SOBENHAN PARENT_CODE, 1 CATEGORY_TYPE
      , c.BENHAN_ID as REF_ID
      , 'BENHAN_CHUYENKHOATRHM' as REF_TABLE
      from TT_TIEPNHAN A
      inner join TT_BENHNHAN B on A.BENHNHAN_ID = B.BENHNHAN_ID
      inner join TT_NOITRU_BENHAN C on C.TIEPNHAN_ID = A.TIEPNHAN_ID
      inner join TT_NOITRU_BENHANCHUYENKHOA_CHITIET ct on ct.BENHAN_ID = C.BENHAN_ID
      where A.BENHNHAN_ID = $BENHNHAN_ID$ and C.SOBENHAN is not null and ct.LOAIBENHAN = 'BA_RHM'

      <!--Chuyen khoa tai mui hong-->
      select distinct top 1 C.SOBENHAN, C.BENHAN_ID, A.TIEPNHAN_ID
      , A.NGAYTIEPNHAN, C.LOAIBENHAN_ID
      , 'CHUYENKHOATRUYENNHIEM' ACTION
      , 'CKTNCT_' + C.SOBENHAN CATEGORY_ID
      , 'BACK' + C.SOBENHAN PARENT_ID
      , 'CKTNCT_' + C.SOBENHAN CATEGORY_CODE
      , N'Bệnh án chuyên khoa truyền nhiễm' CATEGORY_NAME
      , 0 FOLDER_LEVEL, 0 IS_FOLDER, 'DIEUTRI' FOLDER_CODE, 'BACK' + C.SOBENHAN PARENT_CODE, 1 CATEGORY_TYPE
      , c.BENHAN_ID as REF_ID
      , 'BENHAN_CHUYENKHOATRUYENNHIEM' as REF_TABLE
      from TT_TIEPNHAN A
      inner join TT_BENHNHAN B on A.BENHNHAN_ID = B.BENHNHAN_ID
      inner join TT_NOITRU_BENHAN C on C.TIEPNHAN_ID = A.TIEPNHAN_ID
      inner join TT_NOITRU_BENHANCHUYENKHOA_CHITIET ct on ct.BENHAN_ID = C.BENHAN_ID
      where A.BENHNHAN_ID = $BENHNHAN_ID$ and C.SOBENHAN is not null and ct.LOAIBENHAN = 'BA_TRUYENNHIEM'

      <!--phieu dieu tri-->
      select distinct C.SOBENHAN, C.BENHAN_ID, A.TIEPNHAN_ID SOTIEPNHAN, A.NGAYTIEPNHAN, A.TIEPNHAN_ID, C.LOAIBENHAN_ID,
      'PDT' + C.SOBENHAN CATEGORY_ID,
      C.SOBENHAN PARENT_ID,
      'PDT' + C.SOBENHAN CATEGORY_CODE,
      N'Tờ điều trị' CATEGORY_NAME,
      0 FOLDER_LEVEL, 1 IS_FOLDER, 'DIEUTRI' FOLDER_CODE, C.SOBENHAN PARENT_CODE, 1 CATEGORY_TYPE
      from TT_TIEPNHAN A
      inner join TT_BENHNHAN B on A.BENHNHAN_ID = B.BENHNHAN_ID
      inner join TT_NOITRU_BENHAN C on C.TIEPNHAN_ID = A.TIEPNHAN_ID
      where A.BENHNHAN_ID = $BENHNHAN_ID$ and C.SOBENHAN is not null
      <!--ylenh phieu dieu tri-->
      select distinct  kb.KHAMBENH_ID SOKHAMBENH, kb.KHAMBENH_ID, BA.BENHAN_ID, BA.TIEPNHAN_ID SOTIEPNHAN,
      isnull(KB.LOAITOATHUOC, 'VT') LOAITOATHUOC,
      'YLENH_' + cast(kb.KHAMBENH_ID as varchar(20)) CATEGORY_ID,'YLENH' ACTION,
      'PDT' + BA.SOBENHAN  PARENT_ID,
      'YLENH_' + cast(kb.KHAMBENH_ID as varchar(20)) CATEGORY_CODE,
      FORMAT (kb.THOIGIANKHAM, 'dd/MM/yyyy') + ' (' + FORMAT (kb.THOIGIANKHAM, 'hh:mm') + ') - ' + pb.TENPHONGBAN CATEGORY_NAME,
      0 FOLDER_LEVEL, 0 IS_FOLDER, BA.SOBENHAN  FOLDER_CODE, 'PDT' + BA.SOBENHAN PARENT_CODE, 1 CATEGORY_TYPE
      , kb.KHAMBENH_ID as REF_ID
      , 'TT_NOITRU_KHAMBENH' as REF_TABLE
      from TT_NOITRU_KHAMBENH KB
      inner join TT_NOITRU_BENHAN BA ON BA.BENHAN_ID = KB.BENHAN_ID
      left join TM_PHONGBAN pb on pb.PHONGBAN_ID = kb.PHONGBAN_ID
      where BA.BENHNHAN_ID = $BENHNHAN_ID$ order by kb.KHAMBENH_ID desc
      <!--tom tat ba-->
      select distinct C.SOBENHAN, C.BENHAN_ID, A.TIEPNHAN_ID SOTIEPNHAN, A.NGAYTIEPNHAN, A.TIEPNHAN_ID,'TOMTAT_BA' ACTION, C.LOAIBENHAN_ID,
      'TTBA' + C.SOBENHAN CATEGORY_ID,
      C.SOBENHAN PARENT_ID,
      'TTBA' + C.SOBENHAN CATEGORY_CODE,
      N'Tóm tắt bệnh án' CATEGORY_NAME,
      0 FOLDER_LEVEL, 0 IS_FOLDER, 'DIEUTRI' FOLDER_CODE, C.SOBENHAN PARENT_CODE, 1 CATEGORY_TYPE
      , C.BENHAN_ID as REF_ID
      , 'TOMTATBENHAN' as REF_TABLE
      from TT_TIEPNHAN A
      inner join TT_BENHNHAN B on A.BENHNHAN_ID = B.BENHNHAN_ID
      inner join TT_NOITRU_BENHAN C on C.TIEPNHAN_ID = A.TIEPNHAN_ID
      where A.BENHNHAN_ID = $BENHNHAN_ID$ and C.SOBENHAN is not null
      <!--phieu so ket-->
      select distinct C.SOBENHAN, C.BENHAN_ID, A.TIEPNHAN_ID SOTIEPNHAN
      , A.NGAYTIEPNHAN, A.TIEPNHAN_ID,'SOKET' ACTION, C.LOAIBENHAN_ID, d.BENHAN_SOKET_ID
      , 'PSK' + C.SOBENHAN CATEGORY_ID,
      C.SOBENHAN PARENT_ID,
      'PSK' + C.SOBENHAN CATEGORY_CODE,
      N'Phiếu sơ kết 15 ngày điều trị' CATEGORY_NAME,
      0 FOLDER_LEVEL, 0 IS_FOLDER, 'DIEUTRI' FOLDER_CODE, C.SOBENHAN PARENT_CODE, 1 CATEGORY_TYPE
      , d.BENHAN_SOKET_ID as REF_ID
      , 'TT_NOITRU_SOKET' as REF_TABLE
      from TT_TIEPNHAN A
      inner join TT_BENHNHAN B on A.BENHNHAN_ID = B.BENHNHAN_ID
      inner join TT_NOITRU_BENHAN C on C.TIEPNHAN_ID = A.TIEPNHAN_ID
      inner join TT_NOITRU_SOKET d on d.BENHAN_ID = c.BENHAN_ID
      where A.BENHNHAN_ID = $BENHNHAN_ID$ and C.SOBENHAN is not null
      <!--Giấy ra viện-->
      select distinct C.SOBENHAN, C.BENHAN_ID, A.TIEPNHAN_ID SOTIEPNHAN, A.NGAYTIEPNHAN, A.TIEPNHAN_ID,'GIAYRAVIEN' ACTION, C.LOAIBENHAN_ID,
      'GRV' + C.SOBENHAN CATEGORY_ID,
      C.SOBENHAN PARENT_ID,
      'GRV' + C.SOBENHAN CATEGORY_CODE,
      N'Giấy ra viện' CATEGORY_NAME,
      0 FOLDER_LEVEL, 0 IS_FOLDER, 'DIEUTRI' FOLDER_CODE, C.SOBENHAN PARENT_CODE, 1 CATEGORY_TYPE
      , c.BENHAN_ID as REF_ID
      , 'NOITRU_RAVIEN' as REF_TABLE
      from TT_TIEPNHAN A
      inner join TT_BENHNHAN B on A.BENHNHAN_ID = B.BENHNHAN_ID
      inner join TT_NOITRU_BENHAN C on C.TIEPNHAN_ID = A.TIEPNHAN_ID
      where A.BENHNHAN_ID = $BENHNHAN_ID$ and C.SOBENHAN is not null and C.NGAYRAVIEN is not null
      <!--Giấy chung nhan thuong tich-->
      select distinct C.SOBENHAN, C.BENHAN_ID, A.TIEPNHAN_ID SOTIEPNHAN, A.NGAYTIEPNHAN, A.TIEPNHAN_ID
      ,'CHUNGNHANTHUONGTICH' ACTION, C.LOAIBENHAN_ID
      , 'GCNTT' + C.SOBENHAN CATEGORY_ID
      , C.SOBENHAN PARENT_ID
      , 'GCNTT' + C.SOBENHAN CATEGORY_CODE
      , N'Giấy chứng nhận thương tích' CATEGORY_NAME
      , 0 FOLDER_LEVEL, 0 IS_FOLDER, 'DIEUTRI' FOLDER_CODE, C.SOBENHAN PARENT_CODE, 1 CATEGORY_TYPE
      , c.BENHAN_ID as REF_ID
      , 'CHUNGNHAN_THUONGTICH' as REF_TABLE
      from TT_TIEPNHAN A
      inner join TT_BENHNHAN B on A.BENHNHAN_ID = B.BENHNHAN_ID
      inner join TT_NOITRU_BENHAN C on C.TIEPNHAN_ID = A.TIEPNHAN_ID
      where A.BENHNHAN_ID = $BENHNHAN_ID$ and C.SOBENHAN is not null
      <!--Phan ung thuoc ADR-->
      select distinct C.SOBENHAN, C.BENHAN_ID, A.TIEPNHAN_ID SOTIEPNHAN, A.NGAYTIEPNHAN, A.TIEPNHAN_ID
      ,'PHANUNGTHUOCADR' ACTION, C.LOAIBENHAN_ID
      , D.PHANUNGTHUOCCOHAI_ID
      , 'PUTADR' + C.SOBENHAN CATEGORY_ID
      , C.SOBENHAN PARENT_ID
      , 'PUTADR' + C.SOBENHAN CATEGORY_CODE
      , N'Phản ứng thuốc ADR' CATEGORY_NAME
      , 0 FOLDER_LEVEL, 0 IS_FOLDER, 'DIEUTRI' FOLDER_CODE, C.SOBENHAN PARENT_CODE, 1 CATEGORY_TYPE
      , c.BENHAN_ID as REF_ID
      , 'TT_NOITRU_THUPUTCH' as REF_TABLE
      from TT_TIEPNHAN A
      inner join TT_BENHNHAN B on A.BENHNHAN_ID = B.BENHNHAN_ID
      inner join TT_NOITRU_BENHAN C on C.TIEPNHAN_ID = A.TIEPNHAN_ID
      inner join TT_NOITRU_THUPUTCH D on D.BENHAN_ID = C.BENHAN_ID
      where A.BENHNHAN_ID = $BENHNHAN_ID$ and C.SOBENHAN is not null
      <!--Bien ban hoi chan-->
      select distinct C.SOBENHAN, C.BENHAN_ID, A.TIEPNHAN_ID SOTIEPNHAN, A.NGAYTIEPNHAN, A.TIEPNHAN_ID
      ,'BIENBANHOICHAN' ACTION, C.LOAIBENHAN_ID
      , B.BENHNHAN_ID
      , D.BIENBANHOICHAN_ID
      , 'BBHC' + C.SOBENHAN CATEGORY_ID
      , C.SOBENHAN PARENT_ID
      , 'BBHC' + C.SOBENHAN CATEGORY_CODE
      , N'Biên bản hội chẩn' CATEGORY_NAME
      , 0 FOLDER_LEVEL, 0 IS_FOLDER, 'DIEUTRI' FOLDER_CODE, C.SOBENHAN PARENT_CODE, 1 CATEGORY_TYPE
      , D.BIENBANHOICHAN_ID as REF_ID
      , 'TT_BIENBANHOICHAN' as REF_TABLE
      from TT_TIEPNHAN A
      inner join TT_BENHNHAN B on A.BENHNHAN_ID = B.BENHNHAN_ID
      inner join TT_NOITRU_BENHAN C on C.TIEPNHAN_ID = A.TIEPNHAN_ID
      inner join TT_BIENBANHOICHAN D on D.BENHAN_ID = C.BENHAN_ID
      where A.BENHNHAN_ID = $BENHNHAN_ID$ and C.SOBENHAN is not null
      <!--Giấy chuyen viện-->
      select distinct C.SOBENHAN, C.BENHAN_ID, A.TIEPNHAN_ID SOTIEPNHAN, A.NGAYTIEPNHAN, A.TIEPNHAN_ID,'GIAYCHUYENVIEN' ACTION, C.LOAIBENHAN_ID,
      'GVV' + C.SOBENHAN CATEGORY_ID,
      C.SOBENHAN PARENT_ID,
      'GCV' + C.SOBENHAN CATEGORY_CODE,
      N'Giấy chuyển viện' CATEGORY_NAME,
      0 FOLDER_LEVEL, 0 IS_FOLDER, 'DIEUTRI' FOLDER_CODE, C.SOBENHAN PARENT_CODE, 1 CATEGORY_TYPE
      , d.CHUYENVIEN_ID as REF_ID
      , 'TT_CHUYENVIEN' as REF_TABLE
      from TT_TIEPNHAN A
      inner join TT_BENHNHAN B on A.BENHNHAN_ID = B.BENHNHAN_ID
      inner join TT_NOITRU_BENHAN C on C.TIEPNHAN_ID = A.TIEPNHAN_ID
      inner join TT_CHUYENVIEN d on d.TIEPNHAN_ID = a.TIEPNHAN_ID
      where A.BENHNHAN_ID = $BENHNHAN_ID$ and C.SOBENHAN is not null
      <!--Dich truyen-->
      select distinct C.SOBENHAN, C.BENHAN_ID, A.TIEPNHAN_ID SOTIEPNHAN, A.NGAYTIEPNHAN, A.TIEPNHAN_ID, C.LOAIBENHAN_ID,
      'PDTruyen' + C.SOBENHAN CATEGORY_ID,
      C.SOBENHAN PARENT_ID,
      'PDTruyen' + C.SOBENHAN CATEGORY_CODE,
      N'Phiếu truyền dịch' CATEGORY_NAME,
      0 FOLDER_LEVEL, 1 IS_FOLDER, 'DIEUTRI' FOLDER_CODE, C.SOBENHAN PARENT_CODE, 1 CATEGORY_TYPE
      from TT_TIEPNHAN A
      inner join TT_BENHNHAN B on A.BENHNHAN_ID = B.BENHNHAN_ID
      inner join TT_NOITRU_BENHAN C on C.TIEPNHAN_ID = A.TIEPNHAN_ID
      where A.BENHNHAN_ID = $BENHNHAN_ID$ and C.SOBENHAN is not null
      <!--chi tiet phieu dich truyen-->
      select distinct C.SOBENHAN, C.BENHAN_ID, A.TIEPNHAN_ID SOTIEPNHAN, A.NGAYTIEPNHAN, A.TIEPNHAN_ID, C.LOAIBENHAN_ID,
      cs.CHAMSOCDICHTRUYEN_ID, 'DICHTRUYEN' ACTION
      , 'PDTCT_' + cast(cs.CHAMSOCDICHTRUYEN_ID as varchar(20)) CATEGORY_ID
      , 'PDTruyen' + C.SOBENHAN PARENT_ID
      , 'PDTCT_' + cast(cs.CHAMSOCDICHTRUYEN_ID as varchar(20)) CATEGORY_CODE
      , FORMAT (cs.THOIGIANBATDAU, 'dd/MM/yyyy hh:mm:ss') + ' (' + FORMAT(cs.THOIGIANBATDAU, 'hh:mm:ss') + ')' CATEGORY_NAME
      , 0 FOLDER_LEVEL, 0 IS_FOLDER, 'DIEUTRI' FOLDER_CODE, 'PDTruyen' + C.SOBENHAN PARENT_CODE, 1 CATEGORY_TYPE
      , cs.CHAMSOCDICHTRUYEN_ID as REF_ID
      , 'TT_NOITRU_CHAMSOCDICHTRUYEN' as REF_TABLE
      from TT_TIEPNHAN A
      inner join TT_BENHNHAN B on A.BENHNHAN_ID = B.BENHNHAN_ID
      inner join TT_NOITRU_BENHAN C on C.TIEPNHAN_ID = A.TIEPNHAN_ID
      inner join TT_NOITRU_CHAMSOCDICHTRUYEN cs on cs.BENHAN_ID = c.BENHAN_ID
      where A.BENHNHAN_ID = $BENHNHAN_ID$ and C.SOBENHAN is not null
      <!--CN PTTT-->
      select distinct C.SOBENHAN, C.BENHAN_ID, A.TIEPNHAN_ID SOTIEPNHAN, A.NGAYTIEPNHAN, A.TIEPNHAN_ID,'CHUNGNHANPT' ACTION, C.LOAIBENHAN_ID,
      'CNPT' + C.SOBENHAN CATEGORY_ID,
      C.SOBENHAN PARENT_ID,
      'CNPT' + C.SOBENHAN CATEGORY_CODE,
      N'Chứng nhận phẫu thuật' CATEGORY_NAME,
      0 FOLDER_LEVEL, 0 IS_FOLDER, 'DIEUTRI' FOLDER_CODE, C.SOBENHAN PARENT_CODE, 1 CATEGORY_TYPE
      , C.BENHAN_ID as REF_ID
      , 'CHUNGNHAN_PHAUTHUAT' as REF_TABLE
      from TT_TIEPNHAN A
      inner join TT_BENHNHAN B on A.BENHNHAN_ID = B.BENHNHAN_ID
      inner join TT_NOITRU_BENHAN C on C.TIEPNHAN_ID = A.TIEPNHAN_ID
      where A.BENHNHAN_ID = $BENHNHAN_ID$ and C.SOBENHAN is not null
      <!--phieu chuc nang song-->
      select distinct C.SOBENHAN, C.BENHAN_ID, A.TIEPNHAN_ID SOTIEPNHAN, A.NGAYTIEPNHAN, A.TIEPNHAN_ID,'CHUCNANGSONG' ACTION, C.LOAIBENHAN_ID,
      'TDCNS' + C.SOBENHAN CATEGORY_ID,
      C.SOBENHAN PARENT_ID,
      'TDCNS' + C.SOBENHAN CATEGORY_CODE,
      N'Theo dõi chức năng sống' CATEGORY_NAME,
      0 FOLDER_LEVEL, 0 IS_FOLDER, 'DIEUTRI' FOLDER_CODE, C.SOBENHAN PARENT_CODE, 1 CATEGORY_TYPE
      , C.BENHAN_ID as REF_ID
      , 'CHUCNANGSONG' as REF_TABLE
      from TT_TIEPNHAN A
      inner join TT_BENHNHAN B on A.BENHNHAN_ID = B.BENHNHAN_ID
      inner join TT_NOITRU_BENHAN C on C.TIEPNHAN_ID = A.TIEPNHAN_ID
      where A.BENHNHAN_ID = $BENHNHAN_ID$ and C.SOBENHAN is not null
      <!--phieu cham soc-->
      select distinct C.SOBENHAN, C.BENHAN_ID, A.TIEPNHAN_ID SOTIEPNHAN, A.NGAYTIEPNHAN, A.TIEPNHAN_ID, C.LOAIBENHAN_ID,
      'PCS' + C.SOBENHAN CATEGORY_ID,
      C.SOBENHAN PARENT_ID,
      'PCS' + C.SOBENHAN CATEGORY_CODE,
      N'Phiếu chăm sóc' CATEGORY_NAME,
      0 FOLDER_LEVEL, 1 IS_FOLDER, 'DIEUTRI' FOLDER_CODE, C.SOBENHAN PARENT_CODE, 1 CATEGORY_TYPE
      from TT_TIEPNHAN A
      inner join TT_BENHNHAN B on A.BENHNHAN_ID = B.BENHNHAN_ID
      inner join TT_NOITRU_BENHAN C on C.TIEPNHAN_ID = A.TIEPNHAN_ID
      where A.BENHNHAN_ID = $BENHNHAN_ID$ and C.SOBENHAN is not null
      <!--chi tiet phieu cham soc-->
      select distinct C.SOBENHAN, C.BENHAN_ID, A.TIEPNHAN_ID SOTIEPNHAN, A.NGAYTIEPNHAN, A.TIEPNHAN_ID, C.LOAIBENHAN_ID,
      cs.CHAMSOC_ID CHAMSOC, 'CHAMSOC' ACTION,
      'PCSCT_' + cast(cs.CHAMSOC_ID as varchar(20)) CATEGORY_ID,
      'PCS' + C.SOBENHAN PARENT_ID,
      'PCSCT_' + cast(cs.CHAMSOC_ID as varchar(20)) CATEGORY_CODE,
      FORMAT (cs.THOIGIANTHUCHIEN, 'dd/MM/yyyy hh:mm:ss') + ' (' + FORMAT(cs.THOIGIANTHUCHIEN, 'hh:mm:ss') + ')' CATEGORY_NAME,
      0 FOLDER_LEVEL, 0 IS_FOLDER, 'DIEUTRI' FOLDER_CODE, 'PCS' + C.SOBENHAN PARENT_CODE, 1 CATEGORY_TYPE
      , cs.CHAMSOC_ID as REF_ID
      , 'TT_NOITRU_CHAMSOC' as REF_TABLE
      from TT_TIEPNHAN A
      inner join TT_BENHNHAN B on A.BENHNHAN_ID = B.BENHNHAN_ID
      inner join TT_NOITRU_BENHAN C on C.TIEPNHAN_ID = A.TIEPNHAN_ID
      inner join TT_NOITRU_CHAMSOC cs on cs.BENHAN_ID = c.BENHAN_ID
      where A.BENHNHAN_ID = $BENHNHAN_ID$ and C.SOBENHAN is not null and cs.CHAMSOC_ID is not null
      order by cs.CHAMSOC_ID
      <!--can lam sang menu noi tru-->
      select distinct C.SOBENHAN, C.BENHAN_ID, A.SOTIEPNHAN, A.NGAYTIEPNHAN, A.TIEPNHAN_ID,'CANLAMSANG_MENU' ACTION,
      'ANTCLS' + C.SOBENHAN CATEGORY_ID,
      C.SOBENHAN PARENT_ID,
      'ANTCLS' + C.SOBENHAN CATEGORY_CODE,
      N'Cận lâm sàng' CATEGORY_NAME,
      0 FOLDER_LEVEL, 1 IS_FOLDER, 'DIEUTRI' FOLDER_CODE, C.SOBENHAN PARENT_CODE, 1 CATEGORY_TYPE
      from TT_TIEPNHAN A
      inner join TT_BENHNHAN B on A.BENHNHAN_ID = B.BENHNHAN_ID
      inner join TT_NOITRU_BENHAN C on C.TIEPNHAN_ID = A.TIEPNHAN_ID
      where A.BENHNHAN_ID = $BENHNHAN_ID$ and C.SOBENHAN is not null
      <!--Can lam sang-->
      select distinct tn.TIEPNHAN_ID, ba.SOBENHAN, ketqua.CLSKETQUA_ID, dv.DICHVU_ID, dv.TENDICHVU,'CANLAMSANG' ACTION,
      ketqua.CLSKETQUA_ID SOPHIEU, ketqua.CLSKETQUA_ID as KETQUA_ID,
      'NTCLS' + cast(ketqua.CLSKETQUA_ID as varchar(20)) CATEGORY_ID,
      'ANTCLS' + ba.SOBENHAN PARENT_ID,
      'NTCLS_' + cast(ketqua.CLSKETQUA_ID as varchar(20)) CATEGORY_CODE,
      dv.TENDICHVU CATEGORY_NAME,
      0 FOLDER_LEVEL, 0 IS_FOLDER, 'NTCLS_' + cast(ketqua.CLSKETQUA_ID as varchar(20)) FOLDER_CODE, 'ANTCLS' + ba.SOBENHAN PARENT_CODE, 1 CATEGORY_TYPE
      , ketqua.CLSKETQUA_ID as REF_ID
      , 'TT_CLSKETQUA' as REF_TABLE
      from TT_DVYEUCAU dvyc
      inner join TM_DICHVU dv on dvyc.DICHVU_ID =dv.DICHVU_ID
      inner join TM_NHOMDICHVU nhom on dv.NHOMDICHVU_ID =nhom.NHOMDICHVU_ID
      inner join TT_TIEPNHAN tn on tn.TIEPNHAN_ID = dvyc.TIEPNHAN_ID
      inner join TT_NOITRU_BENHAN ba on tn.TIEPNHAN_ID = ba.TIEPNHAN_ID
      inner join TT_CLSKETQUA ketqua on dvyc.dvyeucau_id=ketqua.dvyeucau_id
      where  tn.BENHNHAN_ID = $BENHNHAN_ID$ and dvyc.HUYYEUCAU='0'
      and exists (select DICHVU_ID from TM_DICHVU a join TM_NHOMDICHVU b on a.NHOMDICHVU_ID = b.NHOMDICHVU_ID
      where dvyc.DICHVU_ID = DICHVU_ID and left(b.MANHOMDICHVU,2) in ('02', '03'))
      and ba.SOBENHAN is not null and dvyc.BENHAN_ID is not null
      <!--xet nghiem-->
      select distinct dvyc.DICHVU_ID ,dvyc.DICHVU_ID as DICHVUCHINH_ID, dvyc.TIEPNHAN_ID, dvyc.NOIYEUCAU_ID,clskq.CLSKETQUA_ID,'CANLAMSANG' ACTION,
      clskq.CLSKETQUA_ID as KETQUA_ID,
      'NTCLS_' + cast(clskq.CLSKETQUA_ID as varchar(20)) CATEGORY_ID,
      'ANTCLS' + ba.SOBENHAN PARENT_ID,
      'NTCLS_' + cast(clskq.CLSKETQUA_ID as varchar(20)) CATEGORY_CODE,
      dv.TENDICHVU CATEGORY_NAME,
      0 FOLDER_LEVEL, 0 IS_FOLDER, 'KBCLS_' + cast(clskq.CLSKETQUA_ID as varchar(20)) FOLDER_CODE, 'AKBCLS' + ba.SOBENHAN PARENT_CODE, 1 CATEGORY_TYPE
      , clskq.CLSKETQUA_ID as REF_ID
      , 'TT_CLSKETQUA' as REF_TABLE
      from TT_DVYEUCAU dvyc
      left join
      (
      select isnull(clskq.CLSKETQUA_ID, ct.CLSKETQUA_ID) as CLSKETQUA_ID, isnull(clskq.DVYEUCAU_ID, ct.DVYEUCAU_ID) as DVYEUCAU_ID, clskq.BENHAN_ID
      from TT_CLSKETQUA clskq join TT_CLSKETQUACHITIET ct on clskq.CLSKETQUA_ID = ct.CLSKETQUA_ID
      ) clskq on clskq.DVYEUCAU_ID = dvyc.DVYEUCAU_ID
      inner join TM_DICHVU dv on dvyc.DICHVU_ID =dv.DICHVU_ID
      inner join TM_NHOMDICHVU nhom on dv.NHOMDICHVU_ID =nhom.NHOMDICHVU_ID
      inner join TT_TIEPNHAN tn on tn.TIEPNHAN_ID = dvyc.TIEPNHAN_ID
      inner join TT_NOITRU_BENHAN ba on tn.TIEPNHAN_ID = ba.TIEPNHAN_ID
      where  tn.BENHNHAN_ID = $BENHNHAN_ID$ and dvyc.HUYYEUCAU='0' and
      left(nhom.MANHOMDICHVU,2) != '04'  and left(nhom.MANHOMDICHVU,2)='01'
      and ba.SOBENHAN is not null and dvyc.BENHAN_ID is not null
      <!--phau thuat menu noi tru-->
      select distinct C.SOBENHAN, C.BENHAN_ID, A.SOTIEPNHAN, A.NGAYTIEPNHAN, A.TIEPNHAN_ID,'CANLAMSANG_MENU' ACTION,
      'PT' + C.SOBENHAN CATEGORY_ID,
      C.SOBENHAN PARENT_ID,
      'PT' + C.SOBENHAN CATEGORY_CODE,
      N'Phẫu thuật - thủ thuật' CATEGORY_NAME,
      0 FOLDER_LEVEL, 1 IS_FOLDER, 'DIEUTRI' FOLDER_CODE, C.SOBENHAN PARENT_CODE, 1 CATEGORY_TYPE
      from TT_TIEPNHAN A
      inner join TT_BENHNHAN B on A.BENHNHAN_ID = B.BENHNHAN_ID
      inner join TT_NOITRU_BENHAN C on C.TIEPNHAN_ID = A.TIEPNHAN_ID
      where A.BENHNHAN_ID = $BENHNHAN_ID$ and C.SOBENHAN is not null
      <!--phau thuat thu thuat-->
      select distinct tn.TIEPNHAN_ID, ba.SOBENHAN, ptyc.PHAUTHUAT_ID
      , dv.TENDICHVU,'PHAUTHUAT' ACTION
      , 'PTTT_' + cast( ptyc.PHAUTHUAT_YEUCAU_ID as varchar(20)) CATEGORY_ID
      , 'PT' + ba.SOBENHAN PARENT_ID
      , 'PTTT_' + cast( ptyc.PHAUTHUAT_YEUCAU_ID as varchar(20)) CATEGORY_CODE
      , dv.TENDICHVU CATEGORY_NAME
      , 0 FOLDER_LEVEL, 0 IS_FOLDER, ba.SOBENHAN FOLDER_CODE
      , 'PT' + ba.SOBENHAN PARENT_CODE, 1 CATEGORY_TYPE
      , ptyc.PHAUTHUAT_ID as REF_ID
      , 'TT_PHAUTHUAT' as REF_TABLE
      from TT_PHAUTHUAT_YEUCAU as ptyc
      inner join TT_PHAUTHUAT as pt on pt.PHAUTHUAT_ID = ptyc.PHAUTHUAT_ID
      inner join TT_DVYEUCAU dvyc on ptyc.DVYEUCAU_ID = dvyc.DVYEUCAU_ID
      inner join TM_DICHVU dv on dvyc.DICHVU_ID =dv.DICHVU_ID
      inner join TT_TIEPNHAN tn on tn.TIEPNHAN_ID = dvyc.TIEPNHAN_ID
      inner join TT_NOITRU_BENHAN ba on tn.TIEPNHAN_ID = ba.TIEPNHAN_ID
      where dvyc.DVYEUCAU_ID is not null and dvyc.HUYYEUCAU='0' and ba.SOBENHAN is not null
      and dvyc.BENHNHAN_ID = $BENHNHAN_ID$ and pt.BENHAN_ID is not null
      and dv.MADICHVU not in ('17665')

      <!--phieu kham tien me-->
      select distinct C.SOBENHAN, C.BENHAN_ID, A.TIEPNHAN_ID SOTIEPNHAN, A.NGAYTIEPNHAN, A.TIEPNHAN_ID, C.LOAIBENHAN_ID,
      'KTM' + C.SOBENHAN CATEGORY_ID,
      C.SOBENHAN PARENT_ID,
      'KTM' + C.SOBENHAN CATEGORY_CODE,
      N'Phiếu khám tiền mê' CATEGORY_NAME,
      0 FOLDER_LEVEL, 1 IS_FOLDER, 'DIEUTRI' FOLDER_CODE, C.SOBENHAN PARENT_CODE, 1 CATEGORY_TYPE
      from TT_TIEPNHAN A
      inner join TT_BENHNHAN B on A.BENHNHAN_ID = B.BENHNHAN_ID
      inner join TT_NOITRU_BENHAN C on C.TIEPNHAN_ID = A.TIEPNHAN_ID
      inner join TT_NOITRU_KHAMTIENME D on D.TIEPNHAN_ID = A.TIEPNHAN_ID
      where A.BENHNHAN_ID = $BENHNHAN_ID$ and C.SOBENHAN is not null
      <!--chi tiet phieu kham tien me-->
      select distinct C.SOBENHAN, C.BENHAN_ID, A.TIEPNHAN_ID SOTIEPNHAN, A.NGAYTIEPNHAN, A.TIEPNHAN_ID, C.LOAIBENHAN_ID,
      cs.KHAMTIENME_ID, 'KHAMTIENME' ACTION,
      'KTMCT_' + cast(cs.KHAMTIENME_ID as varchar(20)) CATEGORY_ID,
      'KTM' + C.SOBENHAN PARENT_ID,
      'KTMCT_' + cast(cs.KHAMTIENME_ID as varchar(20)) CATEGORY_CODE,
      d.SOPHIEUYEUCAU + ' (' + FORMAT(cs.NGAYTAO, 'hh:mm:ss') + ')' CATEGORY_NAME,
      0 FOLDER_LEVEL, 0 IS_FOLDER, 'DIEUTRI' FOLDER_CODE, 'KTM' + C.SOBENHAN PARENT_CODE, 1 CATEGORY_TYPE
      , cs.KHAMTIENME_ID as REF_ID
      , 'TT_NOITRU_KHAMTIENME' as REF_TABLE
      from TT_TIEPNHAN A
      inner join TT_BENHNHAN B on A.BENHNHAN_ID = B.BENHNHAN_ID
      inner join TT_NOITRU_BENHAN C on C.TIEPNHAN_ID = A.TIEPNHAN_ID
      inner join TT_NOITRU_KHAMTIENME cs on cs.TIEPNHAN_ID = A.TIEPNHAN_ID
      inner join TT_DVYEUCAU d on d.DVYEUCAU_ID = cs.DVYEUCAU_ID
      where A.BENHNHAN_ID = $BENHNHAN_ID$ and C.SOBENHAN is not null
      order by cs.KHAMTIENME_ID

      <!--phieu kham gay me-->
      select distinct C.SOBENHAN, C.BENHAN_ID, A.TIEPNHAN_ID SOTIEPNHAN, A.NGAYTIEPNHAN, A.TIEPNHAN_ID, C.LOAIBENHAN_ID,
      'KGM' + C.SOBENHAN CATEGORY_ID,
      C.SOBENHAN PARENT_ID,
      'KGM' + C.SOBENHAN CATEGORY_CODE,
      N'Phiếu khám gây mê' CATEGORY_NAME,
      0 FOLDER_LEVEL, 1 IS_FOLDER, 'DIEUTRI' FOLDER_CODE, C.SOBENHAN PARENT_CODE, 1 CATEGORY_TYPE
      from TT_TIEPNHAN A
      inner join TT_BENHNHAN B on A.BENHNHAN_ID = B.BENHNHAN_ID
      inner join TT_NOITRU_BENHAN C on C.TIEPNHAN_ID = A.TIEPNHAN_ID
      inner join TT_KHAMGAYME D on D.TIEPNHAN_ID = A.TIEPNHAN_ID
      where A.BENHNHAN_ID = $BENHNHAN_ID$ and C.SOBENHAN is not null
      <!--chi tiet phieu kham gay me-->
      select distinct C.SOBENHAN, C.BENHAN_ID, A.TIEPNHAN_ID MATIEPNHAN, A.NGAYTIEPNHAN, A.TIEPNHAN_ID, C.LOAIBENHAN_ID,
      cs.KHAMGAYME_ID, 'KHAMGAYNME' ACTION,
      'KGMCT_' + cast(cs.KHAMGAYME_ID as varchar(20)) CATEGORY_ID,
      'KGM' + C.SOBENHAN PARENT_ID,
      'KGMCT_' + cast(cs.KHAMGAYME_ID as varchar(20)) CATEGORY_CODE,
      d.SOPHIEUYEUCAU + ' (' + FORMAT(cs.NGAYTAO, 'hh:mm:ss') + ')' CATEGORY_NAME,
      0 FOLDER_LEVEL, 0 IS_FOLDER, 'DIEUTRI' FOLDER_CODE, 'KGM' + C.SOBENHAN PARENT_CODE, 1 CATEGORY_TYPE
      , cs.KHAMGAYME_ID as REF_ID
      , 'TT_KHAMGAYME' as REF_TABLE
      from TT_TIEPNHAN A
      inner join TT_BENHNHAN B on A.BENHNHAN_ID = B.BENHNHAN_ID
      inner join TT_NOITRU_BENHAN C on C.TIEPNHAN_ID = A.TIEPNHAN_ID
      inner join TT_KHAMGAYME cs on cs.TIEPNHAN_ID = A.TIEPNHAN_ID
      inner join TT_DVYEUCAU d on d.DVYEUCAU_ID = cs.DVYEUCAU_ID
      where A.BENHNHAN_ID = $BENHNHAN_ID$ and C.SOBENHAN is not null
      order by cs.KHAMGAYME_ID

      <!--File dinh kem-->
      select distinct BENHNHAN_ID, FILE_NAME_PATH, 'ATTACHFILE' ACTION
      , 'PDK' + FILE_NAME_ORI CATEGORY_ID
      , cast(4 as varchar(10)) PARENT_ID
      , 'PDK' + FILE_NAME_ORI CATEGORY_CODE
      , CATEGORY_DOCUMENT_CODE + '_' + FILE_NAME_ORI + '_' + cast(DOCUMENT_ID as varchar(100)) CATEGORY_NAME
      , 0 FOLDER_LEVEL, 0 IS_FOLDER, 'FILEDINHKEM' FOLDER_CODE, 'FILEDINHKEM' PARENT_CODE, 1 CATEGORY_TYPE
      , 0 as REF_ID
      , null as REF_TABLE
      from TT_DOCUMENTS where BENHNHAN_ID = '$BENHNHAN_ID$'
    </statement>
    <statement id="DAO00217_GetFileSignIn" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select top 1 * from TT_EMR_DETAIL where REF_ID = '$REF_ID$' and REF_TABLE = '$REF_TABLE$'
      and (IS_SIGN = '1')
      order by VERSION desc
    </statement>
  </statements>
</sqlMap>
