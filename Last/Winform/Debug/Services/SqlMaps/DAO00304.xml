<?xml version="1.0" encoding="utf-8" ?>
<!--============================================================================
//	CAUTION: This file is generated by IBatisNetGen.3.SQLMap.cst at 10/3/2016 10:12:54 AM
//				Any manual editing will be lost in re-generation.
//===========================================================================-->
<sqlMap namespace="eHospital" xmlns="http://ibatis.apache.org/mapping" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
  <statements>
    <statement id="DAO00304_Add" parameterClass="System.Collections.IDictionary" resultClass="System.Int64">
      insert into TT_NOITRU_DOTDIEUTRI_CHITIET (
      DOTDIEUTRI_ID
      , VIENPHI_ID
      , NGAYTAO
      , NGUOITAO_ID
      , NGAYCAPNHAT
      , NGUOICAPNHAT_ID
      ) values (
      #DOTDIEUTRI_ID#
      , #VIENPHI_ID#
      , #NGAYTAO#
      , #NGUOITAO_ID#
      , #NGAYCAPNHAT#
      , #NGUOICAPNHAT_ID#
      )
      select SCOPE_identity() as value
    </statement>

    <update id="DAO00304_Update" parameterClass="System.Collections.IDictionary">
      update TT_NOITRU_DOTDIEUTRI_CHITIET set
       NGAYCAPNHAT = #NGAYCAPNHAT#
      , NGUOICAPNHAT_ID = #NGUOICAPNHAT_ID#
      where
      VIENPHI_ID IN (SELECT * FROM DBO.SPLIT('$VIENPHI_ID$',', '))
    </update>

    <statement id="DAO00304_Delete" parameterClass="System.Collections.IDictionary" resultClass="System.Int32">
      delete from TT_NOITRU_DOTDIEUTRI_CHITIET
      where
      VIENPHI_ID = $VIENPHI_ID$
    </statement>
    <statement id="DAO00304_DeleteForRow" parameterClass="System.Collections.IDictionary" resultClass="System.Int32">
      delete from TT_NOITRU_DOTDIEUTRI_CHITIET
      where
      VIENPHI_ID IN (select * from dbo.SPLIT('$VIENPHI_ID$', ','))
    </statement>
    <statement id="DAO00304_DotDieuTriID" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select top 1 DOTDIEUTRI_ID
      from TT_NOITRU_DOTDIEUTRI
      where BENHAN_ID = $BENHAN_ID$ and TRANGTHAI='0'
      order by DOTDIEUTRI_ID DESC
    </statement>
    <!--<statement id="DAO00304_GetVienPhiYL" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select *
      from TT_VIENPHI
      where BENHAN_ID = '$BENHAN_ID$' and TIEPNHAN_ID = '$TIEPNHAN_ID$' and KHAMBENH_ID = '$KHAMBENH_ID$'
      and BENHVIEN_ID = '$BENHVIEN_ID$' and DATHANHTOAN='0' AND REF_TABLE='TT_NOITRU_TOATHUOC'
      and VIENPHI_ID not in (select VIENPHI_ID from TT_NOITRU_DOTDIEUTRI_CHITIET)
    </statement>-->
    <statement id="DAO00304_GetVienPhiDV" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select *
      from TT_VIENPHI
      where TIEPNHAN_ID = $TIEPNHAN_ID$
      and BENHVIEN_ID = '$BENHVIEN_ID$' and DATHANHTOAN='0'
      and REF_ID in (select * from dbo.SPLIT('$REF_ID$', ','))
      and not exists (select VIENPHI_ID from TT_NOITRU_DOTDIEUTRI_CHITIET)
    </statement>
    <statement id="DAO00304_GetVienPhiTheoYLenh" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select *
      from TT_VIENPHI
      where BENHAN_ID = $BENHAN_ID$ and KHAMBENH_ID = $KHAMBENH_ID$
      and BENHVIEN_ID = '$BENHVIEN_ID$'
    </statement>
    <statement id="DAO00304_GetVienPhiTheoDichVu" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select *
      from TT_VIENPHI
      where TIEPNHAN_ID = $TIEPNHAN_ID$
      and REF_ID IN (select * from dbo.SPLIT('$REF_ID$', ',')) AND REF_TABLE = 'TT_DVYEUCAU'
      and BENHVIEN_ID = '$BENHVIEN_ID$'
    </statement>
    <statement id="DAO00304_GetVienPhiThanhToanTheoDot" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select distinct DDT.*, NV.TENNHANVIEN AS BACSIDIEUTRI, PB.TENPHONGBAN AS KHOADIEUTRI
      from TT_VIENPHI VP
      INNER JOIN TT_NOITRU_DOTDIEUTRI DDT ON DDT.DOTDIEUTRI_ID = vp.DOTDIEUTRI_ID
      LEFT JOIN TT_DVYEUCAU DVYC ON DVYC.DVYEUCAU_ID = VP.REF_ID and vp.REF_TABLE='TT_DVYEUCAU'
      LEFT JOIN TM_PHONGBAN PB ON PB.PHONGBAN_ID = DDT.KHOADIEUTRI_ID
      LEFT JOIN TM_NHANVIEN NV ON NV.NHANVIEN_ID = DDT.BACSYDIEUTRI_ID
      where DDT.BENHAN_ID = $BENHAN_ID$ and Vp.ACTIVE = '1' and ((DVYC.HUYYEUCAU != '1' and vp.DICHVU_ID is not null) or (vp.DUOC_ID is not null)) and
      ((vp.DATHANHTOAN = '0') or (vp.BENHNHAN_PHAITHANHTOAN > vp.GIATRI_BENHNHAN_DATHANHTOAN and vp.DATHANHTOAN = '1')) and DVYC.DANGKY_CHITIET_ID is null
      <!--and ddt.TRANGTHAI = '1'-->
    </statement>
    <statement id="DAO00304_TT_VIENPHI_THANHTOANDOT" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      declare @DotDieuTri_Id int
      set @DotDieuTri_Id = (select top 1 DOTDIEUTRI_ID from TT_NOITRU_DOTDIEUTRI where BENHAN_ID = '$BENHAN_ID$' order by DOTDIEUTRI_ID DESC)

      select distinct a.*, b.GIATRIMIENGIAM_BH, c.GIATRIMIENGIAM_BHTN, f.GIATRIMIENGIAM_THANHVIEN, g.GIATRIMIENGIAM_CTCT
      from
      (select VP.*, c.NOITHUCHIEN_ID, c.NOIYEUCAU_ID, kb.RAVIEN, kb.ISTHUOCBV, isnull(c.TRANGTHAI, tt.TRANGTHAI) TRANGTHAI,
      isnull(dv.TENDICHVU, dc.TENDUOCDAYDU) NOIDUNG, isnull(dv.MADICHVU, dc.MADUOC) MADICHVU, dv.NORESULT, dc.DONVITINH, ld.MALOAIDUOC, dc.BHYT DUOC_BHYT, ld.LOAIVATTU_ID, ndv.MANHOMDICHVU
      from TT_VIENPHI VP
      left join TM_DUOC dc on VP.DUOC_ID = dc.DUOC_ID
      left join TM_LOAIDUOC ld on dc.LOAIDUOC_ID = ld.LOAIDUOC_ID
      left join TM_DICHVU dv on VP.DICHVU_ID = dv.DICHVU_ID and VP.REF_TABLE = 'TT_DVYEUCAU'
      left join TM_NHOMDICHVU ndv on ndv.NHOMDICHVU_ID = dv.NHOMDICHVU_ID
      left join TT_DVYEUCAU c on c.DVYEUCAU_ID = VP.REF_ID  and vp.REF_TABLE = 'TT_DVYEUCAU'
      left join TT_NOITRU_DOTDIEUTRI dt on dt.DOTDIEUTRI_ID = vp.DOTDIEUTRI_ID
      left join TT_NOITRU_TOATHUOC tt on tt.TOATHUOC_ID = vp.REF_ID and vp.REF_TABLE = 'TT_NOITRU_TOATHUOC'
      left join TT_NOITRU_KHAMBENH kb on kb.KHAMBENH_ID = tt.KHAMBENH_ID
      where Vp.BENHAN_ID = $BENHAN_ID$ and Vp.ACTIVE = '1' and ((c.HUYYEUCAU != '1' and vp.DICHVU_ID is not null) or (vp.DUOC_ID is not null)) and
      ((vp.DATHANHTOAN = '0') or (vp.BENHNHAN_PHAITHANHTOAN > vp.GIATRI_BENHNHAN_DATHANHTOAN and vp.DATHANHTOAN = '1')) and c.DANGKY_CHITIET_ID is null
      and dt.TRANGTHAI = '1'
      <isNotEmpty prepend="" property="THANHTOANVPKHONGLAYTOAMUANGOAI_RAVIEN">
      <isEqual prepend="and" property="THANHTOANVPKHONGLAYTOAMUANGOAI_RAVIEN" compareValue="True">
        ((vp.REF_TABLE = 'TT_NOITRU_TOATHUOC' and kb.RAVIEN is not null) or (vp.REF_TABLE != 'TT_NOITRU_TOATHUOC' and kb.RAVIEN is null))
      </isEqual>
    </isNotEmpty>
      <!--<isNotEmpty prepend="" property="XACNHAN">
      <isEqual prepend="AND" property="XACNHAN" compareValue="True">
        VP.VIENPHI_ID IN (select * from TT_XACNHANCHIPHICHITIET)
      </isEqual>
    </isNotEmpty>-->) a

      left join (select VIENPHI_ID,
      sum(MGCT.GIATRIMIENGIAM) AS GIATRIMIENGIAM_BH from TT_MIENGIAM MG
      INNER JOIN TT_MIENGIAM_CHITIET MGCT ON MG.MIENGIAM_ID = MGCT.MIENGIAM_ID
      where MG.BENHAN_ID = $BENHAN_ID$ and MGCT.REF_TABLE = 'TT_MIENGIAM' and MG.TINHTRANG = 1 group by VIENPHI_ID
      ) b on a.VIENPHI_ID = b.VIENPHI_ID

      left join (select VIENPHI_ID, sum(MGCT.GIATRIMIENGIAM) AS GIATRIMIENGIAM_BHTN
      from TT_MIENGIAM_BHTN MG
      INNER JOIN TT_MIENGIAM_CHITIET MGCT ON MG.MIENGIAM_BHTN_ID = MGCT.MIENGIAM_ID
      where  MG.BENHAN_ID = $BENHAN_ID$ and MGCT.REF_TABLE = 'TT_MIENGIAM_BHTN' and MG.TINHTRANG = 1 group by VIENPHI_ID
      )c on a.VIENPHI_ID = c.VIENPHI_ID

      left join (select VIENPHI_ID, sum(MGCT.GIATRIMIENGIAM) AS GIATRIMIENGIAM_THANHVIEN
      from TT_MIENGIAM_THANHVIEN MG
      INNER JOIN TT_MIENGIAM_CHITIET MGCT ON MG.MIENGIAM_THANHVIEN_ID = MGCT.MIENGIAM_ID
      where MG.TIEPNHAN_ID = $TIEPNHAN_ID$ and MGCT.REF_TABLE = 'TT_MIENGIAM_THANHVIEN' and MG.TINHTRANG = 1 group by VIENPHI_ID
      )f on a.VIENPHI_ID = f.VIENPHI_ID

      left join(select VIENPHI_ID, sum(MGCT.GIATRIMIENGIAM) AS GIATRIMIENGIAM_CTCT
      from TT_MIENGIAM_CONGTY MG
      INNER JOIN TT_MIENGIAM_CHITIET MGCT ON MG.MIENGIAM_CONGTY_ID = MGCT.MIENGIAM_ID
      where MG.BENHAN_ID = $BENHAN_ID$ and MGCT.REF_TABLE = 'TT_MIENGIAM_CONGTY' and MG.TINHTRANG = 1 group by VIENPHI_ID
      )g on a.VIENPHI_ID = g.VIENPHI_ID
    </statement>
    <statement id="DAO00304_GetVienPhiDot" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select vp.VIENPHI_ID
      from TT_VIENPHI vp
      where vp.DOTDIEUTRI_ID IN (SELECT * FROM DBO.SPLIT('$DOTDIEUTRI_ID$',', '))
    </statement>
    <statement id="DAO00304_GetVienPhiWithKhamBenhId" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select *
      from TT_VIENPHI
      where REF_ID IN (select * from dbo.SPLIT('$REF_ID$',', ')) and BENHVIEN_ID = '$BENHVIEN_ID$'
      <isNotEmpty prepend="and" property="KHAMBENH_ID">
        KHAMBENH_ID = $KHAMBENH_ID$
      </isNotEmpty>
    </statement>
    <statement id="DAO00304_GetDotCallBackVP" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select top 1 dt.DOTDIEUTRI_ID, dt.MADOTDIEUTRI
      from TT_HOADON hd
      inner join TT_HOADON_CHITIET_NOITRU ct on ct.HOADON_ID = hd.HOADON_ID
      inner join TT_VIENPHI vp on vp.VIENPHI_ID = ct.VIENPHI_ID
      inner join TT_NOITRU_DOTDIEUTRI_CHITIET dtct on dtct.VIENPHI_ID = vp.VIENPHI_ID
      inner join TT_NOITRU_DOTDIEUTRI dt on dt.DOTDIEUTRI_ID = dtct.DOTDIEUTRI_ID
      where hd.HOADON_ID = $HOADON_ID$ and hd.BENHAN_ID = $BENHAN_ID$ and hd.BENHVIEN_ID = '$BENHVIEN_ID$'
    </statement>
    <statement id="DAO00304_DeleteNoiTruNhapVien" parameterClass="System.Collections.IDictionary" resultClass="System.Int32">
      delete from TT_NOITRU_NHAPVIEN
      where
      TIEPNHAN_ID = $TIEPNHAN_ID$ and BENHNHAN_ID = $BENHNHAN_ID$ and LOAIBENHAN = '$LOAIBENHAN$'
    </statement>
    <statement id="DAO00304_UpdateVienPhiTiepnhan2BenhanNgoaiTru" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      update TT_VIENPHI set BENHAN_ID = #BENHAN_ID#, DOTDIEUTRI_ID = #DOTDIEUTRI_ID#, NGAYCAPNHAT = #NGAYCAPNHAT#, NGUOICAPNHAT_ID = #NGUOICAPNHAT_ID#
      where TIEPNHAN_ID = #TIEPNHAN_ID# and VIENPHI_ID in ($LST_VIENPHI$)
    </statement>
  </statements>
</sqlMap>
