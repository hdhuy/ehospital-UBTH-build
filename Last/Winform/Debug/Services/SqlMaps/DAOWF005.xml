<?xml version="1.0" encoding="utf-8" ?>
<!--============================================================================
//	CAUTION: This file is generated by IBatisNetGen.3.SQLMap.cst at 10/19/2015 7:57:18 AM
//				Any manual editing will be lost in re-generation.
//===========================================================================-->
<sqlMap namespace="eHospital" xmlns="http://ibatis.apache.org/mapping" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" >
  <statements>
    <statement id="DAOWF005_Add" parameterClass="System.Collections.IDictionary" resultClass="System.Int64">
      insert into TT_REQUEST_SERVICE_DETAIL (
      REQUEST_ID
      ,REQUEST_SERVICE_ID
      , OLD_STATE_CODE
      , CURR_STATE_CODE
      ) values (
      #REQUEST_ID#
      ,#REQUEST_SERVICE_ID#
      , #OLD_STATE_CODE#
      , #CURR_STATE_CODE#
      )
      SELECT SCOPE_IDENTITY()
      <!--<selectKey resultClass="System.Int64" type="post" >
        SELECT @@IDENTITY as value
      </selectKey>-->
    </statement>
    <delete id="DAOWF005_Delete" parameterClass="System.Collections.IDictionary">
      delete from TT_REQUEST_SERVICE_DETAIL
      where ID = '$ID$'
    </delete>
    <insert id="DAOWF005_Add_History" parameterClass="System.Collections.IDictionary" resultClass="System.Int64">
      insert into TT_REQUEST_SERVICE_HISTORY (
      REQUEST_ID
      ,REQUEST_SERVICE_ID
      , OLD_STATE_CODE
      , CURR_STATE_CODE
      ) values (
      #REQUEST_ID#
      ,#REQUEST_SERVICE_ID#
      , #OLD_STATE_CODE#
      , #CURR_STATE_CODE#
      )    
    </insert>
    <statement id="DAOWF005_ReturnStateCuaDichVuYeuCau" resultClass="DataObject">
      declare
      @Detail_Id int,
      @CurentState char(8),
      @OldState char(8)

      select top 1 @Detail_Id = ID, @CurentState = OLD_STATE_CODE, @OldState = CURR_STATE_CODE from TT_REQUEST_SERVICE_DETAIL
      where
      REQUEST_ID = '$REQUEST_ID$'
      AND REQUEST_SERVICE_ID = '$ID$'
      order by ID desc;

      update TT_REQUEST_SERVICE set CURR_STATE_CODE = @CurentState, ISACTIVE = 1, ISCOMPLETE = 0 where ID = '$ID$';
      delete from TT_REQUEST_SERVICE_DETAIL where ID = @Detail_Id;
      insert into TT_REQUEST_SERVICE_HISTORY
      (REQUEST_ID,REQUEST_SERVICE_ID, OLD_STATE_CODE, CURR_STATE_CODE) values ('$REQUEST_ID$','$ID$',@OldState, @CurentState);
      select top 1 A.*, B.STATUS_CODE from TT_REQUEST_SERVICE A
      left join TM_STATE B on A.CURR_STATE_CODE = B.STATE_CODE and A.PROCESS_CODE = B.PROCESS_CODE
      where A.ID = '$ID$';
      <!--select top 1 * from TT_REQUEST_SERVICE where ID = '$ID$';-->
    </statement>
  </statements>
</sqlMap>