<?xml version="1.0" encoding="utf-8" ?>
<!--============================================================================
//	CAUTION: This file is generated by IBatisNetGen.3.SQLMap.cst at 4/1/2016 9:22:01 AM
//				Any manual editing will be lost in re-generation.
//===========================================================================-->
<sqlMap namespace="eHospital" xmlns="http://ibatis.apache.org/mapping" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">

  <statements>   
    <statement id="DAO00490_Execute_Stored" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      exec $PROCEDURE_NAME$
      <iterate property="PARAMETERS" open="" close="" conjunction=",">
        #PARAMETERS[]#
      </iterate>
    </statement>
    <statement id="DAO00490_GetListMasterPDF" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      SELECT * FROM (
      SELECT DISTINCT AA.REPORT_CODE AS FIELD,'0' AS PARENT_ID,AA.REPORT_NAME AS DOCUMENTNAME,NULL [DETAIL_ID],0 AS REVICE_ID,NULL [VERSION],'' AS [FILENAME],
      null [STATUS],null [DATESEND], AA.REPORT_CODE as DOCUMENTCODE,NULL AS CREATEDOCUMENT,AA.SORTNUM,1 AS IS_FOLDER, 0 AS BENHAN_ID,0 AS EMR_ID
      FROM TT_EMR CC
      JOIN TT_EMR_DETAIL BB ON BB.EMR_ID=CC.ID
      JOIN TT_BENHNHAN BN ON CC.BENHNHAN_ID=BN.BENHNHAN_ID AND BN.MAYTE='$MAYTE$'
      JOIN TM_EMR_REPORTCODE AA ON AA.REPORT_CODE=BB.DOCUMENTCODE
      WHERE BN.MAYTE='$MAYTE$' AND exists (select 1 from ( select EMR_ID, max(VERSION) as max_Ver from TT_EMR_DETAIL group by EMR_ID ) as cond
      where CC.Id=cond.EMR_ID and BB.[VERSION] =cond.max_Ver)
      <isNotEmpty prepend="and" property="BENHAN_ID">
        CC.BENHAN_ID=$BENHAN_ID$
      </isNotEmpty>
      <isNotEmpty prepend="and" property="TIEPNHAN_ID">
        CC.TIEPNHAN_ID=$TIEPNHAN_ID$
      </isNotEmpty>
      UNION ALL
      SELECT BB.[FIELD],BB.DOCUMENTCODE AS PARENT_ID,BB.[CREATEDOCUMENT] AS DOCUMENTNAME,BB.[DETAIL_ID],CC.TIEPNHAN_ID AS REVICE_ID,BB.[VERSION],BB.[FILENAME],BB.[STATUS],BB.[DATESEND],
      BB.[DOCUMENTCODE],BB.[CREATEDOCUMENT],AA.SORTNUM,0 AS IS_FOLDER, CC.BENHAN_ID, BB.EMR_ID
      FROM TT_EMR CC
      JOIN TT_EMR_DETAIL BB ON BB.EMR_ID=CC.ID AND BB.IS_SIGN=#IS_SIGN#
      JOIN TT_BENHNHAN BN ON CC.BENHNHAN_ID=BN.BENHNHAN_ID AND BN.MAYTE='$MAYTE$'
      JOIN TM_EMR_REPORTCODE AA ON AA.REPORT_CODE=BB.DOCUMENTCODE
      WHERE BN.MAYTE='$MAYTE$'
      <isNotEmpty prepend="and" property="BENHAN_ID">
        CC.BENHAN_ID=$BENHAN_ID$
      </isNotEmpty>
      <isNotEmpty prepend="and" property="TIEPNHAN_ID">
        CC.TIEPNHAN_ID=$TIEPNHAN_ID$
      </isNotEmpty>
      ) ZZ
      ORDER BY ZZ.SORTNUM, ZZ.CREATEDOCUMENT
    </statement>
    <statement id="DAO00490_Upd_EMR_Ky" parameterClass="System.Collections.IDictionary" resultClass="System.Int32">
      <!--declare @i_ROWNUM INT
      SET @i_ROWNUM=1
      BEGIN-->
      <!--BEGIN TRY
      BEGIN TRANSACTION-->

      UPDATE TT_EMR_DETAIL SET IS_SIGN=1,DATESIGN=GETDATE()
      WHERE FIELD='$FIELD$' AND IS_SIGN=0
      UPDATE TT_EMR SET TRANGTHAI=2,NGAYKY=GETDATE() WHERE ID=#EMR_ID# AND TRANGTHAI=1

      <!--BEGIN
      SET @i_ROWNUM = (SELECT COUNT(FIELD) FROM TT_EMR_DETAIL WHERE EMR_ID=#EMR_ID# and [STATUS]=1 and DOCUMENTCODE IS NOT NULL)

      IF(@i_ROWNUM=0)
      UPDATE TT_EMR_DETAIL SET STATUS=2,DATESIGN=GETDATE() WHERE EMR_ID=#EMR_ID# AND [STATUS]=1 and DOCUMENTCODE IS NULL
      UPDATE TT_EMR SET TRANGTHAI=2,NGAYKY=GETDATE() WHERE ID=#EMR_ID# AND TRANGTHAI=1


      END-->

      <!--COMMIT TRANSACTION
      END TRY
      BEGIN CATCH
      IF @@TRANCOUNT &gt; 0
      ROLLBACK TRANSACTION
      END CATCH-->
      <!--END
      
      SELECT @i_ROWNUM-->
    </statement>
    <statement id="DAO00490_GetListEMR" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      SELECT cast(0 as float) AS CHON, AA.[Id],AA.[BENHAN_ID],AA.[TIEPNHAN_ID],AA.[SOBENHAN],AA.[NGAYCAPNHAT],AA.[PHIENBAN],AA.[TRANGTHAI],AA.[NGAYXUAT],AA.[NGAYKY],AA.[NGAYGUI],AA.[BENHNHAN_ID],
      AA.[NGAYKHOABENHAN],
      BN.MAYTE,BN.TENBENHNHAN,(CASE WHEN BN.GIOITINH=1 THEN N'Nam' ELSE N'Nữ' END) AS TENGIOITINH,BN.NGAYSINH,BN.DIACHILIENLAC
      , R.REPORT_NAME AS 'TENPHIEU'
      , R.REPORT_CODE AS MAPHIEU
      , N'Mã y tế: ' + BN.MAYTE + N' - Tên người bệnh: ' + BN.TENBENHNHAN + N' - Giới tính: ' + S.DESCRIPTION + ' - Ngày sinh: ' + CONVERT(VARCHAR(10),BN.NGAYSINH,103) AS NAME
      , BB.VERSION
      , BB.DATESEND
      FROM TT_EMR AA
      JOIN TT_EMR_DETAIL BB ON BB.EMR_ID=AA.ID
      JOIN TT_BENHNHAN BN ON AA.BENHNHAN_ID=BN.BENHNHAN_ID
      JOIN TM_EMR_REPORTCODE R ON R.REPORT_CODE = BB.DOCUMENTCODE
      JOIN TM_GENDER S ON S.ID = BN.GIOITINH
      WHERE exists (select 1 from ( select EMR_ID, max(VERSION) as max_Ver from TT_EMR_DETAIL group by EMR_ID ) as cond
      where AA.Id=cond.EMR_ID and BB.[VERSION] =cond.max_Ver
      ) and bb.IS_SIGN = '$IS_SIGN$' 
      AND CONVERT(date, AA.NGAYKHOABENHAN) BETWEEN CONVERT(date, '$TUNGAY$')  AND  CONVERT(date, '$DENNGAY$')
      <isNotEmpty prepend="and" property="BENHNHAN">
        (BN.MAYTE LIKE '%$BENHNHAN$%' OR BN.TENBENHNHAN LIKE '%$BENHNHAN$%')
      </isNotEmpty>
    </statement>
    <statement id="DAO00490_Upd_EMR_SendSystem" parameterClass="System.Collections.IDictionary" resultClass="System.Int32">
      BEGIN
      BEGIN TRY
      BEGIN TRANSACTION

      UPDATE TT_EMR_DETAIL SET IS_SIGN=1,DATESEND=GETDATE()
      WHERE FIELD='$FIELD$' AND IS_SIGN=0

      declare @i_ROWNUM INT
      BEGIN
      SET @i_ROWNUM = (SELECT COUNT(FIELD) FROM TT_EMR_DETAIL WHERE EMR_ID=#EMR_ID# and [IS_SIGN]=0)

      IF(@i_ROWNUM=0)
      UPDATE TT_EMR SET TRANGTHAI=3,NGAYGUI=GETDATE() WHERE ID=#EMR_ID# AND TRANGTHAI=2


      END

      COMMIT TRANSACTION
      END TRY
      BEGIN CATCH
      IF @@TRANCOUNT &gt; 0
      ROLLBACK TRANSACTION
      END CATCH
      END
    </statement>
    <statement id="DAO00490_GetEMRxml" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      <!--SELECT * FROM TT_EMR_DETAIL WHERE EMR_ID=#EMR_ID# AND DOCUMENTCODE IS NULL-->
      SELECT BB.* FROM TT_EMR AA
      JOIN TT_EMR_DETAIL BB ON BB.EMR_ID=AA.ID
      WHERE exists (select 1 from ( select EMR_ID, max(VERSION) as max_Ver from TT_EMR_DETAIL group by EMR_ID ) as cond
      where AA.Id=cond.EMR_ID and BB.[VERSION] =cond.max_Ver)
      AND BB.EMR_ID=#EMR_ID#  AND BB.FILETYPE='.xml'
    </statement>
    
  </statements>

</sqlMap>
