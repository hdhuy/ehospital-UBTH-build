<?xml version="1.0" encoding="utf-8" ?>
<!--============================================================================
//	CAUTION: This file is generated by IBatisNetGen.3.SQLMap.cst at 10/3/2016 10:12:54 AM
//				Any manual editing will be lost in re-generation.
//===========================================================================-->
<sqlMap namespace="eHospital" xmlns="http://ibatis.apache.org/mapping" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
  <statements>
    <statement id="DAO00330_GetList" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select * from TM_MAU_NHOMMAU where TAMNGUNG='0'
    </statement>
    <statement id="DAO00330_GetAll" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select * from TM_MAU_NHOMMAU
    </statement>
    <statement id="DAO00330_GetChiTietVienphiNoiTru" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select distinct
      C.GIATRIMIENGIAM as GIATRIMIENGIAM, D.GIATRIMIENGIAM as GIATRIMIENGIAM_BHTN, E.GIATRIMIENGIAM as GIATRIMIENGIAM_THANHVIEN,
      A.VIENPHI_ID, A.TIEPNHAN_ID, A.BENHAN_ID, A.DOTDIEUTRI_ID, A.BENHNHAN_ID, A.KHAMBENH_ID, A.REF_ID, A.REF_TABLE, A.DICHVU_ID, A.DUOC_ID, A.SOLONHAP_ID,
      A.LOAI_CHIPHI, A.LOAIGIA_ID, A.SOLUONG, A.DONGIA_DOANHTHU, A.THANHTIEN_DOANHTHU, A.BHYT_TL, A.BHYT_DONGIA, A.BHYT_THANHTIEN, A.BHYT_DONGIA_CONGKHAM_DAU,
      A.BHYT_CONGKHAM_DAU_TYLE, A.BHYT_DONGIA_CHITRA, A.BHYT_THANHTIEN_CHITRA, ISNULL(A.BENHNHAN_PHAITHANHTOAN,0) AS BENHNHAN_PHAITHANHTOAN, A.GIATRI_HOADON, ISNULL(A.GIATRI_HOADON_DATHANHTOAN,0) AS GIATRI_HOADON_DATHANHTOAN,
      A.GIATRI_BIENLAI, ISNULL(A.GIATRI_BIENLAI_DATHANHTOAN,0) AS GIATRI_BIENLAI_DATHANHTOAN, ISNULL(A.GIATRI_BENHNHAN_DATHANHTOAN,0) AS GIATRI_BENHNHAN_DATHANHTOAN, A.GIATRI_THATTHU, A.MIENGIAM_TL, A.MIENGIAM_GIATRI, A.NGANSACH_TL,
      A.NGANSACH_GIATRI, A.TAITRO_TL, A.TAITRO_GIATRI, A.BHTN_TL, A.BHTN_DONGIA, A.BHTN_THANHTIEN, A.BHTN_DONGIA_CHITRA, A.BHTN_THANHTIEN_CHITRA, A.TYLE_VAT,
      A.GIATRI_VAT, A.GIAVON, A.BANGGIA_ID, A.DUOCPHEPTHUCHIEN, A.HUY, A.DATHANHTOAN, A.DATHUCHIEN, A.KHONGTHUTIEN, A.BHYTDONGTIEN, A.HOADON_ID,
      A.CHUYENCHUNGTUID, A.CHUYENDOANHTHUID, A.CHUYENDOANHTHUHUYID, A.CHUYENDOANHTHUHOANID, A.STATUS, A.ACTIVE, A.DUYET, A.BENHVIEN_ID, A.NGUOITAO_ID,
      A.NGAYTAO, A.NGUOICAPNHAT_ID, A.NGAYCAPNHAT, A.YEUCAUVP, A.DOITUONG_HUONG_ID, A.SOBHYT_HUONG_ID, A.DICHVU_TL, A.BHYT_DONGIA_DONGCT_DAU, CT.MAU_ID,
      DK.THOIGIANYEUCAU AS NGAYGIOYEUCAU, DK.NOICHIDINH_ID AS NOIYEUCAU_ID, NULL AS NOITHUCHIEN_ID, DK.TRANGTHAI, DK.NGAYYEUCAU AS NGAYYEUCAU1, hd.SOHOADON, CTU.KHOXUAT_ID AS KHOTHUCHIEN_ID,
      mgct.GIATRIMIENGIAM as GIATRIMIENGIAM_CONGTY, CONVERT(VARCHAR(10), DK.NGAYYEUCAU, 103) as NGAYYEUCAU,
      C.GIATRIMIENGIAM as GIATRIMIENGIAM_BH, mgct.GIATRIMIENGIAM as GIATRIMIENGIAM_CTCT,
      M.TENMAU AS NOIDUNG, M.MAMAU AS MADICHVU, NULL AS NORESULT, DVT.TENDONVITINH AS DONVITINH, LM.MALOAIMAU AS MALOAIDUOC,
      M.BHYT AS DUOC_BHYT, 'M' AS LOAIVATTU_ID, NM.TENNHOMMAU AS MANHOMDICHVU
      from TT_VIENPHI A
      INNER JOIN TT_MAU_CHUNGTU_CHITIET CT ON A.REF_ID=CT.CHUNGTUCHITIET_ID AND A.REF_TABLE='TT_MAU_CHUNGTU_CHITIET' AND A.DUOC_ID is not null AND CT.BENHVIEN_ID='$BENHVIEN_ID$'
      INNER JOIN TT_MAU_CHUNGTU CTU ON CT.CHUNGTU_ID=CTU.CHUNGTU_ID AND CTU.CHUNGTULIENQUAN_ID IS NULL
      INNER join TM_MAU M on CT.MAU_ID = M.MAU_ID
      LEFT JOIN TM_MAU_DONVITINH DVT ON M.DONVITINH_ID = DVT.DONVITINH_ID
      LEFT JOIN TT_MAU_DANGKYMAU_CHITIET DKCT ON DKCT.CHUNGTU_ID = CTU.CHUNGTU_ID AND DKCT.BENHVIEN_ID='$BENHVIEN_ID$'
      LEFT JOIN TT_MAU_DANGKYMAU DK ON DK.DANGKYMAU_ID = DKCT.DANGKYMAU_ID
      LEFT JOIN TM_MAU_LOAIMAU LM ON LM.LOAIMAU_ID = M.LOAIMAU_ID
      LEFT JOIN TM_MAU_NHOMMAU NM ON NM.NHOMMAU_ID = LM.NHOMMAU_ID
      left join TT_HOADON hd on hd.HOADON_ID = A.HOADON_ID and hd.BENHAN_ID is null

      left join (select sum(GIATRIMIENGIAM) as GIATRIMIENGIAM, VIENPHI_ID, REF_TABLE
      from TT_MIENGIAM_CHITIET
      where REF_TABLE = 'TT_MIENGIAM'
      and exists (select MIENGIAM_ID from TT_MIENGIAM where TT_MIENGIAM_CHITIET.MIENGIAM_ID = MIENGIAM_ID and TINHTRANG = 1 and TIEPNHAN_ID = '$TIEPNHAN_ID$')
      group by VIENPHI_ID, REF_TABLE) C on C.REF_TABLE = 'TT_MIENGIAM' and C.VIENPHI_ID = A.VIENPHI_ID
      left join (select sum(GIATRIMIENGIAM) as GIATRIMIENGIAM, VIENPHI_ID, REF_TABLE
      from TT_MIENGIAM_CHITIET
      where REF_TABLE = 'TT_MIENGIAM_BHTN'
      and exists (select MIENGIAM_BHTN_ID from TT_MIENGIAM_BHTN where TT_MIENGIAM_CHITIET.MIENGIAM_ID = MIENGIAM_BHTN_ID and TINHTRANG = 1 and TIEPNHAN_ID = '$TIEPNHAN_ID$')
      group by VIENPHI_ID, REF_TABLE) D on D.REF_TABLE = 'TT_MIENGIAM_BHTN' and D.VIENPHI_ID = A.VIENPHI_ID
      left join (select sum(GIATRIMIENGIAM) as GIATRIMIENGIAM, VIENPHI_ID, REF_TABLE
      from TT_MIENGIAM_CHITIET
      where REF_TABLE = 'TT_MIENGIAM_THANHVIEN'
      and exists (select MIENGIAM_THANHVIEN_ID from TT_MIENGIAM_THANHVIEN where TT_MIENGIAM_CHITIET.MIENGIAM_ID = MIENGIAM_THANHVIEN_ID and TINHTRANG = 1 and  TINHTRANG = 1 and TIEPNHAN_ID = '$TIEPNHAN_ID$')
      group by VIENPHI_ID, REF_TABLE) E on E.REF_TABLE = 'TT_MIENGIAM_THANHVIEN' and E.VIENPHI_ID = A.VIENPHI_ID
      left join (select sum(GIATRIMIENGIAM) as GIATRIMIENGIAM, VIENPHI_ID, REF_TABLE
      from TT_MIENGIAM_CHITIET
      where REF_TABLE = 'TT_MIENGIAM_CONGTY'
      and exists (select MIENGIAM_CONGTY_ID from TT_MIENGIAM_CONGTY where TT_MIENGIAM_CHITIET.MIENGIAM_ID = MIENGIAM_CONGTY_ID and  TIEPNHAN_ID = '$TIEPNHAN_ID$')
      group by VIENPHI_ID, REF_TABLE) mgct on mgct.REF_TABLE = 'TT_MIENGIAM_CONGTY' and mgct.VIENPHI_ID = A.VIENPHI_ID

      WHERE A.TIEPNHAN_ID = '$TIEPNHAN_ID$' and A.BENHVIEN_ID = '$BENHVIEN_ID$' and A.BENHAN_ID = '$BENHAN_ID$'
      <!--and DK.NGAYYEUCAU is not null--> 
      and A.ACTIVE = '1' and A.REF_ID > 0 and (A.KHONGTHUTIEN = '0' or A.KHONGTHUTIEN is null)
      ORDER BY DK.NGAYYEUCAU desc
    </statement>
    <statement id="DAO00330_TT_VIENPHI_GetList_TiepNhanByHoadon" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select  a.*, a.MIENGIAM_GIATRI as GIATRIMIENGIAM_BH, a.BHTN_GIATRI as GIATRIMIENGIAM_BHTN, a.HOIVIEN_GIATRI as GIATRIMIENGIAM_THANHVIEN, a.CONGTYCHITRA_GIATRI as GIATRIMIENGIAM_CTCT
      from
      (select
      vp.HOADONCHITIET_ID, vp.HOADON_ID, vp.VIENPHI_ID, vp.REF_ID, vp.REF_TABLE, vp.DICHVU_ID, vp.DUOC_ID
      , vp.LOAI_CHIPHI, vp.LOAIGIA_ID, vp.SOLUONG, vp.DONGIA_DOANHTHU, vp.THANHTIEN_DOANHTHU, vp.BHYT_TL, vpp.BHYT_DONGIA, vpp.BHYT_THANHTIEN, vpp.BHYT_DONGIA_CHITRA
      , vp.BHYT_THANHTIEN_CHITRA, vp.BENHNHAN_PHAITHANHTOAN, vp.GIATRI_HOADON, vp.GIATRI_HOADON_DATHANHTOAN, vp.GIATRI_BIENLAI
      , vp.GIATRI_BIENLAI_DATHANHTOAN, vp.GIATRI_BENHNHAN_DATHANHTOAN, vp.TYLE_THATTHU, vp.GIATRI_THATTHU, vp.MIENGIAM_TL, vp.MIENGIAM_GIATRI, vp.NGANSACH_TL, vp.NGANSACH_GIATRI
      , vp.TAITRO_TL, vp.TAITRO_GIATRI, vp.BHTN_GIATRI, vp.NOIDUNGTHU, vp.CHUNGTUXUATBN_ID, vp.TYLEVAT, vp.GIATRIVAT, vp.MASOTHUE, vp.SOCHUNGTUKETOAN, vp.DAHOANTRA, vp.TRANGTHAI
      , vp.PHONGBAN_ID, vp.PHONGBAN_THAYDOI_ID, vp.CONGTYCHITRA_GIATRI, vp.HOIVIEN_GIATRI, vp.BENHVIEN_ID, vp.NGAYTAO, vp.NGUOITAO_ID, vp.NGAYCAPNHAT, vp.NGUOICAPNHAT_ID
      , NULL AS NOITHUCHIEN_ID, dk.NOICHIDINH_ID as NOIYEUCAU_ID, vpp.DATHUCHIEN, vpp.TIEPNHAN_ID, vpp.BENHAN_ID
      ,M.TENMAU AS NOIDUNG, M.MAMAU AS MADICHVU, NULL AS NORESULT, DVT.TENDONVITINH AS DONVITINH, LM.MALOAIMAU AS MALOAIDUOC, M.BHYT AS DUOC_BHYT, 'M' AS LOAIVATTU_ID, NM.TENNHOMMAU AS MANHOMDICHVU
      from TT_HOADON_CHITIET_NGOAITRU VP
      join TT_VIENPHI vpp on vpp.VIENPHI_ID = VP.VIENPHI_ID
      INNER JOIN TT_MAU_CHUNGTU_CHITIET CT ON VP.REF_ID=CT.CHUNGTUCHITIET_ID AND VP.REF_TABLE='TT_MAU_CHUNGTU_CHITIET' AND CT.BENHVIEN_ID='$BENHVIEN_ID$'
      INNER JOIN TT_MAU_CHUNGTU CTU ON CT.CHUNGTU_ID=CTU.CHUNGTU_ID AND CTU.CHUNGTULIENQUAN_ID IS NULL
      INNER join TM_MAU M on CT.MAU_ID = M.MAU_ID
      LEFT JOIN TM_MAU_DONVITINH DVT ON M.DONVITINH_ID = DVT.DONVITINH_ID
      LEFT JOIN TT_MAU_DANGKYMAU_CHITIET DKCT ON DKCT.CHUNGTU_ID = CTU.CHUNGTU_ID AND DKCT.BENHVIEN_ID='$BENHVIEN_ID$'
      LEFT JOIN TT_MAU_DANGKYMAU DK ON DK.DANGKYMAU_ID = DKCT.DANGKYMAU_ID
      LEFT JOIN TM_MAU_LOAIMAU LM ON LM.LOAIMAU_ID = M.LOAIMAU_ID
      LEFT JOIN TM_MAU_NHOMMAU NM ON NM.NHOMMAU_ID = LM.NHOMMAU_ID
      where
      vp.HOADON_ID = '$HOADON_ID$'
      ) a
    </statement>
    <statement id="DAO00330_TT_VIENPHI_GetList_TiepNhanPhaiThanhToan" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select distinct  a.*, b.GIATRIMIENGIAM_BH, c.GIATRIMIENGIAM_BHTN, f.GIATRIMIENGIAM_THANHVIEN, g.GIATRIMIENGIAM_CTCT
      from
      (select VP.*,NULL AS NOITHUCHIEN_ID, DK.NOICHIDINH_ID as NOIYEUCAU_ID, NULL AS THUTIENSAU, isnull(DK.TRANGTHAI, '') TRANGTHAI,
      M.TENMAU AS NOIDUNG, M.MAMAU AS MADICHVU, NULL AS NORESULT, DVT.TENDONVITINH AS DONVITINH, LM.MALOAIMAU AS MALOAIDUOC, M.BHYT AS DUOC_BHYT, 'M' AS LOAIVATTU_ID, NM.TENNHOMMAU AS MANHOMDICHVU
      from TT_VIENPHI VP
      INNER JOIN TT_MAU_CHUNGTU_CHITIET CT ON VP.REF_ID=CT.CHUNGTUCHITIET_ID AND VP.REF_TABLE='TT_MAU_CHUNGTU_CHITIET' AND CT.BENHVIEN_ID='$BENHVIEN_ID$'
      INNER JOIN TT_MAU_CHUNGTU CTU ON CT.CHUNGTU_ID=CTU.CHUNGTU_ID AND CTU.CHUNGTULIENQUAN_ID IS NULL
      INNER join TM_MAU M on CT.MAU_ID = M.MAU_ID
      LEFT JOIN TM_MAU_DONVITINH DVT ON M.DONVITINH_ID = DVT.DONVITINH_ID
      LEFT JOIN TT_MAU_DANGKYMAU_CHITIET DKCT ON DKCT.CHUNGTU_ID = CTU.CHUNGTU_ID AND DKCT.BENHVIEN_ID='$BENHVIEN_ID$'
      LEFT JOIN TT_MAU_DANGKYMAU DK ON DK.DANGKYMAU_ID = DKCT.DANGKYMAU_ID
      LEFT JOIN TM_MAU_LOAIMAU LM ON LM.LOAIMAU_ID = M.LOAIMAU_ID
      LEFT JOIN TM_MAU_NHOMMAU NM ON NM.NHOMMAU_ID = LM.NHOMMAU_ID
      where Vp.TIEPNHAN_ID = '$TIEPNHAN_ID$' and Vp.ACTIVE = '1' and vp.DUOC_ID is not null and
      ((vp.DATHANHTOAN = '0') or (vp.BENHNHAN_PHAITHANHTOAN > vp.GIATRI_BENHNHAN_DATHANHTOAN and vp.DATHANHTOAN = '1')) <!--and c.DANGKY_CHITIET_ID is null-->
      <isPropertyAvailable  prepend="" property="BIL_THUDICHVU_KHONGTHUTIEN">
        <isEqual prepend="AND" property="BIL_THUDICHVU_KHONGTHUTIEN" compareValue="False">
          VP.KHONGTHUTIEN != '1'
        </isEqual>
      </isPropertyAvailable>
      <isNotPropertyAvailable prepend="AND" property="BIL_THUDICHVU_KHONGTHUTIEN" >
        VP.KHONGTHUTIEN != '1'
      </isNotPropertyAvailable>
      ) a
      left join (select VIENPHI_ID,
      sum(MGCT.GIATRIMIENGIAM) AS GIATRIMIENGIAM_BH from TT_MIENGIAM MG
      INNER JOIN TT_MIENGIAM_CHITIET MGCT ON MG.MIENGIAM_ID = MGCT.MIENGIAM_ID
      where MG.TIEPNHAN_ID= '$TIEPNHAN_ID$' and MGCT.REF_TABLE = 'TT_MIENGIAM' and MG.TINHTRANG = 1 group by VIENPHI_ID
      ) b on a.VIENPHI_ID = b.VIENPHI_ID

      left join (select VIENPHI_ID, sum(MGCT.GIATRIMIENGIAM) AS GIATRIMIENGIAM_BHTN
      from TT_MIENGIAM_BHTN MG
      INNER JOIN TT_MIENGIAM_CHITIET MGCT ON MG.MIENGIAM_BHTN_ID = MGCT.MIENGIAM_ID
      where  MG.TIEPNHAN_ID= '$TIEPNHAN_ID$' and MGCT.REF_TABLE = 'TT_MIENGIAM_BHTN' and MG.TINHTRANG = 1 group by VIENPHI_ID
      )c on a.VIENPHI_ID = c.VIENPHI_ID

      left join (select VIENPHI_ID, sum(MGCT.GIATRIMIENGIAM) AS GIATRIMIENGIAM_THANHVIEN
      from TT_MIENGIAM_THANHVIEN MG
      INNER JOIN TT_MIENGIAM_CHITIET MGCT ON MG.MIENGIAM_THANHVIEN_ID = MGCT.MIENGIAM_ID
      where MG.TIEPNHAN_ID= '$TIEPNHAN_ID$' and MGCT.REF_TABLE = 'TT_MIENGIAM_THANHVIEN' and MG.TINHTRANG = 1 group by VIENPHI_ID
      )f on a.VIENPHI_ID = f.VIENPHI_ID

      left join(select VIENPHI_ID, sum(MGCT.GIATRIMIENGIAM) AS GIATRIMIENGIAM_CTCT
      from TT_MIENGIAM_CONGTY MG
      INNER JOIN TT_MIENGIAM_CHITIET MGCT ON MG.MIENGIAM_CONGTY_ID = MGCT.MIENGIAM_ID
      where MG.TIEPNHAN_ID= '$TIEPNHAN_ID$' and MGCT.REF_TABLE = 'TT_MIENGIAM_CONGTY' and MG.TINHTRANG = 1 group by VIENPHI_ID
      )g on a.VIENPHI_ID = g.VIENPHI_ID

    </statement>
    <statement id="DAO00330_GetListCongNoNoiTru" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select ntba.BENHAN_ID, ntba.TIEPNHAN_ID, ntba.SOBENHAN, ntba.NGAYVAOKHOA as NGAYVAOVIEN, tn.SOBHYT, tn.SOTIEPNHAN, bn.MAYTE, bn.TENBENHNHAN,
      dt.TENDOITUONG, NULL AS MAGIUONG, pb.TENPHONGBAN as TENKHOA, pb.MAPHONGBAN, tu.TAMUNG, hu.HOANUNG,NULL AS DICHVU_CHUATHUCHIEN, vp.CHIPHITHANHTOAN, vp.BENHNHANTHANHTOAN, vp.BHYTCHITRA
      , ntba.LOAIBENHAN
      from  TT_NOITRU_BENHAN ntba left join TT_TIEPNHAN tn on tn.TIEPNHAN_ID = ntba.TIEPNHAN_ID
      left join TT_BENHNHAN bn on bn.BENHNHAN_ID = tn.BENHNHAN_ID
      inner join TM_DOITUONG dt on tn.DOITUONG_ID = dt.DOITUONG_ID
      inner join TM_PHONGBAN pb on pb.PHONGBAN_ID = isnull(ntba.KHOACHUYENDEN_ID, ntba.KHOAVAO_ID)
      inner join
      (select A.BENHAN_ID, SUM(A.BENHNHAN_PHAITHANHTOAN) as CHIPHITHANHTOAN,sum(A.GIATRI_BENHNHAN_DATHANHTOAN) as BENHNHANTHANHTOAN,sum (A.BHYT_THANHTIEN_CHITRA) as BHYTCHITRA
      from TT_VIENPHI A
      INNER join TT_MAU_CHUNGTU_CHITIET B on A.REF_ID = B.CHUNGTUCHITIET_ID and A.REF_TABLE = 'TT_MAU_CHUNGTU_CHITIET' AND B.BENHVIEN_ID = '$BENHVIEN_ID$'
      INNER JOIN TT_MAU_CHUNGTU C ON B.CHUNGTU_ID=C.CHUNGTU_ID AND C.CHUNGTULIENQUAN_ID IS NULL
      where A.BENHAN_ID is not null and A.BENHVIEN_ID = '$BENHVIEN_ID$' and ACTIVE = '1'
      and A.DUOC_ID is not null and A.REF_ID is not null and A.REF_ID != 0 and A.SOLUONG > 0
      GROUP BY A.BENHAN_ID) vp on vp.BENHAN_ID = ntba.BENHAN_ID
      left join
      (SELECT BENHAN_ID, SUM(GIATRITHUCTHU) AS TAMUNG
      FROM TT_HOADON WHERE LOAIHOADON ='TU'and (TRANGTHAI = 'DATHUTIEN' or TRANGTHAI = 'CHODUYET'  or TRANGTHAI = 'DADUYET') and BENHAN_ID is not null and HUYHOADON = 0 and BENHVIEN_ID = '$BENHVIEN_ID$'
      GROUP BY BENHAN_ID
      ) tu on tu.BENHAN_ID = ntba.BENHAN_ID
      left join
      (SELECT BENHAN_ID, SUM(GIATRIHOADON) AS HOANUNG
      FROM TT_HOADON WHERE LOAIHOADON ='HU' and BENHAN_ID is not null and BENHVIEN_ID = '$BENHVIEN_ID$' GROUP BY BENHAN_ID
      ) hu on hu.BENHAN_ID = ntba.BENHAN_ID

      where (ntba.KHOACHUYENDEN_ID IN ($LIST_KHOADIEUTRI_ID$) or (ntba.KHOAVAO_ID IN ($LIST_KHOADIEUTRI_ID$) and ntba.KHOACHUYENDEN_ID is null))
      and ntba.BENHVIEN_ID = '$BENHVIEN_ID$'
      <isNotEmpty prepend="and" property="TUNGAY">
        ntba.NGAYVAOKHOA &#62;&#61; '$TUNGAY$'
      </isNotEmpty>
      <isNotEmpty prepend="and" property="DENNGAY">
        ntba.NGAYVAOKHOA &#60;&#61; '$DENNGAY$'
      </isNotEmpty>
      AND ntba.TRANGTHAI = '$TRANGTHAI$'
      <isNotEmpty prepend="and" property="TENBENHNHAN">
        (bn.TENBENHNHAN like '%' + #TENBENHNHAN# + '%' or bn.MAYTE like '%' + #TENBENHNHAN# + '%')
      </isNotEmpty>
    </statement>
    <statement id="DAO00330_GetVienphiBenhAnNoiTru_BIL16" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select NULL  as PHONGBAN_ID, A.DUOC_ID as NOIDUNG_ID, A.REF_ID as IDREF, A.VIENPHI_ID,
      A.SOLUONG as SOLUONG, A.SOLUONG as SOLUONG_NEW, A.DICHVU_ID, A.DUOC_ID,
      A.DONGIA_DOANHTHU, A.DONGIA_DOANHTHU as DONGIADOANHTHU, A.BHYT_DONGIA_CHITRA,
      A.BHYT_DONGIA as DONGIAHOTRO, A.BHYT_THANHTIEN_CHITRA as DONGIAHOTROCHITRA, A.BHYT_DONGIA_CHITRA as DONGIAHOTROCHITRA_NEW,
      A.REF_TABLE as LOAI, A.BHYT_DONGIA, A.BHYT_THANHTIEN, A.BHYT_THANHTIEN_CHITRA, A.BENHNHAN_PHAITHANHTOAN,
      A.GIATRI_BENHNHAN_DATHANHTOAN, A.BENHVIEN_ID, A.THANHTIEN_DOANHTHU,
      A.LOAI_CHIPHI, A.LOAIGIA_ID, A.REF_TABLE, A.KHAMBENH_ID, A.REF_ID, A.DUOCPHEPTHUCHIEN,
      A.HUY, A.KHONGTHUTIEN, A.DATHANHTOAN, A.HOADON_ID, A.ACTIVE, A.BENHNHAN_ID, A.DOTDIEUTRI_ID,
      M.TENMAU AS NOIDUNG, M.MAMAU AS MADICHVU, null NORESULT, DVT.TENDONVITINH AS DONVITINH, LM.MALOAIMAU AS MALOAIDUOC, M.BHYT AS DUOC_BHYT,
      'M' AS LOAIVATTU_ID, null MANHOMDICHVU
      from TT_VIENPHI A
      INNER JOIN TT_MAU_CHUNGTU_CHITIET CT ON A.REF_ID=CT.CHUNGTUCHITIET_ID AND A.REF_TABLE='TT_MAU_CHUNGTU_CHITIET' AND CT.BENHVIEN_ID='$BENHVIEN_ID$'
      INNER JOIN TT_MAU_CHUNGTU CTU ON CT.CHUNGTU_ID=CTU.CHUNGTU_ID AND CTU.CHUNGTULIENQUAN_ID IS NULL
      INNER join TM_MAU M on CT.MAU_ID = M.MAU_ID
      LEFT JOIN TM_MAU_DONVITINH DVT ON M.DONVITINH_ID = DVT.DONVITINH_ID
      LEFT JOIN TM_MAU_LOAIMAU LM ON LM.LOAIMAU_ID = M.LOAIMAU_ID
      LEFT JOIN TM_MAU_NHOMMAU NM ON NM.NHOMMAU_ID = LM.NHOMMAU_ID
      where A.BENHAN_ID = '$BENHAN_ID$' and A.BENHVIEN_ID = '$BENHVIEN_ID$' and A.DUOC_ID is not null and A.REF_TABLE = 'TT_MAU_CHUNGTU_CHITIET'
      and A.KHONGTHUTIEN != '1' and A.TIEPNHAN_ID = '$TIEPNHAN_ID$'
      <isNotEmpty prepend="" property="BIL_XACNHANBHYT_HIENTHI_TATCA">
        <isEqual prepend="AND" property="BIL_XACNHANBHYT_HIENTHI_TATCA" compareValue="False">
          A.BHYT_DONGIA > 0
        </isEqual>
      </isNotEmpty>
      <isNotEmpty prepend="and" property="DATHANHTOAN">
        A.DATHANHTOAN = '$DATHANHTOAN$'
      </isNotEmpty>
    </statement>
    <statement id="DAO00330_InsertXacnhanChitietBHYTNoitru" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      insert into TT_XACNHANCHIPHICHITIET
      select
      '$XACNHANCHIPHI_ID$' as XACNHANCHIPHI_ID, A.VIENPHI_ID, A.REF_ID as IDREF, A.DUOC_ID as NOIDUNG_ID, dc.TENMAU as NOIDUNG,
      A.SOLUONG as SOLUONG,
      A.DONGIA_DOANHTHU as DONGIADOANHTHU, A.BHYT_DONGIA as DONGIAHOTRO, A.BHYT_THANHTIEN_CHITRA as DONGIAHOTROCHITRA, A.BHYT_DONGIA_CHITRA as DONGIATHANHTOAN,
      '$LOAI$' as LOAI, null as NGOAITRU_TOATHUOC_ID, null as NOITRU_TOATHUOC_ID, null as PHONGBAN_ID,
      '$BENHVIEN_ID$' as BENHVIEN_ID, getdate() as NGAYCAPNHAT, null as NGUOICAPNHAT_ID
      , 0 THANHTIEN, 0 MUCHUONG, 0 BN_TT, 0 THANHTIEN_BHYT, 0 BN_CTT
      from TT_VIENPHI A
      inner join TT_NOITRU_BENHAN D on D.BENHAN_ID = A.BENHAN_ID
      left join TM_MAU dc on dc.MAU_ID = A.DUOC_ID
      where A.BENHAN_ID = '$BENHAN_ID$' and A.BENHVIEN_ID = '$BENHVIEN_ID$'
      and (A.DICHVU_ID is null and A.DUOC_ID is not null) and REF_TABLE = 'TT_MAU_CHUNGTU_CHITIET'
      and A.KHONGTHUTIEN != '1' and A.TIEPNHAN_ID = '$TIEPNHAN_ID$' and A.BHYT_DONGIA > 0
    </statement>
  <statement id="DAO00330_TT_VIENPHI_GetList" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
    select distinct a.*, b.TINHTRANG AS TINHTRANG_MG, d.TINHTRANG_BHTN, e.TINHTRANG_MGCT
    , b.MIENGIAMCHITIET_ID, b.GIATRIMIENGIAM, d.GIATRIMIENGIAM_BHTN, e.GIATRIMIENGIAM_CONGTY, e.GIATRIMIENGIAM_CONGTY as GIATRIMIENGIAM_CTCT, f.GIATRIMIENGIAM_THANHVIEN
    , NULL AS DVKEMTHEO, NULL AS DVKEMTHEO_KHACEKIP, ttnt.PHONGBANRATOA_ID NOIYEUCAU_ID, NULL AS NOITHUCHIEN_ID, NULL AS DVYEUCAU_ID, 0 AS HUYYEUCAU, NULL AS DANGKY_ID,
    dc.TENMAU NOIDUNG, dc.MAMAU MADICHVU, NULL AS NORESULT, DVT.TENDONVITINH AS DONVITINH, ld.MALOAIMAU AS MALOAIDUOC, DC.BHYT AS DUOC_BHYT, 'M' AS LOAIVATTU_ID,NM.TENNHOMMAU AS MANHOMDICHVU
    from
    (select VP.*, sbh.SOBHYT as SOBHYT_HUONG
    from TT_VIENPHI VP
    left join TT_TIEPNHAN_SOTHEBHYT sbh on sbh.SOBHYT_HUONG_ID = VP.SOBHYT_HUONG_ID
    where (VP.GIATRI_BENHNHAN_DATHANHTOAN = 0 or VP.GIATRI_BENHNHAN_DATHANHTOAN is null)
    <isNotEmpty prepend="and" property="TIEPNHAN_ID">
          VP.TIEPNHAN_ID = '$TIEPNHAN_ID$'
        </isNotEmpty>
      <isNotEmpty prepend="and" property="BENHAN_ID">
        VP.BENHAN_ID = '$BENHAN_ID$'
      </isNotEmpty>
        <isNotEmpty prepend="and" property="BENHVIEN_ID">
          VP.BENHVIEN_ID = '$BENHVIEN_ID$'
        </isNotEmpty>
        <isNotEmpty prepend="and" property="LISTDATE">
          CONVERT(date, NGAYTAO) IN ($LISTDATE$)
        </isNotEmpty>
      <!--TT_VIENPHI-->
      )a left join
      
      <!--TT_MIENGIAM-->
    (
    select VIENPHI_ID, MG.TINHTRANG, MGCT.MIENGIAMCHITIET_ID, MGCT.GIATRIMIENGIAM
    from TT_MIENGIAM MG INNER JOIN TT_MIENGIAM_CHITIET MGCT ON MG.MIENGIAM_ID = MGCT.MIENGIAM_ID
    where
    MG.TIEPNHAN_ID= '$TIEPNHAN_ID$' and MGCT.REF_TABLE = 'TT_MIENGIAM'
    )b
    on a.VIENPHI_ID = b.VIENPHI_ID

    left join(
    select VIENPHI_ID, MG.TINHTRANG AS TINHTRANG_BHTN, MGCT.GIATRIMIENGIAM as GIATRIMIENGIAM_BHTN
    from TT_MIENGIAM_BHTN MG INNER JOIN TT_MIENGIAM_CHITIET MGCT ON MG.MIENGIAM_BHTN_ID = MGCT.MIENGIAM_ID
    where
    MG.TIEPNHAN_ID= '$TIEPNHAN_ID$' and MGCT.REF_TABLE = 'TT_MIENGIAM_BHTN'
    )d
    on a.VIENPHI_ID = d.VIENPHI_ID

    left join(
    select VIENPHI_ID, MG.TINHTRANG AS TINHTRANG_MGCT, MGCT.GIATRIMIENGIAM as GIATRIMIENGIAM_CONGTY
    from TT_MIENGIAM_CONGTY MG INNER JOIN TT_MIENGIAM_CHITIET MGCT ON MG.MIENGIAM_CONGTY_ID = MGCT.MIENGIAM_ID
    where
    MG.TIEPNHAN_ID= '$TIEPNHAN_ID$' and MGCT.REF_TABLE = 'TT_MIENGIAM_CONGTY'
    )e
    on a.VIENPHI_ID = e.VIENPHI_ID

    left join(
    select VIENPHI_ID, MG.TINHTRANG AS TINHTRANG_MGCT, MGCT.GIATRIMIENGIAM as GIATRIMIENGIAM_THANHVIEN
    from TT_MIENGIAM_THANHVIEN MG INNER JOIN TT_MIENGIAM_CHITIET MGCT ON MG.MIENGIAM_THANHVIEN_ID = MGCT.MIENGIAM_ID
    where
    MG.TIEPNHAN_ID= '$TIEPNHAN_ID$' and MGCT.REF_TABLE = 'TT_MIENGIAM_THANHVIEN'
    )f
    on a.VIENPHI_ID = f.VIENPHI_ID
    inner join
    (
    select DK.NOICHIDINH_ID as PHONGBANRATOA_ID, CT.CHUNGTUCHITIET_ID, 'TT_MAU_CHUNGTU_CHITIET' REF_TABLE
    from TT_MAU_DANGKYMAU DK JOIN TT_MAU_DANGKYMAU_CHITIET DKCT ON DK.DANGKYMAU_ID = DKCT.DANGKYMAU_ID AND DK.TIEPNHAN_ID  = '$TIEPNHAN_ID$'
    INNER JOIN TT_MAU_CHUNGTU CTU ON DKCT.CHUNGTU_ID = CTU.CHUNGTU_ID AND CTU.CHUNGTULIENQUAN_ID IS NULL
    JOIN TT_MAU_CHUNGTU_CHITIET CT ON CT.CHUNGTU_ID=CTU.CHUNGTU_ID
    ) ttnt on ttnt.CHUNGTUCHITIET_ID = a.REF_ID and a.REF_TABLE = ttnt.REF_TABLE
    left join TM_MAU dc on A.DUOC_ID = dc.MAU_ID
    LEFT JOIN TM_MAU_DONVITINH DVT ON DC.DONVITINH_ID = DVT.DONVITINH_ID
    left join TM_MAU_LOAIMAU ld on dc.LOAIMAU_ID = ld.LOAIMAU_ID
    LEFT JOIN TM_MAU_NHOMMAU NM ON NM.NHOMMAU_ID = LD.NHOMMAU_ID
  </statement>
    <statement id="DAO00330_GetVienphiTiepNhan_BIL09" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select distinct isnull(DK.TRANGTHAI, '') TRANGTHAI
      , NULL as PHONGBAN_ID, CTU.NGAYCHUNGTU NGAYKHAM,
      A.DUOC_ID as NOIDUNG_ID, A.REF_ID as IDREF, A.VIENPHI_ID,
      A.SOLUONG as SOLUONG, A.SOLUONG as SOLUONG_NEW, A.DICHVU_ID, A.DUOC_ID, A.BHYT_DONGIA_CHITRA,
      A.DONGIA_DOANHTHU, A.DONGIA_DOANHTHU as DONGIADOANHTHU, A.BHYT_DONGIA as DONGIAHOTRO, A.BHYT_THANHTIEN_CHITRA as DONGIAHOTROCHITRA, A.BHYT_DONGIA_CHITRA as DONGIAHOTROCHITRA_NEW,
      A.REF_TABLE as LOAI, A.BHYT_DONGIA, A.BHYT_THANHTIEN, A.BHYT_THANHTIEN_CHITRA, A.BENHNHAN_PHAITHANHTOAN, A.GIATRI_BENHNHAN_DATHANHTOAN, A.BENHVIEN_ID, A.THANHTIEN_DOANHTHU,
      A.LOAI_CHIPHI, A.LOAIGIA_ID, REF_TABLE, A.KHAMBENH_ID, A.REF_ID, A.DUOCPHEPTHUCHIEN,
      A.HUY, A.KHONGTHUTIEN, A.DATHANHTOAN, A.HOADON_ID, A.ACTIVE, NULL AS DVYEUCAU_ID, DK.NGAYYEUCAU, DK.BACSICHIDINH_ID, dk.NOICHIDINH_ID as NOIYEUCAU_ID
      , A.DATHUCHIEN,
      M.TENMAU AS NOIDUNG, M.MAMAU AS MADICHVU, NULL AS NORESULT, DVT.TENDONVITINH AS DONVITINH, LM.MALOAIMAU AS MALOAIDUOC, M.BHYT AS DUOC_BHYT, 'M' AS LOAIVATTU_ID,
      NM.TENNHOMMAU AS MANHOMDICHVU, NULL AS NOIDUNG2, NULL AS HUONGGIAIQUYET_ID
      from TT_VIENPHI A
      INNER JOIN TT_MAU_CHUNGTU_CHITIET CT ON A.REF_ID=CT.CHUNGTUCHITIET_ID AND A.REF_TABLE='TT_MAU_CHUNGTU_CHITIET' AND CT.BENHVIEN_ID='$BENHVIEN_ID$'
      INNER JOIN TT_MAU_CHUNGTU CTU ON CT.CHUNGTU_ID=CTU.CHUNGTU_ID AND CTU.CHUNGTULIENQUAN_ID IS NULL
      INNER join TM_MAU M on CT.MAU_ID = M.MAU_ID
      LEFT JOIN TM_MAU_DONVITINH DVT ON M.DONVITINH_ID = DVT.DONVITINH_ID
      LEFT JOIN TT_MAU_DANGKYMAU_CHITIET DKCT ON DKCT.CHUNGTU_ID = CTU.CHUNGTU_ID AND DKCT.BENHVIEN_ID='$BENHVIEN_ID$'
      LEFT JOIN TT_MAU_DANGKYMAU DK ON DK.DANGKYMAU_ID = DKCT.DANGKYMAU_ID
      LEFT JOIN TM_MAU_LOAIMAU LM ON LM.LOAIMAU_ID = M.LOAIMAU_ID
      LEFT JOIN TM_MAU_NHOMMAU NM ON NM.NHOMMAU_ID = LM.NHOMMAU_ID
      where
      A.TIEPNHAN_ID = '$TIEPNHAN_ID$' and A.BENHVIEN_ID = '$BENHVIEN_ID$' and (A.BENHAN_ID is NULL or A.BENHAN_ID = '') AND A.KHONGTHUTIEN != '1'
      and (exists (select KHAMBENH_ID from TT_NGOAITRU_KHAMBENH where A.KHAMBENH_ID = KHAMBENH_ID and TIEPNHAN_ID = '$TIEPNHAN_ID$') or A.KHAMBENH_ID is null)
      <isNotEmpty prepend="" property="BIL_XACNHANBHYT_HIENTHI_TATCA">
        <isEqual prepend="AND" property="BIL_XACNHANBHYT_HIENTHI_TATCA" compareValue="False">
          (A.BHYT_DONGIA > 0
          <isNotEmpty prepend="" property="PHA_DUOC_KHONG_KIEMTRA_GIA">
            <isEqual prepend="OR" property="PHA_DUOC_KHONG_KIEMTRA_GIA" compareValue="True">
              (A.DUOC_ID is not null and A.BHYT_DONGIA = 0 and A.DONGIA_DOANHTHU = 0)
            </isEqual>
          </isNotEmpty>
          )
        </isEqual>
      </isNotEmpty>
      and
      (
      (A.DICHVU_ID is not null) or (A.DICHVU_ID is null and A.DUOC_ID is not null)
      )
      ORDER BY A.VIENPHI_ID
    </statement>
    <statement id="DAO00330_GetVienphiTiepNhan_BIL09_DaBHYT" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select distinct isnull(DK.TRANGTHAI, '') TRANGTHAI
      , NULL as PHONGBAN_ID, CTU.NGAYCHUNGTU NGAYKHAM,
      VP.DUOC_ID as NOIDUNG_ID, VP.REF_ID as IDREF, XNCT.VIENPHI_ID,
      VP.SOLUONG as SOLUONG, VP.SOLUONG as SOLUONG_NEW, VP.DICHVU_ID, VP.DUOC_ID, VP.BHYT_DONGIA_CHITRA,
      VP.DONGIA_DOANHTHU, VP.DONGIA_DOANHTHU as DONGIADOANHTHU, VP.BHYT_DONGIA as DONGIAHOTRO, VP.BHYT_THANHTIEN_CHITRA as DONGIAHOTROCHITRA, VP.BHYT_DONGIA_CHITRA as DONGIAHOTROCHITRA_NEW,
      VP.REF_TABLE as LOAI, VP.BHYT_DONGIA, VP.BHYT_THANHTIEN, VP.BHYT_THANHTIEN_CHITRA, VP.BENHNHAN_PHAITHANHTOAN, VP.GIATRI_BENHNHAN_DATHANHTOAN, VP.BENHVIEN_ID, VP.THANHTIEN_DOANHTHU,
      VP.LOAI_CHIPHI, VP.LOAIGIA_ID, REF_TABLE, VP.KHAMBENH_ID, VP.REF_ID, VP.DUOCPHEPTHUCHIEN,
      VP.HUY, VP.KHONGTHUTIEN, VP.DATHANHTOAN, VP.HOADON_ID, VP.ACTIVE, NULL AS DVYEUCAU_ID, DK.NGAYYEUCAU, DK.BACSICHIDINH_ID, dk.NOICHIDINH_ID as NOIYEUCAU_ID
      , VP.DATHUCHIEN,
      M.TENMAU AS NOIDUNG, M.MAMAU AS MADICHVU, NULL AS NORESULT, DVT.TENDONVITINH AS DONVITINH, LM.MALOAIMAU AS MALOAIDUOC, M.BHYT AS DUOC_BHYT, 'M' AS LOAIVATTU_ID,
      NM.TENNHOMMAU AS MANHOMDICHVU, NULL AS NOIDUNG2
      from TT_XACNHANCHIPHI XN
      inner join TT_XACNHANCHIPHICHITIET XNCT on XNCT.XACNHANCHIPHI_ID = XN.XACNHANCHIPHI_ID and XNCT.BENHVIEN_ID = XN.BENHVIEN_ID
      inner join TT_VIENPHI VP on VP.VIENPHI_ID = XNCT.VIENPHI_ID and VP.BENHVIEN_ID = XNCT.BENHVIEN_ID AND VP.REF_TABLE='TT_MAU_CHUNGTU_CHITIET'
      INNER JOIN TT_MAU_CHUNGTU_CHITIET CT ON VP.REF_ID=CT.CHUNGTUCHITIET_ID AND VP.REF_TABLE='TT_MAU_CHUNGTU_CHITIET' AND CT.BENHVIEN_ID='$BENHVIEN_ID$'
      INNER JOIN TT_MAU_CHUNGTU CTU ON CT.CHUNGTU_ID=CTU.CHUNGTU_ID AND CTU.CHUNGTULIENQUAN_ID IS NULL
      INNER join TM_MAU M on CT.MAU_ID = M.MAU_ID
      LEFT JOIN TM_MAU_DONVITINH DVT ON M.DONVITINH_ID = DVT.DONVITINH_ID
      LEFT JOIN TT_MAU_DANGKYMAU_CHITIET DKCT ON DKCT.CHUNGTU_ID = CTU.CHUNGTU_ID AND DKCT.BENHVIEN_ID='$BENHVIEN_ID$'
      LEFT JOIN TT_MAU_DANGKYMAU DK ON DK.DANGKYMAU_ID = DKCT.DANGKYMAU_ID
      LEFT JOIN TM_MAU_LOAIMAU LM ON LM.LOAIMAU_ID = M.LOAIMAU_ID
      LEFT JOIN TM_MAU_NHOMMAU NM ON NM.NHOMMAU_ID = LM.NHOMMAU_ID
      where XN.TIEPNHAN_ID = '$TIEPNHAN_ID$' and XN.BENHVIEN_ID = '$BENHVIEN_ID$'
      ORDER BY XNCT.VIENPHI_ID
    </statement>
    <statement id="DAO00330_TT_VIENPHI_GetList_TiepNhanPhaiThanhToanWithVienphiId" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select  a.*, b.GIATRIMIENGIAM_BH, c.GIATRIMIENGIAM_BHTN, f.GIATRIMIENGIAM_THANHVIEN, g.GIATRIMIENGIAM_CTCT
      from
      (select VP.*, null NOITHUCHIEN_ID, dk.NOICHIDINH_ID as NOIYEUCAU_ID, '0' as HUYYEUCAU
      from TT_VIENPHI VP
      INNER JOIN TT_MAU_CHUNGTU_CHITIET CT ON VP.REF_ID=CT.CHUNGTUCHITIET_ID AND VP.REF_TABLE='TT_MAU_CHUNGTU_CHITIET' AND CT.BENHVIEN_ID='$BENHVIEN_ID$'
      INNER JOIN TT_MAU_CHUNGTU CTU ON CT.CHUNGTU_ID=CTU.CHUNGTU_ID AND CTU.CHUNGTULIENQUAN_ID IS NULL
      LEFT JOIN TT_MAU_DANGKYMAU_CHITIET DKCT ON DKCT.CHUNGTU_ID = CTU.CHUNGTU_ID AND DKCT.BENHVIEN_ID='$BENHVIEN_ID$'
      LEFT JOIN TT_MAU_DANGKYMAU DK ON DK.DANGKYMAU_ID = DKCT.DANGKYMAU_ID
      where Vp.TIEPNHAN_ID = '$TIEPNHAN_ID$' and Vp.ACTIVE = '1' and vp.DUOC_ID is not null and
      ((vp.DATHANHTOAN = '0') or (vp.BENHNHAN_PHAITHANHTOAN > vp.GIATRI_BENHNHAN_DATHANHTOAN and vp.DATHANHTOAN = '1'))
      and vp.VIENPHI_ID in ($LIST_VIENPHI$)) a

      left join (select VIENPHI_ID,
      sum(MGCT.GIATRIMIENGIAM) AS GIATRIMIENGIAM_BH from TT_MIENGIAM MG
      INNER JOIN TT_MIENGIAM_CHITIET MGCT ON MG.MIENGIAM_ID = MGCT.MIENGIAM_ID
      where MG.TIEPNHAN_ID= '$TIEPNHAN_ID$' and MGCT.REF_TABLE = 'TT_MIENGIAM' and MG.TINHTRANG = 1 group by VIENPHI_ID
      ) b on a.VIENPHI_ID = b.VIENPHI_ID

      left join (select VIENPHI_ID, sum(MGCT.GIATRIMIENGIAM) AS GIATRIMIENGIAM_BHTN
      from TT_MIENGIAM_BHTN MG
      INNER JOIN TT_MIENGIAM_CHITIET MGCT ON MG.MIENGIAM_BHTN_ID = MGCT.MIENGIAM_ID
      where  MG.TIEPNHAN_ID= '$TIEPNHAN_ID$' and MGCT.REF_TABLE = 'TT_MIENGIAM_BHTN' and MG.TINHTRANG = 1 group by VIENPHI_ID
      )c on a.VIENPHI_ID = c.VIENPHI_ID

      left join (select VIENPHI_ID, sum(MGCT.GIATRIMIENGIAM) AS GIATRIMIENGIAM_THANHVIEN
      from TT_MIENGIAM_THANHVIEN MG
      INNER JOIN TT_MIENGIAM_CHITIET MGCT ON MG.MIENGIAM_THANHVIEN_ID = MGCT.MIENGIAM_ID
      where MG.TIEPNHAN_ID= '$TIEPNHAN_ID$' and MGCT.REF_TABLE = 'TT_MIENGIAM_THANHVIEN' and MG.TINHTRANG = 1 group by VIENPHI_ID
      )f on a.VIENPHI_ID = f.VIENPHI_ID

      left join(select VIENPHI_ID, sum(MGCT.GIATRIMIENGIAM) AS GIATRIMIENGIAM_CTCT
      from TT_MIENGIAM_CONGTY MG
      INNER JOIN TT_MIENGIAM_CHITIET MGCT ON MG.MIENGIAM_CONGTY_ID = MGCT.MIENGIAM_ID
      where MG.TIEPNHAN_ID= '$TIEPNHAN_ID$' and MGCT.REF_TABLE = 'TT_MIENGIAM_CONGTY' and MG.TINHTRANG = 1 group by VIENPHI_ID
      )g on a.VIENPHI_ID = g.VIENPHI_ID
    </statement>
  </statements>
</sqlMap>
