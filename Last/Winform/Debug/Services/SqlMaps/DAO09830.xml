<?xml version="1.0" encoding="utf-8" ?>
<sqlMap namespace="eHospital" xmlns="http://ibatis.apache.org/mapping" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" >
  <statements>
    <statement id="DAO09830_Update_Vienphi_XacNhanChiphi" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      et a.DONGIAHOTROCHITRA = v.bhyt_thanhtien_chitra, a.DONGIATHANHTOAN = v.BHYT_DONGIA_CHITRA
      ,a.DONGIAHOTRO= v.BHYT_DONGIA
      from TT_XACNHANCHIPHICHITIET a
      join TT_XACNHANCHIPHI b on b.XACNHANCHIPHI_ID = a.XACNHANCHIPHI_ID
      join TT_VIENPHI v on v.VIENPHI_ID = a.VIENPHI_ID
      where BHYT_THANHTIEN_CHITRA != ISNULL(DONGIAHOTROCHITRA,0)
      or (BHYT_DONGIA != ISNULL(DONGIAHOTRO,0) and BHYT_THANHTIEN_CHITRA = DONGIAHOTROCHITRA)
      and v.TIEPNHAN_ID = #TIEPNHAN_ID#
      <isNotEmpty property="BENHAN_ID">
        and v.BENHAN_ID = #BENHAN_ID#
      </isNotEmpty>
    </statement>
    <statement id="DAO09830_Get_Ngoaitru_XML_ByTiepnhanID" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      SELECT TH.TIEPNHAN_ID, NULL AS KHAMBENH_ID, BENHAN_ID, BN.BENHNHAN_ID, BN.MAYTE, BN.TENBENHNHAN, YEAR(GETDATE()) - BN.NAMSINH AS TUOI, N'KHÁM BỆNH' AS NOIDUNGKHAM
      , TH.SOBHYT, DAXACNHAN = CASE WHEN TH.XACNHANCHIPHI_ID IS NOT NULL THEN CAST(1 AS BIT) ELSE CAST(0 AS BIT) END, NGAYTIEPNHAN AS NGAYVAOVIEN
      , DOITUONG_ID = TH.DOITUONG_ID, NGAYVAO = THOIGIANVAOVIEN, NGAYRA = THOIGIANRAVIEN, NGAYKHAM = TH.NGAYTIEPNHAN , CHANDOAN = TH.CHANDOANRAVIEN
      , XACNHANCHIPHI_ID, TUYENKHAMBENH = TKB.DICTIONARY_NAME, TH.NGAYXACNHAN, MA_LK, T_TONGCHI = T_TONGCHI, T_BHTT = T_BHTT, T_BNTT = T_BNTT
      , '$MACSKCB$' MACSKCB, '$TENCSKCB$' TENCSKCB
      FROM
      (
      SELECT TN.TIEPNHAN_ID, BENHAN_ID = NULL, TN.BENHNHAN_ID, TN.DOITUONG_ID, TN.SOBHYT
      , NGAYTIEPNHAN = THOIGIANTIEPNHAN, TUYENKHAMBENH_ID, TN.SOTIEPNHAN
      , XN.XACNHANCHIPHI_ID, XN.NGAYXACNHAN
      , THOIGIANVAOVIEN = NULL, THOIGIANRAVIEN = NULL, CHANDOANRAVIEN = '', SOBENHAN = NULL
      , MA_LK = LEFT(TN.SOBHYT, 16) + '_' + TN.SOTIEPNHAN
      , T_TONGCHI = SUM(XNCT.SOLUONG * (CASE WHEN VP.BHYT_CONGKHAM_DAU_TYLE>0 AND VP.BHYT_DONGIA_CONGKHAM_DAU>0 THEN VP.BHYT_DONGIA ELSE XNCT.DONGIAHOTRO END))
      , T_BHTT	= SUM(XNCT.DONGIAHOTROCHITRA)
      , T_BNTT	= SUM((XNCT.SOLUONG * (CASE WHEN VP.BHYT_CONGKHAM_DAU_TYLE>0 AND VP.BHYT_DONGIA_CONGKHAM_DAU>0 THEN VP.BHYT_DONGIA ELSE XNCT.DONGIAHOTRO END)) - XNCT.DONGIAHOTROCHITRA)
      FROM TT_XACNHANCHIPHI XN (NOLOCK)
      INNER JOIN TT_XACNHANCHIPHICHITIET XNCT (NOLOCK) ON XNCT.XACNHANCHIPHI_ID= XN.XACNHANCHIPHI_ID AND XN.BENHVIEN_ID='$BENHVIEN_ID$' AND XNCT.BENHVIEN_ID='$BENHVIEN_ID$'
      INNER JOIN TT_VIENPHI VP (NOLOCK) ON XNCT.VIENPHI_ID=VP.VIENPHI_ID AND XNCT.BENHVIEN_ID='$BENHVIEN_ID$' AND VP.BENHVIEN_ID='$BENHVIEN_ID$'
      INNER JOIN TT_TIEPNHAN TN (NOLOCK) ON TN.TIEPNHAN_ID = XN.TIEPNHAN_ID AND TN.BENHVIEN_ID='$BENHVIEN_ID$'
      JOIN TM_DOITUONG C ON C.DOITUONG_ID = TN.DOITUONG_ID AND C.BENHVIEN_ID='$BENHVIEN_ID$'
      WHERE
      XN.LOAI IN ('NGOAITRU','DTNGOAITRU') AND XNCT.SOLUONG > 0
      AND XNCT.DONGIAHOTROCHITRA > 0  and xn.thoigianxacnhan &lt;= getdate()
        <!--AND  XN.EXPORT = '$EXPORT$'-->
      AND C.MADOITUONG LIKE 'BHYT%' AND TN.SOBHYT NOT LIKE 'HT5%'
      AND XN.TIEPNHAN_ID = '$TIEPNHAN_ID$'
      GROUP BY TN.TIEPNHAN_ID, TN.BENHNHAN_ID, TN.DOITUONG_ID, TN.SOBHYT
      , THOIGIANTIEPNHAN, XN.XACNHANCHIPHI_ID
      , TUYENKHAMBENH_ID, TN.SOTIEPNHAN, XN.NGAYXACNHAN
      HAVING SUM(XNCT.DONGIAHOTROCHITRA * XNCT.SOLUONG) > 0      
      ) TH
      LEFT JOIN TT_BENHNHAN BN (NOLOCK) ON TH.BENHNHAN_ID=BN.BENHNHAN_ID AND BN.BENHVIEN_ID='$BENHVIEN_ID$'
      LEFT JOIN LST_DICTIONARY TKB (NOLOCK) ON TH.TUYENKHAMBENH_ID = TKB.DICTIONARY_ID AND TKB.BENHVIEN_ID='$BENHVIEN_ID$'
      ORDER BY NGAYTIEPNHAN
    </statement>
    
    <statement id="DAO09830_sp_BangKe01_NgoaiTru_eClaim" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      sp_BangKe01_NgoaiTru_eClaim #TIEPNHAN_ID#
    </statement>
    
    <statement id="DAO09830_sp_BangKe02_Noitru_eClaim" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      sp_BangKe02_Noitru_eClaim #BENHAN_ID#
    </statement>
    
    <statement id="DAO09830_Get_CapCuu_XML_ByTiepnhanID" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      SELECT TH.TIEPNHAN_ID, NULL AS KHAMBENH_ID, BENHAN_ID, BN.BENHNHAN_ID, BN.MAYTE, BN.TENBENHNHAN, YEAR(GETDATE()) - BN.NAMSINH AS TUOI, N'KHÁM BỆNH' AS NOIDUNGKHAM
      , TH.SOBHYT, DAXACNHAN = CASE WHEN TH.XACNHANCHIPHI_ID IS NOT NULL THEN CAST(1 AS BIT) ELSE CAST(0 AS BIT) END, NGAYTIEPNHAN AS NGAYVAOVIEN
      , DOITUONG_ID = TH.DOITUONG_ID, NGAYVAO = THOIGIANVAOVIEN, NGAYRA = THOIGIANRAVIEN, NGAYKHAM = TH.NGAYTIEPNHAN , CHANDOAN = TH.CHANDOANRAVIEN
      , XACNHANCHIPHI_ID, TUYENKHAMBENH = TKB.DICTIONARY_NAME, TH.NGAYXACNHAN, MA_LK, T_TONGCHI = T_TONGCHI, T_BHTT = T_BHTT, T_BNTT = T_BNTT
      , '$MACSKCB$' MACSKCB, '$TENCSKCB$' TENCSKCB
      FROM
      (
      SELECT TN.TIEPNHAN_ID, BA.BENHAN_ID, TN.BENHNHAN_ID, TN.DOITUONG_ID, TN.SOBHYT
      , NGAYTIEPNHAN = THOIGIANTIEPNHAN, TUYENKHAMBENH_ID, TN.SOTIEPNHAN
      , XN.XACNHANCHIPHI_ID, XN.NGAYXACNHAN
      , BA.THOIGIANVAOVIEN, BA.THOIGIANRAVIEN, CHANDOANRAVIEN = ISNULL(BA.CHANDOANRAVIEN,ICD.TENICD), BA.SOBENHAN
      , MA_LK = LEFT(TN.SOBHYT, 16) + '_' + REPLACE(BA.SOBENHAN, '/', '_')
      , T_TONGCHI = SUM(XNCT.SOLUONG * (CASE WHEN VP.BHYT_CONGKHAM_DAU_TYLE>0 AND VP.BHYT_DONGIA_CONGKHAM_DAU>0 THEN VP.BHYT_DONGIA_CONGKHAM_DAU ELSE XNCT.DONGIAHOTRO END))
      , T_BHTT	= SUM(XNCT.DONGIAHOTROCHITRA)
      , T_BNTT	= SUM((XNCT.SOLUONG * (CASE WHEN VP.BHYT_CONGKHAM_DAU_TYLE>0 AND VP.BHYT_DONGIA_CONGKHAM_DAU>0 THEN VP.BHYT_DONGIA_CONGKHAM_DAU ELSE XNCT.DONGIAHOTRO END)) - XNCT.DONGIAHOTROCHITRA)
      FROM TT_XACNHANCHIPHI XN (NOLOCK)
      INNER JOIN TT_XACNHANCHIPHICHITIET XNCT (NOLOCK) ON XNCT.XACNHANCHIPHI_ID=XN.XACNHANCHIPHI_ID AND XN.BENHVIEN_ID='$BENHVIEN_ID$' AND XNCT.BENHVIEN_ID='$BENHVIEN_ID$'
      INNER JOIN TT_VIENPHI VP (NOLOCK) ON XNCT.VIENPHI_ID=VP.VIENPHI_ID AND XNCT.BENHVIEN_ID='$BENHVIEN_ID$' AND VP.BENHVIEN_ID='$BENHVIEN_ID$'
      INNER JOIN TT_NOITRU_BENHAN BA (NOLOCK) ON BA.BENHAN_ID=XN.BENHAN_ID AND BA.BENHVIEN_ID='$BENHVIEN_ID$' AND BA.SOBENHAN LIKE '%/CC' AND BA.TRANGTHAI = 'DAKHOA'
      INNER JOIN TT_TIEPNHAN TN (NOLOCK) ON TN.TIEPNHAN_ID = BA.TIEPNHAN_ID AND TN.BENHVIEN_ID='$BENHVIEN_ID$'
      JOIN TM_DOITUONG DT ON DT.DOITUONG_ID = TN.DOITUONG_ID AND DT.BENHVIEN_ID='$BENHVIEN_ID$'
      LEFT JOIN TM_ICD ICD (NOLOCK) ON BA.ICD_BENHCHINH = ICD.ICD_ID AND ICD.BENHVIEN_ID='$BENHVIEN_ID$'
      WHERE  (XN.LOAI = 'CAPCUU' OR XN.LOAI = 'NOITRU')
      AND BA.SOBENHAN LIKE '%/CC'  and xn.thoigianxacnhan &lt;= getdate() <!--getdate() >= xn.thoigianxacnhan-->
      AND  XN.EXPORT = '$EXPORT$'
      AND DT.MADOITUONG LIKE 'BHYT%'
      AND TN.SOBHYT NOT LIKE 'HT5%'
      AND XNCT.SOLUONG > 0
      AND XN.TIEPNHAN_ID = '$TIEPNHAN_ID$'
      GROUP BY TN.TIEPNHAN_ID, TN.BENHNHAN_ID, TN.DOITUONG_ID, TN.SOBHYT
      , THOIGIANTIEPNHAN, XN.XACNHANCHIPHI_ID
      , TUYENKHAMBENH_ID, TN.SOTIEPNHAN, XN.NGAYXACNHAN
      , BA.THOIGIANVAOVIEN, BA.THOIGIANRAVIEN
      , BA.CHANDOANRAVIEN, ICD.TENICD
      , BA.BENHAN_ID, BA.SOBENHAN
      HAVING SUM(XNCT.DONGIAHOTROCHITRA * XNCT.SOLUONG) > 0
      ) TH
      LEFT JOIN TT_BENHNHAN BN (NOLOCK) ON TH.BENHNHAN_ID=BN.BENHNHAN_ID AND BN.BENHVIEN_ID='$BENHVIEN_ID$'
      LEFT JOIN LST_DICTIONARY TKB (NOLOCK) ON TH.TUYENKHAMBENH_ID = TKB.DICTIONARY_ID AND TKB.BENHVIEN_ID='$BENHVIEN_ID$'
      ORDER BY NGAYTIEPNHAN
    </statement>
    <statement id="DAO09830_Get_Noitru_XML_ByBenhanID" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      SELECT TH.TIEPNHAN_ID, NULL AS KHAMBENH_ID, BENHAN_ID, BN.BENHNHAN_ID, MAYTE, BN.TENBENHNHAN, YEAR(GETDATE()) - BN.NAMSINH AS TUOI
      , N'NỘI TRÚ - ' + SOBENHAN AS NOIDUNGKHAM, TH.SOBHYT, DAXACNHAN = CASE WHEN TH.XACNHANCHIPHI_ID IS NOT NULL THEN CAST(1 AS BIT) ELSE CAST(0 AS BIT) END
      , THOIGIANVAOVIEN, DOITUONG_ID = TH.DOITUONG_ID, NGAYVAO = TH.THOIGIANVAOVIEN, NGAYRA = TH.THOIGIANRAVIEN, NGAYKHAM = NULL, CHANDOAN = TH.CHANDOANRAVIEN
      , XACNHANCHIPHI_ID, TUYENKHAMBENH = TKB.DICTIONARY_NAME, NGAYXACNHAN, MA_LK, T_TONGCHI = T_TONGCHI, T_BHTT = T_BHTT, T_BNTT = T_BNTT, T_BNCCT = T_BNCCT
      , '$MACSKCB$' MACSKCB, '$TENCSKCB$' TENCSKCB
      FROM (
      SELECT TN.TIEPNHAN_ID, BA.BENHAN_ID, TN.BENHNHAN_ID, TN.DOITUONG_ID, TN.SOBHYT
      , NGAYTIEPNHAN = THOIGIANTIEPNHAN, TUYENKHAMBENH_ID, TN.SOTIEPNHAN
      , XN.XACNHANCHIPHI_ID, XN.NGAYXACNHAN
      , BA.THOIGIANVAOVIEN
      , BA.THOIGIANRAVIEN
      , CHANDOANRAVIEN = ISNULL(BA.CHANDOANRAVIEN, ICD.TENICD)
      , BA.SOBENHAN
      , MA_LK = LEFT(TN.SOBHYT, 16) + '_' + REPLACE(BA.SOBENHAN, '/', '_')
      , T_TONGCHI = SUM(XNCT.SOLUONG * XNCT.DONGIAHOTRO)
      , T_BHTT	= SUM(XNCT.DONGIAHOTROCHITRA)
      ,T_BNTT = SUM(CASE WHEN TN.TRAITUYEN = 1 THEN ROUND((XNCT.DONGIAHOTRO*XNCT.SOLUONG)*(1-DT.TYLE_TRAITUYEN),2) ELSE 0 END)
      , T_BNCCT = SUM(CASE WHEN TN.TRAITUYEN = 0 THEN ROUND((XNCT.DONGIAHOTRO*XNCT.SOLUONG)-XNCT.DONGIAHOTROCHITRA,2) ELSE
      ROUND((XNCT.DONGIAHOTRO*XNCT.SOLUONG)*DT.TYLE_TRAITUYEN-XNCT.DONGIAHOTROCHITRA,2) END )
      FROM TT_XACNHANCHIPHI XN (NOLOCK)
      LEFT JOIN TT_XACNHANCHIPHICHITIET XNCT (NOLOCK) ON XNCT.XACNHANCHIPHI_ID=XN.XACNHANCHIPHI_ID AND XN.BENHVIEN_ID='$BENHVIEN_ID$'
      LEFT JOIN TT_NOITRU_BENHAN BA (NOLOCK) ON BA.BENHAN_ID=XN.BENHAN_ID
      LEFT JOIN TT_TIEPNHAN TN (NOLOCK) ON TN.TIEPNHAN_ID=BA.TIEPNHAN_ID
      LEFT JOIN TM_ICD ICD (NOLOCK) ON BA.ICD_BENHCHINH=ICD.ICD_ID
      JOIN TM_DOITUONG DT (NOLOCK) ON DT.DOITUONG_ID=TN.DOITUONG_ID
      WHERE XN.LOAI = 'NOITRU'  and xn.thoigianxacnhan &lt;= getdate() <!--getdate() >= xn.thoigianxacnhan-->
      and BA.BENHAN_ID = '$BENHAN_ID$'
      AND BA.SOBENHAN NOT LIKE '%/CC'
      <!--AND   XN.EXPORT = '$EXPORT$'-->
      AND DT.MADOITUONG LIKE 'BHYT%'
      AND TN.SOBHYT NOT LIKE 'HT5%' AND XNCT.SOLUONG > 0
      GROUP BY TN.TIEPNHAN_ID, TN.BENHNHAN_ID, TN.DOITUONG_ID, TN.SOBHYT
      , THOIGIANTIEPNHAN, XN.XACNHANCHIPHI_ID
      , TUYENKHAMBENH_ID, TN.SOTIEPNHAN, XN.NGAYXACNHAN
      , BA.THOIGIANVAOVIEN, BA.THOIGIANRAVIEN
      , BA.CHANDOANRAVIEN, ICD.TENICD
      , BA.BENHAN_ID, BA.SOBENHAN
      HAVING SUM(XNCT.DONGIAHOTROCHITRA * XNCT.SOLUONG) > 0
      ) TH
      JOIN TT_BENHNHAN BN (NOLOCK) ON TH.BENHNHAN_ID=BN.BENHNHAN_ID
      LEFT JOIN LST_DICTIONARY TKB ON TH.TUYENKHAMBENH_ID=TKB.DICTIONARY_ID AND TKB.BENHVIEN_ID='$BENHVIEN_ID$'
    </statement>
    <statement id="DAO09830_SP_TM_SYS_UPLOAD_BHYT_XML" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      SP_TM_SYS_UPLOAD_BHYT_XML
      @ACTION = #ACTION#,
      @BENHVIEN_ID = #BENHVIEN_ID#,
      @BENHNHAN_ID = #BENHNHAN_ID#,
      @TIEPNHAN_ID = #TIEPNHAN_ID#,
      @SOTHE = #SOTHE#,
      @LOAIBANGKE = #LOAIBANGKE#,
      @THOIGIANBATDAU = #THOIGIANBATDAU#,
      @TENFILE = #TENFILE#,
      @VALID_MSG = #VALID_MSG#,
      @TRANGTHAI = #TRANGTHAI#
    </statement>
  </statements>
</sqlMap>