<?xml version="1.0" encoding="utf-8" ?>
<!--============================================================================
//	CAUTION: This file is generated by IBatisNetGen.3.SQLMap.cst at 11/11/2015 9:30:18 AM
//				Any manual editing will be lost in re-generation.
//===========================================================================-->
<sqlMap namespace="eHospital" xmlns="http://ibatis.apache.org/mapping" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
  <statements>
    <!--<statement id="DAO00063_GetSLDuocDaLuu" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select sum(SOLUONG) as SOLUONG
      from TT_NOITRU_TOATHUOC
      where KHAMBENH_ID  = '$KHAMBENH_ID$'
      and DUOC_ID  = '$DUOC_ID$'
    </statement>-->
    <statement id="DAO00063_GetTrangThaiTruocKhiXoa_Update_Thuoc_VTYT" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      SELECT TOATHUOC_ID FROM TT_NOITRU_TOATHUOC TT WHERE TT.KHAMBENH_ID ='$KHAMBENH_ID$' AND BENHVIEN_ID='$BENHVIEN_ID$'
      AND ( PHIEULINH_ID IS NOT NULL OR CHUNGTU_ID IS NOT NULL)
    </statement>
    <statement id="DAO00063_GetAll" resultClass="DataObject">
      select *
      from TT_NOITRU_TOATHUOC
      order by TOATHUOC_ID
    </statement>
    <statement id="DAO00063_CapNhatTrangThaiThuoc" resultClass="DataObject">
      update TT_NOITRU_TOATHUOC
      set TRANGTHAI = #TRANGTHAI#,
      NGUOICAPNHAT_ID = #NGUOICAPNHAT_ID#,
      NGAYCAPNHAT = #NGAYCAPNHAT#
      where TOATHUOC_ID = '$TOATHUOC_ID$'
    </statement>
    <statement id="DAO00063_GetList" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select *
      from TT_NOITRU_TOATHUOC
      <dynamic prepend="where">
        <isParameterPresent>
          <isNotEmpty prepend="and" property="TOATHUOC_ID">
            TOATHUOC_ID = '$TOATHUOC_ID$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="SOTHUTUTOA">
            SOTHUTUTOA = '$SOTHUTUTOA$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="KHAMBENH_ID">
            KHAMBENH_ID = '$KHAMBENH_ID$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="TIEPNHAN_ID">
            TIEPNHAN_ID = '$TIEPNHAN_ID$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="BENHNHAN_ID">
            BENHNHAN_ID = '$BENHNHAN_ID$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="DUOC_ID">
            DUOC_ID = '$DUOC_ID$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="SOLUONG">
            SOLUONG = '$SOLUONG$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="SONGAY">
            SONGAY = '$SONGAY$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="SOLANTRENNGAY">
            SOLANTRENNGAY = '$SOLANTRENNGAY$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="SOLUONGTRENLAN">
            SOLUONGTRENLAN = '$SOLUONGTRENLAN$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="SOLUONG_BUOISANG">
            SOLUONG_BUOISANG = '$SOLUONG_BUOISANG$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="SOLUONG_BUOITRUA">
            SOLUONG_BUOITRUA = '$SOLUONG_BUOITRUA$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="SOLUONG_BUOICHIEU">
            SOLUONG_BUOICHIEU = '$SOLUONG_BUOICHIEU$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="SOLUONG_BUOITOI">
            SOLUONG_BUOITOI = '$SOLUONG_BUOITOI$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="DUONGDUNG_ID">
            DUONGDUNG_ID = '$DUONGDUNG_ID$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="GHICHU">
            GHICHU = '$GHICHU$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="NGUONDUOC_ID">
            NGUONDUOC_ID = '$NGUONDUOC_ID$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="PHIEULINH_ID">
            PHIEULINH_ID = '$PHIEULINH_ID$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="CHUNGTU_ID">
            CHUNGTU_ID = '$CHUNGTU_ID$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="NGUONLAYTHUOC">
            NGUONLAYTHUOC = '$NGUONLAYTHUOC$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="COSO">
            COSO = '$COSO$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="KHOPHAT_ID">
            KHOPHAT_ID = '$KHOPHAT_ID$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="PHATTHUOCTAIQUAY">
            PHATTHUOCTAIQUAY = '$PHATTHUOCTAIQUAY$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="MUANGOAI">
            MUANGOAI = '$MUANGOAI$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="TINHTIEN">
            TINHTIEN = '$TINHTIEN$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="MIENPHI">
            MIENPHI = '$MIENPHI$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="BHYTDONGTIEN">
            BHYTDONGTIEN = '$BHYTDONGTIEN$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="KHONGTHUTIEN">
            KHONGTHUTIEN = '$KHONGTHUTIEN$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="TRANGTHAI">
            TRANGTHAI = '$TRANGTHAI$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="HUYTOATHUOC">
            HUYTOATHUOC = '$HUYTOATHUOC$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="BENHVIEN_ID">
            BENHVIEN_ID = '$BENHVIEN_ID$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="NGAYTAO">
            NGAYTAO = '$NGAYTAO$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="NGUOITAO_ID">
            NGUOITAO_ID = '$NGUOITAO_ID$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="NGAYCAPNHAT">
            NGAYCAPNHAT = '$NGAYCAPNHAT$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="NGUOICAPNHAT_ID">
            NGUOICAPNHAT_ID = '$NGUOICAPNHAT_ID$'
          </isNotEmpty>
        </isParameterPresent>
      </dynamic>
      order by TOATHUOC_ID
    </statement>
    <statement id="DAO00063_GetDetail" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select *
      from TT_NOITRU_TOATHUOC
      where TOATHUOC_ID  = '$value$'
      order by TOATHUOC_ID
    </statement>
    <statement id="DAO00063_GetDetailP" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select *
      from TT_NOITRU_TOATHUOC
      where TOATHUOC_ID  = '$TOATHUOC_ID$'
      order by TOATHUOC_ID
    </statement>
    <insert id="DAO00063_Add" parameterClass="System.Collections.IDictionary" resultClass="System.Int64">
      insert into TT_NOITRU_TOATHUOC (
      SOTHUTUTOA
      , KHAMBENH_ID
      , TIEPNHAN_ID
      , BENHNHAN_ID
      , DUOC_ID
      , SOLUONG
      , SONGAY
      , SOLANTRENNGAY
      , SOLUONGTRENLAN
      , SOLUONG_BUOISANG
      , SOLUONG_BUOITRUA
      , SOLUONG_BUOICHIEU
      , SOLUONG_BUOITOI
      , DUONGDUNG_ID
      , GHICHU
      , NGUONDUOC_ID
      , PHIEULINH_ID
      , CHUNGTU_ID
      , PHONGBANRATOA_ID
      , NGUONLAYTHUOC
      , COSO
      , KHOPHAT_ID
      , KHOTAO_ID
      , PHATTHUOCTAIQUAY
      , MUANGOAI
      , TINHTIEN
      , MIENPHI
      , BHYTDONGTIEN
      , KHONGTHUTIEN
      , TRANGTHAI
      , HUYTOATHUOC
      , BENHVIEN_ID
      , NGAYTAO
      , NGUOITAO_ID
      , NGAYCAPNHAT
      , NGUOICAPNHAT_ID
      <isNotEmpty prepend="," property="PHAMVI_ID">
        PHAMVI_ID
      </isNotEmpty>   
      ) values (
      #SOTHUTUTOA#
      , #KHAMBENH_ID#
      , #TIEPNHAN_ID#
      , #BENHNHAN_ID#
      , #DUOC_ID#
      , #SOLUONG#
      , #SONGAY#
      , #SOLANTRENNGAY#
      , #SOLUONGTRENLAN#
      , #SOLUONG_BUOISANG#
      , #SOLUONG_BUOITRUA#
      , #SOLUONG_BUOICHIEU#
      , #SOLUONG_BUOITOI#
      , #DUONGDUNG_ID#
      , #GHICHU#
      , #NGUONDUOC_ID#
      , #PHIEULINH_ID#
      , #CHUNGTU_ID#
      , #PHONGBANRATOA_ID#
      , #NGUONLAYTHUOC#
      , #COSO#
      , #KHOPHAT_ID#
      , #KHOTAO_ID#
      , #PHATTHUOCTAIQUAY#
      , #MUANGOAI#
      , #TINHTIEN#
      , #MIENPHI#
      , #BHYTDONGTIEN#
      , #KHONGTHUTIEN#
      , #TRANGTHAI#
      , #HUYTOATHUOC#
      , #BENHVIEN_ID#
      , #NGAYTAO#
      , #NGUOITAO_ID#
      , #NGAYCAPNHAT#
      , #NGUOICAPNHAT_ID#
      <isNotEmpty prepend="," property="PHAMVI_ID">
        #PHAMVI_ID#
      </isNotEmpty>     
      )
      <selectKey resultClass="System.Int64" type="post" >
        SELECT @@IDENTITY as value
      </selectKey>
    </insert>

    <update id="DAO00063_Update" parameterClass="System.Collections.IDictionary">
      update TT_NOITRU_TOATHUOC set
      KHAMBENH_ID = #KHAMBENH_ID#
      , TIEPNHAN_ID = #TIEPNHAN_ID#
      , BENHNHAN_ID = #BENHNHAN_ID#
      , DUOC_ID = #DUOC_ID#
      , SOLUONG = #SOLUONG#
      , SONGAY = #SONGAY#
      , SOLANTRENNGAY = #SOLANTRENNGAY#
      , SOLUONGTRENLAN = #SOLUONGTRENLAN#
      , SOLUONG_BUOISANG = #SOLUONG_BUOISANG#
      , SOLUONG_BUOITRUA = #SOLUONG_BUOITRUA#
      , SOLUONG_BUOICHIEU = #SOLUONG_BUOICHIEU#
      , SOLUONG_BUOITOI = #SOLUONG_BUOITOI#
      , DUONGDUNG_ID = #DUONGDUNG_ID#
      , GHICHU = #GHICHU#
      , NGUONDUOC_ID = #NGUONDUOC_ID#
      , PHIEULINH_ID = #PHIEULINH_ID#
      , CHUNGTU_ID = #CHUNGTU_ID#
      , PHONGBANRATOA_ID = #PHONGBANRATOA_ID#
      , NGUONLAYTHUOC = #NGUONLAYTHUOC#
      , COSO = #COSO#
      , KHOPHAT_ID = #KHOPHAT_ID#
      , PHATTHUOCTAIQUAY = #PHATTHUOCTAIQUAY#
      , MUANGOAI = #MUANGOAI#
      , TINHTIEN = #TINHTIEN#
      , MIENPHI = #MIENPHI#
      , BHYTDONGTIEN = #BHYTDONGTIEN#
      , KHONGTHUTIEN = #KHONGTHUTIEN#
      , TRANGTHAI = #TRANGTHAI#
      , HUYTOATHUOC = #HUYTOATHUOC#
      , BENHVIEN_ID = #BENHVIEN_ID#
      , NGAYCAPNHAT = #NGAYCAPNHAT#
      , NGUOICAPNHAT_ID = #NGUOICAPNHAT_ID#
      <isNotEmpty prepend="," property="PHAMVI_ID">
        PHAMVI_ID = #PHAMVI_ID#
      </isNotEmpty>     
      where
      TOATHUOC_ID = '$TOATHUOC_ID$'
    </update>

    <statement id="DAO00063_Delete" parameterClass="System.Collections.IDictionary" resultClass="System.Int32">
      delete from TT_NOITRU_TOATHUOC
      where
      TOATHUOC_ID = '$TOATHUOC_ID$'
    </statement>
    <statement id="DAO00063_KiemTraYLenhDaPhatSinhPhieuHoanTra" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      Select *
      from TT_NOITRU_TRATHUOC
      where
      KHAMBENH_ID = '$KHAMBENH_ID$'
    </statement>
    <statement id="DAO00063_DeleteToaThuocByKhamBenhID" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      delete from TT_NOITRU_TOATHUOC
      where
      KHAMBENH_ID = '$KHAMBENH_ID$'
    </statement>
    <statement id="DAO00063_GetListToaThuocByKhamBenhID" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      Select TOATHUOC_ID, DUOC_ID, KHOPHAT_ID, SOLUONG, KHAMBENH_ID, BENHVIEN_ID, NGUONDUOC_ID, PHAMVI_ID
      from TT_NOITRU_TOATHUOC
      where
      KHAMBENH_ID = '$KHAMBENH_ID$'
    </statement>

    <statement id="DAO00063_DeleteP" parameterClass="System.Collections.IDictionary" resultClass="System.Int32">
      delete from TT_NOITRU_TOATHUOC
      <dynamic prepend="where">
        <isParameterPresent>
          <isNotEmpty prepend="and" property="TOATHUOC_ID">
            TOATHUOC_ID = '$TOATHUOC_ID$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="SOTHUTUTOA">
            SOTHUTUTOA = '$SOTHUTUTOA$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="KHAMBENH_ID">
            KHAMBENH_ID = '$KHAMBENH_ID$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="TIEPNHAN_ID">
            TIEPNHAN_ID = '$TIEPNHAN_ID$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="BENHNHAN_ID">
            BENHNHAN_ID = '$BENHNHAN_ID$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="DUOC_ID">
            DUOC_ID = '$DUOC_ID$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="SOLUONG">
            SOLUONG = '$SOLUONG$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="SONGAY">
            SONGAY = '$SONGAY$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="SOLANTRENNGAY">
            SOLANTRENNGAY = '$SOLANTRENNGAY$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="SOLUONGTRENLAN">
            SOLUONGTRENLAN = '$SOLUONGTRENLAN$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="SOLUONG_BUOISANG">
            SOLUONG_BUOISANG = '$SOLUONG_BUOISANG$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="SOLUONG_BUOITRUA">
            SOLUONG_BUOITRUA = '$SOLUONG_BUOITRUA$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="SOLUONG_BUOICHIEU">
            SOLUONG_BUOICHIEU = '$SOLUONG_BUOICHIEU$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="SOLUONG_BUOITOI">
            SOLUONG_BUOITOI = '$SOLUONG_BUOITOI$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="DUONGDUNG_ID">
            DUONGDUNG_ID = '$DUONGDUNG_ID$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="GHICHU">
            GHICHU = '$GHICHU$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="NGUONDUOC_ID">
            NGUONDUOC_ID = '$NGUONDUOC_ID$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="PHIEULINH_ID">
            PHIEULINH_ID = '$PHIEULINH_ID$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="CHUNGTU_ID">
            CHUNGTU_ID = '$CHUNGTU_ID$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="NGUONLAYTHUOC">
            NGUONLAYTHUOC = '$NGUONLAYTHUOC$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="COSO">
            COSO = '$COSO$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="KHOPHAT_ID">
            KHOPHAT_ID = '$KHOPHAT_ID$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="PHATTHUOCTAIQUAY">
            PHATTHUOCTAIQUAY = '$PHATTHUOCTAIQUAY$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="MUANGOAI">
            MUANGOAI = '$MUANGOAI$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="TINHTIEN">
            TINHTIEN = '$TINHTIEN$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="MIENPHI">
            MIENPHI = '$MIENPHI$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="BHYTDONGTIEN">
            BHYTDONGTIEN = '$BHYTDONGTIEN$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="KHONGTHUTIEN">
            KHONGTHUTIEN = '$KHONGTHUTIEN$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="TRANGTHAI">
            TRANGTHAI = '$TRANGTHAI$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="HUYTOATHUOC">
            HUYTOATHUOC = '$HUYTOATHUOC$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="BENHVIEN_ID">
            BENHVIEN_ID = '$BENHVIEN_ID$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="NGAYTAO">
            NGAYTAO = '$NGAYTAO$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="NGUOITAO_ID">
            NGUOITAO_ID = '$NGUOITAO_ID$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="NGAYCAPNHAT">
            NGAYCAPNHAT = '$NGAYCAPNHAT$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="NGUOICAPNHAT_ID">
            NGUOICAPNHAT_ID = '$NGUOICAPNHAT_ID$'
          </isNotEmpty>
        </isParameterPresent>
      </dynamic>
    </statement>

    <statement id="DAO00063_GetBookingInfo" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select *
      from TT_DUOC_TONKHO_BOOK_NOITRU
      where DUOC_ID = '$DUOC_ID$'
      and NGUONHANG_ID = '$NGUONHANG_ID$'
      and REF_ID = '$TOATHUOC_ID$'
      and REF_TABLE = '$REF_TABLE$'
      
      <isNotEmpty prepend="and" property="PHAMVI_ID">
        PHAMVI_ID = #PHAMVI_ID#
      </isNotEmpty>
    </statement>
    <statement id="DAO00063_KiemtraSoluongDuocXuat" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select A.TONKHO, isnull(B.BOOK_NGOAI,0) BOOK_NGOAI, isnull(D.BOOK_NOI,0) BOOK_NOI, isnull(C.BOOK_NOI_THUOC,0) BOOK_NOI_THUOC, (A.TONKHO - isnull(B.BOOK_NGOAI,0) - isnull(D.BOOK_NOI,0)) TONKHO_BOOK
      from(
      select SUM(tk.SOLUONG) TONKHO, tk.DUOC_ID, sd.PHAMVI_ID, tk.NGUONDUOC_ID from TT_DUOC_TONKHO tk
      inner join TM_DUOC_PHAMVISD_MAPPING sd on sd.KHODUOC_ID = tk.KHODUOC_ID
      where sd.PHAMVI_ID  = '$PHAMVI_ID$' and tk.DUOC_ID = '$DUOC_ID$' and tk.NGUONDUOC_ID = '$NGUONHANG_ID$'
      group by tk.DUOC_ID, sd.PHAMVI_ID, tk.NGUONDUOC_ID) A
      left join (
      select SUM(SOLUONG) BOOK_NGOAI,DUOC_ID, PHAMVI_ID, NGUONHANG_ID from TT_DUOC_TONKHO_BOOK_NGOAITRU
      where PHAMVI_ID  = '$PHAMVI_ID$' and DUOC_ID = '$DUOC_ID$' and NGUONHANG_ID = '$NGUONHANG_ID$' and TRANGTHAI = 'HIEULUC'
      group by DUOC_ID, PHAMVI_ID, NGUONHANG_ID) B on A.DUOC_ID = B.DUOC_ID and A.PHAMVI_ID = B.PHAMVI_ID and A.NGUONDUOC_ID = B.NGUONHANG_ID
      left join (
      select SUM(SOLUONG) BOOK_NOI_THUOC,DUOC_ID, PHAMVI_ID, NGUONHANG_ID from TT_DUOC_TONKHO_BOOK_NOITRU
      where PHAMVI_ID  = '$PHAMVI_ID$' and DUOC_ID = '$DUOC_ID$' and NGUONHANG_ID = '$NGUONHANG_ID$' and REF_ID = '$TOATHUOC_ID$' and REF_TABLE = '$REF_TABLE$' and TRANGTHAI = 'HIEULUC'
      group by DUOC_ID, PHAMVI_ID, NGUONHANG_ID) C on A.DUOC_ID = C.DUOC_ID and A.PHAMVI_ID = C.PHAMVI_ID and A.NGUONDUOC_ID = C.NGUONHANG_ID
      left join (
      select SUM(SOLUONG) BOOK_NOI,DUOC_ID, PHAMVI_ID, NGUONHANG_ID from TT_DUOC_TONKHO_BOOK_NOITRU
      where PHAMVI_ID  = '$PHAMVI_ID$' and DUOC_ID = '$DUOC_ID$' and NGUONHANG_ID = '$NGUONHANG_ID$' and TRANGTHAI = 'HIEULUC'
      group by DUOC_ID, PHAMVI_ID, NGUONHANG_ID) D on A.DUOC_ID = D.DUOC_ID and A.PHAMVI_ID = D.PHAMVI_ID and A.NGUONDUOC_ID = D.NGUONHANG_ID
    </statement>
    <statement id="DAO00063_KiemtraSoluongDuocXuatNgoaitru" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select A.TONKHO, isnull(B.BOOK_NGOAI,0) BOOK_NGOAI, isnull(D.BOOK_NOI,0) BOOK_NOI,  (A.TONKHO - isnull(B.BOOK_NGOAI,0) - isnull(D.BOOK_NOI,0)) TONKHO_BOOK
      from(
      select SUM(tk.SOLUONG) TONKHO, tk.DUOC_ID, sd.PHAMVI_ID, tk.NGUONDUOC_ID from TT_DUOC_TONKHO tk
      inner join TM_DUOC_PHAMVISD_MAPPING sd on sd.KHODUOC_ID = tk.KHODUOC_ID
      where sd.PHAMVI_ID  = '$PHAMVI_ID$' and tk.DUOC_ID = '$DUOC_ID$' and tk.NGUONDUOC_ID = '$NGUONHANG_ID$'
      group by tk.DUOC_ID, sd.PHAMVI_ID, tk.NGUONDUOC_ID) A
      left join (
      select SUM(SOLUONG) BOOK_NGOAI,DUOC_ID, PHAMVI_ID, NGUONHANG_ID from TT_DUOC_TONKHO_BOOK_NGOAITRU
      where PHAMVI_ID  = '$PHAMVI_ID$' and DUOC_ID = '$DUOC_ID$' and NGUONHANG_ID = '$NGUONHANG_ID$' and TRANGTHAI = 'HIEULUC'
      group by DUOC_ID, PHAMVI_ID, NGUONHANG_ID) B on A.DUOC_ID = B.DUOC_ID and A.PHAMVI_ID = B.PHAMVI_ID and A.NGUONDUOC_ID = B.NGUONHANG_ID
      left join (
      select SUM(SOLUONG) BOOK_NOI,DUOC_ID, PHAMVI_ID, NGUONHANG_ID from TT_DUOC_TONKHO_BOOK_NOITRU
      where PHAMVI_ID  = '$PHAMVI_ID$' and DUOC_ID = '$DUOC_ID$' and NGUONHANG_ID = '$NGUONHANG_ID$' and TRANGTHAI = 'HIEULUC'
      group by DUOC_ID, PHAMVI_ID, NGUONHANG_ID) D on A.DUOC_ID = D.DUOC_ID and A.PHAMVI_ID = D.PHAMVI_ID and A.NGUONDUOC_ID = D.NGUONHANG_ID
    </statement>
    <insert id="DAO00063_Add_Booking" parameterClass="HashTable" resultClass="System.Int64">
      insert into TT_DUOC_TONKHO_BOOK_NOITRU (
      REF_TABLE
      , REF_ID
      , KHODUOC_ID
      , DUOC_ID
      , CHUYENKHOA_ID
      , NGUONHANG_ID
      , BENHVIEN_ID
      , SOLUONG
      , NGAYHIEULUC
      , NGAYTAO
      , NGUOITAO_ID
      , NGAYCAPNHAT
      , NGUOICAPNHAT_ID
      <isNotEmpty prepend="," property="PHAMVI_ID">
        PHAMVI_ID
      </isNotEmpty>     
      ) values (
      #REF_TABLE#
      , #TOATHUOC_ID#
      <!--, #SOTHUTUTOA#-->
      , #KHODUOC_ID#
      , #DUOC_ID#
      , #CHUYENKHOA_ID#
      , #NGUONHANG_ID#
      , #BENHVIEN_ID#
      , #SOLUONG#
      , #NGAYHIEULUC#
      , #NGAYTAO#
      , #NGUOITAO_ID#
      , #NGAYCAPNHAT#
      , #NGUOICAPNHAT_ID#
      <isNotEmpty prepend="," property="PHAMVI_ID">
        #PHAMVI_ID#
      </isNotEmpty>    
      )
    </insert>

    <update id="DAO00063_Update_Booking" parameterClass="HashTable" resultClass="System.Int64">
      update TT_DUOC_TONKHO_BOOK_NOITRU set
      SOLUONG = #SOLUONG#,
      DUOC_ID = #DUOC_ID#,
      NGAYHIEULUC = #NGAYHIEULUC#,
      NGUOICAPNHAT_ID = #NGUOICAPNHAT_ID#,
      NGAYCAPNHAT = #NGAYCAPNHAT#
      <isNotEmpty prepend="," property="PHAMVI_ID">
        PHAMVI_ID = #PHAMVI_ID#
      </isNotEmpty>
      <isNotEmpty prepend="," property="KHODUOC_ID">
        KHODUOC_ID = #KHODUOC_ID#
      </isNotEmpty>
      where
      BOOKING_ID = '$BOOKING_ID$'
    </update>

    <delete id="DAO00063_Delete_Booking" parameterClass="HashTable">
      delete from TT_DUOC_TONKHO_BOOK_NOITRU
      where REF_ID = #TOATHUOC_ID#
      and REF_TABLE = #REF_TABLE#
      and DUOC_ID = #DUOC_ID#
      and BENHVIEN_ID = #BENHVIEN_ID#
      <isNotEmpty prepend="and" property="PHAMVI_ID">
          PHAMVI_ID = #PHAMVI_ID#
        </isNotEmpty>
    </delete>

    <update id="DAO00063_UpdateBookingInfo" parameterClass="HashTable">
      update TT_DUOC_TONKHO_BOOK_NOITRU set
      SOLUONG = #SOLUONG#
      where
      KHODUOC_ID = '$KHODUOC_ID$'
      and DUOC_ID = '$DUOC_ID$'
      and BENHVIEN_ID = '$BENHVIEN_ID$'
      and NGAYHIEULUC = '$NGAYHIEULUC$'
      <isNotEmpty prepend="and" property="PHAMVI_ID">
      PHAMVI_ID = #PHAMVI_ID#
    </isNotEmpty>
    </update>

    <statement id="DAO00063_GetSLDuocDaLuu" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select sum(SOLUONG) as SOLUONG
      from TT_NOITRU_TOATHUOC
      where KHAMBENH_ID  = '$KHAMBENH_ID$'
      and DUOC_ID  = '$DUOC_ID$'
    </statement>

    <statement id="DAO00063_GetTrangThaiThuoc" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select CHUNGTU_ID, PHIEULINH_ID, HUYTOATHUOC, NGUOITAO_ID
      from TT_NOITRU_TOATHUOC
      where TOATHUOC_ID  = '$TOATHUOC_ID$'
    </statement>

    <statement id="DAO00063_DeleteThuocInList" parameterClass="HashTable" resultClass="DataObject">
      <!--select DUOC_ID, KHOPHAT_ID, SOLUONG, KHAMBENH_ID, BENHVIEN_ID
      from TT_NOITRU_TOATHUOC
      where KHAMBENH_ID = #KHAMBENH_ID#
      <dynamic prepend=" and TOATHUOC_ID in ">
        <iterate open="(" close=")" conjunction=",  " property="LSTTOATHUOC_ID">#LSTTOATHUOC_ID[]#</iterate>
      </dynamic>-->

      delete from TT_NOITRU_TOATHUOC
      where KHAMBENH_ID = #KHAMBENH_ID#
      <dynamic prepend=" and TOATHUOC_ID in ">
        <iterate open="(" close=")" conjunction=",  " property="LSTTOATHUOC_ID">#LSTTOATHUOC_ID[]#</iterate>
      </dynamic>
    </statement>

    <statement id="DAO00063_DeleteBookingInList" parameterClass="HashTable" resultClass="DataObject">
      delete from TT_DUOC_TONKHO_BOOK_NOITRU
      where REF_TABLE = #REF_TABLE#
      <dynamic prepend=" and REF_ID in ">
        <iterate open="(" close=")" conjunction=",  " property="LSTTOATHUOC_ID">#LSTTOATHUOC_ID[]#</iterate>
      </dynamic>
    </statement>
    <statement id="DAO00063_GetListDuocTonKho_Book_NoiTru" parameterClass="HashTable" resultClass="DataObject">
      select * from TT_DUOC_TONKHO_BOOK_NOITRU
      where REF_TABLE = #REF_TABLE#
      <dynamic prepend=" and REF_ID in ">
        <iterate open="(" close=")" conjunction=",  " property="LSTTOATHUOC_ID">#LSTTOATHUOC_ID[]#</iterate>
      </dynamic>
    </statement>
    <statement id="DAO00063_GetToaThuocByKhamBenhID" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select a.*, b.SOLUONG as SOLUONGTAMNGUNG,
      vp.DONGIA_DOANHTHU, vp.THANHTIEN_DOANHTHU, vp.BHYT_DONGIA, vp.BHYT_THANHTIEN, vp.BHYT_DONGIA_CHITRA, vp.BHYT_THANHTIEN_CHITRA
      from TT_NOITRU_TOATHUOC a
      left join TT_NOITRU_TRATHUOC_CHITIET b on a.TOATHUOC_ID = b.TOATHUOC_ID
      inner join TT_VIENPHI vp on vp.REF_ID = a.TOATHUOC_ID and vp.REF_TABLE = 'TT_NOITRU_TOATHUOC' and vp.DUOC_ID = a.DUOC_ID
      where a.KHAMBENH_ID  = '$KHAMBENH_ID$'
    </statement>

    <statement id="DAO00063_GetSoPhieuLinhByPhieuLinhID" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select MACHUNGTU as SOPHIEULINH
      from TT_DUOC_PHIEULINH
      where CHUNGTU_ID  = '$PHIEULINH_ID$'
    </statement>

    <statement id="DAO00063_GetSoChungTuByChungTuID" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select MACHUNGTU as SOCHUNGTU
      from TT_DUOC_CHUNGTU
      where CHUNGTU_ID  = '$CHUNGTU_ID$'
    </statement>

    <statement id="DAO00063_GetTThaiNhapNoiBo" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select * from TT_DUOC_CHUNGTU where CHUNGTU_ID in
      (select CHUNGTU_ID from TT_DUOC_CHUNGTU_CHITIET where TOATHUOCNOITRU_ID = '$TOATHUOC_ID$')
      <!--and LOAICHUNGTU = 'N'-->
      and BENHVIEN_ID = '$BENHVIEN_ID$'
    </statement>

    <statement id="DAO00063_GetDSThuocByBenhNhanID" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select DUOC_ID, SOLUONG, NGAYTAO, SONGAY from TT_NOITRU_TOATHUOC
      where KHAMBENH_ID in (select KHAMBENH_ID from TT_NOITRU_KHAMBENH
      where TIEPNHAN_ID in (select TIEPNHAN_ID from TT_TIEPNHAN where BENHNHAN_ID = '$BENHNHAN_ID$'))
      and BENHVIEN_ID = '$BENHVIEN_ID$'

      <isNotEmpty prepend="and" property="TUNGAY">
        convert(date, NGAYTAO) &#62;&#61; convert(date, '$TUNGAY$')
      </isNotEmpty>
      <isNotEmpty prepend="and" property="DENNGAY">
        convert(date, NGAYTAO) &#60;&#61; convert(date, '$DENNGAY$')
      </isNotEmpty>
      <!--order by NGAYTAO-->

      union

      select DUOC_ID, SOLUONG, NGAYTAO, SONGAY from TT_NGOAITRU_TOATHUOC
      where KHAMBENH_ID in (select KHAMBENH_ID from TT_NGOAITRU_KHAMBENH
      where TIEPNHAN_ID in (select TIEPNHAN_ID from TT_TIEPNHAN where BENHNHAN_ID = '$BENHNHAN_ID$'))
      and BENHVIEN_ID = '$BENHVIEN_ID$'

      <isNotEmpty prepend="and" property="TUNGAY">
        convert(date, NGAYTAO) &#62;&#61; convert(date, '$TUNGAY$')
      </isNotEmpty>
      <isNotEmpty prepend="and" property="DENNGAY">
        convert(date, NGAYTAO) &#60;&#61; convert(date, '$DENNGAY$')
      </isNotEmpty>
      order by NGAYTAO

    </statement>
    <statement id="DAO00063_GetListKhoThuocPhongBanPhamvi" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select distinct dpv.*
      from TM_DUOC_PHAMVISD_MAPPING dmap
      left join TM_DUOC_PHAMVISUDUNG dpv on dpv.PHAMVI_ID = dmap.PHAMVI_ID
      where dmap.KHODUOC_ID in (select KHODUOC_ID from TM_PHONGBAN_KHODUOC where PHONGBAN_ID = '$PHONGBAN_ID$')
    </statement>
    <statement id="DAO00063_GetListPhamviTuKhoThuocVaPhongBan" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select distinct dpv.*, dmap.KHODUOC_ID
      from TM_DUOC_PHAMVISD_MAPPING dmap
      left join TM_DUOC_PHAMVISUDUNG dpv on dpv.PHAMVI_ID = dmap.PHAMVI_ID
      where dmap.KHODUOC_ID in (select KHODUOC_ID from TM_PHONGBAN_KHODUOC where PHONGBAN_ID = '$PHONGBAN_ID$')
      and dmap.KHODUOC_ID = '$KHODUOC_ID$'
    </statement>
    <statement id="DAO00063_GetKhoduocUuTienTuPhamvi" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select top 1 dmap.*
      from TM_DUOC_PHAMVISD_MAPPING dmap
      where dmap.PHAMVI_ID = '$PHAMVI_ID$'
    </statement>
  </statements>
</sqlMap>
