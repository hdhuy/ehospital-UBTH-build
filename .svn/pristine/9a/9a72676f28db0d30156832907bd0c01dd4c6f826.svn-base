<?xml version="1.0" encoding="utf-8" ?>
<!--============================================================================
//	CAUTION: This file is generated by IBatisNetGen.3.SQLMap.cst at 11/11/2015 9:27:48 AM
//				Any manual editing will be lost in re-generation.
//===========================================================================-->
<sqlMap namespace="eHospital" xmlns="http://ibatis.apache.org/mapping" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" >
<statements>
<!--get-->
 <statement id="DAO00113_GetList" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
   SELECT GOI_ID,MAGOI,TENGOI,GIATRIGOI 
   FROM TM_CSKH_GOI GOI
   WHERE GOI.TRANGTHAI='GOIDUOCPHEPBAN' AND GOI.BENHVIEN_ID='$BENHVIEN_ID$'
 </statement>
<statement id="DAO00113_TT_TUVANGOI_Get" resultClass="DataObject">
  SELECT TV.[TUVAN_ID]
  ,TV.[MATUVAN]
  ,TV.[BENHNHAN_ID]
  ,TV.[BENHVIEN_ID]
  ,TV.[NGAYTAO]
  ,TV.[NGUOITAO_ID]
  ,TV.[NGAYCAPNHAT]
  ,TV.[NGUOICAPNHAT_ID]
  ,TV.[NGUOITHUCHIEN_ID]
  ,TV.[THOIGIANTHUCHIEN]
  ,TV.[BAOHIEM]
  ,TV.[NGAYNHAPVIEN]
  ,TV.[NGAYPHAUTHUAT]
  ,TV.[BACSIDIEUTRI_ID]
  ,TV.[HOTENNGUOITHAN]
  ,TV.[SODIENTHOAI] as SDT
  ,BN.MAYTE
  FROM [TT_CSKH_TUVAN] TV
  INNER JOIN TT_BENHNHAN BN ON TV.BENHNHAN_ID=BN.BENHNHAN_ID
  <dynamic prepend="where">
      <isParameterPresent>
        <isNotEmpty prepend="and" property="TUVANGOI_ID">
          TV.TUVAN_ID = '$TUVANGOI_ID$'
        </isNotEmpty>
          <isNotEmpty prepend="and" property="BENHVIEN_ID">
          TV.BENHVIEN_ID = '$BENHVIEN_ID$'
        </isNotEmpty>
      </isParameterPresent>
    </dynamic>
  </statement>
    
    <statement id="DAO00113_TT_TUVANGOI_GetList_Goi" resultClass="DataObject">
      SELECT
      ROW_NUMBER()OVER (ORDER BY CT.[TUVAN_CHITIET_ID]) STT
      ,CT.[TUVAN_CHITIET_ID]
      ,CT.[TUVAN_ID]
      ,CT.[REF_CATEGORY]
      ,CT.[REF_ID] GOI_ID
      ,CT.[LOAIGIA_ID]
      ,CT.[DONGIABAN] GIATRIGOI
      ,CT.[SOLUONG] SOLUONGGOI
      ,CT.[THANHTIEN]
      ,CT.[BENHVIEN_ID]
      ,CT.[NGAYTAO]
      ,CT.[NGUOITAO_ID]
      ,CT.[NGAYCAPNHAT]
      ,CT.[NGUOICAPNHAT_ID]
      ,GOI.TENGOI
      ,GOI.MAGOI
      FROM [TT_CSKH_TUVAN_CHITIET] CT
      INNER JOIN TM_CSKH_GOI GOI ON CT.REF_ID= GOI.GOI_ID
      WHERE CT.TUVAN_ID='$TUVANGOI_ID$'  and CT.REF_CATEGORY='TM_CSKH_GOI' and GOI.BENHVIEN_ID='$BENHVIEN_ID$'
    </statement>
  <statement id="DAO00113_TT_TUVANGOI_GetList_DichVu" resultClass="DataObject">
    SELECT ROW_NUMBER()OVER (ORDER BY CT.[TUVAN_CHITIET_ID]) STT
    ,CT.[TUVAN_CHITIET_ID]
    ,CT.[TUVAN_ID]
    ,CT.[REF_CATEGORY]
    ,CT.[REF_ID] DICHVU_ID
    ,CT.[LOAIGIA_ID]
    ,CT.[DONGIABAN] DONGIA
    ,CT.[SOLUONG] SOLUONGDV
    ,CT.[THANHTIEN]
    ,CT.[BENHVIEN_ID]
    ,CT.[NGAYTAO]
    ,CT.[NGUOITAO_ID]
    ,CT.[NGAYCAPNHAT]
    ,CT.[NGUOICAPNHAT_ID]
    ,DV.MADICHVU
    ,DV.TENDICHVU
    FROM [TT_CSKH_TUVAN_CHITIET] CT
    INNER JOIN TM_DICHVU dv ON CT.REF_ID= dv.DICHVU_ID
    WHERE CT.TUVAN_ID='$TUVANGOI_ID$' and dv.BENHVIEN_ID='$BENHVIEN_ID$' and CT.REF_CATEGORY='TM_DICHVU'
  </statement>
  <statement id="DAO00113_TT_TUVANGOI_GetList_Duoc" resultClass="DataObject">
    SELECT
    ROW_NUMBER()OVER (ORDER BY CT.[TUVAN_CHITIET_ID]) STT
    ,CT.[TUVAN_CHITIET_ID]
    ,CT.[TUVAN_ID]
    ,CT.[REF_CATEGORY]
    ,CT.[REF_ID] DUOC_ID
    ,CT.[LOAIGIA_ID]
    ,CT.[DONGIABAN] DONGIADUOC
    ,CT.[SOLUONG] SOLUONGDUOC
    ,CT.[THANHTIEN]
    ,CT.[BENHVIEN_ID]
    ,CT.[NGAYTAO]
    ,CT.[NGUOITAO_ID]
    ,CT.[NGAYCAPNHAT]
    ,CT.[NGUOICAPNHAT_ID]
    ,d.TENDUOCDAYDU TENDUOC
    FROM [TT_CSKH_TUVAN_CHITIET] CT
    INNER JOIN TM_DUOC d ON CT.REF_ID= d.DUOC_ID
    WHERE CT.TUVAN_ID='$TUVANGOI_ID$' and d.BENHVIEN_ID='$BENHVIEN_ID$'and CT.REF_CATEGORY='TM_DUOC'
  </statement>
    <!--Search-->    
<statement id="DAO00113_TT_TUVANGOI_Search" resultClass="DataObject">
  select TV.*,TV.TUVAN_ID AS TUVANGOI_ID, BN.TENBENHNHAN, BN.MAYTE
  , CASE ISNULL(BN.NGAYSINH,'')
  WHEN '' THEN CONVERT(VARCHAR(10), BN.NAMSINH)
  ELSE CONVERT(VARCHAR(10), BN.NGAYSINH, 103)
  END AS NAMSINH
  , GT.DESCRIPTION AS GIOITINH
  from TT_CSKH_TUVAN TV
  left join TT_BENHNHAN BN on BN.BENHNHAN_ID = TV.BENHNHAN_ID
  left join TM_GENDER GT on GT.ID = BN.GIOITINH
  <dynamic prepend="where">
      <isParameterPresent>
        <isNotEmpty prepend="and" property="TUKHOA">
          (TV.MATUVAN like '%$TUKHOA$%' or BN.TENBENHNHAN like '%$TUKHOA$%')
        </isNotEmpty>
        <isNotEmpty prepend="and" property="TUNGAY">
          convert(date,TV.NGAYTAO) between convert(date, '$TUNGAY$') and convert(date, '$DENNGAY$')
        </isNotEmpty>
      <isNotEmpty prepend="and" property="BENHVIEN_ID">
          TV.BENHVIEN_ID = '$BENHVIEN_ID$'
        </isNotEmpty>
        <isNotEmpty prepend="and" property="MAYTE">
          BN.MAYTE = '$MAYTE$'
        </isNotEmpty>
      </isParameterPresent>
    </dynamic>
  </statement>
    
    <!--add-->
    <statement id="DAO00113_TT_TUVANGOI_Add" parameterClass="HashTable" resultClass="System.Int64">
      INSERT INTO [TT_CSKH_TUVAN]
      ([MATUVAN]
      ,[BENHNHAN_ID]
      ,[BENHVIEN_ID]
      ,[NGAYTAO]
      ,[NGUOITAO_ID]
      ,[NGAYCAPNHAT]
      ,[NGUOICAPNHAT_ID]
      ,[NGUOITHUCHIEN_ID]
      ,[THOIGIANTHUCHIEN]
      ,[BAOHIEM]
      ,[NGAYNHAPVIEN]
      ,[NGAYPHAUTHUAT]
      ,[BACSIDIEUTRI_ID]
      ,[HOTENNGUOITHAN]
      ,[SODIENTHOAI])
      VALUES
      (#MATUVAN#
      ,#BENHNHAN_ID#
      ,#BENHVIEN_ID#
      ,#NGAYTAO#
      ,#NGUOITAO_ID#
      ,#NGAYCAPNHAT#
      ,#NGUOICAPNHAT_ID#
      ,#NGUOITHUCHIEN_ID#
      ,#THOIGIANTHUCHIEN#
      ,#BAOHIEM#
      ,#NGAYNHAPVIEN#
      ,#NGAYPHAUTHUAT#
      ,#BACSIDIEUTRI_ID#
      ,#HOTENNGUOITHAN#
      ,#SODIENTHOAI#)
      select SCOPE_identity() as value
    </statement>
    
    <statement id="DAO00113_TT_TUVANGOI_CHITIET_Add" parameterClass="HashTable" resultClass="System.Int64">
      INSERT INTO  [TT_CSKH_TUVAN_CHITIET]
      ([TUVAN_ID]
      ,[REF_CATEGORY]
      ,[REF_ID]
      ,[LOAIGIA_ID]
      ,[DONGIABAN]
      ,[SOLUONG]
      ,[THANHTIEN]
      ,[BENHVIEN_ID]
      ,[NGAYTAO]
      ,[NGUOITAO_ID]
      ,[NGAYCAPNHAT]
      ,[NGUOICAPNHAT_ID])
      VALUES
      (#TUVAN_ID#
      ,#REF_CATEGORY#
      ,#REF_ID#
      ,#LOAIGIA_ID#
      ,#DONGIABAN#
      ,#SOLUONG#
      ,#THANHTIEN#
      ,#BENHVIEN_ID#
      ,#NGAYTAO#
      ,#NGUOITAO_ID#
      ,#NGAYCAPNHAT#
      ,#NGUOICAPNHAT_ID#)
      select SCOPE_identity() as value
    </statement>
    
    <!--update-->
    
      <update id="DAO00113_TT_TUVANGOI_Update" parameterClass="System.Collections.IDictionary">
        UPDATE  [TT_CSKH_TUVAN]
        SET
        [NGAYCAPNHAT] = #NGAYCAPNHAT#
        ,[NGUOICAPNHAT_ID] = #NGUOICAPNHAT_ID#
        ,[BAOHIEM] = #BAOHIEM#
        ,[NGAYNHAPVIEN] = #NGAYNHAPVIEN#
        ,[NGAYPHAUTHUAT] = #NGAYPHAUTHUAT#
        ,[BACSIDIEUTRI_ID] = #BACSIDIEUTRI_ID#
        ,[HOTENNGUOITHAN] = #HOTENNGUOITHAN#
        ,[SODIENTHOAI] = #SODIENTHOAI#
        WHERE TUVAN_ID=#TUVAN_ID#
      </update>

    <update id="DAO00113_TT_TUVANGOI_CHITIET_Update" parameterClass="System.Collections.IDictionary">
      UPDATE  [TT_CSKH_TUVAN_CHITIET]
      SET
      [REF_ID] = #REF_ID#
      ,[LOAIGIA_ID] = #LOAIGIA_ID#
      ,[DONGIABAN] = #DONGIA#
      ,[SOLUONG] = #SOLUONG#
      ,[THANHTIEN] = #THANHTIEN#
      ,[NGAYCAPNHAT] = #NGAYCAPNHAT#
      ,[NGUOICAPNHAT_ID] = #NGUOICAPNHAT_ID#
      WHERE TUVAN_CHITIET_ID=#TUVAN_CHITIET_ID#
    </update>

    <!--Delete-->
    <statement id="DAO00113_TT_TUVANGOI_Delete" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      DELETE FROM  [TT_CSKH_TUVAN_CHITIET] WHERE TUVAN_ID='$TUVAN_ID$'
      DELETE FROM  [TT_CSKH_TUVAN] WHERE TUVAN_ID='$TUVAN_ID$'
    </statement>
  <!--Delete-->
  <statement id="DAO00113_TT_TUVANGOI_CHITIET_Delete" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
    DELETE FROM  [TT_CSKH_TUVAN_CHITIET] WHERE TUVAN_CHITIET_ID='$TUVAN_CHITIET_ID$'
  </statement>
  <statement id="DAO00113_GetDICHVU_DONGIA" resultClass="DataObject">
    select TOP 1 A.DONGIA
    from TM_DICHVU_DONGIA A
    WHERE A.DICHVU_ID='$DICHVU_ID$' AND A.TAMNGUNG='0' AND A.LOAIGIA_ID='$LOAIGIA_ID$' AND A.BENHVIEN_ID = '$BENHVIEN_ID$'
  </statement>
  <statement id="DAO00113_GetDUOC_DONGIA" resultClass="DataObject">
    select TOP 1 B.DONGIABANVAT_DAUVAO as DONGIA, B.DONGIAVONVAT as DONGIA_KHAC,
    B.DONGIAVON, B.TYLEVAT_DAUVAO AS TYLE_VAT
    from TT_DUOC_CHUNGTU_SOLONHAP A
    inner join TT_DUOC_SOLONHAP_GIABAN B on A.SOLONHAP_ID = B.SOLONHAP_ID
    where A.DUOC_ID = '$DUOC_ID$' AND A.BENHVIEN_ID='$BENHVIEN_ID$'
    order by A.NGAYNHAP DESC
  </statement>
  </statements> 
</sqlMap>