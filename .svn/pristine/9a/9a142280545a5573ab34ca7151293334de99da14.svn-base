<?xml version="1.0" encoding="utf-8" ?>
<sqlMap namespace="eHospital" xmlns="http://ibatis.apache.org/mapping" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
  <statements>
    <statement id="DAO00328_GetList" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      SELECT GOI.GOI_ID, GOI.MAGOI, GOI.TENGOI, GOI.GIATRIGOI
      FROM TM_CSKH_GOI GOI
      INNER JOIN LST_DICTIONARY L ON L.DICTIONARY_ID = GOI.LOAIGOI_ID
      INNER JOIN TT_KSK_HOPDONG_GOIDICHVU HD_G ON HD_G.GOIDICHVU_ID = GOI.GOI_ID
      WHERE GOI.TRANGTHAI='GOIDUOCPHEPBAN' AND L.DICTIONARY_TYPE_CODE = 'LoaiGoiDV' AND L.DICTIONARY_CODE = 'KhamSucKhoe'
      AND HD_G.HOPDONG_ID = '$HOPDONG_ID$'
      <isNotEmpty prepend="and" property="BENHVIEN_ID">
        GOI.BENHVIEN_ID ='$BENHVIEN_ID$'
      </isNotEmpty>
    </statement>
    <statement id="DAO00328_DeletePatientImport" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      delete
      from TT_KSK_HOPDONG_BENHNHAN
      where HOPDONG_BENHNHAN_ID IN (SELECT * FROM DBO.SPLIT('$HOPDONG_BENHNHAN_ID$',', '))
    </statement>
    <statement id="DAO00328_GetKetQuaKSK" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select * from TT_KSK_KETQUA
      where HOPDONG_BENHNHAN_ID  = '$HOPDONG_BENHNHAN_ID$' and KETQUA_ID = '$KETQUA_ID$'
      <dynamic>
        <isParameterPresent>
          <isNotEmpty prepend="and" property="BENHVIEN_ID">
            BENHVIEN_ID = '$BENHVIEN_ID$'
          </isNotEmpty>
        </isParameterPresent>
      </dynamic>
    </statement>
    <statement id="DAO00328_GetPatientId" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select BN.*, KQ.KETQUA_ID
      from TT_KSK_HOPDONG_BENHNHAN BN
      left join TT_KSK_KETQUA KQ on KQ.HOPDONG_BENHNHAN_ID = BN.HOPDONG_BENHNHAN_ID
      <dynamic prepend="where">
        <isParameterPresent>
          <isNotEmpty prepend="and" property="BENHNHAN_ID">
            BN.BENHNHAN_ID = '$BENHNHAN_ID$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="BENHVIEN_ID">
            BN.BENHVIEN_ID = '$BENHVIEN_ID$'
          </isNotEmpty>
        </isParameterPresent>
      </dynamic>
    </statement>
    <update id="DAO00328_UpdateBenhNhanTonTai" parameterClass="System.Collections.IDictionary">
      update TT_KSK_HOPDONG_BENHNHAN 
      set TONTAI = '1' 
      where HOPDONG_BENHNHAN_ID = '$HOPDONG_BENHNHAN_ID$'
    </update>
    <statement id="DAO00328_GetListTiepNhanAll" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select distinct A.SOTIEPNHAN, A.TRAITUYEN, A.NGAYMIENDONGCHITRA, A.TIEPNHAN_ID, A.DOITUONG_ID,
      A.LOAITHANHVIEN_ID, A.SUDUNG_BHTN, A.THE_ID, A.THANHVIEN_ID, A.VIP, A.NGUON_BENHNHAN_ID, A.BAOLANH_VIENPHI,
      B.*, HD.SO_HD + ' - ' + CT.TENCONGTY as TENHOPDONG, G.DESCRIPTION as GENDER, DT.TENDOITUONG, N.DICTIONARY_NAME as NGHENGHIEP
      , case when B.NGAYSINH is null then convert(varchar(4),B.NAMSINH) else convert(varchar(10),B.NGAYSINH,103) end as NGAYTHANGNAMSINH
      from TT_TIEPNHAN A
      inner join TT_BENHNHAN B on B.BENHNHAN_ID = A.BENHNHAN_ID and (A.TRANGTHAI = 'DATIEPNHAN') and B.ACTIVE = '1'
      inner join TT_KSK_HOPDONG_BENHNHAN HD_BN on HD_BN.BENHNHAN_ID = B.BENHNHAN_ID
      inner join TT_KSK_HOPDONG HD on HD.HOPDONG_ID = HD_BN.HOPDONG_ID
      inner join TT_KSK_CONGTY CT on CT.CONGTY_ID = HD.CONGTY_ID
      inner join TM_GENDER G on G.ID = B.GIOITINH
      inner join TM_DOITUONG DT on DT.DOITUONG_ID = A.DOITUONG_ID
      left join LST_DICTIONARY N on N.DICTIONARY_ID = B.NGHENGHIEP_ID and N.DICTIONARY_TYPE_CODE = 'NgheNghiep'
      where A.BENHVIEN_ID = '$BENHVIEN_ID$' and HD.KHOA = '0' and CT.TAMNGUNG = '0'
    </statement>
  </statements>
</sqlMap>