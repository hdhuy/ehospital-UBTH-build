<?xml version="1.0" encoding="utf-8" ?>
<!--============================================================================
//	CAUTION: This file is generated by IBatisNetGen.3.SQLMap.cst at 5/24/2016 11:05:56 AM
//				Any manual editing will be lost in re-generation.
//===========================================================================-->
<sqlMap namespace="eHospital" xmlns="http://ibatis.apache.org/mapping" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
  <statements>
    <statement id="DAO00094_GetStaffByDepartmentId" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      WITH Relation (CAPTREN_ID, PHONGBAN_ID)
      AS
      (
      SELECT pb.CAPTREN_ID, pb.PHONGBAN_ID
      FROM TM_PHONGBAN AS pb
      WHERE (pb.TAMNGUNG = '0' OR pb.TAMNGUNG IS NULL)
      AND pb.PHONGBAN_ID = '$PHONGBAN_ID$'
      AND  pb.BENHVIEN_ID = '$BENHVIEN_ID$'
      UNION ALL
      SELECT pb.CAPTREN_ID, pb.PHONGBAN_ID
      FROM TM_PHONGBAN AS pb
      INNER JOIN Relation AS r ON pb.CAPTREN_ID = r.PHONGBAN_ID
      WHERE (pb.TAMNGUNG = '0' OR pb.TAMNGUNG IS NULL)
      AND pb.BENHVIEN_ID = '$BENHVIEN_ID$'
      )
      SELECT nv.* FROM TM_NHANVIEN nv
      LEFT JOIN LST_DICTIONARY ls ON ls.DICTIONARY_ID = nv.CHUCDANH_ID
      WHERE ls.DICTIONARY_TYPE_CODE = 'ChucDanh' AND ls.DICTIONARY_CODE = 'BS'
      AND nv.PHONGBAN_ID IN (SELECT PHONGBAN_ID FROM  Relation)
      AND (nv.TAMNGUNG = '0' OR nv.TAMNGUNG IS NULL)
    </statement>
    <statement id="DAO00094_GetStaff" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      WITH Relation (CAPTREN_ID, PHONGBAN_ID)
      AS
      (
      SELECT pb.CAPTREN_ID, pb.PHONGBAN_ID
      FROM TM_PHONGBAN AS pb
      WHERE ISNULL(pb.CAPTREN_ID ,0)=0
      AND (pb.TAMNGUNG = '0' OR pb.TAMNGUNG IS NULL)
      AND  pb.BENHVIEN_ID = '$BENHVIEN_ID$'
      UNION ALL
      SELECT pb.CAPTREN_ID, pb.PHONGBAN_ID
      FROM TM_PHONGBAN AS pb
      INNER JOIN Relation AS r ON pb.CAPTREN_ID = r.PHONGBAN_ID
      WHERE (pb.TAMNGUNG = '0' OR pb.TAMNGUNG IS NULL)
      AND pb.BENHVIEN_ID = '$BENHVIEN_ID$'
      )
      SELECT nv.* FROM TM_NHANVIEN nv
      LEFT JOIN LST_DICTIONARY ls ON ls.DICTIONARY_ID = nv.CHUCDANH_ID
      WHERE ls.DICTIONARY_TYPE_CODE = 'ChucDanh' AND ls.DICTIONARY_CODE = 'BS'
      AND nv.PHONGBAN_ID IN (SELECT PHONGBAN_ID FROM  Relation)
      AND (nv.TAMNGUNG = '0' OR nv.TAMNGUNG IS NULL)
    </statement>
    
    <statement id="DAO00094_GetAll" resultClass="DataObject">
      select *
      from TT_LICHHEN
      order by LICHHEN_ID
    </statement>    
    <statement id="DAO00094_GetList" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select *
      from TT_LICHHEN
      <dynamic prepend="where">
        <isParameterPresent>
          <isNotEmpty prepend="and" property="LICHHEN_ID">
            LICHHEN_ID = '$LICHHEN_ID$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="MALICHHEN">
            MALICHHEN = '$MALICHHEN$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="KHAMBENH_ID">
            KHAMBENH_ID = '$KHAMBENH_ID$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="BENHAN_ID">
            BENHAN_ID = '$BENHAN_ID$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="BENHNHAN_ID">
            BENHNHAN_ID = '$BENHNHAN_ID$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="THOIGIANHEN_BATDAU">
            THOIGIANHEN_BATDAU = '$THOIGIANHEN_BATDAU$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="THOIGIANHEN_KETTHUC">
            THOIGIANHEN_KETTHUC = '$THOIGIANHEN_KETTHUC$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="NOITHUCHIEN_ID">
            NOITHUCHIEN_ID = '$NOITHUCHIEN_ID$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="BACSI_ID">
            BACSI_ID = '$BACSI_ID$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="DICHVU_ID">
            DICHVU_ID = '$DICHVU_ID$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="TRANGTHAI_ID">
            TRANGTHAI_ID = '$TRANGTHAI_ID$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="LOAILICHHEN_ID">
            LOAILICHHEN_ID = '$LOAILICHHEN_ID$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="THUCHIEN_ID">
            THUCHIEN_ID = '$THUCHIEN_ID$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="NHANVIENHEN_ID">
            NHANVIENHEN_ID = '$NHANVIENHEN_ID$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="NHANVIENTHAYDOI_ID">
            NHANVIENTHAYDOI_ID = '$NHANVIENTHAYDOI_ID$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="NGAYTHAYDOI">
            NGAYTHAYDOI = '$NGAYTHAYDOI$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="GHICHU">
            GHICHU = '$GHICHU$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="NGAYTAO">
            NGAYTAO = '$NGAYTAO$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="NGUOITAO_ID">
            NGUOITAO_ID = '$NGUOITAO_ID$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="NGAYCAPNHAT">
            NGAYCAPNHAT = '$NGAYCAPNHAT$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="NGUOICAPNHAT_ID">
            NGUOICAPNHAT_ID = '$NGUOICAPNHAT_ID$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="TIEPNHAN_ID">
            TIEPNHAN_ID = '$TIEPNHAN_ID$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="LICHHEN_OLD">
            LICHHEN_OLD = '$LICHHEN_OLD$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="LICHHEN_PREV">
            LICHHEN_PREV = '$LICHHEN_PREV$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="TIEPNHANTHUCHIEN_ID">
            TIEPNHANTHUCHIEN_ID = '$TIEPNHANTHUCHIEN_ID$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="GUISMS">
            GUISMS = '$GUISMS$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="SONGAYGUITRUOC">
            SONGAYGUITRUOC = '$SONGAYGUITRUOC$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="LICHMO_ID">
            LICHMO_ID = '$LICHMO_ID$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="XEPLICHMO_EKIPMO_ID">
            XEPLICHMO_EKIPMO_ID = '$XEPLICHMO_EKIPMO_ID$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="KHUHEN_ID">
            KHUHEN_ID = '$KHUHEN_ID$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="GOIDICHVU_DANGKY_ID">
            GOIDICHVU_DANGKY_ID = '$GOIDICHVU_DANGKY_ID$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="HOPDONG_ID">
            HOPDONG_ID = '$HOPDONG_ID$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="CONGTY_ID">
            CONGTY_ID = '$CONGTY_ID$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="THOIGIANTHUCHIEN">
            THOIGIANTHUCHIEN = '$THOIGIANTHUCHIEN$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="DATIEPNHAN">
            DATIEPNHAN = '$DATIEPNHAN$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="SODIENTHOAI">
            SODIENTHOAI = '$SODIENTHOAI$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="HUY">
            HUY = '$HUY$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="LYDOHUY">
            LYDOHUY = '$LYDOHUY$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="NGAYHUY">
            LYDOHUY = '$NGAYHUY$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="NGUOIHUY">
            NGUOIHUY = '$NGUOIHUY$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="BENHVIEN_ID">
            BENHVIEN_ID = '$BENHVIEN_ID$'
          </isNotEmpty>
        </isParameterPresent>
      </dynamic>
      order by LICHHEN_ID
    </statement>
    <statement id="DAO00094_GetAppointments" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      SELECT  lh.*,
      tt.DICTIONARY_CODE as MATRANGTHAI,
      bs.TENNHANVIEN as TENBACSI,
      nt.TENNHANVIEN as NGUOITAO,
      ncn.TENNHANVIEN as NGUOICAPNHAT,
      bn.MAYTE,
      bn.TENBENHNHAN as TENBENHNHANREF,
      bn.SODIENTHOAI as SODIENTHOAIREF,
      ll.DICTIONARY_CODE as MaLoaiLich
      FROM TT_LICHHEN lh
      LEFT JOIN LST_DICTIONARY tt ON tt.DICTIONARY_ID = lh.TRANGTHAI_ID
      LEFT JOIN TM_NHANVIEN bs ON bs.NHANVIEN_ID = lh.BACSI_ID
      LEFT JOIN TT_BENHNHAN bn ON bn.BENHNHAN_ID = lh.BENHNHAN_ID
      LEFT JOIN  LST_DICTIONARY ll ON ll.DICTIONARY_ID = lh.LOAILICHHEN_ID
      LEFT JOIN TM_NHANVIEN nt ON nt.NHANVIEN_ID = lh.NGUOITAO_ID
      LEFT JOIN TM_NHANVIEN ncn ON ncn.NHANVIEN_ID = lh.NGUOICAPNHAT_ID
      WHERE (tt.DICTIONARY_CODE = 'MOI' OR tt.DICTIONARY_CODE = 'DOI') AND lh.LICHHEN_PREV IS NULL
      <isParameterPresent>
        <isNotEmpty prepend="and" property="LICHHEN_ID">
          lh.LICHHEN_ID = '$LICHHEN_ID$'
        </isNotEmpty>
        <isNotEmpty prepend="and" property="MALICHHEN">
          lh.MALICHHEN LIKE '%' + #MALICHHEN# + '%'
        </isNotEmpty>
        <isNotEmpty prepend="and" property="BENHAN_ID">
          lh.BENHAN_ID = '$BENHAN_ID$'
        </isNotEmpty>
        <isNotEmpty prepend="and" property="BENHNHAN_ID">
          lh.BENHNHAN_ID = '$BENHNHAN_ID$'
        </isNotEmpty>        
        <isNotEmpty prepend="and" property="TUNGAY">
          <isNotEmpty property="DENNGAY">
            ((lh.THOIGIANHEN_BATDAU BETWEEN CONVERT(date, '$TUNGAY$') and CONVERT(datetime, '$DENNGAY$')) OR
            (lh.THOIGIANHEN_KETTHUC BETWEEN CONVERT(date, '$TUNGAY$') and CONVERT(datetime, '$DENNGAY$')))
          </isNotEmpty>
        </isNotEmpty>
        <isNotEmpty prepend="and" property="BACSIIDS">
          lh.BACSI_ID IN
          <iterate open="(" close=")" conjunction=",  " property="BACSIIDS" >#BACSIIDS[]#</iterate>
        </isNotEmpty>
        <isNotEmpty prepend="and" property="PHONGBAN_ID">
          lh.BACSI_ID IN (SELECT NHANVIEN_ID FROM TM_NHANVIEN WHERE PHONGBAN_ID = '$PHONGBAN_ID$')
        </isNotEmpty>
        <isNotEmpty prepend="and" property="TRANGTHAI_ID">
          lh.TRANGTHAI_ID = '$TRANGTHAI_ID$'
        </isNotEmpty>
        <isNotEmpty prepend="and" property="LOAILICHHEN_ID">
          lh.LOAILICHHEN_ID = '$LOAILICHHEN_ID$'
        </isNotEmpty>     
        <isNotEmpty prepend="and" property="TENBENHNHAN">
          (bn.TENBENHNHAN like '%' + #TENBENHNHAN# + '%' OR lh.TENBENHNHAN like '%' + #TENBENHNHAN# + '%')
        </isNotEmpty>
        <isNotEmpty prepend="and" property="SODIENTHOAI">
          (bn.SODIENTHOAI like '%' + #SODIENTHOAI# + '%' OR lh.SODIENTHOAI like '%' + #SODIENTHOAI# + '%')
        </isNotEmpty>
      </isParameterPresent>
      Order by THOIGIANHEN_BATDAU
    </statement>

    <statement id="DAO00094_CheckAppointmentReceived" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      SELECT TOP 1 1
      FROM TT_LICHHEN lh
      LEFT JOIN LST_DICTIONARY tt ON tt.DICTIONARY_ID = lh.TRANGTHAI_ID
      WHERE lh.LICHHEN_ID = '$LICHHEN_ID$'
          AND (tt.DICTIONARY_CODE = 'MOI' OR (tt.DICTIONARY_CODE = 'DOI' AND LICHHEN_PREV is NOT NULL))
          AND lh.TIEPNHAN_ID IS NOT NULL
    </statement>

    <statement id="DAO00094_ExistDoctorRoster" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      SELECT TOP 1 1
      FROM TT_XEPLICH_CHITIET
      WHERE NHANVIEN_ID = '$BACSIID$'
      AND CONVERT(date, NGAYXEPLICH) = CONVERT(date, '$NGAYHEN$')
    </statement>
    
    <statement id="DAO00094_GetDepartmentIdByStaff" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      SELECT PHONGBAN_ID
      FROM TM_NHANVIEN WHERE NHANVIEN_ID = '$NHANVIEN_ID$'
    </statement>

    <insert id="DAO00094_AddAppointment" parameterClass="System.Collections.IDictionary" resultClass="System.Int64">
      INSERT INTO TT_LICHHEN
      (MALICHHEN
      ,BENHNHAN_ID
      ,TIEPNHAN_ID
      ,KHAMBENH_ID
      ,BENHAN_ID
      ,LOAILICHHEN_ID
      ,THOIGIANHEN_BATDAU
      ,THOIGIANHEN_KETTHUC
      ,NOITHUCHIEN_ID
      ,BACSI_ID
      ,DICHVU_ID
      ,THUCHIEN_ID
      ,NHANVIENHEN_ID
      ,NHANVIENTHAYDOI_ID
      ,NGAYTHAYDOI
      ,LICHHEN_OLD
      ,LICHHEN_PREV
      ,SONGAYGUITRUOC
      ,TIEPNHANTHUCHIEN_ID
      ,LICHMO_ID
      ,XEPLICHMO_EKIPMO_ID
      ,KHUHEN_ID
      ,GOIDICHVU_ID
      ,HOPDONG_ID
      ,CONGTY_ID
      ,THOIGIANTHUCHIEN
      ,TRANGTHAI_ID
      ,DATIEPNHAN
      ,GUISMS
      ,GHICHU
      ,BENHVIEN_ID
      ,NGAYTAO
      ,NGUOITAO_ID
      ,NGAYCAPNHAT
      ,NGUOICAPNHAT_ID
      ,TENBENHNHAN
      ,SODIENTHOAI
      ,NGAYHUY
      ,NGUOIHUY
      ,LYDOHUY
      ,NGAYDOI
      ,NGUOIDOI
      ,LYDODOI)
      VALUES
      (#MALICHHEN#
      ,#BENHNHAN_ID#
      ,#TIEPNHAN_ID#
      ,#KHAMBENH_ID#
      ,#BENHAN_ID#
      ,#LOAILICHHEN_ID#
      ,#THOIGIANHEN_BATDAU#
      ,#THOIGIANHEN_KETTHUC#
      ,#NOITHUCHIEN_ID#
      ,#BACSI_ID#
      ,#DICHVU_ID#
      ,#THUCHIEN_ID#
      ,#NHANVIENHEN_ID#
      ,#NHANVIENTHAYDOI_ID#
      ,#NGAYTHAYDOI#
      ,#LICHHEN_OLD#
      ,#LICHHEN_PREV#
      ,#SONGAYGUITRUOC#
      ,#TIEPNHANTHUCHIEN_ID#
      ,#LICHMO_ID#
      ,#XEPLICHMO_EKIPMO_ID#
      ,#KHUHEN_ID#
      ,#GOIDICHVU_ID#
      ,#HOPDONG_ID#
      ,#CONGTY_ID#
      ,#THOIGIANTHUCHIEN#
      ,#TRANGTHAI_ID#
      ,#DATIEPNHAN#
      ,#GUISMS#
      ,#GHICHU#
      ,#BENHVIEN_ID#
      ,#NGAYTAO#
      ,#NGUOITAO_ID#
      ,#NGAYCAPNHAT#
      ,#NGUOICAPNHAT_ID#
      ,#TENBENHNHAN#
      ,#SODIENTHOAI#
      ,#NGAYHUY#
      ,#NGUOIHUY#
      ,#LYDOHUY#
      ,#NGAYDOI#
      ,#NGUOIDOI#
      ,#LYDODOI#)
      <!--SELECT SCOPE_IDENTITY()-->
      <selectKey resultClass="System.Int64" type="post" >
        SELECT @@IDENTITY as value
      </selectKey>
    </insert>
    <update id="DAO00094_UpdateAppointment" parameterClass="System.Collections.IDictionary">
      UPDATE TT_LICHHEN
      SET MALICHHEN = #MALICHHEN#
      ,BENHNHAN_ID = #BENHNHAN_ID#
      ,TIEPNHAN_ID = #TIEPNHAN_ID#
      ,KHAMBENH_ID = #KHAMBENH_ID#
      ,BENHAN_ID = #BENHAN_ID#
      ,LOAILICHHEN_ID = #LOAILICHHEN_ID#
      ,THOIGIANHEN_BATDAU = #THOIGIANHEN_BATDAU#
      ,THOIGIANHEN_KETTHUC = #THOIGIANHEN_KETTHUC#
      ,NOITHUCHIEN_ID = #NOITHUCHIEN_ID#
      ,BACSI_ID = #BACSI_ID#
      ,DICHVU_ID = #DICHVU_ID#
      ,THUCHIEN_ID = #THUCHIEN_ID#
      ,NHANVIENHEN_ID = #NHANVIENHEN_ID#
      ,NHANVIENTHAYDOI_ID = #NHANVIENTHAYDOI_ID#
      ,NGAYTHAYDOI = #NGAYTHAYDOI#
      ,LICHHEN_OLD = #LICHHEN_OLD#
      ,LICHHEN_PREV = #LICHHEN_PREV#
      ,SONGAYGUITRUOC = #SONGAYGUITRUOC#
      ,TIEPNHANTHUCHIEN_ID = #TIEPNHANTHUCHIEN_ID#
      ,LICHMO_ID = #LICHMO_ID#
      ,XEPLICHMO_EKIPMO_ID = #XEPLICHMO_EKIPMO_ID#
      ,KHUHEN_ID = #KHUHEN_ID#
      ,GOIDICHVU_ID = #GOIDICHVU_ID#
      ,HOPDONG_ID = #HOPDONG_ID#
      ,CONGTY_ID = #CONGTY_ID#
      ,THOIGIANTHUCHIEN = #THOIGIANTHUCHIEN#
      ,TRANGTHAI_ID = #TRANGTHAI_ID#
      ,DATIEPNHAN = #DATIEPNHAN#
      ,GUISMS = #GUISMS#
      ,GHICHU = #GHICHU#
      ,NGAYCAPNHAT = #NGAYCAPNHAT#
      ,NGUOICAPNHAT_ID = #NGUOICAPNHAT_ID#
      ,TENBENHNHAN = #TENBENHNHAN#
      ,SODIENTHOAI = #SODIENTHOAI#
      ,NGAYHUY = #NGAYHUY#
      ,NGUOIHUY = #NGUOIHUY#
      ,LYDOHUY = #LYDOHUY#
      ,NGAYDOI = #NGAYDOI#
      ,NGUOIDOI = #NGUOIDOI#
      ,LYDODOI = #LYDODOI#
      WHERE LICHHEN_ID = '$LICHHEN_ID$'
    </update>
    <statement id="DAO00094_DeleteAppointment" parameterClass="System.Collections.IDictionary" resultClass="System.Int32">
      DELETE FROM TT_LICHHEN
      WHERE
         LICHHEN_ID = '$LICHHEN_ID$'
    </statement>
    
    <statement id="DAO00094_ValidateBeforUpdate" parameterClass="System.Collections.IDictionary" resultClass="System.Int32">
      SELECT LICHHEN_ID FROM TT_LICHHEN WHERE LICHHEN_ID='$LICHHEN_ID$' AND DATIEPNHAN='1'
    </statement>
    <statement id="DAO00094_GetRoster" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select * from TT_XEPLICH
      where PHONGBAN_ID = '$PHONGBAN_ID$'
      <dynamic>
        <isParameterPresent>
          <isNotEmpty prepend="and" property="TUNGAY">
            <isNotEmpty property="DENNGAY">
              ((THOIGIAN_BATDAU BETWEEN CONVERT(date, '$TUNGAY$') and CONVERT(datetime, '$DENNGAY$')) OR
              (THOIGIAN_KETTHUC BETWEEN CONVERT(date, '$TUNGAY$') and CONVERT(datetime, '$DENNGAY$')))
            </isNotEmpty>
          </isNotEmpty>
          <isNotEmpty prepend="and" property="NHANVIEN_ID">
            NHANVIEN_ID = '$NHANVIEN_ID$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="BENHVIEN_ID">
            BENHVIEN_ID = '$BENHVIEN_ID$'
          </isNotEmpty>
        </isParameterPresent>
      </dynamic>
      order by THOIGIAN_BATDAU
    </statement>
  </statements>
</sqlMap>
