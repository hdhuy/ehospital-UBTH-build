<?xml version="1.0" encoding="utf-8" ?>
<!--============================================================================
//	CAUTION: This file is generated by IBatisNetGen.3.SQLMap.cst at 11/11/2015 9:27:48 AM
//				Any manual editing will be lost in re-generation.
//===========================================================================-->
<sqlMap namespace="eHospital" xmlns="http://ibatis.apache.org/mapping" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" >
  <statements>
    <!--get-->
    <statement id="DAO00099_GetListLoaiGoiDV" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select * from LST_DICTIONARY
      where
      DICTIONARY_TYPE_CODE = 'LoaiGoiDV'
      <!--and BENHVIEN_ID = 'FPT00001'-->
    </statement>
    <statement id="DAO00099_GetLoaiGiaDichVu" resultClass="DataObject">
      select A.LOAIGIA_ID,B.TENLOAIGIA, B.MALOAIGIA
      from TM_DICHVU_DONGIA A
      inner join TM_LOAIGIA B on A.LOAIGIA_ID = B.LOAIGIA_ID
      inner join LST_DICTIONARY AS DIC ON DIC.DICTIONARY_ID = B.NHOMGIA_ID AND DIC.DICTIONARY_TYPE_CODE = 'NhomGia'
      where A.DICHVU_ID = '$DICHVU_ID$' and A.BENHVIEN_ID = '$BENHVIEN_ID$' and DIC.DICTIONARY_CODE != 'BHYT'
    </statement>
    <statement id="DAO00099_TM_CSKH_GOI_GetList" resultClass="DataObject">
      select * from TM_CSKH_GOI A
      <dynamic prepend="where">
      <isParameterPresent>        
        <isNotEmpty prepend="and" property="TUKHOA">
          (A.TENGOI like N'%$TUKHOA$%' or A.MAGOI like N'%$TUKHOA$%')
        </isNotEmpty>
        <isNotEmpty prepend="and" property="NGAYHIENTAI">
          A.TRANGTHAI = '$TRANGTHAIGOI$'
        </isNotEmpty>
        <isNotEmpty prepend="and" property="TRANGTHAI">
          A.TRANGTHAI = '$TRANGTHAI$'
        </isNotEmpty>
      <isNotEmpty prepend="and" property="DENNGAY">
          convert(date,A.NGAYTAO) between convert(date, '$TUNGAY$') and convert(date, '$DENNGAY$')
        </isNotEmpty>
      <isNotEmpty prepend="and" property="BENHVIEN_ID">
          A.BENHVIEN_ID = '$BENHVIEN_ID$'
        </isNotEmpty>
       <isNotEmpty prepend="and" property="NGAYKETTHUCBAN">
         convert(date,A.NGAYTAO) between convert(date, '$NGAYBATDAUBAN$') and convert(date, '$NGAYKETTHUCBAN$')
       </isNotEmpty>
      <isNotEmpty prepend="and" property="NGAYHIENTAI">
        convert(date,'$NGAYHIENTAI$') between convert(date, A.NGAYBATDAUBAN) and convert(date, NGAYKETTHUCBAN)
      </isNotEmpty>
        
      </isParameterPresent>
    </dynamic>
    </statement>
    
    <statement id="DAO00099_TM_CSKH_GOI_Get" resultClass="DataObject">
      select A.*, B.SOLANSUDUNG
      from TM_CSKH_GOI A
      left join
      (select count(*) as SOLANSUDUNG, GOI_ID
      from TT_CSKH_GOI_DANGKY
      group by GOI_ID
      )B on B.GOI_ID = a.GOI_ID
      <dynamic prepend="where">
      <isParameterPresent>
        <isNotEmpty prepend="and" property="TRANNGTHAI">
          A.TRANGTHAI = '$TRANGTHAI$'
        </isNotEmpty>
        <isNotEmpty prepend="and" property="LAGOIMAU">
          A.LAGOIMAU = '$LAGOIMAU$'
        </isNotEmpty>
        <isNotEmpty prepend="and" property="GOI_ID">
          A.GOI_ID = '$GOI_ID$'
        </isNotEmpty>
      <isNotEmpty prepend="and" property="BENHVIEN_ID">
          A.BENHVIEN_ID = '$BENHVIEN_ID$'
        </isNotEmpty>
      </isParameterPresent>
    </dynamic>
    </statement>

    <statement id="DAO00099_TT_CSKH_GOI_DANGKY_GetCount" resultClass="DataObject">
      select Count(*) as SOLAN from TT_CSKH_GOI_DANGKY
      <dynamic prepend="where">
        <isParameterPresent>          
          <isNotEmpty prepend="and" property="GOI_ID">
            GOI_ID = '$GOI_ID$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="BENHVIEN_ID">
            BENHVIEN_ID = '$BENHVIEN_ID$'
          </isNotEmpty>
        </isParameterPresent>
      </dynamic>
    </statement>
    
    <statement id="DAO00099_TM_CSKH_GOI_CheckChange" resultClass="DataObject">
      select * from TM_CSKH_GOI
      <dynamic prepend="where">
        <isParameterPresent>
          <isNotEmpty prepend="and" property="MAGOI">
            MAGOI = '$MAGOI$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="TENGOI">
            TENGOI = '$TENGOI$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="LOAIGOI_ID">
            LOAIGOI_ID = '$LOAIGOI_ID$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="GIATRIGOI">
            GIATRIGOI = '$GIATRIGOI$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="GIATRICHUAGIAM">
            GIATRICHUAGIAM = '$GIATRICHUAGIAM$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="TYLEMIENGIAM">
            TYLEMIENGIAM = '$TYLEMIENGIAM$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="GIATRIMIENGIAM">
            GIATRIMIENGIAM = '$GIATRIMIENGIAM$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="NGAYBATDAUBAN">
            NGAYBATDAUBAN = '$NGAYBATDAUBAN$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="THOIGIANSUDUNG">
            THOIGIANSUDUNG = '$THOIGIANSUDUNG$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="NGAYHETHANTUYETDOI">
            NGAYHETHANTUYETDOI = '$NGAYHETHANTUYETDOI$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="MOTAGOI">
            MOTAGOI = '$MOTAGOI$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="LYDOHUY">
            LYDOHUY = '$LYDOHUY$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="TRANNGTHAI">
            TRANGTHAI = '$TRANGTHAI$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="TRANNGTHAI">
            TRANGTHAI = '$TRANGTHAI$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="LAGOIMAU">
            LAGOIMAU = '$LAGOIMAU$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="GOI_ID">
            GOI_ID = '$GOI_ID$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="BENHVIEN_ID">
            BENHVIEN_ID = '$BENHVIEN_ID$'
          </isNotEmpty>
        </isParameterPresent>
      </dynamic>
    </statement>


    <statement id="DAO00099_TM_CSKH_GOI_CHITIET_GetDetail" resultClass="DataObject">
      select A.*, DV.MADICHVU from TM_CSKH_GOI_CHITIET A
      left join TM_DICHVU dv on dv.DICHVU_ID = A.DICHVU_ID
      <dynamic prepend="where">
        <isParameterPresent>
          <isNotEmpty prepend="and" property="GOI_ID">
            A.GOI_ID = '$GOI_ID$'
          </isNotEmpty>
        <isNotEmpty prepend="and" property="BENHVIEN_ID">
            A.BENHVIEN_ID = '$BENHVIEN_ID$'
          </isNotEmpty>
        </isParameterPresent>
      </dynamic>
    </statement>
    
    <statement id="DAO00099_TT_CSKH_GOI_DANGKY_GetList" resultClass="DataObject">
      select A.*, B.TYLEMIENGIAM
      from TT_CSKH_GOI_DANGKY A
      left join TM_CSKH_GOI B on B.GOI_ID = A.GOI_ID
      <dynamic prepend="where">
        <isParameterPresent>
          <isNotEmpty prepend="and" property="GOI_ID">
            A.GOI_ID = '$GOI_ID$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="SOVOUCHER">
            A.SOVOUCHER = '$SOVOUCHER$'
          </isNotEmpty>
        <isNotEmpty prepend="and" property="DANGKY_ID">
            A.DANGKY_ID = '$DANGKY_ID$'
          </isNotEmpty>
        </isParameterPresent>
      </dynamic>
    </statement>
    
    <statement id="DAO00099_TT_CSKH_GOI_DANGKY_Get" resultClass="DataObject">
      select A.*, B.MAYTE, C.THANHTIENTRONGGOI as THANHTIENGOI, C.SOLANDINHMUC as SOLUONG
      , C.DANGKY_CHITIET_ID, (C.THANHTIENTRONGGOI * C.SOLANDINHMUC) as THANHTIEN
      , C.DICHVU_ID, C.SOLANDASUDUNG, C.SOLANCONLAI, C.NGAYFOLLOWUP as NGAYFOLLOWUPDV, C.NGAYHETFOLLOWUP as NGAYHETFOLLOWUPDV
      from TT_CSKH_GOI_DANGKY A
      left join TT_BENHNHAN B on B.BENHNHAN_ID = A.BENHNHAN_ID
      left join TT_CSKH_GOI_DANGKY_CHITIET C on A.DANGKY_ID = C.DANGKY_ID
      <dynamic prepend="where">
        <isParameterPresent>
          <isNotEmpty prepend="and" property="GOI_ID">
            A.GOI_ID = '$GOI_ID$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="SOVOUCHER">
            A.SOVOUCHER = '$SOVOUCHER$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="DANGKY_ID">
            A.DANGKY_ID = '$DANGKY_ID$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="TRANGTHAI">
              A.TRANGTHAI = '$TRANGTHAI$'
          </isNotEmpty>
         </isParameterPresent>
      </dynamic>
    </statement>
    
    <statement id="DAO00099_TT_CSKH_GOI_DANGKY_CheckSuDungGoi" resultClass="DataObject">
      select A.*, B.MAYTE, C.THANHTIENTRONGGOI as THANHTIENGOI, C.SOLANDINHMUC as SOLUONG
      , C.DANGKY_CHITIET_ID, (C.THANHTIENTRONGGOI * C.SOLANDINHMUC) as THANHTIEN
      , C.DICHVU_ID, C.SOLANDASUDUNG, C.SOLANCONLAI, C.NGAYFOLLOWUP as NGAYFOLLOWUPDV
      from TT_CSKH_GOI_DANGKY A
      left join TT_BENHNHAN B on B.BENHNHAN_ID = A.BENHNHAN_ID
      left join TT_CSKH_GOI_DANGKY_CHITIET C on A.DANGKY_ID = C.DANGKY_ID
      where C.SOLANDASUDUNG > 0
      <isParameterPresent>
          <isNotEmpty prepend="and" property="GOI_ID">
            A.GOI_ID = '$GOI_ID$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="SOVOUCHER">
            A.SOVOUCHER = '$SOVOUCHER$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="DANGKY_ID">
            A.DANGKY_ID = '$DANGKY_ID$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="TRANGTHAI">
              A.TRANGTHAI = '$TRANGTHAI$'
          </isNotEmpty>
         </isParameterPresent>
    
    </statement>
    
    <statement id="DAO00099_TT_CSKH_GOI_DANGKY_CHITIET_GetList" resultClass="DataObject">
      select * from TT_CSKH_GOI_DANGKY_CHITIET
      <dynamic prepend="where">
        <isParameterPresent>
          <isNotEmpty prepend="and" property="DANGKY_CHITIET_ID">
            DANGKY_CHITIET_ID = '$DANGKY_CHITIET_ID$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="DANGKY_ID">
            DANGKY_ID = '$DANGKY_ID$'
          </isNotEmpty>
        
        </isParameterPresent>
      </dynamic>
    </statement>
    
    <!--Search-->    
    <statement id="DAO00099_TM_CSKH_GOI_Search" resultClass="DataObject">
      select * from TM_CSKH_GOI
      <dynamic prepend="where">
      <isParameterPresent>
        <isNotEmpty prepend="and" property="TUKHOA">
          (MAGOI like '%' + #TUKHOA# + '%' or TENGOI like '%' + #TUKHOA# + '%')
        </isNotEmpty>
        <isNotEmpty prepend="and" property="DENNGAY">
          convert(date,NGAYTAO) between convert(date, '$TUNGAY$') and convert(date, '$DENNGAY$')
        </isNotEmpty>
        <isNotEmpty prepend="and" property="TRANGTHAI">
          TRANGTHAI = '$TRANGTHAI$'
        </isNotEmpty>
      </isParameterPresent>
    </dynamic>      
    </statement>
    <statement id="DAO00099_TT_CSKH_GOI_DANGKY_Search" resultClass="DataObject">
      select A.*,B.LOAIGOI_ID,B.MAGOI, B.TENGOI, B.GIATRIGOI, B.GIATRICHUAGIAM, B.GIATRIGOI as THANHTIEN
      , C.TENBENHNHAN, C.MAYTE, CASE ISNULL(C.NGAYSINH,'')
      WHEN '' THEN CONVERT(VARCHAR(10), C.NAMSINH) ELSE CONVERT(VARCHAR(10), C.NGAYSINH, 103) END AS NAMSINH
      , D.DESCRIPTION AS GIOITINH , C.DIACHI
      , ISNULL(BL.HUYHOADON,'0') as HUYBIENLAI, vp.VIENPHI_ID, VP.HOADON_ID
      from TT_CSKH_GOI_DANGKY A
      left join TT_BENHNHAN C on c.BENHNHAN_ID = A.BENHNHAN_ID
      left join TM_GENDER D ON D.ID = C.GIOITINH
      left join TM_CSKH_GOI B on B.GOI_ID = A.GOI_ID
      left join TT_VIENPHI vp on vp.REF_ID = A.DANGKY_ID and vp.REF_TABLE like '%' + #TT_CSKH_GOI_DANGKY# + '%'
      left join
      (SELECT HCN.VIENPHI_ID, HUYHOADON = MIN(CASE WHEN HD.HUYHOADON = '0' THEN HD.HOANTRA ELSE HD.HUYHOADON END)
      FROM TT_HOADON_CHITIET_NGOAITRU AS HCN
      INNER JOIN TT_HOADON AS HD ON HD.HOADON_ID = HCN.HOADON_ID
      WHERE HCN.REF_TABLE like '%TT_CSKH_GOI_DANGKY%'
      GROUP BY HCN.VIENPHI_ID) AS BL ON BL.VIENPHI_ID = vp.VIENPHI_ID
      <dynamic prepend="where">
      <isParameterPresent>
        <isNotEmpty prepend="and" property="TUKHOA">
          (C.MAYTE like '%' + #TUKHOA# + '%' or C.TENBENHNHAN like '%' + #TUKHOA# + '%')
        </isNotEmpty>
        <isNotEmpty prepend="and" property="TUKHOA1">
          (B.MAGOI like '%' + #TUKHOA1# + '%' or B.TENGOI like '%' + #TUKHOA1# + '%')
        </isNotEmpty>
        <isNotEmpty prepend="and" property="TUKHOA2">
          C.TENBENHNHAN like '%' + #TUKHOA2# + '%'
        </isNotEmpty>
         <isNotEmpty prepend="and" property="MADANGKY">
          A.MADANGKY = '$MADANGKY$'
        </isNotEmpty>
        <isNotEmpty prepend="and" property="BENHNHAN_ID">
          A.BENHNHAN_ID = '$BENHNHAN_ID$'
        </isNotEmpty>
        <isNotEmpty prepend="and" property="DENNGAY">
          convert(date,A.NGAYTAO) between convert(date, '$TUNGAY$') and convert(date, '$DENNGAY$')
        </isNotEmpty>
        <isNotEmpty prepend="and" property="TRANGTHAI">
          A.TRANGTHAI = '$TRANGTHAI$'
        </isNotEmpty>
      <isNotEmpty prepend="and" property="TRANGTHAI1">
          (A.TRANGTHAI = 'DAKICHHOAT' or A.TRANGTHAI = 'BOKHOAGOI')
        </isNotEmpty>
      <isNotEmpty prepend="and" property="TRANGTHAI2">
          A.TRANGTHAI = '$TRANGTHAI2$'
        </isNotEmpty>
      <isNotEmpty prepend="and" property="BENHVIEN_ID">
          A.BENHVIEN_ID = '$BENHVIEN_ID$'
        </isNotEmpty>
      </isParameterPresent>
    </dynamic>
  </statement>
    <statement id="DAO00099_GetTT_CSKH_GOI_DANGKY" resultClass="DataObject">
      select A.*,B.LOAIGOI_ID,B.MAGOI, B.TENGOI, B.GIATRIGOI, B.GIATRICHUAGIAM, B.GIATRIGOI as THANHTIEN
      , C.TENBENHNHAN, C.MAYTE, CASE ISNULL(C.NGAYSINH,'')
      WHEN '' THEN CONVERT(VARCHAR(10), C.NAMSINH) ELSE CONVERT(VARCHAR(10), C.NGAYSINH, 103) END AS NAMSINH
      , D.DESCRIPTION AS GIOITINH , C.DIACHI
      , vp.huy as HUYBIENLAI, vp.VIENPHI_ID, VP.HOADON_ID
      from TT_CSKH_GOI_DANGKY A
      left join TT_BENHNHAN C on c.BENHNHAN_ID = A.BENHNHAN_ID
      left join TM_GENDER D ON D.ID = C.GIOITINH
      left join (select * from TM_CSKH_GOI B) B on B.GOI_ID = A.GOI_ID
      left join TT_VIENPHI vp on vp.REF_ID = A.DANGKY_ID and vp.REF_TABLE like '%TT_CSKH_GOI_DANGKY%'
      <dynamic prepend="where">
        <isParameterPresent>          
          <isNotEmpty prepend="and" property="BENHVIEN_ID">
            A.BENHVIEN_ID = '$BENHVIEN_ID$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="DANGKY_ID">
            A.DANGKY_ID = '$DANGKY_ID$'
          </isNotEmpty>
        </isParameterPresent>
      </dynamic>
    </statement>
    
    <!--add-->
    <statement id="DAO00099_TM_CSKH_GOI_Add" parameterClass="HashTable" resultClass="System.Int64">
      INSERT INTO TM_CSKH_GOI
           (MAGOI
           ,TENGOI
           ,LOAIGOI_ID
           ,GIATRIGOI
           ,GIATRICHUAGIAM
           ,TYLEMIENGIAM
           ,GIATRIMIENGIAM
           ,NGAYBATDAUBAN
           ,NGAYKETTHUCBAN
           ,THOIGIANSUDUNG
           ,NGAYHETHANTUYETDOI
           ,MOTAGOI
           ,LYDOHUY
           ,LAGOIMAU
           ,TRANGTHAI
           ,NGAYDUYET
           ,NGUOIDUYET_ID
           ,BENHVIEN_ID
           ,NGAYTAO
           ,NGUOITAO_ID
           ,NGAYCAPNHAT
           ,NGUOICAPNHAT_ID)
     VALUES
           (#MAGOI#
           ,#TENGOI#
           ,#LOAIGOI_ID#
           ,#GIATRIGOI#
           ,#GIATRICHUAGIAM#
           ,#TYLEMIENGIAM#
           ,#GIATRIMIENGIAM#
           ,#NGAYBATDAUBAN#
           ,#NGAYKETTHUCBAN#
           ,#THOIGIANSUDUNG#
           ,#NGAYHETHANTUYETDOI#
           ,#MOTAGOI#
           ,#LYDOHUY#
           ,#LAGOIMAU#
           ,#TRANGTHAI#
           ,#NGAYDUYET#
           ,#NGUOIDUYET_ID#
           ,#BENHVIEN_ID#
           ,#NGAYTAO#
           ,#NGUOITAO_ID#
           ,#NGAYCAPNHAT#
           ,#NGUOICAPNHAT_ID#
           )
      select SCOPE_identity() as value
    </statement>
    <statement id="DAO00099_TM_CSKH_GOI_CHITIET_Add" parameterClass="HashTable" resultClass="System.Int64">
      INSERT INTO TM_CSKH_GOI_CHITIET
           (GOI_ID
           ,DICHVU_ID
           ,SOLAN
           ,DONGIATRONGGOI
           ,THANHTIENTRONGGOI
           ,LOAIGIA_ID
           ,GIAVON_DICHVU
           ,GIAVAT_DICHVU
           ,MOTA
           ,TINHTRANG
           ,BENHVIEN_ID
           ,NGAYTAO
           ,NGUOITAO_ID
           ,NGAYCAPNHAT
           ,NGUOICAPNHAT_ID)
     VALUES
           (#GOI_ID#
           ,#DICHVU_ID#
           ,#SOLAN#
           ,#DONGIATRONGGOI#
           ,#THANHTIENTRONGGOI#
           ,#LOAIGIA_ID#
           ,#GIAVON_DICHVU#
           ,#GIAVAT_DICHVU#
           ,#MOTA#
           ,#TINHTRANG#
           ,#BENHVIEN_ID#
           ,#NGAYTAO#
           ,#NGUOITAO_ID#
           ,#NGAYCAPNHAT#
           ,#NGUOICAPNHAT_ID#
           )
    </statement>
    <statement id="DAO00099_TT_CSKH_GOI_DANGKY_Add" parameterClass="HashTable" resultClass="System.Int64">
      INSERT INTO TT_CSKH_GOI_DANGKY
      ( MADANGKY
           ,GOI_ID
           ,BENHNHAN_ID
           ,SOVOUCHER
           ,NGAYHIEULUC
           ,NGAYHETHIEULUC
           ,NGAYKICHHOAT
           ,NGUOIKICHHOAT_ID
           ,SONGAYSUDUNG
           ,NGAYHETHANSUDUNG
           ,NGAYKHOAGOI
           ,NGUOIKHOAGOI_ID
           ,NGAYFOLLOWUP
           ,NGAYHETFOLLOWUP
           ,NGUOIFOLLOWUP_ID
           ,NGAYHOANTATGOI
           ,NGUOIHOANTATGOI_ID
           ,TRANGTHAI
           ,BENHVIEN_ID
           ,NGAYTAO
           ,NGUOITAO_ID
           ,NGAYCAPNHAT
           ,NGUOICAPNHAT_ID
      )
      VALUES
      (
        #MADANGKY#
           ,#GOI_ID#
           ,#BENHNHAN_ID#
           ,#SOVOUCHER#
           ,#NGAYHIEULUC#
           ,#NGAYHETHIEULUC#
           ,#NGAYKICHHOAT#
           ,#NGUOIKICHHOAT_ID#
           ,#SONGAYSUDUNG#
           ,#NGAYHETHANSUDUNG#
           ,#NGAYKHOAGOI#
           ,#NGUOIKHOAGOI_ID#
           ,#NGAYFOLLOWUP#
           ,#NGAYHETFOLLOWUP#
           ,#NGUOIFOLLOWUP_ID#
           ,#NGAYHOANTATGOI#
           ,#NGUOIHOANTATGOI_ID#
           ,#TRANGTHAI#
           ,#BENHVIEN_ID#
           ,#NGAYTAO#
           ,#NGUOITAO_ID#
           ,#NGAYCAPNHAT#
           ,#NGUOICAPNHAT_ID#
      )
      select SCOPE_identity() as value
    </statement>
    <statement id="DAO00099_TT_CSKH_GOI_DANGKY_CHITIET_Add" parameterClass="HashTable" resultClass="System.Int64">
      INSERT INTO TT_CSKH_GOI_DANGKY_CHITIET
           (DANGKY_ID
           ,DICHVU_ID
           ,SOLANDINHMUC
           ,SOLANDASUDUNG
           ,SOLANCONLAI
           ,NGAYFOLLOWUP
           ,GHICHU
           ,DONGIATRONGGOI
           ,THANHTIENTRONGGOI
           ,GIAVON_DICHVU
           ,GIAVAT_DICHVU
           ,BENHVIEN_ID
           ,NGAYTAO
           ,NGUOITAO_ID
           ,NGAYCAPNHAT
           ,NGUOICAPNHAT_ID)
     VALUES
           (#DANGKY_ID#
           ,#DICHVU_ID#
           ,#SOLANDINHMUC#
           ,#SOLANDASUDUNG#
           ,#SOLANCONLAI#
           ,#NGAYFOLLOWUP#
           ,#GHICHU#
           ,#DONGIATRONGGOI#
           ,#THANHTIENTRONGGOI#
           ,#GIAVON_DICHVU#
           ,#GIAVAT_DICHVU#
           ,#BENHVIEN_ID#
           ,#NGAYTAO#
           ,#NGUOITAO_ID#
           ,#NGAYCAPNHAT#
           ,#NGUOICAPNHAT_ID#
           )
    </statement>
    
    <!--update-->
    <update id="DAO00099_TM_CSKH_GOI_Update" parameterClass="System.Collections.IDictionary">
      UPDATE TM_CSKH_GOI
      SET 
      MAGOI = #MAGOI#
      ,TENGOI = #TENGOI#
      ,LOAIGOI_ID = #LOAIGOI_ID#
      ,GIATRIGOI = #GIATRIGOI#
      ,GIATRICHUAGIAM = #GIATRICHUAGIAM#
      ,TYLEMIENGIAM = #TYLEMIENGIAM#
      ,GIATRIMIENGIAM = #GIATRIMIENGIAM#
      ,NGAYBATDAUBAN = #NGAYBATDAUBAN#
      ,NGAYKETTHUCBAN = #NGAYKETTHUCBAN#
      ,THOIGIANSUDUNG = #THOIGIANSUDUNG#
      ,NGAYHETHANTUYETDOI = #NGAYHETHANTUYETDOI#
      ,MOTAGOI = #MOTAGOI#
      ,LYDOHUY = #LYDOHUY#
      ,LAGOIMAU = #LAGOIMAU#
      ,TRANGTHAI = #TRANGTHAI#
      ,NGAYDUYET = #NGAYDUYET#
      ,NGUOIDUYET_ID = #NGUOIDUYET_ID#
      ,BENHVIEN_ID = #BENHVIEN_ID#
      ,NGAYTAO = #NGAYTAO#
      ,NGUOITAO_ID = #NGUOITAO_ID#
      ,NGAYCAPNHAT = #NGAYCAPNHAT#
      ,NGUOICAPNHAT_ID = #NGUOICAPNHAT_ID#
      WHERE
        GOI_ID = #GOI_ID#
    </update>
    <update id="DAO00099_TM_CSKH_GOI_CHITIET_Update" parameterClass="System.Collections.IDictionary">
      UPDATE TM_CSKH_GOI_CHITIET
      SET 
      GOI_ID = #GOI_ID#
      ,DICHVU_ID = #DICHVU_ID#
      ,SOLAN = #SOLAN#
      ,DONGIATRONGGOI = #DONGIATRONGGOI#
      ,THANHTIENTRONGGOI = #THANHTIENTRONGGOI#
      ,LOAIGIA_ID = #LOAIGIA_ID#
      ,GIAVON_DICHVU = #GIAVON_DICHVU#
      ,GIAVAT_DICHVU = #GIAVAT_DICHVU#
      ,MOTA = #MOTA#
      ,TINHTRANG = #TINHTRANG#
      ,BENHVIEN_ID = #BENHVIEN_ID#
      ,NGAYTAO = #NGAYTAO#
      ,NGUOITAO_ID = #NGUOITAO_ID#
      ,NGAYCAPNHAT = #NGAYCAPNHAT#
      ,NGUOICAPNHAT_ID = #NGUOICAPNHAT_ID#
      WHERE
      GOI_ID = #GOI_ID# AND GOI_CHITIET_ID = #GOI_CHITIET_ID#
    </update>

    <update id="DAO00099_TM_CSKH_GOI_UpdateTrangThai" parameterClass="System.Collections.IDictionary">
      UPDATE TM_CSKH_GOI
      SET
      <isParameterPresent>
        <isNotEmpty prepend=" " property="TRANGTHAI">
          TRANGTHAI = #TRANGTHAI#
        </isNotEmpty>
        <isNotEmpty prepend="," property="LAGOIMAU">
          LAGOIMAU = #LAGOIMAU#
        </isNotEmpty>
        <isNotEmpty prepend="," property="LYDO">
          LYDO = #LYDO#
        </isNotEmpty>
        <isNotEmpty prepend="," property="NGAYCAPNHAT">
          NGAYCAPNHAT = #NGAYCAPNHAT#
        </isNotEmpty>
        <isNotEmpty prepend="," property="NGUOICAPNHAT_ID">
          NGUOICAPNHAT_ID = #NGUOICAPNHAT_ID#
        </isNotEmpty>
      </isParameterPresent>
      WHERE
      GOI_ID = #GOI_ID#
      and BENHVIEN_ID = '$BENHVIEN_ID$'
    </update>
    <update id="DAO00099_TT_CSKH_GOI_DANGKY_KichHoat" parameterClass="System.Collections.IDictionary">
      UPDATE TT_CSKH_GOI_DANGKY
      SET
      <isParameterPresent>
      <isNotEmpty prepend=" " property="TRANGTHAI">
        TRANGTHAI = #TRANGTHAI#
      </isNotEmpty>
        <isNotEmpty prepend=", " property="NGAYKICHHOAT">
          NGAYKICHHOAT = #NGAYKICHHOAT#
        </isNotEmpty>
        <isNotEmpty prepend=", " property="SONGAYSUDUNG">
          SONGAYSUDUNG = #SONGAYSUDUNG#
        </isNotEmpty>
        <isNotEmpty prepend=", " property="NGAYHETHANSUDUNG">
          NGAYHETHANSUDUNG = #NGAYHETHANSUDUNG#
        </isNotEmpty>
        <isNotEmpty prepend=", " property="NGUOIKICHHOAT_ID">
          NGUOIKICHHOAT_ID = #NGUOIKICHHOAT_ID#
        </isNotEmpty>
        <isNotEmpty prepend=", " property="NGAYHIEULUC">
          NGAYHIEULUC = #NGAYHIEULUC#
        </isNotEmpty>
        <isNotEmpty prepend=", " property="NGAYKHOAGOI">
          NGAYKHOAGOI = #NGAYKHOAGOI#
        </isNotEmpty>
        <isNotEmpty prepend=", " property="NGUOIKHOAGOI_ID">
          NGUOIKHOAGOI_ID = #NGUOIKHOAGOI_ID#
        </isNotEmpty>
        <isNotEmpty prepend=", " property="NGAYHETHIEULUC">
          NGAYHETHIEULUC = #NGAYHETHIEULUC#
        </isNotEmpty>
        <isNotEmpty prepend=", " property="NGAYFOLLOWUP">
          NGAYFOLLOWUP = #NGAYFOLLOWUP#
        </isNotEmpty>
        <isNotEmpty prepend=", " property="NGAYHETFOLLOWUP">
          NGAYHETFOLLOWUP = #NGAYHETFOLLOWUP#
        </isNotEmpty>
        <isNotEmpty prepend=", " property="NGUOIFOLLOWUP_ID">
          NGUOIFOLLOWUP_ID = #NGUOIFOLLOWUP_ID#
        </isNotEmpty>
        <isNotEmpty prepend=", " property="NGAYCAPNHAT">
          NGAYCAPNHAT = #NGAYCAPNHAT#
        </isNotEmpty>
        <isNotEmpty prepend=", " property="NGUOICAPNHAT_ID">
          NGUOICAPNHAT_ID = #NGUOICAPNHAT_ID#
        </isNotEmpty>
    </isParameterPresent>
      WHERE DANGKY_ID = #DANGKY_ID#
      
    Update TT_VIENPHI
    set DATHUCHIEN = #DATHUCHIEN#
    where REF_ID = #DANGKY_ID#
    and REF_TABLE = 'TT_CSKH_GOI_DANGKY'
    </update>

    <update id="DAO00099_TT_CSKH_GOI_DANGKY_FollowUp" parameterClass="System.Collections.IDictionary">
      UPDATE TT_CSKH_GOI_DANGKY
      SET
      <isParameterPresent>
        <isNotEmpty prepend=" " property="TRANGTHAI">
          TRANGTHAI = #TRANGTHAI#
        </isNotEmpty>
        <isNotEmpty prepend=", " property="NGAYKICHHOAT">
          NGAYKICHHOAT = #NGAYKICHHOAT#
        </isNotEmpty>
        <isNotEmpty prepend=", " property="SONGAYSUDUNG">
          SONGAYSUDUNG = #SONGAYSUDUNG#
        </isNotEmpty>
        <isNotEmpty prepend=", " property="NGAYHETHANSUDUNG">
          NGAYHETHANSUDUNG = #NGAYHETHANSUDUNG#
        </isNotEmpty>
        <isNotEmpty prepend=", " property="NGUOIKICHHOAT_ID">
          NGUOIKICHHOAT_ID = #NGUOIKICHHOAT_ID#
        </isNotEmpty>
        <isNotEmpty prepend=", " property="NGAYHIEULUC">
          NGAYHIEULUC = #NGAYHIEULUC#
        </isNotEmpty>
        <isNotEmpty prepend=", " property="NGAYKHOAGOI">
          NGAYKHOAGOI = #NGAYKHOAGOI#
        </isNotEmpty>
        <isNotEmpty prepend=", " property="NGUOIKHOAGOI_ID">
          NGUOIKHOAGOI_ID = #NGUOIKHOAGOI_ID#
        </isNotEmpty>
        <isNotEmpty prepend=", " property="NGAYHETHIEULUC">
          NGAYHETHIEULUC = #NGAYHETHIEULUC#
        </isNotEmpty>
        <isNotEmpty prepend=", " property="NGAYFOLLOWUP">
          NGAYFOLLOWUP = #NGAYFOLLOWUP#
        </isNotEmpty>
        <isNotEmpty prepend=", " property="NGAYHETFOLLOWUP">
          NGAYHETFOLLOWUP = #NGAYHETFOLLOWUP#
        </isNotEmpty>
        <isNotEmpty prepend=", " property="NGUOIFOLLOWUP_ID">
          NGUOIFOLLOWUP_ID = #NGUOIFOLLOWUP_ID#
        </isNotEmpty>
        <isNotEmpty prepend=", " property="NGAYCAPNHAT">
          NGAYCAPNHAT = #NGAYCAPNHAT#
        </isNotEmpty>
        <isNotEmpty prepend=", " property="NGUOICAPNHAT_ID">
          NGUOICAPNHAT_ID = #NGUOICAPNHAT_ID#
        </isNotEmpty>
      </isParameterPresent>
      WHERE DANGKY_ID = #DANGKY_ID#
    </update>
    
    <update id="DAO00099_TT_CSKH_GOI_DANGKY_Upt" parameterClass="System.Collections.IDictionary">
      UPDATE TT_CSKH_GOI_DANGKY
      SET 
      SOVOUCHER = #SOVOUCHER#
      ,NGAYCAPNHAT = #NGAYCAPNHAT#
      ,NGUOICAPNHAT_ID = #NGUOICAPNHAT_ID#
      WHERE
      DANGKY_ID = #DANGKY_ID#
      and GOI_ID = #GOI_ID#
      and BENHVIEN_ID = #BENHVIEN_ID#
    </update>
    <update id="DAO00099_TT_CSKH_GOI_DANGKY_CHITIET_Update" parameterClass="System.Collections.IDictionary">
      UPDATE TT_CSKH_GOI_DANGKY_CHITIET
      SET
      SOLANDINHMUC = #SOLANDINHMUC#
      ,NGAYCAPNHAT = #NGAYCAPNHAT#
      ,NGUOICAPNHAT_ID = #NGUOICAPNHAT_ID#
      ,NGAYFOLLOWUP = #NGAYFOLLOWUP#
      ,GHICHU = #GHICHU#
      ,NGAYHETFOLLOWUP = #NGAYHETFOLLOWUP#
      WHERE
      DANGKY_CHITIET_ID = #DANGKY_CHITIET_ID#
      and DANGKY_ID = #DANGKY_ID#
      and DICHVU_ID = #DICHVU_ID#
      and BENHVIEN_ID = #BENHVIEN_ID#
    </update>
    
    <!--Delete-->
     <statement id="DAO00099_TM_CSKH_GOI_Delete" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      delete from TM_CSKH_GOI
      WHERE GOI_ID = #GOI_ID#
    </statement>
    <statement id="DAO00099_TM_CSKH_GOI_CHITIET_Delete" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      delete from TM_CSKH_GOI_CHITIET
      WHERE GOI_ID = #GOI_ID# AND GOI_CHITIET_ID = #GOI_CHITIET_ID#
    </statement>

    <statement id="DAO00099_TT_CSKH_GOI_DANGKY_Delete" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      delete from TT_CSKH_GOI_DANGKY
      WHERE 
      DANGKY_ID = #DANGKY_ID#
      and BENHVIEN_ID = #BENHVIEN_ID#
      
        delete from TT_VIENPHI
    where Ref_id = $DANGKY_ID$
    and Ref_TABLE = 'TT_CSKH_GOI_DANGKY'
    and BENHVIEN_ID = #BENHVIEN_ID#
    </statement>
    <statement id="DAO00099_TT_CSKH_GOI_DANGKY_CHITIET_Delete" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      delete from TT_CSKH_GOI_DANGKY_CHITIET
      WHERE 
      DANGKY_CHITIET_ID = #DANGKY_CHITIET_ID#
      AND DANGKY_ID = #DANGKY_ID#
      and BENHVIEN_ID = #BENHVIEN_ID#
      

    </statement>
  
    <!--Service cho chỉ định dịch vụ-->
    
    <!--Get-->
    <statement id="DAO00099_TM_CSKH_GOI_Service_GetList" resultClass="DataObject">
      select * from TM_CSKH_GOI

      where LOAIGOI_ID in (select DICTIONARY_ID from LST_DICTIONARY where DICTIONARY_CODE = '$DICTIONARY_CODE$'
                                                                        and DICTIONARY_TYPE_CODE = 'LoaiGoiDV')
      <dynamic prepend="and">
        <isParameterPresent>
          <isNotEmpty prepend="and" property="TRANNGTHAI">
            TRANGTHAI = '$TRANGTHAI$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="BENHVIEN_ID">
            BENHVIEN_ID = '$BENHVIEN_ID$'
          </isNotEmpty>      
        </isParameterPresent>
      </dynamic>
    </statement>
    
    <statement id="DAO00099_TT_CSKH_GOI_DANGKY_Service_GetList" resultClass="DataObject">
      select * from TT_CSKH_GOI_DANGKY GDV
      <dynamic prepend="where">
      <isParameterPresent>
        <isNotEmpty prepend="and" property="MADANGKY">
            GDV.MADANGKY = '$MADANGKY$'
          </isNotEmpty>
        <isNotEmpty prepend="and" property="GOI_ID">
            GDV.GOI_ID = '$GOI_ID$'
          </isNotEmpty>
        <isNotEmpty prepend="and" property="BENHNHAN_ID">
            GDV.BENHNHAN_ID = '$BENHNHAN_ID$'
          </isNotEmpty>
        <isNotEmpty prepend="and" property="TRANGTHAI">
          GDV.TRANGTHAI = '$TRANGTHAI$'
        </isNotEmpty>
        <isNotEmpty prepend="and" property="BENHVIEN_ID">
          GDV.BENHVIEN_ID = '$BENHVIEN_ID$'
        </isNotEmpty>      
      </isParameterPresent>
    </dynamic>
    </statement>
    
    <statement id="DAO00099_TT_CSKH_GOI_DANGKY_Service_GetList_01" resultClass="DataObject">
      select GDV.*, GOI.TENGOI, GOI.LOAIGOI_ID from TT_CSKH_GOI_DANGKY GDV
      left join TM_CSKH_GOI GOI on GOI.GOI_ID = GDV.GOI_ID
      where LOAIGOI_ID in (select DICTIONARY_ID from LST_DICTIONARY where DICTIONARY_CODE = '$DICTIONARY_CODE$'
                            and DICTIONARY_TYPE_CODE = 'LoaiGoiDV')      
        <isNotEmpty prepend="and" property="MADANGKY">
          GDV.MADANGKY = '$MADANGKY$'
        </isNotEmpty>
        <isNotEmpty prepend="and" property="GOI_ID">
          GDV.GOI_ID = '$GOI_ID$'
        </isNotEmpty>
        <isNotEmpty prepend="and" property="BENHNHAN_ID">
          GDV.BENHNHAN_ID = '$BENHNHAN_ID$'
        </isNotEmpty>
        <isNotEmpty prepend="and" property="TRANGTHAI">
          GDV.TRANGTHAI in ($TRANGTHAI$)
        </isNotEmpty>
        <isNotEmpty prepend="and" property="BENHVIEN_ID">
          GDV.BENHVIEN_ID = '$BENHVIEN_ID$'
        </isNotEmpty>       
    </statement>
    
    <statement id="DAO00099_TT_CSKH_GOI_DANGKY_CHITIET_Service_GetList" resultClass="DataObject">
      select distinct GDV.MADANGKY, GDV.GOI_ID, GDV.BENHNHAN_ID, GDV.NGAYHETFOLLOWUP as NGAYHETFOLLOWUPOFGOI, DM_GCT.LOAIGIA_ID
      ,GDV_CT.*
      from TT_CSKH_GOI_DANGKY GDV
      right join TT_CSKH_GOI_DANGKY_CHITIET GDV_CT on GDV_CT.DANGKY_ID = GDV.DANGKY_ID
      left join TM_CSKH_GOI_CHITIET DM_GCT on DM_GCT.GOI_ID = GDV.GOI_ID and DM_GCT.DICHVU_ID = GDV_CT.DICHVU_ID
      <dynamic prepend="where">
      <isParameterPresent>
        <isNotEmpty prepend="and" property="DANGKY_ID">
          GDV.DANGKY_ID = '$DANGKY_ID$'
        </isNotEmpty>
        <isNotEmpty prepend="and" property="MADANGKY">
            GDV.MADANGKY = '$MADANGKY$'
          </isNotEmpty>
        <isNotEmpty prepend="and" property="GOI_ID">
            GDV.GOI_ID = '$GOI_ID$'
          </isNotEmpty>
        <isNotEmpty prepend="and" property="BENHNHAN_ID">
            GDV.BENHNHAN_ID = '$BENHNHAN_ID$'
          </isNotEmpty>
        <isNotEmpty prepend="and" property="SOVOUCHER">
            GDV.SOVOUCHER = '$SOVOUCHER$'
        </isNotEmpty>
      <isNotEmpty prepend="and" property="BENHVIEN_ID">
            GDV.BENHVIEN_ID = '$BENHVIEN_ID$'
        </isNotEmpty>
      </isParameterPresent>
    </dynamic>
    </statement>
  
    <!--Update-->
    <update id="DAO00099_TT_CSKH_GOI_DANGKY_CHITIET_Service_Update" parameterClass="System.Collections.IDictionary">
      UPDATE TT_CSKH_GOI_DANGKY_CHITIET
      SET
      SOLANDASUDUNG = isnull(SOLANDASUDUNG, 0) + #SOLANDASUDUNG#
      , SOLANCONLAI = SOLANDINHMUC - (isnull(SOLANDASUDUNG, 0) + #SOLANDASUDUNG#)
      ,NGAYCAPNHAT = #NGAYCAPNHAT#
      ,NGUOICAPNHAT_ID = #NGUOICAPNHAT_ID#
      WHERE
      DANGKY_ID = #DANGKY_ID#
      and DICHVU_ID = #DICHVU_ID#
      and BENHVIEN_ID = #BENHVIEN_ID#
    </update>

    <update id="DAO00099_GiamSoLanSuDung" parameterClass="System.Collections.IDictionary">
      UPDATE TT_CSKH_GOI_DANGKY_CHITIET
      SET
      SOLANDASUDUNG = SOLANDASUDUNG - #SOLUONG#
      <!--, SOLANCONLAI = #SOLANDINHMUC# - (#SOLANDASUDUNG# - #SOLUONG#)-->
      , SOLANCONLAI = SOLANCONLAI + #SOLUONG#
      ,NGAYCAPNHAT = #NGAYCAPNHAT#
      ,NGUOICAPNHAT_ID = #NGUOICAPNHAT_ID#
      WHERE
      DANGKY_ID = #DANGKY_ID#
      and DICHVU_ID = #DICHVU_ID#
      and BENHVIEN_ID = #BENHVIEN_ID#
    </update>
    
    <update id="DAO00099_TT_CSKH_GOI_DANGKY_HuyDangKy" parameterClass="System.Collections.IDictionary">
      UPDATE TT_CSKH_GOI_DANGKY
      SET
      <isParameterPresent>
        <isNotEmpty prepend=" " property="TRANGTHAI">
          TRANGTHAI = #TRANGTHAI#
        </isNotEmpty>
      </isParameterPresent>
      where DANGKY_ID = #DANGKY_ID#
      
      UPDATE TT_VIENPHI
      SET HUY = '1', ACTIVE = '0'
      WHERE VIENPHI_ID = '$VIENPHI_ID$' AND BENHVIEN_ID = '$BENHVIEN_ID$'
    </update>
  </statements> 
</sqlMap>