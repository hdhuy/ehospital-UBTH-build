<?xml version="1.0" encoding="utf-8" ?>
<sqlMap namespace="eHospital" xmlns="http://ibatis.apache.org/mapping" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
  <statements>
    <statement id="DAO00328_GetList" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      SELECT DISTINCT GOI.*, HD_G.HOPDONG_ID
      FROM TM_CSKH_GOI GOI
      INNER JOIN LST_DICTIONARY L ON L.DICTIONARY_ID = GOI.LOAIGOI_ID
      INNER JOIN TT_KSK_HOPDONG_GOIDICHVU HD_G ON HD_G.GOIDICHVU_ID = GOI.GOI_ID
      WHERE GOI.TRANGTHAI='GOIDUOCPHEPBAN' AND L.DICTIONARY_TYPE_CODE = 'LoaiGoiDV' AND L.DICTIONARY_CODE = 'KhamSucKhoe'
      <isNotEmpty prepend="and" property="BENHVIEN_ID">
        GOI.BENHVIEN_ID ='$BENHVIEN_ID$'
      </isNotEmpty>
    </statement>
    <statement id="DAO00328_DeletePatientImport" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      delete
      from TT_KSK_HOPDONG_BENHNHAN
      where HOPDONG_BENHNHAN_ID IN (SELECT * FROM DBO.SPLIT('$HOPDONG_BENHNHAN_ID$',', '))
    </statement>
    <statement id="DAO00328_GetKetQuaKSK" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      SELECT KQ.KETQUA_ID,KQ.TIEPNHAN_ID,KQ.HOPDONG_ID,KQ.HOPDONG_BENHNHAN_ID,SH.MACH,SH.CANNANG,SH.CHIEUCAO,SH.HUYETAPCAO,SH.HUYETAPTHAP,SH.NHIPTHO,SH.NHIETDO,SH.CHISOBMI AS BMI
      ,N.TUANHOAN,N.PLTUANHOAN_ID,N.HOHAP,n.PLHOHAP_ID,N.TIEUHOA,N.PLTIEUHOA_ID,N.THAN,N.PLTHAN_ID,N.NOITIET,N.PLNOITIET_ID
      ,N.COXUONGKHOP,N.PLCOXUONGKHOP_ID,N.THANKINH,N.PLTHANKINH_ID,N.TAMTHAN,N.PLTAMTHAN_ID,N.BACSIKHAMNOI_ID,NG.NGOAIKHOA
      ,NG.PLNGOAIKHOA_ID,NG.BACSINGOAIKHOA_ID,PK.SANPHUKHOA,PK.PLSANPHUKHOA_ID,PK.BACSISANPHUKHOA_ID,MAT.COKINHMATTRAI
      ,MAT.COKINHMATPHAI,MAT.KHONGKINHMATTRAI,MAT.KHONGKINHMATPHAI,MAT.CACBENHVEMAT,MAT.PLMAT_ID,MAT.BACSIMAT_ID
      ,TMH.TAITRAINOITHUONG,TMH.TAITRAINOITHAM,TMH.TAIPHAINOITHUONG,TMH.TAIPHAINOITHAM,TMH.CACBENHVETAI,TMH.PLTAIMH_ID,TMH.BACSITMH_ID
      ,RHM.HAMTREN,RHM.HAMDUOI,RHM.CACBENHVERHM,RHM.PLRHM_ID,RHM.BACSIRHM_ID,DL.DALIEU,DL.PLDALIEU_ID,DL.BACSIDALIEU_ID
      ,KQ.BACSIKETLUAN_ID,KQ.NHANXET,KQ.XEPLOAI_ID,KQ.TENICD
      FROM TT_KSK_KETQUA KQ
      LEFT JOIN TT_KSK_KETQUA_NOI N ON KQ.KETQUA_ID = N.KETQUA_ID
      LEFT JOIN TT_KSK_KETQUA_NGOAI NG ON N.KETQUA_ID=NG.KETQUA_ID
      LEFT JOIN TT_KSK_KETQUA_MAT MAT ON NG.KETQUA_ID=MAT.KETQUA_ID
      LEFT JOIN TT_KSK_KETQUA_PHUKHOA PK ON MAT.KETQUA_ID=PK.KETQUA_ID
      LEFT JOIN TT_KSK_KETQUA_RHM RHM ON PK.HOPDONG_BENHNHAN_ID=RHM.KETQUA_ID
      LEFT JOIN TT_KSK_KETQUA_TMH TMH ON RHM.KETQUA_ID=TMH.KETQUA_ID
      LEFT JOIN TT_KSK_KETQUA_DALIEU DL ON TMH.KETQUA_ID=DL.KETQUA_ID
      LEFT JOIN TT_NGOAITRU_KHAMBENH_SINHHIEU SH ON KQ.TIEPNHAN_ID = SH.TIEPNHAN_ID
      where (DL.HOPDONG_BENHNHAN_ID  = $HOPDONG_BENHNHAN_ID$ and DL.BENHVIEN_ID = '$BENHVIEN_ID$')
      OR (KQ.HOPDONG_BENHNHAN_ID  = $HOPDONG_BENHNHAN_ID$ and KQ.BENHVIEN_ID = '$BENHVIEN_ID$')
      OR (N.HOPDONG_BENHNHAN_ID  = $HOPDONG_BENHNHAN_ID$ and N.BENHVIEN_ID = '$BENHVIEN_ID$')
      OR (NG.HOPDONG_BENHNHAN_ID  = $HOPDONG_BENHNHAN_ID$ and NG.BENHVIEN_ID = '$BENHVIEN_ID$')
      OR (RHM.HOPDONG_BENHNHAN_ID  = $HOPDONG_BENHNHAN_ID$ and RHM.BENHVIEN_ID = '$BENHVIEN_ID$')
      OR (MAT.HOPDONG_BENHNHAN_ID  = $HOPDONG_BENHNHAN_ID$ and MAT.BENHVIEN_ID = '$BENHVIEN_ID$')
      OR (PK.HOPDONG_BENHNHAN_ID  = $HOPDONG_BENHNHAN_ID$ and PK.BENHVIEN_ID = '$BENHVIEN_ID$')
      OR (TMH.HOPDONG_BENHNHAN_ID  = $HOPDONG_BENHNHAN_ID$ and TMH.BENHVIEN_ID = '$BENHVIEN_ID$')
      <!--<dynamic>
        <isParameterPresent>
          <isNotEmpty prepend="and" property="BENHVIEN_ID">
            BENHVIEN_ID = '$BENHVIEN_ID$'
          </isNotEmpty>
        </isParameterPresent>
      </dynamic>-->
    </statement>
    <statement id="DAO00328_GetPatientId" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select BN.*, KQ.KETQUA_ID
      from TT_KSK_HOPDONG_BENHNHAN BN
      left join TT_KSK_KETQUA KQ on KQ.HOPDONG_BENHNHAN_ID = BN.HOPDONG_BENHNHAN_ID
      <dynamic prepend="where">
        <isParameterPresent>
          <isNotEmpty prepend="and" property="BENHNHAN_ID">
            BN.BENHNHAN_ID = $BENHNHAN_ID$
          </isNotEmpty>
          <isNotEmpty prepend="and" property="BENHVIEN_ID">
            BN.BENHVIEN_ID = '$BENHVIEN_ID$'
          </isNotEmpty>
        </isParameterPresent>
      </dynamic>
    </statement>
    <update id="DAO00328_UpdateBenhNhanTonTai" parameterClass="System.Collections.IDictionary">
      update TT_KSK_HOPDONG_BENHNHAN
      set TONTAI = '1'
      where HOPDONG_BENHNHAN_ID = $HOPDONG_BENHNHAN_ID$
    </update>
    <statement id="DAO00328_GetListTiepNhanAll" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select distinct A.SOTIEPNHAN, A.TRAITUYEN, A.NGAYMIENDONGCHITRA, A.TIEPNHAN_ID, A.DOITUONG_ID,
      A.LOAITHANHVIEN_ID, A.SUDUNG_BHTN, A.THE_ID, A.THANHVIEN_ID, A.VIP, A.NGUON_BENHNHAN_ID, A.BAOLANH_VIENPHI,
      B.*, HD.SO_HD + ' - ' + CT.TENCONGTY as TENHOPDONG, G.DESCRIPTION as GENDER, DT.TENDOITUONG, N.DICTIONARY_NAME as NGHENGHIEP
      , case when B.NGAYSINH is null then convert(varchar(4),B.NAMSINH) else convert(varchar(10),B.NGAYSINH,103) end as NGAYTHANGNAMSINH
      from TT_TIEPNHAN A
      inner join TT_BENHNHAN B on B.BENHNHAN_ID = A.BENHNHAN_ID and (A.TRANGTHAI = 'DATIEPNHAN') and B.ACTIVE = '1'
      inner join TT_KSK_HOPDONG_BENHNHAN HD_BN on HD_BN.BENHNHAN_ID = B.BENHNHAN_ID
      inner join TT_KSK_HOPDONG HD on HD.HOPDONG_ID = HD_BN.HOPDONG_ID
      inner join TT_KSK_CONGTY CT on CT.CONGTY_ID = HD.CONGTY_ID
      inner join TM_GENDER G on G.ID = B.GIOITINH
      inner join TM_DOITUONG DT on DT.DOITUONG_ID = A.DOITUONG_ID
      left join LST_DICTIONARY N on N.DICTIONARY_ID = HD_BN.NGHENGHIEP_ID and N.DICTIONARY_TYPE_CODE = 'NgheNghiep'
      where A.BENHVIEN_ID = '$BENHVIEN_ID$' and HD.KHOA = '0' and CT.TAMNGUNG = '0'
    </statement>
  </statements>
</sqlMap>