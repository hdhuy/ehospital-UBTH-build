<?xml version="1.0" encoding="utf-8" ?>
<!--============================================================================
//	CAUTION: This file is generated by IBatisNetGen.3.SQLMap.cst at 11/11/2015 9:27:48 AM
//				Any manual editing will be lost in re-generation.
//===========================================================================-->
<sqlMap namespace="eHospital" xmlns="http://ibatis.apache.org/mapping" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" >

  <statements>
    <!--Add-->
  
    <!--Search-->
    <statement id="DAO00114_TT_HOADON_THUOCMUANGOAI_Search" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select vp.REF_TABLE, A.*, B.SOHOADON AS HOADONLIENQUAN, bn.MAYTE
      , CASE ISNULL(BN.NGAYSINH,'')
      WHEN '' THEN CONVERT(VARCHAR(10), BN.NAMSINH)
      ELSE CONVERT(VARCHAR(10), BN.NGAYSINH, 103)
      END AS NAMSINH
      from TT_HOADON A
      LEFT JOIN  TT_HOADON B ON A.HOADONLIENQUAN_ID = B.HOADON_ID
      inner join TT_VIENPHI VP on VP.HOADON_ID = A.HOADON_ID and vp.REF_TABLE like '%TT_DUOC_CHUNGTU%'
      left join TT_BENHNHAN bn on bn.BENHNHAN_ID = a.BENHNHAN_ID
      <dynamic prepend="where(">
        <isParameterPresent>
          <isNotEmpty prepend="and" property="DATHANHTOAN">
            A.DATHANHTOAN = '$DATHANHTOAN$'
            and (A.HUYHOADON is null or A.HUYHOADON = '0')
            and (A.HOANTRA is null or A.HOANTRA = '0')
          </isNotEmpty>
          <isNotEmpty prepend="or" property="HUYHOADON">
            A.HUYHOADON = '$HUYHOADON$'
          </isNotEmpty>
          <isNotEmpty prepend="or" property="HOANTRA">
            A.HOANTRA = '$HOANTRA$'
          </isNotEmpty>
          <isNotEmpty prepend="or" property="CHUATHANHTOAN">
            A.DATHANHTOAN = 0
          </isNotEmpty>
          )
          <isNotEmpty prepend="and" property="TIEPNHAN_ID">
            A.TIEPNHAN_ID = '$TIEPNHAN_ID$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="TUKHOA">
            A.SOHOADON like '%$TUKHOA$%'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="TENBENHNHAN">
            (bn.TENBENHNHAN like N'%$TENBENHNHAN$%' or bn.MAYTE like N'%$TENBENHNHAN$%')
          </isNotEmpty>
          <isNotEmpty prepend="and" property="TUNGAY">
            convert(date,A.NGAYHOADON) between convert(date, '$TUNGAY$') and convert(date, '$DENNGAY$')
          </isNotEmpty>
          <isNotEmpty prepend="and" property="TRANGTHAI">
            A.TRANGTHAI = '$TRANGTHAI$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="USER_ID">
            (A.NGUOICAPNHAT_ID = '$USER_ID$' or A.NGUOITAO_ID = '$USER_ID$')
          </isNotEmpty>
          <isNotEmpty prepend="and" property="BENHNHAN_ID">
            A.BENHNHAN_ID = '$BENHNHAN_ID$'
          </isNotEmpty>
        </isParameterPresent>
      </dynamic>
      order by A.NGAYHOADON

    </statement>
    <statement id="DAO00114_BIENLAI_THUOCMUANGOAI_Search" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select distinct NGOAITRU_TOATHUOC_NGUOIMUA_ID,A.*, B.SOHOADON AS HOADONLIENQUAN, bn.MAYTE
      , CASE ISNULL(BN.NGAYSINH,'')
      WHEN '' THEN CONVERT(VARCHAR(10), BN.NAMSINH)
      ELSE CONVERT(VARCHAR(10), BN.NGAYSINH, 103)
      END AS NAMSINH, ntba.SOBENHAN, bn.TENBENHNHAN
      , ntba.TRANGTHAI as TRANGTHAINOITRU, tn.TRANGTHAI as TRANGTHAINGOAITRU
      , bn.DIACHITHUONGTRU as DIACHI, dt.MADOITUONG
      from TT_HOADON A LEFT JOIN  TT_HOADON B ON A.HOADONLIENQUAN_ID = B.HOADON_ID
      left join TT_HOADON_CHITIET_NGOAITRU hdct on hdct.HOADON_ID = a.HOADON_ID and ref_table = 'TT_DUOC_CHUNGTU_CHITIET'
      left join TT_DUOC_CHUNGTU_CHITIET ctct on ctct.CHUNGTUCHITIET_ID = hdct.REF_ID
      left join TT_DUOC_CHUNGTU ct on ct.CHUNGTU_ID = ctct.chungtu_id
      left join TT_TIEPNHAN tn on tn.TIEPNHAN_ID = a.TIEPNHAN_ID
      left join TT_BENHNHAN bn on bn.BENHNHAN_ID = a.BENHNHAN_ID
      left join TM_DOITUONG DT on DT.DOITUONG_ID = tn.doituong_id
      left join TT_NOITRU_BENHAN ntba on ntba.TIEPNHAN_ID = a.TIEPNHAN_ID
      <dynamic prepend="where(">
        <isParameterPresent>          
          <isNotEmpty prepend="and" property="DATHANHTOAN">
            A.DATHANHTOAN = '$DATHANHTOAN$'
          </isNotEmpty>
          <isNotEmpty prepend="or" property="HUYHOADON">
            A.HUYHOADON = '$HUYHOADON$'
          </isNotEmpty>
          <isNotEmpty prepend="or" property="HOANTRA">
            A.HOANTRA = '$HOANTRA$'
          </isNotEmpty>
          <isNotEmpty prepend="or" property="CHUATHANHTOAN">
            A.DATHANHTOAN = 0
          </isNotEmpty>
          )
          <isNotEmpty prepend="and" property="TIEPNHAN_ID">
            A.TIEPNHAN_ID = '$TIEPNHAN_ID$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="TUKHOA">
            A.SOHOADON like '%$TUKHOA$%'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="TENBENHNHAN">
            (bn.TENBENHNHAN like N'%$TENBENHNHAN$%' or bn.MAYTE like N'%$TENBENHNHAN$%')
          </isNotEmpty>
          <isNotEmpty prepend="and" property="TUNGAY">
            convert(date,A.NGAYHOADON) between convert(date, '$TUNGAY$') and convert(date, '$DENNGAY$')
          </isNotEmpty>
          <isNotEmpty prepend="and" property="TRANGTHAI">
            A.TRANGTHAI = '$TRANGTHAI$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="USER_ID">
            (A.NGUOICAPNHAT_ID = '$USER_ID$' or A.NGUOITAO_ID = '$USER_ID$')
          </isNotEmpty>
        </isParameterPresent>
      </dynamic>
      and a.HOADON_ID in
      (
      select vp.HOADON_ID
      from TT_VIENPHI vp
      where vp.REF_TABLE like '%TT_DUOC_CHUNGTU%'
      )
      order by A.NGAYHOADON

    </statement>
    <!--Get-->
  <statement id="DAO00114_CHUNGTUTHUOC_MUANGOAI_THANHTOAN_GetList" resultClass="DataObject">
    select  a.*, b.GIATRIMIENGIAM_BH, c.GIATRIMIENGIAM_BHTN, f.GIATRIMIENGIAM_THANHVIEN, g.GIATRIMIENGIAM_CTCT
    from
    (select VP.*, ct.SOCHUNGTU, bn.MAYTE, bn.TENBENHNHAN, bn.GIOITINH, bn.NGAYSINH
    , bn.DIACHI, bn.NGAYTHANGNAMSINH
    , bn.SONHA, bn.XAPHUONG_ID, bn.SODIENTHOAI, bn.NGHENGHIEP_ID, ct.MUCDICHCHUNGTU_ID, tn.SUDUNG_BHTN
    from TT_VIENPHI vp
    inner join TT_DUOC_CHUNGTU_CHITIET ctct on ctct.CHUNGTUCHITIET_ID= vp.REF_ID
    left join TT_DUOC_CHUNGTU ct on ct.CHUNGTU_ID = ctct.CHUNGTU_ID
    left join TT_TIEPNHAN tn on tn.TIEPNHAN_ID = vp.TIEPNHAN_ID
    left join
    ( select bn.BENHNHAN_ID,bn.MAYTE, bn.TENBENHNHAN, bn.GIOITINH, bn.NGAYSINH
    , bn.DIACHI, isnull(convert(varchar, NGAYSINH, 103), convert(varchar, NAMSINH)) as NGAYTHANGNAMSINH
    , bn.SONHA, bn.XAPHUONG_ID, bn.SODIENTHOAI, bn.NGHENGHIEP_ID
    from TT_BENHNHAN bn where bn.BENHNHAN_ID = '$BENHNHAN_ID$')bn on bn.BENHNHAN_ID = ct.BENHNHAN_ID
    where ct.CHUNGTU_ID = '$CHUNGTU_ID$'
    and vp.BENHVIEN_ID = '$BENHVIEN_ID$'
    and vp.ref_table like '%TT_DUOC_CHUNGTU_CHITIET%'
    and ct.MUCDICHCHUNGTU_ID in (select DICTIONARY_ID from LST_DICTIONARY where DICTIONARY_CODE = 'X08')
    and vp.DATHANHTOAN = '0') a

    left join (select VIENPHI_ID,
    sum(MGCT.GIATRIMIENGIAM) AS GIATRIMIENGIAM_BH from TT_MIENGIAM MG
    INNER JOIN TT_MIENGIAM_CHITIET MGCT ON MG.MIENGIAM_ID = MGCT.MIENGIAM_ID
    where MG.BENHNHAN_ID= '$BENHNHAN_ID$' and MGCT.REF_TABLE = 'TT_MIENGIAM' and MG.TINHTRANG = 1 group by VIENPHI_ID
    ) b on a.VIENPHI_ID = b.VIENPHI_ID

    left join (select VIENPHI_ID, sum(MGCT.GIATRIMIENGIAM) AS GIATRIMIENGIAM_BHTN
    from TT_MIENGIAM_BHTN MG
    INNER JOIN TT_MIENGIAM_CHITIET MGCT ON MG.MIENGIAM_BHTN_ID = MGCT.MIENGIAM_ID
    where  MG.BENHNHAN_ID= '$BENHNHAN_ID$' and MGCT.REF_TABLE = 'TT_MIENGIAM_BHTN' and MG.TINHTRANG = 1 group by VIENPHI_ID
    )c on a.VIENPHI_ID = c.VIENPHI_ID

    left join (select VIENPHI_ID, sum(MGCT.GIATRIMIENGIAM) AS GIATRIMIENGIAM_THANHVIEN
    from TT_MIENGIAM_THANHVIEN MG
    INNER JOIN TT_MIENGIAM_CHITIET MGCT ON MG.MIENGIAM_THANHVIEN_ID = MGCT.MIENGIAM_ID
    where MG.BENHNHAN_ID= '$BENHNHAN_ID$' and MGCT.REF_TABLE = 'TT_MIENGIAM_THANHVIEN' and MG.TINHTRANG = 1 group by VIENPHI_ID
    )f on a.VIENPHI_ID = f.VIENPHI_ID

    left join(select VIENPHI_ID, sum(MGCT.GIATRIMIENGIAM) AS GIATRIMIENGIAM_CTCT
    from TT_MIENGIAM_CONGTY MG
    INNER JOIN TT_MIENGIAM_CHITIET MGCT ON MG.MIENGIAM_CONGTY_ID = MGCT.MIENGIAM_ID
    where MG.BENHNHAN_ID= '$BENHNHAN_ID$' and MGCT.REF_TABLE = 'TT_MIENGIAM_CONGTY' and MG.TINHTRANG = 1 group by VIENPHI_ID
    )g on a.VIENPHI_ID = g.VIENPHI_ID

  </statement>
    <statement id="DAO00114_CHUNGTUTHUOC_MUANGOAI_DaThanhToan_GetList" resultClass="DataObject">
      select VP.*, ct.MUCDICHCHUNGTU_ID
      from TT_VIENPHI vp
      inner join TT_DUOC_CHUNGTU_CHITIET ctct on ctct.CHUNGTUCHITIET_ID= vp.REF_ID
      left join TT_DUOC_CHUNGTU ct on ct.CHUNGTU_ID = ctct.CHUNGTU_ID      
      where CT.CHUNGTU_ID = '$CHUNGTU_ID$'
      and VP.BENHVIEN_ID = '$BENHVIEN_ID$'
      and vp.ref_table = 'TT_DUOC_CHUNGTU_CHITIET'
      and ct.MUCDICHCHUNGTU_CODE = 'X08'
      and vp.DATHANHTOAN = '1'

    </statement>
    <statement id="DAO00114_CHUNGTUTHUOC_MUANGOAI_GetList" resultClass="DataObject">
      select ct.*, bn.mayte
      from TT_DUOC_CHUNGTU ct      
      left join TT_BENHNHAN bn on bn.benhnhan_id = ct.benhnhan_id
      where ct.MUCDICHCHUNGTU_CODE = 'X08'
      <isParameterPresent>
        <isNotEmpty prepend="and" property="BENHVIEN_ID">
          CT.BENHVIEN_ID = '$BENHVIEN_ID$'
        </isNotEmpty>
        <isNotEmpty prepend="and" property="NGUOITAO_ID">
          CT.NGUOITAO_ID = '$NGUOITAO_ID$'
        </isNotEmpty>
      </isParameterPresent>    
    </statement>
    <statement id="DAO00114_CHUNGTUTHUOC_MUANGOAI_GetList_BIL12" resultClass="DataObject">
      select distinct ct.*, isnull(bn.MAYTE, 'VANGLAI') as MAYTE, isnull(bn.NAMSINH, ntnm.NAMSINH) as NAMSINH
      from TT_DUOC_CHUNGTU ct
      left join TT_BENHNHAN bn on bn.benhnhan_id = ct.benhnhan_id
      inner join TT_DUOC_CHUNGTU_CHITIET ctct on ct.CHUNGTU_ID = ctct.CHUNGTU_ID
      left join TT_NGOAITRU_TOATHUOC_NGUOIMUA ntnm on ntnm.NGOAITRU_TOATHUOC_NGUOIMUA_ID = ct.NGOAITRU_TOATHUOC_NGUOIMUA_ID
      inner join TT_VIENPHI vp on vp.REF_ID = ctct.CHUNGTUCHITIET_ID and REF_TABLE = 'TT_DUOC_CHUNGTU_CHITIET' and vp.DATHANHTOAN = '0'
      where      
      ct.MUCDICHCHUNGTU_CODE = 'X08'
      and ct.BENHVIEN_ID = '$BENHVIEN_ID$'
      order by ct.MACHUNGTU desc
    </statement>
    <statement id="DAO00114_CHUNGTUTHUOC_MUANGOAI_ChiTiet_BIL12" resultClass="DataObject">
      select distinct ct.*, isnull(bn.MAYTE, 'VANGLAI') as MAYTE, isnull(bn.NAMSINH, ntnm.NAMSINH) as NAMSINH
      from TT_DUOC_CHUNGTU ct
      left join TT_BENHNHAN bn on bn.benhnhan_id = ct.benhnhan_id
      inner join TT_DUOC_CHUNGTU_CHITIET ctct on ct.CHUNGTU_ID = ctct.CHUNGTU_ID
      left join TT_NGOAITRU_TOATHUOC_NGUOIMUA ntnm on ntnm.NGOAITRU_TOATHUOC_NGUOIMUA_ID = ct.NGOAITRU_TOATHUOC_NGUOIMUA_ID
      inner join TT_VIENPHI vp on vp.REF_ID = ctct.CHUNGTUCHITIET_ID and REF_TABLE = 'TT_DUOC_CHUNGTU_CHITIET' and vp.DATHANHTOAN = '0' and vp.REF_ID = '$CHUNGTUCHITIET_ID$'
      where      
      ct.MUCDICHCHUNGTU_CODE = 'X08'
      and ct.BENHVIEN_ID = '$BENHVIEN_ID$'
      order by ct.MACHUNGTU desc
    </statement>
    <statement id="DAO00114_CHUNGTUTHUOC_MUANGOAI_CHITIET_DATA_BIL12" resultClass="DataObject">
      select distinct ct.*, isnull(bn.MAYTE, 'VANGLAI') as MAYTE, isnull(bn.NAMSINH, ntnm.NAMSINH) as NAMSINH
      from TT_DUOC_CHUNGTU ct
      left join TT_BENHNHAN bn on bn.benhnhan_id = ct.benhnhan_id
      inner join TT_DUOC_CHUNGTU_CHITIET ctct on ct.CHUNGTU_ID = ctct.CHUNGTU_ID
      left join TT_NGOAITRU_TOATHUOC_NGUOIMUA ntnm on ntnm.NGOAITRU_TOATHUOC_NGUOIMUA_ID = ct.NGOAITRU_TOATHUOC_NGUOIMUA_ID
      inner join TT_VIENPHI vp on vp.REF_ID = ctct.CHUNGTUCHITIET_ID and REF_TABLE = 'TT_DUOC_CHUNGTU_CHITIET' and vp.HOADON_ID = '$HOADON_ID$'
      where      
      ct.MUCDICHCHUNGTU_CODE = 'X08'
      and ct.BENHVIEN_ID = '$BENHVIEN_ID$' <!--and ct.BENHNHAN_ID = '$BENHNHAN_ID$'-->
      order by ct.MACHUNGTU desc
    </statement>
<statement id="DAO00114_CHUNGTUTHUOC_MUANGOAI_Get" resultClass="DataObject">
  select bn.MAYTE, ct.*
  from TT_DUOC_CHUNGTU ct  
  left join TT_BENHNHAN bn on bn.BENHNHAN_ID = ct.BENHNHAN_ID  
      <dynamic prepend="where">
        <isParameterPresent>
          <isNotEmpty prepend="and" property="CHUNGTU_ID">
            CT.CHUNGTU_ID = '$CHUNGTU_ID$'
          </isNotEmpty>          
          <isNotEmpty prepend="and" property="BENHVIEN_ID">
            CT.BENHVIEN_ID = '$BENHVIEN_ID$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="NGUOITAO_ID">
            CT.NGUOITAO_ID = '$NGUOITAO_ID$'
          </isNotEmpty>
        </isParameterPresent>
      </dynamic>
    </statement>
    <!--update-->

  </statements>   
</sqlMap>