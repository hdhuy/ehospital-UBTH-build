<?xml version="1.0" encoding="utf-8" ?>
<!--============================================================================
//	CAUTION: This file is generated by IBatisNetGen.3.SQLMap.cst at 10/3/2016 10:12:54 AM
//				Any manual editing will be lost in re-generation.
//===========================================================================-->
<sqlMap namespace="eHospital" xmlns="http://ibatis.apache.org/mapping" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
  <statements>
    <statement id="DAO00315_GetList" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select * from TM_NHOM_ABO
    </statement>
    <statement id="DAO00315_AddNew" parameterClass="System.Collections.IDictionary" resultClass="System.Int64">
      insert into TT_MAU_DANGKYMAU (
      SOPHIEU
      , NGAYYEUCAU
      , THOIGIANYEUCAU
      , NAMYEUCAU
      , THANGYEUCAU
      , BACSICHIDINH_ID
      , NOICHIDINH_ID
      , BENHNHAN_ID
      , TIEPNHAN_ID
      , BENHAN_ID
      , NHOM_ABO
      , NHOM_RH
      , PHENOTYPE
      , KHANGTHEBT
      , TRONGYEU
      , TRONGDOI
      , SOLUONG
      , TRANGTHAI
      , GHICHU
      , BENHVIEN_ID
      , NGAYTAO
      , NGUOITAO_ID
      , NGAYCAPNHAT
      , NGUOICAPNHAT_ID
      )
      VALUES
      (
      #SOPHIEU#
      , getdate()
      , getdate()
      , YEAR(GETDATE())
      , MONTH(GETDATE())
      , #BACSICHIDINH_ID#
      , #NOICHIDINH_ID#
      , #BENHNHAN_ID#
      , #TIEPNHAN_ID#
      , #BENHAN_ID#
      , #NHOM_ABO#
      , #NHOM_RH#
      , #PHENOTYPE#
      , #KHANGTHEBT#
      , #TRONGYEU#
      , #TRONGDOI#
      , #SOLUONG#
      , #TRANGTHAI#
      , #GHICHU#
      , #BENHVIEN_ID#
      , getdate()
      , #NGUOITAO_ID#
      , null
      , null
      )
      select SCOPE_identity() as value
    </statement>
    
    <update id="DAO00315_Update" parameterClass="System.Collections.IDictionary">
      update TT_MAU_DANGKYMAU set
      SOPHIEU = #SOPHIEU#
      , NGAYYEUCAU = #NGAYYEUCAU#
      , THOIGIANYEUCAU = #THOIGIANYEUCAU#
      , NAMYEUCAU = #NAMYEUCAU#
      , THANGYEUCAU = #THANGYEUCAU#
      , BACSICHIDINH_ID = #BACSICHIDINH_ID#
      , NOICHIDINH_ID = #NOICHIDINH_ID#
      , BENHNHAN_ID = #BENHNHAN_ID#
      , NHOM_ABO = #NHOM_ABO#
      , NHOM_RH = #NHOM_RH#
      , PHENOTYPE = #PHENOTYPE#
      , KHANGTHEBT = #KHANGTHEBT#
      , TRONGYEU = #TRONGYEU#
      , TRONGDOI = #TRONGDOI#
      , SOLUONG = #SOLUONG#
      , TRANGTHAI = #TRANGTHAI#
      , GHICHU = #GHICHU#      
      , NGAYCAPNHAT = #NGAYCAPNHAT#
      , NGUOICAPNHAT_ID = #NGUOICAPNHAT_ID#
      where
      DANGKYMAU_ID = '$DANGKYMAU_ID$'
    </update>

    <statement id="DAO00315_Delete" parameterClass="System.Collections.IDictionary" resultClass="System.Int32">
      DELETE FROM TT_MAU_DANGKYMAU_CHITIET WHERE DANGKYMAU_ID = '$DANGKYMAU_ID$'
      DELETE FROM TT_MAU_DANGKYMAU WHERE DANGKYMAU_ID = '$DANGKYMAU_ID$'
    </statement>
  
    <statement id="DAO00315_AddDetails" parameterClass="System.Collections.IDictionary" resultClass="System.Int64">
      DELETE FROM TT_MAU_DANGKYMAU_CHITIET WHERE DANGKYMAU_ID = '$DANGKYMAU_ID$'

      declare @json nvarchar(max) =  N'$JSON_DATA$';

      INSERT INTO TT_MAU_DANGKYMAU_CHITIET (
      DANGKYMAU_ID
      , MAU_ID      
      , SOLUONGYEUCAU
      , DONVITINH_ID
      , LOAISANPHAM
      , NHOM_ABO
      , NHOM_RH
      , SOLUONGCAPPHAT
      , GHICHU
      , KHOXUAT_ID
      , TRANGTHAI
      , BENHVIEN_ID
      , NGAYTAO
      , NGUOITAO_ID
      )
      SELECT * FROM OPENJSON(@json)
      WITH (
      DANGKYMAU_ID int
      , MAU_ID int      
      , SOLUONGYEUCAU int
      , DONVITINH_ID int
      , LOAISANPHAM varchar(20)
      , NHOM_ABO varchar(5)
      , NHOM_RH varchar(5)
      , SOLUONGCAPPHAT int
      , GHICHU nvarchar(200)
      , KHO_ID int
      , TRANGTHAI varchar(20)
      , BENHVIEN_ID varchar(10)
      , NGAYTAO datetime
      , NGUOITAO_ID int
      )
    </statement>
   
    <statement id="DAO00315_GetDangKyMau" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select dk.*, ba.SOBENHAN
      from TT_MAU_DANGKYMAU dk
      left join TT_NOITRU_BENHAN ba on dk.BENHAN_ID = ba.BENHAN_ID
      where dk.DANGKYMAU_ID = '$DANGKYMAU_ID$'
    </statement>
    <statement id="DAO00315_GetDangKyMauChiTiet" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      SELECT  ct.* ,
      m.MAMAU ,
      m.TENMAU ,
      lm.MALOAIMAU ,
      lm.TENLOAIMAU ,
      lm.LOAIMAU_ID ,
      m.THANHPHAN,
      STT = ROW_NUMBER() over(order by ct.DANGKYMAUCHITIET_ID),
      NGUOICHIDINH = NV.TENNHANVIEN,
      NOICHIDINH = NCD.TENPHONGBAN,
      THOIGIANCHIDINH = DK.THOIGIANYEUCAU, DVT.TENDONVITINH, 
      (CONVERT(VARCHAR, CT.SOLUONGYEUCAU*ISNULL(DVT.DUNGTICH,0))+' '+DVT.DONVI) TOTAL_DONVITINH
      FROM    TT_MAU_DANGKYMAU_CHITIET ct
      JOIN dbo.TT_MAU_DANGKYMAU dk ON dk.DANGKYMAU_ID = ct.DANGKYMAU_ID
      JOIN TM_MAU m ON m.MAU_ID = ct.MAU_ID
      JOIN TM_MAU_LOAIMAU lm ON lm.LOAIMAU_ID = m.LOAIMAU_ID
      JOIN TM_MAU_DONVITINH DVT ON m.DONVITINH_ID = DVT.DONVITINH_ID
      LEFT JOIN dbo.TM_PHONGBAN ncd ON ncd.PHONGBAN_ID = dk.NOICHIDINH_ID
      LEFT JOIN dbo.TM_NHANVIEN nv ON nv.NHANVIEN_ID = dk.BACSICHIDINH_ID
      where ct.DANGKYMAU_ID = '$DANGKYMAU_ID$'
      <isNotEmpty prepend="and" property="BENHVIEN_ID">
      ct.BENHVIEN_ID = '$BENHVIEN_ID$'
    </isNotEmpty>
    </statement>
    
      <statement id="DAO00315_GetDangKyMau_XuatBenhNhan" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
        select dk.*,
        bn.TENBENHNHAN,
        CASE WHEN BN.GIOITINH = 1 THEN N'Nam' WHEN BN.GIOITINH = 2 THEN N'Nữ' END AS GIOITINH,
        CASE WHEN BN.NGAYSINH IS NOT NULL THEN CONVERT(VARCHAR(10), BN.NGAYSINH, 103) ELSE ' - ' + CONVERT(VARCHAR(10), BN.NAMSINH) END AS NGAYSINH,
        dt.TENDOITUONG AS DOITUONG
        from TT_MAU_DANGKYMAU dk
        left join TT_NOITRU_BENHAN ba on dk.BENHAN_ID = ba.BENHAN_ID
        left join TT_BENHNHAN bn on dk.BENHNHAN_ID = bn.BENHNHAN_ID
        left join dbo.TM_DOITUONG dt on dt.DOITUONG_ID = ba.DOITUONG_ID
        where dk.DANGKYMAU_ID = '$DANGKYMAU_ID$'
      </statement>
    <statement id="DAO00315_GetDangKyMauChiTiet_XuatBenhNhan" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      SELECT  ct.* ,
      m.MAMAU ,
      m.TENMAU ,
      lm.MALOAIMAU ,
      lm.TENLOAIMAU ,
      lm.LOAIMAU_ID ,
      m.THANHPHAN,      
      NGUOICHIDINH = NV.TENNHANVIEN,
      NOICHIDINH = NCD.TENPHONGBAN,
      THOIGIANCHIDINH = DK.THOIGIANYEUCAU
      FROM TT_MAU_DANGKYMAU_CHITIET ct
      JOIN TT_MAU_DANGKYMAU dk ON dk.DANGKYMAU_ID = ct.DANGKYMAU_ID
      LEFT JOIN dbo.TM_PHONGBAN ncd ON ncd.PHONGBAN_ID = dk.NOICHIDINH_ID
      LEFT JOIN dbo.TM_NHANVIEN nv ON nv.NHANVIEN_ID = dk.BACSICHIDINH_ID
      JOIN TM_MAU m ON m.MAU_ID = ct.MAU_ID
      JOIN TM_MAU_LOAIMAU lm ON lm.LOAIMAU_ID = m.LOAIMAU_ID
      where ct.DANGKYMAU_ID = '$DANGKYMAU_ID$'
      <isNotEmpty prepend="and" property="BENHVIEN_ID">
        ct.BENHVIEN_ID = '$BENHVIEN_ID$'
      </isNotEmpty>
    </statement>
    
    <statement id="DAO00315_FindBlank" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select ROW_NUMBER() over(order by dk.DANGKYMAU_ID) as STT, dk.*
      , nv.TENNHANVIEN as BACSICHIDINH
      , dk.SOPHIEU AS SOPHIEUMAU
      , case when dk.TRANGTHAI='CHUAXUAT' then N'Chưa xuất' else N'Đã xuất' end TRANGTHAIPHIEU
      , bn.TENBENHNHAN
      , GIOITINH = CASE WHEN BN.GIOITINH = 1 THEN N'Nam' ELSE N'Nữ' END
      , NGAYSINH = CASE WHEN BN.NGAYSINH IS NOT NULL THEN CONVERT(VARCHAR(20), BN.NGAYSINH, 103) ELSE CAST(bn.NAMSINH AS VARCHAR(10)) END
      , DOITUONG = DT.TENDOITUONG
      FROM TT_MAU_DANGKYMAU dk
      left join TM_NHANVIEN nv on nv.NHANVIEN_ID = dk.BACSICHIDINH_ID
      JOIN dbo.TT_BENHNHAN bn ON bn.BENHNHAN_ID = dk.BENHNHAN_ID
      JOIN (SELECT idx = ROW_NUMBER() OVER(PARTITION BY BENHNHAN_ID ORDER BY TIEPNHAN_ID DESC)
      ,TIEPNHAN_ID, DOITUONG_ID,BENHNHAN_ID
      FROM dbo.TT_TIEPNHAN)TN ON TN.BENHNHAN_ID = bn.BENHNHAN_ID AND TN.idx = 1
      JOIN dbo.TM_DOITUONG dt ON dt.DOITUONG_ID = TN.DOITUONG_ID
      <dynamic prepend="where">
      <isParameterPresent>
        <isNotEmpty prepend="and" property="TUNGAY">
          convert(date,dk.NGAYYEUCAU) between convert(date,'$TUNGAY$') and convert(date,'$DENNGAY$')
        </isNotEmpty>
        <isNotEmpty prepend="and" property="SOPHIEU">
          dk.SOPHIEU like '%' + #SOPHIEU# + '%'
        </isNotEmpty>
        <isNotEmpty prepend="and" property="BENHNHAN_ID">
          dk.BENHNHAN_ID = '$BENHNHAN_ID$'
        </isNotEmpty>
      </isParameterPresent>
    </dynamic>
    </statement>
    
  </statements>
</sqlMap>
