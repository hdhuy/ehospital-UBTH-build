<?xml version="1.0" encoding="utf-8" ?>
<!--============================================================================
//	CAUTION: This file is generated by IBatisNetGen.3.SQLMap.cst at 11/11/2015 9:27:48 AM
//				Any manual editing will be lost in re-generation.
//===========================================================================-->
<sqlMap namespace="eHospital" xmlns="http://ibatis.apache.org/mapping" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" >

  <statements>
    <!--Add-->
    <statement id="DAO00111_TT_HOADON_CHUNGTU_Add" parameterClass="HashTable" resultClass="System.Int64">
      INSERT INTO TT_HOADON_CHUNGTU
      (
      BENHNHAN_ID
      ,LOAI_HOADON_CHUNGTU_ID
      ,SOHOADON
      ,NGAYHOADON
      ,GIATRIHOADON
      ,INLAI
      ,TENKHACHHANG
      ,TENCONGTY
      ,DIACHICONGTY
      ,MASOTHUE
      ,HINHTHUCTHANHTOAN
      ,SOTAIKHOAN
      ,NGUOIDAIDIEN
      ,TRANGTHAI
      ,BENHVIEN_ID
      ,NGAYTAO
      ,NGUOITAO_ID
      ,NGAYCAPNHAT
      ,NGUOICAPNHAT_ID
      )
      VALUES
      (
      #BENHNHAN_ID#
      ,#LOAI_HOADON_CHUNGTU_ID#
      ,#SOHOADON#
      ,#NGAYHOADON#
      ,#GIATRIHOADON#
      ,#INLAI#
      ,#TENKHACHHANG#
      ,#TENCONGTY#
      ,#DIACHICONGTY#
      ,#MASOTHUE#
      ,#HINHTHUCTHANHTOAN#
      ,#SOTAIKHOAN#
      ,#NGUOIDAIDIEN#
      ,#TRANGTHAI#
      ,#BENHVIEN_ID#
      ,#NGAYTAO#
      ,#NGUOITAO_ID#
      ,#NGAYCAPNHAT#
      ,#NGUOICAPNHAT_ID#
      )

      select SCOPE_identity() as value
    </statement>

    <statement id="DAO00111_TT_HOADON_CHUNGTU_CHITIET_Add" parameterClass="HashTable" resultClass="System.Int64">

      INSERT INTO TT_HOADON_CHUNGTU_CHITIET
      (
      HOADON_CHUNGTU_ID
      ,HOADONLIENQUAN_ID
      ,NGAYHOADON
      ,GIATRIHOADON
      ,INLAI
      ,TRANGTHAI
      ,BENHVIEN_ID
      ,NGAYTAO
      ,NGUOITAO_ID
      ,NGAYCAPNHAT
      ,NGUOICAPNHAT_ID
      )
      VALUES
      (
      #HOADON_CHUNGTU_ID#
      ,#HOADONLIENQUAN_ID#
      ,#NGAYHOADON#
      ,#GIATRIHOADON#
      ,#INLAI#
      ,#TRANGTHAI#
      ,#BENHVIEN_ID#
      ,#NGAYTAO#
      ,#NGUOITAO_ID#
      ,#NGAYCAPNHAT#
      ,#NGUOICAPNHAT_ID#
      )
      <!--select SCOPE_identity() as value-->
    </statement>

    <!--Search-->
    <statement id="DAO00111_TT_HOADON_CHUNGTU_Search" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select HD.*
      from TT_HOADON_CHUNGTU HD
      <!--left join TT_HOADON_CHUNGTU_CHITIET HDCT on hdct.HOADON_CHUNGTU_CHITIET_ID = hd.HOADON_CHUNGTU_ID-->
      <dynamic prepend="where">
        <isParameterPresent>
          <isNotEmpty prepend="and" property="TUKHOA">
            (HD.SOHOADON like '%' + #TUKHOA# + '%'
            or HD.TENKHACHHANG like '%' + #TUKHOA# + '%')
          </isNotEmpty>
          <isNotEmpty prepend="and" property="TUKHOA1">
            HD.TENKHACHHANG like '%' + #TUKHOA1# + '%'
            <!--or BN.MAYTE like '%$TUKHOA1$%'-->
          </isNotEmpty>
          <isNotEmpty prepend="and" property="TUKHOA2">
            HD.SOHOADON like '%' + #TUKHOA2# + '%'
          </isNotEmpty>
          <!--<isNotEmpty prepend="and" property="USER_ID">
            (HD.NGUOIDUYET_ID = '$USER_ID$' or MG.NGUOITAO_ID = '$USER_ID$')
          </isNotEmpty>-->
          <isNotEmpty prepend="and" property="BENHNHAN_ID">
            HD.BENHNHAN_ID = '$BENHNHAN_ID$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="BENHVIEN_ID">
            HD.BENHVIEN_ID = '$BENHVIEN_ID$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="TRANGTHAI">
            HD.TRANGTHAI = '$TRANGTHAI$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="TUNGAY">
            convert(date, HD.NGAYTAO) between convert(date, '$TUNGAY$') and convert(date, '$DENNGAY$')
          </isNotEmpty>

        </isParameterPresent>
      </dynamic>
      ORDER BY HD.HOADON_CHUNGTU_ID DESC
    </statement>
    
    <!--Get-->
    <statement id="DAO00111_TT_HOADON_CHUNGTU_Get" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select HD.*
      from TT_HOADON_CHUNGTU HD
      <dynamic prepend="where">
        <isParameterPresent>
          <isNotEmpty prepend="and" property="HOADON_CHUNGTU_ID">
            HD.HOADON_CHUNGTU_ID = '$HOADON_CHUNGTU_ID$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="BENHVIEN_ID">
            HD.BENHVIEN_ID = '$BENHVIEN_ID$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="TRANGTHAI">
            HD.TRANGTHAI = '$TRANGTHAI$'
          </isNotEmpty>
        </isParameterPresent>
      </dynamic>
      ORDER BY HD.HOADON_CHUNGTU_ID DESC
    </statement>

    <statement id="DAO00111_TT_HOADON_CHUNGTU_CHITIET_GetList" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select HD.*, bn.MAYTE, bn.TENBENHNHAN, bl.SOHOADON as SOBIENLAI
      , bl.NGAYHOADON as NGAYBIENLAI, bl.GIATRIHOADON as GIATRIBIENLAI
      , bl.GIATRITHUCTHU as THANHTOAN
      from TT_HOADON_CHUNGTU_CHITIET hdct
      left join TT_HOADON_CHUNGTU hd on hd.HOADON_CHUNGTU_ID = hdct.HOADON_CHUNGTU_ID
      left join TT_HOADON bl on bl.HOADON_ID = hdct.HOADONLIENQUAN_ID
      left join TT_BENHNHAN bn on bn.BENHNHAN_ID = bl.BENHNHAN_ID
      <dynamic prepend="where">
        <isParameterPresent>
          <isNotEmpty prepend="and" property="HOADON_CHUNGTU_ID">
            HDCT.HOADON_CHUNGTU_ID = '$HOADON_CHUNGTU_ID$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="BENHVIEN_ID">
            HDCT.BENHVIEN_ID = '$BENHVIEN_ID$'
          </isNotEmpty>
        </isParameterPresent>
      </dynamic>
    </statement>

    <!--update-->
    <update id="DAO00111_TT_GHINHAN_DUYETHOADON" parameterClass="System.Collections.IDictionary">
      UPDATE TT_HOADON_CHUNGTU
      SET
      TRANGTHAI = #TRANGTHAI#
      ,NGAYCAPNHAT = #NGAYCAPNHAT#
      ,NGUOICAPNHAT_ID = #NGUOICAPNHAT_ID#
      <isNotEmpty prepend="," property="NGUOIHUYHOADON_ID">
        NGUOIHUYHOADON_ID = #NGUOIHUYHOADON_ID#
        , NGAYHUYHOADON = #NGAYHUYHOADON#
      </isNotEmpty>
      <isNotEmpty prepend="," property="NGUOIDUYETHUYHD_ID">
        NGUOIDUYETHUYHD_ID = #NGUOIDUYETHUYHD_ID#
        , NGAYDUYETHUYHD = #NGAYDUYETHUYHD#
      </isNotEmpty>
      <isNotEmpty prepend="," property="LYDOHUY_ID">
        LYDOHUY_ID = #LYDOHUY_ID#
      </isNotEmpty>
      WHERE
      HOADON_CHUNGTU_ID = #HOADON_CHUNGTU_ID#
    </update>

    <update id="DAO00111_TT_HOADON_UpdateHoaDonChungTuLienQuan" parameterClass="System.Collections.IDictionary">
      update TT_HOADON
      set
      HOADON_CHUNGTU_LIENQUAN_ID = #HOADON_ID#
      , NGAYCAPNHAT = #NGAYCAPNHAT#
      , NGUOICAPNHAT_ID = #NGUOICAPNHAT_ID#
       <dynamic prepend="where">
        <isParameterPresent>
          <isNotEmpty prepend="and" property="LIST_HOADON_ID">
            HOADON_ID IN ($LIST_HOADON_ID$)
          </isNotEmpty>
          <isNotEmpty prepend="and" property="BENHVIEN_ID">
            BENHVIEN_ID = '$BENHVIEN_ID$'
          </isNotEmpty>
         <isNotEmpty prepend="and" property="HDCTLQ">
            HOADON_CHUNGTU_LIENQUAN_ID = '$HDCTLQ$'
          </isNotEmpty>
        </isParameterPresent>
      </dynamic>
      
    </update>

    <statement id="DAO00111_LOADDANHSACHBIENLAI_BHTN" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      SELECT DISTINCT BN.MAYTE,BN.TENBENHNHAN,HD.SOPHIEUBHTN SOBIENLAI, HD.NGAYTAO NGAYBIENLAI,HD.GIATRI_BHTN_CHITRA GIATRIBIENLAI, HD.GIATRI_BHTN_CHITRA THANHTOAN
      ,CT.MACONGTY,CT.TENCONGTY,HD.MIENGIAM_BHTN_ID HOADONLIENQUAN_ID, DIACHITHUONGTRU as DIACHIBENHNHAN
      FROM TT_MIENGIAM_BHTN HD
      INNER JOIN TM_CONGTYBAOHIEM CT ON HD.CONGTYBHTN_ID=CT.CONGTY_ID
      INNER JOIN TT_BENHNHAN BN ON HD.BENHNHAN_ID=BN.BENHNHAN_ID
      WHERE HD.TINHTRANG=1 AND HD.BENHVIEN_ID='$BENHVIEN_ID$' AND (HD.HOADON_CHUNGTU_LIENQUAN_ID IS NULL OR HD.HOADON_CHUNGTU_LIENQUAN_ID=0)
      <isNotEmpty prepend="" property="TUNGAY">
        and convert(date,  HD.NGAYTAO) &#62;&#61; convert(date, '$TUNGAY$')
      </isNotEmpty>
      <isNotEmpty prepend="" property="DENNGAY">
        and convert(date,  HD.NGAYTAO) &#60;&#61; convert(date, '$DENNGAY$')
      </isNotEmpty>
   </statement>
    <statement id="DAO00111_LOADDANHSACHBIENLAI_CONGTY" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      SELECT DISTINCT BN.MAYTE,BN.TENBENHNHAN,HD.SOPHIEUMIENGIAM SOBIENLAI, HD.NGAYTAO NGAYBIENLAI,HD.GIATRIMIENGIAM GIATRIBIENLAI, HD.GIATRIMIENGIAM THANHTOAN
      ,CT.MACONGTY,CT.TENCONGTY,HD.MIENGIAM_CONGTY_ID HOADONLIENQUAN_ID, DIACHITHUONGTRU as DIACHIBENHNHAN
      FROM TT_MIENGIAM_CONGTY HD
      INNER JOIN TM_CONGTYCHITRA CT ON HD.CONGTYCHITRA_ID=CT.CONGTY_CHITRA_ID
      INNER JOIN TT_BENHNHAN BN ON HD.BENHNHAN_ID=BN.BENHNHAN_ID
      WHERE HD.TINHTRANG=1 AND HD.BENHVIEN_ID='$BENHVIEN_ID$' AND (HD.HOADON_CHUNGTU_LIENQUAN_ID IS NULL OR HD.HOADON_CHUNGTU_LIENQUAN_ID=0)
      <isNotEmpty prepend="" property="TUNGAY">
        and convert(date,  HD.NGAYTAO) &#62;&#61; convert(date, '$TUNGAY$')
      </isNotEmpty>
      <isNotEmpty prepend="" property="DENNGAY">
        and convert(date,  HD.NGAYTAO) &#60;&#61; convert(date, '$DENNGAY$')
      </isNotEmpty>
      <isNotEmpty prepend="" property="TENNGUOIBENH">
        and (BN.TENBENHNHAN like '%' + #TENNGUOIBENH# + '%' or BN.MAYTE like '%' + #TENNGUOIBENH# + '%')
      </isNotEmpty>
    </statement>
    <statement id="DAO00111_LOADDANHSACHBIENLAI_NGOAITRU" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      SELECT DISTINCT  MAYTE,TENBENHNHAN, SOBIENLAI, NGAYBIENLAI,GIATRIBIENLAI,  THANHTOAN, HOADONLIENQUAN_ID, DIACHIBENHNHAN
      FROM
      (
      SELECT  BN.MAYTE,BN.TENBENHNHAN,HD.SOHOADON SOBIENLAI, HD.NGAYTAO NGAYBIENLAI,HD.GIATRIHOADON GIATRIBIENLAI, HD.GIATRITHUCTHU THANHTOAN
      ,HD.HOADON_ID HOADONLIENQUAN_ID, DIACHITHUONGTRU as DIACHIBENHNHAN
      FROM TT_HOADON HD
      INNER JOIN TT_HOADON_CHITIET_NGOAITRU CT ON CT.HOADON_ID=HD.HOADON_ID
      INNER JOIN TT_BENHNHAN BN ON HD.BENHNHAN_ID=BN.BENHNHAN_ID
      INNER JOIN TT_VIENPHI VP ON CT.VIENPHI_ID=VP.VIENPHI_ID
      WHERE HD.DATHANHTOAN=1 AND HD.LOAIHOADON='BL'  and (HD.HUYHOADON is null or HD.HUYHOADON = '0')  and (HD.HOANTRA is null or HD.HOANTRA = '0')
      AND VP.DATHANHTOAN =1 AND CT.REF_TABLE not in ( 'TT_GOIDICHVU_DANGKY','TT_CSKH_THANHVIEN_CAPTHE','TT_CSKH_GOI_DANGKY') AND (HD.HOADON_CHUNGTU_LIENQUAN_ID IS NULL OR HD.HOADON_CHUNGTU_LIENQUAN_ID=0)
      AND HD.BENHVIEN_ID='$BENHVIEN_ID$'
      <isNotEmpty prepend="" property="TUNGAY">
        and convert(date,  HD.NGAYTAO) &#62;&#61; convert(date, '$TUNGAY$')
      </isNotEmpty>
      <isNotEmpty prepend="" property="DENNGAY">
        and convert(date,  HD.NGAYTAO) &#60;&#61; convert(date, '$DENNGAY$')
      </isNotEmpty>
      <isNotEmpty prepend="" property="TENNGUOIBENH">
        and (BN.TENBENHNHAN like '%' + #TENNGUOIBENH# + '%' or BN.MAYTE like '%' + #TENNGUOIBENH# + '%')
      </isNotEmpty>
      UNION ALL
      SELECT  BN.MAYTE,BN.TENBENHNHAN,HD.SOHOADON SOBIENLAI, HD.NGAYTAO NGAYBIENLAI,HD.GIATRIHOADON GIATRIBIENLAI, HD.GIATRITHUCTHU THANHTOAN
      ,HD.HOADON_ID HOADONLIENQUAN_ID, DIACHITHUONGTRU as DIACHIBENHNHAN
      FROM TT_HOADON HD
      LEFT JOIN TT_HOADON_CHITIET_NOITRU CT ON CT.HOADON_ID=HD.HOADON_ID
      INNER JOIN TT_BENHNHAN BN ON HD.BENHNHAN_ID=BN.BENHNHAN_ID
      INNER JOIN TT_VIENPHI VP ON   CT.VIENPHI_ID=VP.VIENPHI_ID
      WHERE HD.DATHANHTOAN=1 AND HD.LOAIHOADON='BL'  and (HD.HUYHOADON is null or HD.HUYHOADON = '0')  and (HD.HOANTRA is null or HD.HOANTRA = '0')
      AND VP.DATHANHTOAN =1 AND VP.REF_TABLE NOT in( 'TT_GOIDICHVU_DANGKY','TT_CSKH_THANHVIEN_CAPTHE','TT_CSKH_GOI_DANGKY')  AND  (HD.HOADON_CHUNGTU_LIENQUAN_ID IS NULL OR HD.HOADON_CHUNGTU_LIENQUAN_ID=0)
      AND HD.BENHVIEN_ID='$BENHVIEN_ID$'
      <isNotEmpty prepend="" property="TUNGAY">
        and convert(date,  HD.NGAYTAO) &#62;&#61; convert(date, '$TUNGAY$')
      </isNotEmpty>
      <isNotEmpty prepend="" property="DENNGAY">
        and convert(date,  HD.NGAYTAO) &#60;&#61; convert(date, '$DENNGAY$')
      </isNotEmpty>
      <isNotEmpty prepend="" property="TENNGUOIBENH">
        and (BN.TENBENHNHAN like '%' + #TENNGUOIBENH# + '%' or BN.MAYTE like '%' + #TENNGUOIBENH# + '%')
      </isNotEmpty>
      ) AS T
    </statement>
    <statement id="DAO00111_LOADDANHSACHBIENLAI_NHATHUOC" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      SELECT DISTINCT  MAYTE,TENBENHNHAN, SOBIENLAI, NGAYBIENLAI,GIATRIBIENLAI,  THANHTOAN
      , HOADONLIENQUAN_ID, DIACHIBENHNHAN
      FROM
      (
      SELECT  BN.MAYTE,isnull(BN.TENBENHNHAN, NM.TENNGUOIMUA) TENBENHNHAN,HD.SOHOADON SOBIENLAI, HD.NGAYTAO NGAYBIENLAI,HD.GIATRIHOADON GIATRIBIENLAI, HD.GIATRITHUCTHU THANHTOAN
      ,HD.HOADON_ID HOADONLIENQUAN_ID, DIACHITHUONGTRU as DIACHIBENHNHAN
      FROM TT_HOADON HD
      INNER JOIN TT_HOADON_CHITIET_NGOAITRU CT ON CT.HOADON_ID=HD.HOADON_ID
      left JOIN TT_BENHNHAN BN ON HD.BENHNHAN_ID=BN.BENHNHAN_ID
      INNER JOIN TT_VIENPHI VP ON CT.VIENPHI_ID=VP.VIENPHI_ID
      left join TT_DUOC_CHUNGTU_CHITIET ctct on ctct.CHUNGTUCHITIET_ID= CT.REF_ID
      left join TT_DUOC_CHUNGTU ct1 on ct1.CHUNGTU_ID = ctct.CHUNGTU_ID
      left join TT_NGOAITRU_TOATHUOC_NGUOIMUA NM on NM.NGOAITRU_TOATHUOC_NGUOIMUA_ID = CT1.NGOAITRU_TOATHUOC_NGUOIMUA_ID
      WHERE HD.DATHANHTOAN=1 AND HD.LOAIHOADON='BL'  and (HD.HUYHOADON is null or HD.HUYHOADON = '0')  and (HD.HOANTRA is null or HD.HOANTRA = '0')
      AND VP.DATHANHTOAN =1 AND CT.REF_TABLE in ( 'TT_DUOC_CHUNGTU_CHITIET') AND (HD.HOADON_CHUNGTU_LIENQUAN_ID IS NULL OR HD.HOADON_CHUNGTU_LIENQUAN_ID=0)
      AND HD.BENHVIEN_ID='$BENHVIEN_ID$'
      <isNotEmpty prepend="" property="TUNGAY">
        and convert(date,  HD.NGAYTAO) &#62;&#61; convert(date, '$TUNGAY$')
      </isNotEmpty>
      <isNotEmpty prepend="" property="DENNGAY">
        and convert(date,  HD.NGAYTAO) &#60;&#61; convert(date, '$DENNGAY$')
      </isNotEmpty>
      <isNotEmpty prepend="" property="TENNGUOIBENH">
        and (BN.TENBENHNHAN like '%' + #TENNGUOIBENH# + '%' or BN.MAYTE like '%' + #TENNGUOIBENH# + '%')
      </isNotEmpty>
      ) AS T
    </statement>
    <statement id="DAO00111_LOADDANHSACHBIENLAI_GOI" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      SELECT DISTINCT  MAYTE,TENBENHNHAN, SOBIENLAI, NGAYBIENLAI,GIATRIBIENLAI,  THANHTOAN, HOADONLIENQUAN_ID, DIACHIBENHNHAN
      FROM
      (
      SELECT   BN.MAYTE,BN.TENBENHNHAN,HD.SOHOADON SOBIENLAI, HD.NGAYTAO NGAYBIENLAI,HD.GIATRIHOADON GIATRIBIENLAI, HD.GIATRITHUCTHU THANHTOAN
      ,HD.HOADON_ID HOADONLIENQUAN_ID, DIACHITHUONGTRU as DIACHIBENHNHAN
      FROM TT_HOADON HD
      INNER JOIN TT_HOADON_CHITIET_NGOAITRU CT ON CT.HOADON_ID=HD.HOADON_ID
      INNER JOIN TT_BENHNHAN BN ON HD.BENHNHAN_ID=BN.BENHNHAN_ID
      INNER JOIN TT_VIENPHI VP  ON CT.VIENPHI_ID=VP.VIENPHI_ID
      WHERE HD.DATHANHTOAN=1 AND HD.LOAIHOADON='BL'  and (HD.HUYHOADON is null or HD.HUYHOADON = '0')  and (HD.HOANTRA is null or HD.HOANTRA = '0')
      AND VP.DATHANHTOAN =1 AND CT.REF_TABLE in( 'TT_GOIDICHVU_DANGKY','TT_CSKH_THANHVIEN_CAPTHE','TT_CSKH_GOI_DANGKY') AND (HD.HOADON_CHUNGTU_LIENQUAN_ID IS NULL OR HD.HOADON_CHUNGTU_LIENQUAN_ID=0)
      AND HD.BENHVIEN_ID='$BENHVIEN_ID$'
      <isNotEmpty prepend="" property="TUNGAY">
        and convert(date,  HD.NGAYTAO) &#62;&#61; convert(date, '$TUNGAY$')
      </isNotEmpty>
      <isNotEmpty prepend="" property="DENNGAY">
        and convert(date,  HD.NGAYTAO) &#60;&#61; convert(date, '$DENNGAY$')
      </isNotEmpty>
      <isNotEmpty prepend="" property="TENNGUOIBENH">
        and (BN.TENBENHNHAN like '%' + #TENNGUOIBENH# + '%' or BN.MAYTE like '%' + #TENNGUOIBENH# + '%')
      </isNotEmpty>
      <!--UNION ALL

      SELECT   BN.MAYTE,BN.TENBENHNHAN,HD.SOHOADON SOBIENLAI, HD.NGAYTAO NGAYBIENLAI,HD.GIATRIHOADON GIATRIBIENLAI, HD.GIATRITHUCTHU THANHTOAN
      ,HD.HOADON_ID HOADONLIENQUAN_ID
      FROM TT_HOADON HD
      LEFT JOIN TT_HOADON_CHITIET_NOITRU CT ON CT.HOADON_ID=HD.HOADON_ID
      INNER JOIN TT_BENHNHAN BN ON HD.BENHNHAN_ID=BN.BENHNHAN_ID
      INNER JOIN TT_VIENPHI VP  ON CT.VIENPHI_ID=VP.VIENPHI_ID
      WHERE HD.DATHANHTOAN=1 AND HD.LOAIHOADON='BL'  and (HD.HUYHOADON is null or HD.HUYHOADON = '0')  and (HD.HOANTRA is null or HD.HOANTRA = '0')
      AND VP.DATHANHTOAN =1 AND VP.REF_TABLE in( 'TT_GOIDICHVU_DANGKY','TT_CSKH_THANHVIEN_CAPTHE','TT_CSKH_GOI_DANGKY') AND (HD.HOADON_CHUNGTU_LIENQUAN_ID IS NULL OR HD.HOADON_CHUNGTU_LIENQUAN_ID=0)
      AND HD.BENHVIEN_ID='$BENHVIEN_ID$'
      <isNotEmpty prepend="" property="TUNGAY">
        and convert(date,  HD.NGAYTAO) &#62;&#61; convert(date, '$TUNGAY$')
      </isNotEmpty>
      <isNotEmpty prepend="" property="DENNGAY">
        and convert(date,  HD.NGAYTAO) &#60;&#61; convert(date, '$DENNGAY$')
      </isNotEmpty>
      <isNotEmpty prepend="" property="TENNGUOIBENH">
        and (BN.TENBENHNHAN like '%' + #TENNGUOIBENH# + '%' or BN.MAYTE like '%' + #TENNGUOIBENH# + '%')
      </isNotEmpty>-->
      ) AS T
    </statement>
    <statement id="DAO00111_Add_HoaDonChungTu" parameterClass="System.Collections.IDictionary" resultClass="System.Int64">
      insert into TT_HOADON_CHUNGTU (
      BENHNHAN_ID
      , GIATRIHOADON
      , TENKHACHHANG
      ,TENCONGTY
      , DIACHICONGTY
      , MASOTHUE
      , SOTAIKHOAN
      , BENHVIEN_ID
      , NGAYTAO
      , NGUOITAO_ID
      , NGAYCAPNHAT
      , NGUOICAPNHAT_ID
      , HINHTHUCTHANHTOAN_ID
      , GHICHU
      <isNotEmpty prepend="" property="SOHOADON">
      , SOHOADON
      , NGAYHOADON
      </isNotEmpty>
      <isNotEmpty prepend="" property="LOAICHUNGTU ">
        , LOAICHUNGTU
      </isNotEmpty>
      <isNotEmpty prepend="" property="MAUSO">
        , MAUSO, KYHIEU
      </isNotEmpty>
      ) values (

      #BENHNHAN_ID#
      , #GIATRIHOADON#
      , #TENKHACHHANG#
      ,#TENCONGTY#
      , #DIACHICONGTY#
      , #MASOTHUE#
      , #SOTAIKHOAN#
      , #BENHVIEN_ID#
      , #NGAYTAO#
      , #NGUOITAO_ID#
      , #NGAYCAPNHAT#
      , #NGUOICAPNHAT_ID#
      , #HINHTHUCTHANHTOAN_ID#
      , #GHICHU#
      <isNotEmpty prepend="" property="SOHOADON">
        , #SOHOADON#
        , #NGAYHOADON#
      </isNotEmpty>
      <isNotEmpty prepend="" property="LOAICHUNGTU ">
        , #LOAICHUNGTU#
      </isNotEmpty>
      <isNotEmpty prepend="" property="MAUSO">
        , #MAUSO#, #KYHIEU#
      </isNotEmpty>
      )
      select SCOPE_identity() as value
    </statement>
    <statement id="DAO00111_AddDetail_HoaDonChungTu" parameterClass="System.Collections.IDictionary" resultClass="System.Int64">
      insert into TT_HOADON_CHUNGTU_CHITIET (
      HOADON_CHUNGTU_ID
      , HOADONLIENQUAN_ID
      , NGAYHOADON
      , GIATRIHOADON
      , BENHVIEN_ID
      , NGAYTAO
      , NGUOITAO_ID
      , NGAYCAPNHAT
      , NGUOICAPNHAT_ID
      , REF_TABLE
      ) values (
      #HOADON_CHUNGTU_ID#
      , #HOADONLIENQUAN_ID#
      , #NGAYHOADON#
      , #GIATRIHOADON#
      , #BENHVIEN_ID#
      , #NGAYTAO#
      , #NGUOITAO_ID#
      , #NGAYCAPNHAT#
      , #NGUOICAPNHAT_ID#
      , #REF_TABLE#
      )
      select SCOPE_identity() as value
    </statement>
    <statement id="DAO00111_LoadDanhSachHoaDon_BenhNhan" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      SELECT BN.MAYTE,HD.TENKHACHHANG TENBENHNHAN,HD.SOHOADON,HD.NGAYHOADON,HD.GIATRIHOADON, HD.TRANGTHAI,ISNULL(HD.INLAI, 0) INLAI,HD.HOADON_CHUNGTU_ID,HD.GHICHU
      ,CASE WHEN HD.TRANGTHAI ='CHODUYET' THEN N'Chờ duyệt hủy'
      when hd.TRANGTHAI ='DAHUY' then N'Đã hủy'
      when hd.TRANGTHAI ='DADUYETHUY' THEN N'Đã duyệt hủy'
      when hd.TRANGTHAI ='DAXUATHOADON' THEN N'Đã xuất hóa đơn'
      else '' end as TENTRANGTHAI,
      HD.NGUOIXUATHOADON_ID, HD.NGAYXUATHOADON, HD.NGUOIHUYHOADON_ID, HD.NGAYHUYHOADON
      , HD.LOAICHUNGTU
      FROM TT_HOADON_CHUNGTU HD
      left JOIN TT_BENHNHAN BN ON HD.BENHNHAN_ID=BN.BENHNHAN_ID
      <!--left join TT_HOADON_CHUNGTU_CHITIET HDCT on hdct.HOADON_CHUNGTU_CHITIET_ID = hd.HOADON_CHUNGTU_ID-->
      <dynamic prepend="where">
        <isParameterPresent>   
          <isNotEmpty prepend="and" property="BENHVIEN_ID">
            HD.BENHVIEN_ID = '$BENHVIEN_ID$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="TRANGTHAI">
            HD.TRANGTHAI = '$TRANGTHAI$'
          </isNotEmpty>
          <isNotEmpty prepend="" property="TUNGAY">
            and convert(date,  HD.NGAYTAO) &#62;&#61; convert(date, '$TUNGAY$')
          </isNotEmpty>
          <isNotEmpty prepend="" property="DENNGAY">
            and convert(date,  HD.NGAYTAO) &#60;&#61; convert(date, '$DENNGAY$')
          </isNotEmpty>
          <isNotEmpty prepend="and" property="SOHOADONSEARCH">
            HD.SOHOADON like '%' + #SOHOADONSEARCH# + '%'
          </isNotEmpty>
          <isNotEmpty prepend="" property="TENNGUOIBENH">
            and (HD.TENKHACHHANG like '%' + #TENNGUOIBENH# + '%' )
          </isNotEmpty>
        </isParameterPresent>
      </dynamic>
      ORDER BY HD.HOADON_CHUNGTU_ID DESC
    </statement>

    <update id="DAO00111_UpdateHoaDonChungTuLienQuan_HoaDon" parameterClass="System.Collections.IDictionary">
      update TT_HOADON
      set
      HOADON_CHUNGTU_LIENQUAN_ID = #HOADON_ID#
      , NGAYCAPNHAT = #NGAYCAPNHAT#
      , NGUOICAPNHAT_ID = #NGUOICAPNHAT_ID#
      <dynamic prepend="where">
      <isParameterPresent>
        <isNotEmpty prepend="and" property="LIST_HOADON_ID">
          HOADON_ID IN ($LIST_HOADON_ID$)
        </isNotEmpty>
        <isNotEmpty prepend="and" property="BENHVIEN_ID">
          BENHVIEN_ID = '$BENHVIEN_ID$'
        </isNotEmpty>
        <isNotEmpty prepend="and" property="HDCTLQ">
          HOADON_CHUNGTU_LIENQUAN_ID = '$HDCTLQ$'
        </isNotEmpty>
      </isParameterPresent>
    </dynamic>
    </update>
    <update id="DAO00111_UpdateHoaDonChungTuLienQuan_BHTN" parameterClass="System.Collections.IDictionary">
      UPDATE TT_MIENGIAM_BHTN
      SET HOADON_CHUNGTU_LIENQUAN_ID = #HOADON_ID#
      , NGAYCAPNHAT = #NGAYCAPNHAT#
      , NGUOICAPNHAT_ID = #NGUOICAPNHAT_ID#
      <dynamic prepend="where">
        <isParameterPresent>
          <isNotEmpty prepend="and" property="LIST_HOADON_ID">
            MIENGIAM_BHTN_ID IN ($LIST_HOADON_ID$)
          </isNotEmpty>
          <isNotEmpty prepend="and" property="BENHVIEN_ID">
            BENHVIEN_ID = '$BENHVIEN_ID$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="HDCTLQ">
            HOADON_CHUNGTU_LIENQUAN_ID = '$HDCTLQ$'
          </isNotEmpty>
        </isParameterPresent>
      </dynamic>
    </update>
    <update id="DAO00111_UpdateHoaDonChungTuLienQuan_CONGTY" parameterClass="System.Collections.IDictionary">
      UPDATE TT_MIENGIAM_CONGTY
      SET HOADON_CHUNGTU_LIENQUAN_ID = #HOADON_ID#
      , NGAYCAPNHAT = #NGAYCAPNHAT#
      , NGUOICAPNHAT_ID = #NGUOICAPNHAT_ID#
      <dynamic prepend="where">
        <isParameterPresent>
          <isNotEmpty prepend="and" property="LIST_HOADON_ID">
            MIENGIAM_CONGTY_ID IN ($LIST_HOADON_ID$)
          </isNotEmpty>
          <isNotEmpty prepend="and" property="BENHVIEN_ID">
            BENHVIEN_ID = '$BENHVIEN_ID$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="HDCTLQ">
            HOADON_CHUNGTU_LIENQUAN_ID = '$HDCTLQ$'
          </isNotEmpty>
        </isParameterPresent>
      </dynamic>
    </update>
    <update id="DAO00111_TT_HOADON_Update_Status_Print" parameterClass="System.Collections.IDictionary">
      update TT_HOADON_CHUNGTU
      set
      INLAI = #INLAI#,
      NGUOICAPNHAT_ID = #NGUOIXUATHOADON_ID#,
      NGAYCAPNHAT = #NGAYXUATHOADON#
      where
      HOADON_CHUNGTU_ID = '$HOADON_CHUNGTU_ID$'
    </update>
    <statement id="DAO00111_TT_HOADON_Update_Print_Number" parameterClass="System.Collections.IDictionary">
      update TT_HOADON_CHUNGTU
      set
      INLAI = INLAI + 1,      
      NGUOICAPNHAT_ID = #NGUOIXUATHOADON_ID#,
      NGAYCAPNHAT = #NGAYXUATHOADON#
      where
      HOADON_CHUNGTU_ID = '$HOADON_CHUNGTU_ID$'
    </statement>
    <statement id="DAO00111_KiemTraHoaDonDaIn" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      SELECT ISNULL(INLAI,0) result
      FROM TT_HOADON_CHUNGTU HD
      WHERE HOADON_CHUNGTU_ID='$HOADON_CHUNGTU_ID$'
    </statement>
    <statement id="DAO00111_KiemTraHoaDonLienQuan" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      SELECT TOP 1 A.*
      FROM TT_HOADON_CHUNGTU_CHITIET A
      INNER JOIN TT_HOADON_CHUNGTU B ON A.HOADON_CHUNGTU_ID = B.HOADON_CHUNGTU_ID
      WHERE A.HOADONLIENQUAN_ID = '$HOADONLIENQUAN_ID$' and A.BENHVIEN_ID = '$BENHVIEN_ID$' and B.TRANGTHAI != 'DAHUY'
    </statement>
  </statements>   
</sqlMap>