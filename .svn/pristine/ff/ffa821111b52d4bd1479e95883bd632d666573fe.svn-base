<?xml version="1.0" encoding="utf-8" ?>
<sqlMap namespace="eHospital" xmlns="http://ibatis.apache.org/mapping" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" >

  <statements>
    <statement id="DAO00401_GetList" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select ID AS LOAI_ID,MA AS MALOAI,TEN AS TENLOAI from TM_PUR_LOAI where BENHVIEN_ID = '$BENHVIEN_ID$' ORDER BY TEN
    </statement>
    <statement id="DAO00401_INV001_GetDMKHOVPP" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      Select K.*,BB.SODU,BB.SODUDENNGAY,BB.KHOASO,BB.NGAYKHOA  From TM_KHO K
      LEFT JOIN TM_INV_KHO BB ON K.MAKHO = BB.MAKHO
      LEFT JOIN LST_DICTIONARY AA ON AA.DICTIONARY_ID = K.MODULE_ID
      WHERE AA.DICTIONARY_CODE = 'KhoVPP'
    </statement>
    <statement id="DAO00401_INV001_GetTrangThaiNhapKhoVPP" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      SELECT DICTIONARY_CODE AS MATRANGTHAI,DICTIONARY_NAME AS TENTRANGTHAI FROM LST_DICTIONARY WHERE DICTIONARY_TYPE_CODE = 'TrangThaiVPP'
    </statement>
    <statement id="DAO00401_INV001_ChungTuPO" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select DISTINCT 0 AS CHON,CT.CHUNGTU_ID,CT.MACHUNGTU,CT.NGAYLAPCHUNGTU,CT.NGAYGIOLAPCHUNGTU,CT.PROCESS_CODE,CT.PROCESS_NAME,CT.STATE_CODE,CT.STATE_NAME,CT.PHONGBAN_ID,
      CT.TENPHONGBAN,CT.NGUOIDUYETCAP1_ID,CT.TENNGUOIDUYETCAP1,CT.NGAYGIODUYETCAP1,CT.NGUOIDUYETCAP2_ID,CT.TENNGUOIDUYETCAP2,CT.NGAYGIODUYETCAP2,CT.NGUOIDUYETCAP3_ID,
      CT.TENNGUOIDUYETCAP3,CT.NGAYGIODUYETCAP3,CT.CAPDUYET,CT.THOIGIANGIAOHANG,CT.NHACUNGCAP_ID,CT.TENNHACUNGCAP,CT.HINHTHUCGIAOHANG,CT.HINHTHUCTHANHTOAN,CT.TONGTIEN,CT.GHICHU,CT.DIENGIAI,
      CT.TENNGUOITAO,CT.TENNGUOICAPNHAT,CT.NGUOIPHANCONG_ID,CT.TENNGUOIPHANCONG,CT.NGAYPHANCONG,CT.NGAYCHAPNHAN,CT.NGAYTUCHOI,CT.THANHTOAN1,CT.THANHTOAN2,CT.THANHTOAN3,CT.THANHTOAN4,
      CT.THANHTOAN5,CT.THANHTOAN6,CT.BENHVIEN_ID,CT.NGAYTAO,CT.NGUOITAO_ID,CT.NGAYCAPNHAT,CT.NGUOICAPNHAT_ID,
      (CASE WHEN CT.STATE_CODE='3' THEN N'Đã duyệt bởi '+CT.TENNGUOIDUYETCAP1 ELSE CASE WHEN CT.STATE_CODE='4' THEN N'Đã từ chối bởi '+CT.TENNGUOIDUYETCAP1 ELSE CT.STATE_NAME END END) AS TRANGTHAI
      from TT_PUR_CHUNGTU CT INNER JOIN TT_PUR_CHUNGTUCHITIET CTCT ON CT.CHUNGTU_ID = CTCT.CHUNGTU_ID AND CTCT.SOLUONGYEUCAU-ISNULL(CTCT.SOLUONGDANHAP,0)>0
      where CT.BENHVIEN_ID = '$BENHVIEN_ID$' AND CT.NHACUNGCAP_ID = '$NHACUNGCAP_ID$' AND CT.PROCESS_CODE = 'PO' AND CT.MALOAIPHIEU='VPP' AND CTCT.SOLUONGYEUCAU-ISNULL(CTCT.SOLUONGDANHAP,0)>0 AND CT.STATE_CODE IN ($TRANGTHAIPO$)
      <isNotEmpty prepend="AND" property="TUNGAY">
        CONVERT(DATETIME,CONVERT(VARCHAR(10),CONVERT(DATETIME,CT.NGAYLAPCHUNGTU,101),103),103) BETWEEN CONVERT(DATETIME,CONVERT(VARCHAR(10),CONVERT(DATETIME,'$TUNGAY$',101),103),103) AND CONVERT(DATETIME,CONVERT(VARCHAR(10),CONVERT(DATETIME,'$DENNGAY$',101),103),103)
      </isNotEmpty>
      ORDER BY NGAYLAPCHUNGTU
    </statement>
    <statement id="DAO00401_INV001_GetChungTuChiTietPO_ChungTuID" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select CTCT.CHUNGTUCHITIET_ID,CTCT.CHUNGTU_ID,CTCT.HANGHOA_ID,CTCT.MAHANGHOA,CTCT.TENHANGHOA,CTCT.DONVITINH_ID,CTCT.TENDONVITINH,CTCT.LOAI_ID,CTCT.TENLOAI,SOLUONGYEUCAU,CTCT.MOTA,
      CTCT.THUONGHIEU,CTCT.KICHTHUOC,CTCT.VATLIEU,CTCT.GHICHU AS CT_GHICHU,CTCT.FILE_NAME,CTCT.FULLPATHSERVER,CTCT.FULLPATHLOCAL,CTCT.SIZE,CTCT.FILE_NAME_PO,CTCT.FULLPATHSERVER_PO,CTCT.FULLPATHLOCAL_PO,CTCT.SIZE_PO,CTCT.STATE_CODE AS CT_STATE_CODE,CTCT.STATE_NAME AS CT_STATE_NAME,CTCT.NGUOIDUYET_ID AS CT_NGUOIDUYET_ID,CTCT.TENNGUOIDUYET AS CT_TENNGUOIDUYET,CTCT.NGAYGIODUYET AS CT_NGAYGIODUYET,
      CTCT.MACHONGIA,CTCT.TENCHONGIA,CTCT.DONGIA,CTCT.TYLEVAT,CTCT.GIATRIVAT,CTCT.DONGIASAUVAT,CTCT.THANHTIEN,CTCT.NHACUNGCAP_ID AS CT_NHACUNGCAP_ID,CTCT.TENNHACUNGCAP AS CT_TENNHACUNGCAP,CTCT.DONGIAHOPDONG,CTCT.TUNGAYHOPDONG, CTCT.DENNGAYHOPDONG,CTCT.MATONGHOP,
      CTCT.CHUNGTUTONGHOP_ID,CTCT.MALOAIPHIEU,CTCT.BAOHANHTUNGAY,CTCT.BAOHANHDENNGAY,CTCT.TENNGUOITAO,CTCT.TENNGUOICAPNHAT,CTCT.NGAYTAO,CTCT.NGUOITAO_ID,CTCT.NGAYCAPNHAT,CTCT.NGUOICAPNHAT_ID
      from TT_PUR_CHUNGTUCHITIET CTCT
      where CTCT.BENHVIEN_ID = '$BENHVIEN_ID$' AND CTCT.CHUNGTU_ID = '$CHUNGTUPHIEUPO_ID$'
      ORDER BY TENHANGHOA
    </statement>
    <statement id="DAO00401_INV001_GetChiTietPO_MaChungTu" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select CT.MACHUNGTU,CT.NHACUNGCAP_ID,CT.TENNHACUNGCAP,CTCT.CHUNGTUCHITIET_ID AS CHUNGTULIENQUANCHITIET_ID,CTCT.CHUNGTU_ID AS CHUNGTULIENQUAN_ID,CTCT.HANGHOA_ID,CTCT.MAHANGHOA,CTCT.TENHANGHOA,CTCT.DONVITINH_ID,CTCT.TENDONVITINH,CTCT.LOAI_ID,CTCT.TENLOAI,CTCT.SOLUONGYEUCAU,
      (CTCT.SOLUONGYEUCAU-ISNULL([SOLUONGDANHAP],0)) AS SOLUONGCONLAI, (CTCT.SOLUONGYEUCAU-ISNULL([SOLUONGDANHAP],0)) AS SOLUONGNHAP, CTCT.MOTA,
      CTCT.THUONGHIEU,CTCT.KICHTHUOC,CTCT.VATLIEU,CTCT.GHICHU AS CT_GHICHU,CTCT.FILE_NAME,CTCT.FULLPATHSERVER,CTCT.FULLPATHLOCAL,CTCT.SIZE,CTCT.FILE_NAME_PO,CTCT.FULLPATHSERVER_PO,CTCT.FULLPATHLOCAL_PO,CTCT.SIZE_PO,CTCT.STATE_CODE AS CT_STATE_CODE,CTCT.STATE_NAME AS CT_STATE_NAME,CTCT.NGUOIDUYET_ID AS CT_NGUOIDUYET_ID,CTCT.TENNGUOIDUYET AS CT_TENNGUOIDUYET,CTCT.NGAYGIODUYET AS CT_NGAYGIODUYET,
      CTCT.MACHONGIA,CTCT.TENCHONGIA,CTCT.DONGIA,CTCT.TYLEVAT,CTCT.GIATRIVAT,CTCT.DONGIASAUVAT,CTCT.THANHTIEN, CTCT.THANHTIEN AS THANHTIENSAUVAT, CTCT.NHACUNGCAP_ID AS CT_NHACUNGCAP_ID,CTCT.TENNHACUNGCAP AS CT_TENNHACUNGCAP,CTCT.DONGIAHOPDONG,CTCT.TUNGAYHOPDONG, CTCT.DENNGAYHOPDONG,CTCT.MATONGHOP,
      CTCT.CHUNGTUTONGHOP_ID,CTCT.MALOAIPHIEU,CTCT.BAOHANHTUNGAY,CTCT.BAOHANHDENNGAY,CTCT.TENNGUOITAO,CTCT.TENNGUOICAPNHAT,CTCT.NGAYTAO,CTCT.NGUOITAO_ID,CTCT.NGAYCAPNHAT,CTCT.NGUOICAPNHAT_ID
      from TT_PUR_CHUNGTUCHITIET CTCT INNER JOIN TT_PUR_CHUNGTU CT ON CT.CHUNGTU_ID=CTCT.CHUNGTU_ID
      where CTCT.BENHVIEN_ID = '$BENHVIEN_ID$' AND CT.MACHUNGTU = '$MACHUNGTULIENQUAN$' AND CTCT.SOLUONGYEUCAU-ISNULL(CTCT.SOLUONGDANHAP,0)>0
      ORDER BY TENHANGHOA
    </statement>
    <statement id="DAO00401_INV001_KiemTraMaChungTuNhapTonTai" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select SUM(CTCT.SOLUONGNHAP) AS SOLUONGNHAP, SUM(TKCT.SOLUONGXUAT) AS SOLUONGXUAT,CT.IDCHUYEN
      FROM TT_INV_CHUNGTUNHAP CT INNER JOIN TT_INV_CHUNGTUNHAPCHITIET CTCT ON CT.CHUNGTUNHAP_ID=CTCT.CHUNGTUNHAP_ID AND CT.MMYY='$MMYY$'
      INNER JOIN TT_INV_THEODOI TD ON CTCT.THEODOI_ID=TD.THEODOI_ID
      LEFT JOIN TT_INV_TONKHOCHITIET TKCT ON TD.THEODOI_ID=TKCT.THEODOI_ID
      where CT.MMYY='$MMYY$' AND CT.CHUNGTUNHAP_ID = '$CHUNGTUNHAP_ID$' AND CT.BENHVIEN_ID = '$BENHVIEN_ID$'
      GROUP BY CT.IDCHUYEN
    </statement>
    <statement id="DAO00401_INV001_AddChungTuNhap" parameterClass="System.Collections.IDictionary" resultClass="System.Int64">
      INSERT INTO TT_INV_CHUNGTUNHAP
      (MACHUNGTU,MMYY,NGAYCHUNGTU,NHACUNGCAP_ID,TENNHACUNGCAP,MAKHO,TENKHO,NGUOINHAP_ID,TENNGUOINHAP,TENNGUOIGIAO,KYHIEUHOADON,SOSERI,SOHOADON,NGAYHOADON,MATRANGTHAI,TENTRANGTHAI,
      TYLECHIETKHAU,GIATRICHIETKHAU,THANHTIEN,THANHTIENSAUCUNG,GHICHU,CHUNGTULIENQUAN_ID,MACHUNGTULIENQUAN,BENHVIEN_ID,NGAYTAO,NGUOITAO_ID)
      VALUES
      (#MACHUNGTU#,#MMYY#,#NGAYCHUNGTU#,#NHACUNGCAP_ID#,#TENNHACUNGCAP#,#MAKHO#,#TENKHO#,#NGUOINHAP_ID#,#TENNGUOINHAP#,#TENNGUOIGIAO#,#KYHIEUHOADON#,#SOSERI#,#SOHOADON#,#NGAYHOADON#,
      #MATRANGTHAI#,#TENTRANGTHAI#,#TYLECHIETKHAU#,#GIATRICHIETKHAU#,#THANHTIEN#,#THANHTIENSAUCUNG#,#GHICHU#,#CHUNGTULIENQUAN_ID#,#MACHUNGTULIENQUAN#,#BENHVIEN_ID#,GETDATE(),#NGUOITAO_ID#)
      SELECT SCOPE_IDENTITY()
    </statement>
    <update id="DAO00401_INV001_UpdChungTuNhap" parameterClass="DataObject">
      UPDATE TT_INV_CHUNGTUNHAP
      SET MMYY = #MMYY#,NGAYCHUNGTU = #NGAYCHUNGTU#,NHACUNGCAP_ID = #NHACUNGCAP_ID#,TENNHACUNGCAP = #TENNHACUNGCAP#,MAKHO = #MAKHO#,TENKHO = #TENKHO#,NGUOINHAP_ID = #NGUOINHAP_ID#,TENNGUOINHAP = #TENNGUOINHAP#,
      TENNGUOIGIAO = #TENNGUOIGIAO#,KYHIEUHOADON = #KYHIEUHOADON#,SOSERI = #SOSERI#,SOHOADON = #SOHOADON#,NGAYHOADON = #NGAYHOADON#,MATRANGTHAI = #MATRANGTHAI#,TENTRANGTHAI = #TENTRANGTHAI#,TYLECHIETKHAU = #TYLECHIETKHAU#,
      GIATRICHIETKHAU = #GIATRICHIETKHAU#,THANHTIEN = #THANHTIEN#,THANHTIENSAUCUNG = #THANHTIENSAUCUNG#,GHICHU = #GHICHU#,CHUNGTULIENQUAN_ID = #CHUNGTULIENQUAN_ID#,MACHUNGTULIENQUAN = #MACHUNGTULIENQUAN#,
      BENHVIEN_ID = #BENHVIEN_ID#,NGAYCAPNHAT = GETDATE(),NGUOICAPNHAT_ID = #NGUOICAPNHAT_ID#
      WHERE CHUNGTUNHAP_ID = '$CHUNGTUNHAP_ID$'
    </update>
    <statement id="DAO00401_INV001_AddChungTuNhapChiTiet" parameterClass="System.String" resultClass="System.Int64">
      INSERT INTO TT_INV_THEODOI(MMYY,HANGHOA_ID,MAHANGHOA,TENHANGHOA,DONVITINH_ID,TENDONVITINH,HANDUNG,LOSX,DONGIA,DONGIASAUVAT,TYLEVAT,TENNGUOITAO,BENHVIEN_ID,NGAYTAO,NGUOITAO_ID)
      VALUES (#MMYY#,#HANGHOA_ID#,#MAHANGHOA#,#TENHANGHOA#,#DONVITINH_ID#,#TENDONVITINH#,#HANDUNG#,#LOSX#,#DONGIA#,#DONGIASAUVAT#,#TYLEVAT#,#TENNGUOITAO#,#BENHVIEN_ID#,GETDATE(),#NGUOITAO_ID#)
      INSERT INTO TT_INV_CHUNGTUNHAPCHITIET(CHUNGTUNHAP_ID,MMYY,THEODOI_ID,SOLUONGYEUCAU,SOLUONGCONLAI,SOLUONGNHAP,GIATRIVAT,THANHTIENTRUOCVAT,THANHTIENSAUVAT,NGAYDUKIEN,GHICHU,CHUNGTULIENQUANCHITIET_ID,KHUYENMAI,TENNGUOITAO,BENHVIEN_ID,NGAYTAO,NGUOITAO_ID)
      VALUES (#CHUNGTUNHAP_ID#,#MMYY#,SCOPE_IDENTITY(),#SOLUONGYEUCAU#,#SOLUONGCONLAI#,#SOLUONGNHAP#,#GIATRIVAT#,#THANHTIENTRUOCVAT#,#THANHTIENSAUVAT#,#NGAYDUKIEN#,#CT_GHICHU#,#CHUNGTULIENQUANCHITIET_ID#,#KHUYENMAI#,#TENNGUOITAO#,#BENHVIEN_ID#,#NGAYTAO#,#NGUOITAO_ID#)
      SELECT SCOPE_IDENTITY()
    </statement>
    <statement id="DAO00401_INV001_DelChungTuNhapChiTiet" parameterClass="System.String" resultClass="System.Int64">
      DELETE FROM TT_INV_CHUNGTUNHAPCHITIET WHERE MMYY='$MMYY$' AND CHUNGTUNHAP_ID='$CHUNGTUNHAP_ID$';
      <!--DELETE FROM TT_INV_THEODOI WHERE MMYY='$MMYY$' AND THEODOI_ID IN($LISTTHEODOI_ID$);-->
    </statement>
     <statement id="DAO00401_INV001_DelChungTuNhapAll" parameterClass="System.String" resultClass="System.Int64">
       DELETE FROM TT_INV_CHUNGTUNHAPCHITIET WHERE MMYY='$MMYY$' AND CHUNGTUNHAP_ID='$CHUNGTUNHAP_ID$';
       <!--DELETE FROM TT_INV_THEODOI WHERE MMYY='$MMYY$' AND THEODOI_ID IN($LISTTHEODOI_ID$);-->
       DELETE FROM TT_INV_CHUNGTUNHAP WHERE MMYY='$MMYY$' AND CHUNGTUNHAP_ID='$CHUNGTUNHAP_ID$';
     </statement>
    <statement id="DAO00401_INV001_DelChungTuNhapChiTietTheoID" parameterClass="System.String" resultClass="System.Int64">
      DELETE FROM TT_INV_CHUNGTUNHAPCHITIET WHERE MMYY='$MMYY$' AND CHUNGTUNHAPCHITIET_ID='$CHUNGTUNHAPCHITIET_ID$';
      <!--DELETE FROM TT_INV_THEODOI WHERE MMYY='$MMYY$' AND THEODOI_ID=$LISTTHEODOI_ID$;-->
    </statement>
    <statement id="DAO00401_INV001_UpdSLDaNhap_ChungTuChiTietID" parameterClass="DataObject">
      UPDATE TT_PUR_CHUNGTUCHITIET SET SOLUONGDANHAP=0 WHERE CHUNGTUCHITIET_ID IN($LISTCHUNGTUCHITIET_ID$);
      MERGE TT_PUR_CHUNGTUCHITIET AS X USING
      (SELECT SUM(B.SOLUONGNHAP) AS SOLUONGDANHAP,B.CHUNGTULIENQUANCHITIET_ID
      FROM TT_INV_CHUNGTUNHAP A INNER JOIN TT_INV_CHUNGTUNHAPCHITIET B ON A.CHUNGTUNHAP_ID=B.CHUNGTUNHAP_ID AND B.CHUNGTULIENQUANCHITIET_ID IN($LISTCHUNGTUCHITIET_ID$)
      INNER JOIN TT_INV_THEODOI C ON B.THEODOI_ID=C.THEODOI_ID
      WHERE A.MATRANGTHAI='DaNhapKho' AND A.BENHVIEN_ID='$BENHVIEN_ID$'
      GROUP BY B.CHUNGTULIENQUANCHITIET_ID) AS Y
      ON (X.CHUNGTUCHITIET_ID=Y.CHUNGTULIENQUANCHITIET_ID)
      WHEN MATCHED THEN UPDATE SET X.SOLUONGDANHAP=Y.SOLUONGDANHAP;
    </statement>
    <statement id="DAO00401_INV001_UpdSLNhapTonKho" parameterClass="DataObject">
      UPDATE TT_INV_TONKHOCHITIET SET SOLUONGNHAP=0 WHERE MMYY='$MMYY$' AND MAKHO IN($LISTMAKHO$);
      MERGE TT_INV_TONKHOCHITIET AS X USING
      (SELECT QQ.MMYY, QQ.MAKHO,QQ.TENKHO,QQ.THEODOI_ID,SUM(QQ.SOLUONGNHAP) AS SOLUONGNHAP FROM (
      SELECT '$MMYY$' AS MMYY, A.MAKHO,A.TENKHO,B.THEODOI_ID,B.SOLUONGNHAP
      FROM TT_INV_CHUNGTUNHAP A INNER JOIN TT_INV_CHUNGTUNHAPCHITIET B ON A.CHUNGTUNHAP_ID=B.CHUNGTUNHAP_ID AND A.MMYY='$MMYY$'
      INNER JOIN TT_INV_THEODOI C ON B.THEODOI_ID=C.THEODOI_ID
      WHERE A.MMYY='$MMYY$' AND A.MATRANGTHAI='DaNhapKho' AND A.BENHVIEN_ID='$BENHVIEN_ID$' AND A.MAKHO IN($LISTMAKHO$)
      UNION ALL
      SELECT '$MMYY$' AS MMYY, A.MAKHO,A.TENKHO,B.THEODOI_ID,B.SOLUONG AS SOLUONGNHAP
      FROM TT_INV_CHUNGTUTANGGIAM A INNER JOIN TT_INV_CHUNGTUTANGGIAMCHITIET B ON A.CHUNGTUTANGGIAM_ID=B.CHUNGTUTANGGIAM_ID AND A.MMYY='$MMYY$' AND A.LOAI='tang'
      INNER JOIN TT_INV_THEODOI C ON B.THEODOI_ID=C.THEODOI_ID
      WHERE A.MMYY='$MMYY$' AND A.LOAI='tang' AND A.BENHVIEN_ID='$BENHVIEN_ID$' AND A.MAKHO IN($LISTMAKHO$)) QQ
      GROUP BY QQ.MMYY, QQ.MAKHO,QQ.TENKHO,QQ.THEODOI_ID) AS Y
      ON (X.MMYY=Y.MMYY AND X.MAKHO=Y.MAKHO AND X.THEODOI_ID=Y.THEODOI_ID)
      WHEN MATCHED THEN UPDATE SET X.SOLUONGNHAP=Y.SOLUONGNHAP
      WHEN NOT MATCHED THEN
      INSERT (MMYY,MAKHO,TENKHO,THEODOI_ID,SOLUONGNHAP,BENHVIEN_ID,NGAYTAO) VALUES
      ('$MMYY$',Y.MAKHO,Y.TENKHO,Y.THEODOI_ID,Y.SOLUONGNHAP,#BENHVIEN_ID#,GETDATE());

      UPDATE TT_INV_TONKHOTONGHOP SET SOLUONGTONDAU=0,SOLUONGNHAP=0,SOLUONGXUAT=0 WHERE MMYY='$MMYY$' AND MAKHO IN($LISTMAKHO$);
      MERGE TT_INV_TONKHOTONGHOP AS X USING
      (SELECT '$MMYY$' AS MMYY,A.MAKHO,A.TENKHO,B.HANGHOA_ID,B.MAHANGHOA,HH.TEN,SUM(A.SOLUONGTONDAU) AS SOLUONGTONDAU,SUM(A.SOLUONGNHAP) AS SOLUONGNHAP,SUM(A.SOLUONGXUAT) AS SOLUONGXUAT
      FROM TT_INV_TONKHOCHITIET A INNER JOIN TT_INV_THEODOI B ON A.THEODOI_ID=B.THEODOI_ID AND A.MMYY='$MMYY$'
      JOIN TM_PUR_HANGHOA HH on HH.ID = B.HANGHOA_ID
      WHERE A.MMYY='$MMYY$' AND A.BENHVIEN_ID='$BENHVIEN_ID$' AND A.MAKHO IN($LISTMAKHO$)
      GROUP BY A.MAKHO,A.TENKHO,B.HANGHOA_ID,B.MAHANGHOA,HH.TEN) AS Y
      ON (X.MMYY=Y.MMYY AND X.MAKHO=Y.MAKHO AND X.HANGHOA_ID=Y.HANGHOA_ID)
      WHEN MATCHED THEN UPDATE SET X.SOLUONGTONDAU=Y.SOLUONGTONDAU, X.SOLUONGNHAP=Y.SOLUONGNHAP,X.SOLUONGXUAT=Y.SOLUONGXUAT
      WHEN NOT MATCHED THEN
      INSERT (MMYY,MAKHO,TENKHO,HANGHOA_ID,MAHANGHOA,TENHANGHOA,SOLUONGTONDAU,SOLUONGNHAP,SOLUONGXUAT,BENHVIEN_ID,NGAYTAO)
      VALUES ('$MMYY$',Y.MAKHO,Y.TENKHO,Y.HANGHOA_ID,Y.MAHANGHOA,Y.TEN,Y.SOLUONGTONDAU,Y.SOLUONGNHAP,Y.SOLUONGXUAT,#BENHVIEN_ID#,GETDATE());

      DELETE FROM TT_INV_TONKHOCHITIET WHERE SOLUONGTONDAU=0 AND SOLUONGNHAP=0 AND SOLUONGXUAT=0;
      DELETE FROM TT_INV_TONKHOTONGHOP WHERE SOLUONGTONDAU=0 AND SOLUONGNHAP=0 AND SOLUONGXUAT=0;
    </statement>
  <statement id="DAO00401_INV001_GetChungTuNhap" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      SELECT CT.CHUNGTUNHAP_ID,CT.MACHUNGTU,CT.MMYY,CT.NGAYCHUNGTU,CT.NHACUNGCAP_ID,CT.TENNHACUNGCAP,CT.MAKHO,CT.TENKHO,CT.NGUOINHAP_ID,CT.TENNGUOINHAP,CT.TENNGUOIGIAO,
      CT.KYHIEUHOADON,CT.SOSERI,CT.SOHOADON,CT.NGAYHOADON,CT.MATRANGTHAI,CT.TENTRANGTHAI,CT.TYLECHIETKHAU,CT.GIATRICHIETKHAU,CT.THANHTIEN,CT.THANHTIENSAUCUNG,CT.GHICHU,
      CT.CHUNGTULIENQUAN_ID,CT.MACHUNGTULIENQUAN,CT.BENHVIEN_ID,CT.NGAYTAO,CT.NGUOITAO_ID,CT.NGAYCAPNHAT,CT.NGUOICAPNHAT_ID
      FROM TT_INV_CHUNGTUNHAP CT where CT.BENHVIEN_ID = '$BENHVIEN_ID$' AND CT.MMYY IN($MMYY$)
      AND CT.MAKHO = '$MAKHO$'
      <isNotEmpty prepend="AND" property="MACHUNGTU">
        CT.MACHUNGTU LIKE '%$MACHUNGTU$%'
      </isNotEmpty>
    <isNotEmpty prepend="AND" property="TUNGAY">
       CT.NGAYCHUNGTU BETWEEN '$TUNGAY$' AND '$DENNGAY$'
      </isNotEmpty>
    <isNotEmpty prepend="AND" property="NHACUNGCAP_ID">
        CT.NHACUNGCAP_ID = '$NHACUNGCAP_ID$'
      </isNotEmpty>
      ORDER BY CT.NGAYCHUNGTU
    </statement>
  <statement id="DAO00401_INV001_GetChungTuNhapAll" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
    SELECT CT.CHUNGTUNHAP_ID,CT.MACHUNGTU,CT.MMYY,CT.NGAYCHUNGTU,CT.NHACUNGCAP_ID,CT.TENNHACUNGCAP,CT.MAKHO,CT.TENKHO,CT.NGUOINHAP_ID,CT.TENNGUOINHAP,CT.TENNGUOIGIAO,
    CT.KYHIEUHOADON,CT.SOSERI,CT.SOHOADON,CT.NGAYHOADON,CT.MATRANGTHAI,CT.TENTRANGTHAI,CT.TYLECHIETKHAU,CT.GIATRICHIETKHAU,CT.THANHTIEN,CT.THANHTIENSAUCUNG,CT.GHICHU,
    CT.CHUNGTULIENQUAN_ID,CT.MACHUNGTULIENQUAN,CTCT.TENNGUOITAO,CT.IDCHUYEN,CT.BENHVIEN_ID,CT.NGAYTAO,CT.NGUOITAO_ID,CT.NGAYCAPNHAT,CT.NGUOICAPNHAT_ID,
    (CASE WHEN CT.IDCHUYEN IS NULL THEN NULL ELSE N'Đã chuyển EAccount' END) AS CHUYENEACCOUNT,
    CTCT.CHUNGTUNHAPCHITIET_ID,CTCT.SOLUONGYEUCAU,CTCT.SOLUONGCONLAI,CTCT.SOLUONGNHAP,CTCT.GIATRIVAT,CTCT.THANHTIENTRUOCVAT,
    CTCT.THANHTIENSAUVAT,CTCT.NGAYDUKIEN,CTCT.GHICHU AS CT_GHICHU,CTCT.CHUNGTULIENQUANCHITIET_ID,CTCT.KHUYENMAI,
    TD.THEODOI_ID,TD.HANGHOA_ID,TD.MAHANGHOA,TD.TENHANGHOA,TD.DONVITINH_ID,TD.TENDONVITINH,TD.HANDUNG,TD.LOSX,TD.DONGIA,TD.DONGIASAUVAT,TD.TYLEVAT,
    TKCT.SOLUONGXUAT
    FROM TT_INV_CHUNGTUNHAP CT INNER JOIN TT_INV_CHUNGTUNHAPCHITIET CTCT ON CT.CHUNGTUNHAP_ID=CTCT.CHUNGTUNHAP_ID
    <isNotEmpty prepend="AND" property="MMYY">
      CT.MMYY IN($MMYY$)
    </isNotEmpty>
    INNER JOIN TT_INV_THEODOI TD ON CTCT.THEODOI_ID=TD.THEODOI_ID
    LEFT JOIN TT_INV_TONKHOCHITIET TKCT ON TKCT.THEODOI_ID = TD.THEODOI_ID AND TKCT.MMYY = TD.MMYY
    where CT.BENHVIEN_ID = '$BENHVIEN_ID$' AND CT.MACHUNGTU = '$MACHUNGTU$'
    AND CT.MAKHO = '$MAKHO$'
    <isNotEmpty prepend="AND" property="MMYY">
      CT.MMYY IN($MMYY$)
    </isNotEmpty>
    ORDER BY TD.TENHANGHOA
  </statement>
    <statement id="DAO00401_INV001_KiemTraMaPhieuYeuCauDaXuatKho" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select SUM(CTCT.SOLUONGDAXUAT) AS SOLUONGDAXUAT
      FROM TT_INV_PHIEUYEUCAU CT INNER JOIN TT_INV_PHIEUYEUCAUCHITIET CTCT ON CT.PHIEUYEUCAU_ID=CTCT.PHIEUYEUCAU_ID AND CT.MMYY='$MMYY$'
      where CT.MMYY='$MMYY$' AND CT.PHIEUYEUCAU_ID = '$PHIEUYEUCAU_ID$' AND CT.BENHVIEN_ID = '$BENHVIEN_ID$'
    </statement>
    <statement id="DAO00401_INV001_KiemTraMaPhieuYeuCauTonTai" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select CT.MAPHIEUYEUCAU
      FROM TT_INV_PHIEUYEUCAU CT
      where CT.MAPHIEUYEUCAU = '$MAPHIEUYEUCAU$' AND CT.BENHVIEN_ID = '$BENHVIEN_ID$'
    </statement>
    
    <statement id="DAO00401_INV001_GetTonKho" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      SELECT TKTH.HANGHOA_ID,TKTH.MAHANGHOA,TKTH.TENHANGHOA,HH.DONVITINH_ID,HH.TENDONVITINH,SUM(TKTH.SOLUONGTONDAU+TKTH.SOLUONGNHAP-TKTH.SOLUONGXUAT) AS SOLUONGTONCUOI
      FROM TM_PUR_HANGHOA HH INNER JOIN TT_INV_TONKHOTONGHOP TKTH ON HH.ID = TKTH.HANGHOA_ID
      where TKTH.BENHVIEN_ID = '$BENHVIEN_ID$' AND TKTH.MAKHO = '$MAKHO$' AND TKTH.MMYY='$MMYY$'
      GROUP BY TKTH.HANGHOA_ID,TKTH.MAHANGHOA,TKTH.TENHANGHOA,HH.DONVITINH_ID,HH.TENDONVITINH
    </statement>
    <statement id="DAO00401_INV001_GetTonKhoChiTiet" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      SELECT TD.THEODOI_ID,TD.HANGHOA_ID,TD.MAHANGHOA,TD.TENHANGHOA,TD.DONVITINH_ID,TD.TENDONVITINH,TD.DONGIA AS DONGIATRUOCVAT,TD.DONGIASAUVAT AS DONGIA,CASE WHEN TD.HANDUNG IS NULL THEN DATEADD(YEAR,999, GETDATE()) ELSE TD.HANDUNG END AS HANDUNG ,TD.NGAYTAO,
      SUM(TKCT.SOLUONGTONDAU+TKCT.SOLUONGNHAP-TKCT.SOLUONGXUAT) AS SOLUONGTONCUOI
      FROM TM_PUR_HANGHOA HH INNER JOIN TT_INV_THEODOI TD ON HH.ID = TD.HANGHOA_ID
      INNER JOIN TT_INV_TONKHOCHITIET TKCT ON TD.THEODOI_ID = TKCT.THEODOI_ID
      where TKCT.BENHVIEN_ID = '$BENHVIEN_ID$' AND TKCT.MAKHO = '$MAKHO$' AND TKCT.MMYY='$MMYY$'
      GROUP BY TD.THEODOI_ID,TD.HANGHOA_ID,TD.MAHANGHOA,TD.TENHANGHOA,TD.DONVITINH_ID,TD.TENDONVITINH,TD.DONGIA,TD.DONGIASAUVAT,TD.HANDUNG,TD.NGAYTAO
      ORDER BY TD.NGAYTAO
    </statement>
    
    <statement id="DAO00401_INV001_GetTonKhoChiTietTongTon" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      SELECT TD.THEODOI_ID,TD.HANGHOA_ID,TD.MAHANGHOA,TD.TENHANGHOA,TD.DONVITINH_ID,TD.TENDONVITINH,TD.DONGIA AS DONGIATRUOCVAT,
      TD.DONGIASAUVAT AS DONGIA,CONVERT(VARCHAR(10),TD.HANDUNG,103) HANDUNG, TD.HANDUNG as HANDUNGDT,
      TD.LOSX,CONVERT(VARCHAR(10),TD.NGAYTAO,103) +' '+CONVERT(VARCHAR(10),TD.NGAYTAO,108) NGAYTAO,
      SUM(TKCT.SOLUONGTONDAU+TKCT.SOLUONGNHAP-TKCT.SOLUONGXUAT) AS SOLUONGTONCHITIET,SUM(TKTH.SOLUONGTONDAU+TKTH.SOLUONGNHAP-TKTH.SOLUONGXUAT) AS SOLUONGTONCUOI
      FROM TM_PUR_HANGHOA HH INNER JOIN TT_INV_THEODOI TD ON HH.ID = TD.HANGHOA_ID
      INNER JOIN TT_INV_TONKHOTONGHOP TKTH ON HH.ID = TKTH.HANGHOA_ID AND TKTH.MMYY='$MMYY$'
      INNER JOIN TT_INV_TONKHOCHITIET TKCT ON TD.THEODOI_ID = TKCT.THEODOI_ID AND TKCT.MMYY='$MMYY$'
      where TKCT.MMYY='$MMYY$' AND TKCT.BENHVIEN_ID = '$BENHVIEN_ID$' AND TKCT.MAKHO = '$MAKHO$'
      GROUP BY TD.THEODOI_ID,TD.HANGHOA_ID,TD.MAHANGHOA,TD.TENHANGHOA,TD.DONVITINH_ID,TD.TENDONVITINH,TD.DONGIA,TD.DONGIASAUVAT,TD.HANDUNG,TD.NGAYTAO,TD.LOSX
      <isNotEmpty prepend="" property="LISTCHUNGTUTANGGIAMCHITIET_ID">
        UNION ALL
        SELECT TD.THEODOI_ID,TD.HANGHOA_ID,TD.MAHANGHOA,TD.TENHANGHOA,TD.DONVITINH_ID,TD.TENDONVITINH,TD.DONGIA AS DONGIATRUOCVAT,
        TD.DONGIASAUVAT AS DONGIA,CONVERT(VARCHAR(10),TD.HANDUNG,103) HANDUNG,TD.HANDUNG as HANDUNGDT,
        TD.LOSX,CONVERT(VARCHAR(10),TD.NGAYTAO,103) +' '+CONVERT(VARCHAR(10),TD.NGAYTAO,108) NGAYTAO,
        0 AS SOLUONGTONCHITIET,0 AS SOLUONGTONCUOI
        FROM TM_PUR_HANGHOA HH INNER JOIN TT_INV_THEODOI TD ON HH.ID = TD.HANGHOA_ID
        INNER JOIN TT_INV_TONKHOTONGHOP TKTH ON HH.ID = TKTH.HANGHOA_ID
        INNER JOIN TT_INV_TONKHOCHITIET TKCT ON TD.THEODOI_ID = TKCT.THEODOI_ID
        INNER JOIN TT_INV_CHUNGTUTANGGIAMCHITIET CTCT ON TD.THEODOI_ID=CTCT.THEODOI_ID
        WHERE CTCT.CHUNGTUTANGGIAMCHITIET_ID IN($LISTCHUNGTUTANGGIAMCHITIET_ID$)
      </isNotEmpty>
      <!--ORDER BY TD.TENHANGHOA-->
    </statement>
    <statement id="DAO00401_INV001_DelPhieuYeuCauAll" parameterClass="System.String" resultClass="System.Int64">
      DELETE FROM TT_INV_PHIEUYEUCAUCHITIET WHERE MMYY='$MMYY$' AND PHIEUYEUCAU_ID='$PHIEUYEUCAU_ID$' AND BENHVIEN_ID = '$BENHVIEN_ID$';
      DELETE FROM TT_INV_PHIEUYEUCAU WHERE MMYY='$MMYY$' AND PHIEUYEUCAU_ID='$PHIEUYEUCAU_ID$' AND BENHVIEN_ID = '$BENHVIEN_ID$';
    </statement>
    <statement id="DAO00401_INV001_DelPhieuYeuCauChiTietTheoID" parameterClass="System.String" resultClass="System.Int64">
      DELETE FROM TT_INV_PHIEUYEUCAUCHITIET WHERE MMYY='$MMYY$' AND PHIEUYEUCAUCHITIET_ID='$PHIEUYEUCAUCHITIET_ID$' AND BENHVIEN_ID = '$BENHVIEN_ID$';
    </statement>
    <statement id="DAO00401_INV001_GetPhieuYeuCau" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select YC.PHIEUYEUCAU_ID,YC.MAPHIEUYEUCAU,YC.MMYY,YC.NGAYLAP,YC.PHONGBAN_ID,YC.TENPHONGBAN,YC.MAKHOXUAT,YC.TENKHOXUAT,YC.GHICHU,YC.TENNGUOITAO,YC.TENNGUOICAPNHAT,YC.BENHVIEN_ID,YC.NGAYTAO,YC.NGUOITAO_ID,YC.NGAYCAPNHAT,YC.NGUOICAPNHAT_ID,
      YCCT.PHIEUYEUCAUCHITIET_ID,YCCT.HANGHOA_ID,YCCT.MAHANGHOA,YCCT.TENHANGHOA,YCCT.DONVITINH_ID,YCCT.TENDONVITINH,YCCT.SOLUONGYEUCAU,YCCT.SOLUONGDAXUAT
      FROM TT_INV_PHIEUYEUCAU YC INNER JOIN TT_INV_PHIEUYEUCAUCHITIET YCCT ON YC.PHIEUYEUCAU_ID=YCCT.PHIEUYEUCAU_ID
      where YC.MAPHIEUYEUCAU='$MAPHIEUYEUCAU$' AND YC.BENHVIEN_ID = '$BENHVIEN_ID$'
      <isNotEmpty prepend="AND" property="NGUOITAO_ID">
        YC.NGUOITAO_ID = '$NGUOITAO_ID$'
      </isNotEmpty>
    </statement>
    <statement id="DAO00401_INV001_AddPhieuYeuCau" parameterClass="System.String" resultClass="System.Int64">
      INSERT INTO TT_INV_PHIEUYEUCAU(MAPHIEUYEUCAU,MMYY,NGAYLAP,PHONGBAN_ID,TENPHONGBAN,MAKHOXUAT,TENKHOXUAT,GHICHU,TENNGUOITAO,BENHVIEN_ID,NGAYTAO,NGUOITAO_ID)
      VALUES(#MAPHIEUYEUCAU#,#MMYY#,#NGAYLAP#,#PHONGBAN_ID#,#TENPHONGBAN#,#MAKHOXUAT#,#TENKHOXUAT#,#GHICHU#,#TENNGUOITAO#,#BENHVIEN_ID#,GETDATE(),#NGUOITAO_ID#)
      SELECT SCOPE_IDENTITY()
    </statement>
    <update id="DAO00401_INV001_UpdPhieuYeuCau" parameterClass="DataObject">
      UPDATE TT_INV_PHIEUYEUCAU
      SET MMYY = #MMYY#,NGAYLAP = #NGAYLAP#,PHONGBAN_ID = #PHONGBAN_ID#,TENPHONGBAN = #TENPHONGBAN#,MAKHOXUAT = #MAKHOXUAT#,TENKHOXUAT = #TENKHOXUAT#,GHICHU = #GHICHU#,TENNGUOICAPNHAT = #TENNGUOICAPNHAT#,NGAYCAPNHAT = GETDATE(),NGUOICAPNHAT_ID = #NGUOICAPNHAT_ID#
      WHERE PHIEUYEUCAU_ID = '$PHIEUYEUCAU_ID$' AND BENHVIEN_ID = '$BENHVIEN_ID$'
    </update>
    <statement id="DAO00401_INV001_DelPhieuYeuCauChiTiet" parameterClass="System.String" resultClass="System.Int64">
      DELETE FROM TT_INV_PHIEUYEUCAUCHITIET WHERE MMYY='$MMYY$' AND PHIEUYEUCAU_ID = '$PHIEUYEUCAU_ID$' AND BENHVIEN_ID = '$BENHVIEN_ID$';
    </statement>
    <statement id="DAO00401_INV001_AddPhieuYeuCauChiTiet" parameterClass="System.String" resultClass="System.Int64">
      INSERT INTO TT_INV_PHIEUYEUCAUCHITIET(PHIEUYEUCAU_ID,MMYY,HANGHOA_ID,MAHANGHOA,TENHANGHOA,DONVITINH_ID,TENDONVITINH,SOLUONGYEUCAU,SOLUONGDAXUAT,TENNGUOITAO,BENHVIEN_ID,NGAYTAO,NGUOITAO_ID)
      VALUES(#PHIEUYEUCAU_ID#,#MMYY#,#HANGHOA_ID#,#MAHANGHOA#,#TENHANGHOA#,#DONVITINH_ID#,#TENDONVITINH#,#SOLUONGYEUCAU#,#SOLUONGDAXUAT#,#TENNGUOITAO#,#BENHVIEN_ID#,GETDATE(),#NGUOITAO_ID#)
      SELECT SCOPE_IDENTITY()
    </statement>
    <statement id="DAO00401_INV001_PhieuYeuCauSearch" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select YC.PHIEUYEUCAU_ID,YC.MAPHIEUYEUCAU,YC.MMYY,YC.NGAYLAP,YC.PHONGBAN_ID,YC.TENPHONGBAN,YC.MAKHOXUAT,YC.TENKHOXUAT,YC.GHICHU,YC.TENNGUOITAO,YC.TENNGUOICAPNHAT,YC.BENHVIEN_ID,YC.NGAYTAO,YC.NGUOITAO_ID,YC.NGAYCAPNHAT,YC.NGUOICAPNHAT_ID
      FROM TT_INV_PHIEUYEUCAU YC
      WHERE YC.BENHVIEN_ID = '$BENHVIEN_ID$' AND YC.NGAYLAP BETWEEN '$TUNGAY$' AND '$DENNGAY$'
      <isNotEmpty prepend="AND" property="MAPHIEUYEUCAU">
        YC.MAPHIEUYEUCAU LIKE '%$MAPHIEUYEUCAU$%'
      </isNotEmpty>
      <isNotEmpty prepend="AND" property="NGUOITAO_ID">
        YC.NGUOITAO_ID = '$NGUOITAO_ID$'
      </isNotEmpty>
      <isNotEmpty prepend="AND" property="CHUNGTUXUAT_ID">
        YC.CHUNGTUXUAT_ID IS NULL
      </isNotEmpty>
      <isNotEmpty prepend="AND" property="MAKHOXUAT">
        YC.MAKHOXUAT = '$MAKHOXUAT$'
      </isNotEmpty>
    </statement>
    <statement id="DAO00401_INV001_GetPhieuYeuCauChiTiet_PhieuYeuCauID" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select YCCT.PHIEUYEUCAUCHITIET_ID,YCCT.HANGHOA_ID,YCCT.MAHANGHOA,YCCT.TENHANGHOA,YCCT.DONVITINH_ID,YCCT.TENDONVITINH,YCCT.SOLUONGYEUCAU,YCCT.SOLUONGDAXUAT
      FROM TT_INV_PHIEUYEUCAUCHITIET YCCT
      WHERE YCCT.BENHVIEN_ID = '$BENHVIEN_ID$' AND YCCT.PHIEUYEUCAU_ID='$PHIEUYEUCAU_ID$'
    </statement>
    <statement id="DAO00401_INV001_GetNhanVien" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      SELECT DISTINCT N.*
      <!--,NHANVIENMAP.USERID AS USER_ID-->
      ,N.NHANVIEN_ID AS NHANVIENNHAN_ID,N.TENNHANVIEN AS TENNHANVIENNHAN 
      FROM TM_NHANVIEN N
      <!--LEFT JOIN TBL_USER NHANVIENMAP ON NHANVIENMAP.EMPLOYEEID = N.NHANVIEN_ID-->
      ORDER BY N.TENNHANVIEN
    </statement>
    <statement id="DAO00401_INV001_GetDMNhanVien" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      SELECT NHANVIEN_ID,TENNHANVIEN,NHANVIEN_ID AS NHANVIENNHAN_ID,TENNHANVIEN AS TENNHANVIENNHAN FROM [TM_NHANVIEN]
      where BENHVIEN_ID = '$BENHVIEN_ID$'
      ORDER BY TENNHANVIEN
    </statement>
    <statement id="DAO00401_INV001_KiemTraMaChungTuXuatTonTai" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select CT.IDCHUYEN
      FROM TT_INV_CHUNGTUXUAT CT
      where CT.MACHUNGTU = '$MACHUNGTU$' AND CT.BENHVIEN_ID = '$BENHVIEN_ID$'
      <isNotEmpty prepend="AND" property="MMYY">
      CT.MMYY IN($MMYY$)
    </isNotEmpty>
    </statement>
    <statement id="DAO00401_INV001_DelChungTuXuatAll" parameterClass="System.String" resultClass="System.Int64">
      DELETE FROM TT_INV_CHUNGTUXUATCHITIET WHERE MMYY='$MMYY$' AND CHUNGTUXUAT_ID='$CHUNGTUXUAT_ID$';
      DELETE FROM TT_INV_CHUNGTUXUAT WHERE MMYY='$MMYY$' AND CHUNGTUXUAT_ID='$CHUNGTUXUAT_ID$';
      UPDATE TT_INV_PHIEUYEUCAUCHITIET SET SOLUONGDAXUAT=0 WHERE PHIEUYEUCAU_ID = '$PHIEUYEUCAU_ID$' AND BENHVIEN_ID = '$BENHVIEN_ID$';
      UPDATE TT_INV_PHIEUYEUCAU SET CHUNGTUXUAT_ID=NULL WHERE PHIEUYEUCAU_ID = '$PHIEUYEUCAU_ID$' AND BENHVIEN_ID = '$BENHVIEN_ID$';
    </statement>
    <statement id="DAO00401_INV001_UpdSLXuatTonKho" parameterClass="DataObject">
      UPDATE TT_INV_TONKHOCHITIET SET SOLUONGXUAT=0 WHERE MMYY='$MMYY$' AND MAKHO IN($LISTMAKHO$);
      MERGE TT_INV_TONKHOCHITIET AS X USING
      (SELECT QQ.MMYY, QQ.MAKHO,QQ.TENKHO,QQ.THEODOI_ID,SUM(QQ.SOLUONGXUAT) AS SOLUONGXUAT FROM (
      SELECT '$MMYY$' AS MMYY, A.MAKHOXUAT AS MAKHO,A.TENKHOXUAT AS TENKHO,B.THEODOI_ID,B.SOLUONGXUAT,C.NGAYTAO,C.NGUOITAO_ID
      FROM TT_INV_CHUNGTUXUAT A INNER JOIN TT_INV_CHUNGTUXUATCHITIET B ON A.CHUNGTUXUAT_ID=B.CHUNGTUXUAT_ID AND A.MMYY='$MMYY$'
      INNER JOIN TT_INV_THEODOI C ON B.THEODOI_ID=C.THEODOI_ID
      WHERE A.MMYY='$MMYY$' AND A.BENHVIEN_ID='$BENHVIEN_ID$' AND A.MAKHOXUAT IN($LISTMAKHO$)
      UNION ALL
      SELECT '$MMYY$' AS MMYY, A.MAKHO,A.TENKHO,B.THEODOI_ID,B.SOLUONG AS SOLUONGXUAT,C.NGAYTAO,C.NGUOITAO_ID
      FROM TT_INV_CHUNGTUTANGGIAM A INNER JOIN TT_INV_CHUNGTUTANGGIAMCHITIET B ON A.CHUNGTUTANGGIAM_ID=B.CHUNGTUTANGGIAM_ID AND A.MMYY='$MMYY$' AND A.LOAI='giam'
      INNER JOIN TT_INV_THEODOI C ON B.THEODOI_ID=C.THEODOI_ID
      WHERE A.MMYY='$MMYY$' AND A.LOAI='giam' AND A.BENHVIEN_ID='$BENHVIEN_ID$' AND A.MAKHO IN($LISTMAKHO$)) QQ
      GROUP BY QQ.MMYY, QQ.MAKHO,QQ.TENKHO,QQ.THEODOI_ID) AS Y
      ON (X.MMYY=Y.MMYY AND X.MAKHO=Y.MAKHO AND X.THEODOI_ID=Y.THEODOI_ID)
      WHEN MATCHED THEN UPDATE SET X.SOLUONGXUAT=Y.SOLUONGXUAT
      WHEN NOT MATCHED THEN
      
      INSERT (MMYY,MAKHO,TENKHO,THEODOI_ID,SOLUONGXUAT,BENHVIEN_ID,NGAYTAO,NGUOITAO_ID) VALUES
      ('$MMYY$',Y.MAKHO,Y.TENKHO,Y.THEODOI_ID,Y.SOLUONGXUAT,#BENHVIEN_ID#,GETDATE(), '');

      UPDATE TT_INV_TONKHOTONGHOP SET SOLUONGTONDAU=0,SOLUONGNHAP=0,SOLUONGXUAT=0 WHERE MMYY='$MMYY$' AND MAKHO IN($LISTMAKHO$);
      MERGE TT_INV_TONKHOTONGHOP AS X USING
      (SELECT '$MMYY$' AS MMYY,A.MAKHO,A.TENKHO,B.HANGHOA_ID,B.MAHANGHOA,HH.TEN,SUM(A.SOLUONGTONDAU) AS SOLUONGTONDAU,SUM(A.SOLUONGNHAP) AS SOLUONGNHAP,SUM(A.SOLUONGXUAT) AS SOLUONGXUAT
      FROM TT_INV_TONKHOCHITIET A INNER JOIN TT_INV_THEODOI B ON A.THEODOI_ID=B.THEODOI_ID AND A.MMYY='$MMYY$'
      JOIN TM_PUR_HANGHOA HH on HH.ID = B.HANGHOA_ID
      WHERE A.MMYY='$MMYY$' AND A.BENHVIEN_ID='$BENHVIEN_ID$' AND A.MAKHO IN($LISTMAKHO$)
      GROUP BY A.MAKHO,A.TENKHO,B.HANGHOA_ID,B.MAHANGHOA,HH.TEN) AS Y
      ON (X.MMYY=Y.MMYY AND X.MAKHO=Y.MAKHO AND X.HANGHOA_ID=Y.HANGHOA_ID)

      WHEN MATCHED THEN UPDATE SET X.SOLUONGTONDAU=Y.SOLUONGTONDAU, X.SOLUONGNHAP=Y.SOLUONGNHAP,X.SOLUONGXUAT=Y.SOLUONGXUAT
      WHEN NOT MATCHED THEN
      
      INSERT (MMYY,MAKHO,TENKHO,HANGHOA_ID,MAHANGHOA,TENHANGHOA,SOLUONGTONDAU,SOLUONGNHAP,SOLUONGXUAT,BENHVIEN_ID,NGAYTAO)
      VALUES ('$MMYY$',Y.MAKHO,Y.TENKHO,Y.HANGHOA_ID,Y.MAHANGHOA,Y.TEN,Y.SOLUONGTONDAU,Y.SOLUONGNHAP,Y.SOLUONGXUAT,#BENHVIEN_ID#,GETDATE());

      DELETE FROM TT_INV_TONKHOCHITIET WHERE SOLUONGTONDAU=0 AND SOLUONGNHAP=0 AND SOLUONGXUAT=0;
      DELETE FROM TT_INV_TONKHOTONGHOP WHERE SOLUONGTONDAU=0 AND SOLUONGNHAP=0 AND SOLUONGXUAT=0;
    </statement>
    <statement id="DAO00401_INV001_GetChungTuXuatAll" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      SELECT CT.CHUNGTUXUAT_ID,CT.MACHUNGTU,CT.MMYY,CT.NGAYCHUNGTU,CT.MAKHOXUAT,CT.TENKHOXUAT,CT.PHONGBANNHAN_ID,CT.TENPHONGBANNHAN,CT.NHANVIENNHAN_ID,CT.TENNHANVIENNHAN,
      CT.GHICHU,CT.PHIEUYEUCAU_ID,CT.MAPHIEUYEUCAU,CT.XUATKHOTHEO,CT.TENNGUOITAO,CT.TENNGUOICAPNHAT,CT.IDCHUYEN,CT.BENHVIEN_ID,CT.NGAYTAO,CT.NGUOITAO_ID,CT.NGAYCAPNHAT,CT.NGUOICAPNHAT_ID,
      CTCT.SOLUONGYEUCAU,CTCT.SOLUONGXUAT,CTCT.THANHTIEN,CTCT.GHICHU AS CT_GHICHU,CTCT.PHIEUYEUCAUCHITIET_ID,
      TD.THEODOI_ID,TD.HANGHOA_ID,TD.MAHANGHOA,TD.TENHANGHOA,TD.DONVITINH_ID,TD.TENDONVITINH,TD.HANDUNG,TD.LOSX,TD.DONGIASAUVAT AS DONGIA
      , CT.MUCDICHCHUNGTU_ID, CT.MUCDICHCHUNGTU_CODE
      FROM TT_INV_CHUNGTUXUAT CT INNER JOIN TT_INV_CHUNGTUXUATCHITIET CTCT ON CT.CHUNGTUXUAT_ID=CTCT.CHUNGTUXUAT_ID
      <isNotEmpty prepend="AND" property="MMYY">
      CT.MMYY IN($MMYY$)
    </isNotEmpty>
    INNER JOIN TT_INV_THEODOI TD ON CTCT.THEODOI_ID=TD.THEODOI_ID
    where CT.BENHVIEN_ID = '$BENHVIEN_ID$' AND CT.MACHUNGTU = '$MACHUNGTU$'
    <isNotEmpty prepend="AND" property="MMYY">
      CT.MMYY IN($MMYY$)
    </isNotEmpty>
    ORDER BY TD.TENHANGHOA
    </statement>
    
    <statement id="DAO00401_INV001_ChungTuXuatSearch" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select CT.CHUNGTUXUAT_ID,CT.MACHUNGTU,CT.MMYY,CT.NGAYCHUNGTU,CT.MAKHOXUAT,CT.TENKHOXUAT,CT.PHONGBANNHAN_ID,CT.TENPHONGBANNHAN,CT.NHANVIENNHAN_ID,CT.TENNHANVIENNHAN,
      CT.GHICHU,CT.PHIEUYEUCAU_ID,CT.MAPHIEUYEUCAU,CT.XUATKHOTHEO,CT.TENNGUOITAO,CT.TENNGUOICAPNHAT,CT.IDCHUYEN,CT.BENHVIEN_ID,CT.NGAYTAO,CT.NGUOITAO_ID,CT.NGAYCAPNHAT,CT.NGUOICAPNHAT_ID
      FROM TT_INV_CHUNGTUXUAT CT
      WHERE CT.BENHVIEN_ID = '$BENHVIEN_ID$' AND CT.NGAYCHUNGTU BETWEEN '$TUNGAY$' AND '$DENNGAY$'
      AND CT.MAKHOXUAT = '$MAKHO$'
      <isNotEmpty prepend="AND" property="MACHUNGTU">
         (CT.MACHUNGTU LIKE '%$MACHUNGTU$' OR CT.MAPHIEUYEUCAU LIKE '%$MACHUNGTU$')
      </isNotEmpty>

      UNION

      select CT.CHUNGTUXUAT_ID,CT.MACHUNGTU,CT.MMYY,CT.NGAYCHUNGTU,CT.MAKHOXUAT,CT.TENKHOXUAT,CT.PHONGBANNHAN_ID,CT.TENPHONGBANNHAN,CT.NHANVIENNHAN_ID,CT.TENNHANVIENNHAN,
      CT.GHICHU,CT.PHIEUYEUCAU_ID,CT.MAPHIEUYEUCAU,CT.XUATKHOTHEO,CT.TENNGUOITAO,CT.TENNGUOICAPNHAT,CT.IDCHUYEN,CT.BENHVIEN_ID,CT.NGAYTAO,CT.NGUOITAO_ID,CT.NGAYCAPNHAT,CT.NGUOICAPNHAT_ID
      FROM TT_INV_CHUNGTUXUAT CT
      WHERE CT.BENHVIEN_ID = '$BENHVIEN_ID$' AND CT.NGAYCHUNGTU BETWEEN '$TUNGAY$' AND '$DENNGAY$'
      AND CT.MAKHOXUAT = '$MAKHO$'
      <isNotEmpty prepend="AND" property="MACHUNGTU">
         (CT.MACHUNGTU LIKE '%$MACHUNGTU$%' OR CT.MAPHIEUYEUCAU LIKE '%$MACHUNGTU$%')
      </isNotEmpty>
    </statement>
    <statement id="DAO00401_INV001_GetChungTuXuatChiTiet_ChungTuID" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select CTCT.SOLUONGYEUCAU,CTCT.SOLUONGXUAT,CTCT.THANHTIEN,CTCT.GHICHU AS CT_GHICHU,CTCT.PHIEUYEUCAUCHITIET_ID,
      TD.THEODOI_ID,TD.HANGHOA_ID,TD.MAHANGHOA,TD.TENHANGHOA,TD.DONVITINH_ID,TD.TENDONVITINH,TD.HANDUNG,TD.LOSX,TD.DONGIASAUVAT AS DONGIA
      FROM TT_INV_CHUNGTUXUATCHITIET CTCT INNER JOIN TT_INV_THEODOI TD ON CTCT.THEODOI_ID=TD.THEODOI_ID
      WHERE CTCT.BENHVIEN_ID = '$BENHVIEN_ID$' AND CTCT.CHUNGTUXUAT_ID='$CHUNGTUXUAT_ID$'
    </statement>
    <statement id="DAO00401_INV001_GetChiTietYC_MaPhieuYeuCau" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select YC.PHIEUYEUCAU_ID,YC.MAPHIEUYEUCAU,YC.MMYY,YC.NGAYLAP,YC.PHONGBAN_ID AS PHONGBANNHAN_ID,YC.TENPHONGBAN AS TENPHONGBANNHAN,YC.MAKHOXUAT,YC.TENKHOXUAT,
      YCCT.PHIEUYEUCAUCHITIET_ID,YCCT.HANGHOA_ID,YCCT.MAHANGHOA,YCCT.TENHANGHOA,YCCT.DONVITINH_ID,YCCT.TENDONVITINH,YCCT.SOLUONGYEUCAU,YCCT.SOLUONGYEUCAU AS SOLUONGXUAT, NULL AS DONGIA,NULL AS LOSX,NULL AS HANDUNG,
      TKTH.SOLUONGTONCUOI
      FROM TT_INV_PHIEUYEUCAU YC INNER JOIN TT_INV_PHIEUYEUCAUCHITIET YCCT ON YC.PHIEUYEUCAU_ID=YCCT.PHIEUYEUCAU_ID
      LEFT JOIN (SELECT (SOLUONGTONDAU+SOLUONGNHAP-SOLUONGXUAT) AS SOLUONGTONCUOI, HANGHOA_ID,MAKHO
      FROM TT_INV_TONKHOTONGHOP WHERE BENHVIEN_ID='$BENHVIEN_ID$' AND MMYY='$MMYY$'
      ) TKTH ON YCCT.HANGHOA_ID = TKTH.HANGHOA_ID AND YC.MAKHOXUAT = TKTH.MAKHO
      WHERE YC.MAPHIEUYEUCAU='$MAPHIEUYEUCAU$' AND YC.BENHVIEN_ID = '$BENHVIEN_ID$'
    </statement>
    <statement id="DAO00401_INV001_DelChungTuXuatChiTietTheoID" parameterClass="System.String" resultClass="System.Int64">
      DELETE FROM TT_INV_CHUNGTUXUATCHITIET WHERE MMYY='$MMYY$' AND CHUNGTUXUATCHITIET_ID='$CHUNGTUXUATCHITIET_ID$';
    </statement>
    <update id="DAO00401_INV001_UpdSLDaXuat_PhieuYeuCauChiTietID" parameterClass="DataObject">
      UPDATE TT_INV_PHIEUYEUCAUCHITIET
      SET SOLUONGDAXUAT=#SOLUONGXUAT#
      WHERE PHIEUYEUCAUCHITIET_ID = '$LISTPHIEUYEUCAUCHITIET_ID$' AND BENHVIEN_ID = '$BENHVIEN_ID$'
    </update>
  <statement id="DAO00401_INV001_AddChungTuXuat" parameterClass="System.Collections.IDictionary" resultClass="System.Int64">
    INSERT INTO TT_INV_CHUNGTUXUAT
    (MACHUNGTU,MMYY,NGAYCHUNGTU,MAKHOXUAT,TENKHOXUAT,PHONGBANNHAN_ID,TENPHONGBANNHAN,NHANVIENNHAN_ID,TENNHANVIENNHAN,GHICHU,PHIEUYEUCAU_ID,MAPHIEUYEUCAU,XUATKHOTHEO,TENNGUOITAO,BENHVIEN_ID,NGAYTAO,NGUOITAO_ID
    <isPropertyAvailable prepend="" property="MUCDICHCHUNGTU_ID">
      , MUCDICHCHUNGTU_ID
    </isPropertyAvailable>
    <isPropertyAvailable prepend="" property="MUCDICHCHUNGTU_CODE">
      , MUCDICHCHUNGTU_CODE
    </isPropertyAvailable>
    )
    VALUES (#MACHUNGTU#,#MMYY#,#NGAYCHUNGTU#,#MAKHOXUAT#,#TENKHOXUAT#,#PHONGBANNHAN_ID#,#TENPHONGBANNHAN#,#NHANVIENNHAN_ID#,#TENNHANVIENNHAN#,#GHICHU#,#PHIEUYEUCAU_ID#,#MAPHIEUYEUCAU#,#XUATKHOTHEO#,#TENNGUOITAO#,#BENHVIEN_ID#,GETDATE(),#NGUOITAO_ID#
    <isPropertyAvailable prepend="" property="MUCDICHCHUNGTU_ID">
      , #MUCDICHCHUNGTU_ID#
    </isPropertyAvailable>
    <isPropertyAvailable prepend="" property="MUCDICHCHUNGTU_CODE">
      , #MUCDICHCHUNGTU_CODE#
    </isPropertyAvailable>
    )
    SELECT SCOPE_IDENTITY()
  
</statement>
  <update id="DAO00401_INV001_UpdChungTuXuat" parameterClass="DataObject">
    UPDATE TT_INV_CHUNGTUXUAT
    SET MAKHOXUAT = #MAKHOXUAT#,TENKHOXUAT = #TENKHOXUAT#,PHONGBANNHAN_ID = #PHONGBANNHAN_ID#,TENPHONGBANNHAN = #TENPHONGBANNHAN#,NHANVIENNHAN_ID = #NHANVIENNHAN_ID#,TENNHANVIENNHAN = #TENNHANVIENNHAN#,
    GHICHU = #GHICHU#,PHIEUYEUCAU_ID = #PHIEUYEUCAU_ID#,MAPHIEUYEUCAU = #MAPHIEUYEUCAU#,XUATKHOTHEO = #XUATKHOTHEO#,TENNGUOICAPNHAT = #TENNGUOICAPNHAT#,BENHVIEN_ID = #BENHVIEN_ID#,NGAYCAPNHAT = GETDATE(),
    NGUOICAPNHAT_ID = #NGUOICAPNHAT_ID#
    <isPropertyAvailable prepend="" property="MUCDICHCHUNGTU_ID">
      , MUCDICHCHUNGTU_ID = #MUCDICHCHUNGTU_ID#
    </isPropertyAvailable>
    <isPropertyAvailable prepend="" property="MUCDICHCHUNGTU_CODE">
      , MUCDICHCHUNGTU_CODE = #MUCDICHCHUNGTU_CODE#
    </isPropertyAvailable>
      WHERE CHUNGTUXUAT_ID = '$CHUNGTUXUAT_ID$'
    </update>
  <statement id="DAO00401_INV001_DelChungTuXuatChiTiet" parameterClass="System.String" resultClass="System.Int64">
      DELETE FROM TT_INV_CHUNGTUXUATCHITIET WHERE MMYY='$MMYY$' AND CHUNGTUXUAT_ID='$CHUNGTUXUAT_ID$';
    </statement>
<statement id="DAO00401_INV001_AddChungTuXuatChiTiet" parameterClass="System.String" resultClass="System.Int64">
      INSERT INTO TT_INV_CHUNGTUXUATCHITIET(CHUNGTUXUAT_ID,MMYY,THEODOI_ID,SOLUONGYEUCAU,SOLUONGXUAT,THANHTIEN,GHICHU,PHIEUYEUCAUCHITIET_ID,TENNGUOITAO,BENHVIEN_ID,NGAYTAO,NGUOITAO_ID)
     VALUES(#CHUNGTUXUAT_ID#,#MMYY#,#THEODOI_ID#,#SOLUONGYEUCAU#,#SOLUONGXUAT#,#THANHTIEN#,#CT_GHICHU#,#PHIEUYEUCAUCHITIET_ID#,#TENNGUOITAO#,#BENHVIEN_ID#,GETDATE(),#NGUOITAO_ID#)
      SELECT SCOPE_IDENTITY()
    </statement>
  <update id="DAO00401_INV001_UpdChungTuXuatID_PhieuYeuCau" parameterClass="DataObject">
      UPDATE TT_INV_PHIEUYEUCAU SET CHUNGTUXUAT_ID = #CHUNGTUXUAT_ID# WHERE PHIEUYEUCAU_ID = '$PHIEUYEUCAU_ID$' AND BENHVIEN_ID = '$BENHVIEN_ID$'
    </update>
    <statement id="DAO00401_INV001_TinhSoDuDauKy" parameterClass="DataObject">
      UPDATE TT_INV_TONKHOCHITIET SET SOLUONGTONDAU=0 WHERE MMYY='$MMYY$' AND MAKHO IN($LISTMAKHO$);
      MERGE TT_INV_TONKHOCHITIET AS X USING (
      SELECT TK.MMYY, TK.MAKHO,TK.TENKHO,TK.THEODOI_ID,SUM(TK.SOLUONGTONDAU+TK.SOLUONGNHAP-TK.SOLUONGXUAT) AS SOLUONGTONDAU
      FROM
      <!--So luong ton dau-->
      (SELECT '$MMYY$' AS MMYY, A.MAKHO,A.TENKHO,B.THEODOI_ID,A.SOLUONGTONDAU,0 AS SOLUONGNHAP,0 AS SOLUONGXUAT,B.NGAYTAO,B.NGUOITAO_ID
      FROM TT_INV_TONKHOCHITIET A INNER JOIN TT_INV_THEODOI B ON A.THEODOI_ID=B.THEODOI_ID AND A.MMYY='$MMYYTRUOC$'
      WHERE A.MMYY='$MMYYTRUOC$' AND A.BENHVIEN_ID='$BENHVIEN_ID$' AND A.MAKHO IN($LISTMAKHO$)
      UNION ALL
      <!--So luong xuat-->
      SELECT '$MMYY$' AS MMYY, A.MAKHOXUAT AS MAKHO,A.TENKHOXUAT AS TENKHO,B.THEODOI_ID,0 AS SOLUONGTONDAU,0 AS SOLUONGNHAP,B.SOLUONGXUAT,C.NGAYTAO,C.NGUOITAO_ID
      FROM TT_INV_CHUNGTUXUAT A INNER JOIN TT_INV_CHUNGTUXUATCHITIET B ON A.CHUNGTUXUAT_ID=B.CHUNGTUXUAT_ID AND A.MMYY='$MMYYTRUOC$'
      INNER JOIN TT_INV_THEODOI C ON B.THEODOI_ID=C.THEODOI_ID
      WHERE A.MMYY='$MMYYTRUOC$' AND A.BENHVIEN_ID='$BENHVIEN_ID$' AND A.MAKHOXUAT IN($LISTMAKHO$)
      UNION ALL
      SELECT '$MMYY$' AS MMYY, A.MAKHO,A.TENKHO,B.THEODOI_ID,0 AS SOLUONGTONDAU,0 AS SOLUONGNHAP,B.SOLUONG AS SOLUONGXUAT,C.NGAYTAO,C.NGUOITAO_ID
      FROM TT_INV_CHUNGTUTANGGIAM A INNER JOIN TT_INV_CHUNGTUTANGGIAMCHITIET B ON A.CHUNGTUTANGGIAM_ID=B.CHUNGTUTANGGIAM_ID AND A.MMYY='$MMYYTRUOC$' AND A.LOAI='giam'
      INNER JOIN TT_INV_THEODOI C ON B.THEODOI_ID=C.THEODOI_ID
      WHERE A.MMYY='$MMYYTRUOC$' AND A.LOAI='giam' AND A.BENHVIEN_ID='$BENHVIEN_ID$' AND A.MAKHO IN($LISTMAKHO$)
      UNION ALL
      <!--So luong nhap-->
      SELECT '$MMYY$' AS MMYY, A.MAKHO,A.TENKHO,B.THEODOI_ID,0 AS SOLUONGTONDAU,B.SOLUONGNHAP,0 AS SOLUONGXUAT,C.NGAYTAO,C.NGUOITAO_ID
      FROM TT_INV_CHUNGTUNHAP A INNER JOIN TT_INV_CHUNGTUNHAPCHITIET B ON A.CHUNGTUNHAP_ID=B.CHUNGTUNHAP_ID AND A.MMYY='$MMYYTRUOC$'
      INNER JOIN TT_INV_THEODOI C ON B.THEODOI_ID=C.THEODOI_ID
      WHERE A.MMYY='$MMYYTRUOC$' AND A.MATRANGTHAI='DaNhapKho' AND A.BENHVIEN_ID='$BENHVIEN_ID$' AND A.MAKHO IN($LISTMAKHO$)
      UNION ALL
      SELECT '$MMYY$' AS MMYY, A.MAKHO,A.TENKHO,B.THEODOI_ID,0 AS SOLUONGTONDAU,B.SOLUONG AS SOLUONGNHAP,0 AS SOLUONGXUAT,C.NGAYTAO,C.NGUOITAO_ID
      FROM TT_INV_CHUNGTUTANGGIAM A INNER JOIN TT_INV_CHUNGTUTANGGIAMCHITIET B ON A.CHUNGTUTANGGIAM_ID=B.CHUNGTUTANGGIAM_ID AND A.MMYY='$MMYYTRUOC$' AND A.LOAI='tang'
      INNER JOIN TT_INV_THEODOI C ON B.THEODOI_ID=C.THEODOI_ID
      WHERE A.MMYY='$MMYYTRUOC$' AND A.LOAI='tang' AND A.BENHVIEN_ID='$BENHVIEN_ID$' AND A.MAKHO IN($LISTMAKHO$)
      ) TK GROUP BY TK.MMYY, TK.MAKHO,TK.TENKHO,TK.THEODOI_ID) AS Y
	  ON (X.MMYY=Y.MMYY AND X.MAKHO=Y.MAKHO AND X.THEODOI_ID=Y.THEODOI_ID)
      
	  WHEN MATCHED THEN UPDATE SET X.SOLUONGTONDAU=Y.SOLUONGTONDAU
      WHEN NOT MATCHED THEN
      
	  INSERT (MMYY,MAKHO,TENKHO,THEODOI_ID,SOLUONGTONDAU,BENHVIEN_ID,NGAYTAO,NGUOITAO_ID) VALUES
      ('$MMYY$',Y.MAKHO,Y.TENKHO,Y.THEODOI_ID,Y.SOLUONGTONDAU,#BENHVIEN_ID#,GETDATE(),'');

      UPDATE TT_INV_TONKHOTONGHOP SET SOLUONGTONDAU=0,SOLUONGNHAP=0,SOLUONGXUAT=0 WHERE MMYY='$MMYY$' AND MAKHO IN($LISTMAKHO$);
      MERGE TT_INV_TONKHOTONGHOP AS X USING
      (SELECT '$MMYY$' AS MMYY,A.MAKHO,A.TENKHO,B.HANGHOA_ID,B.MAHANGHOA,HH.TEN,SUM(A.SOLUONGTONDAU) AS SOLUONGTONDAU,SUM(A.SOLUONGNHAP) AS SOLUONGNHAP,SUM(A.SOLUONGXUAT) AS SOLUONGXUAT
      FROM TT_INV_TONKHOCHITIET A INNER JOIN TT_INV_THEODOI B ON A.THEODOI_ID=B.THEODOI_ID AND A.MMYY='$MMYY$'
	  JOIN TM_PUR_HANGHOA HH on HH.ID = B.HANGHOA_ID

      WHERE A.MMYY='$MMYY$' AND A.BENHVIEN_ID='$BENHVIEN_ID$' AND A.MAKHO IN($LISTMAKHO$)
      GROUP BY A.MAKHO,A.TENKHO,B.HANGHOA_ID,B.MAHANGHOA,HH.TEN) AS Y
      ON (X.MMYY=Y.MMYY AND X.MAKHO=Y.MAKHO AND X.HANGHOA_ID=Y.HANGHOA_ID)
      WHEN MATCHED THEN UPDATE SET X.SOLUONGTONDAU=Y.SOLUONGTONDAU, X.SOLUONGNHAP=Y.SOLUONGNHAP,X.SOLUONGXUAT=Y.SOLUONGXUAT
      WHEN NOT MATCHED THEN
      INSERT (MMYY,MAKHO,TENKHO,HANGHOA_ID,MAHANGHOA,TENHANGHOA,SOLUONGTONDAU,SOLUONGNHAP,SOLUONGXUAT,BENHVIEN_ID,NGAYTAO)
      VALUES ('$MMYY$',Y.MAKHO,Y.TENKHO,Y.HANGHOA_ID,Y.MAHANGHOA,Y.TEN,Y.SOLUONGTONDAU,Y.SOLUONGNHAP,Y.SOLUONGXUAT,#BENHVIEN_ID#,GETDATE());

      DELETE FROM TT_INV_TONKHOCHITIET WHERE SOLUONGTONDAU=0 AND SOLUONGNHAP=0 AND SOLUONGXUAT=0;
      DELETE FROM TT_INV_TONKHOTONGHOP WHERE SOLUONGTONDAU=0 AND SOLUONGNHAP=0 AND SOLUONGXUAT=0;
    </statement>
    <!--<statement id="DAO00401_INV001_SoDuDMKho" parameterClass="DataObject">
      MERGE TM_INV_KHO AS X USING (
      SELECT AA.DICTIONARY_CODE AS MAKHO,AA.DICTIONARY_NAME AS TENKHO,#SODU# AS SODU,#SODUDENNGAY# AS SODUDENNGAY
      FROM LST_DICTIONARY AA LEFT JOIN TM_INV_KHO BB ON AA.DICTIONARY_CODE = BB.MAKHO
      WHERE AA.DICTIONARY_TYPE_CODE = 'KhoVPP' AND AA.DICTIONARY_CODE IN($LISTMAKHO$)) AS Y
      ON (X.MAKHO=Y.MAKHO)
      WHEN MATCHED THEN UPDATE SET X.SODU=#SODU#,X.SODUDENNGAY=#SODUDENNGAY#,X.NGUOICAPNHAT_ID=#NGUOITAO_ID#
      WHEN NOT MATCHED THEN
      INSERT (MAKHO,TENKHO,SODU,SODUDENNGAY,BENHVIEN_ID,NGAYTAO,NGUOITAO_ID) VALUES
      (Y.MAKHO,Y.TENKHO,Y.SODU,Y.SODUDENNGAY,#BENHVIEN_ID#,GETDATE(),#NGUOITAO_ID#);
    </statement>-->
    <statement id="DAO00401_INV001_SoDuDMKho" parameterClass="DataObject">
      MERGE TM_INV_KHO AS X USING (
      SELECT AA.MAKHO,AA.TENKHO,#SODU# AS SODU,#SODUDENNGAY# AS SODUDENNGAY
      FROM TM_KHO AA LEFT JOIN TM_INV_KHO BB ON AA.MAKHO = BB.MAKHO
      WHERE AA.MAKHO IN($LISTMAKHO$)) AS Y
      ON (X.MAKHO=Y.MAKHO)
      WHEN MATCHED THEN UPDATE SET X.SODU=#SODU#,X.SODUDENNGAY=#SODUDENNGAY#,X.NGUOICAPNHAT_ID=#NGUOITAO_ID#
      WHEN NOT MATCHED THEN
      INSERT (MAKHO,TENKHO,SODU,SODUDENNGAY,BENHVIEN_ID,NGAYTAO,NGUOITAO_ID) VALUES
      (Y.MAKHO,Y.TENKHO,Y.SODU,Y.SODUDENNGAY,#BENHVIEN_ID#,GETDATE(),#NGUOITAO_ID#);
    </statement>
    <statement id="DAO00401_INV001_KiemTraMaChungTuTangGiamTonTai" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select CT.CHUNGTUTANGGIAM_ID
      FROM TT_INV_CHUNGTUTANGGIAM CT
      where CT.MACHUNGTU = '$MACHUNGTU$' AND CT.BENHVIEN_ID = '$BENHVIEN_ID$'
    </statement>
    <statement id="DAO00401_INV001_AddChungTuTangGiam" parameterClass="System.Collections.IDictionary" resultClass="System.Int64">
      INSERT INTO TT_INV_CHUNGTUTANGGIAM (MACHUNGTU,MMYY,NGAYCHUNGTU,MAKHO,TENKHO,NGUOIDUYET_ID,TENNGUOIDUYET,GHICHU,LOAI,TENNGUOITAO,BENHVIEN_ID,NGAYTAO,NGUOITAO_ID)
      VALUES(#MACHUNGTU#,#MMYY#,#NGAYCHUNGTU#,#MAKHO#,#TENKHO#,#NGUOIDUYET_ID#,#TENNGUOIDUYET#,#GHICHU#,#LOAI#,#TENNGUOITAO#,#BENHVIEN_ID#,GETDATE(),#NGUOITAO_ID#)
      SELECT SCOPE_IDENTITY()
    </statement>
    <statement id="DAO00401_INV001_AddChungTuTangGiamChiTiet" parameterClass="System.Collections.IDictionary" resultClass="System.Int64">
      INSERT INTO TT_INV_CHUNGTUTANGGIAMCHITIET (CHUNGTUTANGGIAM_ID,MMYY,THEODOI_ID,SOLUONG,THANHTIEN,LYDO,TENNGUOITAO,BENHVIEN_ID,NGAYTAO,NGUOITAO_ID)
      VALUES(#CHUNGTUTANGGIAM_ID#,#MMYY#,#THEODOI_ID#,#SOLUONG#,#THANHTIEN#,#LYDO#,#TENNGUOITAO#,#BENHVIEN_ID#,GETDATE(),#NGUOITAO_ID#)
      SELECT SCOPE_IDENTITY()
    </statement>
    <statement id="DAO00401_INV001_GetChungTuTangGiam" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      SELECT CT.CHUNGTUTANGGIAM_ID,CT.MACHUNGTU,CT.MMYY,CT.NGAYCHUNGTU,CT.MAKHO,CT.TENKHO,CT.NGUOIDUYET_ID,CT.TENNGUOIDUYET,CT.GHICHU,CT.LOAI,CT.TENNGUOITAO,CT.TENNGUOICAPNHAT,CT.BENHVIEN_ID,CT.NGAYTAO,CT.NGUOITAO_ID,CT.NGAYCAPNHAT,CT.NGUOICAPNHAT_ID,
      CTCT.CHUNGTUTANGGIAMCHITIET_ID,CTCT.SOLUONG,CTCT.THANHTIEN,CTCT.LYDO,
      TD.THEODOI_ID,TD.HANGHOA_ID,TD.MAHANGHOA,TD.TENHANGHOA,TD.DONVITINH_ID,TD.TENDONVITINH,TD.HANDUNG,TD.LOSX,TD.DONGIASAUVAT AS DONGIA, A.SOLUONGTONCUOI
      FROM TT_INV_CHUNGTUTANGGIAM CT INNER JOIN TT_INV_CHUNGTUTANGGIAMCHITIET CTCT ON CT.CHUNGTUTANGGIAM_ID=CTCT.CHUNGTUTANGGIAM_ID
      <isNotEmpty prepend="AND" property="MMYY">
        CT.MMYY IN($MMYY$)
      </isNotEmpty>
      INNER JOIN TT_INV_THEODOI TD ON CTCT.THEODOI_ID=TD.THEODOI_ID
      INNER JOIN
      (
      SELECT DISTINCT TD.THEODOI_ID,TD.HANGHOA_ID,TD.MAHANGHOA,TD.TENHANGHOA,TD.DONVITINH_ID,TD.TENDONVITINH,TD.DONGIA AS DONGIATRUOCVAT,TD.DONGIASAUVAT AS DONGIA,CONVERT(VARCHAR(20),TD.HANDUNG, 103) HANDUNG,TD.LOSX, CONVERT(VARCHAR(20),TD.NGAYTAO, 103) + ' ' + CONVERT(VARCHAR(20),TD.NGAYTAO, 108) NGAYTAO,
      SUM(TKCT.SOLUONGTONDAU+TKCT.SOLUONGNHAP-TKCT.SOLUONGXUAT) AS SOLUONGTONCHITIET,SUM(TKTH.SOLUONGTONDAU+TKTH.SOLUONGNHAP-TKTH.SOLUONGXUAT) AS SOLUONGTONCUOI
      FROM TM_PUR_HANGHOA HH INNER JOIN TT_INV_THEODOI TD ON HH.ID = TD.HANGHOA_ID
      INNER JOIN TT_INV_TONKHOTONGHOP TKTH ON HH.ID = TKTH.HANGHOA_ID
      <isNotEmpty prepend="AND" property="MMYY">
        TKTH.MMYY IN($MMYY$)
      </isNotEmpty>
      INNER JOIN TT_INV_TONKHOCHITIET TKCT ON TD.THEODOI_ID = TKCT.THEODOI_ID
      <isNotEmpty prepend="AND" property="MMYY">
        TKCT.MMYY IN($MMYY$)
      </isNotEmpty>
      where TKCT.BENHVIEN_ID = '$BENHVIEN_ID$'
      <isNotEmpty prepend="AND" property="MAKHO">
        TKCT.MAKHO = '$MAKHO$'
      </isNotEmpty>
      <isNotEmpty prepend="AND" property="MMYY">
        TKCT.MMYY IN($MMYY$)
      </isNotEmpty>
      GROUP BY TD.THEODOI_ID,TD.HANGHOA_ID,TD.MAHANGHOA,TD.TENHANGHOA,TD.DONVITINH_ID,TD.TENDONVITINH,TD.DONGIA,TD.DONGIASAUVAT,TD.HANDUNG,TD.NGAYTAO,TD.LOSX
      ) A ON A.THEODOI_ID = TD.THEODOI_ID
      where CT.BENHVIEN_ID = '$BENHVIEN_ID$' AND CT.MACHUNGTU = '$MACHUNGTU$'
      <isNotEmpty prepend="AND" property="MMYY">
        CT.MMYY IN($MMYY$)
      </isNotEmpty>
      ORDER BY TD.TENHANGHOA
    </statement>
    <statement id="DAO00401_INV001_ChungTuTangGiamSearch" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select CT.CHUNGTUTANGGIAM_ID,CT.MACHUNGTU,CT.MMYY,CT.NGAYCHUNGTU,CT.MAKHO,CT.TENKHO,CT.NGUOIDUYET_ID,CT.TENNGUOIDUYET,CT.GHICHU,CT.LOAI,
      CT.TENNGUOITAO,CT.TENNGUOICAPNHAT,CT.BENHVIEN_ID,CT.NGAYTAO,CT.NGUOITAO_ID,CT.NGAYCAPNHAT,CT.NGUOICAPNHAT_ID
      FROM TT_INV_CHUNGTUTANGGIAM CT
      WHERE CT.BENHVIEN_ID = '$BENHVIEN_ID$' AND CT.LOAI = '$LOAI$' AND CT.NGAYCHUNGTU BETWEEN '$TUNGAY$' AND '$DENNGAY$'
      AND CT.MAKHO = '$MAKHO$'
      <isNotEmpty prepend="AND" property="MACHUNGTU">
        CT.MACHUNGTU LIKE '%$MACHUNGTU$%'
      </isNotEmpty>
    </statement>
    <statement id="DAO00401_INV001_GetChungTuTangGiamChiTiet_ChungTuID" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select CTCT.CHUNGTUTANGGIAMCHITIET_ID,CTCT.SOLUONG,CTCT.THANHTIEN,CTCT.LYDO,CTCT.CHUNGTUTANGGIAM_ID,
      TD.THEODOI_ID,TD.HANGHOA_ID,TD.MAHANGHOA,TD.TENHANGHOA,TD.DONVITINH_ID,TD.TENDONVITINH,TD.HANDUNG,TD.LOSX,TD.DONGIASAUVAT AS DONGIA
      FROM TT_INV_CHUNGTUTANGGIAMCHITIET CTCT INNER JOIN TT_INV_THEODOI TD ON CTCT.THEODOI_ID=TD.THEODOI_ID
      WHERE CTCT.BENHVIEN_ID = '$BENHVIEN_ID$' AND CTCT.CHUNGTUTANGGIAM_ID='$CHUNGTUTANGGIAM_ID$'
    </statement>
    <statement id="DAO00401_INV001_GetKhoaSoChungTu" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select DISTINCT LEFT(TKTH.MMYY,2) +'/' + RIGHT(TKTH.MMYY,2) AS MMYY,KS.KHOASO_ID,ISNULL(KS.KHOASO,0) AS KHOASO,TKTH.MAKHO,TKTH.TENKHO,KS.NGUOIKHOA_ID,KS.TENNGUOIKHOA,KS.NGAYKHOA,KS.NGUOIMOKHOA_ID,KS.TENNGUOIMOKHOA,
      KS.NGAYMOKHOA,KS.NGAYTAO,KS.NGUOITAO_ID,K.NGAYKHOA AS SODU_NGAYKHOA
      FROM TT_INV_TONKHOTONGHOP TKTH LEFT JOIN TT_INV_KHOASO KS ON TKTH.MMYY = KS.MMYY
      LEFT JOIN TM_INV_KHO K ON TKTH.MAKHO = K.MAKHO
      WHERE TKTH.BENHVIEN_ID = '$BENHVIEN_ID$'
    </statement>
    <statement id="DAO00401_INV001_AddKhoaSo" parameterClass="System.Collections.IDictionary" resultClass="System.Int64">
      INSERT INTO TT_INV_KHOASO(KHOASO,MMYY,MAKHO,TENKHO,NGUOIKHOA_ID,TENNGUOIKHOA,NGAYKHOA,NGAYTAO,NGUOITAO_ID,BENHVIEN_ID)
      VALUES(#KHOASO#,#MMYY#,#MAKHO#,#TENKHO#,#NGUOIKHOA_ID#,#TENNGUOIKHOA#,#NGAYKHOA#,GETDATE(),#NGUOITAO_ID#,#BENHVIEN_ID#)
      SELECT SCOPE_IDENTITY()
    </statement>
  <update id="DAO00401_INV001_UpdKhoaSo" parameterClass="DataObject">
      UPDATE TT_INV_KHOASO
       SET KHOASO = #KHOASO#,NGUOIKHOA_ID = #NGUOIKHOA_ID#,TENNGUOIKHOA = #TENNGUOIKHOA#,NGAYKHOA = #NGAYKHOA#,NGUOIMOKHOA_ID = #NGUOIMOKHOA_ID#,TENNGUOIMOKHOA = #TENNGUOIMOKHOA#,NGAYMOKHOA = #NGAYMOKHOA#,NGAYCAPNHAT = GETDATE(),NGUOICAPNHAT_ID = #NGUOICAPNHAT_ID#
       WHERE KHOASO_ID = '$KHOASO_ID$' AND MMYY = '$MMYY$' AND MAKHO = '$MAKHO$' AND BENHVIEN_ID = '$BENHVIEN_ID$'
    </update>
    <statement id="DAO00401_INV001_AddKhoaSoHistory" parameterClass="System.String" resultClass="System.Int32">
      INSERT INTO TT_INV_KHOASOHISTORY(TENNGUOITAO,TRANGTHAIHANHDONG,KS_KHOASO_ID,KS_KHOASO,KS_MMYY,KS_MAKHO,KS_TENKHO,KS_NGUOIKHOA_ID,KS_TENNGUOIKHOA,KS_NGAYKHOA,KS_NGUOIMOKHOA_ID,
      KS_TENNGUOIMOKHOA,KS_NGAYMOKHOA,KS_NGAYTAO,KS_NGUOITAO_ID,KS_NGAYCAPNHAT,KS_NGUOICAPNHAT_ID,NGAYTAO,NGUOITAO_ID,BENHVIEN_ID)
      SELECT
      #TENNGUOITAO#,#TRANGTHAIHANHDONG#,KHOASO_ID,KHOASO,MMYY,MAKHO,TENKHO,NGUOIKHOA_ID,TENNGUOIKHOA,NGAYKHOA,NGUOIMOKHOA_ID,TENNGUOIMOKHOA,NGAYMOKHOA,NGAYTAO,NGUOITAO_ID,
      NGAYCAPNHAT,NGUOICAPNHAT_ID,GETDATE(),#NGUOITAO_ID#,#BENHVIEN_ID#
      FROM TT_INV_KHOASO
      WHERE KHOASO_ID='$KHOASO_ID$' AND BENHVIEN_ID = '$BENHVIEN_ID$'
    </statement>
  <update id="DAO00401_INV001_UpdSoDuDMKho_KhoaSo" parameterClass="DataObject">
      UPDATE TM_INV_KHO
       SET KHOASO = #KHOASO#,NGAYKHOA = #NGAYKHOA#
       WHERE MAKHO = '$MAKHO$' AND  BENHVIEN_ID = '$BENHVIEN_ID$'
    </update>
  <statement id="DAO00401_INV001_KiemTraKhoaSoMMYY" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select KHOASO FROM TT_INV_KHOASO WHERE MMYY = '$MMYY$' AND MAKHO = '$MAKHO$' AND BENHVIEN_ID = '$BENHVIEN_ID$'
    </statement>
    <statement id="DAO00401_INV001_GetDMNhanVen" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      SELECT AA.NHANVIEN_ID,AA.TENNHANVIEN,AA.CHUCVU_ID,BB.DICTIONARY_NAME AS TENCHUCVU
      FROM TM_NHANVIEN AA LEFT JOIN LST_DICTIONARY BB ON AA.CHUCVU_ID=BB.DICTIONARY_ID AND BB.DICTIONARY_TYPE_CODE='ChucVu';
    </statement>
    <statement id="DAO00401_INV001_GetHangHoaPO" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      SELECT A.HANGHOA_ID, B.MACHUNGTU,  A.SOLUONGYEUCAU FROM TT_PUR_CHUNGTUCHITIET A LEFT JOIN TT_PUR_CHUNGTU B on A.CHUNGTU_ID = B.CHUNGTU_ID
      WHERE B.PROCESS_CODE = 'PO' AND B.MACHUNGTU = '$MACHUNGTULIENQUAN$'
    </statement>
    <statement id="DAO00401_INV001_UpdateTrangThaiPO_NhapKho" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      UPDATE TT_PUR_CHUNGTU SET STATE_CODE = #STATE_CODE#, STATE_NAME = #STATE_NAME# WHERE MACHUNGTU = '$MACHUNGTULIENQUAN$' AND PROCESS_CODE = 'PO'
    </statement>
    <statement id="DAO00401_INV001_GetChungTuNhapKho" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      SELECT MACHUNGTU, MACHUNGTULIENQUAN FROM TT_INV_CHUNGTUNHAP WHERE MACHUNGTULIENQUAN = '$MACHUNGTULIENQUAN$'
    </statement>
    <statement id="DAO00401_INV001_UpdateDonGia_HangHoa" parameterClass="DataObject">
      UPDATE TM_PUR_HANGHOA SET DONGIA = #DONGIA# WHERE ID = '$HANGHOA_ID$' AND  BENHVIEN_ID = '$BENHVIEN_ID$'
    </statement>
    <statement id="DAO00401_INV001_GetHangHoaNhapKho_PhieuPO" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      SELECT MACHUNGTULIENQUAN, SOLUONGNHAP, KHUYENMAI FROM TT_INV_CHUNGTUNHAPCHITIET A LEFT JOIN TT_INV_CHUNGTUNHAP B ON B.CHUNGTUNHAP_ID = A.CHUNGTUNHAP_ID WHERE B.MACHUNGTULIENQUAN = '$MACHUNGTULIENQUAN$'
    </statement>
    <!--Nhatt25 Add STT For STA14-->
    <statement id="DAO00401_STA001_GetGiaVPPHopDong" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      SELECT TOP 1 HH.ID AS HANGHOA_ID, HH.MA AS MAHANGHOA, HH.TEN AS TENHANGHOA,
      HH.DONVITINH_ID, HH.TENDONVITINH, G.NHACUNGCAP_ID, NCC.TENNHACUNGCAP,
      GC.DONGIA, GC.VAT, HH.LOAI_ID
      FROM TM_PUR_GIAHOPDONGCHITIET AS GC
      INNER JOIN TM_PUR_GIAHOPDONG AS G ON G.GIAHOPDONG_ID = GC.GIAHOPDONG_ID
      INNER JOIN TM_NHACUNGCAP AS NCC ON NCC.NHACUNGCAP_ID = G.NHACUNGCAP_ID
      INNER JOIN TM_PUR_HANGHOA AS HH ON HH.ID = GC.HANGHOA_ID
      INNER JOIN TM_DONVITINH AS DVT ON DVT.DONVITINH_ID = GC.DONVITINH_ID
      WHERE GC.BENHVIEN_ID = '$BENHVIEN_ID$'
      AND GC.HANGHOA_ID = '$HANGHOA_ID$'
      AND (CONVERT(DATE,GETDATE()) BETWEEN G.TUNGAY AND G.DENNGAY)
      ORDER BY GC.DONGIA
    </statement>
    
    <statement id="DAO00401_STA001_GetVPPGanNhat" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      SELECT TOP 1 HH.ID AS HANGHOA_ID, HH.MA AS MAHANGHOA, HH.TEN AS TENHANGHOA,
      HH.DONVITINH_ID, HH.TENDONVITINH, NCC.NHACUNGCAP_ID, NCC.TENNHACUNGCAP,
      TD.DONGIA, TD.TYLEVAT as VAT
      FROM TT_INV_THEODOI TD
      INNER JOIN TT_INV_CHUNGTUNHAPCHITIET AS CT ON CT.THEODOI_ID = TD.THEODOI_ID And CT.BENHVIEN_ID = TD.BENHVIEN_ID
      INNER JOIN TT_INV_CHUNGTUNHAP AS C ON C.CHUNGTUNHAP_ID = CT.CHUNGTUNHAP_ID And C.BENHVIEN_ID = TD.BENHVIEN_ID
      INNER JOIN TM_NHACUNGCAP AS NCC ON NCC.NHACUNGCAP_ID = C.NHACUNGCAP_ID And NCC.BENHVIEN_ID = C.BENHVIEN_ID
      INNER JOIN TM_PUR_HANGHOA AS HH ON HH.ID = TD.HANGHOA_ID And HH.BENHVIEN_ID = C.BENHVIEN_ID
      INNER JOIN TM_DONVITINH AS DVT ON DVT.DONVITINH_ID = TD.DONVITINH_ID And DVT.BENHVIEN_ID = C.BENHVIEN_ID
      WHERE C.BENHVIEN_ID = '$BENHVIEN_ID$'
      AND TD.HANGHOA_ID = '$HANGHOA_ID$'
      ORDER BY TD.NGAYTAO DESC, TD.MMYY DESC
    </statement>

    <statement id="DAO00401_STA001_InsVPPDutru" parameterClass="System.String" resultClass="System.Int32">
      INSERT INTO [dbo].[TT_VPP_DUTRU]
      ([MACHUNGTU],[TONGHOP_TUNGAY],[TONGHOP_DENNGAY],[NGAYCHUNGTU],[NGAYBAOCAO],[NGUOINHAP_ID]
      ,[NGUOINHAN_ID],[NGUOINHAN],[GIATRITHANHTOAN],[CHUNGTULIENQUAN_ID],[TRANGTHAI]
      ,[NGAYDUYET],[NGUOIDUYET_ID],[PHONGBAN_ID],[BENHVIEN_ID],[NGAYTAO],[NGUOITAO_ID],[NGAYCAPNHAT],[NGUOICAPNHAT_ID]
      ,[MAKHO],[TENKHO])
      VALUES
      (#MACHUNGTU#,#TONGHOP_TUNGAY#,#TONGHOP_DENNGAY#,#NGAYCHUNGTU#,#NGAYBAOCAO#,#NGUOINHAP_ID#
      ,#NGUOINHAN_ID#,#NGUOINHAN#,#GIATRITHANHTOAN#,#CHUNGTULIENQUAN_ID#,#TRANGTHAI#
      ,#NGAYDUYET#,#NGUOIDUYET_ID#,#PHONGBAN_ID#,#BENHVIEN_ID#,#NGAYTAO#,#NGUOITAO_ID#,#NGAYCAPNHAT#,#NGUOICAPNHAT_ID#
      ,#MAKHO#,#TENKHO#)
      SELECT SCOPE_IDENTITY()
    </statement>

    <statement id="DAO00401_STA001_InsVPPDutruChitiet" parameterClass="System.String" resultClass="System.Int32">
      INSERT INTO [dbo].[TT_VPP_DUTRU_CHITIET]
      ([DUTRU_ID],[HANGHOA_ID],[MAHANGHOA],[TENHANGHOA],[DONVITINH_ID],[NHACUNGCAP_ID]
      ,[SOLUONG],[LUACHONGIA_ID],[DONGIA],[VAT],[DONGIAVAT],[THANHTIEN]
      ,[GHICHUCHITIET],[BENHVIEN_ID],[NGAYTAO],[NGUOITAO_ID],[NGAYCAPNHAT],[NGUOICAPNHAT_ID])
      VALUES
      (#DUTRU_ID#,#HANGHOA_ID#,#MAHANGHOA#,#TENHANGHOA#,#DONVITINH_ID#,#NHACUNGCAP_ID#
      ,#SOLUONG#,#LUACHONGIA_ID#,#DONGIA#,#VAT#,#DONGIAVAT#,#THANHTIEN#
      ,#GHICHUCHITIET#,#BENHVIEN_ID#,#NGAYTAO#,#NGUOITAO_ID#,#NGAYCAPNHAT#,#NGUOICAPNHAT_ID#)
      SELECT SCOPE_IDENTITY()
    </statement>

    <statement id="DAO00401_STA001_GetDuTruVPP" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      SELECT DT.*, ISNULL(PC.TRANGTHAI_DUYET, '0') AS TRANGTHAI_DUYET,
      ISNULL(PC.NGAYGIODUYETCAP3,ISNULL(PC.NGAYGIODUYETCAP2, PC.NGAYGIODUYETCAP1)) AS NGAYDUYETMUAHANG
      , ISNULL(PC.NGUOIDUYETCAP3_ID, ISNULL(PC.NGUOIDUYETCAP2_ID, PC.NGUOIDUYETCAP1_ID)) AS NGUOIDUYETMUAHANG
      from TT_VPP_DUTRU AS DT
      LEFT JOIN TT_PUR_CHUNGTU AS PC ON PC.MACHUNGTU = DT.CHUNGTULIENQUAN_ID
      where DT.MACHUNGTU = '$MACHUNGTU$' AND DT.BENHVIEN_ID = '$BENHVIEN_ID$'
    </statement>

    <statement id="DAO00401_STA001_GetDuTruDetailByDuTruID" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      SELECT VC.*, DVT.TENDONVITINH, NCC.TENNHACUNGCAP, HH.LOAI_ID
      FROM TT_VPP_DUTRU_CHITIET AS VC
      inner join TM_PUR_HANGHOA AS HH ON HH.ID = VC.HANGHOA_ID
      inner join TM_DONVITINH AS DVT ON DVT.DONVITINH_ID = HH.DONVITINH_ID
      inner join TM_NHACUNGCAP AS NCC ON NCC.NHACUNGCAP_ID = VC.NHACUNGCAP_ID
      WHERE VC.DUTRU_ID = '$DUTRU_ID$' AND VC.BENHVIEN_ID = '$BENHVIEN_ID$'
    </statement>
    
    <statement id="DAO00401_STA001_DELDuTruVPP" parameterClass="System.Collections.IDictionary" resultClass="System.Int32">
      DELETE from TT_VPP_DUTRU
      where
      DUTRU_ID = '$DUTRU_ID$' AND BENHVIEN_ID = '$BENHVIEN_ID$'
    </statement>
    <statement id="DAO00401_STA001_DELDuTruVPPChiTiet" parameterClass="System.Collections.IDictionary" resultClass="System.Int32">
      DELETE from TT_VPP_DUTRU_CHITIET
      where
      DUTRU_ID = '$DUTRU_ID$' AND BENHVIEN_ID = '$BENHVIEN_ID$'
    </statement>

    <statement id="DAO00401_STA001_DelDuTruVPP_ByDetailID" parameterClass="System.Collections.IDictionary" resultClass="System.Int32">
      delete from TT_VPP_DUTRU_CHITIET
      where
      DUTRUCHITIET_ID = '$DUTRUCHITIET_ID$' AND BENHVIEN_ID = '$BENHVIEN_ID$'
    </statement>
    
    <update id="DAO00401_STA001_UpdDuTruVPP_ChiTiet" parameterClass="System.Collections.IDictionary">
      UPDATE TT_VPP_DUTRU_CHITIET
      SET HANGHOA_ID = #HANGHOA_ID#
      ,MAHANGHOA = #MAHANGHOA#
      ,TENHANGHOA = #TENHANGHOA#
      ,DONVITINH_ID = #DONVITINH_ID#
      ,NHACUNGCAP_ID = #NHACUNGCAP_ID#
      ,SOLUONG = #SOLUONG#
      ,LUACHONGIA_ID = #LUACHONGIA_ID#
      ,DONGIA = #DONGIA#
      ,VAT = #VAT#
      ,DONGIAVAT = #DONGIAVAT#
      ,THANHTIEN = #THANHTIEN#
      ,GHICHUCHITIET = #GHICHUCHITIET#
      ,NGAYCAPNHAT = #NGAYCAPNHAT#
      ,NGUOICAPNHAT_ID = #NGUOICAPNHAT_ID#
      WHERE DUTRUCHITIET_ID = '$DUTRUCHITIET_ID$' And DUTRU_ID = '$DUTRU_ID$' And BENHVIEN_ID = '$BENHVIEN_ID$'
    </update>
    
    <update id="DAO00401_STA001_UpdDuTruVPP" parameterClass="System.Collections.IDictionary">
      UPDATE TT_VPP_DUTRU
      SET TONGHOP_TUNGAY = #TONGHOP_TUNGAY#
      ,TONGHOP_DENNGAY = #TONGHOP_DENNGAY#
      ,NGAYCHUNGTU = #NGAYCHUNGTU#
      ,NGAYBAOCAO = #NGAYBAOCAO#
      ,NGUOINHAP_ID = #NGUOINHAP_ID#
      ,NGUOINHAN_ID = #NGUOINHAN_ID#
      ,NGUOINHAN = #NGUOINHAN#
      ,GIATRITHANHTOAN = #GIATRITHANHTOAN#
      ,CHUNGTULIENQUAN_ID = #CHUNGTULIENQUAN_ID#
      ,TRANGTHAI = #TRANGTHAI#
      ,NGAYDUYET = #NGAYDUYET#
      ,NGUOIDUYET_ID = #NGUOIDUYET_ID#
      ,PHONGBAN_ID = #PHONGBAN_ID#
      ,NGAYCAPNHAT = #NGAYCAPNHAT#
      ,NGUOICAPNHAT_ID = #NGUOICAPNHAT_ID#
      ,MAKHO = #MAKHO#
      ,TENKHO = #TENKHO#
      WHERE DUTRU_ID = '$DUTRU_ID$' And BENHVIEN_ID = '$BENHVIEN_ID$'
    </update>
  <!--STA15 Search DUTRU-->
    <statement id="DAO00401_STA001_GetTrangThaiDuTru" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      SELECT DICTIONARY_CODE AS MATRANGTHAI, DICTIONARY_NAME AS TENTRANGTHAI FROM LST_DICTIONARY
      WHERE ENABLED = '1'
      AND BENHVIEN_ID = '$BENHVIEN_ID$' AND DICTIONARY_TYPE_CODE = 'TrangThai_DuTru'
      ORDER BY IDX
    </statement>

    <statement id="DAO00401_STA001_GetTotalByCondition" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select COUNT(DT.MACHUNGTU) AS TOTAL
      from TT_VPP_DUTRU AS DT
      LEFT join TM_NHANVIEN AS NV ON DT.NGUOINHAP_ID = NV.NHANVIEN_ID
      left join TT_PUR_CHUNGTU AS PC ON PC.MACHUNGTU = DT.CHUNGTULIENQUAN_ID
      <dynamic prepend="where">
        <isParameterPresent>
          <isNotEmpty prepend="and" property="BENHVIEN_ID">
            DT.BENHVIEN_ID = '$BENHVIEN_ID$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="TUNGAY">
            CONVERT(DATE,DT.NGAYCHUNGTU) &gt;= CONVERT(DATE,'$TUNGAY$')
          </isNotEmpty>
          <isNotEmpty prepend="and" property="DENNGAY">
            CONVERT(DATE,DT.NGAYCHUNGTU) &lt;= CONVERT(DATE,'$DENNGAY$')
          </isNotEmpty>
          <isNotEmpty prepend="and" property="TRANGTHAI">
            ('$TRANGTHAI$' = 'New' AND DT.TRANGTHAI = '$TRANGTHAI$')
            OR ('$TRANGTHAI$' = 'Purchased' AND PC.TRANGTHAI_DUYET != '1')
            OR ('$TRANGTHAI$' = 'Approved' AND PC.TRANGTHAI_DUYET = '1')
          </isNotEmpty>
        </isParameterPresent>
      </dynamic>
    </statement>

    <statement id="DAO00401_STA001_GetListByCondition" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      WITH LIST_CHUNGTU AS
      (
      select ROW_NUMBER() OVER(ORDER BY DT.DUTRU_ID) as ROWNUMBER
      , DT.MACHUNGTU, DT.NGAYCHUNGTU, DT.NGAYBAOCAO, NV.TENNHANVIEN AS NGUOINHAP, DT.GIATRITHANHTOAN
      from TT_VPP_DUTRU AS DT
      Left join TM_NHANVIEN AS NV ON DT.NGUOINHAP_ID = NV.NHANVIEN_ID
      left join TT_PUR_CHUNGTU AS PC ON PC.MACHUNGTU = DT.CHUNGTULIENQUAN_ID
      <dynamic prepend="where">
        <isParameterPresent>
          <isNotEmpty prepend="and" property="BENHVIEN_ID">
            DT.BENHVIEN_ID = '$BENHVIEN_ID$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="TUNGAY">
            CONVERT(DATE,DT.NGAYCHUNGTU) &gt;= CONVERT(DATE,'$TUNGAY$')
          </isNotEmpty>
          <isNotEmpty prepend="and" property="DENNGAY">
            CONVERT(DATE,DT.NGAYCHUNGTU) &lt;= CONVERT(DATE,'$DENNGAY$')
          </isNotEmpty>
          <isNotEmpty prepend="and" property="TRANGTHAI">
            ('$TRANGTHAI$' = 'New' AND DT.TRANGTHAI = '$TRANGTHAI$')
            OR ('$TRANGTHAI$' = 'Purchased' AND PC.TRANGTHAI_DUYET != '1')
            OR ('$TRANGTHAI$' = 'Approved' AND PC.TRANGTHAI_DUYET = '1')
          </isNotEmpty>
        </isParameterPresent>
      </dynamic>
      )
      SELECT *
      FROM LIST_CHUNGTU
      WHERE ROWNUMBER BETWEEN '$FROM_ROW$' AND '$TO_ROW$'
    </statement>
    
    <!--Nhatt25 Add END For STA14-->
    <statement id="DAO00401_STA001_GetDanhMucLoai" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      SELECT A.ID as LOAI_ID,A.MA as MALOAI,A.TEN as TENLOAI ,A.ACTIVE,isnull(B.NHANVIEN_ID,-1) AS NHANVIEN_ID
      ,B.TENNHANVIEN, isnull(C.NHANVIEN_ID,-1) AS NHANVIENPHANCONG_ID,C.TENNHANVIEN AS TENNHANVIEN_PHANCONG
      FROM TM_PUR_LOAI A
      LEFT JOIN TM_NHANVIEN B ON A.NHANVIEN_ID=B.NHANVIEN_ID
      LEFT JOIN TM_NHANVIEN C ON A.NHANVIENPHANCONG_ID = C.NHANVIEN_ID
      where A.BENHVIEN_ID = '$BENHVIEN_ID$' AND A.ACTIVE='1' And A.MA != 'DP'
      order by A.TEN
    </statement>
    <statement id="DAO00401_STA001_GetDanhMucNCC" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      SELECT NHACUNGCAP_ID, TENNHACUNGCAP from TM_NHACUNGCAP
      WHERE BENHVIEN_ID = '$BENHVIEN_ID$'
      ORDER BY TENNHACUNGCAP
    </statement>
    
    <!--STA16-->
    <!--Tong Hop SL xuat de DuTru-->
    <statement id="DAO00401_STA001_SoLuongXuatTrongKy" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      SELECT TD.HANGHOA_ID, TD.DONVITINH_ID, SUM(XC.SOLUONGXUAT) as SOLUONG
      FROM TT_INV_CHUNGTUXUAT X
      INNER JOIN TT_INV_CHUNGTUXUATCHITIET AS XC ON XC.CHUNGTUXUAT_ID = X.CHUNGTUXUAT_ID AND XC.BENHVIEN_ID = X.BENHVIEN_ID
      INNER JOIN TT_INV_THEODOI AS TD ON TD.THEODOI_ID = XC.THEODOI_ID AND TD.MMYY = X.MMYY AND TD.BENHVIEN_ID = X.BENHVIEN_ID
      INNER JOIN TM_KHO K ON K.MAKHO = X.MAKHOXUAT
      WHERE X.BENHVIEN_ID = '$BENHVIEN_ID$' AND (CONVERT(DATE,X.NGAYCHUNGTU) BETWEEN CONVERT(DATE,'$TUNGAY$') AND CONVERT(DATE,'$DENNGAY$'))
      AND K.MAKHO = '$MAKHO$'
      GROUP BY TD.HANGHOA_ID, TD.DONVITINH_ID
    </statement>
    <statement id="DAO00401_STA001_SoLuongNhapTrongKy" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      SELECT TD.HANGHOA_ID, TD.DONVITINH_ID, SUM(NC.SOLUONGNHAP) as SOLUONG
      FROM TT_INV_CHUNGTUNHAP N
      INNER JOIN TT_INV_CHUNGTUNHAPCHITIET AS NC ON NC.CHUNGTUNHAP_ID = N.CHUNGTUNHAP_ID AND NC.BENHVIEN_ID = N.BENHVIEN_ID
      INNER JOIN TT_INV_THEODOI AS TD ON TD.THEODOI_ID = NC.THEODOI_ID AND TD.MMYY = N.MMYY AND TD.BENHVIEN_ID = N.BENHVIEN_ID
      INNER JOIN TM_KHO K ON K.MAKHO = N.MAKHO
      WHERE N.BENHVIEN_ID = '$BENHVIEN_ID$' AND (CONVERT(DATE,N.NGAYCHUNGTU) BETWEEN CONVERT(DATE,'$TUNGAY$') AND CONVERT(DATE,'$DENNGAY$'))
      AND K.MAKHO = '$MAKHO$'
      GROUP BY TD.HANGHOA_ID, TD.DONVITINH_ID
    </statement>
    <!--(SUM(ISNULL(TK.SOLUONGNHAP,0)) - SUM(ISNULL(TK.SOLUONGXUAT,0)) + -->
    <statement id="DAO00401_STA001_SoLuongTonKhoDauThang" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      SELECT TK.HANGHOA_ID, SUM(ISNULL(TK.SOLUONGTONDAU,0)) AS SOLUONG
      FROM TT_INV_TONKHOTONGHOP AS TK
      INNER JOIN TM_PUR_HANGHOA AS HH ON HH.ID = TK.HANGHOA_ID AND HH.BENHVIEN_ID = TK.BENHVIEN_ID
      INNER JOIN TM_KHO AS K ON K.MAKHO = TK.MAKHO
      WHERE TK.BENHVIEN_ID = '$BENHVIEN_ID$' AND TK.MMYY = '$THANGNAM$' AND TK.MAKHO = '$MAKHO$'
      GROUP BY TK.HANGHOA_ID
    </statement>
    <statement id="DAO00401_STA001_GetDanhSachNCC" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      SELECT GC.HANGHOA_ID, HH.MA AS MAHANGHOA, GC.TENHANGHOA, GC.DONVITINH_ID, DVT.TENDONVITINH, G.NHACUNGCAP_ID, NCC.TENNHACUNGCAP
      , GC.DONGIA, GC.VAT, HH.LOAI_ID
      FROM TM_PUR_GIAHOPDONGCHITIET AS GC
      INNER JOIN TM_PUR_GIAHOPDONG AS G ON G.GIAHOPDONG_ID = GC.GIAHOPDONG_ID
      INNER JOIN TM_NHACUNGCAP AS NCC ON NCC.NHACUNGCAP_ID = G.NHACUNGCAP_ID
      INNER JOIN TM_PUR_HANGHOA AS HH ON HH.ID = GC.HANGHOA_ID
      INNER JOIN TM_DONVITINH AS DVT ON DVT.DONVITINH_ID = GC.DONVITINH_ID
      WHERE GC.BENHVIEN_ID = '$BENHVIEN_ID$' AND GC.HANGHOA_ID = '$HANGHOA_ID$'
      AND (CONVERT(DATE,GETDATE()) BETWEEN G.TUNGAY AND G.DENNGAY)
      ORDER BY GC.DONGIA
    </statement>
    <statement id="DAO00401_STA001_GetGiaChungTuGanNhat" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      SELECT TOP 1 TD.HANGHOA_ID, HH.MA AS MAHANGHOA, TD.TENHANGHOA, TD.DONVITINH_ID, DVT.TENDONVITINH, N.NHACUNGCAP_ID, NCC.TENNHACUNGCAP,
      TD.TYLEVAT as VAT, NC.SOLUONGNHAP, HH.LOAI_ID, TD.DONGIA
      FROM TT_INV_CHUNGTUNHAP AS N
      INNER JOIN TT_INV_CHUNGTUNHAPCHITIET AS NC ON NC.CHUNGTUNHAP_ID = N.CHUNGTUNHAP_ID
      INNER JOIN TM_NHACUNGCAP AS NCC ON NCC.NHACUNGCAP_ID = N.NHACUNGCAP_ID
      INNER JOIN TT_INV_THEODOI AS TD ON TD.THEODOI_ID = NC.THEODOI_ID
      INNER JOIN TM_PUR_HANGHOA AS HH ON HH.ID = TD.HANGHOA_ID
      INNER JOIN TM_DONVITINH AS DVT ON DVT.DONVITINH_ID = TD.DONVITINH_ID
      WHERE N.BENHVIEN_ID = '$BENHVIEN_ID$' AND TD.HANGHOA_ID = '$HANGHOA_ID$'
      ORDER BY N.NGAYCHUNGTU DESC
    </statement>
    
    <statement id="DAO00401_STA001_GetHangHoaByID" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
    SELECT ID as HANGHOA_ID, MA as MAHANGHOA, TEN as TENHANGHOA, DONVITINH_ID, TENDONVITINH, LOAI_ID, DONGIA
    From TM_PUR_HANGHOA
    WHERE ACTIVE = 1 and BENHVIEN_ID = '$BENHVIEN_ID$'
    AND ID = '$HANGHOA_ID$'
    </statement>
    <!--Gui Duyet_Bo Duyet-->
    <statement id="DAO00401_STA001_GetDetail" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      SELECT DT.*, ISNULL(PC.TRANGTHAI_DUYET, '0') AS TRANGTHAI_DUYET, ISNULL(PC.STATE_CODE, '0') AS STATE_CODE, PC.NGUOIDUYETCAP1_ID
      from TT_VPP_DUTRU AS DT
      LEFT JOIN TT_PUR_CHUNGTU AS PC ON PC.MACHUNGTU = DT.CHUNGTULIENQUAN_ID
      where DT.DUTRU_ID  = '$DUTRU_ID$'
      order by DT.DUTRU_ID
    </statement>
    <statement id="DAO00401_STA001_UpdateTrangThaiPR" parameterClass="System.Collections.IDictionary">
      UPDATE TT_PUR_CHUNGTU set
      STATE_CODE = #STATE_CODE#
      , STATE_NAME = #STATE_NAME#
      , NGAYCAPNHAT = #NGAYCAPNHAT#
      , NGUOICAPNHAT_ID = #NGUOICAPNHAT_ID#
      where MACHUNGTU = '$CHUNGTULIENQUAN_ID$' AND BENHVIEN_ID = '$BENHVIEN_ID$'
    </statement>
    <statement id="DAO00401_STA001_GetLoaiHangHoaByCode" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select PL.*
      from TM_PUR_LOAI AS PL
      WHERE PL.BENHVIEN_ID = '$BENHVIEN_ID$' AND PL.MA = '$MA$'
    </statement>
    <update id="DAO00401_STA001_UpdateTrangThai" parameterClass="System.Collections.IDictionary">
      UPDATE TT_VPP_DUTRU set
      TRANGTHAI = #TRANGTHAI#
      , CHUNGTULIENQUAN_ID = #CHUNGTULIENQUAN_ID#
      where DUTRU_ID = '$DUTRU_ID$' AND BENHVIEN_ID = '$BENHVIEN_ID$'
    </update>
    <!--STA17 Search Phieu Yeu Cau Dat Hang-->
    <!--AND CTCT.STATE_CODE >= 5-->
    <statement id="DAO00401_STA001_ChungTuYeuCauSearch" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      Select CT.CHUNGTU_ID,CT.MACHUNGTU as MAPHIEUYEUCAU,CT.NGAYLAPCHUNGTU,
	           CT.PROCESS_CODE, CT.PROCESS_NAME, CT.STATE_CODE, CT.STATE_NAME,
	           CT.PHONGBAN_ID,CT.TENPHONGBAN,CT.GHICHU,
	           CT.NGAYTAO,CT.NGUOITAO_ID,CT.TENNGUOITAO,
	           CT.NHACUNGCAP_ID, CT.TENNHACUNGCAP, CT.MALOAIPHIEU as MANHOMHANGHOA, CT.TENLOAIPHIEU as TENNHOMHANGHOA
      FROM TT_PUR_CHUNGTU CT
      INNER JOIN TT_PUR_CHUNGTUCHITIET CTCT ON CT.CHUNGTU_ID = CTCT.CHUNGTU_ID
	    WHERE CT.BENHVIEN_ID = '$BENHVIEN_ID$' AND (CONVERT(DATE,CT.NGAYLAPCHUNGTU) BETWEEN '$TUNGAY$' AND '$DENNGAY$')
        AND CT.PROCESS_CODE = 'PO' AND CT.STATE_CODE in ('$STATE_CODE$')
      <isNotEmpty prepend="AND" property="MACHUNGTU">
        CT.MACHUNGTU LIKE '%$MACHUNGTU$%'
      </isNotEmpty>
      Group by CT.CHUNGTU_ID,CT.MACHUNGTU,CT.NGAYLAPCHUNGTU,
	              CT.PROCESS_CODE, CT.PROCESS_NAME, CT.STATE_CODE, CT.STATE_NAME,
	              CT.PHONGBAN_ID,CT.TENPHONGBAN,CT.GHICHU, CT.NGAYTAO,CT.NGUOITAO_ID,CT.TENNGUOITAO,
	              CT.NHACUNGCAP_ID, CT.TENNHACUNGCAP, CT.MALOAIPHIEU,CT.TENLOAIPHIEU
      ORDER BY CT.NGAYLAPCHUNGTU
    </statement>
    <!--CTCT.STATE_CODE >= 5 AND -->
    <statement id="DAO00401_STA001_GetPhieuYeuCauDatHangChiTietByID" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      Select CTCT.CHUNGTUCHITIET_ID,CTCT.HANGHOA_ID,CTCT.MAHANGHOA,CTCT.TENHANGHOA,
	           CTCT.DONVITINH_ID,CTCT.TENDONVITINH,CTCT.SOLUONGYEUCAU,
	           CTCT.TENLOAI, CTCT.GHICHU as GHICHUCHITIET
      FROM TT_PUR_CHUNGTUCHITIET CTCT
      WHERE CTCT.BENHVIEN_ID = '$BENHVIEN_ID$' AND CTCT.CHUNGTU_ID='$CHUNGTU_ID$'
    </statement>
    <!--CTCT.STATE_CODE >= 5 AND -->
    <statement id="DAO00401_STA001_GetChiTietYCDatHang" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      Select CT.CHUNGTU_ID as PHIEUYEUCAU_ID, CT.MACHUNGTU as MAPHIEUYEUCAU, CT.NGAYLAPCHUNGTU as NGAYLAP,
           CT.PHONGBAN_ID as PHONGBANNHAN_ID, CT.TENPHONGBAN AS TENPHONGBANNHAN, NULL AS LOSX,NULL AS HANDUNG,
           CTCT.HANGHOA_ID,CTCT.MAHANGHOA,CTCT.TENHANGHOA,
	         CTCT.DONVITINH_ID,CTCT.TENDONVITINH,CTCT.SOLUONGYEUCAU,
	         CTCT.DONGIA, CTCT.CHUNGTUCHITIET_ID,
	         CTCT.TENLOAI, CTCT.GHICHU, CTCT.STATE_CODE, CTCT.STATE_NAME
      FROM TT_PUR_CHUNGTUCHITIET CTCT
      INNER JOIN TT_PUR_CHUNGTU CT ON CT.CHUNGTU_ID = CTCT.CHUNGTU_ID 
      WHERE CT.BENHVIEN_ID = '$BENHVIEN_ID$' 
      AND CT.MACHUNGTU = '$MAPHIEUYEUCAU$'
      ORDER BY CT.NGAYLAPCHUNGTU
    </statement>

    <statement id="DAO00401_ListKhoVPPOfPhongBan" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select B.* from TM_PHONGBAN_KHODUOC A
      inner join TM_KHODUOC B on B.KHODUOC_ID = A.KHODUOC_ID
      where
      A.PHONGBAN_ID = '$PHONGBAN_ID$'
      and A.BENHVIEN_ID = '$BENHVIEN_ID$'
    </statement>
    <statement id="DAO00401_GetListMucDichChungTu" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      SELECT DICTIONARY_ID, DICTIONARY_CODE, DICTIONARY_NAME
      FROM LST_DICTIONARY
      WHERE DICTIONARY_TYPE_CODE = 'VPP_MucDichChungTu'
      AND ENABLED = '1'
    </statement>
    
  </statements>
</sqlMap>
