<?xml version="1.0" encoding="utf-8" ?>
<!--============================================================================
//	CAUTION: This file is generated by IBatisNetGen.3.SQLMap.cst at 5/24/2016 11:05:56 AM
//				Any manual editing will be lost in re-generation.
//===========================================================================-->
<sqlMap namespace="eHospital" xmlns="http://ibatis.apache.org/mapping" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">

  <statements>
    <statement id="DAO00109_KiemTraBenhNhanDuocChiDinhDichVuTaiPhong" resultClass="DataObject">
      IF EXISTS (
      select DVYC.DVYEUCAU_ID
      from TT_DVYEUCAU DVYC
      WHERE DVYC.TIEPNHAN_ID='$TIEPNHAN_ID$' AND DVYC.NOITHUCHIEN_ID='$PHONGBAN_ID$' AND DVYC.HUYYEUCAU='0' AND DVYC.TRANGTHAI= 'CHUAKETQUA' AND DVYC.BENHVIEN_ID='$BENHVIEN_ID$'
      )
      BEGIN

        IF EXISTS (
        select VP.VIENPHI_ID
        from TT_VIENPHI vp
        INNER JOIN TT_DVYEUCAU YC ON VP.REF_ID=YC.DVYEUCAU_ID AND VP.REF_TABLE='TT_DVYEUCAU'
        WHERE VP.TIEPNHAN_ID='$TIEPNHAN_ID$' AND YC.NOITHUCHIEN_ID='$PHONGBAN_ID$' AND VP.DATHANHTOAN='0' AND YC.BENHVIEN_ID='$BENHVIEN_ID$' AND YC.HUYYEUCAU='0'
        )
        BEGIN
            SELECT -2 AS RESULT
        END
        ELSE
        BEGIN
            SELECT 1 AS RESULT
        END
      END
      ELSE
      BEGIN
        SELECT -1 AS RESULT
      END
    </statement>
    <statement id="DAO00109_KiemTraDichVuTaiPhongDaThanhToan" resultClass="DataObject">
      IF EXISTS (
      select VP.VIENPHI_ID
      from TT_VIENPHI vp
      INNER JOIN TT_DVYEUCAU YC ON VP.REF_ID=YC.DVYEUCAU_ID AND VP.REF_TABLE='TT_DVYEUCAU'
      WHERE VP.TIEPNHAN_ID='$TIEPNHAN_ID$' AND YC.NOITHUCHIEN_ID='$PHONGBAN_ID$' AND VP.DATHANHTOAN='0' AND YC.BENHVIEN_ID='$BENHVIEN_ID$' AND YC.HUYYEUCAU='0'
      )
      BEGIN
      SELECT 0 AS RESULT
      END
      ELSE
      BEGIN
      SELECT 1 AS RESULT
      END
    </statement>
    <statement id="DAO00109_GetAll" resultClass="DataObject">
      select *
      from TT_QUANLYBENHPHAM
      order by QUANLYBENHPHAM_ID
    </statement>

    <statement id="DAO00109_GetList" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select *
      from TT_QUANLYBENHPHAM
      <dynamic prepend="where">
        <isParameterPresent>
          <isNotEmpty prepend="and" property="QUANLYBENHPHAM_ID">
            QUANLYBENHPHAM_ID = '$QUANLYBENHPHAM_ID$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="SOPHIEU">
            SOPHIEU = '$SOPHIEU$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="BENHAN_ID">
            BENHAN_ID = '$BENHAN_ID$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="TIEPNHAN_ID">
            TIEPNHAN_ID = '$TIEPNHAN_ID$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="NOITHUCHIEN_ID">
            NOITHUCHIEN_ID = '$NOITHUCHIEN_ID$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="NGAYTHUCHIEN">
            NGAYTHUCHIEN = '$NGAYTHUCHIEN$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="THOIGIANTHUCHIEN">
            THOIGIANTHUCHIEN = '$THOIGIANTHUCHIEN$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="THOIGIANDUKIENTRAKQ">
            THOIGIANDUKIENTRAKQ = '$THOIGIANDUKIENTRAKQ$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="KYTHUATVIEN_ID">
            KYTHUATVIEN_ID = '$KYTHUATVIEN_ID$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="SOLUONGONGMAU">
            SOLUONGONGMAU = '$SOLUONGONGMAU$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="THOIGIANLAYMAU">
            THOIGIANLAYMAU = '$THOIGIANLAYMAU$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="THOIGIANNHANMAU">
            THOIGIANNHANMAU = '$THOIGIANNHANMAU$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="THOIGIANCDBENHPHAM">
            THOIGIANCDBENHPHAM = '$THOIGIANCDBENHPHAM$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="DUNGDICHCD_ID">
            DUNGDICHCD_ID = '$DUNGDICHCD_ID$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="DUNGTICH">
            DUNGTICH = '$DUNGTICH$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="GHICHU">
            GHICHU = '$GHICHU$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="NGAYTAO">
            NGAYTAO = '$NGAYTAO$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="NGUOITAO_ID">
            NGUOITAO_ID = '$NGUOITAO_ID$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="NGAYCAPNHAT">
            NGAYCAPNHAT = '$NGAYCAPNHAT$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="NGUOICAPNHAT_ID">
            NGUOICAPNHAT_ID = '$NGUOICAPNHAT_ID$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="BENHVIEN_ID">
            BENHVIEN_ID = '$BENHVIEN_ID$'
          </isNotEmpty>
        </isParameterPresent>
      </dynamic>
      order by QUANLYBENHPHAM_ID
    </statement>

    <statement id="DAO00109_GetDetail" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select *
      from TT_QUANLYBENHPHAM
      where QUANLYBENHPHAM_ID  = '$QUANLYBENHPHAM_ID$'
      order by QUANLYBENHPHAM_ID
    </statement>

    <statement id="DAO00109_GetDetailP" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select *
      from TT_QUANLYBENHPHAM
      where QUANLYBENHPHAM_ID  = '$QUANLYBENHPHAM_ID$'
      order by QUANLYBENHPHAM_ID
    </statement>

    <statement id="DAO00109_Add" parameterClass="System.Collections.IDictionary" resultClass="System.Int64">
      insert into TT_QUANLYBENHPHAM (
      SOPHIEU
      , BENHAN_ID
      , TIEPNHAN_ID
      , NOITHUCHIEN_ID
      , NGAYTHUCHIEN
      , THOIGIANTHUCHIEN
      , THOIGIANDUKIENTRAKQ
      , KYTHUATVIEN_ID
      , SOLUONGONGMAU
      , THOIGIANLAYMAU
      , THOIGIANNHANMAU
      , THOIGIANCDBENHPHAM
      , DUNGDICHCD_ID
      , DUNGTICH
      , GHICHU
      , NGAYTAO
      , NGUOITAO_ID
      , NGAYCAPNHAT
      , NGUOICAPNHAT_ID
      , BENHVIEN_ID
      ) values (
      #SOPHIEU#
      , #BENHAN_ID#
      , #TIEPNHAN_ID#
      , #NOITHUCHIEN_ID#
      , #NGAYTHUCHIEN#
      , #THOIGIANTHUCHIEN#
      , #THOIGIANDUKIENTRAKQ#
      , #KYTHUATVIEN_ID#
      , #SOLUONGONGMAU#
      , #THOIGIANLAYMAU#
      , #THOIGIANNHANMAU#
      , #THOIGIANCDBENHPHAM#
      , #DUNGDICHCD_ID#
      , #DUNGTICH#
      , #GHICHU#
      , #NGAYTAO#
      , #NGUOITAO_ID#
      , #NGAYCAPNHAT#
      , #NGUOICAPNHAT_ID#
      , #BENHVIEN_ID#
      )
      SELECT SCOPE_IDENTITY()
    </statement>

    <update id="DAO00109_Update" parameterClass="System.Collections.IDictionary">
      update TT_QUANLYBENHPHAM set
      NOITHUCHIEN_ID = #NOITHUCHIEN_ID#
      , NGAYTHUCHIEN = #NGAYTHUCHIEN#
      , THOIGIANTHUCHIEN = #THOIGIANTHUCHIEN#
      , THOIGIANDUKIENTRAKQ = #THOIGIANDUKIENTRAKQ#
      , KYTHUATVIEN_ID = #KYTHUATVIEN_ID#
      , SOLUONGONGMAU = #SOLUONGONGMAU#
      , THOIGIANLAYMAU = #THOIGIANLAYMAU#
      , THOIGIANNHANMAU = #THOIGIANNHANMAU#
      , THOIGIANCDBENHPHAM = #THOIGIANCDBENHPHAM#
      , DUNGDICHCD_ID = #DUNGDICHCD_ID#
      , DUNGTICH = #DUNGTICH#
      , GHICHU = #GHICHU#
      , NGAYCAPNHAT = #NGAYCAPNHAT#
      , NGUOICAPNHAT_ID = #NGUOICAPNHAT_ID#
      where
      QUANLYBENHPHAM_ID = '$QUANLYBENHPHAM_ID$'
    </update>

    <statement id="DAO00109_DeleteP" parameterClass="System.Collections.IDictionary" resultClass="System.Int32">
      delete from TT_QUANLYBENHPHAM
      where
      QUANLYBENHPHAM_ID = '$QUANLYBENHPHAM_ID$'
    </statement>

    <statement id="DAO00109_GetTrangThaiDichVu" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select TRANGTHAI
      from TT_DVYEUCAU
      where DVYEUCAU_ID  = '$DVYEUCAU_ID$'
    </statement>
    <statement id="DAO00109_GetDanhSachSidCuaBenhNhan" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select distinct A.*, B.SID
      from TT_QUANLYBENHPHAM A
      left join TT_QUANLYBENHPHAM_CHITIET B on A.QUANLYBENHPHAM_ID = B.QUANLYBENHPHAM_ID
      where A.TIEPNHAN_ID = '$TIEPNHAN_ID$'
      <isNotEmpty prepend=" and " property="BENHAN_ID">
        A.BENHAN_ID = '$BENHAN_ID$'
      </isNotEmpty>
    </statement>
    <!--///////////////////////////////////////////////////////////////-->
    <statement id="DAO00109_GetDSLayMau" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      <!--<isNotEmpty prepend="" property="GetCountList">
        <isEqual prepend="" property="GetCountList" compareValue="True">
          SELECT COUNT(*) AS TOTALROWS
        </isEqual>
      </isNotEmpty>
      <isNotEmpty prepend="" property="GetWaitingList">
        <isEqual prepend="" property="GetWaitingList" compareValue="True">
          SELECT *
        </isEqual>
      </isNotEmpty>-->
      select *
      FROM
      (SELECT COUNT(*) OVER() as TOTALROWS, ROW_NUMBER() OVER(order by isnull($SOHANGDOI$,'999999999'), dv.NGAYGIOYEUCAU) as ROWNUMBER,
      N'Mã người bệnh: ' + bn.MAYTE + ' - ' + N'Tên người bệnh: ' + bn.TENBENHNHAN + ' - ' + N'Số bệnh án: ' + ISNULL(BA.SOBENHAN,'') + ' - ' + N'Sinh ngày: ' + Convert(varchar(10),bn.NGAYSINH,103) + ' - ' + N'Giới tính: ' + GD.DESCRIPTION as GROUPNAME,
      bn.MAYTE, bn.TENBENHNHAN, bn.NAMSINH, bn.NGAYSINH as TUOI, ISNULL(CONVERT(VARCHAR(10),
      NGAYSINH, 103),CAST(NAMSINH AS varchar)) as NGAYSINH, bn.DIACHILIENLAC as DIACHI, bn.GIOITINH, GD.DESCRIPTION as TENGIOITINH,tn.DOITUONG_ID, tn.THOIGIANTIEPNHAN, tn.BENHNHAN_ID, tn.TIEPNHAN_ID,
      tn.TRAITUYEN, tn.SOTIEPNHAN,dv.DICHVU_ID, dv.NOITHUCHIEN_ID, isnull(dv.NGAYTAO, dv.NGAYCAPNHAT) as THOIGIANDKDICHVU, dv.KHAN, dv.NOIYEUCAU_ID, dv.NGAYGIOYEUCAU, dv.BACSICHIDINH_ID,
      dv.DONVIGIOITHIEU_ID, dv.NGUOIGIOITHIEU_ID,tn.NOIGIOITHIEU_ID, kbnt.HUONGGIAIQUYET_ID,dv.DVYEUCAU_ID, dv.MARIS, dv.TRANGTHAI as TRANGTHAICODE, B.TENNHOMDICHVU, dv.SOPHIEUYEUCAU, dv.KHAMBENH_NGOAITRU_ID, dv.NGUOICAPNHAT_ID, dv.NGAYCAPNHAT,
      CASE WHEN Left(B.MANHOMDICHVU,2) = '03' THEN '02' ELSE Left(B.MANHOMDICHVU,2) END AS MANHOMDICHVU, B.MANHOMDICHVU as MANHOMDICHVUCHITIET, tn.TRANGTHAI as TRANGTHAI_TIEPNHAN,'$DAKHAM$' as DAKHAM,
      isnull($SOHANGDOI$,'999999999') as SOHANGDOI,vp.DATHANHTOAN,BA.SOBENHAN
      <isNotEmpty prepend="" property="CHITIET_LIS">
        <isEqual prepend="," property="CHITIET_LIS" compareValue="True">
          lisRis.CLSKETQUA_ID, lisRis.NGAYGIOTHUCHIEN , lisRis.THOIGIANKHOADULIEU, lisRis.NGUOIKHOA_ID, lisRis.VTYT, mau.SID, lisRis.GUINGOAI, lisRis.NOIGUIDEN_ID
        </isEqual>
      </isNotEmpty>
      <isNotEmpty prepend="" property="CHITIET_LAYMAU">
        <isEqual prepend="," property="CHITIET_LAYMAU" compareValue="True">
          mau.SID, mau.THOIGIANLAYMAU, mau.NOITHUCHIEN_ID as NOILAYMAU_ID, mau.KYTHUATVIEN_ID
        </isEqual>
      </isNotEmpty>
      FROM [TT_TIEPNHAN] tn
      join TT_BENHNHAN bn on tn.BENHNHAN_ID = bn.BENHNHAN_ID
      left join TT_DVYEUCAU dv on dv.TIEPNHAN_ID = tn.TIEPNHAN_ID
      left join TM_DICHVU A on A.DICHVU_ID = dv.DICHVU_ID
      left join TM_NHOMDICHVU B on B.NHOMDICHVU_ID = A.NHOMDICHVU_ID
      left join TT_VIENPHI VP on VP.TIEPNHAN_ID = tn.TIEPNHAN_ID and VP.DICHVU_ID = dv.DICHVU_ID and VP.REF_ID = dv.DVYEUCAU_ID
      left join TT_NOITRU_BENHAN BA on BA.TIEPNHAN_ID = tn.TIEPNHAN_ID AND dv.BENHAN_ID = BA.BENHAN_ID
      left join TM_GENDER GD on GD.ID = bn.GIOITINH
      left join TT_NGOAITRU_KHAMBENH kbnt on kbnt.KHAMBENH_ID = dv.KHAMBENH_NGOAITRU_ID
      <isNotEmpty prepend="" property="CHITIET_LIS">
        <isEqual prepend="" property="CHITIET_LIS" compareValue="True">
          left join(select distinct A.DVYEUCAU_ID, B.CLSKETQUA_ID, B.NGAYGIOTHUCHIEN , B.THOIGIANKHOADULIEU, B.NGUOIKHOA_ID, B.GUINGOAI, B.NOIGUIDEN_ID,
          C.CLSKETQUA_ID as VTYT
          from TT_CLSKETQUACHITIET A
          left join TT_CLSKETQUA B on B.CLSKETQUA_ID = A.CLSKETQUA_ID
          left join TT_CLSKETQUA_VTYT C on C.CLSKETQUA_ID = a.CLSKETQUA_ID
          where A.BENHVIEN_ID = '$BENHVIEN_ID$') lisRis on lisRis.DVYEUCAU_ID = dv.DVYEUCAU_ID
          left join(select distinct A.DVYEUCAU_ID, A.SID, B.THOIGIANLAYMAU, B.NOITHUCHIEN_ID, B.KYTHUATVIEN_ID
          from TT_QUANLYBENHPHAM_CHITIET A
          left join TT_QUANLYBENHPHAM B on B.QUANLYBENHPHAM_ID = A.QUANLYBENHPHAM_ID and B.BENHVIEN_ID = '$BENHVIEN_ID$')
          mau on mau.DVYEUCAU_ID = dv.DVYEUCAU_ID
        </isEqual>
      </isNotEmpty>
      <isNotEmpty prepend="" property="CHITIET_LAYMAU">
        <isEqual prepend="" property="CHITIET_LAYMAU" compareValue="True">
          left join(select distinct A.DVYEUCAU_ID, A.SID, B.THOIGIANLAYMAU, B.NOITHUCHIEN_ID, B.KYTHUATVIEN_ID
          from TT_QUANLYBENHPHAM_CHITIET A
          left join TT_QUANLYBENHPHAM B on B.QUANLYBENHPHAM_ID = A.QUANLYBENHPHAM_ID and B.BENHVIEN_ID = '$BENHVIEN_ID$')
          mau on mau.DVYEUCAU_ID = dv.DVYEUCAU_ID
        </isEqual>
      </isNotEmpty>
      where
      dv.DICHVU_ID IS NOT NULL
      and tn.BENHVIEN_ID = '$BENHVIEN_ID$'
      and HUYYEUCAU = 0
      and dv.NGAYHENCLS is NULL
      <isNotEmpty prepend="and" property="TUNGAY">
        dv.NGAYYEUCAU &#62;&#61; '$TUNGAY$'
      </isNotEmpty>
      <isNotEmpty prepend="and" property="DENNGAY">
        dv.NGAYYEUCAU &#60;&#61; '$DENNGAY$'
      </isNotEmpty>
      <isNotEmpty prepend="and" property="NOITHUCHIEN_ID">
        dv.NOITHUCHIEN_ID = '$NOITHUCHIEN_ID$'
      </isNotEmpty>
      <isNotEmpty prepend="and" property="NOIYEUCAU_ID">
        dv.NOIYEUCAU_ID = '$NOIYEUCAU_ID$'
      </isNotEmpty>
      <isNotEmpty prepend="and" property="MANHOMDICHVUCAPDUOI">
        B.MANHOMDICHVU = '$MANHOMDICHVUCAPDUOI$'
      </isNotEmpty>
      <isNotEmpty prepend="and" property="GHINHANVTYT">
        dv.GHINHANVTYT = '$GHINHANVTYT$'
      </isNotEmpty>
      <isNotEmpty prepend="and" property="BACSICHIDINH_ID">
        ISNULL (dv.BACSICHIDINH_ID, dv.NGUOIGIOITHIEU_ID) = '$BACSICHIDINH_ID$'
      </isNotEmpty>
      <isNotEmpty prepend="" property="DAKHAM">
        <isEqual prepend="AND" property="DAKHAM" compareValue="True">
          (dv.TRANGTHAI = 'HOANTAT' or dv.TRANGTHAI = 'DACHUYENTUYEN'  or dv.TRANGTHAI = 'CHOXACNHAN' OR dv.TRANGTHAI = 'DANGTHUCHIEN')
        </isEqual>
        <isEqual prepend="AND" property="DAKHAM" compareValue="False">
          (dv.TRANGTHAI = 'CHUAKETQUA')
        </isEqual>
      </isNotEmpty>
      <isNotEmpty prepend="and" property="DICHVU_DATHANHTOAN">
        (vp.DATHANHTOAN = '$DICHVU_DATHANHTOAN$'  or vp.DONGIA_DOANHTHU = '0' OR TN.SUDUNG_BHTN='1' OR TN.BAOLANH_VIENPHI='1'  OR tn.TRANGTHAI IN ('NOITRU','CAPCUU','NGOAITRU'))
      </isNotEmpty>
      <isNotEmpty prepend="" property="DALAYMAU">
        <isEqual prepend="AND" property="DALAYMAU" compareValue="True">
          dv.DALAYMAU = '1'
        </isEqual>
        <isEqual prepend="AND" property="DALAYMAU" compareValue="False">
          (dv.DALAYMAU = '0' or dv.DALAYMAU is null)
        </isEqual>
      </isNotEmpty>
      <isNotEmpty prepend="" property="CHITIET_LIS">
        <isEqual prepend="" property="CHITIET_LIS" compareValue="True">
          <isNotEmpty prepend="" property="GUINGOAI">
            <isEqual prepend="AND" property="GUINGOAI" compareValue="True">
              dv.YEUCAUBENNGOAI = '1'
            </isEqual>
          </isNotEmpty>
          <isNotEmpty prepend="and" property="NOIGUIDEN_ID">
            dv.DONVIGIOITHIEU_ID = '$NOIGUIDEN_ID$'
          </isNotEmpty>
        </isEqual>
      </isNotEmpty>
      <isNotEmpty prepend="" property="EXAMDOC">
        <isGreaterThan prepend="AND" property="EXAMDOC" compareValue="0">
          tn.NGUOICAPNHAT_ID = '$EXAMDOC$'
        </isGreaterThan>
      </isNotEmpty>
      <isNotEmpty prepend="and" property="TENBENHNHAN">
        (bn.TENBENHNHAN like '%' + #TENBENHNHAN# + '%' or bn.MAYTE like '%' + #TENBENHNHAN# + '%')
      </isNotEmpty>
      <isNotEmpty prepend="and" property="MANHOMDICHVU">
        (CASE WHEN Left(B.MANHOMDICHVU,2) = '03' THEN '02' ELSE Left(B.MANHOMDICHVU,2) END) = '$MANHOMDICHVU$'
      </isNotEmpty>
      <isNotEmpty prepend="and" property="MANHOMDICHVU_EXCEPT">
        (CASE WHEN Left(B.MANHOMDICHVU,2) = '03' THEN '02' ELSE Left(B.MANHOMDICHVU,2) END) not in ($MANHOMDICHVU_EXCEPT$)
      </isNotEmpty>
      <isNotEmpty prepend="and" property="TRANGTHAI_DONGTIEN">
        tn.TRANGTHAI IN ('$TRANGTHAI_DONGTIEN$')
      </isNotEmpty>
      <isNotEmpty prepend="and" property="LST_DICHVU_ID">
        dv.DICHVU_ID in
        <iterate open="(" close=")" conjunction=",  " property="LST_DICHVU_ID">#LST_DICHVU_ID[]#</iterate>
      </isNotEmpty>
      ) lst
      <isNotEmpty prepend="" property="GetWaitingList">
        <isEqual prepend="" property="GetWaitingList" compareValue="True">
          where
          lst.ROWNUMBER between $FROMROW$ and $TOROW$
          order by SOHANGDOI, NGAYGIOYEUCAU asc
        </isEqual>
      </isNotEmpty>
    </statement>

  </statements>

</sqlMap>
