<?xml version="1.0" encoding="utf-8" ?>
<!--============================================================================
//	CAUTION: This file is generated by IBatisNetGen.3.SQLMap.cst at 11/11/2015 9:30:18 AM
//				Any manual editing will be lost in re-generation.
//===========================================================================-->
<sqlMap namespace="eHospital" xmlns="http://ibatis.apache.org/mapping" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">

  <statements>
    <statement id="DAO00014_KiemTraDVYCCoBHYT" parameterClass="System.String" resultClass="DataObject">
      select *
      from TT_VIENPHI
      where REF_ID  = '$DVYEUCAU_ID$' and REF_TABLE = 'TT_DVYEUCAU' and BHYT_DONGIA > 0
    </statement>
    <statement id="DAO00014_GetTotalChiPhiDVByTiepNhan" parameterClass="System.String" resultClass="DataObject">
      select sum(THANHTIEN_DOANHTHU) as THANHTIEN_DOANHTHU from TT_VIENPHI
      where ACTIVE = '1'
      and TIEPNHAN_ID = '$TIEPNHAN_ID$'
      and REF_TABLE = 'TT_DVYEUCAU'
      and exists (select DVYEUCAU_ID from TT_DVYEUCAU where HUYYEUCAU = '0' and TIEPNHAN_ID = '$TIEPNHAN_ID$' and TT_VIENPHI.REF_ID = DVYEUCAU_ID)
    </statement>
    <statement id="DAO00014_GetDetail" parameterClass="System.String" resultClass="DataObject">
      select *
      from TT_NGOAITRU_KHAMBENH
      where KHAMBENH_ID  = '$value$'
    </statement>

    <statement id="DAO00014_LoadLSTiepNhanByBenhNhanID" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select *
      from TT_TIEPNHAN
      where BENHNHAN_ID  = '$BENHNHAN_ID$'
      order by THOIGIANTIEPNHAN desc
      <!--and (TIEPNHAN_ID in (select TIEPNHAN_ID from TT_CLSKETQUA)
      or TIEPNHAN_ID in (select TIEPNHAN_ID from TT_PHAUTHUAT))
      order by THOIGIANTIEPNHAN desc-->
    </statement>

    <statement id="DAO00014_GetLichSuDungThuoc" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select t.*, tt.LOAITOATHUOC, tt.NGAYTAO as NGAYCHOTOA, tt.NGAYCAPNHAT as NGAYCAPNHATTOA, kb.DICHVU_ID, dc.TENDUOCDAYDU
      from TT_NGOAITRU_KHAMBENH kb
      left join TT_NGOAITRU_KHAMBENH_TOATHUOC tt on kb.KHAMBENH_ID = tt.KHAMBENH_ID
      left join TT_NGOAITRU_TOATHUOC t on tt.KHAMBENH_TOATHUOC_ID = t.KHAMBENH_TOATHUOC_ID
      left join TM_DUOC dc on t.DUOC_ID = dc.DUOC_ID
      left join TM_LOAIDUOC ld on dc.LOAIDUOC_ID = ld.LOAIDUOC_ID
      where kb.BENHNHAN_ID = '$BENHNHAN_ID$'
      and (kb.THOIGIANKHAM >= '$NGAYBATDAU$')
      <isNotEmpty prepend="and" property="LOAITOATHUOC">
        LOAITOATHUOC = '$LOAITOATHUOC$'
      </isNotEmpty>
    </statement>

    <statement id="DAO00014_GetKhamBenhInfo" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      <!--select *
      from TT_NGOAITRU_KHAMBENH
      where TIEPNHAN_ID  = '$TIEPNHAN_ID$'
      <isNotEmpty prepend="and" property="NGUOITAO_ID">
        NGUOITAO_ID = '$NGUOITAO_ID$'
      </isNotEmpty>
      and DICHVU_ID = '$DICHVU_ID$'
      and KHAMBENH_ID in
      (select KHAMBENH_NGOAITRU_ID
      from TT_DVYEUCAU
      where DVYEUCAU_ID = '$DVYEUCAU_ID$')-->

      select * from TT_NGOAITRU_KHAMBENH where KHAMBENH_ID =
      (select KHAMBENH_NGOAITRU_ID from TT_DVYEUCAU where DVYEUCAU_ID = '$DVYEUCAU_ID$')
    </statement>

    <statement id="DAO00014_GetChanDoanKhoaKham" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select KHAMBENH_ID, CHANDOANKHOAKHAM
      from TT_NGOAITRU_KHAMBENH
      where TIEPNHAN_ID  = '$TIEPNHAN_ID$'
      and NGUOITAO_ID  = '$NGUOITAO_ID$'
      and DICHVU_ID  = '$DICHVU_ID$'
      and BENHVIEN_ID = '$BENHVIEN_ID$'
    </statement>

    <statement id="DAO00014_GetChanDoan" parameterClass="System.Collections.IDictionary" resultClass="String">
      DECLARE @VAL1 NVARCHAR(1000) = ''
      DECLARE @VAL2 NVARCHAR(1000) = ''
      SELECT @VAL1 = (SELECT ICD.TENICD +'('+ICD.MAICD+'); '+ KB.CHANDOANKHOAKHAM FROM TT_NGOAITRU_KHAMBENH KB
      INNER JOIN TM_ICD ICD ON ICD.ICD_ID = KB.CHANDOANICD_ID
      WHERE KHAMBENH_ID = #KHAMBENH_ID#)
      SELECT @VAl2 = @VAL2 + ICD.TENICD +'('+ICD.MAICD +'); ' FROM
      TT_NGOAITRU_KHAMBENH_ICD KBI
      INNER JOIN TM_ICD ICD ON KBI.ICD_ID = ICD.ICD_ID
      WHERE KBI.KHAMBENH_ID = #KHAMBENH_ID#
      SELECT @VAL1 + '; '+ ISNULL(@VAL2,'')
    </statement>

    <statement id="DAO00014_GetSoCaKhamTrongNgay" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select Count(KB.KHAMBENH_ID) as SOCAKHAMTRONGNGAY
      from TT_NGOAITRU_KHAMBENH KB
      inner join TT_TIEPNHAN TN on TN.TIEPNHAN_ID = KB.TIEPNHAN_ID
      where KB.NGAYKHAM = convert(date, GETDATE())
      and KB.BACSIKHAM_ID = '$BACSIKHAM_ID$'
      and KB.BENHVIEN_ID = '$BENHVIEN_ID$'
      and TN.SOBHYT IS NOT NULL and TN.SOBHYT != ''

    </statement>

    <statement id="DAO00014_GetChungTuPhatThuoc" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select CHUNGTUPHATTHUOC_ID
      from TT_NGOAITRU_KHAMBENH_TOATHUOC
      where KHAMBENH_TOATHUOC_ID  = '$KHAMBENH_TOATHUOC_ID$'
    </statement>
    <statement id="DAO00014_GetChungTuPhatThuoc_OPD02" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select CHUNGTUPHATTHUOC_ID, DUYET
      from TT_NGOAITRU_KHAMBENH_TOATHUOC
      where KHAMBENH_TOATHUOC_ID  = '$KHAMBENH_TOATHUOC_ID$'
    </statement>
    <statement id="DAO00014_GetTTinToaThuoc" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select *
      from TT_NGOAITRU_KHAMBENH_TOATHUOC
      where KHAMBENH_TOATHUOC_ID  = '$KHAMBENH_TOATHUOC_ID$'
    </statement>

    <statement id="DAO00014_Add" parameterClass="HashTable" resultClass="System.Int64">
      insert into TT_NGOAITRU_KHAMBENH (
      BENHNHAN_ID
      , TIEPNHAN_ID
      , BENHAN_ID
      , DICHVU_ID
      , PHONGBAN_ID
      , NGAYKHAM
      , THOIGIANKHAM
      , BACSIKHAM_ID
      , DIEUDUONG_ID
      , DOITUONG_ID
      , CHANDOANICD_ID
      , CHANDOANPHUICD_ID
      , CHANDOANICD
      , BENHMANTINH_ID
      , HUONGGIAIQUYET_ID
      , YEUCAUCHITIET_ID
      , CHANDOANKHOAKHAM
      , TLDG_MT
      , TLDG_MP
      , TKLT_MP
      , TKLT_MT
      , TLDG_MT_TEXT
      , TLDG_MP_TEXT
      , TKLT_MP_TEXT
      , TKLT_MT_TEXT
      , NHANAP_MT
      , NHANAP_MP
      , MACH
      , CANNANG
      , CHIEUCAO
      , HUYETAPTHAP
      , HUYETAPCAO
      , NHIPTHO
      , NHIETDO
      , BMI
      , TYLEMO
      , VONGBUNG
      , SIEUHIENVI
      , SOIDAYMAT
      , TRIEUCHUNGLAMSANG
      , CHANDOANSOBOICD_ID
      , CHANDOANSOBO
      , CHUYENDENBENHVIEN_ID
      , LYDONHAPVIEN_ID
      , THOIGIANNHAPVIENDUKIEN
      , KHAMBENHLANDAU_ID
      , KHAMBENH_CHUYENKHOA_ID
      , NHAPKHOA_ID
      , CHUYENKHOA_ID
      , NGHIOM_TUNGAY
      , NGHIOM_DENNGAY
      , HUONGDIEUTRI_ID
      , CHEDOANUONG_ID
      , CHEDOCHAMSOC_ID
      , DIEUTRIDUPHONG
      , SONGAYDIEUTRI
      , GIAIDOANBENH
      , TOATHUOCMUANGOAI
      , TACDUNGPHU
      , TUANTHUCUABN
      , SONGAYHENTAIKHAM
      , SOBENHANNGOAITRU_ID
      , KHAMCAPCUU
      , GHICHU
      , KHOADULIEU
      , NGUOIKHOA_ID
      , NGAYKHOA
      , THOIGIANKHOA
      , BENHVIEN_ID
      , NGAYTAO
      , NGUOITAO_ID
      , NGAYCAPNHAT
      , NGUOICAPNHAT_ID
      , KHAMBENH_SINHHIEU_ID
      ) values (
      #BENHNHAN_ID#
      , #TIEPNHAN_ID#
      , #BENHAN_ID#
      , #DICHVU_ID#
      , #PHONGBAN_ID#
      , #NGAYKHAM#
      , #THOIGIANKHAM#
      , #BACSIKHAM_ID#
      , #DIEUDUONG_ID#
      , #DOITUONG_ID#
      , #CHANDOANICD_ID#
      , #CHANDOANPHUICD_ID#
      , #CHANDOANICD#
      , #BENHMANTINH_ID#
      , #HUONGGIAIQUYET_ID#
      , #YEUCAUCHITIET_ID#
      , #CHANDOANKHOAKHAM#
      , #TLDG_MT#
      , #TLDG_MP#
      , #TKLT_MP#
      , #TKLT_MT#
      , #TLDG_MT_TEXT#
      , #TLDG_MP_TEXT#
      , #TKLT_MP_TEXT#
      , #TKLT_MT_TEXT#
      , #NHANAP_MT#
      , #NHANAP_MP#
      , #MACH#
      , #CANNANG#
      , #CHIEUCAO#
      , #HUYETAPTHAP#
      , #HUYETAPCAO#
      , #NHIPTHO#
      , #NHIETDO#
      , #BMI#
      , #TYLEMO#
      , #VONGBUNG#
      , #SIEUHIENVI#
      , #SOIDAYMAT#
      , #TRIEUCHUNGLAMSANG#
      , #CHANDOANSOBOICD_ID#
      , #CHANDOANSOBO#
      , #CHUYENDENBENHVIEN_ID#
      , #LYDONHAPVIEN_ID#
      , #THOIGIANNHAPVIENDUKIEN#
      , #KHAMBENHLANDAU_ID#
      , #KHAMBENH_CHUYENKHOA_ID#
      , #NHAPKHOA_ID#
      , #CHUYENKHOA_ID#
      , #NGHIOM_TUNGAY#
      , #NGHIOM_DENNGAY#
      , #HUONGDIEUTRI_ID#
      , #CHEDOANUONG_ID#
      , #CHEDOCHAMSOC_ID#
      , #DIEUTRIDUPHONG#
      , #SONGAYDIEUTRI#
      , #GIAIDOANBENH#
      , #TOATHUOCMUANGOAI#
      , #TACDUNGPHU#
      , #TUANTHUCUABN#
      , #SONGAYHENTAIKHAM#
      , #SOBENHANNGOAITRU_ID#
      , #KHAMCAPCUU#
      , #GHICHU#
      , #KHOADULIEU#
      , #NGUOIKHOA_ID#
      , #NGAYKHOA#
      , #THOIGIANKHOA#
      , #BENHVIEN_ID#
      , #NGAYTAO#
      , #NGUOITAO_ID#
      , #NGAYCAPNHAT#
      , #NGUOICAPNHAT_ID#
      , #KHAMBENH_SINHHIEU_ID#
      )
      SELECT SCOPE_IDENTITY()
      <!--<selectKey resultClass="System.Int64" type="post" >
        SELECT @@IDENTITY as value
      </selectKey>-->
    </statement>

    <statement id="DAO00014_Insert_TAINANTHUONGTICH" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      INSERT INTO [dbo].[TT_TAINANTHUONGTICH]
      ([BENHNHAN_ID]
      ,[TIEPNHAN_ID]
      ,[BENHAN_ID]
      ,[NGAYKHAM]
      ,[THOIGIANKHAM]
      ,[CHANDOANNOIGIOITHIEU]
      ,[NGAYTAINAN]
      ,[THOIGIANTAINAN]
      ,[NOITAINAN_TINHTHANH_ID]
      ,[NOITAINAN_QUANHUYEN_ID]
      ,[NOITAINAN_PHUONGXA_ID]
      ,[NOITAINAN_DIACHI]
      ,[DIADIEMTAINAN_ID]
      ,[BOPHANBITHUONG_ID]
      ,[DIENBIENSAUTN_ID]
      ,[XUTRISAUTN_ID]
      ,[MUCDO_ID]
      ,[NGUYENNHAN_ID]
      ,[ICD_NGUYENNHAN]
      ,[NGUYENNHANCHITIET_ID]
      ,[XUTRIKHAMBENH_ID]
      ,[CONGANCANTHIEP]
      ,[BENHVIEN_ID]
      ,[NGAYTAO]
      ,[NGUOITAO_ID]
      ,[NGAYCAPNHAT]
      ,[NGUOICAPNHAT_ID])
      VALUES
      (#BENHNHAN_ID#
      ,#TIEPNHAN_ID#
      ,#BENHAN_ID#
      ,#NGAYKHAM#
      ,#THOIGIANKHAM#
      ,#CHANDOANNOIGIOITHIEU#
      ,#NGAYTAINAN#
      ,#THOIGIANTAINAN#
      ,#NOITAINAN_TINHTHANH_ID#
      ,#NOITAINAN_QUANHUYEN_ID#
      ,#NOITAINAN_PHUONGXA_ID#
      ,#NOITAINAN_DIACHI#
      ,#DIADIEMTAINAN_ID#
      ,#BOPHANBITHUONG_ID#
      ,#DIENBIENSAUTN_ID#
      ,#XUTRISAUTN_ID#
      ,#MUCDO_ID#
      ,#NGUYENNHAN_ID#
      ,#ICD_NGUYENNHAN#
      ,#NGUYENNHANCHITIET_ID#
      ,#XUTRIKHAMBENH_ID#
      ,#CONGANCANTHIEP#
      ,#BENHVIEN_ID#
      ,#NGAYTAO#
      ,#NGUOITAO_ID#
      ,#NGAYCAPNHAT#
      ,#NGUOICAPNHAT_ID#)
    </statement>

    <statement id="DAO00014_Update_TAINANTHUONGTICH" parameterClass="System.Collections.IDictionary">
      UPDATE [dbo].[TT_TAINANTHUONGTICH]
      SET [BENHNHAN_ID] = #BENHNHAN_ID#
      ,[TIEPNHAN_ID] = #TIEPNHAN_ID#
      ,[BENHAN_ID] = #BENHAN_ID#
      ,[NGAYKHAM] = #NGAYKHAM#
      ,[THOIGIANKHAM] = #THOIGIANKHAM#
      ,[CHANDOANNOIGIOITHIEU] = #CHANDOANNOIGIOITHIEU#
      ,[NGAYTAINAN] = #NGAYTAINAN#
      ,[THOIGIANTAINAN] = #THOIGIANTAINAN#
      ,[NOITAINAN_TINHTHANH_ID] = #NOITAINAN_TINHTHANH_ID#
      ,[NOITAINAN_QUANHUYEN_ID] = #NOITAINAN_QUANHUYEN_ID#
      ,[NOITAINAN_PHUONGXA_ID] = #NOITAINAN_PHUONGXA_ID#
      ,[NOITAINAN_DIACHI] = #NOITAINAN_DIACHI#
      ,[DIADIEMTAINAN_ID] = #DIADIEMTAINAN_ID#
      ,[BOPHANBITHUONG_ID] = #BOPHANBITHUONG_ID#
      ,[DIENBIENSAUTN_ID] = #DIENBIENSAUTN_ID#
      ,[XUTRISAUTN_ID] = #XUTRISAUTN_ID#
      ,[MUCDO_ID] = #MUCDO_ID#
      ,[NGUYENNHAN_ID] = #NGUYENNHAN_ID#
      ,[ICD_NGUYENNHAN] = #ICD_NGUYENNHAN#
      ,[NGUYENNHANCHITIET_ID] = #NGUYENNHANCHITIET_ID#
      ,[XUTRIKHAMBENH_ID] = #XUTRIKHAMBENH_ID#
      ,[CONGANCANTHIEP] = #CONGANCANTHIEP#
      ,[BENHVIEN_ID] = #BENHVIEN_ID#
      ,[NGAYTAO] = #NGAYTAO#
      ,[NGUOITAO_ID] = #NGUOITAO_ID#
      ,[NGAYCAPNHAT] = #NGAYCAPNHAT#
      ,[NGUOICAPNHAT_ID] = #NGUOICAPNHAT_ID#
      WHERE TAINANTHUONGTICH_ID = #TAINANTHUONGTICH_ID#
    </statement>

    <statement id="DAO00014_GetTT_TAINANTHUONGTICH" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      SELECT *
      FROM [dbo].[TT_TAINANTHUONGTICH]
      WHERE
      TT_TAINANTHUONGTICH.TIEPNHAN_ID = '$TIEPNHAN_ID$' AND
      TT_TAINANTHUONGTICH.BENHNHAN_ID = '$BENHNHAN_ID$'
    </statement>

    <statement id="DAO00014_DeleteKhamBenhInfo" parameterClass="System.Collections.IDictionary" resultClass="System.Int32">
      delete from TT_NGOAITRU_KHAMBENH
      where KHAMBENH_ID = '$KHAMBENH_ID$'
    </statement>

    <statement id="DAO00014_Update_TTKhambenh" parameterClass="System.Collections.IDictionary">
      update TT_NGOAITRU_KHAMBENH set
      TRIEUCHUNGLAMSANG = #TRIEUCHUNGLAMSANG#
      , CHANDOANKHOAKHAM = #CHANDOANKHOAKHAM#
      , CHANDOANSOBOICD_ID = #CHANDOANSOBOICD_ID#
      , CHANDOANSOBO = #CHANDOANSOBO#
      , CHANDOANICD_ID = #CHANDOANICD_ID#
      , NGUOICAPNHAT_ID = #NGUOICAPNHAT_ID#
      , NGAYCAPNHAT = Getdate()
      where
      KHAMBENH_ID = #KHAMBENH_ID#
    </statement>
    <update id="DAO00014_Update" parameterClass="HashTable">
      update TT_NGOAITRU_KHAMBENH set
      BENHNHAN_ID = #BENHNHAN_ID#
      , DICHVU_ID = #DICHVU_ID#
      <!--, PHONGBAN_ID = #PHONGBAN_ID#
      , BACSIKHAM_ID = #BACSIKHAM_ID#-->
      , NGAYKHAM = #NGAYKHAM#
      , CHANDOANICD_ID = #CHANDOANICD_ID#
      , HUONGGIAIQUYET_ID = #HUONGGIAIQUYET_ID#
      <!--, KHAMCAPCUU = #KHAMCAPCUU#-->
      , YEUCAUCHITIET_ID = #YEUCAUCHITIET_ID#
      , CHANDOANKHOAKHAM = #CHANDOANKHOAKHAM#
      , SONGAYHENTAIKHAM = #SONGAYHENTAIKHAM#
      , NHANAP_MT = #NHANAP_MT#
      , NHANAP_MP = #NHANAP_MP#
      , CHANDOANPHUICD_ID = #CHANDOANPHUICD_ID#
      , TRIEUCHUNGLAMSANG = #TRIEUCHUNGLAMSANG#
      , HUYETAPTHAP = #HUYETAPTHAP#
      , HUYETAPCAO = #HUYETAPCAO#
      , BENHMANTINH_ID = #BENHMANTINH_ID#
      , NHAPKHOA_ID = #NHAPKHOA_ID#
      , CHANDOANSOBOICD_ID = #CHANDOANSOBOICD_ID#
      , CHANDOANSOBO = #CHANDOANSOBO#
      , CHUYENDENBENHVIEN_ID = #CHUYENDENBENHVIEN_ID#
      , LYDONHAPVIEN_ID = #LYDONHAPVIEN_ID#
      , NGHIOM_TUNGAY = #NGHIOM_TUNGAY#
      , NGHIOM_DENNGAY = #NGHIOM_DENNGAY#
      , TLDG_MT_TEXT = #TLDG_MT_TEXT#
      , TLDG_MP_TEXT = #TLDG_MP_TEXT#
      , TKLT_MP_TEXT = #TKLT_MP_TEXT#
      , TKLT_MT_TEXT = #TKLT_MT_TEXT#
      , SIEUHIENVI = #SIEUHIENVI#
      , SOIDAYMAT = #SOIDAYMAT#
      , MACH = #MACH#
      , CANNANG = #CANNANG#
      , CHIEUCAO = #CHIEUCAO#
      , BMI = #BMI#
      , NHIPTHO = #NHIPTHO#
      , NHIETDO = #NHIETDO#
      , GHICHU = #GHICHU#
      , KHOADULIEU = #KHOADULIEU#
      , NGUOIKHOA_ID = #NGUOIKHOA_ID#
      , NGAYKHOA = #NGAYKHOA#
      , THOIGIANKHOA = #THOIGIANKHOA#
      , NGAYCAPNHAT = #NGAYCAPNHAT#
      , NGUOICAPNHAT_ID = #NGUOICAPNHAT_ID#
      , KHAMBENH_SINHHIEU_ID = #KHAMBENH_SINHHIEU_ID#
      where
      KHAMBENH_ID = #KHAMBENH_ID#
    </update>

    <statement id="DAO00014_Delete" parameterClass="System.String" resultClass="System.Int32">
      delete from TT_NGOAITRU_KHAMBENH
      where
      KHAMBENH_ID = '$KHAMBENH_ID$'
    </statement>

    <statement id="DAO00014_GetSLDuocByKhamBenhID" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select SOLUONG
      from TT_NGOAITRU_TOATHUOC
      where KHAMBENH_ID  = '$KHAMBENH_ID$'
      and DUOC_ID  = '$DUOC_ID$'
    </statement>

    <statement id="DAO00014_IsExistThuoc" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select *
      from TT_NGOAITRU_TOATHUOC
      where KHAMBENH_TOATHUOC_ID  = '$KHAMBENH_TOATHUOC_ID$'
      and DUOC_ID  = '$DUOC_ID$'
    </statement>
    <statement id="DAO00014_ListThuocTrongToa" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select *
      from TT_NGOAITRU_TOATHUOC
      where KHAMBENH_TOATHUOC_ID  = '$KHAMBENH_TOATHUOC_ID$'
    </statement>
    <statement id="DAO00014_GetKhamBenhNotInDichVuID" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select KHAMBENH_ID
      from TT_NGOAITRU_KHAMBENH
      where TIEPNHAN_ID  = '$TIEPNHAN_ID$'
      and DICHVU_ID  != '$DICHVU_ID$'
    </statement>

    <statement id="DAO00014_Add_TOATHUOC" parameterClass="HashTable" resultClass="System.Int64">
      insert into TT_NGOAITRU_TOATHUOC (
      KHAMBENH_TOATHUOC_ID
      , SOTHUTUTOA
      , KHAMBENH_ID
      , TIEPNHAN_ID
      , DUOC_ID
      , SOLUONG
      , SONGAY
      , SOLANTRENNGAY
      , SOLUONGTRENLAN
      , SOLUONG_BUOISANG
      , SOLUONG_BUOITRUA
      , SOLUONG_BUOICHIEU
      , SOLUONG_BUOITOI
      , DUONGDUNG_ID
      , CACHDUNG_ID
      , HUYTOATHUOC
      , IDX
      , NGUONHANG_ID
      , PHATSINHHOADON
      , GHICHU
      , TRANGTHAI
      , BENHVIEN_ID
      , NGAYTAO
      , NGUOITAO_ID
      , NGAYCAPNHAT
      , NGUOICAPNHAT_ID
      ) values (
      #KHAMBENH_TOATHUOC_ID#
      , #SOTHUTUTOA#
      , #KHAMBENH_ID#
      , #TIEPNHAN_ID#
      , #DUOC_ID#
      , #SOLUONG#
      , #SONGAY#
      , #SOLANTRENNGAY#
      , #SOLUONGTRENLAN#
      , #SOLUONG_BUOISANG#
      , #SOLUONG_BUOITRUA#
      , #SOLUONG_BUOICHIEU#
      , #SOLUONG_BUOITOI#
      , #DUONGDUNG_ID#
      , #CACHDUNG_ID#
      , #HUYTOATHUOC#
      , #STT#
      , #NGUONHANG_ID#
      , #PHATSINHHOADON#
      , #GHICHU#
      , #TRANGTHAI#
      , #BENHVIEN_ID#
      , #NGAYTAO#
      , #NGUOITAO_ID#
      , #NGAYCAPNHAT#
      , #NGUOICAPNHAT_ID#
      )
      SELECT SCOPE_IDENTITY()
      <!--<selectKey resultClass="System.Int64" type="post" >
        SELECT @@IDENTITY as value
      </selectKey>-->
    </statement>

    <statement id="DAO00014_DeleteThuocInfo" parameterClass="System.Collections.IDictionary" resultClass="System.Int32">
      delete from TT_NGOAITRU_TOATHUOC
      where KHAMBENH_TOATHUOC_ID = '$KHAMBENH_TOATHUOC_ID$'
      and DUOC_ID = '$DUOC_ID$'
    </statement>

    <statement id="DAO00014_GetListDeleteThuocInfoNotInList" parameterClass="HashTable" resultClass="DataObject">
      select nttt.TOATHUOC_ID, nttt.DUOC_ID, nttt.SOLUONG, nttt.NGUONHANG_ID, tt.PHAMVI_ID
      from TT_NGOAITRU_TOATHUOC as nttt
      left join TT_NGOAITRU_KHAMBENH_TOATHUOC tt on tt.KHAMBENH_TOATHUOC_ID = nttt.KHAMBENH_TOATHUOC_ID
      where nttt.KHAMBENH_ID = #KHAMBENH_ID#
      <dynamic prepend=" and nttt.KHAMBENH_TOATHUOC_ID in ">
        <iterate open="(" close=")" conjunction=",  " property="LSTTOATHUOC_ID">#LSTTOATHUOC_ID[]#</iterate>
      </dynamic>
      and nttt.BENHVIEN_ID = #BENHVIEN_ID#
    </statement>
    <statement id="DAO00014_DeleteThuocInfoNotInList" parameterClass="HashTable" resultClass="DataObject">
      delete from TT_NGOAITRU_TOATHUOC
      where KHAMBENH_ID = #KHAMBENH_ID#
      <dynamic prepend=" and KHAMBENH_TOATHUOC_ID in ">
        <iterate open="(" close=")" conjunction=",  " property="LSTTOATHUOC_ID">#LSTTOATHUOC_ID[]#</iterate>
      </dynamic>
      and BENHVIEN_ID = #BENHVIEN_ID#
    </statement>

    <statement id="DAO00014_DeleteBookingInfoNotInList" parameterClass="HashTable" resultClass="DataObject">
      delete from TT_DUOC_TONKHO_BOOK_NGOAITRU
      where BENHVIEN_ID = #BENHVIEN_ID#
      and REF_TABLE = 'TT_NGOAITRU_TOATHUOC'
      <dynamic prepend=" and REF_ID in ">
        <iterate open="(" close=")" conjunction=",  " property="LSTTOATHUOC_ID">#LSTTOATHUOC_ID[]#</iterate>
      </dynamic>
    </statement>

    <statement id="DAO00014_GetListDeleteDSThuoc" parameterClass="HashTable" resultClass="DataObject">
      select TOATHUOC_ID as TOATHUOC_ID, DUOC_ID, SOLUONG, NGUONHANG_ID
      from TT_NGOAITRU_TOATHUOC
      where KHAMBENH_ID = #KHAMBENH_ID#
      and KHAMBENH_TOATHUOC_ID = #KHAMBENH_TOATHUOC_ID#
      <dynamic prepend=" and DUOC_ID not in ">
        <iterate open="(" close=")" conjunction=",  " property="LSTDUOC_ID">#LSTDUOC_ID[]#</iterate>;
      </dynamic>
    </statement>
    <statement id="DAO00014_DeleteDSThuoc" parameterClass="HashTable" resultClass="DataObject">
      delete from TT_NGOAITRU_TOATHUOC
      where KHAMBENH_ID = #KHAMBENH_ID#
      and KHAMBENH_TOATHUOC_ID = #KHAMBENH_TOATHUOC_ID#
      <dynamic prepend=" and DUOC_ID not in ">
        <iterate open="(" close=")" conjunction=",  " property="LSTDUOC_ID">#LSTDUOC_ID[]#</iterate>
      </dynamic>
    </statement>

    <statement id="DAO00014_GetListDeleteDSBooking" parameterClass="HashTable" resultClass="DataObject">
      select * from TT_DUOC_TONKHO_BOOK_NGOAITRU
      where REF_TABLE = #REF_TABLE#
      <dynamic prepend=" and REF_ID in ">
        <iterate open="(" close=")" conjunction=",  " property="LSTTOATHUOC_ID">#LSTTOATHUOC_ID[]#</iterate>
      </dynamic>
      and BENHVIEN_ID = #BENHVIEN_ID#
    </statement>
    <statement id="DAO00014_DeleteDSBooking" parameterClass="HashTable" resultClass="DataObject">
      delete from TT_DUOC_TONKHO_BOOK_NGOAITRU
      where REF_TABLE = #REF_TABLE#
      <dynamic prepend=" and REF_ID in ">
        <iterate open="(" close=")" conjunction=",  " property="LSTTOATHUOC_ID">#LSTTOATHUOC_ID[]#</iterate>
      </dynamic>
      and BENHVIEN_ID = #BENHVIEN_ID#
    </statement>

    <statement id="DAO00014_DeleteThuocInfoDifDuocID" parameterClass="HashTable">
      delete from TT_NGOAITRU_TOATHUOC
      where KHAMBENH_ID = #KHAMBENH_ID#
      and DUOC_ID != #DUOC_ID#
    </statement>

    <statement id="DAO00014_DeleteAllThuocInfo" parameterClass="HashTable">
      delete from TT_NGOAITRU_TOATHUOC
      where KHAMBENH_ID = #KHAMBENH_ID#
    </statement>

    <delete id="DAO00014_DeleteToaThuocInfoNotInList" parameterClass="HashTable">
      delete from TT_NGOAITRU_KHAMBENH_TOATHUOC
      where KHAMBENH_ID = #KHAMBENH_ID#
      <dynamic prepend=" and KHAMBENH_TOATHUOC_ID in ">
        <iterate open="(" close=")" conjunction=",  " property="LSTTOATHUOC_ID">#LSTTOATHUOC_ID[]#</iterate>
      </dynamic>
    </delete>

    <delete id="DAO00014_DeleteToaThuocInfoDifToaID" parameterClass="HashTable">
      delete from TT_NGOAITRU_KHAMBENH_TOATHUOC
      where KHAMBENH_ID = #KHAMBENH_ID#
      and KHAMBENH_TOATHUOC_ID != #KHAMBENH_TOATHUOC_ID#
    </delete>

    <delete id="DAO00014_DeleteAllToaThuocInfo" parameterClass="HashTable">
      delete from TT_NGOAITRU_KHAMBENH_TOATHUOC
      where KHAMBENH_ID = #KHAMBENH_ID#
    </delete>

    <statement id="DAO00014_GetSLDuocDaLuu" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select sum(SOLUONG) as SOLUONG
      from TT_NGOAITRU_TOATHUOC
      where KHAMBENH_ID  = '$KHAMBENH_ID$'
      and DUOC_ID  = '$DUOC_ID$'
    </statement>

    <statement id="DAO00014_GetListThuocBHYT" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select tt.*, vp.DONGIA_DOANHTHU, vp.THANHTIEN_DOANHTHU, vp.BHYT_DONGIA, vp.BHYT_THANHTIEN, vp.BENHNHAN_PHAITHANHTOAN,
      vp.GIATRI_BENHNHAN_DATHANHTOAN, vp.LOAIGIA_ID, vp.DATHANHTOAN, vp.HUY as DAHUYHOADON,
      dc.TENDUOCDAYDU, dc.DONVITINH, ld.MALOAIDUOC, dc.BHYT DUOC_BHYT, ld.LOAIVATTU_ID, dc.TAMNGUNG
      from TT_NGOAITRU_TOATHUOC tt
      left join TM_DUOC dc on tt.DUOC_ID = dc.DUOC_ID
      left join TM_LOAIDUOC ld on dc.LOAIDUOC_ID = ld.LOAIDUOC_ID
      left join TT_VIENPHI vp on tt.DUOC_ID = vp.DUOC_ID and tt.TOATHUOC_ID = vp.REF_ID
      where KHAMBENH_TOATHUOC_ID = '$KHAMBENH_TOATHUOC_ID$'
      <!--and vp.REF_TABLE = 'TT_NGOAITRU_TOATHUOC'-->
      order by tt.IDX
    </statement>
    <statement id="DAO00014_GetListThuocVP" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select tt.*, dc.TENDUOCDAYDU, dc.DONVITINH, ld.MALOAIDUOC, dc.BHYT DUOC_BHYT, ld.LOAIVATTU_ID, dc.TAMNGUNG
      from TT_NGOAITRU_TOATHUOC tt
      left join TM_DUOC dc on tt.DUOC_ID = dc.DUOC_ID
      left join TM_LOAIDUOC ld on dc.LOAIDUOC_ID = ld.LOAIDUOC_ID
      where tt.KHAMBENH_TOATHUOC_ID = '$KHAMBENH_TOATHUOC_ID$'
      order by tt.IDX
    </statement>
    <statement id="DAO00014_GetListThuoc" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select tt.*, vp.DONGIA_DOANHTHU, (tt.SOLUONG * vp.DONGIA_DOANHTHU) as THANHTIEN_DOANHTHU
      from TT_NGOAITRU_TOATHUOC tt
      left join(
      select B.DONGIAVONVAT as DONGIA_KHAC,
      ROUND(B.DONGIABAN + B.DONGIABAN*tmduoc.TYLE_VAT/100, 0) as DONGIA_DOANHTHU,
      B.DONGIAVON, tmduoc.TYLE_VAT, dg.DONGIA as DONGIATHAU, tmduoc.BHYT, A.DUOC_ID
      from TT_DUOC_CHUNGTU_SOLONHAP A
      inner join TT_DUOC_SOLONHAP_GIABAN B on A.SOLONHAP_ID = B.SOLONHAP_ID
      inner join TM_DUOC tmduoc on A.DUOC_ID = tmduoc.DUOC_ID
      left JOIN TM_DUOC_DONGIA dg on dg.DUOC_ID = A.DUOC_ID
      left JOIN TM_BANGGIA bg on (bg.BANGGIA_ID = dg.BANGGIA_ID)
      where exists (select DUOC_ID from TT_NGOAITRU_TOATHUOC where KHAMBENH_TOATHUOC_ID = '$KHAMBENH_TOATHUOC_ID$' and A.DUOC_ID = DUOC_ID)
      ) vp on vp.DUOC_ID = tt.DUOC_ID
      where tt.KHAMBENH_TOATHUOC_ID = '$KHAMBENH_TOATHUOC_ID$'
      order by tt.IDX
    </statement>

    <update id="DAO00014_UpdateThuocInfo" parameterClass="HashTable">
      update TT_NGOAITRU_TOATHUOC set
      <!--KHAMBENH_TOATHUOC_ID = #KHAMBENH_TOATHUOC_ID#
      , SOTHUTUTOA = #SOTHUTUTOA#
      , KHAMBENH_ID = #KHAMBENH_ID#-->
      <!--,-->
      SOLUONG = #SOLUONG#
      , SONGAY = #SONGAY#
      , SOLANTRENNGAY = #SOLANTRENNGAY#
      , SOLUONGTRENLAN = #SOLUONGTRENLAN#
      , SOLUONG_BUOISANG = #SOLUONG_BUOISANG#
      , SOLUONG_BUOITRUA = #SOLUONG_BUOITRUA#
      , SOLUONG_BUOICHIEU = #SOLUONG_BUOICHIEU#
      , SOLUONG_BUOITOI = #SOLUONG_BUOITOI#
      , DUONGDUNG_ID = #DUONGDUNG_ID#
      , CACHDUNG_ID = #CACHDUNG_ID#
      , HUYTOATHUOC = #HUYTOATHUOC#
      , IDX = #STT#
      , NGUONHANG_ID = #NGUONHANG_ID#
      <!--, PHATSINHHOADON = #PHATSINHHOADON#-->
      , GHICHU = #GHICHU#
      <!--, TRANGTHAI = #TRANGTHAI#
      , BENHVIEN_ID = #BENHVIEN_ID#
      , NGAYTAO = #NGAYTAO#
      , NGUOITAO_ID = #NGUOITAO_ID#-->
      , NGAYCAPNHAT = #NGAYCAPNHAT#
      , NGUOICAPNHAT_ID = #NGUOICAPNHAT_ID#
      where
      KHAMBENH_TOATHUOC_ID = #KHAMBENH_TOATHUOC_ID#
      and DUOC_ID = #DUOC_ID#
      <!--TOATHUOC_ID = #TOATHUOC_ID#-->
    </update>

    <statement id="DAO00014_DeleteToaThuocInfo" parameterClass="System.Collections.IDictionary" resultClass="System.Int32">
      delete from TT_NGOAITRU_KHAMBENH_TOATHUOC
      where KHAMBENH_TOATHUOC_ID = '$KHAMBENH_TOATHUOC_ID$'
    </statement>

    <statement id="DAO00014_GetListToaThuoc" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select A.*
      from TT_NGOAITRU_KHAMBENH_TOATHUOC A
      where A.KHAMBENH_ID = '$KHAMBENH_ID$'
    </statement>

    <update id="DAO00014_UpdateKhoaNhapVien" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      update  TT_NGOAITRU_KHAMBENH
      set NHAPKHOA_ID = #NHAPKHOA_ID#
      where KHAMBENH_ID = '$KHAMBENH_ID$'
    </update>

    <statement id="DAO00014_Add_KHAMBENH_TOATHUOC" parameterClass="HashTable" resultClass="System.Int64">
      insert into TT_NGOAITRU_KHAMBENH_TOATHUOC (
      SOTHUTUTOA
      , LOAITOATHUOC
      , KHAMBENH_ID
      , TIEPNHAN_ID
      , BACSI_ID
      , NGAYTOATHUOC
      , THOIGIANTOATHUOC
      , HUYTOATHUOC
      , GHICHU
      , CHUNGTUPHATTHUOC_ID
      , TRANGTHAI
      , KHOXUAT_ID
      , DUYET
      , NGAYDUYET
      , THOIGIANDUYET
      , NGUOIDUYET_ID
      , THOIGIANTAO
      , BENHVIEN_ID
      , NGAYTAO
      , NGUOITAO_ID
      , NGAYCAPNHAT
      , NGUOICAPNHAT_ID
      <isNotEmpty prepend="," property="PHAMVI_ID">
        PHAMVI_ID
      </isNotEmpty>
      <isNotEmpty prepend="," property="MATOATHUOC">
        MATOATHUOC
      </isNotEmpty>
      <isNotEmpty prepend="," property="MATOAMAU">
        MATOAMAU
      </isNotEmpty>
      ) values (
      #SOTHUTUTOA#
      , #LOAITOATHUOC#
      , #KHAMBENH_ID#
      , #TIEPNHAN_ID#
      , #BACSI_ID#
      , #NGAYTOATHUOC#
      , #THOIGIANTOATHUOC#
      , #HUYTOATHUOC#
      , #GHICHU#
      , #CHUNGTUPHATTHUOC_ID#
      , #TRANGTHAI#
      , #KHOXUAT_ID#
      , #DUYET#
      , #NGAYDUYET#
      , #THOIGIANDUYET#
      , #NGUOIDUYET_ID#
      , #THOIGIANTAO#
      , #BENHVIEN_ID#
      , #NGAYTAO#
      , #NGUOITAO_ID#
      , #NGAYCAPNHAT#
      , #NGUOICAPNHAT_ID#
      <isNotEmpty prepend="," property="PHAMVI_ID">
        #PHAMVI_ID#
      </isNotEmpty>
      <isNotEmpty prepend="," property="MATOATHUOC">
        #MATOATHUOC#
      </isNotEmpty>
      <isNotEmpty prepend="," property="MATOAMAU">
        #MATOAMAU#
      </isNotEmpty>
      )
      SELECT SCOPE_IDENTITY()
      <!--<selectKey resultClass="System.Int64" type="post" >
        SELECT @@IDENTITY as value
      </selectKey>-->
    </statement>

    <update id="DAO00014_UpdateToaThuocInfo" parameterClass="HashTable">
      update TT_NGOAITRU_KHAMBENH_TOATHUOC set
      <!--SOTHUTUTOA = #SOTHUTUTOA#-->
      <!--,-->
      LOAITOATHUOC = #LOAITOATHUOC#
      , KHAMBENH_ID = #KHAMBENH_ID#
      , BACSI_ID = #BACSI_ID#
      , NGAYTOATHUOC = #NGAYTOATHUOC#
      , THOIGIANTOATHUOC = #THOIGIANTOATHUOC#
      , HUYTOATHUOC = #HUYTOATHUOC#
      , GHICHU = #GHICHU#
      <!--, CHUNGTUPHATTHUOC_ID = #CHUNGTUPHATTHUOC_ID#-->
      , KHOXUAT_ID = #KHOXUAT_ID#
      <!--, DUYET = #DUYET#
      , NGAYDUYET = #NGAYDUYET#
      , THOIGIANDUYET = #THOIGIANDUYET#
      , NGUOIDUYET_ID = #NGUOIDUYET_ID#
      , TRANGTHAI = #TRANGTHAI#-->
      , BENHVIEN_ID = #BENHVIEN_ID#
      , NGAYCAPNHAT = #NGAYCAPNHAT#
      , NGUOICAPNHAT_ID = #NGUOICAPNHAT_ID#
      <isNotEmpty prepend="," property="PHAMVI_ID">
        PHAMVI_ID = #PHAMVI_ID#
      </isNotEmpty>
      <isNotEmpty prepend="," property="MATOATHUOC">
        MATOATHUOC = #MATOATHUOC#
      </isNotEmpty>
      where
      KHAMBENH_TOATHUOC_ID = #KHAMBENH_TOATHUOC_ID#
    </update>

    <statement id="DAO00014_CheckExistHenTaiKHam" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select KHAMBENH_HENTAIKHAM
      from TT_NGOAITRU_KHAMBENH_HENTK
      where KHAMBENH_ID  = '$KHAMBENH_ID$'
    </statement>

    <statement id="DAO00014_GetHenTaiKhamInfo" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select *
      from TT_NGOAITRU_KHAMBENH_HENTK
      where KHAMBENH_ID  = '$KHAMBENH_ID$'
    </statement>

    <update id="DAO00014_UpdateHenTaiKhamInfo" parameterClass="HashTable">
      update TT_NGOAITRU_KHAMBENH_HENTK set
      KHAMBENH_ID = #KHAMBENH_ID#
      , BENHNHAN_ID = #BENHNHAN_ID#
      , NGAYTAIKHAM = #NGAYTAIKHAM#
      , THOIGIANTAIKHAM = #THOIGIANTAIKHAM#
      , LOAILICHHEN = #LOAILICHHEN#
      , NGAYCAPNHAT = #NGAYCAPNHAT#
      , NGUOICAPNHAT_ID = #NGUOICAPNHAT_ID#
      where
      KHAMBENH_ID = '$KHAMBENH_ID$'
      and NGUOITAO_ID = '$NGUOITAO_ID$'
      and BENHVIEN_ID = '$BENHVIEN_ID$'
    </update>

    <statement id="DAO00014_DeleteHenTaiKhamInfo" parameterClass="System.String" resultClass="System.Int32">
      delete from TT_NGOAITRU_KHAMBENH_HENTK
      where
      KHAMBENH_ID = #KHAMBENH_ID#
    </statement>

    <statement id="DAO00014_Add_KhamBenh_HenTaiKham" parameterClass="HashTable" resultClass="System.Int64">
      insert into TT_NGOAITRU_KHAMBENH_HENTK (
      KHAMBENH_ID
      , BENHNHAN_ID
      , NGAYTAIKHAM
      , THOIGIANTAIKHAM
      , TIEPNHAN_ID
      , BENHVIEN_ID
      , NGAYTAO
      , NGUOITAO_ID
      , LOAILICHHEN
      , DATIEPNHAN
      , DICHVU_ID
      , NOITHUCHIEN_ID
      ) values (
      #KHAMBENH_ID#
      , #BENHNHAN_ID#
      , #NGAYTAIKHAM#
      , #THOIGIANTAIKHAM#
      , #TIEPNHAN_ID#
      , #BENHVIEN_ID#
      , #NGAYTAO#
      , #NGUOITAO_ID#
      , #LOAILICHHEN#
      , #DATIEPNHAN#
      , #DICHVU_ID#
      , #NOITHUCHIEN_ID#
      )
      SELECT SCOPE_IDENTITY()
      <!--<selectKey resultClass="System.Int64" type="post" >
        SELECT @@IDENTITY as value
      </selectKey>-->
    </statement>

    <statement id="DAO00014_CheckExistNhapVien" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select NHAPVIEN_ID
      from TT_NOITRU_NHAPVIEN
      where TIEPNHAN_ID  = '$TIEPNHAN_ID$'
      and TRANGTHAI != 'CHOXACNHAN'
    </statement>

    <statement id="DAO00014_GetTTNhapVien" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select *
      from TT_NOITRU_NHAPVIEN
      where TIEPNHAN_ID  = '$TIEPNHAN_ID$'
      <!--and BENHNHAN_ID  = '$BENHNHAN_ID$'-->
    </statement>
    <statement id="DAO00014_GetTTDVYeucauOPD" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select A.KHAMBENH_NGOAITRU_ID, B.KHAMBENH_ID
      from TT_DVYEUCAU A
      left join TT_NGOAITRU_KHAMBENH B on A.KHAMBENH_NGOAITRU_ID = B.KHAMBENH_ID
      where A.DVYEUCAU_ID = '$DVYEUCAU_ID$' and A.TIEPNHAN_ID = #TIEPNHAN_ID#
      <!--and BENHNHAN_ID  = '$BENHNHAN_ID$'-->
    </statement>
    <statement id="DAO00014_DeleteTTNhapVien" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      delete TT_NOITRU_NHAPVIEN
      where TIEPNHAN_ID  = '$TIEPNHAN_ID$'
    </statement>

    <statement id="DAO00014_CheckExistCapCuu" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select THONGTINCAPCUU_ID
      from TT_TIEPNHAN_THONGTINCAPCUU
      where TIEPNHAN_ID  = '$TIEPNHAN_ID$' and BENHVIEN_ID = '$BENHVIEN_ID$'
    </statement>

    <statement id="DAO00014_CheckExistChuyenVien" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select CHUYENVIEN_ID
      from TT_CHUYENVIEN
      where TIEPNHAN_ID  = '$TIEPNHAN_ID$'
    </statement>

    <insert id="DAO00014_Add_Booking" parameterClass="System.Collections.IDictionary" resultClass="System.Int64">
      insert into TT_DUOC_TONKHO_BOOK_NGOAITRU (
      REF_TABLE
      , REF_ID
      , KHODUOC_ID
      , NGUONHANG_ID
      , DUOC_ID
      , BENHVIEN_ID
      , SOLUONG
      , NGAYHIEULUC
      , NGUOITAO_ID
      , NGAYTAO
      , NGUOICAPNHAT_ID
      , NGAYCAPNHAT
      <isNotEmpty prepend="," property="PHAMVI_ID">
        PHAMVI_ID
      </isNotEmpty>
      ) values (
      #REF_TABLE#
      , #TOATHUOC_ID#
      , #KHODUOC_ID#
      , #NGUONHANG_ID#
      , #DUOC_ID#
      , #BENHVIEN_ID#
      , #SOLUONG#
      , #NGAYHIEULUC#
      , #NGUOITAO_ID#
      , #NGAYTAO#
      , #NGUOICAPNHAT_ID#
      , #NGAYCAPNHAT#
      <isNotEmpty prepend="," property="PHAMVI_ID">
        #PHAMVI_ID#
      </isNotEmpty>
      )
    </insert>

    <update id="DAO00014_Update_Booking" parameterClass="System.Collections.IDictionary" resultClass="System.Int64">
      update TT_DUOC_TONKHO_BOOK_NGOAITRU set
      KHODUOC_ID = #KHODUOC_ID#,
      NGUONHANG_ID = #NGUONHANG_ID#,
      DUOC_ID = #DUOC_ID#,
      SOLUONG = #SOLUONG#,
      NGAYHIEULUC = #NGAYHIEULUC#,
      NGUOICAPNHAT_ID = #NGUOICAPNHAT_ID#,
      NGAYCAPNHAT = #NGAYCAPNHAT#
      <isNotEmpty prepend="," property="PHAMVI_ID">
        PHAMVI_ID = #PHAMVI_ID#
      </isNotEmpty>
      where
      BOOKING_ID = '$BOOKING_ID$'
    </update>

    <delete id="DAO00014_Delete_Booking" parameterClass="System.Collections.IDictionary">
      delete from TT_DUOC_TONKHO_BOOK_NGOAITRU
      where REF_TABLE = #REF_TABLE#
      and REF_ID = #REF_ID#
      and DUOC_ID = #DUOC_ID#
      and BENHVIEN_ID = #BENHVIEN_ID#
      <isNotEmpty prepend="and" property="PHAMVI_ID">
        PHAMVI_ID = #PHAMVI_ID#
      </isNotEmpty>
    </delete>

    <update id="DAO00014_TruPhauThuatBookingDuoc" parameterClass="System.Collections.IDictionary" resultClass="System.Int64">
      delete TT_DUOC_TONKHO_BOOK_NGOAITRU
      where
      DUOC_ID = '$DUOC_ID$'
      and SOLUONG = 0
      and BENHVIEN_ID = '$BENHVIEN_ID$'
      <isNotEmpty prepend="and" property="KHODUOC_ID">
        KHODUOC_ID = #KHODUOC_ID#
      </isNotEmpty>
      <isNotEmpty prepend="and" property="PHAMVI_ID">
        PHAMVI_ID = #PHAMVI_ID#
      </isNotEmpty>

      update TOP (1) TT_DUOC_TONKHO_BOOK_NGOAITRU set
      SOLUONG = SOLUONG - #SOLUONG#
      where
      DUOC_ID = '$DUOC_ID$'
      and SOLUONG >= '$SOLUONG$'
      and BENHVIEN_ID = '$BENHVIEN_ID$'
      <isNotEmpty prepend="and" property="KHODUOC_ID">
        KHODUOC_ID = #KHODUOC_ID#
      </isNotEmpty>
      <isNotEmpty prepend="and" property="PHAMVI_ID">
        PHAMVI_ID = #PHAMVI_ID#
      </isNotEmpty>
    </update>

    <statement id="DAO00014_GetBookingInfo" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select *
      from TT_DUOC_TONKHO_BOOK_NGOAITRU
      where

      <!--KHODUOC_ID  = '$KHODUOC_ID$'
      and-->
      DUOC_ID = '$DUOC_ID$'
      and NGUONHANG_ID = '$NGUONHANG_ID$'
      and REF_ID = '$TOATHUOC_ID$'
      and REF_TABLE = '$REF_TABLE$'
      <isNotEmpty prepend="and" property="KHODUOC_ID">
        KHODUOC_ID = #KHODUOC_ID#
      </isNotEmpty>
      <isNotEmpty prepend="and" property="PHAMVI_ID">
        PHAMVI_ID = #PHAMVI_ID#
      </isNotEmpty>
    </statement>

    <update id="DAO00014_UpdateBookingInfo" parameterClass="System.Collections.IDictionary">
      update TT_DUOC_TONKHO_BOOK_NGOAITRU set
      SOLUONG = #SOLUONG#
      where
      KHAMBENH_TOATHUOC_ID = '$KHAMBENH_TOATHUOC_ID$'
      and DUOC_ID = '$DUOC_ID$'
      and BENHVIEN_ID = '$BENHVIEN_ID$'
      and NGAYHIEULUC = '$NGAYHIEULUC$'
      <isNotEmpty prepend="and" property="KHODUOC_ID">
        KHODUOC_ID = #KHODUOC_ID#
      </isNotEmpty>
      <isNotEmpty prepend="and" property="PHAMVI_ID">
        PHAMVI_ID = #PHAMVI_ID#
      </isNotEmpty>
    </update>

    <insert id="DAO00014_Add_KhamBenh_ICD" parameterClass="System.Collections.IDictionary" resultClass="System.Int64">
      insert into TT_NGOAITRU_KHAMBENH_ICD (
      KHAMBENH_ID
      , ICD_ID
      , IDX
      , BENHVIEN_ID
      ) values (
      #KHAMBENH_ID#
      , #ICD_ID#
      , #IDX#
      , #BENHVIEN_ID#
      )
    </insert>

    <statement id="DAO00014_Delete_KhamBenh_ICD" parameterClass="System.Collections.IDictionary" resultClass="System.Int32">
      delete from TT_NGOAITRU_KHAMBENH_ICD
      where
      KHAMBENH_ID = #KHAMBENH_ID#
      and ICD_ID = #ICD_ID#
    </statement>

    <statement id="DAO00014_GetKhamBenhICDInfo" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select *
      from TT_NGOAITRU_KHAMBENH_ICD
      where KHAMBENH_ID  = '$KHAMBENH_ID$'
    </statement>

    <statement id="DAO00014_GetXacNhanChiPhi" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select KHAMBENH_ID
      from TT_XACNHANCHIPHI
      <dynamic prepend="where">
        <isParameterPresent>
          <isNotEmpty prepend="and" property="KHAMBENH_ID">
            KHAMBENH_ID = '$KHAMBENH_ID$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="TIEPNHAN_ID">
            TIEPNHAN_ID = '$TIEPNHAN_ID$'
          </isNotEmpty>
        </isParameterPresent>
      </dynamic>
    </statement>

    <statement id="DAO00014_GetTTinKhamBenhByBenhNhanID" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select *
      from TT_NGOAITRU_KHAMBENH
      where BENHNHAN_ID  = #BENHNHAN_ID#
      and BENHVIEN_ID = '$BENHVIEN_ID$'
      <isNotEmpty prepend="" property="PHONGBAN_ID">
        and PHONGBAN_ID = #PHONGBAN_ID#
      </isNotEmpty>
      <isNotEmpty prepend="" property="BACSIKHAM_ID">
        and BACSIKHAM_ID = #BACSIKHAM_ID#
      </isNotEmpty>
      <isNotEmpty prepend="" property="TUNGAY">
        and NGAYKHAM &gt;= '$TUNGAY$'
    </isNotEmpty>
      <isNotEmpty prepend="" property="DENNGAY">
        and NGAYKHAM &lt;= '$DENNGAY$'
    </isNotEmpty>
      order by THOIGIANKHAM desc
    </statement>

    <statement id="DAO00014_GetTTinThuocByDSKhamBenhID" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select *
      from TT_NGOAITRU_TOATHUOC
      <dynamic prepend=" where KHAMBENH_ID in ">
        <iterate open="(" close=")" conjunction=",  " property="LSTKHAMBENH_ID">#LSTKHAMBENH_ID[]#</iterate>
      </dynamic>
    </statement>

    <statement id="DAO00014_GetTTinThuocByKhamBenhID" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select t.*, tt.LOAITOATHUOC
      from TT_NGOAITRU_TOATHUOC t left join TT_NGOAITRU_KHAMBENH_TOATHUOC tt
      on t.KHAMBENH_TOATHUOC_ID = tt.KHAMBENH_TOATHUOC_ID
      where t.KHAMBENH_ID = '$KHAMBENH_ID$' and t.HUYTOATHUOC =0
    </statement>

    <statement id="DAO00014_GetTTinToaBHYT" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select * from TT_NGOAITRU_KHAMBENH_TOATHUOC
      where exists (select KHAMBENH_ID
      from TT_NGOAITRU_KHAMBENH
      where BENHNHAN_ID = '$BENHNHAN_ID$'
      and TIEPNHAN_ID = '$TIEPNHAN_ID$'
      and BENHVIEN_ID = '$BENHVIEN_ID$'
      and DICHVU_ID != '$DICHVU_ID$' and TT_NGOAITRU_KHAMBENH_TOATHUOC.KHAMBENH_ID = KHAMBENH_ID)
      and LOAITOATHUOC = '$LOAITOATHUOC$'
    </statement>

    <statement id="DAO00014_GetDSLichHen" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select kb.*<!--, bn.TENBENHNHAN--> from TT_NGOAITRU_KHAMBENH_HENTK kb
      <!--left join TT_BENHNHAN bn
      on kb.BENHNHAN_ID = kb.BENHNHAN_ID-->
      where kb.NGUOITAO_ID = '$NGUOITAO_ID$'
      and convert(date, NGAYTAIKHAM) between convert(date, '$TUNGAY$') and convert(date, '$DENNGAY$')
      and kb.BENHVIEN_ID = '$BENHVIEN_ID$'
    </statement>

    <update id="DAO00014_CapNhatTThaiKhoaCaKham" parameterClass="System.Collections.IDictionary">
      update TT_NGOAITRU_KHAMBENH set
      KHOADULIEU = #KHOADULIEU#,
      NGUOIKHOA_ID = #NGUOIKHOA_ID#,
      THOIGIANKHOA = #THOIGIANKHOA#,
      NGUOICAPNHAT_ID = #NGUOICAPNHAT_ID#,
      NGAYCAPNHAT = #NGAYCAPNHAT#
      where
      KHAMBENH_ID = '$KHAMBENH_ID$'
      and BENHVIEN_ID = '$BENHVIEN_ID$'
    </update>

    <statement id="DAO00014_GetTrangThaiTiepNhan" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select tn.TIEPNHAN_ID, tn.KHOADULIEU, xncp.XACNHANCHIPHI_ID from TT_TIEPNHAN tn
      left join TT_XACNHANCHIPHI xncp
      on tn.TIEPNHAN_ID = xncp.TIEPNHAN_ID
      where tn.TIEPNHAN_ID = '$TIEPNHAN_ID$'
      and tn.BENHVIEN_ID = '$BENHVIEN_ID$'
    </statement>

    <statement id="DAO00014_GetDSDVXetNghiem" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select clskqct.* from TT_CLSKETQUACHITIET clskqct
      left join TT_CLSKETQUA clskq on clskqct.CLSKETQUA_ID = clskq.CLSKETQUA_ID
      left join TM_DICHVU B on clskqct.DICHVU_ID = B.DICHVU_ID
      left join TM_NHOMDICHVU C on C.NHOMDICHVU_ID = B.NHOMDICHVU_ID
      where
      clskq.TIEPNHAN_ID = '$TIEPNHAN_ID$' and clskq.BENHVIEN_ID = '$BENHVIEN_ID$'
      and LEFT(C.MANHOMDICHVU, 2) = '01'
      <!--<isNotEmpty prepend="and" property="LISTDICHVU_ID">
        <iterate open=" clskqct.DICHVU_ID in (" close=")" conjunction=",  " property="LISTDICHVU_ID">#LISTDICHVU_ID[]#</iterate>
      </isNotEmpty>-->
    </statement>
    <statement id="DAO00014_GetLoaiDuoc" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select TT.TOATHUOC_ID, TT.SOTHUTUTOA
      from TT_NGOAITRU_TOATHUOC TT
      inner join TM_DUOC D on D.DUOC_ID = TT.DUOC_ID
      inner join TM_LOAIDUOC LD on LD.LOAIDUOC_ID = D.LOAIDUOC_ID
      where TT.KHAMBENH_TOATHUOC_ID = '$KhamBenh_ToaThuoc_ID$' and (LD.MALOAIDUOC='N02A' or LD.MALOAIDUOC='N05')
    </statement>
    <statement id="DAO00014_GetPatientStatus" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select
      CASE
      when tn.TRANGTHAI = 'HOANTHANH' Then tn.TRANGTHAI
      WHEN xncp.XACNHANCHIPHI_ID is not null THEN 'XACNHANCHIPHI'
      WHEN (tn.KHOADULIEU = '1') THEN 'KHOADULIEU'
      ELSE tn.TRANGTHAI
      END
      as TRANGTHAI
      from TT_TIEPNHAN tn
      left join TT_XACNHANCHIPHI xncp on tn.TIEPNHAN_ID = xncp.TIEPNHAN_ID
      where tn.TIEPNHAN_ID = '$TIEPNHAN_ID$'
      and tn.BENHVIEN_ID = '$BENHVIEN_ID$'
    </statement>
    <statement id="DAO00014_GetPatientStatusXacNhanChiPhi" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select
      tn.TRANGTHAI as TRANGTHAI
      from TT_TIEPNHAN tn
      where tn.TIEPNHAN_ID = '$TIEPNHAN_ID$'
      and tn.BENHVIEN_ID = '$BENHVIEN_ID$'
    </statement>
    <statement id="DAO00014_GetInPatientStatus" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select TRANGTHAI, isnull(KHOACHUYENDEN_ID, KHOAVAO_ID) as KHOAHIENTAI from TT_NOITRU_BENHAN
      where
      TIEPNHAN_ID = '$TIEPNHAN_ID$'
      and BENHVIEN_ID = '$BENHVIEN_ID$'
      <isNotEmpty prepend="and" property="BENHAN_ID">
        BENHAN_ID = '$BENHAN_ID$'
      </isNotEmpty>
    </statement>
    <statement id="DAO00014_GetServiceStatus" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select TRANGTHAI, NGUOIKHOA_ID from TT_DVYEUCAU
      where
      DVYEUCAU_ID = '$DVYEUCAU_ID$'
      and BENHVIEN_ID = '$BENHVIEN_ID$'
    </statement>
    <statement id="DAO00014_GetBenhAnDaXacnhanBHYT" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select * from TT_XACNHANCHIPHI
      where
      BENHAN_ID = '$BENHAN_ID$'
      and BENHVIEN_ID = '$BENHVIEN_ID$'
    </statement>
    <statement id="DAO00014_GetORMServiceStatus" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select dvyc.TRANGTHAI, pt.NGUOIKHOA_ID, pt.NGUOITAO_ID
      from TT_PHAUTHUAT pt
      left join TT_PHAUTHUAT_YEUCAU ptyc on ptyc.PHAUTHUAT_ID = pt.PHAUTHUAT_ID
      left join (select * from TT_DVYEUCAU where exists (select DVYEUCAU_ID from TT_PHAUTHUAT where TT_DVYEUCAU.DVYEUCAU_ID = DVYEUCAU_ID and PHAUTHUAT_ID = '$PHAUTHUAT_ID$')) dvyc
      on ptyc.DVYEUCAU_ID = dvyc.DVYEUCAU_ID
      where pt.PHAUTHUAT_ID = '$PHAUTHUAT_ID$'
    </statement>
    <statement id="DAO00014_GetDuocTamngung" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select * from TM_DUOC where DUOC_ID = '$DUOC_ID$' and TAMNGUNG = '1'
    </statement>
    <statement id="DAO00014_GetListDuocTamngung" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select * from TM_DUOC where DUOC_ID in ($LST_DUOC_ID$) and TAMNGUNG = '1'
    </statement>
    <statement id="DAO00014_GetThongTinBenhNhan" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select * from
      (
      select COUNT(*) OVER() as TOTALROWS,ROW_NUMBER() OVER (ORDER BY a.TIEPNHAN_ID) as ROWNUMBER, * from
      (
      select distinct tn.*, bn.MAYTE, bn.TENBENHNHAN, bn.NGAYSINH, g.DESCRIPTION as GIOITINH, dt.TENDOITUONG
      from TT_TIEPNHAN tn
      inner join TT_BENHNHAN bn on bn.BENHNHAN_ID = tn.BENHNHAN_ID
      left join TT_NGOAITRU_KHAMBENH_SINHHIEU sh on sh.TIEPNHAN_ID = tn.TIEPNHAN_ID
      inner join TM_GENDER g on g.ID = bn.GIOITINH
      inner join TM_DOITUONG dt on dt.DOITUONG_ID = tn.DOITUONG_ID
      where convert(date,tn.NGAYTIEPNHAN) between convert(date,'$DATEFROM$') and convert(date,'$DATETO$')
      and (tn.TRANGTHAI != 'HOANTHANH' and tn.TRANGTHAI != 'NOITRU' and tn.TRANGTHAI != 'CAPCUU')
      <isNotEmpty prepend="and" property="BENHVIEN_ID">
        tn.BENHVIEN_ID = '$BENHVIEN_ID$'
      </isNotEmpty>
      <isNotEmpty prepend="and" property="KEYSEARCH">
        (BN.MAYTE LIKE '%' + #KEYSEARCH# + '%' OR BN.TENBENHNHAN LIKE '%' + #KEYSEARCH# + '%')
      </isNotEmpty>
      <isNotEmpty prepend="" property="TRANGTHAI">
        <isEqual prepend="AND" property="TRANGTHAI" compareValue="02">
          exists (SELECT TIEPNHAN_ID FROM TT_NGOAITRU_KHAMBENH_SINHHIEU WHERE TN.TIEPNHAN_ID = TIEPNHAN_ID and BENHVIEN_ID = '$BENHVIEN_ID$')
        </isEqual>
        <isEqual prepend="AND" property="TRANGTHAI" compareValue="03">
          TN.TIEPNHAN_ID NOT IN (SELECT TIEPNHAN_ID FROM TT_NGOAITRU_KHAMBENH_SINHHIEU WHERE BENHVIEN_ID = '$BENHVIEN_ID$')
        </isEqual>
      </isNotEmpty>
      )a
      )b
      where b.ROWNUMBER between '$FROMROW$' AND '$TOROW$'
      order by b.TIEPNHAN_ID
    </statement>
    <statement id="DAO00014_GetTrangThaiSinhHieu" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select DICTIONARY_ID, DICTIONARY_CODE, DICTIONARY_NAME
      from LST_DICTIONARY
      where DICTIONARY_TYPE_CODE = 'TrangThaiSinhHieu'
      <isNotEmpty prepend="and" property="BENHVIEN_ID">
        BENHVIEN_ID = '$BENHVIEN_ID$'
      </isNotEmpty>
    </statement>
    <statement id="DAO00014_Add_JsonKhambenhToathuoc" parameterClass="System.String" resultClass="System.Int32">
      declare @jsonVienPhi nvarchar(max);
      set @jsonVienPhi = N'{
      "DATA": $JSON_DATA$
      }';

      declare @TOATHUOC_ID int;
      declare @KHAMBENH_TOATHUOC_ID int;
      declare @LOAITOA_NGOAITRU varchar(10);
      declare @SOTHUTUTOA varchar(10);
      declare @KHAMBENH_ID int;
      declare @TIEPNHAN_ID int;
      declare @BENHNHAN_ID int;
      declare @DUOC_ID int;
      declare @SOLUONG numeric(25, 4);
      declare @SONGAY numeric(25, 4);
      declare @SOLANTRENNGAY numeric(25, 4);
      declare @SOLUONGTRENLAN numeric(25, 4);
      declare @SOLUONG_BUOISANG numeric(25, 4);
      declare @SOLUONG_BUOITRUA numeric(25, 4);
      declare @SOLUONG_BUOICHIEU numeric(25, 4);
      declare @SOLUONG_BUOITOI numeric(25, 4);
      declare @DUONGDUNG_ID int;
      declare @CACHDUNG_ID int;
      declare @IDX int;
      declare @CHUYENKHOA_ID int;
      declare @PHONGBANRATOA_ID int;
      declare @NGUONHANG_ID int;
      declare @PHATSINHHOADON char(1);
      declare @GHICHU nvarchar(2000);
      declare @TRANGTHAI varchar(20);
      declare @HUYTOATHUOC char(1);
      declare @BENHVIEN_ID varchar(10);
      declare @NGAYTAO datetime;
      declare @NGUOITAO_ID int;
      declare @NGAYCAPNHAT datetime;
      declare @NGUOICAPNHAT_ID int;
      declare @PHAMVI_ID int;
      declare @NGUONDUOC_ID int;
      declare @KHOPHAT_ID int;

      declare @DONGIA_DOANHTHU numeric(25, 4);
      declare @THANHTIEN_DOANHTHU numeric(25, 4);
      declare @BHYT_DONGIA numeric(25, 4);
      declare @BHYT_THANHTIEN numeric(25, 4);
      declare @DOITUONG_HUONG_ID numeric(25, 4);
      declare @SOBHYT_HUONG_ID numeric(25, 4);

      declare @TOAMUANGOAI_DANHMUC int = 0;
      select @TOAMUANGOAI_DANHMUC = isnull(VALUE,0) from TM_SYS_APPSETTINGS where CODE = 'OPD_TOAMUANGOAI_DUNGDANHMUC_DUOC'
      
      declare @TOAMUANGOAI_KHONGBOOK int = 0;
      select @TOAMUANGOAI_KHONGBOOK = isnull(VALUE,0) from TM_SYS_APPSETTINGS where CODE = 'OPD_TOAMUANGOAI_KHONG_BOOKING_DUOC'

      declare @iTotal int = #TOTAL_RECORD#;
      declare @icnt int = 0;
      WHILE @iTotal > @icnt
      BEGIN
      declare @dyn_sql nvarchar(1000) = 'select @data = json_query(@json_dyn, ''' + CHAR(36) +'.DATA[' + cast(@icnt as varchar(10)) + ']'');'
      declare @jsondatamax nvarchar(max);

      exec sp_executesql @dyn_sql
      , N'@json_dyn nvarchar(max), @data nvarchar(max) OUTPUT'
      , @json_dyn = @jsonVienPhi
      , @data = @jsondatamax OUTPUT

      <!--lay data tu json-->
      select
      @KHAMBENH_TOATHUOC_ID =  JSON_VALUE(@jsondatamax, '' + CHAR(36) +'.KHAMBENH_TOATHUOC_ID'),
      @SOTHUTUTOA =  JSON_VALUE(@jsondatamax, '' + CHAR(36) +'.SOTHUTUTOA'),
      @LOAITOA_NGOAITRU =  JSON_VALUE(@jsondatamax, '' + CHAR(36) +'.LOAITOA_NGOAITRU'),
      @KHAMBENH_ID =  JSON_VALUE(@jsondatamax, '' + CHAR(36) +'.KHAMBENH_ID'),
      @TIEPNHAN_ID =  JSON_VALUE(@jsondatamax, '' + CHAR(36) +'.TIEPNHAN_ID'),
      @BENHNHAN_ID =  JSON_VALUE(@jsondatamax, '' + CHAR(36) +'.BENHNHAN_ID'),
      @NGUONDUOC_ID =  JSON_VALUE(@jsondatamax, '' + CHAR(36) +'.NGUONDUOC_ID'),
      @DUOC_ID =  JSON_VALUE(@jsondatamax, '' + CHAR(36) +'.DUOC_ID'),
      @SOLUONG =  JSON_VALUE(@jsondatamax, '' + CHAR(36) +'.SOLUONG'),
      @SONGAY =  JSON_VALUE(@jsondatamax, '' + CHAR(36) +'.SONGAY'),
      @SOLANTRENNGAY =  JSON_VALUE(@jsondatamax, '' + CHAR(36) +'.SOLANTRENNGAY'),
      @SOLUONGTRENLAN =  JSON_VALUE(@jsondatamax, '' + CHAR(36) +'.SOLUONGTRENLAN'),
      @SOLUONG_BUOISANG =  JSON_VALUE(@jsondatamax, '' + CHAR(36) +'.SOLUONG_BUOISANG'),
      @SOLUONG_BUOITRUA =  JSON_VALUE(@jsondatamax, '' + CHAR(36) +'.SOLUONG_BUOITRUA'),
      @SOLUONG_BUOICHIEU =  JSON_VALUE(@jsondatamax, '' + CHAR(36) +'.SOLUONG_BUOICHIEU'),
      @SOLUONG_BUOITOI =  JSON_VALUE(@jsondatamax, '' + CHAR(36) +'.SOLUONG_BUOITOI'),
      @DUONGDUNG_ID =  JSON_VALUE(@jsondatamax, '' + CHAR(36) +'.DUONGDUNG_ID'),
      @CACHDUNG_ID =  JSON_VALUE(@jsondatamax, '' + CHAR(36) +'.CACHDUNG_ID'),
      @KHOPHAT_ID =  JSON_VALUE(@jsondatamax, '' + CHAR(36) +'.KHOPHAT_ID'),
      @PHONGBANRATOA_ID =  JSON_VALUE(@jsondatamax, '' + CHAR(36) +'.PHONGBANRATOA_ID'),
      @GHICHU =  JSON_VALUE(@jsondatamax, '' + CHAR(36) +'.GHICHU'),
      @BENHVIEN_ID =  JSON_VALUE(@jsondatamax, '' + CHAR(36) +'.BENHVIEN_ID'),
      @NGAYTAO =  JSON_VALUE(@jsondatamax, '' + CHAR(36) +'.NGAYTAO'),
      @NGUOITAO_ID =  JSON_VALUE(@jsondatamax, '' + CHAR(36) +'.NGUOITAO_ID'),
      @NGAYCAPNHAT =  JSON_VALUE(@jsondatamax, '' + CHAR(36) +'.NGAYCAPNHAT'),
      @NGUOICAPNHAT_ID =  JSON_VALUE(@jsondatamax, '' + CHAR(36) +'.NGUOICAPNHAT_ID'),
      @PHAMVI_ID =  JSON_VALUE(@jsondatamax, '' + CHAR(36) +'.PHAMVI_ID'),
      @DOITUONG_HUONG_ID =  JSON_VALUE(@jsondatamax, '' + CHAR(36) +'.DOITUONG_HUONG_ID'),
      @SOBHYT_HUONG_ID =  JSON_VALUE(@jsondatamax, '' + CHAR(36) +'.SOBHYT_HUONG_ID'),
      @IDX =  JSON_VALUE(@jsondatamax, '' + CHAR(36) +'.IDX'),

      @DONGIA_DOANHTHU =  JSON_VALUE(@jsondatamax, '' + CHAR(36) +'.DONGIA_DOANHTHU'),
      @THANHTIEN_DOANHTHU =  JSON_VALUE(@jsondatamax, '' + CHAR(36) +'.THANHTIEN_DOANHTHU'),
      @BHYT_DONGIA =  JSON_VALUE(@jsondatamax, '' + CHAR(36) +'.BHYT_DONGIA'),
      @BHYT_THANHTIEN =  JSON_VALUE(@jsondatamax, '' + CHAR(36) +'.BHYT_THANHTIEN')

      <!--insert toa thuoc ngoai tru-->
      INSERT INTO [TT_NGOAITRU_TOATHUOC]
      ([KHAMBENH_TOATHUOC_ID],[SOTHUTUTOA] ,[KHAMBENH_ID] ,[TIEPNHAN_ID] ,[DUOC_ID] ,[SOLUONG] ,[SONGAY] ,[SOLANTRENNGAY] ,[SOLUONGTRENLAN]
      ,[SOLUONG_BUOISANG] ,[SOLUONG_BUOITRUA] ,[SOLUONG_BUOICHIEU],[SOLUONG_BUOITOI],[DUONGDUNG_ID],[CACHDUNG_ID] ,[IDX] ,[CHUYENKHOA_ID]
      ,[PHONGBANRATOA_ID] ,[NGUONHANG_ID] ,[PHATSINHHOADON],[GHICHU] ,[TRANGTHAI] ,[HUYTOATHUOC],[BENHVIEN_ID],[NGAYTAO],[NGUOITAO_ID]
      ,[NGAYCAPNHAT],[NGUOICAPNHAT_ID]) VALUES
      (@KHAMBENH_TOATHUOC_ID,@SOTHUTUTOA ,@KHAMBENH_ID ,@TIEPNHAN_ID ,@DUOC_ID ,@SOLUONG ,@SONGAY ,@SOLANTRENNGAY ,@SOLUONGTRENLAN
      ,@SOLUONG_BUOISANG ,@SOLUONG_BUOITRUA ,@SOLUONG_BUOICHIEU,@SOLUONG_BUOITOI,@DUONGDUNG_ID,@CACHDUNG_ID ,@IDX ,@CHUYENKHOA_ID
      ,@PHONGBANRATOA_ID ,@NGUONDUOC_ID ,@PHATSINHHOADON,@GHICHU ,@TRANGTHAI ,'0',@BENHVIEN_ID,getdate(),@NGUOITAO_ID
      ,getdate(),@NGUOICAPNHAT_ID)
      <!--get toathuoc_id-->
      set @TOATHUOC_ID = SCOPE_IDENTITY()

      <!--insert TT_VIENPHI-->
      if (@LOAITOA_NGOAITRU != 'MN' and @LOAITOA_NGOAITRU != 'TV' and @LOAITOA_NGOAITRU != 'MP')
      BEGIN
      INSERT INTO TT_VIENPHI
      ([TIEPNHAN_ID]
      ,[BENHNHAN_ID],[KHAMBENH_ID],[REF_ID],[REF_TABLE],[DICHVU_ID],[DUOC_ID],[LOAI_CHIPHI]
      ,[SOLUONG],[DONGIA_DOANHTHU],[THANHTIEN_DOANHTHU],[BHYT_DONGIA],[BHYT_THANHTIEN],[HUY],[DATHANHTOAN]
      ,[DATHUCHIEN],[BENHVIEN_ID],[NGUOITAO_ID],[NGAYTAO],[NGUOICAPNHAT_ID],[NGAYCAPNHAT], [DOITUONG_HUONG_ID], [SOBHYT_HUONG_ID])
      VALUES
      (@TIEPNHAN_ID
      ,@BENHNHAN_ID,@KHAMBENH_ID,@TOATHUOC_ID,'TT_NGOAITRU_TOATHUOC',null,@DUOC_ID,'TT'
      ,@SOLUONG,@DONGIA_DOANHTHU,@THANHTIEN_DOANHTHU,@BHYT_DONGIA,@BHYT_THANHTIEN,'0','0'
      ,'0',@BENHVIEN_ID,@NGUOITAO_ID,GETDATE(),@NGUOICAPNHAT_ID,GETDATE(), @DOITUONG_HUONG_ID, @SOBHYT_HUONG_ID)
      END
      <!--insert TT_DUOC_TONKHO_BOOK_NGOAITRU-->
      if (@LOAITOA_NGOAITRU = 'MN' and @TOAMUANGOAI_DANHMUC = 1 and @PHAMVI_ID = 0)
      begin
      set @TOAMUANGOAI_DANHMUC = 1
      end
      else
      begin
      if (@TOAMUANGOAI_KHONGBOOK = 1 and @LOAITOA_NGOAITRU != 'BV' and @LOAITOA_NGOAITRU != 'TV' and @LOAITOA_NGOAITRU != 'MP')
      begin
      set @TOAMUANGOAI_KHONGBOOK = 1
      end
      else
      begin
      insert into TT_DUOC_TONKHO_BOOK_NGOAITRU
      ([REF_TABLE],[REF_ID],[PHAMVI_ID],[KHODUOC_ID],[DUOC_ID],[SOLUONG],[NGUONHANG_ID],[CHUYENKHOA_ID]
      ,[GHICHU],[BENHVIEN_ID],[NGAYTAO],[NGUOITAO_ID],[NGAYCAPNHAT],[NGUOICAPNHAT_ID], [TRANGTHAI], [NGAYHIEULUC])
      VALUES
      ('TT_NGOAITRU_TOATHUOC',@TOATHUOC_ID,@PHAMVI_ID,@KHOPHAT_ID,@DUOC_ID,@SOLUONG,@NGUONDUOC_ID,@PHONGBANRATOA_ID
      ,@GHICHU,@BENHVIEN_ID,GETDATE(),@NGUOITAO_ID,GETDATE(),@NGUOICAPNHAT_ID, 'HIEULUC', GETDATE())
      end
      end
      set @icnt = @icnt + 1;
      END
    </statement>
    <statement id="DAO00014_Update_JsonKhambenhToathuoc" parameterClass="System.String" resultClass="System.Int32">
      declare @jsonVienPhi nvarchar(max);
      set @jsonVienPhi = N'{
      "DATA": $JSON_DATA$
      }';

      declare @TOATHUOC_ID int;
      declare @KHAMBENH_TOATHUOC_ID int;
      declare @LOAITOA_NGOAITRU varchar(10);
      declare @SOTHUTUTOA varchar(10);
      declare @KHAMBENH_ID int;
      declare @TIEPNHAN_ID int;
      declare @BENHNHAN_ID int;
      declare @DUOC_ID int;
      declare @SOLUONG numeric(25, 4);
      declare @SONGAY numeric(25, 4);
      declare @SOLANTRENNGAY numeric(25, 4);
      declare @SOLUONGTRENLAN numeric(25, 4);
      declare @SOLUONG_BUOISANG numeric(25, 4);
      declare @SOLUONG_BUOITRUA numeric(25, 4);
      declare @SOLUONG_BUOICHIEU numeric(25, 4);
      declare @SOLUONG_BUOITOI numeric(25, 4);
      declare @DUONGDUNG_ID int;
      declare @CACHDUNG_ID int;
      declare @IDX int;
      declare @CHUYENKHOA_ID int;
      declare @PHONGBANRATOA_ID int;
      declare @NGUONHANG_ID int;
      declare @PHATSINHHOADON char(1);
      declare @GHICHU nvarchar(2000);
      declare @TRANGTHAI varchar(20);
      declare @HUYTOATHUOC char(1);
      declare @BENHVIEN_ID varchar(10);
      declare @NGAYTAO datetime;
      declare @NGUOITAO_ID int;
      declare @NGAYCAPNHAT datetime;
      declare @NGUOICAPNHAT_ID int;
      declare @PHAMVI_ID int;
      declare @NGUONDUOC_ID int;
      declare @KHOPHAT_ID int;

      declare @DONGIA_DOANHTHU numeric(25, 4);
      declare @THANHTIEN_DOANHTHU numeric(25, 4);
      declare @BHYT_DONGIA numeric(25, 4);
      declare @BHYT_THANHTIEN numeric(25, 4);
      declare @DOITUONG_HUONG_ID numeric(25, 4);
      declare @SOBHYT_HUONG_ID numeric(25, 4);

      declare @TOAMUANGOAI_DANHMUC int = 0;
      select @TOAMUANGOAI_DANHMUC = isnull(VALUE,0) from TM_SYS_APPSETTINGS where CODE = 'OPD_TOAMUANGOAI_DUNGDANHMUC_DUOC'
      declare @TOAMUANGOAI_KHONGBOOK int = 0;
      select @TOAMUANGOAI_KHONGBOOK = isnull(VALUE,0) from TM_SYS_APPSETTINGS where CODE = 'OPD_TOAMUANGOAI_KHONG_BOOKING_DUOC'
      
      declare @iTotal int = #TOTAL_RECORD#;
      declare @icnt int = 0;
      WHILE @iTotal > @icnt
      BEGIN
      declare @dyn_sql nvarchar(1000) = 'select @data = json_query(@json_dyn, ''' + CHAR(36) +'.DATA[' + cast(@icnt as varchar(10)) + ']'');'
      declare @jsondatamax nvarchar(max);

      exec sp_executesql @dyn_sql
      , N'@json_dyn nvarchar(max), @data nvarchar(max) OUTPUT'
      , @json_dyn = @jsonVienPhi
      , @data = @jsondatamax OUTPUT

      <!--lay data tu json-->
      select
      @TOATHUOC_ID =  JSON_VALUE(@jsondatamax, '' + CHAR(36) +'.TOATHUOC_ID'),
      @KHAMBENH_TOATHUOC_ID =  JSON_VALUE(@jsondatamax, '' + CHAR(36) +'.KHAMBENH_TOATHUOC_ID'),
      @LOAITOA_NGOAITRU =  JSON_VALUE(@jsondatamax, '' + CHAR(36) +'.LOAITOA_NGOAITRU'),
      @SOTHUTUTOA =  JSON_VALUE(@jsondatamax, '' + CHAR(36) +'.SOTHUTUTOA'),
      @KHAMBENH_ID =  JSON_VALUE(@jsondatamax, '' + CHAR(36) +'.KHAMBENH_ID'),
      @TIEPNHAN_ID =  JSON_VALUE(@jsondatamax, '' + CHAR(36) +'.TIEPNHAN_ID'),
      @BENHNHAN_ID =  JSON_VALUE(@jsondatamax, '' + CHAR(36) +'.BENHNHAN_ID'),
      @NGUONDUOC_ID =  JSON_VALUE(@jsondatamax, '' + CHAR(36) +'.NGUONDUOC_ID'),
      @DUOC_ID =  JSON_VALUE(@jsondatamax, '' + CHAR(36) +'.DUOC_ID'),
      @SOLUONG =  JSON_VALUE(@jsondatamax, '' + CHAR(36) +'.SOLUONG'),
      @SONGAY =  JSON_VALUE(@jsondatamax, '' + CHAR(36) +'.SONGAY'),
      @SOLANTRENNGAY =  JSON_VALUE(@jsondatamax, '' + CHAR(36) +'.SOLANTRENNGAY'),
      @SOLUONGTRENLAN =  JSON_VALUE(@jsondatamax, '' + CHAR(36) +'.SOLUONGTRENLAN'),
      @SOLUONG_BUOISANG =  JSON_VALUE(@jsondatamax, '' + CHAR(36) +'.SOLUONG_BUOISANG'),
      @SOLUONG_BUOITRUA =  JSON_VALUE(@jsondatamax, '' + CHAR(36) +'.SOLUONG_BUOITRUA'),
      @SOLUONG_BUOICHIEU =  JSON_VALUE(@jsondatamax, '' + CHAR(36) +'.SOLUONG_BUOICHIEU'),
      @SOLUONG_BUOITOI =  JSON_VALUE(@jsondatamax, '' + CHAR(36) +'.SOLUONG_BUOITOI'),
      @DUONGDUNG_ID =  JSON_VALUE(@jsondatamax, '' + CHAR(36) +'.DUONGDUNG_ID'),
      @CACHDUNG_ID =  JSON_VALUE(@jsondatamax, '' + CHAR(36) +'.CACHDUNG_ID'),
      @KHOPHAT_ID =  JSON_VALUE(@jsondatamax, '' + CHAR(36) +'.KHOPHAT_ID'),
      @PHONGBANRATOA_ID =  JSON_VALUE(@jsondatamax, '' + CHAR(36) +'.PHONGBANRATOA_ID'),
      @GHICHU =  JSON_VALUE(@jsondatamax, '' + CHAR(36) +'.GHICHU'),
      @BENHVIEN_ID =  JSON_VALUE(@jsondatamax, '' + CHAR(36) +'.BENHVIEN_ID'),
      @NGAYTAO =  JSON_VALUE(@jsondatamax, '' + CHAR(36) +'.NGAYTAO'),
      @NGUOITAO_ID =  JSON_VALUE(@jsondatamax, '' + CHAR(36) +'.NGUOITAO_ID'),
      @NGAYCAPNHAT =  JSON_VALUE(@jsondatamax, '' + CHAR(36) +'.NGAYCAPNHAT'),
      @NGUOICAPNHAT_ID =  JSON_VALUE(@jsondatamax, '' + CHAR(36) +'.NGUOICAPNHAT_ID'),
      @PHAMVI_ID =  JSON_VALUE(@jsondatamax, '' + CHAR(36) +'.PHAMVI_ID'),
      @DOITUONG_HUONG_ID =  JSON_VALUE(@jsondatamax, '' + CHAR(36) +'.DOITUONG_HUONG_ID'),
      @SOBHYT_HUONG_ID =  JSON_VALUE(@jsondatamax, '' + CHAR(36) +'.SOBHYT_HUONG_ID'),
      @IDX =  JSON_VALUE(@jsondatamax, '' + CHAR(36) +'.IDX'),

      @DONGIA_DOANHTHU =  JSON_VALUE(@jsondatamax, '' + CHAR(36) +'.DONGIA_DOANHTHU'),
      @THANHTIEN_DOANHTHU =  JSON_VALUE(@jsondatamax, '' + CHAR(36) +'.THANHTIEN_DOANHTHU'),
      @BHYT_DONGIA =  JSON_VALUE(@jsondatamax, '' + CHAR(36) +'.BHYT_DONGIA'),
      @BHYT_THANHTIEN =  JSON_VALUE(@jsondatamax, '' + CHAR(36) +'.BHYT_THANHTIEN')

      <!--insert toa thuoc ngoai tru-->
      update TT_NGOAITRU_TOATHUOC
      set DUOC_ID = @DUOC_ID
      ,[SOLUONG] = @SOLUONG
      ,[SONGAY] = @SONGAY
      ,[SOLANTRENNGAY] = @SOLANTRENNGAY
      ,[SOLUONGTRENLAN] = @SOLUONGTRENLAN
      ,[SOLUONG_BUOISANG] = @SOLUONG_BUOISANG
      ,[SOLUONG_BUOITRUA] = @SOLUONG_BUOITRUA
      ,[SOLUONG_BUOICHIEU] = @SOLUONG_BUOICHIEU
      ,[SOLUONG_BUOITOI] = @SOLUONG_BUOITOI
      ,[GHICHU] = @GHICHU
      ,[NGAYCAPNHAT] = GETDATE()
      ,[NGUOICAPNHAT_ID] =  @NGUOICAPNHAT_ID
      where TOATHUOC_ID = @TOATHUOC_ID

      <!--insert TT_VIENPHI-->
      if (@LOAITOA_NGOAITRU != 'MN' and @LOAITOA_NGOAITRU != 'TV' and @LOAITOA_NGOAITRU != 'MP')
      BEGIN
      update TT_VIENPHI set SOLUONG = @SOLUONG, NGUOICAPNHAT_ID = @NGUOICAPNHAT_ID
      , NGAYCAPNHAT = GETDATE()
      where REF_TABLE = 'TT_NGOAITRU_TOATHUOC' and KHAMBENH_ID = @KHAMBENH_ID and REF_ID = @TOATHUOC_ID
      END
      <!--insert TT_DUOC_TONKHO_BOOK_NOITRU-->
      if (@LOAITOA_NGOAITRU = 'MN' and @TOAMUANGOAI_DANHMUC = 1 and @PHAMVI_ID = 0)
      begin
      set @TOAMUANGOAI_DANHMUC = 1
      end
      else
      begin
      if (@TOAMUANGOAI_KHONGBOOK = 1 and @LOAITOA_NGOAITRU != 'BV' and @LOAITOA_NGOAITRU != 'TV' and @LOAITOA_NGOAITRU != 'MP')
      begin
      set @TOAMUANGOAI_KHONGBOOK = 1
      end
      else
      begin
      update TT_DUOC_TONKHO_BOOK_NGOAITRU set SOLUONG = @SOLUONG, NGUOICAPNHAT_ID = @NGUOICAPNHAT_ID, NGAYCAPNHAT = GETDATE()
      where REF_TABLE = 'TT_NGOAITRU_TOATHUOC' and REF_ID = @TOATHUOC_ID
      end
      end
      set @icnt = @icnt + 1;
      END
    </statement>
    <statement id="DAO00014_Update_JsonKhambenhToathuocThuocSTT" parameterClass="System.String" resultClass="System.Int32">
      declare @jsonVienPhi nvarchar(max);
      set @jsonVienPhi = N'{
      "DATA": $JSON_DATA$
      }';

      declare @TOATHUOC_ID int;
      declare @IDX int;

      declare @iTotal int = #TOTAL_RECORD#;
      declare @icnt int = 0;
      WHILE @iTotal > @icnt
      BEGIN
      declare @dyn_sql nvarchar(1000) = 'select @data = json_query(@json_dyn, ''' + CHAR(36) +'.DATA[' + cast(@icnt as varchar(10)) + ']'');'
      declare @jsondatamax nvarchar(max);

      exec sp_executesql @dyn_sql
      , N'@json_dyn nvarchar(max), @data nvarchar(max) OUTPUT'
      , @json_dyn = @jsonVienPhi
      , @data = @jsondatamax OUTPUT

      <!--lay data tu json-->
      select
      @TOATHUOC_ID =  JSON_VALUE(@jsondatamax, '' + CHAR(36) +'.TOATHUOC_ID'),
      @IDX =  JSON_VALUE(@jsondatamax, '' + CHAR(36) +'.IDX')

      <!--insert toa thuoc ngoai tru-->
      update TT_NGOAITRU_TOATHUOC
      set IDX = @IDX
      where TOATHUOC_ID = @TOATHUOC_ID
      set @icnt = @icnt + 1;
      END
    </statement>
    <statement id="DAO00014_Delete_KhambenhToathuoc" parameterClass="System.String" resultClass="System.Int32">
      DELETE FROM TT_DUOC_TONKHO_BOOK_NGOAITRU where REF_TABLE = 'TT_NGOAITRU_TOATHUOC' and REF_ID in ($LST_TOATHUOC_ID$)

      DELETE FROM TT_VIENPHI where REF_TABLE = 'TT_NGOAITRU_TOATHUOC' and REF_ID in ($LST_TOATHUOC_ID$)

      DELETE FROM TT_NGOAITRU_TOATHUOC where TOATHUOC_ID in ($LST_TOATHUOC_ID$)

    </statement>

    <statement id="DAO00014_Delete_1ToaThuocKhambenh" parameterClass="System.String" resultClass="System.Int32">

      DELETE FROM TT_DUOC_TONKHO_BOOK_NGOAITRU where REF_TABLE = 'TT_NGOAITRU_TOATHUOC'
      and exists (select TOATHUOC_ID from TT_NGOAITRU_TOATHUOC where TT_DUOC_TONKHO_BOOK_NGOAITRU.REF_ID = TOATHUOC_ID and KHAMBENH_TOATHUOC_ID in ($KHAMBENH_TOATHUOC_ID$))

      DELETE FROM TT_VIENPHI where REF_TABLE = 'TT_NGOAITRU_TOATHUOC'
      and exists (select TOATHUOC_ID from TT_NGOAITRU_TOATHUOC where TT_VIENPHI.REF_ID = TOATHUOC_ID and KHAMBENH_TOATHUOC_ID in ($KHAMBENH_TOATHUOC_ID$))

      DELETE FROM TT_NGOAITRU_TOATHUOC where KHAMBENH_TOATHUOC_ID in ($KHAMBENH_TOATHUOC_ID$)

      DELETE FROM TT_NGOAITRU_KHAMBENH_TOATHUOC where KHAMBENH_TOATHUOC_ID in ($KHAMBENH_TOATHUOC_ID$)
    </statement>
    <statement id="DAO00014_Clear_1ToaThuocKhambenh" parameterClass="System.String" resultClass="System.Int32">

      <!--DELETE FROM TT_DUOC_TONKHO_BOOK_NGOAITRU where REF_TABLE = 'TT_NGOAITRU_TOATHUOC'
      and REF_ID not in (select TOATHUOC_ID from TT_NGOAITRU_TOATHUOC)

      DELETE FROM TT_VIENPHI where REF_TABLE = 'TT_NGOAITRU_TOATHUOC'
      and REF_ID not in (select TOATHUOC_ID from TT_NGOAITRU_TOATHUOC)-->

      DELETE FROM TT_DUOC_TONKHO_BOOK_NGOAITRU where REF_TABLE = 'TT_NGOAITRU_TOATHUOC'
      and REF_ID in (
      select TOATHUOC_ID from TT_NGOAITRU_TOATHUOC
      where 
          KHAMBENH_TOATHUOC_ID in (select KHAMBENH_TOATHUOC_ID from TT_NGOAITRU_KHAMBENH_TOATHUOC
      where TIEPNHAN_ID = '$TIEPNHAN_ID$' and 
                KHAMBENH_ID not in (select KHAMBENH_ID from TT_NGOAITRU_KHAMBENH where  TIEPNHAN_ID = '$TIEPNHAN_ID$'))
      and TIEPNHAN_ID = '$TIEPNHAN_ID$')

      DELETE FROM TT_VIENPHI where REF_TABLE = 'TT_NGOAITRU_TOATHUOC'
      and REF_ID in (
      select TOATHUOC_ID from TT_NGOAITRU_TOATHUOC
      where KHAMBENH_TOATHUOC_ID in (select KHAMBENH_TOATHUOC_ID from TT_NGOAITRU_KHAMBENH_TOATHUOC
      where TIEPNHAN_ID = '$TIEPNHAN_ID$' and KHAMBENH_ID not in (select KHAMBENH_ID from TT_NGOAITRU_KHAMBENH where TIEPNHAN_ID = '$TIEPNHAN_ID$'))
      and TIEPNHAN_ID = '$TIEPNHAN_ID$')

      delete from TT_NGOAITRU_TOATHUOC
      where KHAMBENH_TOATHUOC_ID in (select KHAMBENH_TOATHUOC_ID from TT_NGOAITRU_KHAMBENH_TOATHUOC
      where TIEPNHAN_ID = '$TIEPNHAN_ID$' and KHAMBENH_ID not in (select KHAMBENH_ID from TT_NGOAITRU_KHAMBENH where TIEPNHAN_ID = '$TIEPNHAN_ID$')
      and TIEPNHAN_ID = '$TIEPNHAN_ID$')

      delete from TT_NGOAITRU_KHAMBENH_TOATHUOC where TIEPNHAN_ID = '$TIEPNHAN_ID$'
      and KHAMBENH_ID not in (select KHAMBENH_ID from TT_NGOAITRU_KHAMBENH where TIEPNHAN_ID = '$TIEPNHAN_ID$') and TIEPNHAN_ID = '$TIEPNHAN_ID$'
    </statement>

    <statement id="DAO00014_GetToathuocTonTai" parameterClass="System.String" resultClass="DataObject">
      select top 1 SOTHUTUTOA, KHAMBENH_TOATHUOC_ID from TT_NGOAITRU_KHAMBENH_TOATHUOC where
      TIEPNHAN_ID = '$TIEPNHAN_ID$'
      and KHAMBENH_ID = '$KHAMBENH_ID$'
      and MATOATHUOC = '$MATOATHUOC$'
      and LOAITOATHUOC = '$LOAITOATHUOC$'
    </statement>

    <statement id="DAO00014_CheckExistsToaThuoc_ByTiepNhan_ID" parameterClass="System.String" resultClass="System.Int32">
      select count(KHAMBENH_TOATHUOC_ID)
      from TT_NGOAITRU_KHAMBENH_TOATHUOC
      where
      TIEPNHAN_ID = '$TIEPNHAN_ID$' and LOAITOATHUOC = 'BV'
    </statement>
    <statement id="DAO00014_GetThongTinDoKhucXa" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select * from
      (
      select COUNT(*) OVER() as TOTALROWS,ROW_NUMBER() OVER (ORDER BY a.TIEPNHAN_ID) as ROWNUMBER, * from
      (
      select distinct tn.*, bn.MAYTE, bn.TENBENHNHAN, bn.NGAYSINH, g.DESCRIPTION as GIOITINH, dt.TENDOITUONG
      from TT_TIEPNHAN tn
      inner join TT_BENHNHAN bn on bn.BENHNHAN_ID = tn.BENHNHAN_ID
      left join TT_DOKHUCXA kx on kx.TIEPNHAN_ID = tn.TIEPNHAN_ID
      inner join TM_GENDER g on g.ID = bn.GIOITINH
      inner join TM_DOITUONG dt on dt.DOITUONG_ID = tn.DOITUONG_ID
      where convert(date,tn.NGAYTIEPNHAN) between convert(date,'$DATEFROM$') and convert(date,'$DATETO$')
      and (tn.TRANGTHAI != 'HOANTHANH' and tn.TRANGTHAI != 'NOITRU' and tn.TRANGTHAI != 'CAPCUU')
      <isNotEmpty prepend="and" property="BENHVIEN_ID">
        tn.BENHVIEN_ID = '$BENHVIEN_ID$'
      </isNotEmpty>
      <isNotEmpty prepend="and" property="KEYSEARCH">
        (BN.MAYTE LIKE '%' + #KEYSEARCH# + '%' OR BN.TENBENHNHAN LIKE '%' + #KEYSEARCH# + '%')
      </isNotEmpty>
      <isNotEmpty prepend="" property="STATUS">
        <isEqual prepend="AND" property="STATUS" compareValue="02">
          TN.TIEPNHAN_ID NOT IN (SELECT TIEPNHAN_ID FROM TT_DOKHUCXA WHERE BENHVIEN_ID = '$BENHVIEN_ID$')
        </isEqual>
        <isEqual prepend="AND" property="STATUS" compareValue="03">
          TN.TIEPNHAN_ID IN (SELECT TIEPNHAN_ID FROM TT_DOKHUCXA WHERE BENHVIEN_ID = '$BENHVIEN_ID$')
        </isEqual>
      </isNotEmpty>
      )a
      )b
      where b.ROWNUMBER between '$FROMROW$' AND '$TOROW$'
      order by b.TIEPNHAN_ID
    </statement>
    <statement id="DAO00014_AddKhucXa" parameterClass="System.Collections.IDictionary" resultClass="System.Int64">
      insert into TT_DOKHUCXA (
      TIEPNHAN_ID
      , BENHNHAN_ID
      , THILUC_OS
      , THILUC_OD
      , KINHCU_OS
      , KINHCU_OD
      , PPDNAKTX_OS
      , PPDNAKTX_OD
      , PPDNAMK_OS
      , PPDNAMK_OD
      , NGUOIDO_ID
      , THOIGIANDO
      , BENHSU
      , NGAYTAO
      , NGUOITAO_ID
      , NGAYCAPNHAT
      , NGUOICAPNHAT_ID
      , BENHVIEN_ID
      ) values (
      #TIEPNHAN_ID#
      , #BENHNHAN_ID#
      , #THILUC_OS#
      , #THILUC_OD#
      , #KINHCU_OS#
      , #KINHCU_OD#
      , #PPDNAKTX_OS#
      , #PPDNAKTX_OD#
      , #PPDNAMK_OS#
      , #PPDNAMK_OD#
      , #NGUOIDO_ID#
      , #THOIGIANDO#
      , #BENHSU#
      , #NGAYTAO#
      , #NGUOITAO_ID#
      , #NGAYCAPNHAT#
      , #NGUOICAPNHAT_ID#
      , #BENHVIEN_ID#
      )
      SELECT SCOPE_IDENTITY()
    </statement>
    <update id="DAO00014_UpdateKhucXa" parameterClass="System.Collections.IDictionary">
      update TT_DOKHUCXA set
      TIEPNHAN_ID =	#TIEPNHAN_ID#
      , BENHNHAN_ID	= #BENHNHAN_ID#
      , THILUC_OS	= #THILUC_OS#
      , THILUC_OD = #THILUC_OD#
      , KINHCU_OS	= #KINHCU_OS#
      , KINHCU_OD	= #KINHCU_OD#
      , PPDNAKTX_OS	= #PPDNAKTX_OS#
      , PPDNAKTX_OD = #PPDNAKTX_OD#
      , PPDNAMK_OS = #PPDNAMK_OS#
      , PPDNAMK_OD = #PPDNAMK_OD#
      , NGUOIDO_ID = #NGUOIDO_ID#
      , THOIGIANDO = #THOIGIANDO#
      , BENHSU = #BENHSU#
      , NGAYCAPNHAT	= #NGAYCAPNHAT#
      , NGUOICAPNHAT_ID	= #NGUOICAPNHAT_ID#
      where
      KHUCXA_ID = '$KHUCXA_ID$'
    </update>
  <statement id="DAO00014_GetDoKhucXa" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
    select A.*, B.TENNHANVIEN as NGUOIDO from TT_DOKHUCXA A join TM_NHANVIEN B on A.NGUOIDO_ID = B.NHANVIEN_ID
    <dynamic prepend="where">
      <isParameterPresent>
        <isNotEmpty prepend="and" property="TIEPNHAN_ID">
          A.TIEPNHAN_ID = '$TIEPNHAN_ID$'
        </isNotEmpty>
        <isNotEmpty prepend="and" property="BENHNHAN_ID">
          A.BENHNHAN_ID = '$BENHNHAN_ID$'
        </isNotEmpty>
        <isNotEmpty prepend="and" property="BENHVIEN_ID">
          A.BENHVIEN_ID = '$BENHVIEN_ID$'
        </isNotEmpty>
      <isNotEmpty prepend="and" property="KHUCXA_ID">
          A.KHUCXA_ID = '$KHUCXA_ID$'
        </isNotEmpty>
      </isParameterPresent>
    </dynamic>
    order by A.THOIGIANDO desc
  </statement>
    <statement id="DAO00014_GetChitietDVYeucauKhamBenh" parameterClass="System.String" resultClass="DataObject">
      select *
      from TT_DVYEUCAU
      where DVYEUCAU_ID  = '$DVYEUCAU_ID$'
    </statement>
    <statement id="DAO00014_CheckExistsLoaiToaThuoc_KhamBenhID" parameterClass="System.String" resultClass="System.Int32">
      select COUNT(KHAMBENH_TOATHUOC_ID)
      from TT_NGOAITRU_KHAMBENH_TOATHUOC
      where
      KHAMBENH_ID = $KHAMBENH_ID$
      and MATOATHUOC = '$MATOATHUOC$'
      and HUYTOATHUOC = 0
    </statement>
    <statement id="DAO00014_CheckBenhNhanChuaXSDVTYT" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      IF EXISTS (
      select vt.KHAMBENH_VTYT_ID
      from TT_NGOAITRU_KHAMBENH_VTYT vt
      inner join TT_NGOAITRU_KHAMBENH kb on kb.KHAMBENH_ID = vt.KHAMBENH_ID
      where kb.TIEPNHAN_ID = $TIEPNHAN_ID$
      and kb.BENHVIEN_ID = '$BENHVIEN_ID$'
      and vt.CHUNGTU_ID is null

      union all

      select vt.CLSKETQUA_VTYT_ID
      from TT_CLSKETQUA_VTYT vt
      inner join TT_DVYEUCAU yc on yc.DVYEUCAU_ID = vt.DVYEUCAU_ID and yc.BENHVIEN_ID = vt.BENHVIEN_ID
      where yc.TIEPNHAN_ID = $TIEPNHAN_ID$
      and yc.BENHVIEN_ID = '$BENHVIEN_ID$'
      and vt.CHUNGTU_ID is null
      )
      BEGIN
      SELECT -1 AS RESULT
      END
      ELSE
      BEGIN
      SELECT 1 AS RESULT
      END

    </statement>
    <statement id="DAO00014_GetDanhsachMatoathuocThuoc" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select * from TT_NGOAITRU_KHAMBENH_TOATHUOC where TIEPNHAN_ID = #TIEPNHAN_ID# and MATOATHUOC = #MATOATHUOC#
    </statement>
    <statement id="DAO00014_GetThongtinKhamsuckhoeTheoDVyc" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select HOPDONG_ID, HOPDONG_BENHNHAN_ID from TT_DVYEUCAU where DVYEUCAU_ID = #DVYEUCAU_ID#
    </statement>
  </statements>
</sqlMap>
