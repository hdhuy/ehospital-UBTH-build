<?xml version="1.0" encoding="utf-8" ?>
<!--============================================================================
//	CAUTION: This file is generated by IBatisNetGen.3.SQLMap.cst at 10/3/2016 10:12:54 AM
//				Any manual editing will be lost in re-generation.
//===========================================================================-->
<sqlMap namespace="eHospital" xmlns="http://ibatis.apache.org/mapping" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
  <statements>
    <statement id="DAO00303_DanhSachDotDieuTri" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select ROW_NUMBER() over(order by dt.DOTDIEUTRI_ID desc) as STT
      ,dt.*, pb.TENPHONGBAN AS KHOADIEUTRI, NV.TENNHANVIEN AS BACSYDIEUTRI
      ,icd_kb.MAICD AS MAICDKB, icd_rk.MAICD AS MAICDRAKHOA
      , case when dt.TRANGTHAI='0' then N'Đang mở' else N'Đóng' end as TINHTRANG
      from TT_NOITRU_DOTDIEUTRI dt
      inner join TM_PHONGBAN pb on pb.PHONGBAN_ID = dt.KHOADIEUTRI_ID
      inner join TM_NHANVIEN nv on nv.NHANVIEN_ID = dt.BACSYDIEUTRI_ID
      left join TM_ICD icd_kb on icd_kb.ICD_ID = dt.ICD_ID_DIEUTRI
      left join TM_ICD icd_rk on icd_rk.ICD_ID = dt.ICD_ID_RA
      where convert(date,dt.TUNGAY) BETWEEN CONVERT(DATE,case when '$TUNGAY$' is null then '1900-01-01' else '$TUNGAY$' end) AND CONVERT(DATE,'$DENNGAY$')
      <dynamic>
        <isParameterPresent>
          <isNotEmpty prepend="and" property="THONGTINTIMKIEM">
            (dt.MADOTDIEUTRI LIKE '%' + #THONGTINTIMKIEM# + '%' OR dt.TENDOTDIEUTRI LIKE '%' + #THONGTINTIMKIEM# + '%')
          </isNotEmpty>
          <isNotEmpty prepend="and" property="BENHAN_ID">
            dt.BENHAN_ID = '$BENHAN_ID$'
          </isNotEmpty>
          <!--<isNotEmpty prepend="and">
            convert(date,dt.TUNGAY) BETWEEN CONVERT(DATE,case when '$TUNGAY$' is null then '1900-01-01' else '$TUNGAY$' end) AND CONVERT(DATE,'$DENNGAY$')
          </isNotEmpty>-->
        </isParameterPresent>
      </dynamic>
      order by dt.DOTDIEUTRI_ID DESC
    </statement>
    <statement id="DAO00303_GetDSDVChuaThucHien" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select dvyc.* from TT_DVYEUCAU dvyc
      left join TT_VIENPHI vp
      on dvyc.DVYEUCAU_ID = vp.REF_ID and vp.REF_TABLE = 'TT_DVYEUCAU'
      where vp.DATHUCHIEN = 0 and dvyc.HUYYEUCAU = '0'
      and dvyc.BENHAN_ID = '$BENHAN_ID$'
      and dvyc.BENHVIEN_ID = '$BENHVIEN_ID$'
    </statement>
    <statement id="DAO00303_GetDSThuocChuaXuat" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select A.TOATHUOC_ID
      from TT_NOITRU_TOATHUOC A
      inner join TT_NOITRU_KHAMBENH B on B.KHAMBENH_ID = A.KHAMBENH_ID
      left join TT_NOITRU_TRATHUOC_CHITIET ttct on a.TOATHUOC_ID = ttct.TOATHUOC_ID
      where A.TIEPNHAN_ID = '$TIEPNHAN_ID$'
      and A.BENHVIEN_ID = '$BENHVIEN_ID$'
      and A.CHUNGTU_ID IS NULL
      and ttct.TRATHUOC_ID is null
    </statement>

    <statement id="DAO00303_GetDSVTYTChuaXuat" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select PHAUTHUAT_VTYT_ID from TT_PHAUTHUAT_VTYT
      where PHAUTHUAT_ID in (select PHAUTHUAT_ID from TT_PHAUTHuAT where BENHAN_ID = '$BENHAN_ID$')
      and BENHVIEN_ID = '$BENHVIEN_ID$'
      and CHUNGTU_ID IS NULL
    </statement>
    <statement id="DAO00303_GetNhanVienTaoDot" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select NGUOITAO_ID from TT_NOITRU_DOTDIEUTRI where MADOTDIEUTRI = '$MADOTDIEUTRI$'
    </statement>
    <statement id="DAO00303_KiemTraThongTinDotDieuTri" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select top 1 * from TT_NOITRU_DOTDIEUTRI where BENHAN_ID = '$BENHAN_ID$' and TRANGTHAI='0' order by DOTDIEUTRI_ID DESC
    </statement>
    <statement id="DAO00303_KiemTraThongTinBenhAn" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select top 1 ba.* from TT_NOITRU_BENHAN ba
      inner join TT_TIEPNHAN tn on tn.TIEPNHAN_ID = ba.TIEPNHAN_ID
      where ba.TIEPNHAN_ID = '$TIEPNHAN_ID$' and ba.BENHVIEN_ID = '$BENHVIEN_ID$'
      order by BA.BENHAN_ID
    </statement>
    <statement id="DAO00303_CheckThanhToanVienPhi" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select VP.*
      from TT_VIENPHI VP
      INNER JOIN TT_NOITRU_DOTDIEUTRI DT ON DT.BENHAN_ID = VP.BENHAN_ID
      INNER JOIN TT_TIEPNHAN TN ON TN.TIEPNHAN_ID = VP.TIEPNHAN_ID
      INNER JOIN TT_NOITRU_BENHAN BA ON BA.TIEPNHAN_ID = TN.TIEPNHAN_ID
      WHERE <!--VP.DATHANHTOAN='0' AND--> VP.TIEPNHAN_ID = '$TIEPNHAN_ID$' AND VP.BENHVIEN_ID = '$BENHVIEN_ID$'
      <isNotEmpty prepend="and" property="OPT_KHO_RAVIEN_DUNG_KHO_OPD">
        <isEqual prepend="" property="OPT_KHO_RAVIEN_DUNG_KHO_OPD" compareValue="False">
          VP.DATHANHTOAN = '0' and VP.KHONGTHUTIEN = '0'
        </isEqual>
      <isEqual prepend="" property="OPT_KHO_RAVIEN_DUNG_KHO_OPD" compareValue="True">
          VP.DATHANHTOAN = '0' and VP.KHONGTHUTIEN = '1'
        </isEqual>
      </isNotEmpty>
    </statement>
  </statements>
</sqlMap>
