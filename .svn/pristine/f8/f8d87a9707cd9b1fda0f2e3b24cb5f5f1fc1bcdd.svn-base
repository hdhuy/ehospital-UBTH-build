<?xml version="1.0" encoding="utf-8" ?>
<sqlMap namespace="eHospital" xmlns="http://ibatis.apache.org/mapping" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" >
  <!--+ Author: Thucnv
      + Description: Nhập/Trả nhà cung cấp-->
  <statements>

    <!--============================================BEGIN LOAD DANH MỤC=============================================-->
    <statement id="DAO09800_TICHHOPCHUNGTUNHAPNCC" parameterClass="System.Collections.IDictionary" resultClass="System.Int64">
      INSERT INTO TM_PUR_GIAHOPDONG(NHACUNGCAP_ID,TENNHACUNGCAP,NGAYHOPDONG,TUNGAY,DENNGAY,MALOAIPHIEU,TENLOAIPHIEU,BENHVIEN_ID,NGAYTAO,NGUOITAO_ID)
      VALUES(#NHACUNGCAP_ID#,#TENNHACUNGCAP#,#NGAYHOPDONG#,#TUNGAY#,#DENNGAY#,#MALOAIPHIEU#,#TENLOAIPHIEU#,#BENHVIEN_ID#,GETDATE(),#NGUOITAO_ID#)
      SELECT SCOPE_IDENTITY()
    </statement>
    <statement id="DAO09800_GetKhoDuoc" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      SELECT KHODUOC_ID,MAKHO, TENKHO FROM dbo.TM_KHODUOC WHERE BENHVIEN_ID = '$BENHVIEN_ID$' AND TAMNGUNG = 0  ORDER BY TENKHO
    </statement>
    <statement id="DAO09800_GetNhaCungCap" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      SELECT NHACUNGCAP_ID, MANHACUNGCAP, TENNHACUNGCAP FROM dbo.TM_NHACUNGCAP WHERE BENHVIEN_ID = '$BENHVIEN_ID$' AND TAMNGUNG = 0 ORDER BY TENNHACUNGCAP
    </statement>
    <statement id="DAO09800_GetNhanVien" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      SELECT  N.NHANVIEN_ID ,N.MANHANVIEN ,N.TENNHANVIEN
      FROM    TM_NHANVIEN N
      WHERE   N.BENHVIEN_ID = '$BENHVIEN_ID$'
      ORDER BY N.TENNHANVIEN
    </statement>
    <statement id="DAO09800_GetDMKHOVPP" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      SELECT  AA.DICTIONARY_CODE AS MAKHO ,
      AA.DICTIONARY_NAME AS TENKHO
      FROM    LST_DICTIONARY AA
      WHERE  AA.BENHVIEN_ID = '$BENHVIEN_ID$' AND  AA.DICTIONARY_TYPE_CODE = 'KhoVPP';
    </statement>
    <!--============================================END LOAD DANH MỤC=============================================-->

    <!--============================================BEGIN DƯỢC PHẨM=============================================-->
    <!--Lấy danh sách chứng từ nhập ncc-->
    <statement id="DAO09800_GetMasterNHAPNCC" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      DECLARE @TENBENHVIEN NVARCHAR(250);
      SELECT @TENBENHVIEN = CODE
      FROM   dbo.TM_SYS_APPSETTINGS
      WHERE  BENHVIEN_ID = '$BENHVIEN_ID$' AND CODE = 'APP_BENHVIEN_TEN';

      SELECT BTNCHECK = CAST (0 AS BIT), CT.CHUNGTU_ID ,CT.MACHUNGTU ,CT.NGAYCHUNGTU ,CT.MUCDICHCHUNGTU_CODE AS MAMUCDICHCHUNGTU,MDCT.DICTIONARY_NAME AS TENMUCDICHCHUNGTU,CT.NHACUNGCAP_ID ,NCC.MANHACUNGCAP ,NCC.TENNHACUNGCAP ,
      NULL AS DIACHI, NULL AS MASOTHUE,CT.MAUHOADON ,CT.SOHOADON ,CT.SOSERI ,CT.NGAYHOADON ,CT.DIENGIAI ,CT.TIENTE_ID ,CT.TYGIA ,CT.GIATRI ,CT.TYLEVAT ,CT.GIATRIVAT ,CT.TYLECHIETKHAU ,CT.GIATRICHIETKHAU ,
      CT.GIATRITHANHTOAN ,NN.MANHANVIEN ,NN.TENNHANVIEN , NULL AS MADONHANG,CT.KHONHAP_ID ,KN.MAKHO AS MAKHONHAP, KN.TENKHO AS TENKHONHAP ,CT.KHOXUAT_ID , NULL AS MAKHOXUAT, NULL AS TENKHOXUAT ,
      CT.TRANGTHAI ,CT.PHONGBAN_ID ,PB.MAPHONGBAN ,PB.TENPHONGBAN ,PB.COSTCENTER_ID , CO.MAPHONGBAN AS COSTCENTERCODE, CO.TENPHONGBAN AS COSTCENTERNAME ,CT.BENHVIEN_ID
      ,CT.BENHVIEN_ID AS MABENHVIEN, TENBENHVIEN = @TENBENHVIEN ,
      CT.IDCHUYEN ,CT.BENHNHAN_ID ,NULL AS MAYTE, NULL AS TENBENHNHAN, NULL AS GHICHU, NULL AS CHUYENTICHHOP_ID, PV.MAPHAMVI AS PHAMVI,CT.LOAICHUNGTU, STATUSROW = CAST (0 AS BIT), MESSAGEROW = NULL
      FROM   dbo.TT_DUOC_CHUNGTU CT
      JOIN dbo.TM_KHODUOC KN ON CT.KHONHAP_ID = KN.KHODUOC_ID
      JOIN dbo.TM_NHANVIEN NN ON CT.NGUOINHAN_ID = NN.NHANVIEN_ID
      JOIN dbo.LST_DICTIONARY MDCT ON CT.MUCDICHCHUNGTU_ID = MDCT.DICTIONARY_ID
      JOIN dbo.TM_NHACUNGCAP NCC ON CT.NHACUNGCAP_ID = NCC.NHACUNGCAP_ID
      JOIN dbo.TM_PHONGBAN PB ON CT.PHONGBAN_ID = PB.PHONGBAN_ID
      LEFT JOIN dbo.TM_PHONGBAN CO ON PB.COSTCENTER_ID = CO.PHONGBAN_ID
      LEFT JOIN dbo.TM_PHAMVI PV ON KN.PHAMVI_ID = PV.PHAMVI_ID
      WHERE  CT.BENHVIEN_ID = '$BENHVIEN_ID$' AND CAST(CT.NGAYCHUNGTU AS DATE) BETWEEN '$TUNGAY$' AND '$DENNGAY$'
      AND CT.MUCDICHCHUNGTU_CODE = 'N01'
      AND CT.TRANGTHAI = 'PNDNK'
      AND CT.IDCHUYEN IS NULL
      <isNotEmpty prepend="AND" property="KHONHAP_ID">
        CT.KHONHAP_ID = '$KHONHAP_ID$'
      </isNotEmpty>
      <isNotEmpty prepend="AND" property="NHACUNGCAP_ID">
        CT.NHACUNGCAP_ID = '$NHACUNGCAP_ID$'
      </isNotEmpty>
      <isNotEmpty prepend="AND" property="NGUOINHAN_ID">
        CT.NGUOINHAN_ID = '$NGUOINHAN_ID$'
      </isNotEmpty>
      <isNotEmpty prepend="AND" property="MACHUNGTU">
        CT.MACHUNGTU LIKE '%$MACHUNGTU$%'
      </isNotEmpty>
    </statement>
    <!--Lấy danh sách chứng từ nhập ncc đã chuyển-->
    <statement id="DAO09800_GetMasterNHAPNCC_DACHUYEN" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      DECLARE @TENBENHVIEN NVARCHAR(250);
      SELECT @TENBENHVIEN = CODE
      FROM   dbo.TM_SYS_APPSETTINGS
      WHERE  BENHVIEN_ID = '$BENHVIEN_ID$' AND CODE = 'APP_BENHVIEN_TEN';

      SELECT BTNCHECK = CAST (0 AS BIT), CT.CHUNGTU_ID ,CT.MACHUNGTU ,CT.NGAYCHUNGTU ,CT.MUCDICHCHUNGTU_CODE AS MAMUCDICHCHUNGTU,MDCT.DICTIONARY_NAME AS TENMUCDICHCHUNGTU,CT.NHACUNGCAP_ID ,NCC.MANHACUNGCAP ,NCC.TENNHACUNGCAP ,
      NULL AS DIACHI, NULL AS MASOTHUE,CT.MAUHOADON ,CT.SOHOADON ,CT.SOSERI ,CT.NGAYHOADON ,CT.DIENGIAI ,CT.TIENTE_ID ,CT.TYGIA ,CT.GIATRI ,CT.TYLEVAT ,CT.GIATRIVAT ,CT.TYLECHIETKHAU ,CT.GIATRICHIETKHAU ,
      CT.GIATRITHANHTOAN ,NN.MANHANVIEN ,NN.TENNHANVIEN , NULL AS MADONHANG,CT.KHONHAP_ID ,KN.MAKHO AS MAKHONHAP, KN.TENKHO AS TENKHONHAP ,CT.KHOXUAT_ID , NULL AS MAKHOXUAT, NULL AS TENKHOXUAT ,
      CT.TRANGTHAI ,CT.PHONGBAN_ID ,PB.MAPHONGBAN ,PB.TENPHONGBAN ,PB.COSTCENTER_ID , CO.MAPHONGBAN AS COSTCENTERCODE, CO.TENPHONGBAN AS COSTCENTERNAME ,CT.BENHVIEN_ID
      ,CT.BENHVIEN_ID AS MABENHVIEN, TENBENHVIEN = @TENBENHVIEN ,
      CT.IDCHUYEN ,CT.BENHNHAN_ID ,NULL AS MAYTE, NULL AS TENBENHNHAN, NULL AS GHICHU, NULL AS CHUYENTICHHOP_ID, PV.MAPHAMVI AS PHAMVI,CT.LOAICHUNGTU, STATUSROW = CAST (0 AS BIT), MESSAGEROW = NULL
      FROM   dbo.TT_DUOC_CHUNGTU CT
      JOIN dbo.TM_KHODUOC KN ON CT.KHONHAP_ID = KN.KHODUOC_ID
      JOIN dbo.TM_NHANVIEN NN ON CT.NGUOINHAN_ID = NN.NHANVIEN_ID
      JOIN dbo.LST_DICTIONARY MDCT ON CT.MUCDICHCHUNGTU_ID = MDCT.DICTIONARY_ID
      JOIN dbo.TM_NHACUNGCAP NCC ON CT.NHACUNGCAP_ID = NCC.NHACUNGCAP_ID
      JOIN dbo.TM_PHONGBAN PB ON CT.PHONGBAN_ID = PB.PHONGBAN_ID
      LEFT JOIN dbo.TM_PHONGBAN CO ON PB.COSTCENTER_ID = CO.PHONGBAN_ID
      LEFT JOIN dbo.TM_PHAMVI PV ON KN.PHAMVI_ID = PV.PHAMVI_ID
      WHERE  CT.BENHVIEN_ID = '$BENHVIEN_ID$' AND CAST(CT.NGAYCHUNGTU AS DATE) BETWEEN '$TUNGAY$' AND '$DENNGAY$'
      AND CT.MUCDICHCHUNGTU_CODE = 'N01'
      AND CT.TRANGTHAI = 'PNDNK'
      AND CT.IDCHUYEN IS NOT NULL
      <isNotEmpty prepend="AND" property="KHONHAP_ID">
        CT.KHONHAP_ID = '$KHONHAP_ID$'
      </isNotEmpty>
      <isNotEmpty prepend="AND" property="NHACUNGCAP_ID">
        CT.NHACUNGCAP_ID = '$NHACUNGCAP_ID$'
      </isNotEmpty>
      <isNotEmpty prepend="AND" property="NGUOINHAN_ID">
        CT.NGUOINHAN_ID = '$NGUOINHAN_ID$'
      </isNotEmpty>
      <isNotEmpty prepend="AND" property="MACHUNGTU">
        CT.MACHUNGTU LIKE '%$MACHUNGTU$%'
      </isNotEmpty>
    </statement>
    <!--Lấy chi tiết chứng từ nhập ncc-->
    <statement id="DAO09800_GetDetailNHAPNCC" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      SELECT	  TICHHOP_ID = NULL,
      CT.CHUNGTU_ID ,
      LD.LOAIVATTU_ID ,
      LD.MALOAIDUOC ,
      LD.TENLOAIDUOC ,
      D.MADUOC ,
      TD.TENDUOC  ,
      DONVITINH = DVT.TENDONVITINH,
      DONVIQUICACH = DVTQD.TENDONVITINH ,
      GIATRIQUIDOI = DVTQD.GIATRIQUIDOI ,
      SOLUONG = CTCT.SOLUONGTHUCTE  ,
      DONGIA = CTCT.DONGIAMUA,
      GIATRI = CTCT.THANHTIENMUA ,
      TYLEVAT = CTCT.TYLEVAT,
      GIATRIVAT = CTCT.GIATRIVAT ,
      TYLECHIETKHAU = CTCT.TYLECHIETKHAU ,
      GIATRICHIETKHAU = CTCT.GIATRICHIETKHAU ,
      GIATRITHANHTOAN = ISNULL(CTCT.THANHTIENMUA,0) + ISNULL(CTCT.GIATRIVAT,0),
      CTCT.KHUYENMAI
      FROM   dbo.TT_DUOC_CHUNGTU CT
      JOIN dbo.TT_DUOC_CHUNGTU_CHITIET CTCT ON CTCT.CHUNGTU_ID = CT.CHUNGTU_ID
      JOIN dbo.TT_DUOC_SOLONHAP_GIABAN GB ON CTCT.SOLONHAP_ID = GB.SOLONHAP_ID
      JOIN dbo.TM_DUOC D ON CTCT.DUOC_ID = D.DUOC_ID
      JOIN dbo.TM_TENDUOC TD ON D.TENDUOC_ID = TD.TENDUOC_ID
      JOIN dbo.TM_LOAIDUOC LD ON D.LOAIDUOC_ID = LD.LOAIDUOC_ID
      JOIN dbo.TM_DONVITINH DVT ON D.DONVITINH_ID = DVT.DONVITINH_ID
      JOIN dbo.TM_DONVITINH DVTQD ON CTCT.DONVITINH_ID = DVTQD.DONVITINH_ID
      WHERE  CT.CHUNGTU_ID = '$CHUNGTU_ID$'
    </statement>

    <!--Lấy danh sách chứng từ trả ncc-->
    <statement id="DAO09800_GetMasterTRANCC" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      DECLARE @TENBENHVIEN NVARCHAR(250);
      SELECT @TENBENHVIEN = CODE
      FROM   dbo.TM_SYS_APPSETTINGS
      WHERE  BENHVIEN_ID = '$BENHVIEN_ID$' AND CODE = 'APP_BENHVIEN_TEN';

      SELECT BTNCHECK = CAST (0 AS BIT), CT.CHUNGTU_ID ,CT.MACHUNGTU ,CT.NGAYCHUNGTU ,MAMUCDICHCHUNGTU = CT.MUCDICHCHUNGTU_CODE ,TENMUCDICHCHUNGTU = MDCT.DICTIONARY_NAME ,CT.NHACUNGCAP_ID ,NCC.MANHACUNGCAP ,NCC.TENNHACUNGCAP ,
      DIACHI = NULL ,MASOTHUE = NULL ,CT.MAUHOADON ,CT.SOHOADON ,CT.SOSERI ,CT.NGAYHOADON ,CT.DIENGIAI ,CT.TIENTE_ID ,CT.TYGIA ,CT.GIATRI ,CT.TYLEVAT ,CT.GIATRIVAT ,CT.TYLECHIETKHAU ,CT.GIATRICHIETKHAU ,
      CT.GIATRITHANHTOAN ,NG.MANHANVIEN ,NG.TENNHANVIEN ,MADONHANG = NULL ,CT.KHONHAP_ID ,MAKHONHAP = NULL ,TENKHONHAP = NULL ,CT.KHOXUAT_ID ,MAKHOXUAT = KT.MAKHO ,TENKHOXUAT = KT.TENKHO ,
      CT.TRANGTHAI ,CT.PHONGBAN_ID ,PB.MAPHONGBAN ,PB.TENPHONGBAN ,PB.COSTCENTER_ID ,COSTCENTERCODE = CO.MAPHONGBAN ,COSTCENTERNAME = CO.TENPHONGBAN ,CT.BENHVIEN_ID ,MABENHVIEN = CT.BENHVIEN_ID ,
      TENBENHVIEN = @TENBENHVIEN ,CT.IDCHUYEN ,CT.BENHNHAN_ID ,MAYTE = NULL ,TENBENHNHAN = NULL ,GHICHU = NULL ,CHUYENTICHHOP_ID = NULL ,PHAMVI = PV.MAPHAMVI ,CT.LOAICHUNGTU, STATUSROW = CAST (0 AS BIT), MESSAGEROW = NULL
      FROM   dbo.TT_DUOC_CHUNGTU CT
      JOIN dbo.TT_DUOC_CHUNGTU CTLQ ON CT.CHUNGTULIENQUAN_ID = CTLQ.CHUNGTU_ID
      JOIN dbo.TM_KHODUOC KT ON CT.KHOXUAT_ID = KT.KHODUOC_ID
      JOIN dbo.TM_NHANVIEN NG ON CT.NGUOIGIAO_ID = NG.NHANVIEN_ID
      JOIN dbo.LST_DICTIONARY MDCT ON CT.MUCDICHCHUNGTU_ID = MDCT.DICTIONARY_ID
      JOIN dbo.TM_NHACUNGCAP NCC ON CTLQ.NHACUNGCAP_ID = NCC.NHACUNGCAP_ID
      JOIN dbo.TM_PHONGBAN PB ON CT.PHONGBAN_ID = PB.PHONGBAN_ID
      LEFT JOIN dbo.TM_PHONGBAN CO ON PB.COSTCENTER_ID = CO.PHONGBAN_ID
      LEFT JOIN dbo.TM_PHAMVI PV ON KT.PHAMVI_ID = PV.PHAMVI_ID
      WHERE  CT.BENHVIEN_ID = '$BENHVIEN_ID$' AND CAST(CT.NGAYCHUNGTU AS DATE) BETWEEN '$TUNGAY$' AND '$DENNGAY$'
      AND CT.MUCDICHCHUNGTU_CODE = 'X01'
      AND CT.TRANGTHAI = 'DXN'
      AND CT.IDCHUYEN IS NULL
      <isNotEmpty prepend="AND" property="KHOXUAT_ID">
        CT.KHOXUAT_ID = '$KHOXUAT_ID$'
      </isNotEmpty>
      <isNotEmpty prepend="AND" property="NHACUNGCAP_ID">
        CTLQ.NHACUNGCAP_ID = '$NHACUNGCAP_ID$'
      </isNotEmpty>
      <isNotEmpty prepend="AND" property="NGUOIXUAT_ID">
        CT.NGUOIGIAO_ID = '$NGUOIXUAT_ID$'
      </isNotEmpty>
      <isNotEmpty prepend="AND" property="MACHUNGTU">
        CT.MACHUNGTU LIKE '%$MACHUNGTU$%'
      </isNotEmpty>
    </statement>
    <!--Lấy danh sách chứng từ trả ncc đã chuyển-->
    <statement id="DAO09800_GetMasterTRANCC_DACHUYEN" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      DECLARE @TENBENHVIEN NVARCHAR(250);
      SELECT @TENBENHVIEN = CODE
      FROM   dbo.TM_SYS_APPSETTINGS
      WHERE  BENHVIEN_ID = '$BENHVIEN_ID$' AND CODE = 'APP_BENHVIEN_TEN';

      SELECT BTNCHECK = CAST (0 AS BIT), CT.CHUNGTU_ID ,CT.MACHUNGTU ,CT.NGAYCHUNGTU ,MAMUCDICHCHUNGTU = CT.MUCDICHCHUNGTU_CODE ,TENMUCDICHCHUNGTU = MDCT.DICTIONARY_NAME ,CT.NHACUNGCAP_ID ,NCC.MANHACUNGCAP ,NCC.TENNHACUNGCAP ,
      DIACHI = NULL ,MASOTHUE = NULL ,CT.MAUHOADON ,CT.SOHOADON ,CT.SOSERI ,CT.NGAYHOADON ,CT.DIENGIAI ,CT.TIENTE_ID ,CT.TYGIA ,CT.GIATRI ,CT.TYLEVAT ,CT.GIATRIVAT ,CT.TYLECHIETKHAU ,CT.GIATRICHIETKHAU ,
      CT.GIATRITHANHTOAN ,NG.MANHANVIEN ,NG.TENNHANVIEN ,MADONHANG = NULL ,CT.KHONHAP_ID ,MAKHONHAP = NULL ,TENKHONHAP = NULL ,CT.KHOXUAT_ID ,MAKHOXUAT = KT.MAKHO ,TENKHOXUAT = KT.TENKHO ,
      CT.TRANGTHAI ,CT.PHONGBAN_ID ,PB.MAPHONGBAN ,PB.TENPHONGBAN ,PB.COSTCENTER_ID ,COSTCENTERCODE = CO.MAPHONGBAN ,COSTCENTERNAME = CO.TENPHONGBAN ,CT.BENHVIEN_ID ,MABENHVIEN = CT.BENHVIEN_ID ,
      TENBENHVIEN = @TENBENHVIEN ,CT.IDCHUYEN ,CT.BENHNHAN_ID ,MAYTE = NULL ,TENBENHNHAN = NULL ,GHICHU = NULL ,CHUYENTICHHOP_ID = NULL ,PHAMVI = PV.MAPHAMVI ,CT.LOAICHUNGTU, STATUSROW = CAST (0 AS BIT), MESSAGEROW = NULL
      FROM   dbo.TT_DUOC_CHUNGTU CT
      JOIN dbo.TT_DUOC_CHUNGTU CTLQ ON CT.CHUNGTULIENQUAN_ID = CTLQ.CHUNGTU_ID
      JOIN dbo.TM_KHODUOC KT ON CT.KHOXUAT_ID = KT.KHODUOC_ID
      JOIN dbo.TM_NHANVIEN NG ON CT.NGUOIGIAO_ID = NG.NHANVIEN_ID
      JOIN dbo.LST_DICTIONARY MDCT ON CT.MUCDICHCHUNGTU_ID = MDCT.DICTIONARY_ID
      JOIN dbo.TM_NHACUNGCAP NCC ON CTLQ.NHACUNGCAP_ID = NCC.NHACUNGCAP_ID
      JOIN dbo.TM_PHONGBAN PB ON CT.PHONGBAN_ID = PB.PHONGBAN_ID
      LEFT JOIN dbo.TM_PHONGBAN CO ON PB.COSTCENTER_ID = CO.PHONGBAN_ID
      LEFT JOIN dbo.TM_PHAMVI PV ON KT.PHAMVI_ID = PV.PHAMVI_ID
      WHERE  CT.BENHVIEN_ID = '$BENHVIEN_ID$' AND CAST(CT.NGAYCHUNGTU AS DATE) BETWEEN '$TUNGAY$' AND '$DENNGAY$'
      AND CT.MUCDICHCHUNGTU_CODE = 'X01'
      AND CT.TRANGTHAI = 'DXN'
      AND CT.IDCHUYEN IS NOT NULL
      <isNotEmpty prepend="AND" property="KHOXUAT_ID">
        CT.KHOXUAT_ID = '$KHOXUAT_ID$'
      </isNotEmpty>
      <isNotEmpty prepend="AND" property="NHACUNGCAP_ID">
        CTLQ.NHACUNGCAP_ID = '$NHACUNGCAP_ID$'
      </isNotEmpty>
      <isNotEmpty prepend="AND" property="NGUOIXUAT_ID">
        CT.NGUOIGIAO_ID = '$NGUOIXUAT_ID$'
      </isNotEmpty>
      <isNotEmpty prepend="AND" property="MACHUNGTU">
        CT.MACHUNGTU LIKE '%$MACHUNGTU$%'
      </isNotEmpty>
    </statement>
    <!--Lấy chi tiết chứng từ chi tiết trả ncc-->
    <statement id="DAO09800_GetDetailTRANCC" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      SELECT	  TICHHOP_ID = NULL,
      CT.CHUNGTU_ID ,
      LD.LOAIVATTU_ID ,
      LD.MALOAIDUOC ,
      LD.TENLOAIDUOC ,
      D.MADUOC ,
      TD.TENDUOC  ,
      DONVITINH = DVT.TENDONVITINH,
      DONVIQUICACH = DVTQD.TENDONVITINH ,
      GIATRIQUIDOI = DVTQD.GIATRIQUIDOI ,
      SOLUONG = CTCT.SOLUONGDAXUAT  ,
      DONGIA = CTCT.DONGIAMUA,
      GIATRI = CTCT.THANHTIENMUA ,
      TYLEVAT = CTCT.TYLEVAT,
      GIATRIVAT = CTCT.GIATRIVAT ,
      TYLECHIETKHAU = CTCT.TYLECHIETKHAU ,
      GIATRICHIETKHAU = CTCT.GIATRICHIETKHAU ,
      GIATRITHANHTOAN = ISNULL(CTCT.THANHTIENMUA,0) + ISNULL(CTCT.GIATRIVAT,0),
      CTCT.KHUYENMAI
      FROM   dbo.TT_DUOC_CHUNGTU CT
      JOIN dbo.TT_DUOC_CHUNGTU_CHITIET CTCT ON CTCT.CHUNGTU_ID = CT.CHUNGTU_ID
      JOIN dbo.TT_DUOC_SOLONHAP_GIABAN GB ON CTCT.SOLONHAP_ID = GB.SOLONHAP_ID
      JOIN dbo.TM_DUOC D ON CTCT.DUOC_ID = D.DUOC_ID
      JOIN dbo.TM_TENDUOC TD ON D.TENDUOC_ID = TD.TENDUOC_ID
      JOIN dbo.TM_LOAIDUOC LD ON D.LOAIDUOC_ID = LD.LOAIDUOC_ID
      JOIN dbo.TM_DONVITINH DVT ON D.DONVITINH_ID = DVT.DONVITINH_ID
      JOIN dbo.TM_DONVITINH DVTQD ON CTCT.DONVITINH_ID = DVTQD.DONVITINH_ID
      WHERE  CT.CHUNGTU_ID = '$CHUNGTU_ID$'
    </statement>

    <!--Lấy danh sách chứng từ bán thuốc tại quầy-->
    <statement id="DAO09800_GetMasterBANTHUOCTAIQUAY" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      DECLARE @TENBENHVIEN NVARCHAR(250);
      SELECT @TENBENHVIEN = CODE
      FROM   dbo.TM_SYS_APPSETTINGS
      WHERE  BENHVIEN_ID = '$BENHVIEN_ID$' AND CODE = 'APP_BENHVIEN_TEN';

      SELECT BTNCHECK = CAST (0 AS BIT), CT.CHUNGTU_ID ,CT.MACHUNGTU ,CT.NGAYCHUNGTU ,CT.MUCDICHCHUNGTU_CODE AS MAMUCDICHCHUNGTU,MDCT.DICTIONARY_NAME AS TENMUCDICHCHUNGTU,CT.NHACUNGCAP_ID ,MANHACUNGCAP = NULL,TENNHACUNGCAP = NULL ,
      NULL AS DIACHI, NULL AS MASOTHUE,CT.MAUHOADON ,CT.SOHOADON ,CT.SOSERI ,CT.NGAYHOADON ,CT.DIENGIAI ,CT.TIENTE_ID ,CT.TYGIA ,CT.GIATRI ,CT.TYLEVAT ,CT.GIATRIVAT ,CT.TYLECHIETKHAU ,CT.GIATRICHIETKHAU ,
      CT.GIATRI AS GIATRITHANHTOAN ,NN.MANHANVIEN ,NN.TENNHANVIEN , NULL AS MADONHANG,CT.KHONHAP_ID ,NULL AS MAKHONHAP, NULL AS TENKHONHAP ,CT.KHOXUAT_ID , KX.MAKHO AS MAKHOXUAT, KX.TENKHO AS TENKHOXUAT ,
      CT.TRANGTHAI ,CT.PHONGBAN_ID ,PB.MAPHONGBAN ,PB.TENPHONGBAN ,PB.COSTCENTER_ID , CO.MAPHONGBAN AS COSTCENTERCODE, CO.TENPHONGBAN AS COSTCENTERNAME ,CT.BENHVIEN_ID
      ,CT.BENHVIEN_ID AS MABENHVIEN, TENBENHVIEN = @TENBENHVIEN ,
      CT.IDCHUYEN ,CT.BENHNHAN_ID ,NULL AS MAYTE, CT.TENBENHNHAN AS TENBENHNHAN, CT.DIENGIAI AS GHICHU, NULL AS CHUYENTICHHOP_ID, PV.MAPHAMVI AS PHAMVI,CT.LOAICHUNGTU, STATUSROW = CAST (0 AS BIT), MESSAGEROW = NULL
      FROM   dbo.TT_DUOC_CHUNGTU CT
      JOIN dbo.TM_KHODUOC KX ON CT.KHOXUAT_ID = KX.KHODUOC_ID
      LEFT JOIN dbo.TM_NHANVIEN NN ON CT.NGUOIGIAO_ID = NN.NHANVIEN_ID
      JOIN dbo.LST_DICTIONARY MDCT ON CT.MUCDICHCHUNGTU_ID = MDCT.DICTIONARY_ID
      JOIN dbo.TM_PHONGBAN PB ON CT.PHONGBAN_ID = PB.PHONGBAN_ID
      LEFT JOIN dbo.TM_PHONGBAN CO ON PB.COSTCENTER_ID = CO.PHONGBAN_ID
      LEFT JOIN dbo.TM_PHAMVI PV ON KX.PHAMVI_ID = PV.PHAMVI_ID
      WHERE  CT.BENHVIEN_ID = '$BENHVIEN_ID$' AND CAST(CT.NGAYCHUNGTU AS DATE) BETWEEN '$TUNGAY$' AND '$DENNGAY$'
      AND CT.MUCDICHCHUNGTU_CODE = 'X08'
      <!--AND CT.TRANGTHAI = 'PNDNK'-->
      <!--AND CT.DANHANTHUOC = 1-->
      AND CT.IDCHUYEN IS NULL
      <isNotEmpty prepend="AND" property="KHOXUAT_ID">
        CT.KHOXUAT_ID = '$KHOXUAT_ID$'
      </isNotEmpty>
      <isNotEmpty prepend="AND" property="NGUOIXUAT_ID">
        CT.NGUOIGIAO_ID = '$NGUOIXUAT_ID$'
      </isNotEmpty>
      <isNotEmpty prepend="AND" property="MACHUNGTU">
        CT.MACHUNGTU LIKE '%$MACHUNGTU$%'
      </isNotEmpty>
      <isNotEmpty prepend="AND" property="TENBENHNHAN">
        ISNULL(CT.TENBENHNHAN,'') LIKE '%$TENBENHNHAN$%'
      </isNotEmpty>
    </statement>
    <!--Lấy danh sách chứng từ bán thuốc tại quầy đã chyển-->
    <statement id="DAO09800_GetMasterBANTHUOCTAIQUAY_DACHUYEN" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      DECLARE @TENBENHVIEN NVARCHAR(250);
      SELECT @TENBENHVIEN = CODE
      FROM   dbo.TM_SYS_APPSETTINGS
      WHERE  BENHVIEN_ID = '$BENHVIEN_ID$' AND CODE = 'APP_BENHVIEN_TEN';

      SELECT BTNCHECK = CAST (0 AS BIT), CT.CHUNGTU_ID ,CT.MACHUNGTU ,CT.NGAYCHUNGTU ,CT.MUCDICHCHUNGTU_CODE AS MAMUCDICHCHUNGTU,MDCT.DICTIONARY_NAME AS TENMUCDICHCHUNGTU,CT.NHACUNGCAP_ID ,MANHACUNGCAP = NULL,TENNHACUNGCAP = NULL ,
      NULL AS DIACHI, NULL AS MASOTHUE,CT.MAUHOADON ,CT.SOHOADON ,CT.SOSERI ,CT.NGAYHOADON ,CT.DIENGIAI ,CT.TIENTE_ID ,CT.TYGIA ,CT.GIATRI ,CT.TYLEVAT ,CT.GIATRIVAT ,CT.TYLECHIETKHAU ,CT.GIATRICHIETKHAU ,
      CT.GIATRI AS GIATRITHANHTOAN ,NN.MANHANVIEN ,NN.TENNHANVIEN , NULL AS MADONHANG,CT.KHONHAP_ID ,NULL AS MAKHONHAP, NULL AS TENKHONHAP ,CT.KHOXUAT_ID , KX.MAKHO AS MAKHOXUAT, KX.TENKHO AS TENKHOXUAT ,
      CT.TRANGTHAI ,CT.PHONGBAN_ID ,PB.MAPHONGBAN ,PB.TENPHONGBAN ,PB.COSTCENTER_ID , CO.MAPHONGBAN AS COSTCENTERCODE, CO.TENPHONGBAN AS COSTCENTERNAME ,CT.BENHVIEN_ID
      ,CT.BENHVIEN_ID AS MABENHVIEN, TENBENHVIEN = @TENBENHVIEN ,
      CT.IDCHUYEN ,CT.BENHNHAN_ID ,NULL AS MAYTE, CT.TENBENHNHAN AS TENBENHNHAN, CT.DIENGIAI AS GHICHU, NULL AS CHUYENTICHHOP_ID, PV.MAPHAMVI AS PHAMVI,CT.LOAICHUNGTU, STATUSROW = CAST (0 AS BIT), MESSAGEROW = NULL
      FROM   dbo.TT_DUOC_CHUNGTU CT
      JOIN dbo.TM_KHODUOC KX ON CT.KHOXUAT_ID = KX.KHODUOC_ID
      LEFT JOIN dbo.TM_NHANVIEN NN ON CT.NGUOIGIAO_ID = NN.NHANVIEN_ID
      JOIN dbo.LST_DICTIONARY MDCT ON CT.MUCDICHCHUNGTU_ID = MDCT.DICTIONARY_ID
      JOIN dbo.TM_PHONGBAN PB ON CT.PHONGBAN_ID = PB.PHONGBAN_ID
      LEFT JOIN dbo.TM_PHONGBAN CO ON PB.COSTCENTER_ID = CO.PHONGBAN_ID
      LEFT JOIN dbo.TM_PHAMVI PV ON KX.PHAMVI_ID = PV.PHAMVI_ID
      WHERE  CT.BENHVIEN_ID = '$BENHVIEN_ID$' AND CAST(CT.NGAYCHUNGTU AS DATE) BETWEEN '$TUNGAY$' AND '$DENNGAY$'
      AND CT.MUCDICHCHUNGTU_CODE = 'X08'
      <!--AND CT.TRANGTHAI = 'PNDNK'-->
      <!--AND CT.DANHANTHUOC = 1-->
      AND CT.IDCHUYEN IS NOT NULL
      <isNotEmpty prepend="AND" property="KHOXUAT_ID">
        CT.KHOXUAT_ID = '$KHOXUAT_ID$'
      </isNotEmpty>
      <isNotEmpty prepend="AND" property="NGUOIXUAT_ID">
        CT.NGUOIGIAO_ID = '$NGUOIXUAT_ID$'
      </isNotEmpty>
      <isNotEmpty prepend="AND" property="MACHUNGTU">
        CT.MACHUNGTU LIKE '%$MACHUNGTU$%'
      </isNotEmpty>
      <isNotEmpty prepend="AND" property="TENBENHNHAN">
        ISNULL(CT.TENBENHNHAN,'') LIKE '%$TENBENHNHAN$%'
      </isNotEmpty>
    </statement>
    <!--Lấy danh sách chứng từ chi tiết bán thuốc tại quầy-->
    <statement id="DAO09800_GetDetailBANTHUOCTAIQUAY" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      SELECT	  TICHHOP_ID = NULL,
      CT.CHUNGTU_ID ,
      LD.LOAIVATTU_ID ,
      LD.MALOAIDUOC ,
      LD.TENLOAIDUOC ,
      D.MADUOC ,
      TD.TENDUOC  ,
      DONVITINH = DVT.TENDONVITINH,
      DONVIQUICACH = DVTQD.TENDONVITINH ,
      GIATRIQUIDOI = DVTQD.GIATRIQUIDOI ,
      SOLUONG = CTCT.SOLUONGDAXUAT  ,
      DONGIA = CTCT.DONGIAMUA,
      GIATRI = CTCT.SOLUONGDAXUAT *  CTCT.DONGIABAN,
      TYLEVAT = CTCT.TYLEVAT,
      GIATRIVAT = CTCT.GIATRIVAT ,
      TYLECHIETKHAU = CTCT.TYLECHIETKHAU ,
      GIATRICHIETKHAU = CTCT.GIATRICHIETKHAU ,
      GIATRITHANHTOAN = ISNULL( CTCT.SOLUONGDAXUAT *  CTCT.DONGIABAN,0) ,
      CTCT.KHUYENMAI
      FROM   dbo.TT_DUOC_CHUNGTU CT
      JOIN dbo.TT_DUOC_CHUNGTU_CHITIET CTCT ON CTCT.CHUNGTU_ID = CT.CHUNGTU_ID
      JOIN dbo.TT_DUOC_SOLONHAP_GIABAN GB ON CTCT.SOLONHAP_ID = GB.SOLONHAP_ID
      JOIN dbo.TM_DUOC D ON CTCT.DUOC_ID = D.DUOC_ID
      JOIN dbo.TM_TENDUOC TD ON D.TENDUOC_ID = TD.TENDUOC_ID
      JOIN dbo.TM_LOAIDUOC LD ON D.LOAIDUOC_ID = LD.LOAIDUOC_ID
      JOIN dbo.TM_DONVITINH DVT ON D.DONVITINH_ID = DVT.DONVITINH_ID
      JOIN dbo.TM_DONVITINH DVTQD ON CTCT.DONVITINH_ID = DVTQD.DONVITINH_ID
      WHERE  CT.CHUNGTU_ID = '$CHUNGTU_ID$'
    </statement>

    <!--Lấy danh sách chứng từ trả thuốc tại quầy-->
    <statement id="DAO09800_GetMasterTRATHUOCTAIQUAY" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      DECLARE @TENBENHVIEN NVARCHAR(250);
      SELECT @TENBENHVIEN = CODE
      FROM   dbo.TM_SYS_APPSETTINGS
      WHERE  BENHVIEN_ID = '$BENHVIEN_ID$' AND CODE = 'APP_BENHVIEN_TEN';

      SELECT BTNCHECK = CAST (0 AS BIT), CT.CHUNGTU_ID ,CT.MACHUNGTU ,CT.NGAYCHUNGTU ,CT.MUCDICHCHUNGTU_CODE AS MAMUCDICHCHUNGTU,MDCT.DICTIONARY_NAME AS TENMUCDICHCHUNGTU,CT.NHACUNGCAP_ID ,MANHACUNGCAP = NULL,TENNHACUNGCAP = NULL ,
      NULL AS DIACHI, NULL AS MASOTHUE,CT.MAUHOADON ,CT.SOHOADON ,CT.SOSERI ,CT.NGAYHOADON ,CT.DIENGIAI ,CT.TIENTE_ID ,CT.TYGIA ,CT.GIATRI ,CT.TYLEVAT ,CT.GIATRIVAT ,CT.TYLECHIETKHAU ,CT.GIATRICHIETKHAU ,
      ISNULL(CT.GIATRI,CTCT.GIATRITHANHTOAN) AS GIATRITHANHTOAN ,NN.MANHANVIEN ,NN.TENNHANVIEN , NULL AS MADONHANG,CT.KHONHAP_ID ,KN.MAKHO AS MAKHONHAP,KN.TENKHO AS TENKHONHAP ,CT.KHOXUAT_ID, NULL AS MAKHOXUAT, NULL AS TENKHOXUAT,
      CT.TRANGTHAI ,CT.PHONGBAN_ID ,PB.MAPHONGBAN ,PB.TENPHONGBAN ,PB.COSTCENTER_ID , CO.MAPHONGBAN AS COSTCENTERCODE, CO.TENPHONGBAN AS COSTCENTERNAME ,CT.BENHVIEN_ID
      ,CT.BENHVIEN_ID AS MABENHVIEN, TENBENHVIEN = @TENBENHVIEN ,
      CT.IDCHUYEN ,CT.BENHNHAN_ID ,NULL AS MAYTE, CT.TENBENHNHAN AS TENBENHNHAN, CT.DIENGIAI AS GHICHU, NULL AS CHUYENTICHHOP_ID, PV.MAPHAMVI AS PHAMVI,CT.LOAICHUNGTU, STATUSROW = CAST (0 AS BIT), MESSAGEROW = NULL
      FROM   dbo.TT_DUOC_CHUNGTU CT
      JOIN dbo.TM_KHODUOC KN ON CT.KHONHAP_ID = KN.KHODUOC_ID
      CROSS APPLY(SELECT SUM(ISNULL( CTCT.SOLUONGTHUCTE *  CTCT.DONGIABAN_VAT,0)) AS GIATRITHANHTOAN FROM dbo.TT_DUOC_CHUNGTU_CHITIET CTCT WHERE CTCT.CHUNGTU_ID = CT.CHUNGTU_ID) CTCT
      LEFT JOIN dbo.TM_NHANVIEN NN ON CT.NGUOINHAN_ID = NN.NHANVIEN_ID
      JOIN dbo.LST_DICTIONARY MDCT ON CT.MUCDICHCHUNGTU_ID = MDCT.DICTIONARY_ID
      JOIN dbo.TM_PHONGBAN PB ON CT.PHONGBAN_ID = PB.PHONGBAN_ID
      LEFT JOIN dbo.TM_PHONGBAN CO ON PB.COSTCENTER_ID = CO.PHONGBAN_ID
      LEFT JOIN dbo.TM_PHAMVI PV ON KN.PHAMVI_ID = PV.PHAMVI_ID
      WHERE  CT.BENHVIEN_ID = '$BENHVIEN_ID$' AND CAST(CT.NGAYCHUNGTU AS DATE) BETWEEN '$TUNGAY$' AND '$DENNGAY$'
      AND CT.MUCDICHCHUNGTU_CODE = 'N06'
      AND CT.IDCHUYEN IS NULL
      <isNotEmpty prepend="AND" property="KHONHAP_ID">
        CT.KHONHAP_ID = '$KHONHAP_ID$'
      </isNotEmpty>
      <isNotEmpty prepend="AND" property="NGUOINHAP_ID">
        CT.NGUOINHAN_ID = '$NGUOINHAP_ID$'
      </isNotEmpty>
      <isNotEmpty prepend="AND" property="MACHUNGTU">
        CT.MACHUNGTU LIKE '%$MACHUNGTU$%'
      </isNotEmpty>
      <isNotEmpty prepend="AND" property="TENBENHNHAN">
        ISNULL(CT.TENBENHNHAN,'') LIKE '%$TENBENHNHAN$%'
      </isNotEmpty>
    </statement>
    <!--Lấy danh sách chứng từ trả thuốc tại quầy đã chuyển-->
    <statement id="DAO09800_GetMasterTRATHUOCTAIQUAY_DACHUYEN" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      DECLARE @TENBENHVIEN NVARCHAR(250);
      SELECT @TENBENHVIEN = CODE
      FROM   dbo.TM_SYS_APPSETTINGS
      WHERE  BENHVIEN_ID = '$BENHVIEN_ID$' AND CODE = 'APP_BENHVIEN_TEN';

      SELECT BTNCHECK = CAST (0 AS BIT), CT.CHUNGTU_ID ,CT.MACHUNGTU ,CT.NGAYCHUNGTU ,CT.MUCDICHCHUNGTU_CODE AS MAMUCDICHCHUNGTU,MDCT.DICTIONARY_NAME AS TENMUCDICHCHUNGTU,CT.NHACUNGCAP_ID ,MANHACUNGCAP = NULL,TENNHACUNGCAP = NULL ,
      NULL AS DIACHI, NULL AS MASOTHUE,CT.MAUHOADON ,CT.SOHOADON ,CT.SOSERI ,CT.NGAYHOADON ,CT.DIENGIAI ,CT.TIENTE_ID ,CT.TYGIA ,CT.GIATRI ,CT.TYLEVAT ,CT.GIATRIVAT ,CT.TYLECHIETKHAU ,CT.GIATRICHIETKHAU ,
      ISNULL(CT.GIATRI,CTCT.GIATRITHANHTOAN) AS GIATRITHANHTOAN ,NN.MANHANVIEN ,NN.TENNHANVIEN , NULL AS MADONHANG,CT.KHONHAP_ID ,KN.MAKHO AS MAKHONHAP,KN.TENKHO AS TENKHONHAP ,CT.KHOXUAT_ID, NULL AS MAKHOXUAT, NULL AS TENKHOXUAT,
      CT.TRANGTHAI ,CT.PHONGBAN_ID ,PB.MAPHONGBAN ,PB.TENPHONGBAN ,PB.COSTCENTER_ID , CO.MAPHONGBAN AS COSTCENTERCODE, CO.TENPHONGBAN AS COSTCENTERNAME ,CT.BENHVIEN_ID
      ,CT.BENHVIEN_ID AS MABENHVIEN, TENBENHVIEN = @TENBENHVIEN ,
      CT.IDCHUYEN ,CT.BENHNHAN_ID ,NULL AS MAYTE, CT.TENBENHNHAN AS TENBENHNHAN, CT.DIENGIAI AS GHICHU, NULL AS CHUYENTICHHOP_ID, PV.MAPHAMVI AS PHAMVI,CT.LOAICHUNGTU, STATUSROW = CAST (0 AS BIT), MESSAGEROW = NULL
      FROM   dbo.TT_DUOC_CHUNGTU CT
      CROSS APPLY(SELECT SUM(ISNULL( CTCT.SOLUONGTHUCTE *  CTCT.DONGIABAN_VAT,0)) AS GIATRITHANHTOAN FROM dbo.TT_DUOC_CHUNGTU_CHITIET CTCT WHERE CTCT.CHUNGTU_ID = CT.CHUNGTU_ID) CTCT
      JOIN dbo.TM_KHODUOC KN ON CT.KHONHAP_ID = KN.KHODUOC_ID
      LEFT JOIN dbo.TM_NHANVIEN NN ON CT.NGUOINHAP_ID = NN.NHANVIEN_ID
      JOIN dbo.LST_DICTIONARY MDCT ON CT.MUCDICHCHUNGTU_ID = MDCT.DICTIONARY_ID
      JOIN dbo.TM_PHONGBAN PB ON CT.PHONGBAN_ID = PB.PHONGBAN_ID
      LEFT JOIN dbo.TM_PHONGBAN CO ON PB.COSTCENTER_ID = CO.PHONGBAN_ID
      LEFT JOIN dbo.TM_PHAMVI PV ON KN.PHAMVI_ID = PV.PHAMVI_ID
      WHERE  CT.BENHVIEN_ID = '$BENHVIEN_ID$' AND CAST(CT.NGAYCHUNGTU AS DATE) BETWEEN '$TUNGAY$' AND '$DENNGAY$'
      AND CT.MUCDICHCHUNGTU_CODE = 'N06'
      AND CT.IDCHUYEN IS NOT NULL
      <isNotEmpty prepend="AND" property="KHONHAP_ID">
        CT.KHONHAP_ID = '$KHONHAP_ID$'
      </isNotEmpty>
      <isNotEmpty prepend="AND" property="NGUOINHAP_ID">
        CT.NGUOINHAN_ID = '$NGUOINHAP_ID$'
      </isNotEmpty>
      <isNotEmpty prepend="AND" property="MACHUNGTU">
        CT.MACHUNGTU LIKE '%$MACHUNGTU$%'
      </isNotEmpty>
      <isNotEmpty prepend="AND" property="TENBENHNHAN">
        ISNULL(CT.TENBENHNHAN,'') LIKE '%$TENBENHNHAN$%'
      </isNotEmpty>
    </statement>
    <!--Lấy danh sách chứng từ chi tiết trả thuốc tại quầy-->
    <statement id="DAO09800_GetDetailTRATHUOCTAIQUAY" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      SELECT	  TICHHOP_ID = NULL,
      CT.CHUNGTU_ID ,
      LD.LOAIVATTU_ID ,
      LD.MALOAIDUOC ,
      LD.TENLOAIDUOC ,
      D.MADUOC ,
      TD.TENDUOC  ,
      DONVITINH = DVT.TENDONVITINH,
      DONVIQUICACH = DVTQD.TENDONVITINH ,
      GIATRIQUIDOI = DVTQD.GIATRIQUIDOI ,
      SOLUONG = CTCT.SOLUONGTHUCTE  ,
      DONGIA = CTCT.DONGIABAN_VAT,
      GIATRI = CTCT.SOLUONGTHUCTE *  CTCT.DONGIABAN_VAT,
      TYLEVAT = CTCT.TYLEVAT,
      GIATRIVAT = CTCT.GIATRIVAT ,
      TYLECHIETKHAU = CTCT.TYLECHIETKHAU ,
      GIATRICHIETKHAU = CTCT.GIATRICHIETKHAU ,
      GIATRITHANHTOAN = ISNULL( CTCT.SOLUONGTHUCTE *  CTCT.DONGIABAN_VAT,0) ,
      CTCT.KHUYENMAI
      FROM   dbo.TT_DUOC_CHUNGTU CT
      JOIN dbo.TT_DUOC_CHUNGTU_CHITIET CTCT ON CTCT.CHUNGTU_ID = CT.CHUNGTU_ID
      JOIN dbo.TT_DUOC_SOLONHAP_GIABAN GB ON CTCT.SOLONHAP_ID = GB.SOLONHAP_ID
      JOIN dbo.TM_DUOC D ON CTCT.DUOC_ID = D.DUOC_ID
      JOIN dbo.TM_TENDUOC TD ON D.TENDUOC_ID = TD.TENDUOC_ID
      JOIN dbo.TM_LOAIDUOC LD ON D.LOAIDUOC_ID = LD.LOAIDUOC_ID
      JOIN dbo.TM_DONVITINH DVT ON D.DONVITINH_ID = DVT.DONVITINH_ID
      JOIN dbo.TM_DONVITINH DVTQD ON CTCT.DONVITINH_ID = DVTQD.DONVITINH_ID
      WHERE  CT.CHUNGTU_ID = '$CHUNGTU_ID$'
    </statement>

    <!--Lấy danh sách chứng từ điều chỉnh tăng-->
    <statement id="DAO09800_GetMasterDuoc_DieuChinhTang" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      DECLARE @TENBENHVIEN NVARCHAR(250);
      SELECT  @TENBENHVIEN = CODE
      FROM    dbo.TM_SYS_APPSETTINGS
      WHERE   BENHVIEN_ID = '$BENHVIEN_ID$'
      AND CODE = 'APP_BENHVIEN_TEN';

      SELECT  BTNCHECK = CAST (0 AS BIT) ,CT.CHUNGTU_ID ,CT.MACHUNGTU ,CT.NGAYCHUNGTU ,CT.MUCDICHCHUNGTU_CODE AS MAMUCDICHCHUNGTU ,MDCT.DICTIONARY_NAME AS TENMUCDICHCHUNGTU ,
      CT.NHACUNGCAP_ID ,MANHACUNGCAP = NULL ,TENNHACUNGCAP = NULL ,NULL AS DIACHI ,NULL AS MASOTHUE ,CT.MAUHOADON ,CT.SOHOADON ,CT.SOSERI ,CT.NGAYHOADON ,CT.DIENGIAI ,
      CT.TIENTE_ID ,
      CT.TYGIA ,
      CT.GIATRI ,
      CT.TYLEVAT ,
      CT.GIATRIVAT ,
      CT.TYLECHIETKHAU ,
      CT.GIATRICHIETKHAU ,
      ISNULL(CT.GIATRI, CTCT.GIATRITHANHTOAN) AS GIATRITHANHTOAN ,
      NN.MANHANVIEN ,
      NN.TENNHANVIEN ,
      NULL AS MADONHANG ,
      CT.KHONHAP_ID ,
      KN.MAKHO AS MAKHONHAP ,
      KN.TENKHO AS TENKHONHAP ,
      CT.KHOXUAT_ID ,
      NULL AS MAKHOXUAT ,
      NULL AS TENKHOXUAT ,
      CT.TRANGTHAI ,
      CT.PHONGBAN_ID ,
      PB.MAPHONGBAN ,
      PB.TENPHONGBAN ,
      PB.COSTCENTER_ID ,
      CO.MAPHONGBAN AS COSTCENTERCODE ,
      CO.TENPHONGBAN AS COSTCENTERNAME ,
      CT.BENHVIEN_ID ,
      CT.BENHVIEN_ID AS MABENHVIEN ,
      TENBENHVIEN = @TENBENHVIEN ,
      CT.IDCHUYEN ,
      CT.BENHNHAN_ID ,
      NULL AS MAYTE ,
      CT.TENBENHNHAN AS TENBENHNHAN ,
      CT.DIENGIAI AS GHICHU ,
      NULL AS CHUYENTICHHOP_ID ,
      PV.MAPHAMVI AS PHAMVI ,
      CT.LOAICHUNGTU ,
      STATUSROW = CAST (0 AS BIT) ,
      MESSAGEROW = NULL
      FROM    dbo.TT_DUOC_CHUNGTU CT
      JOIN dbo.TM_KHODUOC KN ON CT.KHONHAP_ID = KN.KHODUOC_ID
      CROSS APPLY ( SELECT    SUM(CTCT.SOLUONGTHUCTE * CTCT.DONGIABAN_VAT) AS GIATRITHANHTOAN
      FROM      dbo.TT_DUOC_CHUNGTU_CHITIET CTCT
      WHERE     CTCT.CHUNGTU_ID = CT.CHUNGTU_ID
      ) CTCT
      LEFT JOIN dbo.TM_NHANVIEN NN ON CT.NGUOINHAN_ID = NN.NHANVIEN_ID
      JOIN dbo.LST_DICTIONARY MDCT ON CT.MUCDICHCHUNGTU_ID = MDCT.DICTIONARY_ID
      JOIN dbo.TM_PHONGBAN PB ON CT.PHONGBAN_ID = PB.PHONGBAN_ID
      LEFT JOIN dbo.TM_PHONGBAN CO ON PB.COSTCENTER_ID = CO.PHONGBAN_ID
      LEFT JOIN dbo.TM_PHAMVI PV ON KN.PHAMVI_ID = PV.PHAMVI_ID
      WHERE   CT.BENHVIEN_ID = '$BENHVIEN_ID$' AND CAST(CT.NGAYCHUNGTU AS DATE) BETWEEN '$TUNGAY$' AND '$DENNGAY$'
      AND CT.MUCDICHCHUNGTU_CODE = 'N04'
      AND CT.IDCHUYEN IS NULL
      <isNotEmpty prepend="AND" property="KHONHAP_ID">
        CT.KHONHAP_ID = '$KHONHAP_ID$'
      </isNotEmpty>
      <isNotEmpty prepend="AND" property="NGUOINHAP_ID">
        CT.NGUOINHAN_ID = '$NGUOINHAP_ID$'
      </isNotEmpty>
      <isNotEmpty prepend="AND" property="MACHUNGTU">
        CT.MACHUNGTU LIKE '%$MACHUNGTU$%'
      </isNotEmpty>
    </statement>
    <!--Lấy danh sách chứng từ điều chỉnh tăng đã chuyển-->
    <statement id="DAO09800_GetMasterDuoc_DieuChinhTang_DACHUYEN" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      DECLARE @TENBENHVIEN NVARCHAR(250);
      SELECT  @TENBENHVIEN = CODE
      FROM    dbo.TM_SYS_APPSETTINGS
      WHERE   BENHVIEN_ID = '$BENHVIEN_ID$'
      AND CODE = 'APP_BENHVIEN_TEN';

      SELECT  BTNCHECK = CAST (0 AS BIT) ,
      CT.CHUNGTU_ID ,
      CT.MACHUNGTU ,
      CT.NGAYCHUNGTU ,
      CT.MUCDICHCHUNGTU_CODE AS MAMUCDICHCHUNGTU ,
      MDCT.DICTIONARY_NAME AS TENMUCDICHCHUNGTU ,
      CT.NHACUNGCAP_ID ,
      MANHACUNGCAP = NULL ,
      TENNHACUNGCAP = NULL ,
      NULL AS DIACHI ,
      NULL AS MASOTHUE ,
      CT.MAUHOADON ,
      CT.SOHOADON ,
      CT.SOSERI ,
      CT.NGAYHOADON ,
      CT.DIENGIAI ,
      CT.TIENTE_ID ,
      CT.TYGIA ,
      CT.GIATRI ,
      CT.TYLEVAT ,
      CT.GIATRIVAT ,
      CT.TYLECHIETKHAU ,
      CT.GIATRICHIETKHAU ,
      ISNULL(CT.GIATRI, CTCT.GIATRITHANHTOAN) AS GIATRITHANHTOAN ,
      NN.MANHANVIEN ,
      NN.TENNHANVIEN ,
      NULL AS MADONHANG ,
      CT.KHONHAP_ID ,
      KN.MAKHO AS MAKHONHAP ,
      KN.TENKHO AS TENKHONHAP ,
      CT.KHOXUAT_ID ,
      NULL AS MAKHOXUAT ,
      NULL AS TENKHOXUAT ,
      CT.TRANGTHAI ,
      CT.PHONGBAN_ID ,
      PB.MAPHONGBAN ,
      PB.TENPHONGBAN ,
      PB.COSTCENTER_ID ,
      CO.MAPHONGBAN AS COSTCENTERCODE ,
      CO.TENPHONGBAN AS COSTCENTERNAME ,
      CT.BENHVIEN_ID ,
      CT.BENHVIEN_ID AS MABENHVIEN ,
      TENBENHVIEN = @TENBENHVIEN ,
      CT.IDCHUYEN ,
      CT.BENHNHAN_ID ,
      NULL AS MAYTE ,
      CT.TENBENHNHAN AS TENBENHNHAN ,
      CT.DIENGIAI AS GHICHU ,
      NULL AS CHUYENTICHHOP_ID ,
      PV.MAPHAMVI AS PHAMVI ,
      CT.LOAICHUNGTU ,
      STATUSROW = CAST (0 AS BIT) ,
      MESSAGEROW = NULL
      FROM    dbo.TT_DUOC_CHUNGTU CT
      JOIN dbo.TM_KHODUOC KN ON CT.KHONHAP_ID = KN.KHODUOC_ID
      CROSS APPLY ( SELECT    SUM(CTCT.SOLUONGTHUCTE * CTCT.DONGIABAN_VAT) AS GIATRITHANHTOAN
      FROM      dbo.TT_DUOC_CHUNGTU_CHITIET CTCT
      WHERE     CTCT.CHUNGTU_ID = CT.CHUNGTU_ID
      ) CTCT
      LEFT JOIN dbo.TM_NHANVIEN NN ON CT.NGUOINHAN_ID = NN.NHANVIEN_ID
      JOIN dbo.LST_DICTIONARY MDCT ON CT.MUCDICHCHUNGTU_ID = MDCT.DICTIONARY_ID
      JOIN dbo.TM_PHONGBAN PB ON CT.PHONGBAN_ID = PB.PHONGBAN_ID
      LEFT JOIN dbo.TM_PHONGBAN CO ON PB.COSTCENTER_ID = CO.PHONGBAN_ID
      LEFT JOIN dbo.TM_PHAMVI PV ON KN.PHAMVI_ID = PV.PHAMVI_ID
      WHERE   CT.BENHVIEN_ID = '$BENHVIEN_ID$' AND CAST(CT.NGAYCHUNGTU AS DATE) BETWEEN '$TUNGAY$' AND '$DENNGAY$'
      AND CT.MUCDICHCHUNGTU_CODE = 'N04'
      AND CT.IDCHUYEN IS NOT NULL
      <isNotEmpty prepend="AND" property="KHONHAP_ID">
        CT.KHONHAP_ID = '$KHONHAP_ID$'
      </isNotEmpty>
      <isNotEmpty prepend="AND" property="NGUOINHAP_ID">
        CT.NGUOINHAN_ID = '$NGUOINHAP_ID$'
      </isNotEmpty>
      <isNotEmpty prepend="AND" property="MACHUNGTU">
        CT.MACHUNGTU LIKE '%$MACHUNGTU$%'
      </isNotEmpty>
    </statement>
    <!--Lấy danh sách chứng từ chi tiết điều chỉnh tăng-->
    <statement id="DAO09800_GetDetailDuoc_DieuChinhTang" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      SELECT	  TICHHOP_ID = NULL,
      CT.CHUNGTU_ID ,
      LD.LOAIVATTU_ID ,
      LD.MALOAIDUOC ,
      LD.TENLOAIDUOC ,
      D.MADUOC ,
      TD.TENDUOC  ,
      DONVITINH = DVT.TENDONVITINH,
      DONVIQUICACH = DVTQD.TENDONVITINH ,
      GIATRIQUIDOI = DVTQD.GIATRIQUIDOI ,
      SOLUONG = CTCT.SOLUONGTHUCTE  ,
      DONGIA = CTCT.DONGIABAN_VAT,
      GIATRI = CTCT.SOLUONGTHUCTE *  CTCT.DONGIABAN_VAT,
      TYLEVAT = CTCT.TYLEVAT,
      GIATRIVAT = CTCT.GIATRIVAT ,
      TYLECHIETKHAU = CTCT.TYLECHIETKHAU ,
      GIATRICHIETKHAU = CTCT.GIATRICHIETKHAU ,
      GIATRITHANHTOAN = ISNULL( CTCT.SOLUONGTHUCTE *  CTCT.DONGIABAN_VAT,0) ,
      CTCT.KHUYENMAI
      FROM   dbo.TT_DUOC_CHUNGTU CT
      JOIN dbo.TT_DUOC_CHUNGTU_CHITIET CTCT ON CTCT.CHUNGTU_ID = CT.CHUNGTU_ID
      JOIN dbo.TT_DUOC_SOLONHAP_GIABAN GB ON CTCT.SOLONHAP_ID = GB.SOLONHAP_ID
      JOIN dbo.TM_DUOC D ON CTCT.DUOC_ID = D.DUOC_ID
      JOIN dbo.TM_TENDUOC TD ON D.TENDUOC_ID = TD.TENDUOC_ID
      JOIN dbo.TM_LOAIDUOC LD ON D.LOAIDUOC_ID = LD.LOAIDUOC_ID
      JOIN dbo.TM_DONVITINH DVT ON D.DONVITINH_ID = DVT.DONVITINH_ID
      JOIN dbo.TM_DONVITINH DVTQD ON CTCT.DONVITINH_ID = DVTQD.DONVITINH_ID
      WHERE  CT.CHUNGTU_ID = '$CHUNGTU_ID$'
    </statement>

    <!--Lấy danh sách chứng từ điều chỉnh giảm-->
    <statement id="DAO09800_GetMasterDuoc_DieuChinhGiam" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      DECLARE @TENBENHVIEN NVARCHAR(250);
      SELECT  @TENBENHVIEN = CODE
      FROM    dbo.TM_SYS_APPSETTINGS
      WHERE   BENHVIEN_ID = '$BENHVIEN_ID$'
      AND CODE = 'APP_BENHVIEN_TEN';

      SELECT  BTNCHECK = CAST (0 AS BIT) ,
      CT.CHUNGTU_ID ,
      CT.MACHUNGTU ,
      CT.NGAYCHUNGTU ,
      CT.MUCDICHCHUNGTU_CODE AS MAMUCDICHCHUNGTU ,
      MDCT.DICTIONARY_NAME AS TENMUCDICHCHUNGTU ,
      CT.NHACUNGCAP_ID ,
      MANHACUNGCAP = NULL ,
      TENNHACUNGCAP = NULL ,
      NULL AS DIACHI ,
      NULL AS MASOTHUE ,
      CT.MAUHOADON ,
      CT.SOHOADON ,
      CT.SOSERI ,
      CT.NGAYHOADON ,
      CT.DIENGIAI ,
      CT.TIENTE_ID ,
      CT.TYGIA ,
      CT.GIATRI ,
      CT.TYLEVAT ,
      CT.GIATRIVAT ,
      CT.TYLECHIETKHAU ,
      CT.GIATRICHIETKHAU ,
      ISNULL(CT.GIATRI, CTCT.GIATRITHANHTOAN) AS GIATRITHANHTOAN ,
      NX.MANHANVIEN ,
      NX.TENNHANVIEN ,
      NULL AS MADONHANG ,
      CT.KHONHAP_ID ,
      NULL AS MAKHONHAP ,
      NULL AS TENKHONHAP ,
      CT.KHOXUAT_ID ,
      KX.MAKHO AS MAKHOXUAT ,
      KX.TENKHO AS TENKHOXUAT ,
      CT.TRANGTHAI ,
      CT.PHONGBAN_ID ,
      PB.MAPHONGBAN ,
      PB.TENPHONGBAN ,
      PB.COSTCENTER_ID ,
      CO.MAPHONGBAN AS COSTCENTERCODE ,
      CO.TENPHONGBAN AS COSTCENTERNAME ,
      CT.BENHVIEN_ID ,
      CT.BENHVIEN_ID AS MABENHVIEN ,
      TENBENHVIEN = @TENBENHVIEN ,
      CT.IDCHUYEN ,
      CT.BENHNHAN_ID ,
      NULL AS MAYTE ,
      CT.TENBENHNHAN AS TENBENHNHAN ,
      CT.DIENGIAI AS GHICHU ,
      NULL AS CHUYENTICHHOP_ID ,
      PV.MAPHAMVI AS PHAMVI ,
      CT.LOAICHUNGTU ,
      STATUSROW = CAST (0 AS BIT) ,
      MESSAGEROW = NULL
      FROM    dbo.TT_DUOC_CHUNGTU CT
      JOIN dbo.TM_KHODUOC KX ON CT.KHOXUAT_ID = KX.KHODUOC_ID
      CROSS APPLY ( SELECT    SUM(CTCT.SOLUONGDAXUAT * CTCT.DONGIABAN_VAT) AS GIATRITHANHTOAN
      FROM      dbo.TT_DUOC_CHUNGTU_CHITIET CTCT
      WHERE     CTCT.CHUNGTU_ID = CT.CHUNGTU_ID
      ) CTCT
      LEFT JOIN dbo.TM_NHANVIEN NX ON CT.NGUOIGIAO_ID = NX.NHANVIEN_ID
      JOIN dbo.LST_DICTIONARY MDCT ON CT.MUCDICHCHUNGTU_ID = MDCT.DICTIONARY_ID
      JOIN dbo.TM_PHONGBAN PB ON CT.PHONGBAN_ID = PB.PHONGBAN_ID
      LEFT JOIN dbo.TM_PHONGBAN CO ON PB.COSTCENTER_ID = CO.PHONGBAN_ID
      LEFT JOIN dbo.TM_PHAMVI PV ON KX.PHAMVI_ID = PV.PHAMVI_ID
      WHERE   CT.BENHVIEN_ID = '$BENHVIEN_ID$' AND CAST(CT.NGAYCHUNGTU AS DATE) BETWEEN '$TUNGAY$' AND '$DENNGAY$'
      AND CT.MUCDICHCHUNGTU_CODE = 'X04'
      AND CT.IDCHUYEN IS NULL
      <isNotEmpty prepend="AND" property="KHOXUAT_ID">
        CT.KHOXUAT_ID = '$KHOXUAT_ID$'
      </isNotEmpty>
      <isNotEmpty prepend="AND" property="NGUOIXUAT_ID">
        CT.NGUOIGIAO_ID = '$NGUOIXUAT_ID$'
      </isNotEmpty>
      <isNotEmpty prepend="AND" property="MACHUNGTU">
        CT.MACHUNGTU LIKE '%$MACHUNGTU$%'
      </isNotEmpty>
    </statement>
    <!--Lấy danh sách chứng từ điều chỉnh giảm đã chuyển-->
    <statement id="DAO09800_GetMasterDuoc_DieuChinhGiam_DACHUYEN" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      DECLARE @TENBENHVIEN NVARCHAR(250);
      SELECT  @TENBENHVIEN = CODE
      FROM    dbo.TM_SYS_APPSETTINGS
      WHERE   BENHVIEN_ID = '$BENHVIEN_ID$'
      AND CODE = 'APP_BENHVIEN_TEN';

      SELECT  BTNCHECK = CAST (0 AS BIT) ,
      CT.CHUNGTU_ID ,
      CT.MACHUNGTU ,
      CT.NGAYCHUNGTU ,
      CT.MUCDICHCHUNGTU_CODE AS MAMUCDICHCHUNGTU ,
      MDCT.DICTIONARY_NAME AS TENMUCDICHCHUNGTU ,
      CT.NHACUNGCAP_ID ,
      MANHACUNGCAP = NULL ,
      TENNHACUNGCAP = NULL ,
      NULL AS DIACHI ,
      NULL AS MASOTHUE ,
      CT.MAUHOADON ,
      CT.SOHOADON ,
      CT.SOSERI ,
      CT.NGAYHOADON ,
      CT.DIENGIAI ,
      CT.TIENTE_ID ,
      CT.TYGIA ,
      CT.GIATRI ,
      CT.TYLEVAT ,
      CT.GIATRIVAT ,
      CT.TYLECHIETKHAU ,
      CT.GIATRICHIETKHAU ,
      ISNULL(CT.GIATRI, CTCT.GIATRITHANHTOAN) AS GIATRITHANHTOAN ,
      NX.MANHANVIEN ,
      NX.TENNHANVIEN ,
      NULL AS MADONHANG ,
      CT.KHONHAP_ID ,
      NULL AS MAKHONHAP ,
      NULL AS TENKHONHAP ,
      CT.KHOXUAT_ID ,
      KX.MAKHO AS MAKHOXUAT ,
      KX.TENKHO AS TENKHOXUAT ,
      CT.TRANGTHAI ,
      CT.PHONGBAN_ID ,
      PB.MAPHONGBAN ,
      PB.TENPHONGBAN ,
      PB.COSTCENTER_ID ,
      CO.MAPHONGBAN AS COSTCENTERCODE ,
      CO.TENPHONGBAN AS COSTCENTERNAME ,
      CT.BENHVIEN_ID ,
      CT.BENHVIEN_ID AS MABENHVIEN ,
      TENBENHVIEN = @TENBENHVIEN ,
      CT.IDCHUYEN ,
      CT.BENHNHAN_ID ,
      NULL AS MAYTE ,
      CT.TENBENHNHAN AS TENBENHNHAN ,
      CT.DIENGIAI AS GHICHU ,
      NULL AS CHUYENTICHHOP_ID ,
      PV.MAPHAMVI AS PHAMVI ,
      CT.LOAICHUNGTU ,
      STATUSROW = CAST (0 AS BIT) ,
      MESSAGEROW = NULL
      FROM    dbo.TT_DUOC_CHUNGTU CT
      JOIN dbo.TM_KHODUOC KX ON CT.KHOXUAT_ID = KX.KHODUOC_ID
      CROSS APPLY ( SELECT    SUM(CTCT.SOLUONGDAXUAT * CTCT.DONGIABAN_VAT) AS GIATRITHANHTOAN
      FROM      dbo.TT_DUOC_CHUNGTU_CHITIET CTCT
      WHERE     CTCT.CHUNGTU_ID = CT.CHUNGTU_ID
      ) CTCT
      LEFT JOIN dbo.TM_NHANVIEN NX ON CT.NGUOIGIAO_ID = NX.NHANVIEN_ID
      JOIN dbo.LST_DICTIONARY MDCT ON CT.MUCDICHCHUNGTU_ID = MDCT.DICTIONARY_ID
      JOIN dbo.TM_PHONGBAN PB ON CT.PHONGBAN_ID = PB.PHONGBAN_ID
      LEFT JOIN dbo.TM_PHONGBAN CO ON PB.COSTCENTER_ID = CO.PHONGBAN_ID
      LEFT JOIN dbo.TM_PHAMVI PV ON KX.PHAMVI_ID = PV.PHAMVI_ID
      WHERE   CT.BENHVIEN_ID = '$BENHVIEN_ID$' AND CAST(CT.NGAYCHUNGTU AS DATE) BETWEEN '$TUNGAY$' AND '$DENNGAY$'
      AND CT.MUCDICHCHUNGTU_CODE = 'X04'
      AND CT.IDCHUYEN IS NOT NULL
      <isNotEmpty prepend="AND" property="KHOXUAT_ID">
        CT.KHOXUAT_ID = '$KHOXUAT_ID$'
      </isNotEmpty>
      <isNotEmpty prepend="AND" property="NGUOIXUAT_ID">
        CT.NGUOIGIAO_ID = '$NGUOIXUAT_ID$'
      </isNotEmpty>
      <isNotEmpty prepend="AND" property="MACHUNGTU">
        CT.MACHUNGTU LIKE '%$MACHUNGTU$%'
      </isNotEmpty>
    </statement>
    <!--Lấy danh sách chứng từ chi tiết điều chỉnh giảm-->
    <statement id="DAO09800_GetDetailDuoc_DieuChinhGiam" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      SELECT	  TICHHOP_ID = NULL,
      CT.CHUNGTU_ID ,
      LD.LOAIVATTU_ID ,
      LD.MALOAIDUOC ,
      LD.TENLOAIDUOC ,
      D.MADUOC ,
      TD.TENDUOC  ,
      DONVITINH = DVT.TENDONVITINH,
      DONVIQUICACH = DVTQD.TENDONVITINH ,
      GIATRIQUIDOI = DVTQD.GIATRIQUIDOI ,
      SOLUONG = CTCT.SOLUONGDAXUAT  ,
      DONGIA = CTCT.DONGIAMUA,
      GIATRI = CTCT.THANHTIENMUA ,
      TYLEVAT = CTCT.TYLEVAT,
      GIATRIVAT = CTCT.GIATRIVAT ,
      TYLECHIETKHAU = CTCT.TYLECHIETKHAU ,
      GIATRICHIETKHAU = CTCT.GIATRICHIETKHAU ,
      GIATRITHANHTOAN = ISNULL(CTCT.THANHTIENMUA,0) + ISNULL(CTCT.GIATRIVAT,0),
      CTCT.KHUYENMAI
      FROM   dbo.TT_DUOC_CHUNGTU CT
      JOIN dbo.TT_DUOC_CHUNGTU_CHITIET CTCT ON CTCT.CHUNGTU_ID = CT.CHUNGTU_ID
      JOIN dbo.TT_DUOC_SOLONHAP_GIABAN GB ON CTCT.SOLONHAP_ID = GB.SOLONHAP_ID
      JOIN dbo.TM_DUOC D ON CTCT.DUOC_ID = D.DUOC_ID
      JOIN dbo.TM_TENDUOC TD ON D.TENDUOC_ID = TD.TENDUOC_ID
      JOIN dbo.TM_LOAIDUOC LD ON D.LOAIDUOC_ID = LD.LOAIDUOC_ID
      JOIN dbo.TM_DONVITINH DVT ON D.DONVITINH_ID = DVT.DONVITINH_ID
      JOIN dbo.TM_DONVITINH DVTQD ON CTCT.DONVITINH_ID = DVTQD.DONVITINH_ID
      WHERE  CT.CHUNGTU_ID = '$CHUNGTU_ID$'
    </statement>

    <!--Lấy danh sách chứng từ thanh lý dược-->
    <statement id="DAO09800_GetMasterDuoc_ThanhLy" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      DECLARE @TENBENHVIEN NVARCHAR(250);
      SELECT  @TENBENHVIEN = CODE
      FROM    dbo.TM_SYS_APPSETTINGS
      WHERE   BENHVIEN_ID = '$BENHVIEN_ID$'
      AND CODE = 'APP_BENHVIEN_TEN';

      SELECT  BTNCHECK = CAST (0 AS BIT) ,
      CT.CHUNGTU_ID ,
      CT.MACHUNGTU ,
      CT.NGAYCHUNGTU ,
      CT.MUCDICHCHUNGTU_CODE AS MAMUCDICHCHUNGTU ,
      MDCT.DICTIONARY_NAME AS TENMUCDICHCHUNGTU ,
      CT.NHACUNGCAP_ID ,
      MANHACUNGCAP = NULL ,
      TENNHACUNGCAP = NULL ,
      NULL AS DIACHI ,
      NULL AS MASOTHUE ,
      CT.MAUHOADON ,
      CT.SOHOADON ,
      CT.SOSERI ,
      CT.NGAYHOADON ,
      CT.DIENGIAI ,
      CT.TIENTE_ID ,
      CT.TYGIA ,
      CT.GIATRI ,
      CT.TYLEVAT ,
      CT.GIATRIVAT ,
      CT.TYLECHIETKHAU ,
      CT.GIATRICHIETKHAU ,
      ISNULL(CT.GIATRI, CTCT.GIATRITHANHTOAN) AS GIATRITHANHTOAN ,
      NX.MANHANVIEN ,
      NX.TENNHANVIEN ,
      NULL AS MADONHANG ,
      CT.KHONHAP_ID ,
      NULL AS MAKHONHAP ,
      NULL AS TENKHONHAP ,
      CT.KHOXUAT_ID ,
      KX.MAKHO AS MAKHOXUAT ,
      KX.TENKHO AS TENKHOXUAT ,
      CT.TRANGTHAI ,
      CT.PHONGBAN_ID ,
      PB.MAPHONGBAN ,
      PB.TENPHONGBAN ,
      PB.COSTCENTER_ID ,
      CO.MAPHONGBAN AS COSTCENTERCODE ,
      CO.TENPHONGBAN AS COSTCENTERNAME ,
      CT.BENHVIEN_ID ,
      CT.BENHVIEN_ID AS MABENHVIEN ,
      TENBENHVIEN = @TENBENHVIEN ,
      CT.IDCHUYEN ,
      CT.BENHNHAN_ID ,
      NULL AS MAYTE ,
      CT.TENBENHNHAN AS TENBENHNHAN ,
      CT.DIENGIAI AS GHICHU ,
      NULL AS CHUYENTICHHOP_ID ,
      PV.MAPHAMVI AS PHAMVI ,
      CT.LOAICHUNGTU ,
      STATUSROW = CAST (0 AS BIT) ,
      MESSAGEROW = NULL
      FROM    dbo.TT_DUOC_CHUNGTU CT
      JOIN dbo.TM_KHODUOC KX ON CT.KHOXUAT_ID = KX.KHODUOC_ID
      CROSS APPLY ( SELECT    SUM(CTCT.SOLUONGDAXUAT * CTCT.dongiavon) AS GIATRITHANHTOAN
      FROM      dbo.TT_DUOC_CHUNGTU_CHITIET CTCT
      WHERE     CTCT.CHUNGTU_ID = CT.CHUNGTU_ID
      ) CTCT
      LEFT JOIN dbo.TM_NHANVIEN NX ON CT.NGUOIGIAO_ID = NX.NHANVIEN_ID
      JOIN dbo.LST_DICTIONARY MDCT ON CT.MUCDICHCHUNGTU_ID = MDCT.DICTIONARY_ID
      JOIN dbo.TM_PHONGBAN PB ON CT.PHONGBAN_ID = PB.PHONGBAN_ID
      LEFT JOIN dbo.TM_PHONGBAN CO ON PB.COSTCENTER_ID = CO.PHONGBAN_ID
      LEFT JOIN dbo.TM_PHAMVI PV ON KX.PHAMVI_ID = PV.PHAMVI_ID
      WHERE   CT.BENHVIEN_ID = '$BENHVIEN_ID$' AND CAST(CT.NGAYCHUNGTU AS DATE) BETWEEN '$TUNGAY$' AND '$DENNGAY$'
      AND CT.MUCDICHCHUNGTU_CODE = 'X03'
      AND CT.IDCHUYEN IS NULL
      <isNotEmpty prepend="AND" property="KHOXUAT_ID">
        CT.KHOXUAT_ID = '$KHOXUAT_ID$'
      </isNotEmpty>
      <isNotEmpty prepend="AND" property="NGUOIXUAT_ID">
        CT.NGUOIGIAO_ID = '$NGUOIXUAT_ID$'
      </isNotEmpty>
      <isNotEmpty prepend="AND" property="MACHUNGTU">
        CT.MACHUNGTU LIKE '%$MACHUNGTU$%'
      </isNotEmpty>
    </statement>
    <!--Lấy danh sách chứng từ thanh lý dược đã chuyển-->
    <statement id="DAO09800_GetMasterDuoc_ThanhLy_DACHUYEN" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      DECLARE @TENBENHVIEN NVARCHAR(250);
      SELECT  @TENBENHVIEN = CODE
      FROM    dbo.TM_SYS_APPSETTINGS
      WHERE   BENHVIEN_ID = '$BENHVIEN_ID$'
      AND CODE = 'APP_BENHVIEN_TEN';

      SELECT  BTNCHECK = CAST (0 AS BIT) ,
      CT.CHUNGTU_ID ,
      CT.MACHUNGTU ,
      CT.NGAYCHUNGTU ,
      CT.MUCDICHCHUNGTU_CODE AS MAMUCDICHCHUNGTU ,
      MDCT.DICTIONARY_NAME AS TENMUCDICHCHUNGTU ,
      CT.NHACUNGCAP_ID ,
      MANHACUNGCAP = NULL ,
      TENNHACUNGCAP = NULL ,
      NULL AS DIACHI ,
      NULL AS MASOTHUE ,
      CT.MAUHOADON ,
      CT.SOHOADON ,
      CT.SOSERI ,
      CT.NGAYHOADON ,
      CT.DIENGIAI ,
      CT.TIENTE_ID ,
      CT.TYGIA ,
      CT.GIATRI ,
      CT.TYLEVAT ,
      CT.GIATRIVAT ,
      CT.TYLECHIETKHAU ,
      CT.GIATRICHIETKHAU ,
      ISNULL(CT.GIATRI, CTCT.GIATRITHANHTOAN) AS GIATRITHANHTOAN ,
      NX.MANHANVIEN ,
      NX.TENNHANVIEN ,
      NULL AS MADONHANG ,
      CT.KHONHAP_ID ,
      NULL AS MAKHONHAP ,
      NULL AS TENKHONHAP ,
      CT.KHOXUAT_ID ,
      KX.MAKHO AS MAKHOXUAT ,
      KX.TENKHO AS TENKHOXUAT ,
      CT.TRANGTHAI ,
      CT.PHONGBAN_ID ,
      PB.MAPHONGBAN ,
      PB.TENPHONGBAN ,
      PB.COSTCENTER_ID ,
      CO.MAPHONGBAN AS COSTCENTERCODE ,
      CO.TENPHONGBAN AS COSTCENTERNAME ,
      CT.BENHVIEN_ID ,
      CT.BENHVIEN_ID AS MABENHVIEN ,
      TENBENHVIEN = @TENBENHVIEN ,
      CT.IDCHUYEN ,
      CT.BENHNHAN_ID ,
      NULL AS MAYTE ,
      CT.TENBENHNHAN AS TENBENHNHAN ,
      CT.DIENGIAI AS GHICHU ,
      NULL AS CHUYENTICHHOP_ID ,
      PV.MAPHAMVI AS PHAMVI ,
      CT.LOAICHUNGTU ,
      STATUSROW = CAST (0 AS BIT) ,
      MESSAGEROW = NULL
      FROM    dbo.TT_DUOC_CHUNGTU CT
      JOIN dbo.TM_KHODUOC KX ON CT.KHOXUAT_ID = KX.KHODUOC_ID
      CROSS APPLY ( SELECT    SUM(CTCT.SOLUONGDAXUAT * CTCT.dongiavon) AS GIATRITHANHTOAN
      FROM      dbo.TT_DUOC_CHUNGTU_CHITIET CTCT
      WHERE     CTCT.CHUNGTU_ID = CT.CHUNGTU_ID
      ) CTCT
      LEFT JOIN dbo.TM_NHANVIEN NX ON CT.NGUOIGIAO_ID = NX.NHANVIEN_ID
      JOIN dbo.LST_DICTIONARY MDCT ON CT.MUCDICHCHUNGTU_ID = MDCT.DICTIONARY_ID
      JOIN dbo.TM_PHONGBAN PB ON CT.PHONGBAN_ID = PB.PHONGBAN_ID
      LEFT JOIN dbo.TM_PHONGBAN CO ON PB.COSTCENTER_ID = CO.PHONGBAN_ID
      LEFT JOIN dbo.TM_PHAMVI PV ON KX.PHAMVI_ID = PV.PHAMVI_ID
      WHERE   CT.BENHVIEN_ID = '$BENHVIEN_ID$' AND CAST(CT.NGAYCHUNGTU AS DATE) BETWEEN '$TUNGAY$' AND '$DENNGAY$'
      AND CT.MUCDICHCHUNGTU_CODE = 'X03'
      AND CT.IDCHUYEN IS NOT NULL
      <isNotEmpty prepend="AND" property="KHOXUAT_ID">
        CT.KHOXUAT_ID = '$KHOXUAT_ID$'
      </isNotEmpty>
      <isNotEmpty prepend="AND" property="NGUOIXUAT_ID">
        CT.NGUOIGIAO_ID = '$NGUOIXUAT_ID$'
      </isNotEmpty>
      <isNotEmpty prepend="AND" property="MACHUNGTU">
        CT.MACHUNGTU LIKE '%$MACHUNGTU$%'
      </isNotEmpty>
    </statement>
    <!--Lấy danh sách chứng từ chi tiết thanh lý dược-->
    <statement id="DAO09800_GetDetailDuoc_ThanhLy" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      SELECT	  TICHHOP_ID = NULL,
      CT.CHUNGTU_ID ,
      LD.LOAIVATTU_ID ,
      LD.MALOAIDUOC ,
      LD.TENLOAIDUOC ,
      D.MADUOC ,
      TD.TENDUOC  ,
      DONVITINH = DVT.TENDONVITINH,
      DONVIQUICACH = DVTQD.TENDONVITINH ,
      GIATRIQUIDOI = DVTQD.GIATRIQUIDOI ,
      SOLUONG = CTCT.SOLUONGDAXUAT  ,
      DONGIA = CTCT.DONGIAMUA,
      GIATRI = CTCT.THANHTIENMUA ,
      TYLEVAT = CTCT.TYLEVAT,
      GIATRIVAT = CTCT.GIATRIVAT ,
      TYLECHIETKHAU = CTCT.TYLECHIETKHAU ,
      GIATRICHIETKHAU = CTCT.GIATRICHIETKHAU ,
      GIATRITHANHTOAN = ISNULL(CTCT.THANHTIENMUA,0) + ISNULL(CTCT.GIATRIVAT,0),
      CTCT.KHUYENMAI
      FROM   dbo.TT_DUOC_CHUNGTU CT
      JOIN dbo.TT_DUOC_CHUNGTU_CHITIET CTCT ON CTCT.CHUNGTU_ID = CT.CHUNGTU_ID
      JOIN dbo.TT_DUOC_SOLONHAP_GIABAN GB ON CTCT.SOLONHAP_ID = GB.SOLONHAP_ID
      JOIN dbo.TM_DUOC D ON CTCT.DUOC_ID = D.DUOC_ID
      JOIN dbo.TM_TENDUOC TD ON D.TENDUOC_ID = TD.TENDUOC_ID
      JOIN dbo.TM_LOAIDUOC LD ON D.LOAIDUOC_ID = LD.LOAIDUOC_ID
      JOIN dbo.TM_DONVITINH DVT ON D.DONVITINH_ID = DVT.DONVITINH_ID
      JOIN dbo.TM_DONVITINH DVTQD ON CTCT.DONVITINH_ID = DVTQD.DONVITINH_ID
      WHERE  CT.CHUNGTU_ID = '$CHUNGTU_ID$'
    </statement>

    <!--Lấy danh sách chứng từ xuất sử dụng-->
    <statement id="DAO09800_GetMasterXuatSuDung" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      DECLARE @TENBENHVIEN NVARCHAR(250);
      SELECT @TENBENHVIEN = CODE
      FROM   dbo.TM_SYS_APPSETTINGS
      WHERE  BENHVIEN_ID = '$BENHVIEN_ID$' AND CODE = 'APP_BENHVIEN_TEN';

      SELECT BTNCHECK = CAST (0 AS BIT), CT.CHUNGTU_ID ,CT.MACHUNGTU ,CT.NGAYCHUNGTU ,MAMUCDICHCHUNGTU = CT.MUCDICHCHUNGTU_CODE ,TENMUCDICHCHUNGTU = MDCT.DICTIONARY_NAME ,CT.NHACUNGCAP_ID ,MANHACUNGCAP = NULL, TENNHACUNGCAP = NULL,
      DIACHI = NULL ,MASOTHUE = NULL ,CT.MAUHOADON ,CT.SOHOADON ,CT.SOSERI ,CT.NGAYHOADON ,CT.DIENGIAI ,CT.TIENTE_ID ,CT.TYGIA ,CTCT.GIATRITHANHTOAN AS GIATRI  ,CT.TYLEVAT ,CT.GIATRIVAT ,CT.TYLECHIETKHAU ,CT.GIATRICHIETKHAU ,
      CTCT.GIATRITHANHTOAN AS GIATRITHANHTOAN ,NG.MANHANVIEN ,NG.TENNHANVIEN ,MADONHANG = NULL ,CT.KHONHAP_ID ,MAKHONHAP = NULL ,TENKHONHAP = NULL ,CT.KHOXUAT_ID ,MAKHOXUAT = KT.MAKHO ,TENKHOXUAT = KT.TENKHO ,
      CT.TRANGTHAI ,CT.PHONGBAN_ID ,PB.MAPHONGBAN ,PB.TENPHONGBAN ,PB.COSTCENTER_ID ,COSTCENTERCODE = CO.MAPHONGBAN ,COSTCENTERNAME = CO.TENPHONGBAN ,CT.BENHVIEN_ID ,MABENHVIEN = CT.BENHVIEN_ID ,
      TENBENHVIEN = @TENBENHVIEN ,CT.IDCHUYEN ,CT.BENHNHAN_ID ,MAYTE = NULL ,TENBENHNHAN = NULL ,GHICHU = NULL ,CHUYENTICHHOP_ID = NULL ,PHAMVI = PV.MAPHAMVI ,CT.LOAICHUNGTU, STATUSROW = CAST (0 AS BIT), MESSAGEROW = NULL, MAMUCDICHSUDUNG = MDSD.DICTIONARY_CODE, TENMUCDICHSUDUNG = MDSD.DICTIONARY_NAME
      FROM   dbo.TT_DUOC_CHUNGTU CT
      CROSS APPLY(SELECT SUM(ISNULL(THANHTIENVON,0)) AS GIATRITHANHTOAN  FROM dbo.TT_DUOC_CHUNGTU_CHITIET WHERE CHUNGTU_ID = CT.CHUNGTU_ID) CTCT
      JOIN dbo.TM_KHODUOC KT ON CT.KHOXUAT_ID = KT.KHODUOC_ID
      JOIN dbo.TM_NHANVIEN NG ON CT.NGUOIGIAO_ID = NG.NHANVIEN_ID
      JOIN dbo.LST_DICTIONARY MDCT ON CT.MUCDICHCHUNGTU_ID = MDCT.DICTIONARY_ID
      JOIN dbo.TM_PHONGBAN PB ON CT.PHONGBAN_ID = PB.PHONGBAN_ID
      LEFT JOIN dbo.TM_PHONGBAN CO ON PB.COSTCENTER_ID = CO.PHONGBAN_ID
      LEFT JOIN dbo.TM_PHAMVI PV ON KT.PHAMVI_ID = PV.PHAMVI_ID
      LEFT JOIN dbo.LST_DICTIONARY MDSD ON CT.LYDOXUATSUDUNG_ID = MDSD.DICTIONARY_ID
      WHERE CT.BENHVIEN_ID = '$BENHVIEN_ID$' AND CAST(CT.NGAYCHUNGTU AS DATE) BETWEEN '$TUNGAY$' AND '$DENNGAY$'
      AND CT.MUCDICHCHUNGTU_CODE = 'X13'
      AND CT.IDCHUYEN IS NULL
      <isNotEmpty prepend="AND" property="KHOXUAT_ID">
        CT.KHOXUAT_ID = '$KHOXUAT_ID$'
      </isNotEmpty>
      <isNotEmpty prepend="AND" property="NGUOIXUAT_ID">
        CT.NGUOIGIAO_ID = '$NGUOIXUAT_ID$'
      </isNotEmpty>
      <isNotEmpty prepend="AND" property="TENBENHNHAN">
        CT.TENBENHNHAN LIKE '%$TENBENHNHAN$%'
      </isNotEmpty>
      <isNotEmpty prepend="AND" property="MACHUNGTU">
        CT.MACHUNGTU LIKE '%$MACHUNGTU$%'
      </isNotEmpty>
    </statement>
    <!--Lấy danh sách chứng từ xuất sử dụng-->
    <statement id="DAO09800_GetMasterXuatSuDung_DACHUYEN" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      DECLARE @TENBENHVIEN NVARCHAR(250);
      SELECT @TENBENHVIEN = CODE
      FROM   dbo.TM_SYS_APPSETTINGS
      WHERE  BENHVIEN_ID = '$BENHVIEN_ID$' AND CODE = 'APP_BENHVIEN_TEN';

      SELECT BTNCHECK = CAST (0 AS BIT), CT.CHUNGTU_ID ,CT.MACHUNGTU ,CT.NGAYCHUNGTU ,MAMUCDICHCHUNGTU = CT.MUCDICHCHUNGTU_CODE ,TENMUCDICHCHUNGTU = MDCT.DICTIONARY_NAME ,CT.NHACUNGCAP_ID ,MANHACUNGCAP = NULL, TENNHACUNGCAP = NULL,
      DIACHI = NULL ,MASOTHUE = NULL ,CT.MAUHOADON ,CT.SOHOADON ,CT.SOSERI ,CT.NGAYHOADON ,CT.DIENGIAI ,CT.TIENTE_ID ,CT.TYGIA ,CTCT.GIATRITHANHTOAN AS GIATRI  ,CT.TYLEVAT ,CT.GIATRIVAT ,CT.TYLECHIETKHAU ,CT.GIATRICHIETKHAU ,
      CTCT.GIATRITHANHTOAN AS GIATRITHANHTOAN ,NG.MANHANVIEN ,NG.TENNHANVIEN ,MADONHANG = NULL ,CT.KHONHAP_ID ,MAKHONHAP = NULL ,TENKHONHAP = NULL ,CT.KHOXUAT_ID ,MAKHOXUAT = KT.MAKHO ,TENKHOXUAT = KT.TENKHO ,
      CT.TRANGTHAI ,CT.PHONGBAN_ID ,PB.MAPHONGBAN ,PB.TENPHONGBAN ,PB.COSTCENTER_ID ,COSTCENTERCODE = CO.MAPHONGBAN ,COSTCENTERNAME = CO.TENPHONGBAN ,CT.BENHVIEN_ID ,MABENHVIEN = CT.BENHVIEN_ID ,
      TENBENHVIEN = @TENBENHVIEN ,CT.IDCHUYEN ,CT.BENHNHAN_ID ,MAYTE = NULL ,TENBENHNHAN = NULL ,GHICHU = NULL ,CHUYENTICHHOP_ID = NULL ,PHAMVI = PV.MAPHAMVI ,CT.LOAICHUNGTU, STATUSROW = CAST (0 AS BIT), MESSAGEROW = NULL, MAMUCDICHSUDUNG = MDSD.DICTIONARY_CODE, TENMUCDICHSUDUNG = MDSD.DICTIONARY_NAME
      FROM   dbo.TT_DUOC_CHUNGTU CT
      CROSS APPLY(SELECT SUM(ISNULL(THANHTIENVON,0)) AS GIATRITHANHTOAN  FROM dbo.TT_DUOC_CHUNGTU_CHITIET WHERE CHUNGTU_ID = CT.CHUNGTU_ID) CTCT
      JOIN dbo.TM_KHODUOC KT ON CT.KHOXUAT_ID = KT.KHODUOC_ID
      JOIN dbo.TM_NHANVIEN NG ON CT.NGUOIGIAO_ID = NG.NHANVIEN_ID
      JOIN dbo.LST_DICTIONARY MDCT ON CT.MUCDICHCHUNGTU_ID = MDCT.DICTIONARY_ID
      JOIN dbo.TM_PHONGBAN PB ON CT.PHONGBAN_ID = PB.PHONGBAN_ID
      LEFT JOIN dbo.TM_PHONGBAN CO ON PB.COSTCENTER_ID = CO.PHONGBAN_ID
      LEFT JOIN dbo.TM_PHAMVI PV ON KT.PHAMVI_ID = PV.PHAMVI_ID
      LEFT JOIN dbo.LST_DICTIONARY MDSD ON CT.LYDOXUATSUDUNG_ID = MDSD.DICTIONARY_ID
      WHERE CT.BENHVIEN_ID = '$BENHVIEN_ID$' AND CAST(CT.NGAYCHUNGTU AS DATE) BETWEEN '$TUNGAY$' AND '$DENNGAY$'
      AND CT.MUCDICHCHUNGTU_CODE = 'X13'
      AND CT.IDCHUYEN IS NOT NULL
      <isNotEmpty prepend="AND" property="KHOXUAT_ID">
        CT.KHOXUAT_ID = '$KHOXUAT_ID$'
      </isNotEmpty>
      <isNotEmpty prepend="AND" property="NGUOIXUAT_ID">
        CT.NGUOIGIAO_ID = '$NGUOIXUAT_ID$'
      </isNotEmpty>
      <isNotEmpty prepend="AND" property="TENBENHNHAN">
        CT.TENBENHNHAN LIKE '%$TENBENHNHAN$%'
      </isNotEmpty>
      <isNotEmpty prepend="AND" property="MACHUNGTU">
        CT.MACHUNGTU LIKE '%$MACHUNGTU$%'
      </isNotEmpty>
    </statement>
    <!--Lấy chi tiết chứng từ chi tiết trả ncc-->
    <statement id="DAO09800_GetDetailXuatSuDung" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      SELECT	  TICHHOP_ID = NULL,
      CT.CHUNGTU_ID ,
      LD.LOAIVATTU_ID ,
      LD.MALOAIDUOC ,
      LD.TENLOAIDUOC ,
      D.MADUOC ,
      TD.TENDUOC  ,
      DONVITINH = DVT.TENDONVITINH,
      DONVIQUICACH = DVTQD.TENDONVITINH ,
      GIATRIQUIDOI = DVTQD.GIATRIQUIDOI ,
      SOLUONG = CTCT.SOLUONGDAXUAT  ,
      DONGIA = CTCT.DONGIAVON,
      GIATRI = CTCT.THANHTIENVON ,
      TYLEVAT = CTCT.TYLEVAT,
      GIATRIVAT = CTCT.GIATRIVAT ,
      TYLECHIETKHAU = CTCT.TYLECHIETKHAU ,
      GIATRICHIETKHAU = CTCT.GIATRICHIETKHAU ,
      GIATRITHANHTOAN = ISNULL(CTCT.THANHTIENVON,0),
      CTCT.KHUYENMAI
      FROM   dbo.TT_DUOC_CHUNGTU CT
      JOIN dbo.TT_DUOC_CHUNGTU_CHITIET CTCT ON CTCT.CHUNGTU_ID = CT.CHUNGTU_ID
      JOIN dbo.TT_DUOC_SOLONHAP_GIABAN GB ON CTCT.SOLONHAP_ID = GB.SOLONHAP_ID
      JOIN dbo.TM_DUOC D ON CTCT.DUOC_ID = D.DUOC_ID
      JOIN dbo.TM_TENDUOC TD ON D.TENDUOC_ID = TD.TENDUOC_ID
      JOIN dbo.TM_LOAIDUOC LD ON D.LOAIDUOC_ID = LD.LOAIDUOC_ID
      JOIN dbo.TM_DONVITINH DVT ON D.DONVITINH_ID = DVT.DONVITINH_ID
      JOIN dbo.TM_DONVITINH DVTQD ON CTCT.DONVITINH_ID = DVTQD.DONVITINH_ID
      WHERE  CT.CHUNGTU_ID = '$CHUNGTU_ID$'
    </statement>

    <!--Cập nhật IDChuyen vào bảng DUOC_CHUNGTU-->
    <update id="DAO09800_UpdateDUOC_CHUNGTU_IDChuyen" parameterClass="System.Collections.IDictionary">
      UPDATE dbo.TT_DUOC_CHUNGTU SET IDCHUYEN = #CHUYENTICHHOP_ID# WHERE CHUNGTU_ID = '$CHUNGTU_ID$'
    </update>
    <!--============================================END DƯỢC PHẨM=============================================-->

    <!--============================================BEGIN VĂN PHÒNG PHẨM=============================================-->
    <!--Lấy danh sách chứng từ nhập VPP-->
    <statement id="DAO09800_GetMasterNHAPVPP" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      DECLARE @TENBENHVIEN NVARCHAR(250);
      SELECT @TENBENHVIEN = CODE
      FROM   dbo.TM_SYS_APPSETTINGS
      WHERE  BENHVIEN_ID = '$BENHVIEN_ID$'
      AND CODE = 'APP_BENHVIEN_TEN';

      SELECT BTNCHECK = CAST (0 AS BIT), CHUNGTU_ID = CT.CHUNGTUNHAP_ID ,CT.MACHUNGTU ,CT.NGAYCHUNGTU ,LOAICHUNGTU = 'N' ,CT.KYHIEUHOADON ,CT.SOSERI ,CT.SOHOADON ,CT.NGAYHOADON ,NCC.MANHACUNGCAP ,
      NCC.TENNHACUNGCAP ,NCC.DIACHI ,NCC.MASOTHUE ,TIENTE_ID = 'VND' ,TYGIA = 1.0000 ,GIATRI = CTCT.THANHTIENTRUOCVAT ,TYLEVAT = NULL ,CTCT.GIATRIVAT ,CT.TYLECHIETKHAU ,CT.GIATRICHIETKHAU ,
      GIATRITHANHTOAN = CTCT.THANHTIENSAUVAT ,NN.MANHANVIEN ,ISNULL(NN.TENNHANVIEN, CT.TENNGUOINHAP) AS TENNHANVIEN ,MADONHANG = NULL ,KHONHAP_ID = NULL ,MAKHONHAP = CT.MAKHO ,TENKHONHAP = CT.TENKHO ,KHOXUAT_ID = NULL ,MAKHOXUAT = NULL ,
      TENKHOXUAT = NULL ,TRANGTHAI = CT.MATRANGTHAI ,PHONGBAN_ID = NULL ,MAPHONGBAN = NULL ,TENPHONGBAN = NULL ,COSTCENTER_ID = NULL ,COSTCENTERCODE = NULL ,COSTCENTERNAME = NULL ,
      CT.BENHVIEN_ID ,MABENHVIEN = CT.BENHVIEN_ID ,TENBENHVIEN = @TENBENHVIEN ,IDCHUYEN ,CHUYENTICHHOP_ID = NULL ,CT.GHICHU, CT.TENNGUOINHAP, CT.TENNGUOIGIAO, STATUSROW = CAST (0 AS BIT), MESSAGEROW = NULL
      FROM   dbo.TT_INV_CHUNGTUNHAP CT
      JOIN dbo.TM_NHACUNGCAP NCC ON CT.NHACUNGCAP_ID = NCC.NHACUNGCAP_ID
      CROSS APPLY ( SELECT    SUM(THANHTIENTRUOCVAT) THANHTIENTRUOCVAT ,
      SUM(THANHTIENSAUVAT) THANHTIENSAUVAT ,
      SUM(GIATRIVAT) GIATRIVAT
      FROM      dbo.TT_INV_CHUNGTUNHAPCHITIET
      WHERE     CHUNGTUNHAP_ID = CT.CHUNGTUNHAP_ID
      ) CTCT
      LEFT JOIN dbo.TM_NHANVIEN NN ON CT.NGUOITAO_ID = NN.NHANVIEN_ID
      WHERE  CT.BENHVIEN_ID = '$BENHVIEN_ID$' AND CAST(CT.NGAYCHUNGTU AS DATE) BETWEEN '$TUNGAY$' AND '$DENNGAY$'
      AND CT.MATRANGTHAI = 'DaNhapKho'
      AND CT.IDCHUYEN IS NULL
      <isNotEmpty prepend="AND" property="MACHUNGTU">
        CT.MACHUNGTU LIKE '%$MACHUNGTU$%'
      </isNotEmpty>
      <isNotEmpty prepend="AND" property="MAKHO">
        CT.MAKHO ='$MAKHO$'
      </isNotEmpty>
      <isNotEmpty prepend="AND" property="NHACUNGCAP_ID">
        CT.NHACUNGCAP_ID = '$NHACUNGCAP_ID$'
      </isNotEmpty>
      <isNotEmpty prepend="AND" property="TENNGUOIGIAO">
        ISNULL(CT.TENNGUOIGIAO,'') LIKE '%$TENNGUOIGIAO$%'
      </isNotEmpty>
      <isNotEmpty prepend="AND" property="TENNGUOINHAN">
        ISNULL(CT.TENNGUOINHAP,'') LIKE '%$TENNGUOINHAN$%'
      </isNotEmpty>
    </statement>
    <!--Lấy danh sách chứng từ nhập VPP  đã chuyển-->
    <statement id="DAO09800_GetMasterNHAPVPP_DACHUYEN" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      DECLARE @TENBENHVIEN NVARCHAR(250);
      SELECT @TENBENHVIEN = CODE
      FROM   dbo.TM_SYS_APPSETTINGS
      WHERE  BENHVIEN_ID = '$BENHVIEN_ID$'
      AND CODE = 'APP_BENHVIEN_TEN';

      SELECT BTNCHECK = CAST (0 AS BIT), CHUNGTU_ID = CT.CHUNGTUNHAP_ID ,CT.MACHUNGTU ,CT.NGAYCHUNGTU ,LOAICHUNGTU = 'N' ,CT.KYHIEUHOADON ,CT.SOSERI ,CT.SOHOADON ,CT.NGAYHOADON ,NCC.MANHACUNGCAP ,
      NCC.TENNHACUNGCAP ,NCC.DIACHI ,NCC.MASOTHUE ,TIENTE_ID = 'VND' ,TYGIA = 1.0000 ,GIATRI = CTCT.THANHTIENTRUOCVAT ,TYLEVAT = NULL ,CTCT.GIATRIVAT ,CT.TYLECHIETKHAU ,CT.GIATRICHIETKHAU ,
      GIATRITHANHTOAN = CTCT.THANHTIENSAUVAT ,NN.MANHANVIEN ,ISNULL(NN.TENNHANVIEN, CT.TENNGUOINHAP) AS TENNHANVIEN ,MADONHANG = NULL ,KHONHAP_ID = NULL ,MAKHONHAP = CT.MAKHO ,TENKHONHAP = CT.TENKHO ,KHOXUAT_ID = NULL ,MAKHOXUAT = NULL ,
      TENKHOXUAT = NULL ,TRANGTHAI = CT.MATRANGTHAI ,PHONGBAN_ID = NULL ,MAPHONGBAN = NULL ,TENPHONGBAN = NULL ,COSTCENTER_ID = NULL ,COSTCENTERCODE = NULL ,COSTCENTERNAME = NULL ,
      CT.BENHVIEN_ID ,MABENHVIEN = CT.BENHVIEN_ID ,TENBENHVIEN = @TENBENHVIEN ,IDCHUYEN ,CHUYENTICHHOP_ID = NULL ,CT.GHICHU, CT.TENNGUOINHAP, CT.TENNGUOIGIAO, STATUSROW = CAST (0 AS BIT), MESSAGEROW = NULL
      FROM   dbo.TT_INV_CHUNGTUNHAP CT
      JOIN dbo.TM_NHACUNGCAP NCC ON CT.NHACUNGCAP_ID = NCC.NHACUNGCAP_ID
      CROSS APPLY ( SELECT    SUM(THANHTIENTRUOCVAT) THANHTIENTRUOCVAT ,
      SUM(THANHTIENSAUVAT) THANHTIENSAUVAT ,
      SUM(GIATRIVAT) GIATRIVAT
      FROM      dbo.TT_INV_CHUNGTUNHAPCHITIET
      WHERE     CHUNGTUNHAP_ID = CT.CHUNGTUNHAP_ID
      ) CTCT
      LEFT JOIN dbo.TM_NHANVIEN NN ON CT.NGUOITAO_ID = NN.NHANVIEN_ID
      WHERE  CT.BENHVIEN_ID = '$BENHVIEN_ID$' AND CAST(CT.NGAYCHUNGTU AS DATE) BETWEEN '$TUNGAY$' AND '$DENNGAY$'
      AND CT.MATRANGTHAI = 'DaNhapKho'
      AND CT.IDCHUYEN IS NOT NULL
      <isNotEmpty prepend="AND" property="MACHUNGTU">
        CT.MACHUNGTU LIKE '%$MACHUNGTU$%'
      </isNotEmpty>
      <isNotEmpty prepend="AND" property="MAKHO">
        CT.MAKHO ='$MAKHO$'
      </isNotEmpty>
      <isNotEmpty prepend="AND" property="NHACUNGCAP_ID">
        CT.NHACUNGCAP_ID = '$NHACUNGCAP_ID$'
      </isNotEmpty>
      <isNotEmpty prepend="AND" property="TENNGUOIGIAO">
        ISNULL(CT.TENNGUOIGIAO,'') LIKE '%$TENNGUOIGIAO$%'
      </isNotEmpty>
      <isNotEmpty prepend="AND" property="TENNGUOINHAP">
        ISNULL(CT.TENNGUOINHAP,'') LIKE '%$TENNGUOINHAP$%'
      </isNotEmpty>
    </statement>
    <!--Lấy danh sách chứng từ nhập VPP-->
    <statement id="DAO09800_GetDetailNHAPVPP" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      SELECT TICHHOP_ID = NULL ,CHUNGTU_ID = CT.CHUNGTUNHAP_ID,MALOAI = LOAI.MA ,TENLOAI = LOAI.TEN ,MANHOM = NHOM.MA,TENNHOM = NHOM.TEN,
      MAHANG = HH.MA,TENHANG = HH.TEN,DONVITINH = HH.TENDONVITINH,SOLUONG = CTCT.SOLUONGNHAP,DONGIA = TD.DONGIA,GIATRI = CTCT.THANHTIENSAUVAT,
      TD.TYLEVAT ,CTCT.GIATRIVAT ,GIATRITHANHTOAN = CTCT.THANHTIENSAUVAT,CT.TYLECHIETKHAU ,CT.GIATRICHIETKHAU ,CTCT.KHUYENMAI
      FROM   dbo.TT_INV_CHUNGTUNHAP CT
      JOIN dbo.TT_INV_CHUNGTUNHAPCHITIET CTCT ON CTCT.CHUNGTUNHAP_ID = CT.CHUNGTUNHAP_ID
      JOIN TT_INV_THEODOI TD ON TD.THEODOI_ID = CTCT.THEODOI_ID
      JOIN dbo.TM_PUR_HANGHOA HH ON TD.HANGHOA_ID = HH.ID
      LEFT JOIN dbo.TM_PUR_NHOM NHOM ON HH.NHOM_ID = NHOM.ID
      LEFT JOIN dbo.TM_PUR_LOAI LOAI ON HH.LOAI_ID = LOAI.ID
      WHERE  CT.CHUNGTUNHAP_ID = '$CHUNGTU_ID$'
    </statement>
    <!--Cập nhật IDChuyen vào bảng INV_CHUNGTUNHAP-->
    <update id="DAO09800_UpdateINV_CHUNGTUNHAP_IDChuyen" parameterClass="System.Collections.IDictionary">
      UPDATE dbo.TT_INV_CHUNGTUNHAP SET IDCHUYEN = #CHUYENTICHHOP_ID# WHERE CHUNGTUNHAP_ID = '$CHUNGTU_ID$'
    </update>

    <!--Lấy danh sách chứng từ xuất vpp-->
    <statement id="DAO09800_GetMasterXUATVPP" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      DECLARE @TENBENHVIEN NVARCHAR(250);
      SELECT  @TENBENHVIEN = CODE
      FROM    dbo.TM_SYS_APPSETTINGS
      WHERE   BENHVIEN_ID = '$BENHVIEN_ID$'
      AND CODE = 'APP_BENHVIEN_TEN';

      SELECT  BTNCHECK = CAST (0 AS BIT) ,
      CT.CHUNGTUXUAT_ID AS CHUNGTU_ID ,
      CT.MACHUNGTU ,
      CT.NGAYCHUNGTU ,
      LOAICHUNGTU = 'X' ,
      NULL AS KYHIEUHOADON ,
      NULL AS SOSERI ,
      NULL AS SOHOADON ,
      NULL AS NGAYHOADON ,
      NULL AS MANHACUNGCAP ,
      NULL AS TENNHACUNGCAP ,
      NULL AS DIACHI ,
      NULL AS MASOTHUE ,
      TIENTE_ID = 'VND' ,
      TYGIA = 1.0000,
      NULL AS GIATRI ,
      NULL AS TYLEVAT ,
      NULL AS GIATRIVAT ,
      NULL AS TYLECHIETKHAU ,
      NULL AS GIATRICHIETKHAU ,
      CTCT.GIATRITHANHTOAN ,
      NV.MANHANVIEN ,
      NV.TENNHANVIEN ,
      NULL AS MADONHANG ,
      NULL AS KHONHAP_ID ,
      NULL AS MAKHONHAP ,
      NULL AS TENKHONHAP ,
      AA.DICTIONARY_ID AS KHOXUAT_ID ,
      CT.MAKHOXUAT ,
      CT.TENKHOXUAT ,
      CT.TENNGUOITAO,
      NULL AS TRANGTHAI ,
      PB.PHONGBAN_ID ,
      PB.MAPHONGBAN ,
      PB.TENPHONGBAN ,
      PB.COSTCENTER_ID ,
      CO.MAPHONGBAN AS COSTCENTERCODE ,
      CO.TENPHONGBAN AS COSTCENTERNAME ,
      CT.BENHVIEN_ID ,
      CT.BENHVIEN_ID AS MABENHVIEN ,
      TENBENHVIEN = @TENBENHVIEN ,
      CT.IDCHUYEN ,
      NULL AS CHUYENTICHHOP_ID ,
      CT.GHICHU ,
      STATUSROW = CAST (0 AS BIT) ,
      MESSAGEROW = NULL
      FROM    dbo.TT_INV_CHUNGTUXUAT CT
      CROSS APPLY ( SELECT    ISNULL(CTCT.THANHTIEN, 0) AS GIATRITHANHTOAN
      FROM      dbo.TT_INV_CHUNGTUXUATCHITIET CTCT
      WHERE     CTCT.CHUNGTUXUAT_ID = CT.CHUNGTUXUAT_ID
      ) CTCT
      JOIN dbo.TM_PHONGBAN PB ON CT.PHONGBANNHAN_ID = PB.PHONGBAN_ID
      JOIN dbo.TM_NHANVIEN NV ON NV.NHANVIEN_ID = CT.NHANVIENNHAN_ID
      JOIN dbo.LST_DICTIONARY AA ON AA.DICTIONARY_CODE = CT.MAKHOXUAT
      LEFT JOIN dbo.TM_PHONGBAN CO ON PB.COSTCENTER_ID = CO.PHONGBAN_ID
      WHERE   CT.BENHVIEN_ID = '$BENHVIEN_ID$'  AND CAST(CT.NGAYCHUNGTU AS DATE) BETWEEN '$TUNGAY$' AND '$DENNGAY$'
      AND CT.IDCHUYEN IS NULL
      <isNotEmpty prepend="AND" property="MAKHO">
        CT.MAKHOXUAT = '$MAKHO$'
      </isNotEmpty>
      <isNotEmpty prepend="AND" property="NGUOINHAP_ID">
        CT.NHANVIENNHAN_ID = '$NGUOINHAP_ID$'
      </isNotEmpty>
      <isNotEmpty prepend="AND" property="TENNGUOITAO">
        CT.TENNGUOITAO LIKE '%$TENNGUOITAO$%'
      </isNotEmpty>
      <isNotEmpty prepend="AND" property="TENPHONGBANNHAN">
        CT.TENPHONGBANNHAN LIKE '%$TENPHONGBANNHAN$%'
      </isNotEmpty>
      <isNotEmpty prepend="AND" property="MACHUNGTU">
        CT.MACHUNGTU LIKE '%$MACHUNGTU$%'
      </isNotEmpty>
    </statement>
    <!--Lấy danh sách chứng từ xuất vpp đã chuyển-->
    <statement id="DAO09800_GetMasterXUATVPP_DACHUYEN" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      DECLARE @TENBENHVIEN NVARCHAR(250);
      SELECT  @TENBENHVIEN = CODE
      FROM    dbo.TM_SYS_APPSETTINGS
      WHERE   BENHVIEN_ID = '$BENHVIEN_ID$'
      AND CODE = 'APP_BENHVIEN_TEN';

      SELECT  BTNCHECK = CAST (0 AS BIT) ,
      CT.CHUNGTUXUAT_ID AS CHUNGTU_ID ,
      CT.MACHUNGTU ,
      CT.NGAYCHUNGTU ,
      LOAICHUNGTU = 'X' ,
      NULL AS KYHIEUHOADON ,
      NULL AS SOSERI ,
      NULL AS SOHOADON ,
      NULL AS NGAYHOADON ,
      NULL AS MANHACUNGCAP ,
      NULL AS TENNHACUNGCAP ,
      NULL AS DIACHI ,
      NULL AS MASOTHUE ,
      TIENTE_ID = 'VND' ,
      TYGIA = 1.0000,
      NULL AS GIATRI ,
      NULL AS TYLEVAT ,
      NULL AS GIATRIVAT ,
      NULL AS TYLECHIETKHAU ,
      NULL AS GIATRICHIETKHAU ,
      CTCT.GIATRITHANHTOAN ,
      NV.MANHANVIEN ,
      NV.TENNHANVIEN ,
      NULL AS MADONHANG ,
      NULL AS KHONHAP_ID ,
      NULL AS MAKHONHAP ,
      NULL AS TENKHONHAP ,
      AA.DICTIONARY_ID AS KHOXUAT_ID ,
      CT.MAKHOXUAT ,
      CT.TENKHOXUAT ,
      CT.TENNGUOITAO,
      NULL AS TRANGTHAI ,
      PB.PHONGBAN_ID ,
      PB.MAPHONGBAN ,
      PB.TENPHONGBAN ,
      PB.COSTCENTER_ID ,
      CO.MAPHONGBAN AS COSTCENTERCODE ,
      CO.TENPHONGBAN AS COSTCENTERNAME ,
      CT.BENHVIEN_ID ,
      CT.BENHVIEN_ID AS MABENHVIEN ,
      TENBENHVIEN = @TENBENHVIEN ,
      CT.IDCHUYEN ,
      NULL AS CHUYENTICHHOP_ID ,
      CT.GHICHU ,
      STATUSROW = CAST (0 AS BIT) ,
      MESSAGEROW = NULL
      FROM    dbo.TT_INV_CHUNGTUXUAT CT
      CROSS APPLY ( SELECT    ISNULL(CTCT.THANHTIEN, 0) AS GIATRITHANHTOAN
      FROM      dbo.TT_INV_CHUNGTUXUATCHITIET CTCT
      WHERE     CTCT.CHUNGTUXUAT_ID = CT.CHUNGTUXUAT_ID
      ) CTCT
      JOIN dbo.TM_PHONGBAN PB ON CT.PHONGBANNHAN_ID = PB.PHONGBAN_ID
      JOIN dbo.TM_NHANVIEN NV ON NV.NHANVIEN_ID = CT.NHANVIENNHAN_ID
      JOIN dbo.LST_DICTIONARY AA ON AA.DICTIONARY_CODE = CT.MAKHOXUAT
      LEFT JOIN dbo.TM_PHONGBAN CO ON PB.COSTCENTER_ID = CO.PHONGBAN_ID
      WHERE   CT.BENHVIEN_ID = '$BENHVIEN_ID$'  AND CAST(CT.NGAYCHUNGTU AS DATE) BETWEEN '$TUNGAY$' AND '$DENNGAY$'
      AND CT.IDCHUYEN IS NOT NULL
      <isNotEmpty prepend="AND" property="MAKHO">
        CT.MAKHOXUAT = '$MAKHO$'
      </isNotEmpty>
      <isNotEmpty prepend="AND" property="NGUOINHAP_ID">
        CT.NHANVIENNHAN_ID = '$NGUOINHAP_ID$'
      </isNotEmpty>
      <isNotEmpty prepend="AND" property="TENNGUOITAO">
        CT.TENNGUOITAO LIKE '%$TENNGUOITAO$%'
      </isNotEmpty>
      <isNotEmpty prepend="AND" property="TENPHONGBANNHAN">
        CT.TENPHONGBANNHAN LIKE '%$TENPHONGBANNHAN$%'
      </isNotEmpty>
      <isNotEmpty prepend="AND" property="MACHUNGTU">
        CT.MACHUNGTU LIKE '%$MACHUNGTU$%'
      </isNotEmpty>
    </statement>
    <!--Lấy chi tiết chứng từ xuất vpp-->
    <statement id="DAO09800_GetDetailXUATVPP" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      SELECT  TICHHOP_ID = NULL ,
      CT.CHUNGTUXUAT_ID AS CHUNGTU_ID ,
      LOAI.MA AS MALOAI ,
      HH.TENLOAI ,
      PUR.MA AS MANHOM ,
      HH.TENNHOM ,
      YCCT.MAHANGHOA AS MAHANG ,
      YCCT.TENHANGHOA AS TENHANG ,
      YCCT.TENDONVITINH AS DONVITINH ,
      CTCT.SOLUONGXUAT AS SOLUONG ,
      HH.DONGIA ,
      NULL AS GIATRI ,
      TD.TYLEVAT ,
      NULL AS GIATRIVAT ,
      CTCT.THANHTIEN AS GIATRITHANHTOAN ,
      NULL AS TYLECHIETKHAU ,
      NULL AS GIATRICHIETKHAU ,
      KHUYENMAI = 0
      FROM    dbo.TT_INV_CHUNGTUXUAT CT
      JOIN dbo.TT_INV_CHUNGTUXUATCHITIET CTCT ON CTCT.CHUNGTUXUAT_ID = CT.CHUNGTUXUAT_ID
      JOIN dbo.TT_INV_PHIEUYEUCAUCHITIET YCCT ON CTCT.PHIEUYEUCAUCHITIET_ID = YCCT.PHIEUYEUCAUCHITIET_ID
      JOIN dbo.TM_PUR_HANGHOA HH ON HH.ID = YCCT.HANGHOA_ID
      JOIN TT_INV_THEODOI TD ON TD.THEODOI_ID = CTCT.THEODOI_ID
      LEFT JOIN dbo.TM_PUR_NHOM PUR ON PUR.ID = HH.NHOM_ID
      LEFT JOIN dbo.TM_PUR_LOAI LOAI ON HH.LOAI_ID = LOAI.ID
      WHERE   CT.CHUNGTUXUAT_ID = '$CHUNGTU_ID$';
    </statement>
    <!--Cập nhật IDChuyen vào bảng TT_INV_CHUNGTUXUAT-->
    <update id="DAO09800_UpdateTT_INV_CHUNGTUXUAT_IDChuyen" parameterClass="System.Collections.IDictionary">
      UPDATE dbo.TT_INV_CHUNGTUXUAT SET IDCHUYEN = #CHUYENTICHHOP_ID# WHERE CHUNGTUXUAT_ID = '$CHUNGTU_ID$'
    </update>
    <!--============================================END VĂN PHÒNG PHẨM=============================================-->

    <!--============================================BEGIN VIỆN PHÍ=============================================-->
    <!--Lấy danh sách Viện phí ngoại trú-->
    <statement id="DAO09800_GetMasterVienPhiNgoaiTru" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      DECLARE @TENBENHVIEN NVARCHAR(250);
      SELECT  @TENBENHVIEN = CODE
      FROM    dbo.TM_SYS_APPSETTINGS
      WHERE   BENHVIEN_ID = 'FPT00001'
      AND CODE = 'APP_BENHVIEN_TEN';
      SELECT BTNCHECK = CAST (0 AS BIT) ,* FROM (
      SELECT  HD.HOADON_ID ,HD.SOHOADON ,HD.NGAYHOADON ,HD.LOAIHOADON ,HD.TIEPNHAN_ID ,HD.BENHNHAN_ID ,HD.BENHAN_ID ,BN.MAYTE ,BN.TENBENHNHAN ,BN.DIACHI ,MASOTHUE = NULL ,HD.SOSERIEVAT ,
      HD.TIENTE_ID ,HD.TYGIA ,GIATRI = HD.GIATRITHUCTHU ,HD.GIATRIVAT ,GIATRICHIETKHAU = CAST(NULL AS NUMERIC(25, 4)) ,HD.GIATRIHOADON ,NT.MANHANVIEN ,NT.TENNHANVIEN ,HD.DATHANHTOAN ,
      PHONGBAN_ID = HD.NOITHUTIEN_ID ,NL.MAPHONGBAN ,NL.TENPHONGBAN ,NL.COSTCENTER_ID ,COSTCENTERCODE = COST.MAPHONGBAN ,COSTCENTERNAME = COST.TENPHONGBAN ,HD.BENHVIEN_ID ,MABENHVIEN = HD.BENHVIEN_ID ,TENBENHVIEN = @TENBENHVIEN ,
      HD.IDCHUYEN ,HD.HOANTRA ,HD.IDCHUYENHOAN ,HD.HUYHOADON ,HD.IDCHUYENHUY ,LOAICHUNGTU = 'TH' ,CHUYENTICHHOP_ID = NULL ,SOBENHAN = NULL ,SOTIEPNHAN = TN.SOTIEPNHAN ,STATUSROW = CAST (0 AS BIT) ,MESSAGEROW = NULL
      FROM    dbo.TT_HOADON HD
      JOIN dbo.TT_BENHNHAN BN ON BN.BENHNHAN_ID = HD.BENHNHAN_ID
      JOIN dbo.TT_TIEPNHAN TN ON HD.TIEPNHAN_ID = TN.TIEPNHAN_ID
      JOIN dbo.TM_NHANVIEN NT ON HD.NGUOITHUTIEN_ID = NT.NHANVIEN_ID
      JOIN dbo.TM_PHONGBAN NL ON HD.NOITHUTIEN_ID = NL.PHONGBAN_ID
      LEFT JOIN dbo.TM_PHONGBAN COST ON NL.COSTCENTER_ID = COST.PHONGBAN_ID
      WHERE   HD.BENHVIEN_ID = '$BENHVIEN_ID$'  AND CAST(HD.NGAYHOADON AS DATE) BETWEEN '$TUNGAY$' AND '$DENNGAY$'
      <isNotEmpty prepend="AND" property="SOHOADON">
        HD.SOHOADON LIKE '%$SOHOADON$%'
      </isNotEmpty>
      <isNotEmpty prepend="AND" property="SOTIEPNHAN">
        TN.SOTIEPNHAN LIKE '%$SOTIEPNHAN$%'
      </isNotEmpty>
      <isNotEmpty prepend="AND" property="MAYTE">
        BN.MAYTE LIKE '%$MAYTE$%'
      </isNotEmpty>
      <isNotEmpty prepend="AND" property="TENBENHNHAN">
        BN.TENBENHNHAN LIKE '%$TENBENHNHAN$%'
      </isNotEmpty>
      <isNotEmpty prepend="AND" property="NGUOITHU_ID">
        HD.NGUOITHUTIEN_ID = '$NGUOITHU_ID$'
      </isNotEmpty>
      AND HD.IDCHUYEN IS NULL
      AND HD.DATHANHTOAN = 1
      AND HD.BENHAN_ID IS NULL
      AND HD.TIEPNHAN_ID IS NOT NULL
      UNION ALL
      SELECT  HD.HOADON_ID ,HD.SOHOADON ,HD.THOIGIAN_GHINHANHUY AS NGAYHOADON ,HD.LOAIHOADON ,HD.TIEPNHAN_ID ,HD.BENHNHAN_ID ,HD.BENHAN_ID ,BN.MAYTE ,BN.TENBENHNHAN ,BN.DIACHI ,MASOTHUE = NULL ,HD.SOSERIEVAT ,
      HD.TIENTE_ID ,HD.TYGIA ,GIATRI = HD.GIATRITHUCTHU ,HD.GIATRIVAT ,GIATRICHIETKHAU = CAST(NULL AS NUMERIC(25, 4)) ,HD.GIATRIHOADON ,NT.MANHANVIEN ,NT.TENNHANVIEN ,HD.DATHANHTOAN ,
      PHONGBAN_ID = HD.NOITHUTIEN_ID ,NL.MAPHONGBAN ,NL.TENPHONGBAN ,NL.COSTCENTER_ID ,COSTCENTERCODE = COST.MAPHONGBAN ,COSTCENTERNAME = COST.TENPHONGBAN ,HD.BENHVIEN_ID ,MABENHVIEN = HD.BENHVIEN_ID ,TENBENHVIEN = @TENBENHVIEN ,
      HD.IDCHUYEN ,HD.HOANTRA ,HD.IDCHUYENHOAN ,HD.HUYHOADON ,HD.IDCHUYENHUY ,LOAICHUNGTU = 'TH' ,CHUYENTICHHOP_ID = NULL ,SOBENHAN = NULL ,SOTIEPNHAN = TN.SOTIEPNHAN ,STATUSROW = CAST (0 AS BIT) ,MESSAGEROW = NULL
      FROM    dbo.TT_HOADON HD
      JOIN dbo.TT_BENHNHAN BN ON BN.BENHNHAN_ID = HD.BENHNHAN_ID
      JOIN dbo.TT_TIEPNHAN TN ON HD.TIEPNHAN_ID = TN.TIEPNHAN_ID
      JOIN dbo.TM_NHANVIEN NT ON HD.NGUOITHUTIEN_ID = NT.NHANVIEN_ID
      JOIN dbo.TM_PHONGBAN NL ON HD.NOITHUTIEN_ID = NL.PHONGBAN_ID
      LEFT JOIN dbo.TM_PHONGBAN COST ON NL.COSTCENTER_ID = COST.PHONGBAN_ID
      WHERE   HD.BENHVIEN_ID = '$BENHVIEN_ID$'  AND CAST(HD.THOIGIAN_GHINHANHUY AS DATE) BETWEEN '$TUNGAY$' AND '$DENNGAY$'
      <isNotEmpty prepend="AND" property="SOHOADON">
        HD.SOHOADON LIKE '%$SOHOADON$%'
      </isNotEmpty>
      <isNotEmpty prepend="AND" property="SOTIEPNHAN">
        TN.SOTIEPNHAN LIKE '%$SOTIEPNHAN$%'
      </isNotEmpty>
      <isNotEmpty prepend="AND" property="MAYTE">
        BN.MAYTE LIKE '%$MAYTE$%'
      </isNotEmpty>
      <isNotEmpty prepend="AND" property="TENBENHNHAN">
        BN.TENBENHNHAN LIKE '%$TENBENHNHAN$%'
      </isNotEmpty>
      <isNotEmpty prepend="AND" property="NGUOITHU_ID">
        HD.NGUOITHUTIEN_ID = '$NGUOITHU_ID$'
      </isNotEmpty>
      AND HD.DATHANHTOAN = 1
      AND ( (HD.HUYHOADON = 1 AND HD.IDCHUYENHUY IS NULL)
      OR (HD.HOANTRA = 1 AND HD.IDCHUYENHOAN IS NULL)
      )
      AND HD.BENHAN_ID IS NULL
      AND HD.TIEPNHAN_ID IS NOT NULL
      ) HD
      ORDER BY HD.NGAYHOADON , HD.SOHOADON
    </statement>
    <!--Lấy danh sách Viện phí ngoại trú đã chuyển-->
    <statement id="DAO09800_GetMasterVienPhiNgoaiTru_DACHUYEN" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      DECLARE @TENBENHVIEN NVARCHAR(250);
      SELECT  @TENBENHVIEN = CODE
      FROM    dbo.TM_SYS_APPSETTINGS
      WHERE   BENHVIEN_ID = 'FPT00001'
      AND CODE = 'APP_BENHVIEN_TEN';
      SELECT BTNCHECK = CAST (0 AS BIT) , * FROM (
      SELECT  HD.HOADON_ID ,HD.SOHOADON ,HD.NGAYHOADON ,HD.LOAIHOADON ,HD.TIEPNHAN_ID ,HD.BENHNHAN_ID ,HD.BENHAN_ID ,BN.MAYTE ,BN.TENBENHNHAN ,BN.DIACHI ,MASOTHUE = NULL ,HD.SOSERIEVAT ,
      HD.TIENTE_ID ,HD.TYGIA ,GIATRI = HD.GIATRITHUCTHU ,HD.GIATRIVAT ,GIATRICHIETKHAU = CAST(NULL AS NUMERIC(25, 4)) ,HD.GIATRIHOADON ,NT.MANHANVIEN ,NT.TENNHANVIEN ,HD.DATHANHTOAN ,
      PHONGBAN_ID = HD.NOITHUTIEN_ID ,NL.MAPHONGBAN ,NL.TENPHONGBAN ,NL.COSTCENTER_ID ,COSTCENTERCODE = COST.MAPHONGBAN ,COSTCENTERNAME = COST.TENPHONGBAN ,HD.BENHVIEN_ID ,MABENHVIEN = HD.BENHVIEN_ID ,TENBENHVIEN = @TENBENHVIEN ,
      HD.IDCHUYEN ,HD.HOANTRA ,HD.IDCHUYENHOAN ,HD.HUYHOADON ,HD.IDCHUYENHUY ,LOAICHUNGTU = 'TH' ,CHUYENTICHHOP_ID = NULL ,SOBENHAN = NULL ,SOTIEPNHAN = TN.SOTIEPNHAN ,STATUSROW = CAST (0 AS BIT) ,MESSAGEROW = NULL
      FROM    dbo.TT_HOADON HD
      JOIN dbo.TT_BENHNHAN BN ON BN.BENHNHAN_ID = HD.BENHNHAN_ID
      JOIN dbo.TT_TIEPNHAN TN ON HD.TIEPNHAN_ID = TN.TIEPNHAN_ID
      JOIN dbo.TM_NHANVIEN NT ON HD.NGUOITHUTIEN_ID = NT.NHANVIEN_ID
      JOIN dbo.TM_PHONGBAN NL ON HD.NOITHUTIEN_ID = NL.PHONGBAN_ID
      LEFT JOIN dbo.TM_PHONGBAN COST ON NL.COSTCENTER_ID = COST.PHONGBAN_ID
      WHERE   HD.BENHVIEN_ID = '$BENHVIEN_ID$'  AND CAST(HD.NGAYHOADON AS DATE) BETWEEN '$TUNGAY$' AND '$DENNGAY$'
      <isNotEmpty prepend="AND" property="SOHOADON">
        HD.SOHOADON LIKE '%$SOHOADON$%'
      </isNotEmpty>
      <isNotEmpty prepend="AND" property="SOTIEPNHAN">
        TN.SOTIEPNHAN LIKE '%$SOTIEPNHAN$%'
      </isNotEmpty>
      <isNotEmpty prepend="AND" property="MAYTE">
        BN.MAYTE LIKE '%$MAYTE$%'
      </isNotEmpty>
      <isNotEmpty prepend="AND" property="TENBENHNHAN">
        BN.TENBENHNHAN LIKE '%$TENBENHNHAN$%'
      </isNotEmpty>
      <isNotEmpty prepend="AND" property="NGUOITHU_ID">
        HD.NGUOITHUTIEN_ID = '$NGUOITHU_ID$'
      </isNotEmpty>
      AND HD.IDCHUYEN IS NOT NULL
      AND HD.DATHANHTOAN = 1
      AND HD.BENHAN_ID IS NULL
      AND HD.TIEPNHAN_ID IS NOT NULL
      UNION ALL
      SELECT  HD.HOADON_ID ,HD.SOHOADON ,HD.THOIGIAN_GHINHANHUY AS NGAYHOADON ,HD.LOAIHOADON ,HD.TIEPNHAN_ID ,HD.BENHNHAN_ID ,HD.BENHAN_ID ,BN.MAYTE ,BN.TENBENHNHAN ,BN.DIACHI ,MASOTHUE = NULL ,HD.SOSERIEVAT ,
      HD.TIENTE_ID ,HD.TYGIA ,GIATRI = HD.GIATRITHUCTHU ,HD.GIATRIVAT ,GIATRICHIETKHAU = CAST(NULL AS NUMERIC(25, 4)) ,HD.GIATRIHOADON ,NT.MANHANVIEN ,NT.TENNHANVIEN ,HD.DATHANHTOAN ,
      PHONGBAN_ID = HD.NOITHUTIEN_ID ,NL.MAPHONGBAN ,NL.TENPHONGBAN ,NL.COSTCENTER_ID ,COSTCENTERCODE = COST.MAPHONGBAN ,COSTCENTERNAME = COST.TENPHONGBAN ,HD.BENHVIEN_ID ,MABENHVIEN = HD.BENHVIEN_ID ,TENBENHVIEN = @TENBENHVIEN ,
      HD.IDCHUYEN ,HD.HOANTRA ,HD.IDCHUYENHOAN ,HD.HUYHOADON ,HD.IDCHUYENHUY ,LOAICHUNGTU = 'TH' ,CHUYENTICHHOP_ID = NULL ,SOBENHAN = NULL ,SOTIEPNHAN = TN.SOTIEPNHAN ,STATUSROW = CAST (0 AS BIT) ,MESSAGEROW = NULL
      FROM    dbo.TT_HOADON HD
      JOIN dbo.TT_BENHNHAN BN ON BN.BENHNHAN_ID = HD.BENHNHAN_ID
      JOIN dbo.TT_TIEPNHAN TN ON HD.TIEPNHAN_ID = TN.TIEPNHAN_ID
      JOIN dbo.TM_NHANVIEN NT ON HD.NGUOITHUTIEN_ID = NT.NHANVIEN_ID
      JOIN dbo.TM_PHONGBAN NL ON HD.NOITHUTIEN_ID = NL.PHONGBAN_ID
      LEFT JOIN dbo.TM_PHONGBAN COST ON NL.COSTCENTER_ID = COST.PHONGBAN_ID
      WHERE   HD.BENHVIEN_ID = '$BENHVIEN_ID$'  AND CAST(HD.THOIGIAN_GHINHANHUY AS DATE) BETWEEN '$TUNGAY$' AND '$DENNGAY$'
      <isNotEmpty prepend="AND" property="SOHOADON">
        HD.SOHOADON LIKE '%$SOHOADON$%'
      </isNotEmpty>
      <isNotEmpty prepend="AND" property="SOTIEPNHAN">
        TN.SOTIEPNHAN LIKE '%$SOTIEPNHAN$%'
      </isNotEmpty>
      <isNotEmpty prepend="AND" property="MAYTE">
        BN.MAYTE LIKE '%$MAYTE$%'
      </isNotEmpty>
      <isNotEmpty prepend="AND" property="TENBENHNHAN">
        BN.TENBENHNHAN LIKE '%$TENBENHNHAN$%'
      </isNotEmpty>
      <isNotEmpty prepend="AND" property="NGUOITHU_ID">
        HD.NGUOITHUTIEN_ID = '$NGUOITHU_ID$'
      </isNotEmpty>
      AND HD.DATHANHTOAN = 1
      AND ( (HD.HUYHOADON = 1 AND HD.IDCHUYENHUY IS NOT NULL)
      OR (HD.HOANTRA = 1 AND HD.IDCHUYENHOAN IS NOT NULL)
      )
      AND HD.BENHAN_ID IS NULL
      AND HD.TIEPNHAN_ID IS NOT NULL
      )HD
      ORDER BY HD.NGAYHOADON , HD.SOHOADON
    </statement>


    <!--Cập nhật IDChuyen vào bảng TT_HOADON-->
    <update id="DAO09800_UpdateHoaDon_IDChuyen" parameterClass="System.Collections.IDictionary">
      UPDATE dbo.TT_HOADON SET IDCHUYEN = #CHUYENTICHHOP_ID#  WHERE HOADON_ID = '$HOADON_ID$'
    </update>
    <!--Cập nhật IDCHUYENHUY vào bảng TT_HOADON-->
    <update id="DAO09800_UpdateHoaDon_IDCHUYENHUY" parameterClass="System.Collections.IDictionary">
      UPDATE dbo.TT_HOADON SET IDCHUYENHUY = #CHUYENTICHHOP_ID#  WHERE HOADON_ID = '$HOADON_ID$'
    </update>
    <!--Cập nhật IDCHUYENHOAN vào bảng TT_HOADON-->
    <update id="DAO09800_UpdateHoaDon_IDCHUYENHOAN" parameterClass="System.Collections.IDictionary">
      UPDATE dbo.TT_HOADON SET IDCHUYENHOAN = #CHUYENTICHHOP_ID#  WHERE HOADON_ID = '$HOADON_ID$'
    </update>
    <!--============================================END VIỆN PHÍ=============================================-->

    <!--============================================BEGIN VIỆN PHÍ - BÁN THUỐC TẠI QUẦY=============================================-->
    <!--Lấy danh sách doanh thu bán thuốc tại quầy-->
    <statement id="DAO09800_GetMasterDoanhThuBanThuocTaiQuay" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      
    </statement>
    <!--Lấy danh sách doanh thu bán thuốc tại quầy đã chuyển-->
    <statement id="DAO09800_GetMasterDoanhThuBanThuocTaiQuay_DACHUYEN" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      
    </statement>
    <!--Lấy chi tiết doanh thu bán thuốc tại quầy-->
    <statement id="DAO09800_GetDetailDoanhThuBanThuocTaiQuay" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      
    </statement>
    <!--Lấy chi tiết doanh thu bán thuốc tại quầy httt-->
    <statement id="DAO09800_GetDetailDoanhThuBanThuocTaiQuayHTTT" parameterClass="System.Collections.IDictionary" resultClass="DataObject">

    </statement>
    <!--Cập nhật IDChuyen vào bảng doanh thu bán thuốc tại quầy-->
    <update id="DAO09800_UpdateDoanhThuBanThuocTaiQuay_IDChuyen" parameterClass="System.Collections.IDictionary">
      
    </update>
    <!--============================================END VIỆN PHÍ - BÁN THUỐC TẠI QUẦY=============================================-->

    <!--============================================BEGIN BHTN=============================================-->
    <!--Lấy danh sách BHTN-->
    <statement id="DAO09800_GetMasterBHTN" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      DECLARE @TENBENHVIEN NVARCHAR(250);
      SELECT  @TENBENHVIEN = CODE
      FROM    dbo.TM_SYS_APPSETTINGS
      WHERE   BENHVIEN_ID =  'FPT00001'
      AND CODE = 'APP_BENHVIEN_TEN';

      SELECT
      BTNCHECK = CAST (0 AS BIT) ,MIENGIAM_BHTN_ID ,SOPHIEUBHTN ,CT.TIEPNHAN_ID ,SOTN_BA = tn.SOTIEPNHAN,CT.BENHAN_ID ,CT.BENHNHAN_ID ,CONGTYBHTN_ID ,MACONGTY ,TENCONGTY ,SOTHEBHTN ,MAYTE ,TENBENHNHAN ,BN.DIACHI ,MASOTHUE ,
      TIENTE_ID = 'VND' ,TYGIA = 1 ,GIATRI = VP.BHTN_THANHTIEN_CHITRA,GIATRIVAT = NULL ,GIATRICHIETKHAU = NULL  ,GIATRIHOADON = VP.GIATRI_HOADON_DATHANHTOAN ,GHICHU = NULL,MANHANVIEN ,TENNHANVIEN ,COSTCENTER_ID = NULL ,COSTCENTERCODE = NULL,COSTCENTERNAME = NULL,CT.BENHVIEN_ID ,
      CT.BENHVIEN_ID AS MABENHVIEN ,TENBENHVIEN = @TENBENHVIEN ,IDCHUYEN ,IDCHUYENHUY ,IDCHUYENHOAN ,CHUYENTICHHOP_ID = NULL,LOAICHUNGTU = VP.LOAI_CHIPHI,NGAYDUYET ,NGUOIDUYET_ID ,ND.TENNHANVIEN AS TENNGUOIDUYET ,STATUSROW = CAST (0 AS BIT) ,
      MESSAGEROW = NULL
      FROM dbo.TT_MIENGIAM_BHTN CT
      JOIN dbo.TT_MIENGIAM_CHITIET CTCT ON CTCT.MIENGIAM_ID = CT.MIENGIAM_BHTN_ID
      JOIN dbo.TT_TIEPNHAN TN ON TN.TIEPNHAN_ID = CT.TIEPNHAN_ID
      JOIN dbo.TT_BENHNHAN BN ON TN.BENHNHAN_ID = BN.BENHNHAN_ID
      JOIN dbo.TT_VIENPHI VP ON VP.VIENPHI_ID = CTCT.VIENPHI_ID
      JOIN dbo.TM_CONGTYBAOHIEM CTBH ON CTBH.CONGTY_ID = CT.CONGTYBHTN_ID
      LEFT JOIN dbo.TM_NHANVIEN ND ON ND.NHANVIEN_ID = CT.NGUOIDUYET_ID
      WHERE CTCT.REF_TABLE = 'TT_MIENGIAM_BHTN'
      AND CT.BENHVIEN_ID = '$BENHVIEN_ID$'  AND CAST(CT.NGAYDUYET AS DATE) BETWEEN '$TUNGAY$' AND '$DENNGAY$'
      AND CT.IDCHUYEN IS NULL
      <isNotEmpty prepend="AND" property="MAYTE">
        BN.MAYTE LIKE '%$MAYTE$%'
      </isNotEmpty>
      <isNotEmpty prepend="AND" property="SOTN_BA">
        TN.SOTIEPNHAN LIKE '%$SOTN_BA$%'
      </isNotEmpty>
      <isNotEmpty prepend="AND" property="TENBENHNHAN">
        BN.TENBENHNHAN LIKE '%$TENBENHNHAN$%'
      </isNotEmpty>
      <isNotEmpty prepend="AND" property="TENCONGTY">
        TENCONGTY LIKE '%$TENCONGTY$%'
      </isNotEmpty>

      UNION

      SELECT
      BTNCHECK = CAST (0 AS BIT) ,MIENGIAM_BHTN_ID ,SOPHIEUBHTN ,CT.TIEPNHAN_ID ,SOTN_BA = ba.SOBENHAN,CT.BENHAN_ID ,CT.BENHNHAN_ID ,CONGTYBHTN_ID ,MACONGTY ,TENCONGTY ,SOTHEBHTN ,MAYTE ,TENBENHNHAN ,BN.DIACHI ,MASOTHUE ,
      TIENTE_ID = 'VND' ,TYGIA = 1 ,GIATRI = VP.BHTN_THANHTIEN_CHITRA,GIATRIVAT = NULL ,GIATRICHIETKHAU = NULL  ,GIATRIHOADON = VP.GIATRI_HOADON_DATHANHTOAN ,GHICHU = NULL,MANHANVIEN ,TENNHANVIEN ,COSTCENTER_ID = NULL ,COSTCENTERCODE = NULL,COSTCENTERNAME = NULL,CT.BENHVIEN_ID ,
      CT.BENHVIEN_ID AS MABENHVIEN ,TENBENHVIEN = @TENBENHVIEN ,IDCHUYEN ,IDCHUYENHUY ,IDCHUYENHOAN ,CHUYENTICHHOP_ID = NULL,LOAICHUNGTU = VP.LOAI_CHIPHI,NGAYDUYET ,NGUOIDUYET_ID ,ND.TENNHANVIEN AS TENNGUOIDUYET ,STATUSROW = CAST (0 AS BIT) ,
      MESSAGEROW = NULL
      FROM dbo.TT_MIENGIAM_BHTN CT
      JOIN dbo.TT_MIENGIAM_CHITIET CTCT ON CTCT.MIENGIAM_ID = CT.MIENGIAM_BHTN_ID
      JOIN dbo.TT_NOITRU_BENHAN BA ON BA.BENHAN_ID = CT.BENHAN_ID
      JOIN dbo.TT_BENHNHAN BN ON BA.BENHNHAN_ID = BN.BENHNHAN_ID
      JOIN dbo.TT_VIENPHI VP ON VP.VIENPHI_ID = CTCT.VIENPHI_ID
      JOIN dbo.TM_CONGTYBAOHIEM CTBH ON CTBH.CONGTY_ID = CT.CONGTYBHTN_ID
      LEFT JOIN dbo.TM_NHANVIEN ND ON ND.NHANVIEN_ID = CT.NGUOIDUYET_ID
      WHERE CTCT.REF_TABLE = 'TT_MIENGIAM_BHTN'
      AND CT.BENHVIEN_ID = '$BENHVIEN_ID$'  AND CAST(CT.NGAYDUYET AS DATE) BETWEEN '$TUNGAY$' AND '$DENNGAY$'
      AND CT.IDCHUYEN IS NULL
      <isNotEmpty prepend="AND" property="MAYTE">
        BN.MAYTE LIKE '%$MAYTE$%'
      </isNotEmpty>
      <isNotEmpty prepend="AND" property="SOTN_BA">
        ba.SOBENHAN LIKE '%$SOTN_BA$%'
      </isNotEmpty>
      <isNotEmpty prepend="AND" property="TENBENHNHAN">
        BN.TENBENHNHAN LIKE '%$TENBENHNHAN$%'
      </isNotEmpty>
      <isNotEmpty prepend="AND" property="TENCONGTY">
        TENCONGTY LIKE '%$TENCONGTY$%'
      </isNotEmpty>
    </statement>
    <!--Lấy danh sách BHTN đã chuyển-->
    <statement id="DAO09800_GetMasterBHTN_DACHUYEN" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      DECLARE @TENBENHVIEN NVARCHAR(250);
      SELECT  @TENBENHVIEN = CODE
      FROM    dbo.TM_SYS_APPSETTINGS
      WHERE   BENHVIEN_ID =  'FPT00001'
      AND CODE = 'APP_BENHVIEN_TEN';

      SELECT
      BTNCHECK = CAST (0 AS BIT) ,MIENGIAM_BHTN_ID ,SOPHIEUBHTN ,CT.TIEPNHAN_ID ,CT.BENHAN_ID ,CT.BENHNHAN_ID ,CONGTYBHTN_ID ,MACONGTY ,TENCONGTY ,SOTHEBHTN ,MAYTE ,TENBENHNHAN ,BN.DIACHI ,MASOTHUE ,
      TIENTE_ID = 'VND' ,TYGIA = 1 ,GIATRI = VP.BHTN_THANHTIEN_CHITRA,GIATRIVAT = NULL ,GIATRICHIETKHAU = NULL  ,GIATRIHOADON = VP.GIATRI_HOADON_DATHANHTOAN ,GHICHU = NULL,MANHANVIEN ,TENNHANVIEN ,COSTCENTER_ID = NULL ,COSTCENTERCODE = NULL,COSTCENTERNAME = NULL,CT.BENHVIEN_ID ,
      CT.BENHVIEN_ID AS MABENHVIEN ,TENBENHVIEN = @TENBENHVIEN ,IDCHUYEN ,IDCHUYENHUY ,IDCHUYENHOAN ,CHUYENTICHHOP_ID = NULL,LOAICHUNGTU = VP.LOAI_CHIPHI,NGAYDUYET ,NGUOIDUYET_ID ,ND.TENNHANVIEN AS TENNGUOIDUYET ,STATUSROW = CAST (0 AS BIT) ,
      MESSAGEROW = NULL
      FROM dbo.TT_MIENGIAM_BHTN CT
      JOIN dbo.TT_MIENGIAM_CHITIET CTCT ON CTCT.MIENGIAM_ID = CT.MIENGIAM_BHTN_ID
      JOIN dbo.TT_TIEPNHAN TN ON TN.TIEPNHAN_ID = CT.TIEPNHAN_ID
      JOIN dbo.TT_BENHNHAN BN ON TN.BENHNHAN_ID = BN.BENHNHAN_ID
      JOIN dbo.TT_VIENPHI VP ON VP.VIENPHI_ID = CTCT.VIENPHI_ID
      JOIN dbo.TM_CONGTYBAOHIEM CTBH ON CTBH.CONGTY_ID = CT.CONGTYBHTN_ID
      LEFT JOIN dbo.TM_NHANVIEN ND ON ND.NHANVIEN_ID = CT.NGUOIDUYET_ID
      WHERE CTCT.REF_TABLE = 'TT_MIENGIAM_BHTN'
      AND CT.BENHVIEN_ID = '$BENHVIEN_ID$'  AND CAST(CT.NGAYDUYET AS DATE) BETWEEN '$TUNGAY$' AND '$DENNGAY$'
      AND CT.IDCHUYEN IS NOT NULL
      <isNotEmpty prepend="AND" property="MAYTE">
        BN.MAYTE LIKE '%$MAYTE$%'
      </isNotEmpty>
      <isNotEmpty prepend="AND" property="SOTN_BA">
        TN.SOTIEPNHAN LIKE '%$SOTN_BA$%'
      </isNotEmpty>
      <isNotEmpty prepend="AND" property="TENBENHNHAN">
        BN.TENBENHNHAN LIKE '%$TENBENHNHAN$%'
      </isNotEmpty>
      <isNotEmpty prepend="AND" property="TENCONGTY">
        TENCONGTY LIKE '%$TENCONGTY$%'
      </isNotEmpty>

      UNION

      SELECT
      BTNCHECK = CAST (0 AS BIT) ,MIENGIAM_BHTN_ID ,SOPHIEUBHTN ,CT.TIEPNHAN_ID ,CT.BENHAN_ID ,CT.BENHNHAN_ID ,CONGTYBHTN_ID ,MACONGTY ,TENCONGTY ,SOTHEBHTN ,MAYTE ,TENBENHNHAN ,BN.DIACHI ,MASOTHUE ,
      TIENTE_ID = 'VND' ,TYGIA = 1 ,GIATRI = VP.BHTN_THANHTIEN_CHITRA,GIATRIVAT = NULL ,GIATRICHIETKHAU = NULL  ,GIATRIHOADON = VP.GIATRI_HOADON_DATHANHTOAN ,GHICHU = NULL,MANHANVIEN ,TENNHANVIEN ,COSTCENTER_ID = NULL ,COSTCENTERCODE = NULL,COSTCENTERNAME = NULL,CT.BENHVIEN_ID ,
      CT.BENHVIEN_ID AS MABENHVIEN ,TENBENHVIEN = @TENBENHVIEN ,IDCHUYEN ,IDCHUYENHUY ,IDCHUYENHOAN ,CHUYENTICHHOP_ID = NULL,LOAICHUNGTU = VP.LOAI_CHIPHI,NGAYDUYET ,NGUOIDUYET_ID ,ND.TENNHANVIEN AS TENNGUOIDUYET ,STATUSROW = CAST (0 AS BIT) ,
      MESSAGEROW = NULL
      FROM dbo.TT_MIENGIAM_BHTN CT
      JOIN dbo.TT_MIENGIAM_CHITIET CTCT ON CTCT.MIENGIAM_ID = CT.MIENGIAM_BHTN_ID
      JOIN dbo.TT_NOITRU_BENHAN BA ON BA.BENHAN_ID = CT.BENHAN_ID
      JOIN dbo.TT_BENHNHAN BN ON BA.BENHNHAN_ID = BN.BENHNHAN_ID
      JOIN dbo.TT_VIENPHI VP ON VP.VIENPHI_ID = CTCT.VIENPHI_ID
      JOIN dbo.TM_CONGTYBAOHIEM CTBH ON CTBH.CONGTY_ID = CT.CONGTYBHTN_ID
      LEFT JOIN dbo.TM_NHANVIEN ND ON ND.NHANVIEN_ID = CT.NGUOIDUYET_ID
      WHERE CTCT.REF_TABLE = 'TT_MIENGIAM_BHTN'
      AND CT.BENHVIEN_ID = '$BENHVIEN_ID$'  AND CAST(CT.NGAYDUYET AS DATE) BETWEEN '$TUNGAY$' AND '$DENNGAY$'
      AND CT.IDCHUYEN IS NOT NULL
      <isNotEmpty prepend="AND" property="MAYTE">
        BN.MAYTE LIKE '%$MAYTE$%'
      </isNotEmpty>
      <isNotEmpty prepend="AND" property="SOTN_BA">
        ba.SOBENHAN LIKE '%$SOTN_BA$%'
      </isNotEmpty>
      <isNotEmpty prepend="AND" property="TENBENHNHAN">
        BN.TENBENHNHAN LIKE '%$TENBENHNHAN$%'
      </isNotEmpty>
      <isNotEmpty prepend="AND" property="TENCONGTY">
        TENCONGTY LIKE '%$TENCONGTY$%'
      </isNotEmpty>
    </statement>
    <!--Lấy chi tiết BHTN-->
    <statement id="DAO09800_GetDetailBHTN" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      SELECT TICHHOP_ID =null,MIENGIAM_BHTN_ID ,MAKHOANMUCDT = null ,TENKHOANMUCDT =null,LOAIVATTU_ID = D.DUOC_ID ,MALOAIDUOC ,TENLOAIDUOC ,MADUOC ,TENDUOC ,MALOAIDICHVU ,TENLOAIDICHVU ,MANHOMDICHVU ,
      TENNHOMDICHVU ,MADICHVU ,TENDICHVU ,DV.DONVITINH ,SOLUONG ,DONGIA = VP.BHTN_THANHTIEN_CHITRA ,TYLEVAT = D.TYLE_VAT ,GIATRIVAT = NULL ,GIATRICHIETKHAU = NULL,GIATRIHOADON =VP.GIATRI_HOADON_DATHANHTOAN,LOAINOIDUNG = CASE WHEN VP.DICHVU_ID = NULL THEN 'DU' ELSE 'DV' END ,
      MANOITHUCHIEN = NULL,NOITHUCHIEN = NULL, MAKHOXUAT = NULL,TENKHOXUAT = NULL,MAKHOAXUAT = NULL,TENKHOAXUAT = NULL
      FROM dbo.TT_MIENGIAM_BHTN CT
      JOIN dbo.TT_MIENGIAM_CHITIET CTCT ON CTCT.MIENGIAM_ID = CT.MIENGIAM_BHTN_ID
      JOIN dbo.TT_VIENPHI VP ON VP.VIENPHI_ID = CTCT.VIENPHI_ID
      LEFT JOIN dbo.TM_DICHVU DV ON DV.DICHVU_ID = VP.DICHVU_ID
      LEFT JOIN dbo.TM_NHOMDICHVU NDV ON NDV.NHOMDICHVU_ID = DV.NHOMDICHVU_ID
      LEFT JOIN dbo.TM_LOAIDICHVU LDV ON LDV.LOAIDICHVU_ID = NDV.LOAIDICHVU_ID
      LEFT JOIN dbo.TM_DUOC D ON D.DUOC_ID = VP.DUOC_ID
      LEFT JOIN dbo.TM_LOAIDUOC LD ON LD.LOAIDUOC_ID = D.LOAIDUOC_ID
      LEFT JOIN dbo.TM_TENDUOC TD ON TD.TENDUOC_ID = D.TENDUOC_ID
      WHERE CTCT.REF_TABLE = 'TT_MIENGIAM_BHTN'
      AND CT.MIENGIAM_BHTN_ID = '$MIENGIAM_BHTN_ID$'
    </statement>
    <!--Cập nhật IDChuyen vào bảng BHTN-->
    <update id="DAO09800_UpdateBHTN_IDChuyen" parameterClass="System.Collections.IDictionary">
      UPDATE dbo.TT_MIENGIAM_BHTN SET IDCHUYEN = #CHUYENTICHHOP_ID# WHERE MIENGIAM_BHTN_ID = '$MIENGIAM_BHTN_ID$'
    </update>
    <!--============================================END BHTN=============================================-->

    <!--============================================BEGIN BHYT=============================================-->
    <!--Lấy danh sách BHYT-->
    <statement id="DAO09800_GetMasterBHYT" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      DECLARE @TENBENHVIEN NVARCHAR(250);
      SELECT  @TENBENHVIEN = CODE
      FROM    dbo.TM_SYS_APPSETTINGS
      WHERE   BENHVIEN_ID =  '$BENHVIEN_ID$'
      AND CODE = 'APP_BENHVIEN_TEN';

      SELECT  BTNCHECK = CAST (0 AS BIT) ,CT.XACNHANCHIPHI_ID ,
      CT.SOXACNHAN ,
      CT.NGAYXACNHAN ,
      CT.THOIGIANXACNHAN ,
      CT.TIEPNHAN_ID ,
      CT.BENHAN_ID ,
      CT.BENHNHAN_ID ,
      BN.MAYTE ,
      BN.TENBENHNHAN ,
      BN.DIACHI ,
      MASOTHUE = NULL ,
      TN.SOTIEPNHAN ,
      SOBENHAN = NULL ,
      SOTN_BA = tn.SOTIEPNHAN,
      TIENTE_ID = 'VND' ,
      TYGIA = 1 ,
      GIATRI = NULL ,
      GIATRIVAT = NULL ,
      GIATRICHIETKHAU = NULL ,
      CTCT.DONGIATHANHTOAN AS GIATRITHANHTOAN ,
      GHICHU = NULL,
      LOAI = N'Ngoại trú' ,
      CT.BENHVIEN_ID ,
      CT.BENHVIEN_ID AS MABENHVIEN ,
      TENBENHVIEN = @TENBENHVIEN ,
      CT.IDCHUYEN ,
      PB.TENPHONGBAN,
      NULL AS CHUYENTICHHOP_ID ,
      CT.SOBHYT,
      STATUSROW = CAST (0 AS BIT) ,
      MESSAGEROW = NULL
      FROM    dbo.TT_XACNHANCHIPHI CT
      JOIN dbo.TT_XACNHANCHIPHICHITIET CTCT ON CTCT.XACNHANCHIPHI_ID = CT.XACNHANCHIPHI_ID
      JOIN dbo.TT_TIEPNHAN TN ON TN.TIEPNHAN_ID = CT.TIEPNHAN_ID
      JOIN dbo.TT_BENHNHAN BN ON TN.BENHNHAN_ID = BN.BENHNHAN_ID
      JOIN dbo.TM_PHONGBAN PB ON PB.PHONGBAN_ID = CTCT.PHONGBAN_ID
      WHERE   CT.BENHVIEN_ID = '$BENHVIEN_ID$' AND CAST(CT.NGAYXACNHAN AS DATE) BETWEEN '$TUNGAY$' AND '$DENNGAY$'
      AND CT.IDCHUYEN IS NULL
      <isNotEmpty prepend="AND" property="MAYTE">
			  BN.MAYTE LIKE '%$MAYTE$%'
		  </isNotEmpty>
		  <isNotEmpty prepend="AND" property="SOTN_BA">
			  TN.SOTIEPNHAN LIKE '%$SOTN_BA$%'
		  </isNotEmpty>
		  <isNotEmpty prepend="AND" property="TENBENHNHAN">
			  BN.TENBENHNHAN LIKE '%$TENBENHNHAN$%'
		  </isNotEmpty>

      UNION all

      SELECT  BTNCHECK = CAST (0 AS BIT) ,CT.XACNHANCHIPHI_ID ,
      CT.SOXACNHAN ,
      CT.NGAYXACNHAN ,
      CT.THOIGIANXACNHAN ,
      CT.TIEPNHAN_ID ,
      CT.BENHAN_ID ,
      CT.BENHNHAN_ID ,
      BN.MAYTE ,
      BN.TENBENHNHAN ,
      BN.DIACHI ,
      MASOTHUE = NULL ,
      SOTIEPNHAN = NULL ,
      SOBENHAN = ba.SOBENHAN ,
      SOTN_BA = ba.SOBENHAN ,
      TIENTE_ID = 'VND' ,
      TYGIA = 1 ,
      GIATRI = NULL ,
      GIATRIVAT = NULL ,
      GIATRICHIETKHAU = NULL ,
      CTCT.DONGIATHANHTOAN AS GIATRITHANHTOAN ,
      GHICHU = NULL,
      LOAI = N'Nội trú' ,
      CT.BENHVIEN_ID ,
      CT.BENHVIEN_ID AS MABENHVIEN ,
      TENBENHVIEN = @TENBENHVIEN ,
      CT.IDCHUYEN ,
      PB.TENPHONGBAN,
      NULL AS CHUYENTICHHOP_ID ,
      CT.SOBHYT,
      STATUSROW = CAST (0 AS BIT) ,
      MESSAGEROW = NULL
      FROM    dbo.TT_XACNHANCHIPHI CT
      JOIN dbo.TT_XACNHANCHIPHICHITIET CTCT ON CTCT.XACNHANCHIPHI_ID = CT.XACNHANCHIPHI_ID
      JOIN dbo.TT_NOITRU_BENHAN BA ON BA.BENHAN_ID = CT.BENHAN_ID
      JOIN dbo.TT_BENHNHAN BN ON BA.BENHNHAN_ID = BN.BENHNHAN_ID
      JOIN dbo.TM_PHONGBAN PB ON PB.PHONGBAN_ID = CTCT.PHONGBAN_ID
      WHERE   CT.BENHVIEN_ID = '$BENHVIEN_ID$' AND CAST(CT.NGAYXACNHAN AS DATE) BETWEEN '$TUNGAY$' AND '$DENNGAY$'
      AND CT.IDCHUYEN IS NULL
      <isNotEmpty prepend="AND" property="MAYTE">
			  BN.MAYTE LIKE '%$MAYTE$%'
		  </isNotEmpty>
		  <isNotEmpty prepend="AND" property="SOTN_BA">
			  ba.SOBENHAN LIKE '%$SOTN_BA$%'
		  </isNotEmpty>
		  <isNotEmpty prepend="AND" property="TENBENHNHAN">
			  BN.TENBENHNHAN LIKE '%$TENBENHNHAN$%'
		  </isNotEmpty>
    </statement>
    <!--Lấy danh sách BHYT đã chuyển-->
    <statement id="DAO09800_GetMasterBHYT_DACHUYEN" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      DECLARE @TENBENHVIEN NVARCHAR(250);
      SELECT  @TENBENHVIEN = CODE
      FROM    dbo.TM_SYS_APPSETTINGS
      WHERE   BENHVIEN_ID =  '$BENHVIEN_ID$'
      AND CODE = 'APP_BENHVIEN_TEN';

      SELECT  BTNCHECK = CAST (0 AS BIT) ,CT.XACNHANCHIPHI_ID ,
      CT.SOXACNHAN ,
      CT.NGAYXACNHAN ,
      CT.THOIGIANXACNHAN ,
      CT.TIEPNHAN_ID ,
      CT.BENHAN_ID ,
      CT.BENHNHAN_ID ,
      BN.MAYTE ,
      BN.TENBENHNHAN ,
      BN.DIACHI ,
      MASOTHUE = NULL ,
      TN.SOTIEPNHAN ,
      SOBENHAN = NULL ,
      SOTN_BA = tn.SOTIEPNHAN,
      TIENTE_ID = 'VND' ,
      TYGIA = 1 ,
      GIATRI = NULL ,
      GIATRIVAT = NULL ,
      GIATRICHIETKHAU = NULL ,
      CTCT.DONGIATHANHTOAN AS GIATRITHANHTOAN ,
      GHICHU = NULL,
      LOAI = N'Nội trú' ,
      CT.BENHVIEN_ID ,
      CT.BENHVIEN_ID AS MABENHVIEN ,
      TENBENHVIEN = @TENBENHVIEN ,
      CT.IDCHUYEN ,
      PB.TENPHONGBAN,
      NULL AS CHUYENTICHHOP_ID ,
      CT.SOBHYT,
      STATUSROW = CAST (0 AS BIT) ,
      MESSAGEROW = NULL
      FROM    dbo.TT_XACNHANCHIPHI CT
      JOIN dbo.TT_XACNHANCHIPHICHITIET CTCT ON CTCT.XACNHANCHIPHI_ID = CT.XACNHANCHIPHI_ID
      JOIN dbo.TT_TIEPNHAN TN ON TN.TIEPNHAN_ID = CT.TIEPNHAN_ID
      JOIN dbo.TT_BENHNHAN BN ON TN.BENHNHAN_ID = BN.BENHNHAN_ID
      JOIN dbo.TM_PHONGBAN PB ON PB.PHONGBAN_ID = CTCT.PHONGBAN_ID
      WHERE   CT.BENHVIEN_ID = '$BENHVIEN_ID$' AND CAST(CT.NGAYXACNHAN AS DATE) BETWEEN '$TUNGAY$' AND '$DENNGAY$'
      AND CT.IDCHUYEN IS NOT NULL
      <isNotEmpty prepend="AND" property="MAYTE">
			  BN.MAYTE LIKE '%$MAYTE$%'
		  </isNotEmpty>
		  <isNotEmpty prepend="AND" property="SOTN_BA">
			  TN.SOTIEPNHAN LIKE '%$SOTN_BA$%'
		  </isNotEmpty>
		  <isNotEmpty prepend="AND" property="TENBENHNHAN">
			  BN.TENBENHNHAN LIKE '%$TENBENHNHAN$%'
		  </isNotEmpty>

      UNION all

      SELECT  BTNCHECK = CAST (0 AS BIT) ,CT.XACNHANCHIPHI_ID ,
      CT.SOXACNHAN ,
      CT.NGAYXACNHAN ,
      CT.THOIGIANXACNHAN ,
      CT.TIEPNHAN_ID ,
      CT.BENHAN_ID ,
      CT.BENHNHAN_ID ,
      BN.MAYTE ,
      BN.TENBENHNHAN ,
      BN.DIACHI ,
      MASOTHUE = NULL ,
      SOTIEPNHAN = NULL ,
      SOBENHAN = ba.SOBENHAN ,
      SOTN_BA = ba.SOBENHAN ,
      TIENTE_ID = 'VND' ,
      TYGIA = 1 ,
      GIATRI = NULL ,
      GIATRIVAT = NULL ,
      GIATRICHIETKHAU = NULL ,
      CTCT.DONGIATHANHTOAN AS GIATRITHANHTOAN ,
      GHICHU = NULL,
      LOAI = N'Ngoại trú' ,
      CT.BENHVIEN_ID ,
      CT.BENHVIEN_ID AS MABENHVIEN ,
      TENBENHVIEN = @TENBENHVIEN ,
      CT.IDCHUYEN ,
      PB.TENPHONGBAN,
      NULL AS CHUYENTICHHOP_ID ,
      CT.SOBHYT,
      STATUSROW = CAST (0 AS BIT) ,
      MESSAGEROW = NULL
      FROM    dbo.TT_XACNHANCHIPHI CT
      JOIN dbo.TT_XACNHANCHIPHICHITIET CTCT ON CTCT.XACNHANCHIPHI_ID = CT.XACNHANCHIPHI_ID
      JOIN dbo.TT_NOITRU_BENHAN BA ON BA.BENHAN_ID = CT.BENHAN_ID
      JOIN dbo.TT_BENHNHAN BN ON BA.BENHNHAN_ID = BN.BENHNHAN_ID
      JOIN dbo.TM_PHONGBAN PB ON PB.PHONGBAN_ID = CTCT.PHONGBAN_ID
      WHERE   CT.BENHVIEN_ID = '$BENHVIEN_ID$' AND CAST(CT.NGAYXACNHAN AS DATE) BETWEEN '$TUNGAY$' AND '$DENNGAY$'
      AND CT.IDCHUYEN IS NOT NULL
      <isNotEmpty prepend="AND" property="MAYTE">
			  BN.MAYTE LIKE '%$MAYTE$%'
		  </isNotEmpty>
		  <isNotEmpty prepend="AND" property="SOTN_BA">
			  ba.SOBENHAN LIKE '%$SOTN_BA$%'
		  </isNotEmpty>
		  <isNotEmpty prepend="AND" property="TENBENHNHAN">
			  BN.TENBENHNHAN LIKE '%$TENBENHNHAN$%'
		  </isNotEmpty>
    </statement>
    <!--Lấy chi tiết BHYT-->
    <statement id="DAO09800_GetDetailBHYT" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      SELECT  TICHHOP_ID =NULL,
        CT.XACNHANCHIPHI_ID ,
        NULL AS MAKHOANMUCDT ,
        NULL AS TENKHOANMUCDT ,
        LOAIVATTU_ID = D.DUOC_ID,
        MALOAIDUOC ,
        TENLOAIDUOC ,
        MADUOC ,
        TENDUOC ,
        LDV.MALOAIDICHVU ,
        LDV.TENLOAIDICHVU ,
        NDV.MANHOMDICHVU ,
        NDV.TENNHOMDICHVU ,
        DV.MADICHVU ,
        DV.TENDICHVU ,
        DV.DONVITINH ,
        CTCT.SOLUONG ,
        DONGIADOANHTHU ,
        DONGIAHOTRO ,
        DONGIAHOTROCHITRA ,
        DONGIATHANHTOAN ,
        VP.BHYT_THANHTIEN_CHITRA AS GIATRI,
        NULL AS TYLEVAT ,
        NULL AS GIATRIVAT ,
        NULL AS GIATRICHIETKHAU ,
        VP.GIATRI_HOADON AS GIATRIHOADON ,
        LOAINOIDUNG = CASE WHEN VP.DICHVU_ID = NULL THEN 'DU' ELSE 'DV' END,
        NULL AS MANOITHUCHIEN ,
        NULL AS NOITHUCHIEN ,
        NULL AS MAKHOXUAT ,
        NULL AS TENKHOXUAT ,
        MAKHOAXUAT = PB.MAPHONGBAN ,
        TENKHOAXUAT = PB.TENPHONGBAN 
      FROM    dbo.TT_XACNHANCHIPHI CT
        JOIN dbo.TT_XACNHANCHIPHICHITIET CTCT ON CTCT.XACNHANCHIPHI_ID = CT.XACNHANCHIPHI_ID
		    JOIN dbo.TM_PHONGBAN PB ON PB.PHONGBAN_ID = CTCT.PHONGBAN_ID
		    JOIN dbo.TT_VIENPHI VP ON VP.VIENPHI_ID = CTCT.VIENPHI_ID
		    LEFT JOIN dbo.TM_DICHVU DV ON DV.DICHVU_ID = VP.DICHVU_ID
		    LEFT JOIN dbo.TM_NHOMDICHVU NDV ON NDV.NHOMDICHVU_ID = DV.NHOMDICHVU_ID
		    LEFT JOIN dbo.TM_LOAIDICHVU LDV ON LDV.LOAIDICHVU_ID = NDV.LOAIDICHVU_ID
		    LEFT JOIN dbo.TM_DUOC D ON D.DUOC_ID = VP.DUOC_ID
		    LEFT JOIN dbo.TM_LOAIDUOC LD ON LD.LOAIDUOC_ID = D.LOAIDUOC_ID
		    LEFT JOIN dbo.TM_TENDUOC TD ON TD.TENDUOC_ID = D.TENDUOC_ID
      WHERE CT.XACNHANCHIPHI_ID = '$XACNHANCHIPHI_ID$'
    </statement>
    <!--Cập nhật IDChuyen vào bảng BHYT-->
    <update id="DAO09800_UpdateBHYT_IDChuyen" parameterClass="System.Collections.IDictionary">
       UPDATE dbo.TT_XACNHANCHIPHI SET IDCHUYEN = #CHUYENTICHHOP_ID# WHERE XACNHANCHIPHI_ID = '$XACNHANCHIPHI_ID$'
    </update>
    <!--============================================END BHYT=============================================-->

    <!--============================================BEGIN HÓA ĐƠN VAT=============================================-->

    <!--============================================END HÓA ĐƠN VAT=============================================-->


  </statements>
</sqlMap>