<?xml version="1.0" encoding="utf-8" ?>
<!--============================================================================
//	CAUTION: This file is generated by IBatisNetGen.3.SQLMap.cst at 11/11/2015 9:27:48 AM
//				Any manual editing will be lost in re-generation.
//===========================================================================-->
<sqlMap namespace="eHospital" xmlns="http://ibatis.apache.org/mapping" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" >

  <statements>
    <statement id="DAO00119_TM_CONGTYCHITRA_GetList" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select * from TM_CONGTYCHITRA
      where BENHVIEN_ID = '$BENHVIEN_ID$'
      and TAMNGUNG = '$TAMNGUNG$'
    </statement>
    <statement id="DAO00119_TT_VIENPHI_GetList_BenhNhanThanhVienGoiPhaiThanhToan" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select VP.*
      from TT_VIENPHI VP
      where Vp.BENHNHAN_ID = '$BENHNHAN_ID$' and Vp.ACTIVE = '1' and
      REF_TABLE in ('TT_CSKH_GOI_DANGKY', 'TT_CSKH_THANHVIEN_CAPTHE') and
      ((vp.DATHANHTOAN = '0') or (vp.BENHNHAN_PHAITHANHTOAN > vp.GIATRI_BENHNHAN_DATHANHTOAN and vp.DATHANHTOAN = '1'))
    </statement>
    <statement id="DAO00119_TT_VIENPHI_GetList_TiepNhanPhaiThanhToan" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select  a.*, b.GIATRIMIENGIAM_BH, c.GIATRIMIENGIAM_BHTN, f.GIATRIMIENGIAM_THANHVIEN, g.GIATRIMIENGIAM_CTCT
      from
      (select VP.*, c.NOITHUCHIEN_ID, c.NOIYEUCAU_ID, c.THUTIENSAU
      from TT_VIENPHI VP
      left join TT_DVYEUCAU c on c.DVYEUCAU_ID = VP.REF_ID  and vp.REF_TABLE = 'TT_DVYEUCAU'
      where Vp.TIEPNHAN_ID = '$TIEPNHAN_ID$' and Vp.ACTIVE = '1' and ((c.HUYYEUCAU != '1' and vp.DICHVU_ID is not null) or (vp.DUOC_ID is not null)) and
      ((vp.DATHANHTOAN = '0') or (vp.BENHNHAN_PHAITHANHTOAN > vp.GIATRI_BENHNHAN_DATHANHTOAN and vp.DATHANHTOAN = '1')) and c.DANGKY_ID is null
      and VP.KHONGTHUTIEN != '1'
      ) a

      left join (select VIENPHI_ID,
      sum(MGCT.GIATRIMIENGIAM) AS GIATRIMIENGIAM_BH from TT_MIENGIAM MG
      INNER JOIN TT_MIENGIAM_CHITIET MGCT ON MG.MIENGIAM_ID = MGCT.MIENGIAM_ID
      where MG.TIEPNHAN_ID= '$TIEPNHAN_ID$' and MGCT.REF_TABLE = 'TT_MIENGIAM' and MG.TINHTRANG = 1 group by VIENPHI_ID
      ) b on a.VIENPHI_ID = b.VIENPHI_ID

      left join (select VIENPHI_ID, sum(MGCT.GIATRIMIENGIAM) AS GIATRIMIENGIAM_BHTN
      from TT_MIENGIAM_BHTN MG
      INNER JOIN TT_MIENGIAM_CHITIET MGCT ON MG.MIENGIAM_BHTN_ID = MGCT.MIENGIAM_ID
      where  MG.TIEPNHAN_ID= '$TIEPNHAN_ID$' and MGCT.REF_TABLE = 'TT_MIENGIAM_BHTN' and MG.TINHTRANG = 1 group by VIENPHI_ID
      )c on a.VIENPHI_ID = c.VIENPHI_ID

      left join (select VIENPHI_ID, sum(MGCT.GIATRIMIENGIAM) AS GIATRIMIENGIAM_THANHVIEN
      from TT_MIENGIAM_THANHVIEN MG
      INNER JOIN TT_MIENGIAM_CHITIET MGCT ON MG.MIENGIAM_THANHVIEN_ID = MGCT.MIENGIAM_ID
      where MG.TIEPNHAN_ID= '$TIEPNHAN_ID$' and MGCT.REF_TABLE = 'TT_MIENGIAM_THANHVIEN' and MG.TINHTRANG = 1 group by VIENPHI_ID
      )f on a.VIENPHI_ID = f.VIENPHI_ID

      left join(select VIENPHI_ID, sum(MGCT.GIATRIMIENGIAM) AS GIATRIMIENGIAM_CTCT
      from TT_MIENGIAM_CONGTY MG
      INNER JOIN TT_MIENGIAM_CHITIET MGCT ON MG.MIENGIAM_CONGTY_ID = MGCT.MIENGIAM_ID
      where MG.TIEPNHAN_ID= '$TIEPNHAN_ID$' and MGCT.REF_TABLE = 'TT_MIENGIAM_CONGTY' and MG.TINHTRANG = 1 group by VIENPHI_ID
      )g on a.VIENPHI_ID = g.VIENPHI_ID
     
    </statement>
    <statement id="DAO00119_TT_VIENPHI_GetList_TiepNhanPhaiThanhToanWithVienphiId" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select  a.*, b.GIATRIMIENGIAM_BH, c.GIATRIMIENGIAM_BHTN, f.GIATRIMIENGIAM_THANHVIEN, g.GIATRIMIENGIAM_CTCT
      from
      (select VP.*, c.NOITHUCHIEN_ID, c.NOIYEUCAU_ID
      from TT_VIENPHI VP
      left join TT_DVYEUCAU c on c.DVYEUCAU_ID = VP.REF_ID  and vp.REF_TABLE = 'TT_DVYEUCAU'
      where Vp.TIEPNHAN_ID = '$TIEPNHAN_ID$' and Vp.ACTIVE = '1' and ((c.HUYYEUCAU != '1' and vp.DICHVU_ID is not null) or (vp.DUOC_ID is not null)) and
      ((vp.DATHANHTOAN = '0') or (vp.BENHNHAN_PHAITHANHTOAN > vp.GIATRI_BENHNHAN_DATHANHTOAN and vp.DATHANHTOAN = '1')) and c.DANGKY_ID is null
      and vp.VIENPHI_ID in ($LIST_VIENPHI$)) a

      left join (select VIENPHI_ID,
      sum(MGCT.GIATRIMIENGIAM) AS GIATRIMIENGIAM_BH from TT_MIENGIAM MG
      INNER JOIN TT_MIENGIAM_CHITIET MGCT ON MG.MIENGIAM_ID = MGCT.MIENGIAM_ID
      where MG.TIEPNHAN_ID= '$TIEPNHAN_ID$' and MGCT.REF_TABLE = 'TT_MIENGIAM' and MG.TINHTRANG = 1 group by VIENPHI_ID
      ) b on a.VIENPHI_ID = b.VIENPHI_ID

      left join (select VIENPHI_ID, sum(MGCT.GIATRIMIENGIAM) AS GIATRIMIENGIAM_BHTN
      from TT_MIENGIAM_BHTN MG
      INNER JOIN TT_MIENGIAM_CHITIET MGCT ON MG.MIENGIAM_BHTN_ID = MGCT.MIENGIAM_ID
      where  MG.TIEPNHAN_ID= '$TIEPNHAN_ID$' and MGCT.REF_TABLE = 'TT_MIENGIAM_BHTN' and MG.TINHTRANG = 1 group by VIENPHI_ID
      )c on a.VIENPHI_ID = c.VIENPHI_ID

      left join (select VIENPHI_ID, sum(MGCT.GIATRIMIENGIAM) AS GIATRIMIENGIAM_THANHVIEN
      from TT_MIENGIAM_THANHVIEN MG
      INNER JOIN TT_MIENGIAM_CHITIET MGCT ON MG.MIENGIAM_THANHVIEN_ID = MGCT.MIENGIAM_ID
      where MG.TIEPNHAN_ID= '$TIEPNHAN_ID$' and MGCT.REF_TABLE = 'TT_MIENGIAM_THANHVIEN' and MG.TINHTRANG = 1 group by VIENPHI_ID
      )f on a.VIENPHI_ID = f.VIENPHI_ID

      left join(select VIENPHI_ID, sum(MGCT.GIATRIMIENGIAM) AS GIATRIMIENGIAM_CTCT
      from TT_MIENGIAM_CONGTY MG
      INNER JOIN TT_MIENGIAM_CHITIET MGCT ON MG.MIENGIAM_CONGTY_ID = MGCT.MIENGIAM_ID
      where MG.TIEPNHAN_ID= '$TIEPNHAN_ID$' and MGCT.REF_TABLE = 'TT_MIENGIAM_CONGTY' and MG.TINHTRANG = 1 group by VIENPHI_ID
      )g on a.VIENPHI_ID = g.VIENPHI_ID
    </statement>
    <!--<statement id="DAO00119_TT_VIENPHI_GetList_BenhAnPhaiThanhToan" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select  a.*, b.GIATRIMIENGIAM_BH, c.GIATRIMIENGIAM_BHTN, f.GIATRIMIENGIAM_THANHVIEN, g.GIATRIMIENGIAM_CTCT
      from
      (select VP.*, c.NOITHUCHIEN_ID, c.NOIYEUCAU_ID
      from TT_VIENPHI VP
      left join TT_DVYEUCAU c on c.DVYEUCAU_ID = VP.REF_ID  and vp.REF_TABLE = 'TT_DVYEUCAU'
      where Vp.BENHAN_ID = '$BENHAN_ID$' and Vp.ACTIVE = '1' and ((c.HUYYEUCAU != '1' and vp.DICHVU_ID is not null) or 
      (vp.DUOC_ID is not null) or (REF_TABLE = 'TT_NUT_XACNHANSUATAN_CHITIET')) and
      ((vp.DATHANHTOAN = '0') or (vp.BENHNHAN_PHAITHANHTOAN > vp.GIATRI_BENHNHAN_DATHANHTOAN and vp.DATHANHTOAN = '1')) and c.DANGKY_ID is null
      ) a

      left join (select VIENPHI_ID,
      sum(MGCT.GIATRIMIENGIAM) AS GIATRIMIENGIAM_BH from TT_MIENGIAM MG
      INNER JOIN TT_MIENGIAM_CHITIET MGCT ON MG.MIENGIAM_ID = MGCT.MIENGIAM_ID
      where MG.BENHAN_ID = '$BENHAN_ID$' and MGCT.REF_TABLE = 'TT_MIENGIAM' and MG.TINHTRANG = 1 group by VIENPHI_ID
      ) b on a.VIENPHI_ID = b.VIENPHI_ID

      left join (select VIENPHI_ID, sum(MGCT.GIATRIMIENGIAM) AS GIATRIMIENGIAM_BHTN
      from TT_MIENGIAM_BHTN MG
      INNER JOIN TT_MIENGIAM_CHITIET MGCT ON MG.MIENGIAM_BHTN_ID = MGCT.MIENGIAM_ID
      where  MG.BENHAN_ID = '$BENHAN_ID$' and MGCT.REF_TABLE = 'TT_MIENGIAM_BHTN' and MG.TINHTRANG = 1 group by VIENPHI_ID
      )c on a.VIENPHI_ID = c.VIENPHI_ID

      left join (select VIENPHI_ID, sum(MGCT.GIATRIMIENGIAM) AS GIATRIMIENGIAM_THANHVIEN
      from TT_MIENGIAM_THANHVIEN MG
      INNER JOIN TT_MIENGIAM_CHITIET MGCT ON MG.MIENGIAM_THANHVIEN_ID = MGCT.MIENGIAM_ID
      where MG.TIEPNHAN_ID = '$TIEPNHAN_ID$' and MGCT.REF_TABLE = 'TT_MIENGIAM_THANHVIEN' and MG.TINHTRANG = 1 group by VIENPHI_ID
      )f on a.VIENPHI_ID = f.VIENPHI_ID

      left join(select VIENPHI_ID, sum(MGCT.GIATRIMIENGIAM) AS GIATRIMIENGIAM_CTCT
      from TT_MIENGIAM_CONGTY MG
      INNER JOIN TT_MIENGIAM_CHITIET MGCT ON MG.MIENGIAM_CONGTY_ID = MGCT.MIENGIAM_ID
      where MG.BENHAN_ID = '$BENHAN_ID$' and MGCT.REF_TABLE = 'TT_MIENGIAM_CONGTY' and MG.TINHTRANG = 1 group by VIENPHI_ID
      )g on a.VIENPHI_ID = g.VIENPHI_ID      
    </statement>-->
    <statement id="DAO00119_TT_DVYEUCAU_GetList_BenhAn" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select
      B.MADICHVU, B.TENDICHVU NOIDUNG, A.NGAYGIOYEUCAU, A.SODICHVUYEUCAU SOLUONG,
      E.TENPHONGBAN NOIYEUCAU, F.TENPHONGBAN NOITHUCHIEN, B.DONVITINH,
      <!--Format(A.NGAYGIOYEUCAU, 'dd/MM/yyyy, hh:mm:ss') as THOIGIAN,-->
      CASE
      WHEN A.TRANGTHAI =  'HOANTAT' THEN N'Hoàn thành'
      WHEN A.TRANGTHAI =  'DALAYMAU' THEN N'Đã lấy mẫu'
      WHEN A.TRANGTHAI =  'CHOXACNHAN' THEN N'Chờ xác nhận'
      WHEN A.TRANGTHAI =  'DANGTHUCHIEN' THEN N'Đang thực hiện'
      WHEN A.TRANGTHAI =  'DACHUYENTUYEN' THEN N'Đã chuyển tuyến'
      ELSE N'Chưa kết quả'
      END TRANGTHAI
      from TT_DVYEUCAU A
      left join TM_DICHVU B on B.DICHVU_ID = A.DICHVU_ID
      left join TM_NHOMDICHVU C on B.NHOMDICHVU_ID = C.NHOMDICHVU_ID
      left join TM_PHONGBAN E on E.PHONGBAN_ID = A.NOIYEUCAU_ID
      left join TM_PHONGBAN F on F.PHONGBAN_ID = A.NOITHUCHIEN_ID
      where
      A.BENHAN_ID = '$BENHAN_ID$' and A.HUYYEUCAU != '1'
    </statement>
    <statement id="DAO00119_TT_NOITRU_TOATHUOC_GetList_BenhAn" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select duoc.MADUOC MADICHVU, duoc.TENDUOCDAYDU NOIDUNG, B.SOLUONG, duoc.DONVITINH,
      A.THOIGIANKHAM NGAYGIOYEUCAU, Format(A.THOIGIANKHAM, 'dd/MM/yyyy, hh:mm:ss') as THOIGIAN,
      CASE
      WHEN (B.PHIEULINH_ID is not null and B.CHUNGTU_ID is null) THEN N'Đã lập phiếu lĩnh'
      WHEN B.CHUNGTU_ID is not null  THEN N'Đã xuất thuốc'
      ELSE N'Chưa lập phiếu lĩnh'
      END TRANGTHAI,
      tt.SOLUONG SOLUONG_NGUNG,
      E.TENPHONGBAN NOIYEUCAU
      from TT_NOITRU_KHAMBENH A
      left join TT_NOITRU_TOATHUOC B on A.KHAMBENH_ID = B.KHAMBENH_ID
      left join TT_NOITRU_TRATHUOC_CHITIET tt on B.TOATHUOC_ID = tt.TOATHUOC_ID and B.DUOC_ID = tt.DUOC_ID
      left join TM_DUOC duoc on duoc.DUOC_ID = B.DUOC_ID
      left join TM_PHONGBAN E on E.PHONGBAN_ID = A.PHONGBAN_ID
      where
      A.BENHAN_ID = '$BENHAN_ID$'
    </statement>
    <statement id="DAO00119_TT_VTYT_GetList_BenhAn" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select duoc.MADUOC MADICHVU, duoc.TENDUOCDAYDU NOIDUNG, B.SOLUONG, duoc.DONVITINH,
      B.THOIGIANSUDUNG NGAYGIOYEUCAU, Format(B.THOIGIANSUDUNG, 'dd/MM/yyyy, hh:mm:ss') as THOIGIAN,
      CASE
      WHEN B.CHUNGTU_ID is not null  THEN N'Đã xuất thuốc'
      ELSE N'Chưa xuất thuốc'
      END TRANGTHAI,
      E.TENPHONGBAN NOIYEUCAU
      from TT_CLSKETQUA A
      left join TT_CLSKETQUA_VTYT B on A.CLSKETQUA_ID = B.CLSKETQUA_ID
      left join TM_DUOC duoc on duoc.DUOC_ID = B.DUOC_ID
      left join TM_PHONGBAN E on E.PHONGBAN_ID = B.PHONGBAN_ID
      where A.BENHAN_ID = '$BENHAN_ID$' and B.CLSKETQUA_VTYT_ID is not null
      union
      select duoc.MADUOC MADICHVU, duoc.TENDUOCDAYDU NOIDUNG, B.SOLUONG, duoc.DONVITINH,
      B.NGAYSUDUNG NGAYGIOYEUCAU, Format(B.NGAYSUDUNG, 'dd/MM/yyyy, hh:mm:ss') as THOIGIAN,
      CASE
      WHEN B.CHUNGTU_ID is not null  THEN N'Đã xuất thuốc'
      ELSE N'Chưa xuất thuốc'
      END TRANGTHAI,
      E.TENPHONGBAN NOIYEUCAU
      from TT_PHAUTHUAT A
      left join TT_PHAUTHUAT_VTYT B on A.PHAUTHUAT_ID = B.PHAUTHUAT_ID
      left join TM_DUOC duoc on duoc.DUOC_ID = B.DUOC_ID
      left join TM_PHONGBAN E on E.PHONGBAN_ID = A.PHONGBANTHUCHIEN_ID
      where A.BENHAN_ID = '$BENHAN_ID$' and B.PHAUTHUAT_VTYT_ID is not null
    </statement>
    <statement id="DAO00119_TT_Xuatan_GetList_BenhAn" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select C.XACNHANSUATANCHITIET_ID, A.BENHAN_ID, A.CHIDINHKHAUPHAN_ID, A.CHIDINHKHAUPHANCHITIET_ID, A.NGAYCHIDINH,
      B.TONGHOPSUATANCHITIET_ID,
      kp.MAKHAUPHANAN MADICHVU, kp.TENKHAUPHANAN NOIDUNG,
      A.NGAYCHIDINH NGAYGIOYEUCAU, Format(A.NGAYCHIDINH, 'dd/MM/yyyy, hh:mm:ss') as THOIGIAN,
      CASE
      WHEN A.CHIDINHKHAUPHANCHITIET_ID is not null and B.TONGHOPSUATANCHITIET_ID is not null and C.XACNHANSUATANCHITIET_ID is not null  THEN N'Đã xác nhận'
      WHEN A.CHIDINHKHAUPHANCHITIET_ID is not null and B.TONGHOPSUATANCHITIET_ID is not null and C.XACNHANSUATANCHITIET_ID is null  THEN N'Đã tổng hợp'
      ELSE N'Đã chỉ định'
      END TRANGTHAI,
      E.TENPHONGBAN NOIYEUCAU
      from TT_NUT_CHIDINHKHAUPHAN_CHITIET A
      left join TT_NUT_TONGHOPSUATAN_CHITIET B on A.CHIDINHKHAUPHANCHITIET_ID = B.CHIDINHKHAUPHANCHITIET_ID
      left join TT_NUT_XACNHANSUATAN_CHITIET C on C.TONGHOPSUATANCHITIET_ID = B.TONGHOPSUATANCHITIET_ID
      left join TM_NUT_KHAUPHANAN kp on kp.KHAUPHANAN_ID = A.KHAUPHANAN_ID
      left join TT_NOITRU_BENHAN D on D.BENHAN_ID = A.BENHAN_ID
      left join TM_PHONGBAN E on E.PHONGBAN_ID = D.KHOACHUYENDEN_ID
      where A.XOA != '1' and (C.HUY != '1') and A.BENHAN_ID = '$BENHAN_ID$'
    </statement>
    <statement id="DAO00119_TT_VIENPHI_GetList_BenhAnPhaiThanhToan" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      <!--dich vu yeu cau-->
      select  a.*, b.GIATRIMIENGIAM_BH, c.GIATRIMIENGIAM_BHTN, f.GIATRIMIENGIAM_THANHVIEN, g.GIATRIMIENGIAM_CTCT
      from
      (select VP.*, c.NOITHUCHIEN_ID, c.NOIYEUCAU_ID
      from TT_VIENPHI VP
      left join TT_DVYEUCAU c on c.DVYEUCAU_ID = VP.REF_ID  and vp.REF_TABLE = 'TT_DVYEUCAU'
      where Vp.BENHAN_ID = '$BENHAN_ID$' and Vp.ACTIVE = '1' and vp.KHONGTHUTIEN = '0' and ((c.HUYYEUCAU != '1' and vp.DICHVU_ID is not null) and
      (vp.DUOC_ID is null)) and
      ((vp.DATHANHTOAN = '0') or (vp.BENHNHAN_PHAITHANHTOAN > vp.GIATRI_BENHNHAN_DATHANHTOAN and vp.DATHANHTOAN = '1')) and c.DANGKY_ID is null
      ) a

      left join (select VIENPHI_ID,
      sum(MGCT.GIATRIMIENGIAM) AS GIATRIMIENGIAM_BH from TT_MIENGIAM MG
      INNER JOIN TT_MIENGIAM_CHITIET MGCT ON MG.MIENGIAM_ID = MGCT.MIENGIAM_ID
      where MG.BENHAN_ID = '$BENHAN_ID$' and MGCT.REF_TABLE = 'TT_MIENGIAM' and MG.TINHTRANG = 1 group by VIENPHI_ID
      ) b on a.VIENPHI_ID = b.VIENPHI_ID

      left join (select VIENPHI_ID, sum(MGCT.GIATRIMIENGIAM) AS GIATRIMIENGIAM_BHTN
      from TT_MIENGIAM_BHTN MG
      INNER JOIN TT_MIENGIAM_CHITIET MGCT ON MG.MIENGIAM_BHTN_ID = MGCT.MIENGIAM_ID
      where  MG.BENHAN_ID = '$BENHAN_ID$' and MGCT.REF_TABLE = 'TT_MIENGIAM_BHTN' and MG.TINHTRANG = 1 group by VIENPHI_ID
      )c on a.VIENPHI_ID = c.VIENPHI_ID

      left join (select VIENPHI_ID, sum(MGCT.GIATRIMIENGIAM) AS GIATRIMIENGIAM_THANHVIEN
      from TT_MIENGIAM_THANHVIEN MG
      INNER JOIN TT_MIENGIAM_CHITIET MGCT ON MG.MIENGIAM_THANHVIEN_ID = MGCT.MIENGIAM_ID
      where MG.TIEPNHAN_ID = '$TIEPNHAN_ID$' and MGCT.REF_TABLE = 'TT_MIENGIAM_THANHVIEN' and MG.TINHTRANG = 1 group by VIENPHI_ID
      )f on a.VIENPHI_ID = f.VIENPHI_ID

      left join(select VIENPHI_ID, sum(MGCT.GIATRIMIENGIAM) AS GIATRIMIENGIAM_CTCT
      from TT_MIENGIAM_CONGTY MG
      INNER JOIN TT_MIENGIAM_CHITIET MGCT ON MG.MIENGIAM_CONGTY_ID = MGCT.MIENGIAM_ID
      where MG.BENHAN_ID = '$BENHAN_ID$' and MGCT.REF_TABLE = 'TT_MIENGIAM_CONGTY' and MG.TINHTRANG = 1 group by VIENPHI_ID
      )g on a.VIENPHI_ID = g.VIENPHI_ID

      union
      <!--thuoc-->
      select  a.*, b.GIATRIMIENGIAM_BH, c.GIATRIMIENGIAM_BHTN, f.GIATRIMIENGIAM_THANHVIEN, g.GIATRIMIENGIAM_CTCT
      from
      (select VP.*, nttt.PHONGBANRATOA_ID NOITHUCHIEN_ID, nttt.PHONGBANRATOA_ID NOIYEUCAU_ID
      from TT_VIENPHI VP
      left join TT_NOITRU_TOATHUOC nttt on nttt.TOATHUOC_ID = vp.REF_ID and vp.REF_TABLE = 'TT_NOITRU_TOATHUOC'
      where Vp.BENHAN_ID = '$BENHAN_ID$' and Vp.ACTIVE = '1' and vp.DICHVU_ID is null and
      vp.DUOC_ID is not null and REF_TABLE = 'TT_NOITRU_TOATHUOC' and
      ((vp.DATHANHTOAN = '0') or (vp.BENHNHAN_PHAITHANHTOAN > vp.GIATRI_BENHNHAN_DATHANHTOAN and vp.DATHANHTOAN = '1')) 
      and (VP.KHONGTHUTIEN = '0' or VP.KHONGTHUTIEN is null)  and vp.REF_ID > 0 and vp.SOLUONG > 0) a
      <!--inner join TT_NOITRU_TOATHUOC nttt ON nttt.TOATHUOC_ID = a.REF_ID and nttt.DUOC_ID = a.DUOC_ID-->

      left join (select VIENPHI_ID,
      sum(MGCT.GIATRIMIENGIAM) AS GIATRIMIENGIAM_BH from TT_MIENGIAM MG
      INNER JOIN TT_MIENGIAM_CHITIET MGCT ON MG.MIENGIAM_ID = MGCT.MIENGIAM_ID
      where MG.BENHAN_ID = '$BENHAN_ID$' and MGCT.REF_TABLE = 'TT_MIENGIAM' and MG.TINHTRANG = 1 group by VIENPHI_ID
      ) b on a.VIENPHI_ID = b.VIENPHI_ID

      left join (select VIENPHI_ID, sum(MGCT.GIATRIMIENGIAM) AS GIATRIMIENGIAM_BHTN
      from TT_MIENGIAM_BHTN MG
      INNER JOIN TT_MIENGIAM_CHITIET MGCT ON MG.MIENGIAM_BHTN_ID = MGCT.MIENGIAM_ID
      where  MG.BENHAN_ID = '$BENHAN_ID$' and MGCT.REF_TABLE = 'TT_MIENGIAM_BHTN' and MG.TINHTRANG = 1 group by VIENPHI_ID
      )c on a.VIENPHI_ID = c.VIENPHI_ID

      left join (select VIENPHI_ID, sum(MGCT.GIATRIMIENGIAM) AS GIATRIMIENGIAM_THANHVIEN
      from TT_MIENGIAM_THANHVIEN MG
      INNER JOIN TT_MIENGIAM_CHITIET MGCT ON MG.MIENGIAM_THANHVIEN_ID = MGCT.MIENGIAM_ID
      where MG.TIEPNHAN_ID = '$TIEPNHAN_ID$' and MGCT.REF_TABLE = 'TT_MIENGIAM_THANHVIEN' and MG.TINHTRANG = 1 group by VIENPHI_ID
      )f on a.VIENPHI_ID = f.VIENPHI_ID

      left join(select VIENPHI_ID, sum(MGCT.GIATRIMIENGIAM) AS GIATRIMIENGIAM_CTCT
      from TT_MIENGIAM_CONGTY MG
      INNER JOIN TT_MIENGIAM_CHITIET MGCT ON MG.MIENGIAM_CONGTY_ID = MGCT.MIENGIAM_ID
      where MG.BENHAN_ID = '$BENHAN_ID$' and MGCT.REF_TABLE = 'TT_MIENGIAM_CONGTY' and MG.TINHTRANG = 1 group by VIENPHI_ID
      )g on a.VIENPHI_ID = g.VIENPHI_ID

      union
      <!--Xuất ăn-->
      select  a.*, b.GIATRIMIENGIAM_BH, c.GIATRIMIENGIAM_BHTN, f.GIATRIMIENGIAM_THANHVIEN, g.GIATRIMIENGIAM_CTCT
      from
      (select VP.*, c.KHOACHUYENDEN_ID NOITHUCHIEN_ID, c.KHOACHUYENDEN_ID NOIYEUCAU_ID
      from TT_VIENPHI VP
      left join TT_NOITRU_BENHAN c on c.BENHAN_ID = VP.BENHAN_ID
      where Vp.BENHAN_ID = '$BENHAN_ID$' and Vp.ACTIVE = '1' and vp.DUOC_ID is null and REF_TABLE = 'TT_NUT_XACNHANSUATAN_CHITIET' and
      ((vp.DATHANHTOAN = '0') or (vp.BENHNHAN_PHAITHANHTOAN > vp.GIATRI_BENHNHAN_DATHANHTOAN and vp.DATHANHTOAN = '1'))
      and VP.KHONGTHUTIEN != '1') a

      left join (select VIENPHI_ID,
      sum(MGCT.GIATRIMIENGIAM) AS GIATRIMIENGIAM_BH from TT_MIENGIAM MG
      INNER JOIN TT_MIENGIAM_CHITIET MGCT ON MG.MIENGIAM_ID = MGCT.MIENGIAM_ID
      where MG.BENHAN_ID = '$BENHAN_ID$' and MGCT.REF_TABLE = 'TT_MIENGIAM' and MG.TINHTRANG = 1 group by VIENPHI_ID
      ) b on a.VIENPHI_ID = b.VIENPHI_ID

      left join (select VIENPHI_ID, sum(MGCT.GIATRIMIENGIAM) AS GIATRIMIENGIAM_BHTN
      from TT_MIENGIAM_BHTN MG
      INNER JOIN TT_MIENGIAM_CHITIET MGCT ON MG.MIENGIAM_BHTN_ID = MGCT.MIENGIAM_ID
      where  MG.BENHAN_ID = '$BENHAN_ID$' and MGCT.REF_TABLE = 'TT_MIENGIAM_BHTN' and MG.TINHTRANG = 1 group by VIENPHI_ID
      )c on a.VIENPHI_ID = c.VIENPHI_ID

      left join (select VIENPHI_ID, sum(MGCT.GIATRIMIENGIAM) AS GIATRIMIENGIAM_THANHVIEN
      from TT_MIENGIAM_THANHVIEN MG
      INNER JOIN TT_MIENGIAM_CHITIET MGCT ON MG.MIENGIAM_THANHVIEN_ID = MGCT.MIENGIAM_ID
      where MG.TIEPNHAN_ID = '$TIEPNHAN_ID$' and MGCT.REF_TABLE = 'TT_MIENGIAM_THANHVIEN' and MG.TINHTRANG = 1 group by VIENPHI_ID
      )f on a.VIENPHI_ID = f.VIENPHI_ID

      left join(select VIENPHI_ID, sum(MGCT.GIATRIMIENGIAM) AS GIATRIMIENGIAM_CTCT
      from TT_MIENGIAM_CONGTY MG
      INNER JOIN TT_MIENGIAM_CHITIET MGCT ON MG.MIENGIAM_CONGTY_ID = MGCT.MIENGIAM_ID
      where MG.BENHAN_ID = '$BENHAN_ID$' and MGCT.REF_TABLE = 'TT_MIENGIAM_CONGTY' and MG.TINHTRANG = 1 group by VIENPHI_ID
      )g on a.VIENPHI_ID = g.VIENPHI_ID

      union
      <!--thuoc, vtyt khac-->
      select  a.*, b.GIATRIMIENGIAM_BH, c.GIATRIMIENGIAM_BHTN, f.GIATRIMIENGIAM_THANHVIEN, g.GIATRIMIENGIAM_CTCT
      from
      (select VP.*, 0 NOITHUCHIEN_ID, 0 NOIYEUCAU_ID
      from TT_VIENPHI VP
      left join TT_PHAUTHUAT_VTYT D on VP.REF_ID = D.PHAUTHUAT_VTYT_ID and VP.REF_TABLE = 'TT_PHAUTHUAT_VTYT'
      left join TT_CLSKETQUA_VTYT E on VP.REF_ID = E.CLSKETQUA_VTYT_ID and VP.REF_TABLE = 'TT_CLSKETQUA_VTYT'
      left join TT_NGOAITRU_KHAMBENH_VTYT KB on VP.REF_ID = KB.KHAMBENH_VTYT_ID and VP.REF_TABLE = 'TT_NGOAITRU_KHAMBENH_VTYT'
      where Vp.BENHAN_ID = '$BENHAN_ID$' and Vp.ACTIVE = '1' and vp.DICHVU_ID is null and
      REF_TABLE not in ('TT_NOITRU_TOATHUOC', 'TT_NUT_XACNHANSUATAN_CHITIET', 'TT_DVYEUCAU') and
      ((vp.DUOC_ID is not null and D.PHAUTHUAT_VTYT_ID is not null and vp.REF_TABLE = 'TT_PHAUTHUAT_VTYT') or
      (vp.DUOC_ID is not null and E.CLSKETQUA_VTYT_ID is not null and vp.REF_TABLE = 'TT_CLSKETQUA_VTYT') or
      (vp.DUOC_ID is not null and KB.KHAMBENH_VTYT_ID is not null and vp.REF_TABLE = 'TT_NGOAITRU_KHAMBENH_VTYT')) and
      ((vp.DATHANHTOAN = '0') or (vp.BENHNHAN_PHAITHANHTOAN > vp.GIATRI_BENHNHAN_DATHANHTOAN and vp.DATHANHTOAN = '1'))
      and (VP.KHONGTHUTIEN = '0' or VP.KHONGTHUTIEN is null)) a

      left join (select VIENPHI_ID,
      sum(MGCT.GIATRIMIENGIAM) AS GIATRIMIENGIAM_BH from TT_MIENGIAM MG
      INNER JOIN TT_MIENGIAM_CHITIET MGCT ON MG.MIENGIAM_ID = MGCT.MIENGIAM_ID
      where MG.BENHAN_ID = '$BENHAN_ID$' and MGCT.REF_TABLE = 'TT_MIENGIAM' and MG.TINHTRANG = 1 group by VIENPHI_ID
      ) b on a.VIENPHI_ID = b.VIENPHI_ID

      left join (select VIENPHI_ID, sum(MGCT.GIATRIMIENGIAM) AS GIATRIMIENGIAM_BHTN
      from TT_MIENGIAM_BHTN MG
      INNER JOIN TT_MIENGIAM_CHITIET MGCT ON MG.MIENGIAM_BHTN_ID = MGCT.MIENGIAM_ID
      where  MG.BENHAN_ID = '$BENHAN_ID$' and MGCT.REF_TABLE = 'TT_MIENGIAM_BHTN' and MG.TINHTRANG = 1 group by VIENPHI_ID
      )c on a.VIENPHI_ID = c.VIENPHI_ID

      left join (select VIENPHI_ID, sum(MGCT.GIATRIMIENGIAM) AS GIATRIMIENGIAM_THANHVIEN
      from TT_MIENGIAM_THANHVIEN MG
      INNER JOIN TT_MIENGIAM_CHITIET MGCT ON MG.MIENGIAM_THANHVIEN_ID = MGCT.MIENGIAM_ID
      where MG.TIEPNHAN_ID = '$TIEPNHAN_ID$' and MGCT.REF_TABLE = 'TT_MIENGIAM_THANHVIEN' and MG.TINHTRANG = 1 group by VIENPHI_ID
      )f on a.VIENPHI_ID = f.VIENPHI_ID

      left join(select VIENPHI_ID, sum(MGCT.GIATRIMIENGIAM) AS GIATRIMIENGIAM_CTCT
      from TT_MIENGIAM_CONGTY MG
      INNER JOIN TT_MIENGIAM_CHITIET MGCT ON MG.MIENGIAM_CONGTY_ID = MGCT.MIENGIAM_ID
      where MG.BENHAN_ID = '$BENHAN_ID$' and MGCT.REF_TABLE = 'TT_MIENGIAM_CONGTY' and MG.TINHTRANG = 1 group by VIENPHI_ID
      )g on a.VIENPHI_ID = g.VIENPHI_ID

      where KHONGTHUTIEN = '0' and REF_ID != 0
    </statement>
    <statement id="DAO00119_TT_VIENPHI_GetList_BenhAnPhaiThanhToanWithVienPhiId" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select  a.*, b.GIATRIMIENGIAM_BH, c.GIATRIMIENGIAM_BHTN, f.GIATRIMIENGIAM_THANHVIEN, g.GIATRIMIENGIAM_CTCT
      from
      (select VP.*, c.NOITHUCHIEN_ID, c.NOIYEUCAU_ID
      from TT_VIENPHI VP
      left join TT_DVYEUCAU c on c.DVYEUCAU_ID = VP.REF_ID  and vp.REF_TABLE = 'TT_DVYEUCAU'
      where Vp.BENHAN_ID = '$BENHAN_ID$' and Vp.ACTIVE = '1' and ((c.HUYYEUCAU != '1' and vp.DICHVU_ID is not null) or (vp.DUOC_ID is not null)  or (REF_TABLE = 'TT_NUT_XACNHANSUATAN_CHITIET')) and
      ((vp.DATHANHTOAN = '0') or (vp.BENHNHAN_PHAITHANHTOAN > vp.GIATRI_BENHNHAN_DATHANHTOAN and vp.DATHANHTOAN = '1')) and c.DANGKY_ID is null
      and vp.VIENPHI_ID in ($LIST_VIENPHI$)) a

      left join (select VIENPHI_ID,
      sum(MGCT.GIATRIMIENGIAM) AS GIATRIMIENGIAM_BH from TT_MIENGIAM MG
      INNER JOIN TT_MIENGIAM_CHITIET MGCT ON MG.MIENGIAM_ID = MGCT.MIENGIAM_ID
      where MG.BENHAN_ID = '$BENHAN_ID$' and MGCT.REF_TABLE = 'TT_MIENGIAM' and MG.TINHTRANG = 1 group by VIENPHI_ID
      ) b on a.VIENPHI_ID = b.VIENPHI_ID

      left join (select VIENPHI_ID, sum(MGCT.GIATRIMIENGIAM) AS GIATRIMIENGIAM_BHTN
      from TT_MIENGIAM_BHTN MG
      INNER JOIN TT_MIENGIAM_CHITIET MGCT ON MG.MIENGIAM_BHTN_ID = MGCT.MIENGIAM_ID
      where  MG.BENHAN_ID = '$BENHAN_ID$' and MGCT.REF_TABLE = 'TT_MIENGIAM_BHTN' and MG.TINHTRANG = 1 group by VIENPHI_ID
      )c on a.VIENPHI_ID = c.VIENPHI_ID

      left join (select VIENPHI_ID, sum(MGCT.GIATRIMIENGIAM) AS GIATRIMIENGIAM_THANHVIEN
      from TT_MIENGIAM_THANHVIEN MG
      INNER JOIN TT_MIENGIAM_CHITIET MGCT ON MG.MIENGIAM_THANHVIEN_ID = MGCT.MIENGIAM_ID
      where MG.TIEPNHAN_ID = '$TIEPNHAN_ID$' and MGCT.REF_TABLE = 'TT_MIENGIAM_THANHVIEN' and MG.TINHTRANG = 1 group by VIENPHI_ID
      )f on a.VIENPHI_ID = f.VIENPHI_ID

      left join(select VIENPHI_ID, sum(MGCT.GIATRIMIENGIAM) AS GIATRIMIENGIAM_CTCT
      from TT_MIENGIAM_CONGTY MG
      INNER JOIN TT_MIENGIAM_CHITIET MGCT ON MG.MIENGIAM_CONGTY_ID = MGCT.MIENGIAM_ID
      where MG.BENHAN_ID = '$BENHAN_ID$' and MGCT.REF_TABLE = 'TT_MIENGIAM_CONGTY' and MG.TINHTRANG = 1 group by VIENPHI_ID
      )g on a.VIENPHI_ID = g.VIENPHI_ID
    </statement>
    <statement id="DAO00119_TT_VIENPHI_GetList_TiepNhanByHoadon" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select  a.*, a.MIENGIAM_GIATRI as GIATRIMIENGIAM_BH, a.BHTN_GIATRI as GIATRIMIENGIAM_BHTN, a.HOIVIEN_GIATRI as GIATRIMIENGIAM_THANHVIEN, a.CONGTYCHITRA_GIATRI as GIATRIMIENGIAM_CTCT

      from
      (select
      vp.HOADONCHITIET_ID, vp.HOADON_ID, vp.VIENPHI_ID, vp.REF_ID, vp.REF_TABLE, vp.DICHVU_ID, vp.DUOC_ID
      , vp.LOAI_CHIPHI, vp.LOAIGIA_ID, vp.SOLUONG, vp.DONGIA_DOANHTHU, vp.THANHTIEN_DOANHTHU, vp.BHYT_TL, vpp.BHYT_DONGIA, vpp.BHYT_THANHTIEN, vpp.BHYT_DONGIA_CHITRA
      , vp.BHYT_THANHTIEN_CHITRA, vp.BENHNHAN_PHAITHANHTOAN, vp.GIATRI_HOADON, vp.GIATRI_HOADON_DATHANHTOAN, vp.GIATRI_BIENLAI
      , vp.GIATRI_BIENLAI_DATHANHTOAN, vp.GIATRI_BENHNHAN_DATHANHTOAN, vp.TYLE_THATTHU, vp.GIATRI_THATTHU, vp.MIENGIAM_TL, vp.MIENGIAM_GIATRI, vp.NGANSACH_TL, vp.NGANSACH_GIATRI
      , vp.TAITRO_TL, vp.TAITRO_GIATRI, vp.BHTN_GIATRI, vp.NOIDUNGTHU, vp.CHUNGTUXUATBN_ID, vp.TYLEVAT, vp.GIATRIVAT, vp.MASOTHUE, vp.SOCHUNGTUKETOAN, vp.DAHOANTRA, vp.TRANGTHAI
      , vp.PHONGBAN_ID, vp.PHONGBAN_THAYDOI_ID, vp.CONGTYCHITRA_GIATRI, vp.HOIVIEN_GIATRI, vp.BENHVIEN_ID, isnull(c.NGAYGIOYEUCAU, vp.NGAYTAO) NGAYTAO, vp.NGUOITAO_ID, vp.NGAYCAPNHAT, vp.NGUOICAPNHAT_ID
      , c.NOITHUCHIEN_ID, c.NOIYEUCAU_ID, vpp.DATHUCHIEN, vpp.TIEPNHAN_ID, vpp.BENHAN_ID
      from TT_HOADON_CHITIET_NGOAITRU VP
      left join TT_VIENPHI vpp on vpp.VIENPHI_ID = VP.VIENPHI_ID
      left join TT_DVYEUCAU c on c.DVYEUCAU_ID = VP.REF_ID
      where
      vp.HOADON_ID = '$HOADON_ID$'
      ) a
    </statement>
    <statement id="DAO00119_TT_VIENPHI_GetList_BenhAnByHoadon" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select  a.*, a.MIENGIAM_GIATRI as GIATRIMIENGIAM_BH, a.BHTN_GIATRI as GIATRIMIENGIAM_BHTN, a.HOIVIEN_GIATRI as GIATRIMIENGIAM_THANHVIEN, a.CONGTYCHITRA_GIATRI as GIATRIMIENGIAM_CTCT
      from
      (
      select * from (
      select vp.*, c.NOITHUCHIEN_ID, c.NOIYEUCAU_ID, vpp.DATHUCHIEN, vpp.TIEPNHAN_ID, vpp.BENHAN_ID
      from TT_HOADON_CHITIET_NOITRU VP
      left join TT_VIENPHI vpp on vpp.VIENPHI_ID = VP.VIENPHI_ID
      inner join TT_DVYEUCAU c on c.DVYEUCAU_ID = VP.REF_ID and vpp.REF_TABLE = 'TT_DVYEUCAU'
      union
      select vp.*, C.PHONGBANRATOA_ID as NOITHUCHIEN_ID, D.PHONGBAN_ID NOIYEUCAU_ID, vpp.DATHUCHIEN, vpp.TIEPNHAN_ID, vpp.BENHAN_ID
      from TT_HOADON_CHITIET_NOITRU VP
      left join TT_VIENPHI vpp on vpp.VIENPHI_ID = VP.VIENPHI_ID
      inner join TT_NOITRU_TOATHUOC c on c.TOATHUOC_ID = VP.REF_ID and vpp.REF_TABLE = 'TT_NOITRU_TOATHUOC'
      inner join TT_NOITRU_KHAMBENH D on D.KHAMBENH_ID = C.KHAMBENH_ID
      union
      select vp.*, C.PHONGBAN_ID as NOITHUCHIEN_ID, C.PHONGBAN_ID as NOIYEUCAU_ID, vpp.DATHUCHIEN, vpp.TIEPNHAN_ID, vpp.BENHAN_ID
      from TT_HOADON_CHITIET_NOITRU VP
      left join TT_VIENPHI vpp on vpp.VIENPHI_ID = VP.VIENPHI_ID
      inner join TT_CLSKETQUA_VTYT c on c.CLSKETQUA_VTYT_ID = VP.REF_ID and vpp.REF_TABLE = 'TT_CLSKETQUA_VTYT'
      union
      select vp.*, ISNULL(D.PHONGBANTHUCHIEN_ID,d.PHONGBANCHIDINH_ID) as NOITHUCHIEN_ID, ISNULL(D.PHONGBANCHIDINH_ID,D.PHONGBANTHUCHIEN_ID) as NOIYEUCAU_ID, vpp.DATHUCHIEN, vpp.TIEPNHAN_ID, vpp.BENHAN_ID
      from TT_HOADON_CHITIET_NOITRU VP
      left join TT_VIENPHI vpp on vpp.VIENPHI_ID = VP.VIENPHI_ID
      inner join TT_PHAUTHUAT_VTYT c on c.PHAUTHUAT_VTYT_ID = VP.REF_ID and vpp.REF_TABLE = 'TT_PHAUTHUAT_VTYT'
      inner join TT_PHAUTHUAT D on D.PHAUTHUAT_ID = C.PHAUTHUAT_ID
      union
      select vp.*, E.PHONGBAN_ID as NOITHUCHIEN_ID, E.PHONGBAN_ID as NOIYEUCAU_ID, vpp.DATHUCHIEN, vpp.TIEPNHAN_ID, vpp.BENHAN_ID
      from TT_HOADON_CHITIET_NOITRU VP
      left join TT_VIENPHI vpp on vpp.VIENPHI_ID = VP.VIENPHI_ID
      inner join TT_NUT_XACNHANSUATAN_CHITIET XNC on XNC.XACNHANSUATANCHITIET_ID = vp.REF_ID and vpp.REF_TABLE = 'TT_NUT_XACNHANSUATAN_CHITIET'
      inner join TT_NUT_CHIDINHKHAUPHAN_CHITIET D on D.CHIDINHKHAUPHANCHITIET_ID = XNC.CHIDINHKHAUPHANCHITIET_ID
      inner join TM_NUT_KHAUPHANAN c on C.KHAUPHANAN_ID = D.KHAUPHANAN_ID
      inner join TT_NUT_CHIDINHKHAUPHAN E on E.CHIDINHKHAUPHAN_ID = D.CHIDINHKHAUPHAN_ID
      ) B
      where B.HOADON_ID = '$HOADON_ID$'
      ) a
    </statement>
    <statement id="DAO00119_TT_VIENPHI_GetList_TiepNhanDaThanhToan" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select * from TT_VIENPHI
      where
      TIEPNHAN_ID = '$TIEPNHAN_ID$' and 
      (BENHNHAN_PHAITHANHTOAN = GIATRI_BENHNHAN_DATHANHTOAN and DATHANHTOAN = '1')
      and VIENPHI_ID in ($LIST_VIENPHI$)
    </statement>   
    <statement id="DAO00119_TT_VIENPHI_GetList_BenhAnDaThanhToan" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select * from TT_VIENPHI
      where
      TIEPNHAN_ID = '$TIEPNHAN_ID$' and BENHAN_ID = '$BENHAN_ID$' and
      (BENHNHAN_PHAITHANHTOAN = GIATRI_BENHNHAN_DATHANHTOAN and DATHANHTOAN = '1')
      and VIENPHI_ID in ($LIST_VIENPHI$)
    </statement>
    <statement id="DAO00119_TT_VIENPHI_GetList_BenhNhanDaThanhToan" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select * from TT_VIENPHI
      where
      BENHNHAN_ID = '$BENHNHAN_ID$' and
      (BENHNHAN_PHAITHANHTOAN = GIATRI_BENHNHAN_DATHANHTOAN and DATHANHTOAN = '1')
      and VIENPHI_ID in ($LIST_VIENPHI$)
    </statement>
    <statement id="DAO00119_TT_VIENPHI_GetList_DVYeuCauDaThanhToan" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select * from TT_VIENPHI vp
      where
      TIEPNHAN_ID = '$TIEPNHAN_ID$' and
      (vp.DATHANHTOAN = '1') and REF_ID in ($LIST_REFID$)      
    </statement>
    <statement id="DAO00119_TT_VIENPHI_GetList_DVYeuCauDaPhatSinhMienGiam" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select * from TT_MIENGIAM_CHITIET
      where
      VIENPHI_ID in ( select VIENPHI_ID from TT_VIENPHI vp where TIEPNHAN_ID = '$TIEPNHAN_ID$' and REF_ID in ($DS_DVYEUCAU$) and REF_TABLE = 'TT_DVYEUCAU')
      and REF_TABLE != 'TT_MIENGIAM_THANHVIEN'
    </statement>
    <statement id="DAO00119_TT_VIENPHI_GetList_VPHienTai" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select * from TT_VIENPHI vp
      where
      ((vp.DATHANHTOAN = '0') or (vp.BENHNHAN_PHAITHANHTOAN > vp.GIATRI_BENHNHAN_DATHANHTOAN and vp.DATHANHTOAN = '1'))
      and VIENPHI_ID in ($LIST_VIENPHI$)
      <isNotEmpty prepend="and" property="TIEPNHAN_ID">
        TIEPNHAN_ID = '$TIEPNHAN_ID$'
      </isNotEmpty>
      <isNotEmpty prepend="and" property="BENHNHAN_ID">
        BENHNHAN_ID = '$BENHNHAN_ID$' and REF_TABLE in ('TT_CSKH_GOI_DANGKY', 'TT_CSKH_THANHVIEN_CAPTHE')
      </isNotEmpty>
    </statement>
    <statement id="DAO00119_TT_VIENPHI_GetList_VPHienTai_MuaNgoaiTT" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select * from TT_VIENPHI vp
      where
      ((vp.DATHANHTOAN = '0') or (vp.BENHNHAN_PHAITHANHTOAN > vp.GIATRI_BENHNHAN_DATHANHTOAN and vp.DATHANHTOAN = '1'))
      and VIENPHI_ID in ($LIST_VIENPHI$)
      <!--<isNotEmpty prepend="and" property="TIEPNHAN_ID">
        TIEPNHAN_ID = '$TIEPNHAN_ID$'
      </isNotEmpty>
      <isNotEmpty prepend="and" property="BENHNHAN_ID">
        BENHNHAN_ID = '$BENHNHAN_ID$' and REF_TABLE in ('TT_DUOC_CHUNGTU_CHITIET')
      </isNotEmpty>-->
    </statement>
    <statement id="DAO00119_TT_VIENPHI_GetList_TiepNhanChuaMienGiamBHTN" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select A.* from
      TT_MIENGIAM_BHTN A
      left join TT_MIENGIAM_CHITIET B on B.MIENGIAM_ID = A.MIENGIAM_BHTN_ID and B.REF_TABLE = 'TT_MIENGIAM_BHTN'
      where  A.TINHTRANG = '0' and B.VIENPHI_ID in ($LIST_VIENPHI$) and A.TIEPNHAN_ID = '$TIEPNHAN_ID$'   
    </statement>
    <statement id="DAO00119_TT_VIENPHI_GetList_TiepNhanDaThucHien" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select * from TT_VIENPHI
      where
      HOADON_ID = '$HOADON_ID$' and (DATHUCHIEN = '0' or DICHVU_ID is null) and VIENPHI_ID in ($LIST_VIENPHI$)
      <isNotEmpty prepend="and" property="TIEPNHAN_ID">
        TIEPNHAN_ID = '$TIEPNHAN_ID$'
      </isNotEmpty>
      <isNotEmpty prepend="and" property="BENHNHAN_ID">
        BENHNHAN_ID = '$BENHNHAN_ID$' and REF_TABLE in ('TT_CSKH_GOI_DANGKY', 'TT_CSKH_THANHVIEN_CAPTHE')
      </isNotEmpty>
    </statement>
    <statement id="DAO00119_TT_VIENPHI_GetList_DVDaLayMau" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select A.* from TT_VIENPHI A
      left join TT_DVYEUCAU B on A.REF_ID = B.DVYEUCAU_ID
      where
      A.HOADON_ID = '$HOADON_ID$' and A.DATHUCHIEN = '0' and A.VIENPHI_ID in ($LIST_VIENPHI$) and A.REF_TABLE = 'TT_DVYEUCAU' and B.TRANGTHAI = 'DALAYMAU'
      <isNotEmpty prepend="and" property="TIEPNHAN_ID">
        A.TIEPNHAN_ID = '$TIEPNHAN_ID$'
      </isNotEmpty>      
    </statement>
    
    <statement id="DAO00119_TT_VIENPHI_GetList_SauKhiHuyThuThay" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select A.* from TT_VIENPHI A      
      where A.VIENPHI_ID in ($LIST_VIENPHI$)
      <isNotEmpty prepend="and" property="TIEPNHAN_ID">
        A.TIEPNHAN_ID = '$TIEPNHAN_ID$'
      </isNotEmpty>      
    </statement>
    <statement id="DAO00119_TT_VIENPHI_XoaBienLaiTamNgoaiTru" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      delete from TT_HOADON_HINHTHUCTHANHTOAN
      where HOADON_ID = '$HOADON_ID$'

      delete from TT_HOADON_CHITIET_NGOAITRU
      where HOADON_ID = '$HOADON_ID$'

      delete from TT_HOADON
      where HOADON_ID = '$HOADON_ID$' and TRANGTHAI = 'CHUATHUTIEN'

      update TT_VIENPHI set HOADON_ID = null where HOADON_ID = '$HOADON_ID$'
    </statement>
    <statement id="DAO00119_TT_VIENPHI_XoaBienLaiTamNoiTru" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      delete from TT_HOADON_HINHTHUCTHANHTOAN
      where HOADON_ID = '$HOADON_ID$'

      delete from TT_HOADON_CHITIET_NOITRU
      where HOADON_ID = '$HOADON_ID$'

      delete from TT_HOADON
      where HOADON_ID = '$HOADON_ID$' and TRANGTHAI = 'CHUATHUTIEN'

      update TT_VIENPHI set HOADON_ID = null where HOADON_ID = '$HOADON_ID$'
    </statement>
    <update id="DAO00119_TT_HOADON_Update_GhiNhanHuy" parameterClass="System.Collections.IDictionary">
      update TT_HOADON set
      NGUOI_GHINHANHUY_ID = #NGUOI_GHINHANHUY_ID#
      , NGUOICAPNHAT_ID = #NGUOICAPNHAT_ID#
      , THOIGIAN_GHINHANHUY = #THOIGIAN_GHINHANHUY#
      , NGAYCAPNHAT = #NGAYCAPNHAT#
      , TRANGTHAI = 'CHODUYET'
      , BENHVIEN_ID = #BENHVIEN_ID#
      , LYDOHUY_ID = #LYDOHUY_ID#
      , GHICHU = #GHICHU#
      where
      HOADON_ID in ($HOADON_ID$)
    </update>
    <statement id="DAO00119_TT_HOADON_KiemTra_DaGhiNhanHuy" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select * from TT_HOADON
      where HOADON_ID in ($HOADON_ID$) and (TRANGTHAI = 'CHODUYET' or (TRANGTHAI = 'DADUYET' and HUYHOADON = '1'))
    </statement>
    <update id="DAO00119_TT_HOADON_Update_HuyGhiNhanHuy" parameterClass="System.Collections.IDictionary">
      update TT_HOADON set
      NGUOI_GHINHANHUY_ID = null
      , NGUOICAPNHAT_ID = #NGUOICAPNHAT_ID#
      , THOIGIAN_GHINHANHUY = null
      , NGAYCAPNHAT = #NGAYCAPNHAT#
      , TRANGTHAI = 'DATHUTIEN'
      , BENHVIEN_ID = #BENHVIEN_ID#
      , LYDOHUY_ID = null
      , GHICHU = null
      where
      HOADON_ID in ($HOADON_ID$)
    </update>
    <statement id="DAO00119_TT_HOADON_Huy_BienLaiNgoaiTru" parameterClass="System.Collections.IDictionary">
      <!--update vien phi-->
      DECLARE
      @para1 int,
      @para2 float

      DECLARE Data_Cursor CURSOR FOR
      SELECT A.VIENPHI_ID, A.GIATRI_BENHNHAN_DATHANHTOAN FROM TT_HOADON_CHITIET_NGOAITRU A
      where A.HOADON_ID = '$HOADON_ID$';
      OPEN Data_Cursor;
      FETCH NEXT FROM Data_Cursor into @para1, @para2;
      WHILE @@FETCH_STATUS = 0
      BEGIN
      update TT_VIENPHI set
      HOADON_ID = null,
      DATHANHTOAN = '0',
      DUOCPHEPTHUCHIEN = '0',
      GIATRI_BENHNHAN_DATHANHTOAN = GIATRI_BENHNHAN_DATHANHTOAN - @para2,
      GIATRI_HOADON_DATHANHTOAN = GIATRI_HOADON_DATHANHTOAN - @para2,
      NGUOICAPNHAT_ID = '$NGUOICAPNHAT_ID$',
      NGAYCAPNHAT = '$NGAYCAPNHAT$'
      where VIENPHI_ID = @para1
      FETCH NEXT FROM Data_Cursor into @para1, @para2;
      end
      CLOSE Data_Cursor;
      DEALLOCATE Data_Cursor;

    <!--update hoa don-->
      update TT_HOADON set
      HUYHOADON = '$HUYHOADON$',
      HOANTRA = '$HOANTRA$',
      NGUOICAPNHAT_ID = #NGUOICAPNHAT_ID#,
      NGAYCAPNHAT = #NGAYCAPNHAT#
      <isNotEmpty prepend="," property="LYDOHUY_ID">
        LYDOHUY_ID = '$LYDOHUY_ID$'
      </isNotEmpty>    
      where HOADON_ID = $HOADON_ID$

      <!--Update các biên lai tạm ứng-->
      update TT_HOADON set
      TRANGTHAI = 'DATHUTIEN',
      NGUOICAPNHAT_ID = #NGUOICAPNHAT_ID#,
      NGAYCAPNHAT = #NGAYCAPNHAT#
      where HOADONLIENQUAN_ID = #HOADON_ID#
    </statement>
    <statement id="DAO00119_TT_HOADON_Huy_BienLaiNoiTru" parameterClass="System.Collections.IDictionary">
      <!--update vien phi-->
      DECLARE
      @para1 int,
      @para2 float

      DECLARE Data_Cursor CURSOR FOR
      SELECT A.VIENPHI_ID, A.GIATRI_BENHNHAN_DATHANHTOAN FROM TT_HOADON_CHITIET_NOITRU A
      where A.HOADON_ID = '$HOADON_ID$';
      OPEN Data_Cursor;
      FETCH NEXT FROM Data_Cursor into @para1, @para2;
      WHILE @@FETCH_STATUS = 0
      BEGIN
      update TT_VIENPHI set
      <!--HUY = '1',-->
    HOADON_ID = null,
    DATHANHTOAN = '0',
    DUOCPHEPTHUCHIEN = '0',
    GIATRI_BENHNHAN_DATHANHTOAN = GIATRI_BENHNHAN_DATHANHTOAN - @para2,
    NGUOICAPNHAT_ID = '$NGUOICAPNHAT_ID$',
    NGAYCAPNHAT = '$NGAYCAPNHAT$'
    where VIENPHI_ID = @para1
    FETCH NEXT FROM Data_Cursor into @para1, @para2;
    end
    CLOSE Data_Cursor;
    DEALLOCATE Data_Cursor;

    <!--update hoa don-->
      update TT_HOADON set
      HUYHOADON = '$HUYHOADON$',
      HOANTRA = '$HOANTRA$',
      NGUOICAPNHAT_ID = #NGUOICAPNHAT_ID#,
      NGAYCAPNHAT = #NGAYCAPNHAT#
      where HOADON_ID = $HOADON_ID$

      <!--Update các biên lai tạm ứng-->
      update TT_HOADON set
      TRANGTHAI = 'DATHUTIEN',
      NGUOICAPNHAT_ID = #NGUOICAPNHAT_ID#,
      NGAYCAPNHAT = #NGAYCAPNHAT#
      where HOADONLIENQUAN_ID = #HOADON_ID#
    </statement>
    <statement id="DAO00119_TT_HOADON_GetDanhSachHoaDonThanhToanDaDuyetHuyNgoaiTru" parameterClass="System.Collections.IDictionary"  resultClass="DataObject">
      <!--select *
      from TT_HOADON
      where
      TIEPNHAN_ID = '$TIEPNHAN_ID$' and BENHAN_ID is null and DATHANHTOAN = '1' and HUYHOADON = '0'-->
      select distinct A.*
      from TT_HOADON A
      left join TT_HOADON_CHITIET_NGOAITRU B on A.HOADON_ID = B.HOADON_ID
      where
      A.TIEPNHAN_ID = '$TIEPNHAN_ID$' and A.BENHAN_ID is null and A.DATHANHTOAN = '1' and A.HUYHOADON = '0'
      and B.REF_TABLE not in ('TT_CSKH_GOI_DANGKY', 'TT_CSKH_THANHVIEN_CAPTHE', 'TT_DUOC_CHUNGTU_CHITIET')
    </statement>

    <statement id="DAO00119_TT_NOITRU_BENHAN_Update_TrangThai" parameterClass="System.Collections.IDictionary"  resultClass="DataObject">
      update TT_NOITRU_BENHAN
      set
      TRANGTHAI = '$TRANGTHAI$'
      , NGAYCAPNHAT = getdate()
      , NGUOICAPNHAT_ID = #NGUOICAPNHAT_ID#
      where TIEPNHAN_ID = '$TIEPNHAN_ID$'
      <isNotEmpty prepend="AND" property="BENHAN_ID">
        BENHAN_ID = '$BENHAN_ID$'
      </isNotEmpty>
    </statement>

    <statement id="DAO00119_GetDanhSachDichVuChuaThanhToan" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select    VP.*
      FROM TT_NGOAITRU_KHAMBENH_TOATHUOC KBTT
      inner join TT_NGOAITRU_TOATHUOC TT on  TT.KHAMBENH_TOATHUOC_ID = KBTT.KHAMBENH_TOATHUOC_ID
      inner join TT_VIENPHI VP on (TT.TOATHUOC_ID = VP.REF_ID AND VP.REF_TABLE = 'TT_NGOAITRU_TOATHUOC')
      where
      KBTT.CHUNGTUPHATTHUOC_ID = '$CHUNGTU_ID$'
      and KBTT.BENHVIEN_ID = '$BENHVIEN_ID$'
      AND (vp.DATHANHTOAN = '0'
      or ( vp.DATHANHTOAN = '1' and vp.HUY = '1')
      )
      union
      select    VP.*
      FROM TT_NOITRU_KHAMBENH KBTT
      inner join TT_NOITRU_TOATHUOC TT on  TT.KHAMBENH_ID = KBTT.KHAMBENH_ID
      inner join TT_VIENPHI VP on (TT.TOATHUOC_ID = VP.REF_ID AND VP.REF_TABLE = 'TT_NOITRU_TOATHUOC')
      where
      TT.CHUNGTU_ID = '$CHUNGTU_ID$'
      and KBTT.BENHVIEN_ID = '$BENHVIEN_ID$'
      AND (vp.DATHANHTOAN = '0'
      or ( vp.DATHANHTOAN = '1' and vp.HUY = '1')
      )
    </statement>
    <statement id="DAO00119_TT_NOITRU_XACNHAN_CHIPHI_Update_TrangThai" parameterClass="System.Collections.IDictionary"  resultClass="DataObject">
      update TT_NOITRU_XACNHAN_CHIPHI
      set
      TRANGTHAI = '$TRANGTHAI$'
      <isNotEmpty prepend="," property="NGAYHUYXACNHAN">
        NGAYHUYXACNHAN = #NGAYHUYXACNHAN#
      </isNotEmpty>
      <isNotEmpty prepend="," property="NGAYXACNHAN">
        NGAYXACNHAN = #NGAYXACNHAN#
      </isNotEmpty>
      , NGAYCAPNHAT = getdate()
      , NGUOICAPNHAT_ID = #NGUOICAPNHAT_ID#
      where TIEPNHAN_ID = '$TIEPNHAN_ID$'
    </statement>
    <statement id="DAO00119_TT_NOITRU_XACNHAN_CHIPHI_Insert" parameterClass="System.Collections.IDictionary"  resultClass="DataObject">
      insert
      TT_NOITRU_XACNHAN_CHIPHI
      (
      BENHAN_ID
      , TIEPNHAN_ID
      , BENHNHAN_ID
      , TRANGTHAI
      , NGAYXACNHAN
      , NGAYTAO
      , NGUOITAO_ID
      , NGAYCAPNHAT
      , NGUOICAPNHAT_ID
      )
      values
      (
      #BENHAN_ID#
      , #TIEPNHAN_ID#
      , #BENHNHAN_ID#
      , #TRANGTHAI#
      , getdate()
      , getdate()
      , #NGUOITAO_ID#
      , getdate()
      , #NGUOITAO_ID#
      )
      SELECT SCOPE_IDENTITY()
    </statement>
    <statement id="DAO00119_TT_NOITRU_XACNHAN_CHIPHI_Select" parameterClass="System.Collections.IDictionary"  resultClass="DataObject">
      select * from TT_NOITRU_XACNHAN_CHIPHI      
      where TIEPNHAN_ID = '$TIEPNHAN_ID$'
    </statement>
    <statement id="DAO00119_TT_NOITRU_BENHAN_VP_Select" parameterClass="System.Collections.IDictionary"  resultClass="DataObject">
      select Count(*) as TOTAL from TT_VIENPHI
      where BENHAN_ID = '$BENHAN_ID$' and HOADON_ID is not null and HOADON_ID in (select HOADON_ID from TT_HOADON where BENHAN_ID = '$BENHAN_ID$')
    </statement>
    <statement id="DAO00119_TT_HOADON_List_Thanhtoan" parameterClass="System.Collections.IDictionary"  resultClass="DataObject">
      select * from TT_HOADON
      where BENHAN_ID is not null and TIEPNHAN_ID = '$TIEPNHAN_ID$' and DATHANHTOAN = '1' and HUYHOADON = '0' and HOADON_ID = '$HOADON_ID$'
    </statement>
    <statement id="DAO00119_GetDanhsachDichvuThutiensau_Chuathu" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select DICHVU_ID from TT_VIENPHI
      where
      REF_TABLE = 'TT_DVYEUCAU'
      and REF_ID in (select DVYEUCAU_ID from TT_DVYEUCAU where
      TIEPNHAN_ID = (select TIEPNHAN_ID from TT_DUOC_CHUNGTU
      where BENHNHAN_ID = '$BENHNHAN_ID$' and CHUNGTU_ID = '$CHUNGTU_ID$') AND THUTIENSAU = '1') and BENHNHAN_PHAITHANHTOAN != GIATRI_BENHNHAN_DATHANHTOAN
    </statement>
    <statement id="DAO00119_TT_XACNHANCHIPHI_Benhan" parameterClass="System.Collections.IDictionary"  resultClass="DataObject">
      select * from TT_XACNHANCHIPHI
      where BENHAN_ID = '$BENHAN_ID$'
    </statement>
    <statement id="DAO00119_TT_HOADON_KiemtraHoadonCoToathuocKhongBHYTDaXacnhan" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select * from TT_DUOC_CHUNGTU where CHUNGTU_ID in (
      select CHUNGTUPHATTHUOC_ID
      from TT_NGOAITRU_KHAMBENH_TOATHUOC
      where KHAMBENH_TOATHUOC_ID in (select  B.KHAMBENH_TOATHUOC_ID
      from TT_HOADON_CHITIET_NGOAITRU A
      left join TT_NGOAITRU_TOATHUOC B on A.REF_ID = B.TOATHUOC_ID
      where A.HOADON_ID = '$HOADON_ID$' and A.REF_TABLE = 'TT_NGOAITRU_TOATHUOC')
      and LOAITOATHUOC not in ('TV', 'MN', 'MP', 'BV') and DAXACNHAN = '1')
    </statement>
    <statement id="DAO00119_CanhBaoSoBienLai_Conlai" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      declare @intSohdConlai int = null;
      declare @intCanhbanSohdConlai int = null;

      begin
      select @intCanhbanSohdConlai = VALUE from TM_SYS_APPSETTINGS where CODE = 'BIL_SOLUONG_CANHBAO_SAPHET_HOADON'
      if @intCanhbanSohdConlai is null set @intCanhbanSohdConlai = 0

      select top 1
      BLCT.CURRENT_NUMBER, BLCT.START_NUMBER
      , BL.MAX_NUMBER, (BL.KYHIEU + '/' + SERIES) KYHIEU_SOQUYEN, (BL.MAX_NUMBER - BLCT.CURRENT_NUMBER) SOCONLAI
      from
      TT_BIENLAI BL,TT_BIENLAICHITIET BLCT
      where
      BL.BIENLAI_ID = BLCT.BIENLAI_ID
      and BLCT.HIEULUC = 1
      and BLCT.BIENLAI_ID in (select BIENLAI_ID from TT_BIENLAICHITIET where BIENLAICHITIET_ID = '$BIENLAICHITIET_ID$')
      and @intCanhbanSohdConlai >= (BL.MAX_NUMBER - BLCT.CURRENT_NUMBER)
      order by CURRENT_NUMBER DESC
      end
    </statement>
    <statement id="DAO00119_KiemtraHoaDonTamDaDuyetCongNo" parameterClass="System.Collections.IDictionary" resultClass="System.Int64">
      select count(*) from TT_HOADON where HOADON_ID = #HOADON_ID# and TRANGTHAI = 'DADUYETCONGNO'
    </statement>
    <statement id="DAO00119_KiemtraHoaDonTamCongnoDaThanhtoan" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select count(*) as TOTALROW from TT_HOADON where HOADONLIENQUAN_ID = #HOADON_ID#
    </statement>
    <statement id="DAO00119_UpdateHoaDonTamCongnoDaThanhtoan" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      update TT_HOADON
      set DATHANHTOAN = '1'
      where HOADON_ID = '$HOADON_ID$'      
    </statement>
  </statements>   
</sqlMap>