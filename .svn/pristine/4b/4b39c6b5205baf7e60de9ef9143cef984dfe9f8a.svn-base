<?xml version="1.0" encoding="utf-8" ?>
<!--============================================================================
//	CAUTION: This file is generated by IBatisNetGen.3.SQLMap.cst at 5/27/2016 9:04:28 AM
//				Any manual editing will be lost in re-generation.
//===========================================================================-->
<sqlMap namespace="eHospital" xmlns="http://ibatis.apache.org/mapping" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">

  <statements>
    <statement id="DAO00107_GetLoaiHangHoaByCode" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select PL.*
      from TM_PUR_LOAI AS PL
      WHERE PL.BENHVIEN_ID = '$BENHVIEN_ID$' AND PL.MA = '$MA$'
    </statement>
    <statement id="DAO00107_GetLuaChonGiaByCode" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select PL.*
      from TM_PUR_LUACHONGIA AS PL
      WHERE PL.BENHVIEN_ID = '$BENHVIEN_ID$' AND PL.MA = '$MA$'
    </statement>
    <statement id="DAO00107_GetAll" resultClass="DataObject">
      select *
      from TT_DUOC_DUTRU
      order by DUTRU_ID
    </statement>
    <statement id="DAO00107_GetList" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select DD.*, NV.TENNHANVIEN AS NGUOINHAP
      from TT_DUOC_DUTRU AS DD
      inner join TM_NHANVIEN AS NV ON NV.NHANVIEN_ID = DD.NGUOINHAP_ID
      WHERE DD.BENHVIEN_ID = '$BENHVIEN_ID$'
    </statement>
    <statement id="DAO00107_GetDetail" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select DD.*, ISNULL(PC.TRANGTHAI_DUYET, '0') AS TRANGTHAI_DUYET, ISNULL(PC.STATE_CODE, '0') AS STATE_CODE, PC.NGUOIDUYETCAP1_ID
      from TT_DUOC_DUTRU AS DD
      LEFT JOIN TT_PUR_CHUNGTU AS PC ON PC.MACHUNGTU = DD.MACHUNGTUMUAHANG
      where DD.DUTRU_ID  = '$DUTRU_ID$'
      order by DD.DUTRU_ID
    </statement>
    <statement id="DAO00107_GetDuTru" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select DD.*, ISNULL(PC.TRANGTHAI_DUYET, '0') AS TRANGTHAI_DUYET, ISNULL(PC.NGAYGIODUYETCAP3,ISNULL(PC.NGAYGIODUYETCAP2, PC.NGAYGIODUYETCAP1)) AS NGAYDUYETMUAHANG
      , ISNULL(PC.NGUOIDUYETCAP3_ID, ISNULL(PC.NGUOIDUYETCAP2_ID, PC.NGUOIDUYETCAP1_ID)) AS NGUOIDUYETMUAHANG
      from TT_DUOC_DUTRU AS DD
      LEFT JOIN TT_PUR_CHUNGTU AS PC ON PC.MACHUNGTU = DD.MACHUNGTUMUAHANG
      where DD.MACHUNGTU = '$MACHUNGTU$' AND DD.BENHVIEN_ID = '$BENHVIEN_ID$'
    </statement>
    <statement id="DAO00107_GetDuTruDetailByDuTruID" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select DDC.*, D.TENDUOCDAYDU AS TENDUOC, DVT.TENDONVITINH AS TENDONVICOBAN, DVT2.TENDONVITINH, DVT2.GIATRIQUIDOI AS TYLEQUYDOI
      , D.MADUOC, NCC.TENNHACUNGCAP
      from TT_DUOC_DUTRU_CHITIET AS DDC
      inner join TM_DUOC AS D ON D.DUOC_ID = DDC.DUOC_ID
      inner join TM_DONVITINH AS DVT ON DVT.DONVITINH_ID = D.DONVITINH_ID
      inner join TM_DONVITINH AS DVT2 ON DVT2.DONVITINH_ID = DDC.DONVITINH_ID
      inner join TM_NHACUNGCAP AS NCC ON NCC.NHACUNGCAP_ID = DDC.NHACUNGCAP_ID
      where DDC.DUTRU_ID = '$DUTRU_ID$' AND DDC.BENHVIEN_ID = '$BENHVIEN_ID$'
    </statement>
    <statement id="DAO00107_GetMaKho" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select MAKHO
      from TM_KHODUOC
      where KHODUOC_ID = '$KHODUOC_ID$' AND BENHVIEN_ID = '$BENHVIEN_ID$'
    </statement>
    <statement id="DAO00107_GetMaxSoCT" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select ISNULL(MAX(SOCHUNGTU),'000000') AS SOCT
      from TT_DUOC_DUTRU
      where BENHVIEN_ID = '$BENHVIEN_ID$'
    </statement>
    <statement id="DAO00107_GetDetailP" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select *
      from TT_DUOC_DUTRU
      where TT_DUOC_DUTRU.DUTRU_ID  = '$DUTRU_ID$'
      order by DUTRU_ID
    </statement>
    <update id="DAO00107_UpdateTrangThai" parameterClass="System.Collections.IDictionary">
      update TT_DUOC_DUTRU set
      TRANGTHAI = #TRANGTHAI#
      , MACHUNGTUMUAHANG = #MACHUNGTUMUAHANG#
      where DUTRU_ID = '$DUTRU_ID$' AND BENHVIEN_ID = '$BENHVIEN_ID$'
    </update>
    <statement id="DAO00107_UpdateTrangThaiPR" parameterClass="System.Collections.IDictionary">
      update TT_PUR_CHUNGTU set
      STATE_CODE = #STATE_CODE#
      , STATE_NAME = #STATE_NAME#
      , NGAYCAPNHAT = #NGAYCAPNHAT#
      , NGUOICAPNHAT_ID = #NGUOICAPNHAT_ID#
      where MACHUNGTU = '$MACHUNGTUMUAHANG$' AND BENHVIEN_ID = '$BENHVIEN_ID$'
    </statement>
    <statement id="DAO00107_GetListByTrangThai" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select DD.DUTRU_ID, DD.MACHUNGTU, DD.NGAYCHUNGTU, DD.NGAYBAOCAO, KD.TENKHO, NV1.TENNHANVIEN AS NGUOINHAP, NV2.TENNHANVIEN AS NGUOINHAN
      from TT_DUOC_DUTRU AS DD
      inner join TM_NHANVIEN AS NV1 ON DD.NGUOINHAP_ID = NV1.NHANVIEN_ID
      inner join TM_NHANVIEN AS NV2 ON DD.NGUOINHAN_ID = NV2.NHANVIEN_ID
      inner join TM_KHODUOC AS KD ON DD.KHONHAP_ID = KD.KHODUOC_ID
      <dynamic prepend="where">
        <isParameterPresent>
          <isNotEmpty prepend="and" property="BENHVIEN_ID">
            DD.BENHVIEN_ID = '$BENHVIEN_ID$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="NGAYCHUNGTU">
            CONVERT(DATE,DD.NGAYCHUNGTU) = '$NGAYCHUNGTU$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="TRANGTHAI">
            DD.TRANGTHAI = '$TRANGTHAI$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="KHONHAP_ID">
            DD.KHONHAP_ID = '$KHONHAP_ID$'
          </isNotEmpty>
        </isParameterPresent>
      </dynamic>
      order by DUTRU_ID
    </statement>
    <statement id="DAO00107_GetListByCondition" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      WITH LIST_CHUNGTU AS
      (
      select ROW_NUMBER() OVER(ORDER BY DD.DUTRU_ID) as ROWNUMBER
      , DD.MACHUNGTU, DD.NGAYCHUNGTU, DD.NGAYBAOCAO, NV.TENNHANVIEN AS NGUOINHAP, DD.GIATRITHANHTOAN
      from TT_DUOC_DUTRU AS DD
      inner join TM_NHANVIEN AS NV ON DD.NGUOINHAP_ID = NV.NHANVIEN_ID
      left join TT_PUR_CHUNGTU AS PC ON PC.MACHUNGTU = DD.MACHUNGTUMUAHANG
      <dynamic prepend="where">
        <isParameterPresent>
          <isNotEmpty prepend="and" property="BENHVIEN_ID">
            DD.BENHVIEN_ID = '$BENHVIEN_ID$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="TUNGAY">
            CONVERT(DATE,DD.NGAYCHUNGTU) &gt;= CONVERT(DATE,'$TUNGAY$')
          </isNotEmpty>
          <isNotEmpty prepend="and" property="DENNGAY">
            CONVERT(DATE,DD.NGAYCHUNGTU) &lt;= CONVERT(DATE,'$DENNGAY$')
          </isNotEmpty>
          <isNotEmpty prepend="and" property="KHODUOC_ID">
            DD.KHONHAP_ID = '$KHODUOC_ID$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="TRANGTHAI">
            ('$TRANGTHAI$' = 'New' AND DD.TRANGTHAI = '$TRANGTHAI$')
            OR ('$TRANGTHAI$' = 'Purchased' AND PC.TRANGTHAI_DUYET != '1')
            OR ('$TRANGTHAI$' = 'Approved' AND PC.TRANGTHAI_DUYET = '1')
          </isNotEmpty>
        </isParameterPresent>
      </dynamic>
      )
      SELECT *
      FROM LIST_CHUNGTU
      WHERE ROWNUMBER BETWEEN '$FROM_ROW$' AND '$TO_ROW$'
    </statement>
    <statement id="DAO00107_GetTotalByCondition" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select COUNT(DD.MACHUNGTU) AS TOTAL
      from TT_DUOC_DUTRU AS DD
      inner join TM_NHANVIEN AS NV ON DD.NGUOINHAP_ID = NV.NHANVIEN_ID
      left join TT_PUR_CHUNGTU AS PC ON PC.MACHUNGTU = DD.MACHUNGTUMUAHANG
      <dynamic prepend="where">
        <isParameterPresent>
          <isNotEmpty prepend="and" property="BENHVIEN_ID">
            DD.BENHVIEN_ID = '$BENHVIEN_ID$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="TUNGAY">
            CONVERT(DATE,DD.NGAYCHUNGTU) &gt;= CONVERT(DATE,'$TUNGAY$')
          </isNotEmpty>
          <isNotEmpty prepend="and" property="DENNGAY">
            CONVERT(DATE,DD.NGAYCHUNGTU) &lt;= CONVERT(DATE,'$DENNGAY$')
          </isNotEmpty>
          <isNotEmpty prepend="and" property="KHODUOC_ID">
            DD.KHONHAP_ID = '$KHODUOC_ID$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="TRANGTHAI">
            ('$TRANGTHAI$' = 'New' AND DD.TRANGTHAI = '$TRANGTHAI$')
            OR ('$TRANGTHAI$' = 'Purchased' AND PC.TRANGTHAI_DUYET != '1')
            OR ('$TRANGTHAI$' = 'Approved' AND PC.TRANGTHAI_DUYET = '1')
          </isNotEmpty>       
      </isParameterPresent>
      </dynamic>
    </statement>
    <statement id="DAO00107_Add" parameterClass="System.Collections.IDictionary" resultClass="System.Int64">
      insert into TT_DUOC_DUTRU (
      MACHUNGTU
      , SOCHUNGTU
      , NGAYCHUNGTU
      , NGAYBAOCAO
      , MUCDICHCHUNGTU_ID
      , TONGHOP_TUNGAY
      , TONGHOP_DENNGAY
      , NGAYNHAP
      , NGUONDUOC_ID
      , KHONHAP_ID
      , NGUOINHAP_ID
      , NGUOINHAN_ID
      , NGUOINHAN
      , DONVIGIAO_ID
      , NHOMLOAIDUOC_ID
      , LOAIVATTU_ID
      , TONKHODAUKY
      , GIATRI
      , GIATRITHANHTOAN
      , TYLEVAT
      , GIATRIVAT
      , TIENTE_ID
      , TYGIA
      , DIENGIAI
      , DIENGIAINGHIEPVUPHATSINH
      , CHUNGTULIENQUAN_ID
      , TRANGTHAI
      , NGAYDUYET
      , NGUOIDUYET_ID
      , PHAMVI_ID
      , BENHVIEN_ID
      , NGAYTAO
      , NGUOITAO_ID
      , NGAYCAPNHAT
      , NGUOICAPNHAT_ID
      ) values (
      #MACHUNGTU#
      , #SOCHUNGTU#
      , #NGAYCHUNGTU#
      , #NGAYBAOCAO#
      , #MUCDICHCHUNGTU_ID#
      , #TONGHOP_TUNGAY#
      , #TONGHOP_DENNGAY#
      , #NGAYNHAP#
      , #NGUONDUOC_ID#
      , #KHONHAP_ID#
      , #NGUOINHAP_ID#
      , #NGUOINHAN_ID#
      , #NGUOINHAN#
      , #DONVIGIAO_ID#
      , #NHOMLOAIDUOC_ID#
      , #LOAIVATTU_ID#
      , #TONKHODAUKY#
      , #GIATRI#
      , #GIATRITHANHTOAN#
      , #TYLEVAT#
      , #GIATRIVAT#
      , #TIENTE_ID#
      , #TYGIA#
      , #DIENGIAI#
      , #DIENGIAINGHIEPVUPHATSINH#
      , #CHUNGTULIENQUAN_ID#
      , #TRANGTHAI#
      , #NGAYDUYET#
      , #NGUOIDUYET_ID#
      , #PHAMVI_ID#
      , #BENHVIEN_ID#
      , #NGAYTAO#
      , #NGUOITAO_ID#
      , #NGAYCAPNHAT#
      , #NGUOICAPNHAT_ID#
      )
      SELECT SCOPE_IDENTITY()
    </statement>
    <statement id="DAO00107_Detail_Add" parameterClass="System.Collections.IDictionary" resultClass="System.Int64">
      insert into TT_DUOC_DUTRU_CHITIET (
      DUTRU_ID
      , DUOC_ID
      , DONVITINH_ID
      , HESONHANHANG
      , SOLUONGTON
      , SLHANGCHO
      , SLXUAT1
      , SLXUAT2
      , SLXUAT3
      , SLXUAT4
      , SLTRUNGBINHXUAT
      , SLLYTHUYET
      , SLDONGGOI
      , SLTRON
      , SLDADAT
      , NHACUNGCAP_ID
      , LUACHONGIA_ID
      , UUTIEN
      , NGUYENTE
      , TIENTE_ID
      , TYGIA
      , DONGIA
      , VAT
      , DONGIAVAT
      , THANHTIEN
      , GHICHUCHITIET
      , BENHVIEN_ID
      , NGAYTAO
      , NGUOITAO_ID
      , NGAYCAPNHAT
      , NGUOICAPNHAT_ID
      ) values (
      #DUTRU_ID#
      , #DUOC_ID#
      , #DONVITINH_ID#
      , #HESONHANHANG#
      , #SOLUONGTON#
      , #SLHANGCHO#
      , #SLXUAT1#
      , #SLXUAT2#
      , #SLXUAT3#
      , #SLXUAT4#
      , #SLTRUNGBINHXUAT#
      , #SLLYTHUYET#
      , #SLDONGGOI#
      , #SLTRON#
      , #SLDADAT#
      , #NHACUNGCAP_ID#
      , #LUACHONGIA_ID#
      , #UUTIEN#
      , #NGUYENTE#
      , #TIENTE_ID#
      , #TYGIA#
      , #DONGIA#
      , #VAT#
      , #DONGIAVAT#
      , #THANHTIEN#
      , #GHICHUCHITIET#
      , #BENHVIEN_ID#
      , #NGAYTAO#
      , #NGUOITAO_ID#
      , #NGAYCAPNHAT#
      , #NGUOICAPNHAT_ID#
      )
      SELECT SCOPE_IDENTITY()
    </statement>
    <update id="DAO00107_Update" parameterClass="System.Collections.IDictionary">
      update TT_DUOC_DUTRU set
      MACHUNGTU = #MACHUNGTU#
      , SOCHUNGTU = #SOCHUNGTU#
      , NGAYCHUNGTU = #NGAYCHUNGTU#
      , NGAYBAOCAO = #NGAYBAOCAO#
      , MUCDICHCHUNGTU_ID = #MUCDICHCHUNGTU_ID#
      , TONGHOP_TUNGAY = #TONGHOP_TUNGAY#
      , TONGHOP_DENNGAY = #TONGHOP_DENNGAY#
      , NGAYNHAP = #NGAYNHAP#
      , NGUONDUOC_ID = #NGUONDUOC_ID#
      , KHONHAP_ID = #KHONHAP_ID#
      , NGUOINHAP_ID = #NGUOINHAP_ID#
      , NGUOINHAN_ID = #NGUOINHAN_ID#
      , NGUOINHAN = #NGUOINHAN#
      , DONVIGIAO_ID = #DONVIGIAO_ID#
      , NHOMLOAIDUOC_ID = #NHOMLOAIDUOC_ID#
      , LOAIVATTU_ID = #LOAIVATTU_ID#
      , TONKHODAUKY = #TONKHODAUKY#
      , GIATRI = #GIATRI#
      , GIATRITHANHTOAN = #GIATRITHANHTOAN#
      , TYLEVAT = #TYLEVAT#
      , GIATRIVAT = #GIATRIVAT#
      , TIENTE_ID = #TIENTE_ID#
      , TYGIA = #TYGIA#
      , DIENGIAI = #DIENGIAI#
      , DIENGIAINGHIEPVUPHATSINH = #DIENGIAINGHIEPVUPHATSINH#
      , CHUNGTULIENQUAN_ID = #CHUNGTULIENQUAN_ID#
      , MACHUNGTUMUAHANG = #MACHUNGTUMUAHANG#
      , TRANGTHAI = #TRANGTHAI#
      , NGAYDUYET = #NGAYDUYET#
      , NGUOIDUYET_ID = #NGUOIDUYET_ID#
      , PHAMVI_ID = #PHAMVI_ID#
      , BENHVIEN_ID = #BENHVIEN_ID#
      , NGAYCAPNHAT = #NGAYCAPNHAT#
      , NGUOICAPNHAT_ID = #NGUOICAPNHAT_ID#
      where
      DUTRU_ID = '$DUTRU_ID$'
    </update>
    <update id="DAO00107_Detail_Update" parameterClass="System.Collections.IDictionary">
      update TT_DUOC_DUTRU_CHITIET set
				 DUTRU_ID = #DUTRU_ID#
				, DUOC_ID = #DUOC_ID#
				, DONVITINH_ID = #DONVITINH_ID#
				, HESONHANHANG = #HESONHANHANG#
				, SOLUONGTON = #SOLUONGTON#
				, SLHANGCHO = #SLHANGCHO#
				, SLXUAT1 = #SLXUAT1#
				, SLXUAT2 = #SLXUAT2#
				, SLXUAT3 = #SLXUAT3#
				, SLXUAT4 = #SLXUAT4#
				, SLTRUNGBINHXUAT = #SLTRUNGBINHXUAT#
				, SLLYTHUYET = #SLLYTHUYET#
				, SLDONGGOI = #SLDONGGOI#
				, SLTRON = #SLTRON#
				, SLDADAT = #SLDADAT#
				, NHACUNGCAP_ID = #NHACUNGCAP_ID#
        , LUACHONGIA_ID = #LUACHONGIA_ID#
				, UUTIEN = #UUTIEN#
				, NGUYENTE = #NGUYENTE#
				, TIENTE_ID = #TIENTE_ID#
				, TYGIA = #TYGIA#
				, DONGIA = #DONGIA#
				, VAT = #VAT#
				, DONGIAVAT = #DONGIAVAT#
				, THANHTIEN = #THANHTIEN#
				, GHICHUCHITIET = #GHICHUCHITIET#
				, BENHVIEN_ID = #BENHVIEN_ID#
				, NGAYCAPNHAT = #NGAYCAPNHAT#
				, NGUOICAPNHAT_ID = #NGUOICAPNHAT_ID#
			where
    				DUTRUCHITIET_ID = '$DUTRUCHITIET_ID$'
    </update>
    <statement id="DAO00107_Delete" parameterClass="System.Collections.IDictionary" resultClass="System.Int32">
      delete from TT_DUOC_DUTRU
      where
      DUTRU_ID = '$DUTRU_ID$' AND BENHVIEN_ID = '$BENHVIEN_ID$'
    </statement>
    <statement id="DAO00107_Detail_Delete" parameterClass="System.Collections.IDictionary" resultClass="System.Int32">
      delete from TT_DUOC_DUTRU_CHITIET
      where
      DUTRU_ID = '$DUTRU_ID$' AND BENHVIEN_ID = '$BENHVIEN_ID$'
    </statement>
    <statement id="DAO00107_Detail_DeleteByDetailID" parameterClass="System.Collections.IDictionary" resultClass="System.Int32">
      delete from TT_DUOC_DUTRU_CHITIET
      where
      DUTRUCHITIET_ID = '$DUTRUCHITIET_ID$' AND BENHVIEN_ID = '$BENHVIEN_ID$'
    </statement>
    <statement id="DAO00107_GetDuocDetail" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select D.DUOC_ID, D.TENDUOCDAYDU, D.TENHOATCHAT, D.DONVITINH, D.DONVITINH_ID, ISNULL(DVT.TENDONVITINH,D.DONVITINH) AS QUYCACH
      , ISNULL(DVT.DONVITINH_ID,D.DONVITINH_ID) AS QUYCACH_ID, DVT.GIATRIQUIDOI, GC.DONGIAHOPDONG, GC.GIATRUOCTHUE, GC.VAT, G.NHACUNGCAP_ID, NCC.TENNHACUNGCAP
      , G.GOITHAU_ID, 0 AS SLDADAT
      from TM_DUOC AS D
      left join TM_GIAHOPDONGCHITIET AS GC ON GC.DUOC_ID = D.DUOC_ID
      left join TM_GIAHOPDONG AS G ON G.GIAHOPDONG_ID = GC.GIAHOPDONG_ID
      left join TM_DONVITINH AS DVT ON GC.DONVITINH_ID = DVT.DONVITINH_ID
      left join TM_NHACUNGCAP AS NCC ON NCC.NHACUNGCAP_ID = G.NHACUNGCAP_ID
      where D.DUOC_ID = '$DUOC_ID$' AND D.BENHVIEN_ID = '$BENHVIEN_ID$'
      ORDER BY G.GOITHAU_ID
    </statement>
    <statement id="DAO00107_GetDanhSachNCC" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      SELECT D.DUOC_ID, D.TENDUOCDAYDU, D.DONVITINH, D.DONVITINH_ID, G.NHACUNGCAP_ID, NCC.TENNHACUNGCAP
      , ISNULL(DVT.TENDONVITINH,D.DONVITINH) AS QUYCACH, ISNULL(DVT.DONVITINH_ID,D.DONVITINH_ID) AS QUYCACH_ID
      , DVT.GIATRIQUIDOI, GC.DONGIAHOPDONG, GC.GIATRUOCTHUE, GC.VAT, G.GOITHAU_ID, 0 AS SLDADAT
      FROM TM_GIAHOPDONGCHITIET AS GC
      INNER JOIN TM_GIAHOPDONG AS G ON G.GIAHOPDONG_ID = GC.GIAHOPDONG_ID
      INNER JOIN TM_NHACUNGCAP AS NCC ON NCC.NHACUNGCAP_ID = G.NHACUNGCAP_ID
      INNER JOIN TM_DUOC AS D ON D.DUOC_ID = GC.DUOC_ID
      INNER JOIN TM_DONVITINH AS DVT ON DVT.DONVITINH_ID = GC.DONVITINH_ID
      WHERE GC.BENHVIEN_ID = '$BENHVIEN_ID$' AND GC.DUOC_ID = '$DUOC_ID$' AND (CONVERT(DATE,GETDATE()) BETWEEN G.NGAYCUNGCAP AND G.NGAYHETHAN)
      ORDER BY (GC.DONGIAHOPDONG / ISNULL(DVT.GIATRIQUIDOI,1))
    </statement>
    <statement id="DAO00107_GetGiaChungTuGanNhat" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      SELECT TOP 1 D.DUOC_ID, D.TENDUOCDAYDU, D.DONVITINH, D.DONVITINH_ID, DC.NHACUNGCAP_ID, NCC.TENNHACUNGCAP
      , ISNULL(DVT.TENDONVITINH,D.DONVITINH) AS QUYCACH, ISNULL(DVT.DONVITINH_ID,D.DONVITINH_ID) AS QUYCACH_ID
      , DVT.GIATRIQUIDOI, DCC.DONGIAVON AS DONGIAHOPDONG, DCC.DONGIAMUA AS GIATRUOCTHUE, DCC.TYLEVAT AS VAT
      , NULL AS GOITHAU_ID, 0 AS SLDADAT
      FROM TT_DUOC_CHUNGTU AS DC
      INNER JOIN TT_DUOC_CHUNGTU_CHITIET AS DCC ON DCC.CHUNGTU_ID = DC.CHUNGTU_ID
      INNER JOIN TM_NHACUNGCAP AS NCC ON NCC.NHACUNGCAP_ID = DC.NHACUNGCAP_ID
      INNER JOIN TM_DUOC AS D ON D.DUOC_ID = DCC.DUOC_ID
      INNER JOIN TM_DONVITINH AS DVT ON DVT.DONVITINH_ID = DCC.DONVITINH_ID      
      WHERE DC.BENHVIEN_ID = '$BENHVIEN_ID$' AND DC.MUCDICHCHUNGTU_CODE = 'N01' AND DCC.DUOC_ID = '$DUOC_ID$'
      ORDER BY DC.NGAYCHUNGTU DESC
    </statement>
    <statement id="DAO00107_GetGiaGanNhat" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      SELECT TOP 1 D.DUOC_ID, D.TENDUOCDAYDU, D.DONVITINH, D.DONVITINH_ID, DC.NHACUNGCAP_ID, NCC.TENNHACUNGCAP
      , ISNULL(DVT.TENDONVITINH,D.DONVITINH) AS QUYCACH, ISNULL(DVT.DONVITINH_ID,D.DONVITINH_ID) AS QUYCACH_ID
      , DVT.GIATRIQUIDOI, DCC.DONGIAVON AS DONGIAHOPDONG, DCC.DONGIAMUA AS GIATRUOCTHUE, ISNULL(DCC.TYLEVAT,0) AS VAT
      , NULL AS GOITHAU_ID, 0 AS SLDADAT
      FROM TT_DUOC_CHUNGTU AS DC
      INNER JOIN TT_DUOC_CHUNGTU_CHITIET AS DCC ON DCC.CHUNGTU_ID = DC.CHUNGTU_ID
      INNER JOIN TM_NHACUNGCAP AS NCC ON NCC.NHACUNGCAP_ID = DC.NHACUNGCAP_ID
      INNER JOIN TM_DUOC AS D ON D.DUOC_ID = DCC.DUOC_ID
      INNER JOIN TM_DONVITINH AS DVT ON DVT.DONVITINH_ID = DCC.DONVITINH_ID
      INNER JOIN LST_DICTIONARY AS DIC ON DIC.DICTIONARY_ID = DC.MUCDICHCHUNGTU_ID AND DIC.DICTIONARY_TYPE_CODE = 'MucDichChungTu' AND DIC.DICTIONARY_CODE = 'N01'
      WHERE DC.BENHVIEN_ID = '$BENHVIEN_ID$' AND DCC.DUOC_ID = '$DUOC_ID$' AND DC.NHACUNGCAP_ID = '$NHACUNGCAP_ID$'
      ORDER BY DC.NGAYCHUNGTU DESC
    </statement>
    <statement id="DAO00107_GetPhamvi" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      SELECT * FROM TM_PHAMVI
      WHERE TAMNGUNG = '0' AND BENHVIEN_ID = '$BENHVIEN_ID$'
    </statement>
    <statement id="DAO00107_GetTrangThaiDuTru" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      SELECT DICTIONARY_CODE AS MATRANGTHAI, DICTIONARY_NAME AS TENTRANGTHAI FROM LST_DICTIONARY
      WHERE ENABLED = '1' <!--AND BENHVIEN_ID = '$BENHVIEN_ID$'--> AND DICTIONARY_TYPE_CODE = 'TrangThai_DuTru'
      ORDER BY IDX
    </statement>
    <statement id="DAO00107_SoLuongXuatTrongKy" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      SELECT DCC.DUOC_ID, ISNULL(DVT2.DONVITINH_ID,DCC.DONVITINH_ID) AS DONVITINH_ID
      , SUM((CASE WHEN DVT2.DONVITINH_ID IS NULL THEN 1 ELSE ISNULL(DVT.GIATRIQUIDOI,0) END) * ISNULL(DCC.SOLUONGDAXUAT,0)) AS SOLUONG
      FROM TT_DUOC_CHUNGTU DC
      INNER JOIN TM_KHODUOC AS K ON K.KHODUOC_ID = DC.KHOXUAT_ID
      LEFT JOIN TM_KHODUOC AS K2 ON K2.KHODUOC_ID = DC.KHONHAP_ID
      INNER JOIN LST_DICTIONARY AS D ON D.DICTIONARY_ID = DC.MUCDICHCHUNGTU_ID AND D.DICTIONARY_TYPE_CODE = 'MucDichChungTu'
      INNER JOIN TM_PHAMVI AS P ON P.PHAMVI_ID = K.PHAMVI_ID AND P.PHAMVI_ID = '$PHAMVI_ID$'
      INNER JOIN TT_DUOC_CHUNGTU_CHITIET AS DCC ON DC.CHUNGTU_ID = DCC.CHUNGTU_ID
      INNER JOIN TM_DUOC AS DUOC ON DUOC.DUOC_ID = DCC.DUOC_ID
      INNER JOIN TM_LOAIDUOC AS LD ON LD.LOAIDUOC_ID = DUOC.LOAIDUOC_ID
      INNER JOIN TM_DONVITINH AS DVT ON DVT.DONVITINH_ID = DCC.DONVITINH_ID
      LEFT JOIN TM_DONVITINH AS DVT2 ON DVT2.DONVITINH_ID = DVT.DONVICOBAN_ID
      WHERE DC.BENHVIEN_ID = '$BENHVIEN_ID$' AND (CONVERT(DATE,DC.NGAYCHUNGTU) BETWEEN '$TUNGAY$' AND '$DENNGAY$')
      AND ((P.MAPHAMVI = 'BV' AND D.DICTIONARY_CODE IN ($BV_CODE$)  AND (D.DICTIONARY_CODE NOT IN ('X05', 'X07') OR K2.PHAMVI_ID != '$PHAMVI_ID$'))
      OR (P.MAPHAMVI = 'NT' AND D.DICTIONARY_CODE IN ($NT_CODE$)  AND (D.DICTIONARY_CODE NOT IN ('X05', 'X07') OR K2.PHAMVI_ID != '$PHAMVI_ID$')))
      AND DC.TRANGTHAI NOT IN ('HUY', 'CXN', 'PNDCNK') AND ('$LOAIVATTU_ID$' = '' OR LD.LOAIVATTU_ID = '$LOAIVATTU_ID$')
      GROUP BY DCC.DUOC_ID, ISNULL(DVT2.DONVITINH_ID,DCC.DONVITINH_ID)
    </statement>
    <statement id="DAO00107_SoLuongNhapTrongKy" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      SELECT DCC.DUOC_ID, ISNULL(DVT2.DONVITINH_ID,DCC.DONVITINH_ID) AS DONVITINH_ID
      , SUM((CASE WHEN DVT2.DONVITINH_ID IS NULL THEN 1 ELSE ISNULL(DVT.GIATRIQUIDOI,0) END) * ISNULL(DCC.SOLUONGTHUCTE,0)) AS SOLUONG
      FROM TT_DUOC_CHUNGTU DC
      INNER JOIN TM_KHODUOC AS K ON K.KHODUOC_ID = DC.KHONHAP_ID
      LEFT JOIN TM_KHODUOC AS K2 ON K2.KHODUOC_ID = DC.KHOXUAT_ID
      INNER JOIN LST_DICTIONARY AS D ON D.DICTIONARY_ID = DC.MUCDICHCHUNGTU_ID AND D.DICTIONARY_TYPE_CODE = 'MucDichChungTu'
      INNER JOIN TM_PHAMVI AS P ON P.PHAMVI_ID = K.PHAMVI_ID AND P.PHAMVI_ID = '$PHAMVI_ID$'
      INNER JOIN TT_DUOC_CHUNGTU_CHITIET AS DCC ON DC.CHUNGTU_ID = DCC.CHUNGTU_ID
      INNER JOIN TM_DUOC AS DUOC ON DUOC.DUOC_ID = DCC.DUOC_ID
      INNER JOIN TM_LOAIDUOC AS LD ON LD.LOAIDUOC_ID = DUOC.LOAIDUOC_ID
      INNER JOIN TM_DONVITINH AS DVT ON DVT.DONVITINH_ID = DCC.DONVITINH_ID
      LEFT JOIN TM_DONVITINH AS DVT2 ON DVT2.DONVITINH_ID = DVT.DONVICOBAN_ID
      WHERE DC.BENHVIEN_ID = '$BENHVIEN_ID$' AND (CONVERT(DATE,DC.NGAYCHUNGTU) BETWEEN '$TUNGAY$' AND '$DENNGAY$')
      AND ((P.MAPHAMVI = 'BV' AND D.DICTIONARY_CODE IN ($BV_CODE$) AND (D.DICTIONARY_CODE NOT IN ('N05', 'N10') OR K2.PHAMVI_ID != '$PHAMVI_ID$'))
      OR (P.MAPHAMVI = 'NT' AND D.DICTIONARY_CODE IN ($NT_CODE$)  AND (D.DICTIONARY_CODE NOT IN ('N05', 'N10') OR K2.PHAMVI_ID != '$PHAMVI_ID$')))
      AND DC.TRANGTHAI NOT IN ('HUY', 'CXN', 'PNCNK') AND ('$LOAIVATTU_ID$' = '' OR LD.LOAIVATTU_ID = '$LOAIVATTU_ID$')
      GROUP BY DCC.DUOC_ID, ISNULL(DVT2.DONVITINH_ID,DCC.DONVITINH_ID)
    </statement>
    <statement id="DAO00107_SoLuongTonKhoDauThang" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      SELECT DT.DUOC_ID, SUM(ISNULL(DT.SOLUONG,0)) AS SOLUONG
      FROM TT_DUOC_TONDAUKY AS DT
      INNER JOIN TM_KHODUOC AS K ON K.KHODUOC_ID = DT.KHODUOC_ID
      INNER JOIN TT_DUOC_KYTONKHO AS DK ON DK.DUOCKYTONKHO_ID = DT.DUOCKYTONKHO_ID
      INNER JOIN TM_DUOC AS DUOC ON DUOC.DUOC_ID = DT.DUOC_ID
      INNER JOIN TM_LOAIDUOC AS LD ON LD.LOAIDUOC_ID = DUOC.LOAIDUOC_ID
      WHERE K.PHAMVI_ID = '$PHAMVI_ID$' AND DT.BENHVIEN_ID = '$BENHVIEN_ID$' AND DK.THANG = '$THANG$' AND DK.NAM = '$NAM$'
      AND ('$LOAIVATTU_ID$' = '' OR LD.LOAIVATTU_ID = '$LOAIVATTU_ID$')
      GROUP BY DT.DUOC_ID
    </statement>
    <statement id="DAO00107_GetListDuocTonKho" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select B.MAKHO, B.TENKHO, C.MADUOC, C.TENDUOCDAYDU, D.SOLONHAP, E.TENNGUONDUOC, A.*
      from TT_DUOC_TONKHO A
      left join TM_KHODUOC B on A.KHODUOC_ID = B.KHODUOC_ID
      left join TM_DUOC C on C.DUOC_ID = A.DUOC_ID
      left join TT_DUOC_CHUNGTU_SOLONHAP D on D.SOLONHAP_ID = A.SOLONHAP_ID
      left join TM_NGUONHANG E on E.NGUONDUOC_ID = a.NGUONDUOC_ID
      <dynamic prepend="where">
        <isParameterPresent>
          <isNotEmpty prepend="and" property="TUKHOA">
            (C.MADUOC like N'%$TUKHOA$%' or C.TENDUOCDAYDU like N'%$TUKHOA$%')
          </isNotEmpty>
          <isNotEmpty prepend="and" property="KHODUOC_ID">
            A.KHODUOC_ID = '$KHODUOC_ID$'
          </isNotEmpty>
        </isParameterPresent>
      </dynamic>
    </statement>
    <statement id="DAO00107_GetListDuocTonKhoTheoPhamVi" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select  distinct tk.DUOC_KEY, pv.MAPHAMVI, pv.TENPHAMVI , nh.TENNGUONDUOC,
      d.MADUOC, d.TENDUOCDAYDU, d.DONVITINH, d.BHYT,
      tk.SOLUONG, tk.TONKHO, tk.BOOK_NGOAITRU, tk.BOOK_NOITRU
      , TAMNGUNG = CASE WHEN d.TAMNGUNG = '1' OR nh.TAMNGUNG = '1' OR kd.TAMNGUNG = '1' THEN '1' ELSE '0' END
      from TM_DUOC d
      left join TM_TENDUOC ten on d.TENDUOC_ID = ten.TENDUOC_ID
      inner join
      (
      select LTRIM(A.PHAMVI_ID) + '_' + LTRIM(A.DUOC_ID) + '_' + LTRIM(ISNULL(A.NGUONDUOC_ID,'')) as DUOC_KEY, A.PHAMVI_ID, A.NGUONDUOC_ID, A.DUOC_ID,
      SUM(isnull(A.SOLUONG,0)) TONKHO,
      SUM(isnull(E.SOLUONG,0)) BOOK_NGOAITRU, SUM(isnull(F.SOLUONG,0)) BOOK_NOITRU,
      SUM(isnull(A.SOLUONG,0) - isnull(E.SOLUONG,0) - isnull(F.SOLUONG,0)) as SOLUONG
      from
      (
      select SUM(SOLUONG) as SOLUONG, pvsd.PHAMVI_ID, dtk.NGUONDUOC_ID, dtk.DUOC_ID
      from TT_DUOC_TONKHO dtk
      inner join TM_DUOC_PHAMVISD_MAPPING pvsd on dtk.KHODUOC_ID = pvsd.KHODUOC_ID
      where dtk.BENHVIEN_ID = '$BENHVIEN_ID$' group by pvsd.PHAMVI_ID, dtk.NGUONDUOC_ID, dtk.DUOC_ID
      ) A
      left join
      (
      select SUM(SOLUONG) as SOLUONG, PHAMVI_ID, DUOC_ID, NGUONHANG_ID
      from TT_DUOC_TONKHO_BOOK_NGOAITRU where TRANGTHAI != 'HUY' and BENHVIEN_ID = '$BENHVIEN_ID$' group by PHAMVI_ID, DUOC_ID, NGUONHANG_ID
      ) E on A.PHAMVI_ID = E.PHAMVI_ID and A.DUOC_ID = E.DUOC_ID and E.NGUONHANG_ID = A.NGUONDUOC_ID
      left join
      (
      select SUM(SOLUONG) as SOLUONG, PHAMVI_ID, DUOC_ID, NGUONHANG_ID
      from TT_DUOC_TONKHO_BOOK_NOITRU where TRANGTHAI != 'HUY' and BENHVIEN_ID = '$BENHVIEN_ID$' group by PHAMVI_ID, DUOC_ID, NGUONHANG_ID
      ) F on A.PHAMVI_ID = F.PHAMVI_ID and A.DUOC_ID = F.DUOC_ID and F.NGUONHANG_ID = A.NGUONDUOC_ID
      group by LTRIM(A.PHAMVI_ID)  + '_' + LTRIM(A.DUOC_ID) + '_' + LTRIM(ISNULL(A.NGUONDUOC_ID,'')), A.PHAMVI_ID, A.NGUONDUOC_ID, A.DUOC_ID
      ) tk on tk.DUOC_ID = d.DUOC_ID
      left join TM_DUOC_PHAMVISUDUNG kd on kd.PHAMVI_ID = tk.PHAMVI_ID and kd.BENHVIEN_ID = '$BENHVIEN_ID$'
      left join TM_NGUONHANG nh on nh.NGUONDUOC_ID = tk.NGUONDUOC_ID and nh.BENHVIEN_ID = '$BENHVIEN_ID$'
      left join TM_DUOC_PHAMVISUDUNG pv on pv.PHAMVI_ID = tk.PHAMVI_ID
      <dynamic prepend="where">
        <isParameterPresent>
          <isNotEmpty prepend="and" property="TUKHOA">
            (d.MADUOC like N'%$TUKHOA$%' or d.TENDUOCDAYDU like N'%$TUKHOA$%')
          </isNotEmpty>
          <isNotEmpty prepend="and" property="PHAMVI_ID">
            tk.PHAMVI_ID = '$PHAMVI_ID$'
          </isNotEmpty>
        </isParameterPresent>
      </dynamic>
    </statement>
  </statements>

</sqlMap>
