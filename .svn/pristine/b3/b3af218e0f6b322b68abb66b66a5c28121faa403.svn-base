<?xml version="1.0" encoding="utf-8" ?>
<!--============================================================================
//	CAUTION: This file is generated by IBatisNetGen.3.SQLMap.cst at 10/3/2016 10:12:54 AM
//				Any manual editing will be lost in re-generation.
//===========================================================================-->
<sqlMap namespace="eHospital" xmlns="http://ibatis.apache.org/mapping" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
  <statements>
    <!--GetICDBenhChinh-->
    <statement id="DAO00101_GetICDBenhChinh" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      SELECT ICD_BENHCHINH
      FROM TT_NOITRU_BENHAN
      WHERE BENHAN_ID = '$BENHAN_ID$' and BENHVIEN_ID = '$BENHVIEN_ID$'
    </statement>

    <!--GetBuoiAn-->
    <statement id="DAO00101_GetBuoiAn" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      SELECT [BUOIAN_ID],[MABUOIAN],[TENBUOIAN],[TUGIO],[DENGIO],[GIOTONGHOP]
      FROM  TM_NUT_BUOIAN
      WHERE BENHVIEN_ID = '$BENHVIEN_ID$' AND LOAI = '$LOAI$'
    </statement>

    <!-- Begin : Chi dinh suat an -->
    <statement id="DAO00101_GetThongTinNoiTru" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      SELECT LTC.LUUTRUCHITIET_ID,LT.BACSIDIEUTRICHINH_ID, LTC.PHONGBENH_ID, LTC.GIUONGBENH_ID
      FROM
      TT_NOITRU_LUUTRU LT
      INNER JOIN TT_NOITRU_LUUTRUCHITIET LTC ON LTC.LUUTRU_ID = LT.LUUTRU_ID
      WHERE LTC.LUUTRUCHITIET_CURRENT = 1 AND LT.BENHAN_ID = $BENHAN_ID$
    </statement>

    <statement id="DAO00101_GetChiDinh" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      SELECT
      BN.MAYTE
      ,BN.TENBENHNHAN
      ,NUT.CHIDINHKHAUPHAN_ID
      ,NUT.MACHIDINH
      ,NUT.NGAYCHIDINH
      ,NUT.PHONGBAN_ID
      ,NUT.XOA
      ,NUT.BENHVIEN_ID
      ,NUT.NGUOITAO_ID
      ,NUT.NGAYTAO
      ,NUT.NGUOICAPNHAT_ID
      ,NUT.NGAYCAPNHAT
      FROM TT_NUT_CHIDINHKHAUPHAN NUT
      INNER JOIN TT_NUT_CHIDINHKHAUPHAN_CHITIET NUTC ON NUT.CHIDINHKHAUPHAN_ID = NUTC.CHIDINHKHAUPHAN_ID
      INNER JOIN TT_NOITRU_BENHAN BA ON BA.BENHAN_ID = NUTC.BENHAN_ID
      INNER JOIN TT_TIEPNHAN TN ON TN.TIEPNHAN_ID = BA.TIEPNHAN_ID
      INNER JOIN TT_BENHNHAN BN ON TN.BENHNHAN_ID = BN.BENHNHAN_ID
      WHERE NUT.XOA = 0 AND NUTC.XOA = 0
      <isParameterPresent>
        <isNotEmpty prepend="and" property="MACHUNGTU">
          NUT.MACHIDINH LIKE '%' + #MACHUNGTU# + '%'
        </isNotEmpty>
        <isNotEmpty prepend="and" property="TUNGAY">
          CONVERT(date, NUT.NGAYCHIDINH) BETWEEN CONVERT(date, '$TUNGAY$')  and  CONVERT(date, '$DENNGAY$')
        </isNotEmpty>
        <isNotEmpty prepend="and" property="PHONGBAN_ID">
          NUT.PHONGBAN_ID = $PHONGBAN_ID$
        </isNotEmpty>
        <isNotEmpty prepend="and" property="BENHVIEN_ID">
          NUT.BENHVIEN_ID = '$BENHVIEN_ID$'
        </isNotEmpty>
      </isParameterPresent>
      GROUP BY
      BN.MAYTE
      ,BN.TENBENHNHAN
      ,NUT.CHIDINHKHAUPHAN_ID
      ,NUT.MACHIDINH
      ,NUT.NGAYCHIDINH
      ,NUT.PHONGBAN_ID
      ,NUT.XOA
      ,NUT.BENHVIEN_ID
      ,NUT.NGUOITAO_ID
      ,NUT.NGAYTAO
      ,NUT.NGUOICAPNHAT_ID
      ,NUT.NGAYCAPNHAT
      ORDER BY CHIDINHKHAUPHAN_ID DESC
    </statement>
    <statement id="DAO00101_GetChiDinhDetail" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      SELECT DISTINCT
      CDC.CHIDINHKHAUPHANCHITIET_ID
      ,CDC.CHIDINHKHAUPHAN_ID
      ,CDC.BENHAN_ID
      ,CDC.BACSI_ID
      ,CDC.DIEUDUONG_ID
      ,CDC.KHAUPHANAN_ID
      ,CDC.BENH_ID
      ,CDC.CALORIE_ID
      ,CDC.BUOIAN_ID
      ,CDC.NGAYCHIDINH
      ,CDC.GHICHU
      ,CDC.BENHVIEN_ID
      ,CDC.NGUOITAO_ID
      ,CDC.NGAYTAO
      ,CDC.NGUOICAPNHAT_ID
      ,CDC.NGAYCAPNHAT
      ,CN.TENNHANVIEN as NGUOICAPNHAT
      ,CDC.LUUTRUCHITIET_ID
      ,CDC.TINHTIEN
      ,CD.MACHIDINH
      ,LT.BACSIDIEUTRICHINH_ID
      ,BSC.TENNHANVIEN as BACSIDIEUTRICHINH
      ,THC.TONGHOPSUATANCHITIET_ID
      ,THC.TONGHOPSUATAN_ID
      ,THC.NGAYTONGHOP
      ,TH.MATONGHOP
      ,TH.NGUOITONGHOP_ID
      ,XNC.XACNHANSUATANCHITIET_ID
      ,XNC.NGAYXACNHAN
      ,XNC.HUY
      ,XNC.LYDOHUY
      ,BA.BENHNHAN_ID
      ,BA.SOBENHAN
      ,BN.TENBENHNHAN
      ,BS.TENNHANVIEN as TENBACSI
      ,DD.TENNHANVIEN as TENDIEUDUONG
      ,PB.PHONGBAN_ID
      ,PB.TENPHONGBAN
      ,LTC.PHONGBENH_ID
      ,PB2.TENPHONGBAN as TENPHONGBENH
      ,LTC.GIUONGBENH_ID
      ,GB.MAGIUONG
      ,B.TENBUOIAN
      ,BA.TRANGTHAI as TRANGTHAIBENHAN
      ,case when XNC.HUY = 1 then N'Đã hủy'
      when (XNC.XACNHANSUATANCHITIET_ID is null) then N'Chưa xác nhận'
      when (XNC.HUY = 0 and XNC.XACNHANSUATANCHITIET_ID is not null)  then N'Đã xác nhận'
      else N'' end as TRANGTHAIXACNHAN
      FROM TT_NUT_CHIDINHKHAUPHAN_CHITIET CDC
      INNER JOIN TT_NUT_CHIDINHKHAUPHAN CD ON CD.CHIDINHKHAUPHAN_ID = CDC.CHIDINHKHAUPHAN_ID
      INNER JOIN TT_NOITRU_BENHAN BA ON CDC.BENHAN_ID = BA.BENHAN_ID
      INNER JOIN TT_BENHNHAN BN ON BA.BENHNHAN_ID = BN.BENHNHAN_ID
      INNER JOIN TM_NUT_BUOIAN B ON CDC.BUOIAN_ID = B.BUOIAN_ID
      INNER JOIN TM_NHANVIEN BS ON BS.NHANVIEN_ID = CDC.BACSI_ID
      INNER JOIN TM_NHANVIEN DD ON DD.NHANVIEN_ID = CDC.DIEUDUONG_ID
      INNER JOIN TM_NHANVIEN CN ON CN.NHANVIEN_ID = CDC.NGUOICAPNHAT_ID
      INNER JOIN TM_PHONGBAN PB ON PB.PHONGBAN_ID = CD.PHONGBAN_ID
      LEFT JOIN TT_NUT_TONGHOPSUATAN_CHITIET THC ON THC.CHIDINHKHAUPHANCHITIET_ID = CDC.CHIDINHKHAUPHANCHITIET_ID
      LEFT JOIN TT_NUT_TONGHOPSUATAN TH ON TH.TONGHOPSUATAN_ID = THC.TONGHOPSUATAN_ID
      LEFT JOIN TT_NUT_XACNHANSUATAN_CHITIET XNC ON XNC.TONGHOPSUATANCHITIET_ID = THC.TONGHOPSUATANCHITIET_ID
      LEFT JOIN TT_NOITRU_LUUTRUCHITIET LTC ON LTC.LUUTRUCHITIET_ID = CDC.LUUTRUCHITIET_ID
      LEFT JOIN TT_NOITRU_LUUTRU LT ON LT.LUUTRU_ID = LTC.LUUTRU_ID AND LT.LUUTRU_CURRENT = '1'
      LEFT JOIN TM_NHANVIEN BSC ON BSC.NHANVIEN_ID = LT.BACSIDIEUTRICHINH_ID
      LEFT JOIN TM_PHONGBAN PB2 ON PB2.PHONGBAN_ID = LTC.PHONGBENH_ID
      LEFT JOIN TM_GIUONGBENH GB ON GB.GIUONGBENH_ID = LTC.GIUONGBENH_ID
      WHERE
      CDC.XOA = 0
      AND CD.XOA = 0
      AND CDC.CHIDINHKHAUPHAN_ID = $CHIDINHKHAUPHAN_ID$
      order by CDC.NGAYCHIDINH
      <!--AND (LTC.LUUTRUCHITIET_CURRENT = 1 OR LTC.LUUTRUCHITIET_CURRENT is NULL)-->
    </statement>

    <statement id="DAO00101_CanDeleteChiDinh" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      SELECT TOP 1 1
      FROM TT_NUT_TONGHOPSUATAN_CHITIET THC
      INNER JOIN TT_NUT_CHIDINHKHAUPHAN_CHITIET CDC ON THC.CHIDINHKHAUPHANCHITIET_ID = CDC.CHIDINHKHAUPHANCHITIET_ID
      INNER JOIN TT_NUT_CHIDINHKHAUPHAN CD ON CD.CHIDINHKHAUPHAN_ID = CDC.CHIDINHKHAUPHAN_ID
      WHERE CD.CHIDINHKHAUPHAN_ID = $CHIDINHKHAUPHAN_ID$
    </statement>
    <statement id="DAO00101_CanDeleteChiDinhChiTiet" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      SELECT TOP 1 1
      FROM TT_NUT_TONGHOPSUATAN_CHITIET THC
      INNER JOIN TT_NUT_CHIDINHKHAUPHAN_CHITIET CDC ON THC.CHIDINHKHAUPHANCHITIET_ID = CDC.CHIDINHKHAUPHANCHITIET_ID
      WHERE CDC.CHIDINHKHAUPHANCHITIET_ID = $CHIDINHKHAUPHANCHITIET_ID$
    </statement>

    <!-- CRUD table TT_NUT_CHIDINHKHAUPHAN -->
    <statement id="DAO00101_AddChiDinh" parameterClass="System.Collections.IDictionary" resultClass="System.Int64">
      INSERT INTO [TT_NUT_CHIDINHKHAUPHAN]
      ([MACHIDINH]
      ,[NGAYCHIDINH]
      ,[PHONGBAN_ID]
      ,[XOA]
      ,[BENHVIEN_ID]
      ,[NGUOITAO_ID]
      ,[NGAYTAO]
      ,[NGUOICAPNHAT_ID]
      ,[NGAYCAPNHAT]
      ,[PHONGBENH_ID]
      ,[GIUONGBENH_ID])
      VALUES
      (#MACHIDINH#
      ,#NGAYCHIDINH#
      ,#PHONGBAN_ID#
      ,#XOA#
      ,#BENHVIEN_ID#
      ,#NGUOITAO_ID#
      ,#NGAYTAO#
      ,#NGUOICAPNHAT_ID#
      ,#NGAYCAPNHAT#
      ,#PHONGBENH_ID#
      ,#GIUONGBENH_ID#)
      SELECT SCOPE_IDENTITY() as value

    </statement>
    <update id="DAO00101_UpdateChiDinh" parameterClass="System.Collections.IDictionary">
      UPDATE [TT_NUT_CHIDINHKHAUPHAN]
      SET [MACHIDINH] = #MACHIDINH#
      ,[NGAYCHIDINH] = #NGAYCHIDINH#
      ,[XOA] = #XOA#
      ,[NGUOICAPNHAT_ID] = #NGUOICAPNHAT_ID#
      ,[NGAYCAPNHAT] = #NGAYCAPNHAT#
      WHERE CHIDINHKHAUPHAN_ID = $CHIDINHKHAUPHAN_ID$
    </update>
    <delete id="DAO00101_DeleteChiDinh" parameterClass="System.Collections.IDictionary" resultClass="System.Int32">
      DELETE FROM [TT_NUT_CHIDINHKHAUPHAN]
      WHERE [CHIDINHKHAUPHAN_ID] = '$CHIDINHKHAUPHAN_ID$'
    </delete>

    <!-- CRUD table TT_NUT_CHIDINHKHAUPHAN_CHITIET -->
    <statement id="DAO00101_AddChiDinhDetail" parameterClass="System.Collections.IDictionary" resultClass="System.Int64">
      INSERT INTO [TT_NUT_CHIDINHKHAUPHAN_CHITIET]
      ([CHIDINHKHAUPHAN_ID]
      ,[BENHAN_ID]
      ,[BACSI_ID]
      ,[DIEUDUONG_ID]
      ,[KHAUPHANAN_ID]
      ,[BENH_ID]
      ,[CALORIE_ID]
      ,[BUOIAN_ID]
      ,[NGAYCHIDINH]
      ,[GHICHU]
      ,[LUUTRUCHITIET_ID]
      ,[TINHTIEN]
      ,[XOA]
      ,[BENHVIEN_ID]
      ,[NGUOITAO_ID]
      ,[NGAYTAO]
      ,[NGUOICAPNHAT_ID]
      ,[NGAYCAPNHAT])
      VALUES
      (#CHIDINHKHAUPHAN_ID#
      ,#BENHAN_ID#
      ,#BACSI_ID#
      ,#DIEUDUONG_ID#
      ,#KHAUPHANAN_ID#
      ,#BENH_ID#
      ,#CALORIE_ID#
      ,#BUOIAN_ID#
      ,#NGAYCHIDINH#
      ,#GHICHU#
      ,#LUUTRUCHITIET_ID#
      ,#TINHTIEN#
      ,#XOA#
      ,#BENHVIEN_ID#
      ,#NGUOITAO_ID#
      ,#NGAYTAO#
      ,#NGUOICAPNHAT_ID#
      ,#NGAYCAPNHAT#)
      <!--SELECT SCOPE_IDENTITY() as value-->
      <!--<selectKey resultClass="System.Int64" type="post" >
        SELECT @@IDENTITY as value
      </selectKey>-->
    </statement>
    <update id="DAO00101_UpdateChiDinhDetail" parameterClass="System.Collections.IDictionary">
      UPDATE [TT_NUT_CHIDINHKHAUPHAN_CHITIET]
      SET [CHIDINHKHAUPHAN_ID] = #CHIDINHKHAUPHAN_ID#
      ,[BENHAN_ID] = #BENHAN_ID#
      ,[BACSI_ID] = #BACSI_ID#
      ,[DIEUDUONG_ID] = #DIEUDUONG_ID#
      ,[KHAUPHANAN_ID] = #KHAUPHANAN_ID#
      ,[BENH_ID] = #BENH_ID#
      ,[CALORIE_ID] = #CALORIE_ID#
      ,[BUOIAN_ID] = #BUOIAN_ID#
      ,[NGAYCHIDINH] = #NGAYCHIDINH#
      ,[GHICHU] = #GHICHU#
      ,[LUUTRUCHITIET_ID]= #LUUTRUCHITIET_ID#
      ,[TINHTIEN] = #TINHTIEN#
      ,[XOA] = #XOA#
      ,[BENHVIEN_ID] = #BENHVIEN_ID#
      ,[NGUOITAO_ID] = #NGUOITAO_ID#
      ,[NGAYTAO] = #NGAYTAO#
      ,[NGUOICAPNHAT_ID] = #NGUOICAPNHAT_ID#
      ,[NGAYCAPNHAT] = #NGAYCAPNHAT#
      WHERE [CHIDINHKHAUPHANCHITIET_ID] = $CHIDINHKHAUPHANCHITIET_ID$
    </update>
    <delete id="DAO00101_DeleteChiDinhDetail" parameterClass="System.Collections.IDictionary" resultClass="System.Int32">
      DELETE FROM [TT_NUT_CHIDINHKHAUPHAN_CHITIET]
      WHERE [CHIDINHKHAUPHANCHITIET_ID] = $CHIDINHKHAUPHANCHITIET_ID$
    </delete>

    <update id="DAO00101_DeleteChiDinhDetailWithMark" parameterClass="System.Collections.IDictionary">
      UPDATE TT_NUT_CHIDINHKHAUPHAN_CHITIET
      SET XOA = 1
      ,[NGUOITAO_ID] = #NGUOITAO_ID#
      ,[NGAYTAO] = #NGAYTAO#
      ,[NGUOICAPNHAT_ID] = #NGUOICAPNHAT_ID#
      ,[NGAYCAPNHAT] = #NGAYCAPNHAT#
      WHERE CHIDINHKHAUPHAN_ID = $CHIDINHKHAUPHAN_ID$
    </update>

    <!-- End : Chi dinh suat an -->

    <!-- Begin : Tong hop suat an by khoa (chua tong hop) -->
    <statement id="DAO00101_GetTongHopByKhoa" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      SELECT DISTINCT
      CDC.CHIDINHKHAUPHANCHITIET_ID
      ,CDC.CHIDINHKHAUPHAN_ID
      ,CDC.BENHAN_ID
      ,CDC.BACSI_ID
      ,CDC.DIEUDUONG_ID
      ,CDC.KHAUPHANAN_ID
      ,CDC.BENH_ID
      ,CDC.CALORIE_ID
      ,CDC.BUOIAN_ID
      ,CDC.NGAYCHIDINH
      ,CDC.GHICHU
      ,CDC.BENHVIEN_ID
      ,CDC.NGUOITAO_ID
      ,CDC.NGAYTAO
      ,CDC.LUUTRUCHITIET_ID
      ,CDC.TINHTIEN
      ,CD.MACHIDINH
      ,THC.TONGHOPSUATANCHITIET_ID
      ,THC.TONGHOPSUATAN_ID
      ,THC.NGAYTONGHOP
      ,THC.NGAYCAPNHAT
      ,THC.NGUOICAPNHAT_ID
      ,CN.TENNHANVIEN AS NGUOICAPNHAT
      ,TH.MATONGHOP
      ,TH.NGUOITONGHOP_ID
      ,XNC.XACNHANSUATANCHITIET_ID
      ,XNC.NGAYXACNHAN
      ,XNC.HUY
      ,XNC.LYDOHUY
      ,BA.BENHNHAN_ID
      ,BA.SOBENHAN
      ,BN.TENBENHNHAN
      ,BS.TENNHANVIEN as TENBACSI
      ,DD.TENNHANVIEN as TENDIEUDUONG
      ,PB.PHONGBAN_ID
      ,PB.TENPHONGBAN
      ,LTC.PHONGBENH_ID
      ,PB2.TENPHONGBAN as TENPHONGBENH
      ,LTC.GIUONGBENH_ID
      ,GB.MAGIUONG
      ,B.TENBUOIAN
      ,BA.TRANGTHAI as TRANGTHAIBENHAN
      ,case when XNC.HUY = 1 then N'Đã hủy'
      when (XNC.XACNHANSUATANCHITIET_ID is null) then N'Chưa xác nhận'
      when (XNC.HUY = 0 and XNC.XACNHANSUATANCHITIET_ID is not null)  then N'Đã xác nhận'
      else N'' end as TRANGTHAIXACNHAN
      FROM TT_NUT_CHIDINHKHAUPHAN_CHITIET CDC
      INNER JOIN TT_NUT_CHIDINHKHAUPHAN CD ON CD.CHIDINHKHAUPHAN_ID = CDC.CHIDINHKHAUPHAN_ID
      INNER JOIN TT_NOITRU_BENHAN BA ON CDC.BENHAN_ID = BA.BENHAN_ID
      INNER JOIN TT_BENHNHAN BN ON BA.BENHNHAN_ID = BN.BENHNHAN_ID
      INNER JOIN TM_NUT_BUOIAN B ON CDC.BUOIAN_ID = B.BUOIAN_ID
      INNER JOIN TM_NHANVIEN BS ON BS.NHANVIEN_ID = CDC.BACSI_ID
      INNER JOIN TM_NHANVIEN DD ON DD.NHANVIEN_ID = CDC.DIEUDUONG_ID
      INNER JOIN TM_PHONGBAN PB ON PB.PHONGBAN_ID = CD.PHONGBAN_ID
      LEFT JOIN TT_NUT_TONGHOPSUATAN_CHITIET THC ON THC.CHIDINHKHAUPHANCHITIET_ID = CDC.CHIDINHKHAUPHANCHITIET_ID
      LEFT JOIN TT_NUT_TONGHOPSUATAN TH ON TH.TONGHOPSUATAN_ID = THC.TONGHOPSUATAN_ID
      LEFT JOIN TT_NUT_XACNHANSUATAN_CHITIET XNC ON XNC.TONGHOPSUATANCHITIET_ID = THC.TONGHOPSUATANCHITIET_ID
      LEFT JOIN TT_NOITRU_LUUTRUCHITIET LTC ON LTC.LUUTRUCHITIET_ID = CDC.LUUTRUCHITIET_ID
      LEFT JOIN TT_NOITRU_LUUTRU LT ON LT.LUUTRU_ID = LTC.LUUTRU_ID AND LT.LUUTRU_CURRENT = '1'
      LEFT JOIN TM_PHONGBAN PB2 ON PB2.PHONGBAN_ID = LTC.PHONGBENH_ID
      LEFT JOIN TM_GIUONGBENH GB ON GB.GIUONGBENH_ID = LTC.GIUONGBENH_ID
      LEFT JOIN TM_NHANVIEN CN ON CN.NHANVIEN_ID = THC.NGUOICAPNHAT_ID
      WHERE ((TH.MATONGHOP is NULL
      AND CD.XOA = 0
      AND CDC.XOA = 0) OR XNC.HUY = 1)
      AND (CD.PHONGBAN_ID = #PHONGBAN_ID# OR -1 = #PHONGBAN_ID#)
      <isParameterPresent>
        <isNotEmpty prepend="and" property="NGAYCHIDINH">
          CONVERT(date, CDC.NGAYCHIDINH) BETWEEN CONVERT(date, '$NGAYCHIDINH$') AND CONVERT(date, '$NGAYCHIDINH_DEN$')
        </isNotEmpty>
        <isNotEmpty prepend="and" property="BENHVIEN_ID">
          CDC.BENHVIEN_ID = '$BENHVIEN_ID$'
        </isNotEmpty>
        <isNotEmpty prepend="and" property="BUOIANS">
          CDC.BUOIAN_ID IN
          <iterate open="(" close=")" conjunction=",  " property="BUOIANS" >#BUOIANS[]#</iterate>
        </isNotEmpty>
      </isParameterPresent>
    </statement>

    <statement id="DAO00101_GetTongHop" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      SELECT TH.TONGHOPSUATAN_ID
      ,MATONGHOP
      ,NGUOITONGHOP_ID
      ,TH.NGAYTONGHOP
      ,GHICHU
      ,TH.BENHVIEN_ID
      ,TH.NGUOITAO_ID
      ,TH.NGAYTAO
      ,TH.NGUOICAPNHAT_ID
      ,TH.NGAYCAPNHAT
      FROM TT_NUT_TONGHOPSUATAN TH
      <dynamic prepend="where">
        <isParameterPresent>
          <isNotEmpty prepend="and" property="MACHUNGTU">
            TH.MATONGHOP LIKE '%' + #MACHUNGTU# + '%'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="TUNGAY">
            CONVERT(date, TH.NGAYTONGHOP) BETWEEN CONVERT(date, '$TUNGAY$')  and  CONVERT(date, '$DENNGAY$')
          </isNotEmpty>
          <isNotEmpty prepend="and" property="PHONGBAN_ID">
            TH.TONGHOPSUATAN_ID in
            (
            select distinct thc.TONGHOPSUATAN_ID from TT_NUT_TONGHOPSUATAN_CHITIET thc
            inner join TT_NUT_CHIDINHKHAUPHAN_CHITIET cdc on thc.CHIDINHKHAUPHANCHITIET_ID = cdc.CHIDINHKHAUPHANCHITIET_ID
            inner join TT_NUT_CHIDINHKHAUPHAN cd on cdc.CHIDINHKHAUPHAN_ID = cd.CHIDINHKHAUPHAN_ID
            where cd.PHONGBAN_ID = '$PHONGBAN_ID$'
            )
          </isNotEmpty>
          <isNotEmpty prepend="and" property="BENHVIEN_ID">
            TH.BENHVIEN_ID = '$BENHVIEN_ID$'
          </isNotEmpty>
        </isParameterPresent>
      </dynamic>
      ORDER BY TONGHOPSUATAN_ID DESC
    </statement>
    <statement id="DAO00101_GetTongHopDetail" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      SELECT DISTINCT
      CDC.CHIDINHKHAUPHANCHITIET_ID
      ,CDC.CHIDINHKHAUPHAN_ID
      ,CDC.BENHAN_ID
      ,CDC.BACSI_ID
      ,CDC.DIEUDUONG_ID
      ,CDC.KHAUPHANAN_ID
      ,CDC.BENH_ID
      ,CDC.CALORIE_ID
      ,CDC.BUOIAN_ID
      ,CDC.NGAYCHIDINH
      ,CDC.GHICHU
      ,CDC.BENHVIEN_ID
      ,CDC.LUUTRUCHITIET_ID
      ,CDC.TINHTIEN
      ,CD.MACHIDINH
      ,THC.TONGHOPSUATANCHITIET_ID
      ,THC.TONGHOPSUATAN_ID
      ,THC.NGAYTONGHOP
      ,THC.NGUOITAO_ID
      ,THC.NGAYTAO
      ,THC.NGAYCAPNHAT
      ,THC.NGUOICAPNHAT_ID
      ,CN.TENNHANVIEN AS NGUOICAPNHAT
      ,TH.MATONGHOP
      ,TH.NGUOITONGHOP_ID
      ,XNC.XACNHANSUATANCHITIET_ID
      ,XNC.NGAYXACNHAN
      ,XNC.HUY
      ,XNC.LYDOHUY
      ,BA.BENHNHAN_ID
      ,BA.SOBENHAN
      ,BN.TENBENHNHAN
      ,BS.TENNHANVIEN as TENBACSI
      ,DD.TENNHANVIEN as TENDIEUDUONG
      ,PB.PHONGBAN_ID
      ,PB.TENPHONGBAN
      ,LTC.PHONGBENH_ID
      ,PB2.TENPHONGBAN as TENPHONGBENH
      ,LTC.GIUONGBENH_ID
      ,GB.MAGIUONG
      ,B.TENBUOIAN
      ,BA.TRANGTHAI as TRANGTHAIBENHAN
      ,case when XNC.HUY = 1 then N'Đã hủy'
      when (XNC.XACNHANSUATANCHITIET_ID is null) then N'Chưa xác nhận'
      when (XNC.HUY = 0 and XNC.XACNHANSUATANCHITIET_ID is not null)  then N'Đã xác nhận'
      else N'' end as TRANGTHAIXACNHAN
      FROM TT_NUT_CHIDINHKHAUPHAN_CHITIET CDC
      INNER JOIN TT_NUT_CHIDINHKHAUPHAN CD ON CD.CHIDINHKHAUPHAN_ID = CDC.CHIDINHKHAUPHAN_ID
      INNER JOIN TT_NOITRU_BENHAN BA ON CDC.BENHAN_ID = BA.BENHAN_ID
      INNER JOIN TT_BENHNHAN BN ON BA.BENHNHAN_ID = BN.BENHNHAN_ID
      INNER JOIN TM_NUT_BUOIAN B ON CDC.BUOIAN_ID = B.BUOIAN_ID
      INNER JOIN TM_NHANVIEN BS ON BS.NHANVIEN_ID = CDC.BACSI_ID
      INNER JOIN TM_NHANVIEN DD ON DD.NHANVIEN_ID = CDC.DIEUDUONG_ID
      INNER JOIN TM_PHONGBAN PB ON PB.PHONGBAN_ID = CD.PHONGBAN_ID
      LEFT JOIN TT_NUT_TONGHOPSUATAN_CHITIET THC ON THC.CHIDINHKHAUPHANCHITIET_ID = CDC.CHIDINHKHAUPHANCHITIET_ID
      LEFT JOIN TT_NUT_TONGHOPSUATAN TH ON TH.TONGHOPSUATAN_ID = THC.TONGHOPSUATAN_ID
      LEFT JOIN TT_NUT_XACNHANSUATAN_CHITIET XNC ON XNC.TONGHOPSUATANCHITIET_ID = THC.TONGHOPSUATANCHITIET_ID
      LEFT JOIN TT_NOITRU_LUUTRUCHITIET LTC ON LTC.LUUTRUCHITIET_ID = CDC.LUUTRUCHITIET_ID
      LEFT JOIN TT_NOITRU_LUUTRU LT ON LT.LUUTRU_ID = LTC.LUUTRU_ID AND LT.LUUTRU_CURRENT = '1'
      LEFT JOIN TM_PHONGBAN PB2 ON PB2.PHONGBAN_ID = LTC.PHONGBENH_ID
      LEFT JOIN TM_GIUONGBENH GB ON GB.GIUONGBENH_ID = LTC.GIUONGBENH_ID
      LEFT JOIN TM_NHANVIEN CN ON CN.NHANVIEN_ID = THC.NGUOICAPNHAT_ID
      WHERE
      THC.TONGHOPSUATAN_ID = '$TONGHOPSUATAN_ID$'
      AND CD.XOA = 0
      AND CDC.XOA = 0
      <!--AND (LTC.LUUTRUCHITIET_CURRENT = 1 OR LTC.LUUTRUCHITIET_CURRENT is NULL)-->
    </statement>

    <!-- CRUD table TT_NUT_TONGHOPSUATAN -->
    <insert id="DAO00101_AddTongHop" parameterClass="System.Collections.IDictionary" resultClass="System.Int64">
      INSERT INTO TT_NUT_TONGHOPSUATAN
      (MATONGHOP
      ,NGUOITONGHOP_ID
      ,NGAYTONGHOP
      ,GHICHU
      ,BENHVIEN_ID
      ,NGUOITAO_ID
      ,NGAYTAO
      ,NGUOICAPNHAT_ID
      ,NGAYCAPNHAT
      ,NGAYCHIDINH)
      VALUES
      (#MATONGHOP#
      ,#NGUOITONGHOP_ID#
      ,#NGAYTONGHOP#
      ,#GHICHU#
      ,#BENHVIEN_ID#
      ,#NGUOITAO_ID#
      ,#NGAYTAO#
      ,#NGUOICAPNHAT_ID#
      ,#NGAYCAPNHAT#
      ,#NGAYCHIDINH#)
      <!--SELECT SCOPE_IDENTITY()-->
      <selectKey resultClass="System.Int64" type="post" >
        SELECT @@IDENTITY as value
      </selectKey>
    </insert>
    <update id="DAO00101_UpdateTongHop" parameterClass="System.Collections.IDictionary">
      UPDATE TT_NUT_TONGHOPSUATAN
      SET MATONGHOP = #MATONGHOP#
      ,NGAYTONGHOP = #NGAYTONGHOP#
      ,GHICHU = #GHICHU#
      ,NGUOICAPNHAT_ID = #NGUOICAPNHAT_ID#
      ,NGAYCAPNHAT = #NGAYCAPNHAT#
      WHERE TONGHOPSUATAN_ID = #TONGHOPSUATAN_ID#
    </update>
    <delete id="DAO00101_DeleteTongHop" parameterClass="System.Collections.IDictionary" resultClass="System.Int32">
      DELETE FROM TT_NUT_TONGHOPSUATAN
      WHERE TONGHOPSUATAN_ID = '$TONGHOPSUATAN_ID$'
    </delete>

    <!-- CRUD table TT_NUT_TONGHOPSUATAN_CHITIET -->
    <insert id="DAO00101_AddTongHopDetail" parameterClass="System.Collections.IDictionary" resultClass="System.Int64">
      INSERT INTO TT_NUT_TONGHOPSUATAN_CHITIET
      (TONGHOPSUATAN_ID
      ,CHIDINHKHAUPHANCHITIET_ID
      ,NGAYTONGHOP
      ,BENHVIEN_ID
      ,NGUOITAO_ID
      ,NGAYTAO
      ,NGUOICAPNHAT_ID
      ,NGAYCAPNHAT
      )
      VALUES
      (#TONGHOPSUATAN_ID#
      ,#CHIDINHKHAUPHANCHITIET_ID#
      ,#NGAYTONGHOP#
      ,#BENHVIEN_ID#
      ,#NGUOITAO_ID#
      ,#NGAYTAO#
      ,#NGUOICAPNHAT_ID#
      ,#NGAYCAPNHAT#
      )
      <!--SELECT SCOPE_IDENTITY()-->
      <selectKey resultClass="System.Int64" type="post" >
        SELECT @@IDENTITY as value
      </selectKey>
    </insert>
    <update id="DAO00101_UpdateTongHopDetail" parameterClass="System.Collections.IDictionary">
      UPDATE TT_NUT_TONGHOPSUATAN_CHITIET
      SET NGAYTONGHOP = #NGAYTONGHOP#
      ,NGUOICAPNHAT_ID = #NGUOICAPNHAT_ID#
      ,NGAYCAPNHAT = #NGAYCAPNHAT#
      WHERE TONGHOPSUATANCHITIET_ID = '$TONGHOPSUATANCHITIET_ID$'
    </update>
    <delete id="DAO00101_DeleteTongHopDetail" parameterClass="System.Collections.IDictionary" resultClass="System.Int32">
      DELETE FROM TT_NUT_TONGHOPSUATAN_CHITIET
      WHERE TONGHOPSUATANCHITIET_ID = '$TONGHOPSUATANCHITIET_ID$'
    </delete>
    <delete id="DAO00101_DeleteTongHopDetailByParent" parameterClass="System.Collections.IDictionary" resultClass="System.Int32">
      DELETE FROM TT_NUT_TONGHOPSUATAN_CHITIET
      WHERE TONGHOPSUATAN_ID = '$TONGHOPSUATAN_ID$'
    </delete>
    <!-- End : Tong hop suat an -->

    <!-- Begin : Xac nhan suat an -->
    <statement id="DAO00101_GetXacNhanDetail" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      SELECT DISTINCT
      CDC.CHIDINHKHAUPHANCHITIET_ID
      ,CDC.CHIDINHKHAUPHAN_ID
      ,CDC.BENHAN_ID
      ,CDC.BACSI_ID
      ,CDC.DIEUDUONG_ID
      ,CDC.KHAUPHANAN_ID
      ,CDC.BENH_ID
      ,CDC.CALORIE_ID
      ,CDC.BUOIAN_ID
      ,CD.NGAYCHIDINH
      ,CDC.GHICHU
      ,CDC.BENHVIEN_ID
      ,CDC.NGUOITAO_ID
      ,CDC.NGAYTAO
      ,CDC.LUUTRUCHITIET_ID
      ,CDC.TINHTIEN
      ,CD.MACHIDINH
      ,THC.TONGHOPSUATANCHITIET_ID
      ,THC.TONGHOPSUATAN_ID
      ,THC.NGAYTONGHOP
      ,TH.MATONGHOP
      ,TH.NGUOITONGHOP_ID
      ,XNC.XACNHANSUATANCHITIET_ID
      ,XNC.NGAYXACNHAN
      ,XNC.NGUOIXACNHAN_ID
      ,XNC.HUY
      ,XNC.LYDOHUY
      ,XNC.NGAYCAPNHAT
      ,XNC.NGUOICAPNHAT_ID
      ,CN.TENNHANVIEN AS NGUOICAPNHAT
      ,BA.BENHNHAN_ID
      ,BA.SOBENHAN
      ,BN.TENBENHNHAN
      ,BS.TENNHANVIEN as TENBACSI
      ,DD.TENNHANVIEN as TENDIEUDUONG
      ,PB.PHONGBAN_ID
      ,PB.TENPHONGBAN
      ,LTC.PHONGBENH_ID
      ,PB2.TENPHONGBAN as TENPHONGBENH
      ,LTC.GIUONGBENH_ID
      ,GB.MAGIUONG
      ,B.TENBUOIAN
      ,BA.TRANGTHAI as TRANGTHAIBENHAN
      ,B.MABUOIAN
      ,DATEPART(HOUR,B.GIOTONGHOP) AS GIOTONGHOP
      ,DATEPART(HOUR,CD.NGAYCHIDINH) AS GIOCHIDINH
      ,case when XNC.HUY = 1 then N'Đã hủy'
      when (XNC.XACNHANSUATANCHITIET_ID is null) then N'Chưa xác nhận'
      when (XNC.HUY = 0 and XNC.XACNHANSUATANCHITIET_ID is not null)  then N'Đã xác nhận'
      else N'' end as TRANGTHAIXACNHAN
      FROM TT_NUT_TONGHOPSUATAN_CHITIET THC
      INNER JOIN TT_NUT_TONGHOPSUATAN TH ON TH.TONGHOPSUATAN_ID = THC.TONGHOPSUATAN_ID
      INNER JOIN TT_NUT_CHIDINHKHAUPHAN_CHITIET CDC ON THC.CHIDINHKHAUPHANCHITIET_ID = CDC.CHIDINHKHAUPHANCHITIET_ID
      INNER JOIN TT_NUT_CHIDINHKHAUPHAN CD ON CD.CHIDINHKHAUPHAN_ID = CDC.CHIDINHKHAUPHAN_ID
      INNER JOIN TT_NOITRU_BENHAN BA ON CDC.BENHAN_ID = BA.BENHAN_ID
      INNER JOIN TT_BENHNHAN BN ON BA.BENHNHAN_ID = BN.BENHNHAN_ID
      INNER JOIN TM_NUT_BUOIAN B ON CDC.BUOIAN_ID = B.BUOIAN_ID
      INNER JOIN TM_NHANVIEN BS ON BS.NHANVIEN_ID = CDC.BACSI_ID
      INNER JOIN TM_NHANVIEN DD ON DD.NHANVIEN_ID = CDC.DIEUDUONG_ID
      INNER JOIN TM_PHONGBAN PB ON PB.PHONGBAN_ID = CD.PHONGBAN_ID
      LEFT JOIN TT_NUT_XACNHANSUATAN_CHITIET XNC ON XNC.TONGHOPSUATANCHITIET_ID = THC.TONGHOPSUATANCHITIET_ID
      inner JOIN TT_NOITRU_LUUTRU LT ON LT.BENHAN_ID = BA.BENHAN_ID AND lt.LUUTRU_ID = (select top 1 LUUTRU_ID from TT_NOITRU_LUUTRU where BENHAN_ID = BA.BENHAN_ID order by LUUTRU_ID desc)
      LEFT JOIN TT_NOITRU_LUUTRUCHITIET LTC ON LTC.LUUTRU_ID = LT.LUUTRU_ID  and LTC.LUUTRUCHITIET_CURRENT = '1'
      LEFT JOIN TM_PHONGBAN PB2 ON PB2.PHONGBAN_ID = CD.PHONGBENH_ID
      LEFT JOIN TM_GIUONGBENH GB ON GB.GIUONGBENH_ID = CD.GIUONGBENH_ID
      LEFT JOIN TM_NHANVIEN CN ON CN.NHANVIEN_ID = XNC.NGUOICAPNHAT_ID
      <dynamic prepend="where">
        <isParameterPresent>
          <isNotEmpty prepend="and" property="BENHVIEN_ID">
            THC.BENHVIEN_ID = '$BENHVIEN_ID$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="MACHUNGTU">
            TH.MATONGHOP = #MACHUNGTU#
          </isNotEmpty>
          <isNotEmpty prepend="and" property="MABENHAN">
            BA.SOBENHAN = '$MABENHAN$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="TRANGTHAI">
            (CASE WHEN XNC.HUY = 1 THEN 'HUY'
            WHEN  XNC.XACNHANSUATANCHITIET_ID is null THEN 'CHUAXACNHAN'
            WHEN (XNC.HUY = 0 and XNC.XACNHANSUATANCHITIET_ID is not null) THEN 'DAXACNHAN'
            END = '$TRANGTHAI$')
          </isNotEmpty>
          <isNotEmpty prepend="and" property="PHONGBAN_ID">
            CD.PHONGBAN_ID = '$PHONGBAN_ID$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="BUOIANS">
            CDC.BUOIAN_ID IN
            <iterate open="(" close=")" conjunction=",  " property="BUOIANS" >#BUOIANS[]#</iterate>
          </isNotEmpty>
          <isNotEmpty prepend="and" property="TUNGAY">
            CONVERT(date, THC.NGAYTONGHOP) BETWEEN CONVERT(date, '$TUNGAY$')  and  CONVERT(date, '$DENNGAY$')
          </isNotEmpty>
          <isNotEmpty prepend="and" property="BUOIAN_ID">
            CDC.BUOIAN_ID = '$BUOIAN_ID$'
          </isNotEmpty>
        </isParameterPresent>
      </dynamic>
    </statement>
    <statement id="DAO00101_CheckTongHopInKhoa" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      SELECT TOP 1 1  FROM TT_NUT_TONGHOPSUATAN TH
      INNER JOIN TM_NHANVIEN NV ON NV.NHANVIEN_ID = TH.NGUOITAO_ID
      WHERE TH.MATONGHOP = $MATONGHOP$
      AND NV.PHONGBAN_ID = $PHONGBAN_ID$
    </statement>
    <!-- CRUD table TT_NUT_XACNHANSUATAN_CHITIET -->
    <insert id="DAO00101_AddXacNhanDetail" parameterClass="System.Collections.IDictionary" resultClass="System.Int64">
      INSERT INTO TT_NUT_XACNHANSUATAN_CHITIET
      (TONGHOPSUATANCHITIET_ID
      ,CHIDINHKHAUPHANCHITIET_ID
      ,NGAYXACNHAN
      ,NGUOIXACNHAN_ID
      ,HUY
      ,LYDOHUY
      ,BENHVIEN_ID
      ,NGUOITAO_ID
      ,NGAYTAO
      ,NGUOICAPNHAT_ID
      ,NGAYCAPNHAT)
      VALUES
      (#TONGHOPSUATANCHITIET_ID#
      ,#CHIDINHKHAUPHANCHITIET_ID#
      ,#NGAYXACNHAN#
      ,#NGUOIXACNHAN_ID#
      ,#HUY#
      ,#LYDOHUY#
      ,#BENHVIEN_ID#
      ,#NGUOITAO_ID#
      ,#NGAYTAO#
      ,#NGUOICAPNHAT_ID#
      ,#NGAYCAPNHAT#)
      <!--SELECT SCOPE_IDENTITY()-->
      <selectKey resultClass="System.Int64" type="post" >
        SELECT @@IDENTITY as value
      </selectKey>
    </insert>
    <update id="DAO00101_UpdateXacNhanDetail" parameterClass="System.Collections.IDictionary">
      UPDATE TT_NUT_XACNHANSUATAN_CHITIET
      SET NGAYXACNHAN = #NGAYXACNHAN#
      ,NGUOIXACNHAN_ID = #NGUOIXACNHAN_ID#
      ,HUY = #HUY#
      ,LYDOHUY = #LYDOHUY#
      ,NGUOICAPNHAT_ID = #NGUOICAPNHAT_ID#
      ,NGAYCAPNHAT = #NGAYCAPNHAT#
      WHERE XACNHANSUATANCHITIET_ID = '$XACNHANSUATANCHITIET_ID$'
    </update>
    <delete id="DAO00101_DeleteXacNhanDetail" parameterClass="System.Collections.IDictionary" resultClass="System.Int32">
      DELETE FROM TT_NUT_TONGHOPSUATAN_CHITIET
      WHERE XACNHANSUATANCHITIET_ID = '$XACNHANSUATANCHITIET_ID$'
    </delete>
    <!-- End CRUD table TT_NUT_XACNHANSUATAN_CHITIET -->

    <!-- End : Xac nhan suat an -->

    <!-- Begin : Vien phi -->
    <statement id="DAO00101_GetVienPhiBySuatAn" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      SELECT *
      FROM TT_VIENPHI
      WHERE REF_ID = '$REF_ID$'
      AND REF_TABLE = '$REF_TABLE$'
      AND DATHANHTOAN = '0'
    </statement>

    <statement id="DAO00101_GetThongTinVienPhi" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      SELECT BA.TIEPNHAN_ID,BA.BENHAN_ID,BA.BENHNHAN_ID,BA.TRANGTHAI,CD.KHAUPHANAN_ID,DG.DONGIA,DG.LOAIGIA_ID,CD.TINHTIEN, tn.DOITUONG_ID,
      isnull((select top 1 SOBHYT_HUONG_ID from TT_TIEPNHAN_SOTHEBHYT where TIEPNHAN_ID = BA.TIEPNHAN_ID order by SOBHYT_HUONG_ID desc), 0) SOBHYT_HUONG_ID
      FROM TT_NOITRU_BENHAN BA
      INNER JOIN TT_NUT_CHIDINHKHAUPHAN_CHITIET CD ON CD.BENHAN_ID = BA.BENHAN_ID
      INNER JOIN TT_NUT_TONGHOPSUATAN_CHITIET TH ON TH.CHIDINHKHAUPHANCHITIET_ID = CD.CHIDINHKHAUPHANCHITIET_ID
      INNER JOIN TT_NUT_XACNHANSUATAN_CHITIET XN ON XN.TONGHOPSUATANCHITIET_ID = TH.TONGHOPSUATANCHITIET_ID
      INNER JOIN TM_NUT_KHAUPHANAN_DONGIA DG ON DG.KHAUPHANAN_ID = CD.KHAUPHANAN_ID
      Left join TT_TIEPNHAN tn on tn.TIEPNHAN_ID = BA.TIEPNHAN_ID
      WHERE XN.XACNHANSUATANCHITIET_ID = '$XACNHANSUATANCHITIET_ID$'
    </statement>

    <statement id="DAO00101_GetThongTinBenhAn" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      SELECT TRANGTHAI FROM TT_NOITRU_BENHAN WHERE BENHAN_ID = $BENHAN_ID$
    </statement>

    <insert id="DAO00101_AddVienPhi" parameterClass="System.Collections.IDictionary" resultClass="System.Int64">
      INSERT INTO TT_VIENPHI
      (TIEPNHAN_ID
      ,BENHAN_ID
      ,BENHNHAN_ID
      ,KHAMBENH_ID
      ,REF_ID
      ,REF_TABLE
      ,DICHVU_ID
      ,DUOC_ID
      ,LOAI_CHIPHI
      ,LOAIGIA_ID
      ,SOLUONG
      ,DONGIA_DOANHTHU
      ,THANHTIEN_DOANHTHU
      ,BHYT_TL
      ,BHYT_DONGIA
      ,BHYT_THANHTIEN
      ,BHYT_DONGIA_CHITRA
      ,BHYT_THANHTIEN_CHITRA
      ,BENHNHAN_PHAITHANHTOAN
      ,GIATRI_HOADON
      ,GIATRI_HOADON_DATHANHTOAN
      ,GIATRI_BIENLAI
      ,GIATRI_BIENLAI_DATHANHTOAN
      ,GIATRI_BENHNHAN_DATHANHTOAN
      ,GIATRI_THATTHU
      ,MIENGIAM_TL
      ,MIENGIAM_GIATRI
      ,NGANSACH_TL
      ,NGANSACH_GIATRI
      ,TAITRO_TL
      ,TAITRO_GIATRI
      ,BHTN_TL
      ,BHTN_DONGIA
      ,BHTN_THANHTIEN
      ,BHTN_DONGIA_CHITRA
      ,BHTN_THANHTIEN_CHITRA
      ,DUOCPHEPTHUCHIEN
      ,HUY
      ,DATHANHTOAN
      ,DATHUCHIEN
      ,KHONGTHUTIEN
      ,BHYTDONGTIEN
      ,HOADON_ID
      ,ACTIVE
      ,DUYET
      ,BENHVIEN_ID
      ,NGUOITAO_ID
      ,NGAYTAO
      ,NGUOICAPNHAT_ID
      ,NGAYCAPNHAT
      <isNotEmpty prepend="," property="DOITUONG_HUONG_ID">
        DOITUONG_HUONG_ID
      </isNotEmpty>
      <isNotEmpty prepend="," property="SOBHYT_HUONG_ID">
        SOBHYT_HUONG_ID
      </isNotEmpty>
      )
      VALUES
      (#TIEPNHAN_ID#
      ,#BENHAN_ID#
      ,#BENHNHAN_ID#
      ,#KHAMBENH_ID#
      ,#REF_ID#
      ,#REF_TABLE#
      ,#DICHVU_ID#
      ,#DUOC_ID#
      ,#LOAI_CHIPHI#
      ,#LOAIGIA_ID#
      ,#SOLUONG#
      ,#DONGIA_DOANHTHU#
      ,#THANHTIEN_DOANHTHU#
      ,#BHYT_TL#
      ,#BHYT_DONGIA#
      ,#BHYT_THANHTIEN#
      ,#BHYT_DONGIA_CHITRA#
      ,#BHYT_THANHTIEN_CHITRA#
      ,#BENHNHAN_PHAITHANHTOAN#
      ,#GIATRI_HOADON#
      ,#GIATRI_HOADON_DATHANHTOAN#
      ,#GIATRI_BIENLAI#
      ,#GIATRI_BIENLAI_DATHANHTOAN#
      ,#GIATRI_BENHNHAN_DATHANHTOAN#
      ,#GIATRI_THATTHU#
      ,#MIENGIAM_TL#
      ,#MIENGIAM_GIATRI#
      ,#NGANSACH_TL#
      ,#NGANSACH_GIATRI#
      ,#TAITRO_TL#
      ,#TAITRO_GIATRI#
      ,#BHTN_TL#
      ,#BHTN_DONGIA#
      ,#BHTN_THANHTIEN#
      ,#BHTN_DONGIA_CHITRA#
      ,#BHTN_THANHTIEN_CHITRA#
      ,#DUOCPHEPTHUCHIEN#
      ,#HUY#
      ,#DATHANHTOAN#
      ,#DATHUCHIEN#
      ,#KHONGTHUTIEN#
      ,#BHYTDONGTIEN#
      ,#HOADON_ID#
      ,#ACTIVE#
      ,#DUYET#
      ,#BENHVIEN_ID#
      ,#NGUOITAO_ID#
      ,#NGAYTAO#
      ,#NGUOICAPNHAT_ID#
      ,#NGAYCAPNHAT#
      <isNotEmpty prepend="," property="DOITUONG_HUONG_ID">
        #DOITUONG_HUONG_ID#
      </isNotEmpty>
      <isNotEmpty prepend="," property="SOBHYT_HUONG_ID">
        #SOBHYT_HUONG_ID#
      </isNotEmpty>
      )
      <!--SELECT SCOPE_IDENTITY()-->
      <selectKey resultClass="System.Int64" type="post" >
        SELECT @@IDENTITY as value
      </selectKey>
    </insert>

    <update id="DAO00101_UpdateVienPhi" parameterClass="System.Collections.IDictionary">
      UPDATE TT_VIENPHI SET
      TIEPNHAN_ID = #TIEPNHAN_ID#
      <!--, BENHAN_ID = #BENHAN_ID#-->
      , REF_ID = #REF_ID#
      , REF_TABLE = #REF_TABLE#
      , DICHVU_ID = #DICHVU_ID#
      , DUOC_ID = #DUOC_ID#
      , LOAI_CHIPHI = #LOAI_CHIPHI#
      , LOAIGIA_ID = #LOAIGIA_ID#
      , SOLUONG = #SOLUONG#
      , DONGIA_DOANHTHU = #DONGIA_DOANHTHU#
      , THANHTIEN_DOANHTHU = #THANHTIEN_DOANHTHU#
      , BHYT_TL = #BHYT_TL#
      , BHYT_DONGIA = #BHYT_DONGIA#
      , BHYT_THANHTIEN = #BHYT_THANHTIEN#
      , BHYT_DONGIA_CHITRA = #BHYT_DONGIA_CHITRA#
      , BHYT_THANHTIEN_CHITRA = #BHYT_THANHTIEN_CHITRA#
      , BENHNHAN_PHAITHANHTOAN = #BENHNHAN_PHAITHANHTOAN#
      , GIATRI_HOADON = #GIATRI_HOADON#
      , GIATRI_HOADON_DATHANHTOAN = #GIATRI_HOADON_DATHANHTOAN#
      , GIATRI_BIENLAI = #GIATRI_BIENLAI#
      , GIATRI_BIENLAI_DATHANHTOAN = #GIATRI_BIENLAI_DATHANHTOAN#
      , GIATRI_BENHNHAN_DATHANHTOAN = #GIATRI_BENHNHAN_DATHANHTOAN#
      , GIATRI_THATTHU = #GIATRI_THATTHU#
      , MIENGIAM_TL = #MIENGIAM_TL#
      , MIENGIAM_GIATRI = #MIENGIAM_GIATRI#
      , NGANSACH_TL = #NGANSACH_TL#
      , NGANSACH_GIATRI = #NGANSACH_GIATRI#
      , TAITRO_TL = #TAITRO_TL#
      , TAITRO_GIATRI = #TAITRO_GIATRI#
      , BHTN_TL = #BHTN_TL#
      , BHTN_DONGIA = #BHTN_DONGIA#
      , BHTN_THANHTIEN = #BHTN_THANHTIEN#
      , BHTN_DONGIA_CHITRA = #BHTN_DONGIA_CHITRA#
      , BHTN_THANHTIEN_CHITRA = #BHTN_THANHTIEN_CHITRA#
      , DUOCPHEPTHUCHIEN = #DUOCPHEPTHUCHIEN#
      , HUY = #HUY#
      , DATHANHTOAN = #DATHANHTOAN#
      , DATHUCHIEN = #DATHUCHIEN#
      , KHONGTHUTIEN = #KHONGTHUTIEN#
      , HOADON_ID = #HOADON_ID#
      , ACTIVE = #ACTIVE#
      , NGUOICAPNHAT_ID = #NGUOICAPNHAT_ID#
      , NGAYCAPNHAT = #NGAYCAPNHAT#
      WHERE
      VIENPHI_ID = '$VIENPHI_ID$'
    </update>
    <!-- End : Vien phi -->

    <!-- Begin : Gia -->
    <!-- Begin : Base Gia -->
    <statement id="DAO00101_BANGGIA_CPH_Add" parameterClass="System.Collections.IDictionary" resultClass="System.Int64">
      insert into TM_BANGGIA_CPH (
      LOAIBANGGIA
      , LOAIGIA_ID
      , TIENTE_ID
      , NGAYBANHANH
      , NGAYHIEULUC
      , NGAYHETHIEULUC
      , TRANGTHAI
      , TAMNGUNG
      , NGUOITAO_ID
      , NGAYTAO
      , NGUOICAPNHAT_ID
      , NGAYCAPNHAT
      , BENHVIEN_ID
      ) values (
      #LOAIBANGGIA#
      , #LOAIGIA_ID#
      , #TIENTE_ID#
      , #NGAYBANHANH#
      , #NGAYHIEULUC#
      , #NGAYHETHIEULUC#
      , #TRANGTHAI#
      , #TAMNGUNG#
      , #NGUOITAO_ID#
      , #NGAYTAO#
      , #NGUOICAPNHAT_ID#
      , #NGAYCAPNHAT#
      , #BENHVIEN_ID#
      )
      SELECT SCOPE_IDENTITY()
    </statement>
    <update id="DAO00101_BANGGIA_CPH_Update" parameterClass="System.Collections.IDictionary">
      update TM_BANGGIA_CPH set
      LOAIBANGGIA = #LOAIBANGGIA#
      , LOAIGIA_ID = #LOAIGIA_ID#
      , TIENTE_ID = #TIENTE_ID#
      , NGAYBANHANH = #NGAYBANHANH#
      , NGAYHIEULUC = #NGAYHIEULUC#
      , NGAYHETHIEULUC = #NGAYHETHIEULUC#
      , TRANGTHAI = #TRANGTHAI#
      , TAMNGUNG = #TAMNGUNG#
      , NGUOICAPNHAT_ID = #NGUOICAPNHAT_ID#
      , NGAYCAPNHAT = #NGAYCAPNHAT#
      , BENHVIEN_ID = #BENHVIEN_ID#
      where
      BANGGIA_CPH_ID = '$BANGGIA_CPH_ID$'
    </update>
    <statement id="DAO00101_BANGGIA_CPH_Delete" parameterClass="System.Collections.IDictionary" resultClass="System.Int32">
      delete from TM_BANGGIA_CPH
      where
      BANGGIA_CPH_ID = '$BANGGIA_CPH_ID$'
    </statement>
    <insert id="DAO00101_BANGGIA_Add" parameterClass="System.Collections.IDictionary" resultClass="System.Int64">
      insert into TM_BANGGIA (
      BANGGIA_ID
      , LOAIBANGGIA
      , LOAIGIA_ID
      , TIENTE_ID
      , NGAYBANHANH
      , NGAYHIEULUC
      , NGAYHETHIEULUC
      , TRANGTHAI
      , TAMNGUNG
      , NGUOITAO_ID
      , NGAYTAO
      , NGUOICAPNHAT_ID
      , NGAYCAPNHAT
      , BENHVIEN_ID
      ) values (
      #BANGGIA_ID#
      , #LOAIBANGGIA#
      , #LOAIGIA_ID#
      , #TIENTE_ID#
      , #NGAYBANHANH#
      , #NGAYHIEULUC#
      , #NGAYHETHIEULUC#
      , #TRANGTHAI#
      , #TAMNGUNG#
      , #NGUOITAO_ID#
      , #NGAYTAO#
      , #NGUOICAPNHAT_ID#
      , #NGAYCAPNHAT#
      , #BENHVIEN_ID#
      )
      <selectKey resultClass="System.Int64" type="post" >
        SELECT $BANGGIA_ID$ as value
      </selectKey>
    </insert>
    <statement id="DAO00101_BANGGIA_Delete" parameterClass="System.Collections.IDictionary" resultClass="System.Int32">
      delete from TM_BANGGIA
      where
      BANGGIA_ID = '$BANGGIA_ID$'
    </statement>
    <statement id="DAO00101_BANGGIA_GetDetail" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      SELECT B.*
      FROM TM_BANGGIA AS B
      WHERE B.BENHVIEN_ID = '$BENHVIEN_ID$' AND B.TAMNGUNG = '0' AND B.LOAIGIA_ID = '$LOAIGIA_ID$'
    </statement>
    <statement id="DAO00101_BANGGIA_HIS_GetDetail" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      SELECT B.*
      FROM TM_BANGGIA_HIS AS B
      WHERE B.BENHVIEN_ID = '$BENHVIEN_ID$' AND B.TAMNGUNG = '0' AND B.BANGGIA_ID = '$BANGGIA_ID$' AND B.LOAIGIA_ID = '$LOAIGIA_ID$'
    </statement>
    <statement id="DAO00101_BANGGIA_CPH_GetDetail" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      SELECT B.*
      FROM TM_BANGGIA_CPH AS B
      WHERE B.BENHVIEN_ID = '$BENHVIEN_ID$' AND B.TAMNGUNG = '0' AND B.LOAIGIA_ID = '$LOAIGIA_ID$'
    </statement>
    <insert id="DAO00101_BANGGIA_HIS_Add" parameterClass="System.Collections.IDictionary" resultClass="System.Int64">
      insert into TM_BANGGIA_HIS (
      BANGGIA_ID
      , LOAIBANGGIA
      , LOAIGIA_ID
      , TIENTE_ID
      , NGAYBANHANH
      , NGAYHIEULUC
      , NGAYHETHIEULUC
      , TRANGTHAI
      , TAMNGUNG
      , NGUOITAO_ID
      , NGAYTAO
      , NGUOICAPNHAT_ID
      , NGAYCAPNHAT
      , BENHVIEN_ID
      ) values (
      #BANGGIA_ID#
      , #LOAIBANGGIA#
      , #LOAIGIA_ID#
      , #TIENTE_ID#
      , #NGAYBANHANH#
      , #NGAYHIEULUC#
      , #NGAYHETHIEULUC#
      , #TRANGTHAI#
      , #TAMNGUNG#
      , #NGUOITAO_ID#
      , #NGAYTAO#
      , #NGUOICAPNHAT_ID#
      , #NGAYCAPNHAT#
      , #BENHVIEN_ID#
      )
      <selectKey resultClass="System.Int64" type="post" >
        SELECT $BANGGIA_ID$ as value
      </selectKey>
    </insert>
    <!-- End : Base Gia -->
    <!-- Begin : NUT Gia -->
    <statement id="DAO00101_NUT10_BANGGIA_GetList" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      SELECT L.LOAIGIA_ID AS CATEGORY_ID
      ,L.MALOAIGIA AS CATEGORY_CODE
      ,L.TENLOAIGIA AS CATEGORY_NAME
      ,0 AS FOLDER_LEVEL
      ,0 AS PARENT_ID,
      '1' AS IS_FOLDER
      ,'0' AS IS_CHUAPHATHANH
      ,L.LOAIGIA_ID
      ,0 AS TYPE
      ,0 AS BANGGIA_ID
      FROM TM_LOAIGIA AS L
      INNER JOIN TM_LOAIGIA AS L2 ON L2.LOAIGIA_ID = L.CAPTREN_ID AND L2.MALOAIGIA = 'GiaKhauPhanAn'
      WHERE L.TAMNGUNG = '0' AND L.BENHVIEN_ID = '$BENHVIEN_ID$'
      UNION ALL
      SELECT (L.LOAIGIA_ID + $IDENTIFY$) AS CATEGORY_ID
      ,CONVERT(VARCHAR(10),L.LOAIGIA_ID) + '_GiaHienHanh' AS CATEGORY_CODE
      ,N'Giá hiện hành' AS CATEGORY_NAME
      ,1 AS FOLDER_LEVEL
      ,L.LOAIGIA_ID AS PARENT_ID
      ,'0' AS IS_FOLDER
      ,'0' AS IS_CHUAPHATHANH
      ,L.LOAIGIA_ID
      ,1 AS TYPE
      ,0 AS BANGGIA_ID
      FROM TM_LOAIGIA AS L
      INNER JOIN TM_LOAIGIA AS L2 ON L2.LOAIGIA_ID = L.CAPTREN_ID AND L2.MALOAIGIA = 'GiaKhauPhanAn'
      WHERE L.TAMNGUNG = '0' AND L.BENHVIEN_ID = '$BENHVIEN_ID$'
      UNION ALL
      SELECT (L.LOAIGIA_ID + 2*$IDENTIFY$) AS CATEGORY_ID
      ,CONVERT(VARCHAR(10),L.LOAIGIA_ID) + '_GiaChuaPhatHanh' AS CATEGORY_CODE
      ,N'Giá chưa phát hành' AS CATEGORY_NAME
      ,1 AS FOLDER_LEVEL
      ,L.LOAIGIA_ID AS PARENT_ID
      ,'0' AS IS_FOLDER
      ,'1' AS IS_CHUAPHATHANH
      ,L.LOAIGIA_ID
      ,2 AS TYPE
      ,0 AS BANGGIA_ID
      FROM TM_LOAIGIA AS L
      INNER JOIN TM_LOAIGIA AS L2 ON L2.LOAIGIA_ID = L.CAPTREN_ID AND L2.MALOAIGIA = 'GiaKhauPhanAn'
      WHERE L.TAMNGUNG = '0' AND L.BENHVIEN_ID = '$BENHVIEN_ID$'
      UNION ALL
      SELECT  (L.LOAIGIA_ID + B.BANGGIA_ID + 3*$IDENTIFY$) AS CATEGORY_ID
      ,CONVERT(NVARCHAR(10),B.NGAYHETHIEULUC,103) + '_GiaCu' AS CATEGORY_CODE
      ,N'Bảng giá cũ (' + CONVERT(VARCHAR(10),B.NGAYHETHIEULUC,103) + ')' AS CATEGORY_NAME
      ,1 AS FOLDER_LEVEL
      ,L.LOAIGIA_ID AS PARENT_ID
      ,'0' AS IS_FOLDER
      ,'0' AS IS_CHUAPHATHANH
      ,L.LOAIGIA_ID
      ,3 AS TYPE, B.BANGGIA_ID
      FROM TM_LOAIGIA AS L
      INNER JOIN TM_LOAIGIA AS L2 ON L2.LOAIGIA_ID = L.CAPTREN_ID AND L2.MALOAIGIA = 'GiaKhauPhanAn'
      INNER JOIN TM_BANGGIA_HIS AS B ON B.LOAIGIA_ID = L.LOAIGIA_ID AND B.TAMNGUNG = '0' AND B.BENHVIEN_ID = '$BENHVIEN_ID$'
      WHERE L.TAMNGUNG = '0' AND L.BENHVIEN_ID = '$BENHVIEN_ID$'
    </statement>
    <statement id="DAO00101_NUT10_DONGIA_GetList" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      SELECT KP.KHAUPHANAN_ID
      ,KP.TENKHAUPHANAN
      ,LKP.TENLOAIKHAUPHANAN
      ,DG.DONGIA
      ,DG.TYLEVAT
      ,DG.GIATRIVAT
      ,DG.NGAYCAPNHAT
      ,NV.TENNHANVIEN AS NGUOICAPNHAT
      FROM TM_NUT_KHAUPHANAN KP
      INNER JOIN TM_NUT_LOAIKHAUPHANAN LKP ON LKP.LOAIKHAUPHANAN_ID = KP.LOAIKHAUPHANAN_ID
      LEFT JOIN TM_NUT_KHAUPHANAN_DONGIA DG ON DG.KHAUPHANAN_ID = KP.KHAUPHANAN_ID AND DG.LOAIGIA_ID = '$LOAIGIA_ID$'
      LEFT JOIN TM_NHANVIEN AS NV ON NV.NHANVIEN_ID = DG.NGUOICAPNHAT_ID
      INNER JOIN TM_LOAIGIA AS LG ON LG.LOAIGIA_ID = '$LOAIGIA_ID$' AND LG.BENHVIEN_ID = '$BENHVIEN_ID$'
      INNER JOIN LST_DICTIONARY AS DIC ON DIC.DICTIONARY_ID = LG.NHOMGIA_ID AND DIC.DICTIONARY_TYPE_CODE = 'NhomGia' AND DIC.BENHVIEN_ID = '$BENHVIEN_ID$'
      WHERE KP.BENHVIEN_ID = '$BENHVIEN_ID$' AND KP.TAMNGUNG = '0'
    </statement>
    <statement id="DAO00101_NUT10_DONGIA_HIS_GetList" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      SELECT KP.KHAUPHANAN_ID
      ,KP.TENKHAUPHANAN
      ,LKP.TENLOAIKHAUPHANAN
      ,DG.DONGIA
      ,DG.TYLEVAT
      ,DG.GIATRIVAT
      ,DG.NGAYCAPNHAT
      ,NV.TENNHANVIEN AS NGUOICAPNHAT
      FROM TM_NUT_KHAUPHANAN KP
      INNER JOIN TM_NUT_LOAIKHAUPHANAN LKP ON LKP.LOAIKHAUPHANAN_ID = KP.LOAIKHAUPHANAN_ID
      LEFT JOIN TM_NUT_KHAUPHANAN_DONGIA_HIS DG ON DG.KHAUPHANAN_ID = KP.KHAUPHANAN_ID AND DG.LOAIGIA_ID = '$LOAIGIA_ID$' AND DG.BANGGIA_ID = '$BANGGIA_ID$'
      LEFT JOIN TM_NHANVIEN AS NV ON NV.NHANVIEN_ID = DG.NGUOICAPNHAT_ID
      INNER JOIN TM_LOAIGIA AS LG ON LG.LOAIGIA_ID = '$LOAIGIA_ID$' AND LG.BENHVIEN_ID = '$BENHVIEN_ID$'
      INNER JOIN LST_DICTIONARY AS DIC ON DIC.DICTIONARY_ID = LG.NHOMGIA_ID AND DIC.DICTIONARY_TYPE_CODE = 'NhomGia' AND DIC.BENHVIEN_ID = '$BENHVIEN_ID$'
      WHERE KP.BENHVIEN_ID = '$BENHVIEN_ID$' AND KP.TAMNGUNG = '0'
    </statement>
    <statement id="DAO00101_NUT10_DONGIA_CPH_GetList" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      SELECT KP.KHAUPHANAN_ID
      ,KP.TENKHAUPHANAN
      ,LKP.TENLOAIKHAUPHANAN
      ,DG.DONGIA
      ,DG.TYLEVAT
      ,DG.GIATRIVAT
      ,DG.NGAYCAPNHAT
      ,NV.TENNHANVIEN AS NGUOICAPNHAT
      ,DG2.DONGIA AS DONGIAHIENTAI
      ,(ISNULL(DG.DONGIA,0) - ISNULL(DG2.DONGIA,0)) AS CHENHLECH
      ,DG.BANGGIA_CPH_ID
      FROM TM_NUT_KHAUPHANAN KP
      INNER JOIN TM_NUT_LOAIKHAUPHANAN LKP ON LKP.LOAIKHAUPHANAN_ID = KP.LOAIKHAUPHANAN_ID
      LEFT JOIN TM_NUT_KHAUPHANAN_DONGIA_CPH DG ON DG.KHAUPHANAN_ID = KP.KHAUPHANAN_ID AND DG.LOAIGIA_ID = '$LOAIGIA_ID$'
      LEFT JOIN TM_NUT_KHAUPHANAN_DONGIA DG2 ON DG2.KHAUPHANAN_ID = KP.KHAUPHANAN_ID AND DG2.LOAIGIA_ID = '$LOAIGIA_ID$'
      LEFT JOIN TM_NHANVIEN AS NV ON NV.NHANVIEN_ID = DG.NGUOICAPNHAT_ID
      INNER JOIN TM_LOAIGIA AS LG ON LG.LOAIGIA_ID = '$LOAIGIA_ID$' AND LG.BENHVIEN_ID = '$BENHVIEN_ID$'
      INNER JOIN LST_DICTIONARY AS DIC ON DIC.DICTIONARY_ID = LG.NHOMGIA_ID AND DIC.DICTIONARY_TYPE_CODE = 'NhomGia' AND DIC.BENHVIEN_ID = '$BENHVIEN_ID$'
      WHERE KP.BENHVIEN_ID = '$BENHVIEN_ID$' AND KP.TAMNGUNG = '0'
    </statement>
    <statement id="DAO00101_NUT10_DONGIA_CPH_GetCurrentList" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      SELECT DG.*
      FROM TM_NUT_KHAUPHANAN_DONGIA_CPH AS DG
      WHERE DG.BENHVIEN_ID = '$BENHVIEN_ID$' AND DG.TAMNGUNG = '0' AND DG.LOAIGIA_ID = '$LOAIGIA_ID$'
    </statement>
    <statement id="DAO00101_NUT10_DONGIA_GetCurrentList" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      SELECT DG.*
      FROM TM_NUT_KHAUPHANAN_DONGIA AS DG
      WHERE DG.BENHVIEN_ID = '$BENHVIEN_ID$' AND DG.TAMNGUNG = '0' AND DG.LOAIGIA_ID = '$LOAIGIA_ID$'
    </statement>
    <statement id="DAO00101_NUT10_DONGIA_CPH_Add" parameterClass="System.Collections.IDictionary" resultClass="System.Int64">
      INSERT INTO TM_NUT_KHAUPHANAN_DONGIA_CPH
      (BANGGIA_CPH_ID
      ,KHAUPHANAN_ID
      ,LOAIGIA_ID
      ,TIENTE_ID
      ,DONGIA
      ,TYLEVAT
      ,GIATRIVAT
      ,TRANGTHAI
      ,TAMNGUNG
      ,NGAYTAO
      ,NGUOITAO_ID
      ,NGAYCAPNHAT
      ,NGUOICAPNHAT_ID
      ,BENHVIEN_ID)
      VALUES
      (#BANGGIA_CPH_ID#
      ,#KHAUPHANAN_ID#
      ,#LOAIGIA_ID#
      ,#TIENTE_ID#
      ,#DONGIA#
      ,#TYLEVAT#
      ,#GIATRIVAT#
      ,#TRANGTHAI#
      ,#TAMNGUNG#
      ,#NGAYTAO#
      ,#NGUOITAO_ID#
      ,#NGAYCAPNHAT#
      ,#NGUOICAPNHAT_ID#
      ,#BENHVIEN_ID#)
      SELECT SCOPE_IDENTITY()
    </statement>
    <update id="DAO00101_NUT10_DONGIA_CPH_Update" parameterClass="System.Collections.IDictionary">
      UPDATE TM_NUT_KHAUPHANAN_DONGIA_CPH
      SET BANGGIA_CPH_ID = #BANGGIA_CPH_ID#
      ,KHAUPHANAN_ID = #KHAUPHANAN_ID#
      ,LOAIGIA_ID = #LOAIGIA_ID#
      ,TIENTE_ID = #TIENTE_ID#
      ,DONGIA = #DONGIA#
      ,TYLEVAT = #TYLEVAT#
      ,GIATRIVAT = #GIATRIVAT#
      ,TRANGTHAI = #TRANGTHAI#
      ,TAMNGUNG = #TAMNGUNG#
      ,NGAYTAO = #NGAYTAO#
      ,NGUOITAO_ID = #NGUOITAO_ID#
      ,NGAYCAPNHAT = #NGAYCAPNHAT#
      ,NGUOICAPNHAT_ID = #NGUOICAPNHAT_ID#
      ,BENHVIEN_ID = #BENHVIEN_ID#
      WHERE KHAUPHANAN_DONGIA_ID = '$KHAUPHANAN_DONGIA_ID$'
    </update>
    <statement id="DAO00101_NUT10_DONGIA_CPH_Delete" parameterClass="System.Collections.IDictionary" resultClass="System.Int32">
      DELETE FROM TM_NUT_KHAUPHANAN_DONGIA_CPH
      WHERE KHAUPHANAN_DONGIA_ID = '$KHAUPHANAN_DONGIA_ID$'
    </statement>
    <statement id="DAO00101_NUT10_DONGIA_Add" parameterClass="System.Collections.IDictionary" resultClass="System.Int64">
      INSERT INTO TM_NUT_KHAUPHANAN_DONGIA
      (BANGGIA_ID
      ,KHAUPHANAN_ID
      ,LOAIGIA_ID
      ,TIENTE_ID
      ,DONGIA
      ,TYLEVAT
      ,GIATRIVAT
      ,TRANGTHAI
      ,TAMNGUNG
      ,NGAYTAO
      ,NGUOITAO_ID
      ,NGAYCAPNHAT
      ,NGUOICAPNHAT_ID
      ,BENHVIEN_ID)
      VALUES
      (#BANGGIA_ID#
      ,#KHAUPHANAN_ID#
      ,#LOAIGIA_ID#
      ,#TIENTE_ID#
      ,#DONGIA#
      ,#TYLEVAT#
      ,#GIATRIVAT#
      ,#TRANGTHAI#
      ,#TAMNGUNG#
      ,#NGAYTAO#
      ,#NGUOITAO_ID#
      ,#NGAYCAPNHAT#
      ,#NGUOICAPNHAT_ID#
      ,#BENHVIEN_ID#)
      SELECT SCOPE_IDENTITY()
    </statement>
    <statement id="DAO00101_NUT10_DONGIA_Delete" parameterClass="System.Collections.IDictionary" resultClass="System.Int32">
      DELETE FROM TM_NUT_KHAUPHANAN_DONGIA
      WHERE KHAUPHANAN_DONGIA_ID = '$KHAUPHANAN_DONGIA_ID$'
    </statement>
    <statement id="DAO00101_NUT10_DONGIA_HIS_Add" parameterClass="System.Collections.IDictionary" resultClass="System.Int64">
      INSERT INTO TM_NUT_KHAUPHANAN_DONGIA_HIS
      (BANGGIA_ID
      ,KHAUPHANAN_ID
      ,LOAIGIA_ID
      ,TIENTE_ID
      ,DONGIA
      ,TYLEVAT
      ,GIATRIVAT
      ,TRANGTHAI
      ,TAMNGUNG
      ,NGAYTAO
      ,NGUOITAO_ID
      ,NGAYCAPNHAT
      ,NGUOICAPNHAT_ID
      ,BENHVIEN_ID)
      VALUES
      (#BANGGIA_ID#
      ,#KHAUPHANAN_ID#
      ,#LOAIGIA_ID#
      ,#TIENTE_ID#
      ,#DONGIA#
      ,#TYLEVAT#
      ,#GIATRIVAT#
      ,#TRANGTHAI#
      ,#TAMNGUNG#
      ,#NGAYTAO#
      ,#NGUOITAO_ID#
      ,#NGAYCAPNHAT#
      ,#NGUOICAPNHAT_ID#
      ,#BENHVIEN_ID#)
      SELECT SCOPE_IDENTITY()
    </statement>
    <statement id="DAO00101_NUT10_DOITUONG_GIA_Delete" parameterClass="System.Collections.IDictionary" resultClass="System.Int32">
      SELECT 1 WHERE 1=1
    </statement>
    <statement id="DAO00101_GetBuoiAnDaChiDinh" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select distinct BUOIAN_ID from TT_NUT_CHIDINHKHAUPHAN_CHITIET where BUOIAN_ID is not null and BENHVIEN_ID='$BENHVIEN_ID$'
    </statement>
    <statement id="DAO00101_GetBuoiAnByID" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select BUOIAN_ID
      , convert(varchar(10),TUGIO,108) TUGIO
      , convert(varchar(10),DENGIO,108) DENGIO
      , convert(varchar(10),GIOTONGHOP,108) GIOTONGHOP
      from TM_NUT_BUOIAN where BENHVIEN_ID = '$BENHVIEN_ID$'
    </statement>
    <!-- End : NUT Gia -->
    <!-- End   : Gia -->

    <statement id="DAO00101_GetTTXacNhanSuatAn" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select XACNHANSUATANCHITIET_ID, th.TONGHOPSUATANCHITIET_ID from TT_NUT_XACNHANSUATAN_CHITIET xn
      right join TT_NUT_TONGHOPSUATAN_CHITIET th on xn.TONGHOPSUATANCHITIET_ID = th.TONGHOPSUATANCHITIET_ID
      where th.TONGHOPSUATANCHITIET_ID in
      (select TONGHOPSUATANCHITIET_ID from TT_NUT_TONGHOPSUATAN_CHITIET where CHIDINHKHAUPHANCHITIET_ID in
      (select CHIDINHKHAUPHANCHITIET_ID from TT_NUT_CHIDINHKHAUPHAN_CHITIET where BENHAN_ID = '$BENHAN_ID$'))
    </statement>
    <statement id="DAO00101_GetTTXacNhanSuatAnPhongbanNoitru" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select XACNHANSUATANCHITIET_ID, th.TONGHOPSUATANCHITIET_ID,
      (select KHOACHUYENDEN_ID from TT_NOITRU_BENHAN where BENHAN_ID = '$BENHAN_ID$') PHONGBAN_ID
      from TT_NUT_XACNHANSUATAN_CHITIET xn
      right join TT_NUT_TONGHOPSUATAN_CHITIET th on xn.TONGHOPSUATANCHITIET_ID = th.TONGHOPSUATANCHITIET_ID
      where th.TONGHOPSUATANCHITIET_ID in        (select TONGHOPSUATANCHITIET_ID from TT_NUT_TONGHOPSUATAN_CHITIET where CHIDINHKHAUPHANCHITIET_ID in
      (select CHIDINHKHAUPHANCHITIET_ID from TT_NUT_CHIDINHKHAUPHAN_CHITIET where BENHAN_ID = '$BENHAN_ID$'))
    </statement>
    <statement id="DAO00101_GetFirstHangMucBuoiAn" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select TOP 1 DICTIONARY_CODE
      from LST_DICTIONARY
      where DICTIONARY_ID = '$HANGMUC_ID$' and BENHVIEN_ID='$BENHVIEN_ID$'
    </statement>
    <statement id="DAO00101_GetBenhAnRaVien" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select TOP 1 TRANGTHAI
      from TT_NOITRU_BENHAN
      where BENHAN_ID = '$BENHAN_ID$' and BENHVIEN_ID='$BENHVIEN_ID$'
    </statement>
    <statement id="DAO00101_GetTHAndXacNhan" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select XN.XACNHANSUATANCHITIET_ID, TH.TONGHOPSUATAN_ID, CT.TONGHOPSUATANCHITIET_ID
      from TT_NUT_TONGHOPSUATAN TH
      INNER JOIN TT_NUT_TONGHOPSUATAN_CHITIET CT ON CT.TONGHOPSUATAN_ID = TH.TONGHOPSUATAN_ID
      INNER JOIN TT_NUT_XACNHANSUATAN_CHITIET XN ON XN.TONGHOPSUATANCHITIET_ID = CT.TONGHOPSUATANCHITIET_ID
      where TH.MATONGHOP = '$MATONGHOP$' AND XN.HUY='0' and TH.BENHVIEN_ID='$BENHVIEN_ID$'
    </statement>
    <statement id="DAO00101_CheckExitsSuatAn" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select XN.XACNHANSUATANCHITIET_ID
      from TT_NUT_TONGHOPSUATAN TH
      INNER JOIN TT_NUT_TONGHOPSUATAN_CHITIET CT ON CT.TONGHOPSUATAN_ID = TH.TONGHOPSUATAN_ID
      INNER JOIN TT_NUT_XACNHANSUATAN_CHITIET XN ON XN.TONGHOPSUATANCHITIET_ID = CT.TONGHOPSUATANCHITIET_ID
      where TH.MATONGHOP = '$MATONGHOP$' and TH.BENHVIEN_ID='$BENHVIEN_ID$'
    </statement>
    <delete id="DAO00101_DeleteXacNhan" parameterClass="System.Collections.IDictionary" resultClass="System.Int32">
      DELETE FROM TT_NUT_XACNHANSUATAN_CHITIET
      WHERE TONGHOPSUATANCHITIET_ID = '$TongHopChiTietId$'
    </delete>
    <delete id="DAO00101_DeleteTongHopChiTiet" parameterClass="System.Collections.IDictionary" resultClass="System.Int32">
      DELETE FROM TT_NUT_TONGHOPSUATAN_CHITIET
      WHERE TONGHOPSUATANCHITIET_ID = '$TongHopChiTietId$'
    </delete>
    <delete id="DAO00101_DeleteTongHopSuatAn" parameterClass="System.Collections.IDictionary" resultClass="System.Int32">
      DELETE FROM TT_NUT_TONGHOPSUATAN
      WHERE MATONGHOP = '$MaTongHop$'
    </delete>
    <statement id="DAO00101_GetChiDinhAndTongHop" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select TONGHOPSUATANCHITIET_ID
      from TT_NUT_TONGHOPSUATAN_CHITIET th
      inner join TT_NUT_CHIDINHKHAUPHAN_CHITIET ct on ct.CHIDINHKHAUPHANCHITIET_ID = th.CHIDINHKHAUPHANCHITIET_ID
      where ct.CHIDINHKHAUPHAN_ID = '$ChiDinhSuatAnId$' and ct.CHIDINHKHAUPHANCHITIET_ID = '$ChiDinhSuatAnChiTietId$'
    </statement>
    <statement id="DAO00101_GetSuatAnDaChiDinh" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select distinct KHAUPHANAN_ID from TT_NUT_CHIDINHKHAUPHAN_CHITIET where BUOIAN_ID is not null and BENHVIEN_ID='$BENHVIEN_ID$'
    </statement>
    <statement id="DAO00101_NUT10_DONGIA_CPH_Add_byJson" parameterClass="System.Collections.IDictionary" resultClass="System.Int64">

      declare @jsonVienPhi nvarchar(max) = N'$JSON_DATA$';

      INSERT INTO TM_NUT_KHAUPHANAN_DONGIA_CPH
      SELECT *
      FROM OPENJSON(@jsonVienPhi)
      WITH (
      BANGGIA_CPH_ID int,
      KHAUPHANAN_ID int,
      LOAIGIA_ID int,
      TIENTE_ID nchar(3),
      DONGIA numeric(25, 4),
      TYLEVAT numeric(25, 4),
      GIATRIVAT numeric(25, 4),
      TRANGTHAI varchar(20),
      TAMNGUNG int,
      NGAYTAO datetime,
      NGUOITAO_ID int,
      NGAYCAPNHAT datetime,
      NGUOICAPNHAT_ID int,
      BENHVIEN_ID nvarchar(10))
    </statement>
    <statement id="DAO00101_NUT10_DONGIA_Add_byJson" parameterClass="System.Collections.IDictionary" resultClass="System.Int64">
      declare @jsonVienPhi nvarchar(max) = N'$JSON_DATA$';

      INSERT INTO TM_NUT_KHAUPHANAN_DONGIA
      SELECT *
      FROM OPENJSON(@jsonVienPhi)
      WITH (
      BANGGIA_CPH_ID int,
      KHAUPHANAN_ID int,
      LOAIGIA_ID int,
      TIENTE_ID nchar(3),
      DONGIA numeric(25, 4),
      TYLEVAT numeric(25, 4),
      GIATRIVAT numeric(25, 4),
      TRANGTHAI varchar(20),
      TAMNGUNG int,
      NGAYTAO datetime,
      NGUOITAO_ID int,
      NGAYCAPNHAT datetime,
      NGUOICAPNHAT_ID int,
      BENHVIEN_ID nvarchar(10))

      DELETE FROM TM_NUT_KHAUPHANAN_DONGIA_CPH where KHAUPHANAN_DONGIA_ID IN (SELECT KHAUPHANAN_DONGIA_ID
      FROM OPENJSON(@jsonVienPhi)
      WITH (KHAUPHANAN_DONGIA_ID int))

      delete from TM_BANGGIA_CPH where  BANGGIA_CPH_ID = '$BANGGIA_CPH_ID$'
    </statement>
    <statement id="DAO00101_NUT10_DONGIA_HIS_Add_byJson" parameterClass="System.Collections.IDictionary" resultClass="System.Int64">
      declare @jsonVienPhi nvarchar(max) = N'$JSON_DATA$';

      INSERT INTO TM_NUT_KHAUPHANAN_DONGIA_HIS
      SELECT *
      FROM OPENJSON(@jsonVienPhi)
      WITH (
      BANGGIA_ID int,
      KHAUPHANAN_ID int,
      LOAIGIA_ID int,
      TIENTE_ID nchar(3),
      DONGIA numeric(25, 4),
      TYLEVAT numeric(25, 4),
      GIATRIVAT numeric(25, 4),
      TRANGTHAI varchar(20),
      TAMNGUNG int,
      NGAYTAO datetime,
      NGUOITAO_ID int,
      NGAYCAPNHAT datetime,
      NGUOICAPNHAT_ID int,
      BENHVIEN_ID nvarchar(10))

      DELETE FROM TM_NUT_KHAUPHANAN_DONGIA where KHAUPHANAN_DONGIA_ID IN (SELECT KHAUPHANAN_DONGIA_ID
      FROM OPENJSON(@jsonVienPhi)
      WITH (KHAUPHANAN_DONGIA_ID int))
    </statement>
    <statement id="DAO00101_GetVienPhiDinhDuong" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select top 1 * from TT_VIENPHI where REF_ID = '$REF_ID$' and REF_TABLE = '$REF_TABLE$'
      and ACTIVE = '1' and HUY = '0' and KHONGTHUTIEN = '0'
    </statement>
    <statement id="DAO00101_DeleteBuoiAn" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      delete TM_NUT_BUOIAN where BUOIAN_ID = '$BUOIAN_ID$'
    </statement>
    <statement id="DAO00101_GetTHXacNhan" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select XN.XACNHANSUATANCHITIET_ID, TH.TONGHOPSUATAN_ID, CT.TONGHOPSUATANCHITIET_ID
      from TT_NUT_TONGHOPSUATAN TH
      INNER JOIN TT_NUT_TONGHOPSUATAN_CHITIET CT ON CT.TONGHOPSUATAN_ID = TH.TONGHOPSUATAN_ID
      INNER JOIN TT_NUT_XACNHANSUATAN_CHITIET XN ON XN.TONGHOPSUATANCHITIET_ID = CT.TONGHOPSUATANCHITIET_ID
      where CT.TONGHOPSUATANCHITIET_ID = '$TONGHOPSUATANCHITIET_ID$' AND XN.HUY='0' and TH.BENHVIEN_ID='$BENHVIEN_ID$'
    </statement>
    <statement id="DAO00101_GetListSuatAn" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      SELECT
      kP.KHAUPHANAN_ID,
      kP.MAKHAUPHANAN,
      kP.TENKHAUPHANAN,
      LKP.LOAIKHAUPHANAN_ID,
      LKP.MALOAIKHAUPHANAN,
      LKP.TENLOAIKHAUPHANAN,
      DG.DONGIA,
      kP.HANGMUC_ID
      FROM TM_NUT_KHAUPHANAN kP
      INNER JOIN TM_NUT_LOAIKHAUPHANAN LKP ON  kP.LOAIKHAUPHANAN_ID = LKP.LOAIKHAUPHANAN_ID
      INNER JOIN TM_NUT_KHAUPHANAN_DONGIA DG ON DG.KHAUPHANAN_ID = kP.KHAUPHANAN_ID
      WHERE DG.DONGIA IS NOT NULL
    </statement>
  </statements>
</sqlMap>
