<?xml version="1.0" encoding="utf-8" ?>
<!--============================================================================
//	CAUTION: This file is generated by IBatisNetGen.3.SQLMap.cst at 10/3/2016 10:12:54 AM
//				Any manual editing will be lost in re-generation.
//===========================================================================-->
<sqlMap namespace="eHospital" xmlns="http://ibatis.apache.org/mapping" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
  <statements>
    <statement id="DAO00115_GetStaffByDepartmentId" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      WITH Relation (CAPTREN_ID, PHONGBAN_ID)
      AS
      (
        SELECT pb.CAPTREN_ID, pb.PHONGBAN_ID
        FROM TM_PHONGBAN AS pb
        WHERE (pb.TAMNGUNG = '0' OR pb.TAMNGUNG IS NULL)
          AND pb.PHONGBAN_ID = '$PHONGBAN_ID$'
          AND  pb.BENHVIEN_ID = '$BENHVIEN_ID$'
        UNION ALL
        SELECT pb.CAPTREN_ID, pb.PHONGBAN_ID
        FROM TM_PHONGBAN AS pb
        INNER JOIN Relation AS r ON pb.CAPTREN_ID = r.PHONGBAN_ID
        WHERE (pb.TAMNGUNG = '0' OR pb.TAMNGUNG IS NULL)
          AND pb.BENHVIEN_ID = '$BENHVIEN_ID$'
      )
      SELECT nv.* FROM TM_NHANVIEN nv
      LEFT JOIN LST_DICTIONARY ls ON ls.DICTIONARY_ID = nv.CHUCVU_ID
      WHERE ls.DICTIONARY_TYPE_CODE = 'ChucVu' AND ls.DICTIONARY_CODE = 'BS'
        AND nv.PHONGBAN_ID IN (SELECT PHONGBAN_ID FROM  Relation)
        AND (nv.TAMNGUNG = '0' OR nv.TAMNGUNG IS NULL)
        AND nv.BENHVIEN_ID = '$BENHVIEN_ID$'
    </statement>
    <statement id="DAO00115_GetStaff" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      WITH Relation (CAPTREN_ID, PHONGBAN_ID)
      AS
      (
        SELECT pb.CAPTREN_ID, pb.PHONGBAN_ID
        FROM TM_PHONGBAN AS pb
        WHERE ISNULL(pb.CAPTREN_ID ,0)=0
          AND (pb.TAMNGUNG = '0' OR pb.TAMNGUNG IS NULL)
          AND  pb.BENHVIEN_ID = '$BENHVIEN_ID$'
        UNION ALL
        SELECT pb.CAPTREN_ID, pb.PHONGBAN_ID
        FROM TM_PHONGBAN AS pb
        INNER JOIN Relation AS r ON pb.CAPTREN_ID = r.PHONGBAN_ID
        WHERE (pb.TAMNGUNG = '0' OR pb.TAMNGUNG IS NULL)
          AND pb.BENHVIEN_ID = '$BENHVIEN_ID$'
      )
      SELECT nv.* FROM TM_NHANVIEN nv
      LEFT JOIN LST_DICTIONARY ls ON ls.DICTIONARY_ID = nv.CHUCVU_ID
      WHERE ls.DICTIONARY_TYPE_CODE = 'ChucVu' AND ls.DICTIONARY_CODE = 'BS'
        AND nv.PHONGBAN_ID IN (SELECT PHONGBAN_ID FROM  Relation)
        AND (nv.TAMNGUNG = '0' OR nv.TAMNGUNG IS NULL)
        AND nv.BENHVIEN_ID = '$BENHVIEN_ID$'
    </statement>
    
    <statement id="DAO00115_GetAppointments" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      SELECT xl.*,
        nv.PHONGBAN_ID as PHONGBANID_OF_NHANVIEN,
        nv.TENNHANVIEN,
        pb.TENPHONGBAN,
        pb.MAPHONGBAN,
        nt.TENNHANVIEN as NGUOITAO,
        ncn.TENNHANVIEN as NGUOICAPNHAT,
        ll.DICTIONARY_NAME as TENLOAILICH,
        ll.DICTIONARY_CODE as MALOAILICH
      FROM TT_XEPLICH xl
      LEFT JOIN TM_NHANVIEN nv ON nv.NHANVIEN_ID = xl.NHANVIEN_ID
      LEFT JOIN TM_PHONGBAN pb ON pb.PHONGBAN_ID = xl.PHONGBAN_ID
      LEFT JOIN LST_DICTIONARY ll ON ll.DICTIONARY_ID = xl.LOAILICH_ID
      LEFT JOIN TM_NHANVIEN nt ON nt.NHANVIEN_ID = xl.NGUOITAO_ID
      LEFT JOIN TM_NHANVIEN ncn ON ncn.NHANVIEN_ID = xl.NGUOICAPNHAT_ID
      <dynamic prepend="where">
        <isParameterPresent>
          <isNotEmpty prepend="and" property="XEPLICH_ID">
            xl.XEPLICH_ID = '$XEPLICH_ID$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="TUNGAY">
            <isNotEmpty property="DENNGAY">
              ((xl.THOIGIAN_BATDAU BETWEEN CONVERT(datetime, '$TUNGAY$') and CONVERT(datetime, '$DENNGAY$'))
              OR
              (xl.THOIGIAN_KETTHUC BETWEEN CONVERT(datetime, '$TUNGAY$') and CONVERT(datetime, '$DENNGAY$'))
              OR
              (CONVERT(datetime, '$TUNGAY$') BETWEEN xl.THOIGIAN_BATDAU and xl.THOIGIAN_KETTHUC))
            </isNotEmpty>
          </isNotEmpty>
          <isNotEmpty prepend="and" property="TUGIO">
            <isNotEmpty property="DENGIO">
              ((CONVERT(date,xl.THOIGIAN_BATDAU) BETWEEN CONVERT(date, '$TUGIO$') and CONVERT(date, '$DENGIO$')) OR
              (CONVERT(date,xl.THOIGIAN_KETTHUC) BETWEEN CONVERT(date, '$TUGIO$') and CONVERT(date, '$DENGIO$')))
              AND
              ((CONVERT(time,xl.THOIGIAN_BATDAU) BETWEEN CONVERT(time, '$TUGIO$') and CONVERT(time, '$DENGIO$')) OR
              (CONVERT(time,xl.THOIGIAN_KETTHUC) BETWEEN CONVERT(time, '$TUGIO$') and CONVERT(time, '$DENGIO$')))
            </isNotEmpty>
          </isNotEmpty>
          <isNotEmpty prepend="and" property="NHANVIENIDS">
            xl.NHANVIEN_ID IN
            <iterate open="(" close=")" conjunction=",  " property="NHANVIENIDS" >#NHANVIENIDS[]#</iterate>
          </isNotEmpty>
          <isNotEmpty prepend="and" property="PHONGBAN_ID">
            xl.PHONGBAN_ID = '$PHONGBAN_ID$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="NHANVIEN_PHONGBAN_ID">
            xl.NHANVIEN_ID IN (SELECT NHANVIEN_ID FROM TM_NHANVIEN WHERE PHONGBAN_ID = '$NHANVIEN_PHONGBAN_ID$')
          </isNotEmpty>
          <isNotEmpty prepend="and" property="LOAILICH_ID">
            xl.LOAILICH_ID = '$LOAILICH_ID$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="BENHVIEN_ID">
            xl.BENHVIEN_ID = '$BENHVIEN_ID$'
          </isNotEmpty>
        </isParameterPresent>
      </dynamic>
      Order by xl.THOIGIAN_BATDAU
    </statement>
    <statement id="DAO00115_GetDanhSachLichHenCuaBacSiTrongNgay" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      SELECT lichhen_id FROM TT_LICHHEN WHERE BACSI_ID ='$BACSI_ID$' AND BENHVIEN_ID='$BENHVIEN_ID$'
      AND CONVERT(DATE,THOIGIANHEN_KETTHUC)= CONVERT(DATE,'$DENNGAY$') AND CONVERT(TIME,THOIGIANHEN_KETTHUC)> CONVERT(TIME,'$DENNGAY$')
    </statement>
    <statement id="DAO00115_GetWorkingAppointments" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      SELECT xl.*,
      nv.PHONGBAN_ID as PHONGBANID_OF_NHANVIEN,
      nv.TENNHANVIEN,
      pb.TENPHONGBAN,
      pb.MAPHONGBAN,
      nt.TENNHANVIEN as NGUOITAO,
      ncn.TENNHANVIEN as NGUOICAPNHAT,
      ll.DICTIONARY_NAME as TENLOAILICH,
      ll.DICTIONARY_CODE as MALOAILICH
      FROM TT_XEPLICH xl
      LEFT JOIN TM_NHANVIEN nv ON nv.NHANVIEN_ID = xl.NHANVIEN_ID
      LEFT JOIN TM_PHONGBAN pb ON pb.PHONGBAN_ID = xl.PHONGBAN_ID
      LEFT JOIN LST_DICTIONARY ll ON ll.DICTIONARY_ID = xl.LOAILICH_ID
      LEFT JOIN TM_NHANVIEN nt ON nt.NHANVIEN_ID = xl.NGUOITAO_ID
      LEFT JOIN TM_NHANVIEN ncn ON ncn.NHANVIEN_ID = xl.NGUOICAPNHAT_ID
      WHERE xl.LOAILICH_ID IS NOT NULL
      <isParameterPresent>
          <isNotEmpty prepend="and" property="XEPLICH_ID">
            xl.XEPLICH_ID = '$XEPLICH_ID$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="TUNGAY">
            <isNotEmpty property="DENNGAY">
              ((xl.THOIGIAN_BATDAU BETWEEN CONVERT(datetime, '$TUNGAY$') and CONVERT(datetime, '$DENNGAY$')) OR
              (xl.THOIGIAN_KETTHUC BETWEEN CONVERT(datetime, '$TUNGAY$') and CONVERT(datetime, '$DENNGAY$')))
            </isNotEmpty>
          </isNotEmpty>
          <isNotEmpty prepend="and" property="NHANVIENIDS">
            xl.NHANVIEN_ID IN
            <iterate open="(" close=")" conjunction=",  " property="NHANVIENIDS" >#NHANVIENIDS[]#</iterate>
          </isNotEmpty>
          <isNotEmpty prepend="and" property="PHONGBAN_ID">
            xl.PHONGBAN_ID = '$PHONGBAN_ID$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="NHANVIEN_PHONGBAN_ID">
            xl.NHANVIEN_ID IN (SELECT NHANVIEN_ID FROM TM_NHANVIEN WHERE PHONGBAN_ID = '$NHANVIEN_PHONGBAN_ID$')
          </isNotEmpty>
          <isNotEmpty prepend="and" property="LOAILICH_ID">
            xl.LOAILICH_ID = '$LOAILICH_ID$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="BENHVIEN_ID">
            xl.BENHVIEN_ID = '$BENHVIEN_ID$'
          </isNotEmpty>
      </isParameterPresent>
      Order by xl.THOIGIAN_BATDAU
    </statement>
    <statement id="DAO00115_GetDepartmentIdByStaff" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      SELECT PHONGBAN_ID
      FROM TM_NHANVIEN WHERE NHANVIEN_ID = '$NHANVIEN_ID$'
    </statement>

    <!-- CRUD table TT_XEPLICH_CHITIET --> 
    <insert id="DAO00115_AddAppointment" parameterClass="System.Collections.IDictionary" resultClass="System.Int64">
      INSERT INTO TT_XEPLICH
      (NHANVIEN_ID
      ,PHONGBAN_ID
      ,THOIGIAN_BATDAU
      ,THOIGIAN_KETTHUC
      ,LOAILICH_ID
      ,BENHVIEN_ID
      ,NGUOITAO_ID
      ,NGAYTAO
      ,NGUOICAPNHAT_ID
      ,NGAYCAPNHAT)
      VALUES
      (#NHANVIEN_ID#
      ,#PHONGBAN_ID#
      ,#THOIGIAN_BATDAU#
      ,#THOIGIAN_KETTHUC#
      ,#LOAILICH_ID#
      ,#BENHVIEN_ID#
      ,#NGUOITAO_ID#
      ,#NGAYTAO#
      ,#NGUOICAPNHAT_ID#
      ,#NGAYCAPNHAT#)
      <!--SELECT SCOPE_IDENTITY()-->
      <selectKey resultClass="System.Int64" type="post" >
        SELECT @@IDENTITY as value
      </selectKey>
    </insert>
    <update id="DAO00115_UpdateAppointment" parameterClass="System.Collections.IDictionary">
      UPDATE TT_XEPLICH
      SET NHANVIEN_ID = #NHANVIEN_ID#
      ,PHONGBAN_ID = #PHONGBAN_ID#
      ,THOIGIAN_BATDAU = #THOIGIAN_BATDAU#
      ,THOIGIAN_KETTHUC = #THOIGIAN_KETTHUC#
      ,LOAILICH_ID = #LOAILICH_ID#
      ,BENHVIEN_ID = #BENHVIEN_ID#
      ,NGUOITAO_ID = #NGUOITAO_ID#
      ,NGAYTAO = #NGAYTAO#
      ,NGUOICAPNHAT_ID = #NGUOICAPNHAT_ID#
      ,NGAYCAPNHAT = #NGAYCAPNHAT#
      WHERE XEPLICH_ID = #XEPLICH_ID#
    </update>
    <statement id="DAO00115_DeleteAppointment" parameterClass="System.Collections.IDictionary" resultClass="System.Int32">
      DELETE FROM TT_XEPLICH
      WHERE
      XEPLICH_ID = '$XEPLICH_ID$'
    </statement>

    <update id="DAO00115_CapNhatTrangThaiTiepNhanCuaLichHen" parameterClass="System.Collections.IDictionary">
      UPDATE TT_LICHHEN SET TIEPNHAN_ID='$TIEPNHAN_ID$',NGUOICAPNHAT_ID = '$NGUOICAPNHAT_ID$', NGAYCAPNHAT = '$NGAYCAPNHAT$',DATIEPNHAN='$DATIEPNHAN$'
      WHERE LICHHEN_ID='$LICHHEN_ID$' AND BENHVIEN_ID='$BENHVIEN_ID$'
    </update>
  </statements>
</sqlMap>
