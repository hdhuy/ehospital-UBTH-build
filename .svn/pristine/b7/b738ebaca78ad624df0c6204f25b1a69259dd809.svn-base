<?xml version="1.0" encoding="utf-8" ?>
<sqlMap namespace="eHospital" xmlns="http://ibatis.apache.org/mapping" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
  <statements>
    <statement id="DAO00310_GetAll" resultClass="DataObject">
      select *
      from TM_PHACDO
      <dynamic prepend="where">
        <isParameterPresent>
          <isNotEmpty prepend="and" property="MAPHACDO">
            MAPHACDO = '$MAPHACDO$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="BENHVIEN_ID">
            BENHVIEN_ID = '$BENHVIEN_ID$'
          </isNotEmpty>
        </isParameterPresent>
      </dynamic>
      order by PHACDO_ID
    </statement>
    <statement id="DAO00310_GetAllWithID" resultClass="DataObject">
      select *
      from TM_PHACDO
      where PHACDO_ID = '$PHACDO_ID$'
      <isNotEmpty prepend="and" property="BENHVIEN_ID">
        BENHVIEN_ID = '$BENHVIEN_ID$'
      </isNotEmpty>
      order by PHACDO_ID
    </statement>
    <statement id="DAO00310_Add" parameterClass="System.Collections.IDictionary" resultClass="System.Int64">
      insert into TM_PHACDO (
      MAPHACDO
      , TENPHACDO
      , ICD_ID
      , MAICD
      , GHICHU
      , TAMNGUNG
      , NGAYTAO
      , NGUOITAO_ID
      , BENHVIEN_ID
      ) values (
      #MAPHACDO#
      , #TENPHACDO#
      , #ICD_ID#
      , #MAICD#
      , #GHICHU#
      , #TAMNGUNG#
      , #NGAYTAO#
      , #NGUOITAO_ID#
      , #BENHVIEN_ID#
      )
      select SCOPE_identity() as value
    </statement>

    <update id="DAO00310_Update" parameterClass="System.Collections.IDictionary">
      update TM_PHACDO set
      MAPHACDO = #MAPHACDO#
      , TENPHACDO = #TENPHACDO#
      , ICD_ID = #ICD_ID#
      , MAICD = #MAICD#
      , GHICHU = #GHICHU#
      , TAMNGUNG = #TAMNGUNG#
      , NGAYCAPNHAT = #NGAYCAPNHAT#
      , NGUOICAPNHAT_ID = #NGUOICAPNHAT_ID#
      , BENHVIEN_ID = #BENHVIEN_ID#
      where
      PHACDO_ID = '$PHACDO_ID$'
    </update>
    <statement id="DAO00310_Delete" parameterClass="System.Collections.IDictionary" resultClass="System.Int32">
      delete from TM_PHACDO
      where
      PHACDO_ID = '$PHACDO_ID$'
    </statement>
    <statement id="DAO00310_GetAllPhacDo" resultClass="DataObject">
      select pd.*, nv.TENNHANVIEN as NGUOITAO, nv2.TENNHANVIEN as NGUOICAPNHAT, ICD.TENICD
      , case when pd.TAMNGUNG = '0' then N'Hiệu lực' else N'Hết hiệu lực' end TRANGTHAI
      from TM_PHACDO pd
      left join TM_NHANVIEN nv on nv.NHANVIEN_ID = pd.NGUOITAO_ID
      left join TM_NHANVIEN nv2 on nv2.NHANVIEN_ID = pd.NGUOICAPNHAT_ID
      inner join TM_ICD ICD on ICD.ICD_ID = pd.ICD_ID
      <dynamic prepend="where">
        <isParameterPresent>
          <isNotEmpty prepend="and" property="FICD_ID">
            pd.ICD_ID = '$FICD_ID$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="FTENPHACDO">
            pd.TENPHACDO like N'%$FTENPHACDO$%'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="FNGUOITAO_ID">
            pd.NGUOITAO_ID = '$FNGUOITAO_ID$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="FTAMNGUNG">
            pd.TAMNGUNG = '$FTAMNGUNG$'
          </isNotEmpty>
        </isParameterPresent>
      </dynamic>
      order by pd.PHACDO_ID
    </statement>
    <statement id="DAO00310_GetListCache" resultClass="DataObject">
      select PHACDO_ID, MAPHACDO, TENPHACDO, ICD_ID, MAICD
      from TM_PHACDO
      <dynamic prepend="where">
        <isParameterPresent>
          <isNotEmpty prepend="and" property="BENHVIEN_ID">
            BENHVIEN_ID = '$BENHVIEN_ID$'
          </isNotEmpty>
        </isParameterPresent>
      </dynamic>
    </statement>
    <statement id="DAO00310_GetList" resultClass="DataObject">
      select *
      from TM_PHACDO
      <dynamic prepend="where">
        <isParameterPresent>
          <isNotEmpty prepend="and" property="BENHVIEN_ID">
            BENHVIEN_ID = '$BENHVIEN_ID$'
          </isNotEmpty>
        </isParameterPresent>
      </dynamic>
    </statement>
    <statement id="DAO00310_GetPhacDoUsing" resultClass="DataObject">
      select top 1 pd.*
      from TT_PHACDO_DIEUTRI pd
      where pd.PHACDO_ID = '$PHACDO_ID$'
      <isNotEmpty prepend="and" property="BENHVIEN_ID">
        pd.BENHVIEN_ID = '$BENHVIEN_ID$'
      </isNotEmpty>
    </statement>
    <statement id="DAO00310_GetAllInfoChuKy" resultClass="DataObject">
      select A.*
      from
      (
      select ck.PHACDO_ID, ck.MACHUKY, (convert(varchar(10), ck.THUTU) + '. ' + ck.MACHUKY + ' - ' + ck.TENCHUKY) as TEN, ck.TENCHUKY,ck.CHUKY_ID, ck.THUTU
      , N'Thuốc' as DUOC, null as DICHVU
      , (d.TENDUOCDAYDU + ' | ' + N'Sáng: ' + isnull(convert(varchar(10),ck_duoc.SOLUONG_BUOISANG),0) + ' | '
      + N'Trưa: ' + isnull(convert(varchar(10),ck_duoc.SOLUONG_BUOITRUA),0) + ' | '
      + N'Chiều: ' + isnull(convert(varchar(10),ck_duoc.SOLUONG_BUOICHIEU),0) + ' | '
      + N'Tối: ' + isnull(convert(varchar(10),ck_duoc.SOLUONG_BUOITOI),0) + ' | '
      + N'Số ngày: ' + isnull(convert(varchar(10),ck_duoc.SONGAY),0) + ' | '
      + isnull(DuongDung.DICTIONARY_NAME,'')) as INFO
      from TT_PHACDO_CHUKY_DUOC ck_duoc
      left join LST_DICTIONARY DuongDung on DuongDung.DICTIONARY_ID = ck_duoc.DUONGDUNG_ID
      left join TM_DUOC d on d.DUOC_ID = ck_duoc.DUOC_ID
      inner join TM_PHACDO_CHUKY ck on ck.CHUKY_ID = ck_duoc.CHUKY_ID
      where ck.PHACDO_ID = '$PHACDO_ID$' and ck_duoc.PHIENBAN_ID = '$PHIENBAN_ID$'
      <isNotEmpty prepend="and" property="BENHVIEN_ID">
        ck_duoc.BENHVIEN_ID = '$BENHVIEN_ID$'
      </isNotEmpty>
      <!--<dynamic prepend="where">
      <isParameterPresent>
        <isNotEmpty prepend="and" property="PHACDO_ID">
          ck.PHACDO_ID = '$PHACDO_ID$'
        </isNotEmpty>
      </isParameterPresent>
    </dynamic>-->
      union all
      select ck.PHACDO_ID, ck.MACHUKY, (convert(varchar(10), ck.THUTU) + '. ' + ck.MACHUKY + ' - ' + ck.TENCHUKY) as TEN, ck.TENCHUKY,ck.CHUKY_ID, ck.THUTU
      ,null as DUOC, N'Dịch vụ' as DICHVU
      ,(dv.TENDICHVU + ' | ' + N'Số lượng: ' + isnull(convert(varchar(10), ck_dv.SOLUONG),'')) as INFO
      from TT_PHACDO_CHUKY_DICHVU ck_dv
      left join TM_DICHVU dv on dv.DICHVU_ID = ck_dv.DICHVU_ID
      inner join TM_PHACDO_CHUKY ck on ck.CHUKY_ID = ck_dv.CHUKY_ID
      where ck.PHACDO_ID = '$PHACDO_ID$' and ck_dv.PHIENBAN_ID = '$PHIENBAN_ID$'
      <isNotEmpty prepend="and" property="BENHVIEN_ID">
        ck_dv.BENHVIEN_ID = '$BENHVIEN_ID$'
      </isNotEmpty>
      <!--<dynamic prepend="where">
      <isParameterPresent>
        <isNotEmpty prepend="and" property="PHACDO_ID">
          ck.PHACDO_ID = '$PHACDO_ID$'
        </isNotEmpty>
      </isParameterPresent>
    </dynamic>-->
      group by dv.TENDICHVU, ck.PHACDO_ID, ck.MACHUKY, ck.TENCHUKY, ck_dv.SOLUONG, ck.CHUKY_ID, ck.THUTU
      )A
      <!--order by A.THUTU-->
    </statement>
    <statement id="DAO00310_DeleteCK" parameterClass="System.Collections.IDictionary" resultClass="System.Int32">
      delete from TT_PHACDO_CHUKY_DUOC where CHUKY_ID = '$CHUKY_ID$' and PHIENBAN_ID = '$PHIENBAN_ID$'
      delete from TT_PHACDO_CHUKY_DICHVU where CHUKY_ID = '$CHUKY_ID$' and PHIENBAN_ID = '$PHIENBAN_ID$'
    </statement>
    <statement id="DAO00310_GetChuKyUsing" resultClass="DataObject">
      SELECT *
      FROM dbo.TT_PHACDO_DIEUTRI
      WHERE CHUKY_ID = '$CHUKY_ID$' AND PHACDO_ID = '$PHACDO_ID$'
      <isNotEmpty prepend="and" property="BENHVIEN_ID">
        BENHVIEN_ID = '$BENHVIEN_ID$'
      </isNotEmpty>
    </statement>
    <statement id="DAO00310_GetAllVersion" resultClass="DataObject">
      select *
      from TM_PHIENBAN_PHACDO
      where PHACDO_ID = '$PHACDO_ID$'
      <isNotEmpty prepend="and" property="BENHVIEN_ID">
        BENHVIEN_ID = '$BENHVIEN_ID$'
      </isNotEmpty>
    </statement>
    <statement id="DAO00310_GetAllThuoc" resultClass="DataObject">
      SELECT cd.*, d.TENDUOCDAYDU,ld.DICTIONARY_NAME AS DUONGDUNG
      FROM TM_DUOC d
      JOIN TT_PHACDO_CHUKY_DUOC cd ON d.DUOC_ID= cd.DUOC_ID
      LEFT JOIN dbo.LST_DICTIONARY ld ON cd.DUONGDUNG_ID = ld.DICTIONARY_ID
      where PHACDO_ID = '$PHACDO_ID$'
      <isNotEmpty prepend="and" property="CHUKY_ID">
        CHUKY_ID = '$CHUKY_ID$'
      </isNotEmpty>
      <isNotEmpty prepend="and" property="LOAI">
        CHUKY_ID NOT IN ('$LOAI$')
      </isNotEmpty>
      <isNotEmpty prepend="and" property="PHIENBAN_ID">
        PHIENBAN_ID = '$PHIENBAN_ID$'
      </isNotEmpty>
      <isNotEmpty prepend="and" property="BENHVIEN_ID">
        cd.BENHVIEN_ID = '$BENHVIEN_ID$'
      </isNotEmpty>
    </statement>
    <statement id="DAO00310_GetAllDichVu" resultClass="DataObject">
      SELECT cv.*,dv.TENDICHVU
      FROM Tt_PHACDO_CHUKY_DICHVU cv
      JOIN TM_DICHVU dv ON dv.DICHVU_ID = cv.DICHVU_ID
      where PHACDO_ID = '$PHACDO_ID$'
      <isNotEmpty prepend="and" property="CHUKY_ID">
        CHUKY_ID = '$CHUKY_ID$'
      </isNotEmpty>
      <isNotEmpty prepend="and" property="LOAI">
        CHUKY_ID NOT IN ('$LOAI$')
      </isNotEmpty>
      <isNotEmpty prepend="and" property="PHIENBAN_ID">
        PHIENBAN_ID = '$PHIENBAN_ID$'
      </isNotEmpty>
      <isNotEmpty prepend="and" property="BENHVIEN_ID">
        cv.BENHVIEN_ID = '$BENHVIEN_ID$'
      </isNotEmpty>
    </statement>
    <statement id="DAO00310_GetPDWithVersion" resultClass="DataObject">
      select pd.PHACDO_ID, MAPHACDO, TENPHACDO, ICD_ID, MAICD, case when PHIENBAN_ID is null then 0 else PHIENBAN_ID end as PHIENBAN_ID
      from TM_PHACDO pd
      left join
      (select top 1 * from TM_PHIENBAN_PHACDO where TRANGTHAI = N'Hiệu lực'
      <isNotEmpty prepend="and" property="PHACDO_ID">
        PHACDO_ID = '$PHACDO_ID$'
      </isNotEmpty>
      <isNotEmpty prepend="and" property="BENHVIEN_ID">
        BENHVIEN_ID = '$BENHVIEN_ID$'
      </isNotEmpty>
      order by PHIENBAN_ID desc
      ) pb on pb.PHACDO_ID = pd.PHACDO_ID
    </statement>
    <statement id="DAO00310_GetRegimen" resultClass="DataObject">
      select PHACDO_ID, MAPHACDO, TENPHACDO, ICD_ID, MAICD
      from TM_PHACDO
      where TAMNGUNG = '0'
      <isNotEmpty prepend="and" property="BENHVIEN_ID">
        BENHVIEN_ID = '$BENHVIEN_ID$'
      </isNotEmpty>
    </statement>
  </statements>
</sqlMap>