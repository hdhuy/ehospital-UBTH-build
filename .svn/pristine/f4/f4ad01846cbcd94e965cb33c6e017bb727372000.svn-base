<?xml version="1.0" encoding="utf-8" ?>
<!--iBatis Map File-->
<sqlMap namespace="eHospital" xmlns="http://ibatis.apache.org/mapping" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
  <statements>
    <!--Revision:0,1fc8efd0da1f67a19a45c9b90694090c-->
    <statement id="DAO00027_GetLOAITINHGIADUOC" resultClass="DataObject">
      <!--select VALUE as LOAITINHGIADUOC
      from TM_SYS_APPSETTINGS
      where CODE = 'QuyTrinh_TinhGiaDuoc';-->
      select A.VALUE as LOAITINHGIADUOC, B.VALUE as SAPXEPTHEO
      from TM_SYS_APPSETTINGS A
      <!--left join TM_SYS_APPSETTINGS B on B.CODE = 'CachTinhGiaDuoc_TheoLo'-->
      left join TM_SYS_APPSETTINGS B on B.CODE = 'PHA_CACHTINHGIADUOC_THEOLO'
      where A.CODE = 'APP_QUYTRINH_TINHGIADUOC'
    </statement>
    <!--Revision:0,0dc6cd7b4957e2dbc859689a1fbe753a-->
    <statement id="DAO00027_GetGIADUOCTHEOLO" resultClass="DataObject">
      select TOP 1 B.DONGIAVONVAT as DONGIA_KHAC,
      B.DONGIABAN as DONGIA_DOANHTHU,
      ROUND(B.DONGIAVONVAT + B.DONGIAVONVAT*tmduoc.TYLE_VAT/100, 0) as DONGIA_DOANHTHU2_BACKUP,
      B.DONGIAVON, tmduoc.TYLE_VAT, dg.DONGIA as DONGIATHAU, tmduoc.BHYT,
      tmduoc.TINHTIEN
      from TT_DUOC_CHUNGTU_SOLONHAP A
      inner join TT_DUOC_SOLONHAP_GIABAN B on A.SOLONHAP_ID = B.SOLONHAP_ID and A.DUOC_ID = B.DUOC_ID
      inner join TM_DUOC tmduoc on A.DUOC_ID = tmduoc.DUOC_ID
      left JOIN TM_DUOC_DONGIA dg on dg.DUOC_ID = A.DUOC_ID
      left JOIN TM_BANGGIA bg on (bg.BANGGIA_ID = dg.BANGGIA_ID)
      INNER JOIN TT_DUOC_CHUNGTU_CHITIET AS DCC ON DCC.SOLONHAP_ID = B.SOLONHAP_ID AND DCC.DUOC_ID = B.DUOC_ID
      INNER JOIN TT_DUOC_CHUNGTU AS DC ON DC.CHUNGTU_ID = DCC.CHUNGTU_ID AND DC.LOAICHUNGTU = 'N' AND DC.TRANGTHAI != 'HUY'
      where A.DUOC_ID = '$DUOC_ID$' and (A.HUY = '0' or A.HUY is null) and B.DONGIABAN > 0
      <!--and KHONHAP_ID != (select top 1 kd.KHODUOC_ID from TM_DOITUONG_KHODUOC kd inner join TM_DOITUONG dt on dt.DOITUONG_ID = kd.DOITUONG_ID WHERE dt.MADOITUONG = 'VP')-->
      order by
      KHONHAP_ID asc
      <isEqual prepend="," property="SAPXEPTHEO" compareValue="0">
        A.NGAYNHAP desc
      </isEqual>
      <isEqual prepend="," property="SAPXEPTHEO" compareValue="1">
        A.HANDUNG desc
      </isEqual>
    </statement>
    <statement id="DAO00027_GetListGIADUOCTHEOLO" resultClass="DataObject">
      select B.DONGIAVONVAT as DONGIA_KHAC,
      B.DONGIABAN as DONGIA_DOANHTHU,
      ROUND(B.DONGIAVONVAT + B.DONGIAVONVAT*tmduoc.TYLE_VAT/100, 0) as DONGIA_DOANHTHU2_BACKUP,
      B.DONGIAVON, tmduoc.TYLE_VAT, dg.DONGIA as DONGIATHAU, tmduoc.BHYT, tmduoc.DUOC_ID,
      tmduoc.TINHTIEN
      from TT_DUOC_CHUNGTU_SOLONHAP A
      inner join TT_DUOC_SOLONHAP_GIABAN B on A.SOLONHAP_ID = B.SOLONHAP_ID and A.DUOC_ID = B.DUOC_ID
      inner join TM_DUOC tmduoc on A.DUOC_ID = tmduoc.DUOC_ID
      left JOIN TM_DUOC_DONGIA dg on dg.DUOC_ID = A.DUOC_ID
      left JOIN TM_BANGGIA bg on (bg.BANGGIA_ID = dg.BANGGIA_ID)
      left join TT_DUOC_TONKHO dtk on dtk.SOLONHAP_ID = A.SOLONHAP_ID
      <!--INNER JOIN TT_DUOC_CHUNGTU_CHITIET AS DCC ON DCC.SOLONHAP_ID = B.SOLONHAP_ID AND DCC.DUOC_ID = B.DUOC_ID
      INNER JOIN TT_DUOC_CHUNGTU AS DC ON DC.CHUNGTU_ID = DCC.CHUNGTU_ID AND DC.LOAICHUNGTU = 'N' AND DC.TRANGTHAI != 'HUY'-->
      where A.DUOC_ID in ($LST_DUOC_ID$) and (A.HUY = '0' or A.HUY is null) and B.DONGIABAN > 0 and dtk.SOLUONG > 0
      <!--and KHONHAP_ID != (select top 1 kd.KHODUOC_ID from TM_DOITUONG_KHODUOC kd inner join TM_DOITUONG dt on dt.DOITUONG_ID = kd.DOITUONG_ID WHERE dt.MADOITUONG = 'VP')-->
      order by
      <!--KHONHAP_ID asc-->
      <isEqual prepend="" property="SAPXEPTHEO" compareValue="0">
        A.NGAYNHAP desc
      </isEqual>
      <isEqual prepend="" property="SAPXEPTHEO" compareValue="1">
        A.HANDUNG desc
      </isEqual>
    </statement>
    <statement id="DAO00027_GetGIADUOCVienPhiTheoBangGia" resultClass="DataObject">
      select DONGIA as DONGIA_DOANHTHU from TM_DUOC_DONGIA A
      inner join TM_BANGGIA B on A.BANGGIA_ID = B.BANGGIA_ID
      inner join TM_LOAIGIA C on C.LOAIGIA_ID = B.LOAIGIA_ID
      where C.MALOAIGIA = 'GiaduocVP' and A.DUOC_ID = '$DUOC_ID$'
    </statement>
    <!--Revision:0,c965436a1c21e6e89d5ef48a45000e2f-->
    <statement id="DAO00027_GetList" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select distinct A.*, B.DESCRIPTION as TENGIOITINH
      from TT_BENHNHAN A
      left join TM_GENDER B on A.GIOITINH = B.ID
      where
      <!--A.BENHVIEN_ID = '$BENHVIEN_ID$' and-->
      ACTIVE = '1'
    </statement>
    <!--Revision:0,b4d582adbc89e21dd5979a49a95a6ac8-->
    <statement id="DAO00027_GetListTiepNhan" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select distinct CONVERT(VARCHAR(11),C.NGAYYEUCAU,103) as NGAYYEUCAU, C.DICHVU_ID, C.DVYEUCAU_ID, D.TENDICHVU, C.NOITHUCHIEN_ID, A.SOTIEPNHAN, A.TRAITUYEN, A.NGAYMIENDONGCHITRA, A.TIEPNHAN_ID, A.DOITUONG_ID, A.TRANGTHAI,
      A.LOAITHANHVIEN_ID, A.SUDUNG_BHTN, A.THE_ID, A.THANHVIEN_ID, A.VIP, A.NGUON_BENHNHAN_ID, A.BAOLANH_VIENPHI,
      CASE WHEN (A.TRANGTHAI = 'NOITRU' OR A.TRANGTHAI = 'CAPCUU' OR A.TRANGTHAI = 'NGOAITRU') THEN 'IN' ELSE 'OUT' END AS LOAIBENHAN,
      CASE WHEN (C.TRANGTHAI = 'CHUAKETQUA') THEN 'CHUAKETQUA' ELSE 'HOANTAT' END AS TRANGTHAIDICHVU, A.SOBHYT,
      B.*,
      CASE WHEN Left(E.MANHOMDICHVU,2) = '03' THEN '02' ELSE Left(E.MANHOMDICHVU,2) END AS MANHOMDICHVU
      , A.UUTIEN
      from TT_TIEPNHAN A
      inner join TT_BENHNHAN B on B.BENHNHAN_ID = A.BENHNHAN_ID and (A.TRANGTHAI = 'DATIEPNHAN' or A.TRANGTHAI = 'NOITRU' or A.TRANGTHAI = 'CAPCUU'  or A.TRANGTHAI = 'NGOAITRU') and B.ACTIVE = '1'
      inner join TT_DVYEUCAU C on C.TIEPNHAN_ID = A.TIEPNHAN_ID
      <!--and (C.TRANGTHAI = 'CHUAKETQUA' or C.TRANGTHAI = 'DANGTHUCHIEN')-->
      left join TM_DICHVU D on D.DICHVU_ID = C.DICHVU_ID
      left join TM_NHOMDICHVU E on E.NHOMDICHVU_ID = D.NHOMDICHVU_ID
      where C.NGAYHENCLS is NULL and A.BENHVIEN_ID = '$BENHVIEN_ID$'
      <!--where A.BENHNHAN_ID not in (select BENHNHAN_ID from TT_NOITRU_BENHAN where (TRANGTHAI='DATHANHTOAN' OR TRANGTHAI='DANGDIEUTRI'))-->
    </statement>
    <!--Revision:0,6515e5ee99d08343fa0e18288dd0acaf-->
    <statement id="DAO00027_GetListTiepNhanCOM015" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      declare @ManhomDSA varchar(10);
      select top 1  @ManhomDSA = VALUE from TM_SYS_APPSETTINGS where CODE = 'MANHOM_DICHVU_DSA'
      SELECT * FROM
      (
      SELECT
      (A.SOTIEPNHAN + (CASE WHEN Left(E.MANHOMDICHVU,2) = '03' THEN '02' ELSE Left(E.MANHOMDICHVU,2) END) + LTRIM(C.NOITHUCHIEN_ID)) AS acss_lookupID,
      ROW_NUMBER() OVER
      (PARTITION BY (A.SOTIEPNHAN + (CASE WHEN Left(E.MANHOMDICHVU,2) = '03' THEN '02' ELSE Left(E.MANHOMDICHVU,2) END) + LTRIM(C.NOITHUCHIEN_ID))
      ORDER BY (A.SOTIEPNHAN + (CASE WHEN Left(E.MANHOMDICHVU,2) = '03' THEN '02' ELSE Left(E.MANHOMDICHVU,2) END) + LTRIM(C.NOITHUCHIEN_ID)))
      as num,
      A.SOTIEPNHAN + (CASE WHEN Left(E.MANHOMDICHVU,2) = '03' THEN '02' ELSE Left(E.MANHOMDICHVU,2) END) + LTRIM(C.NOITHUCHIEN_ID) as KEYCOM15,
      C.NOITHUCHIEN_ID, A.SOTIEPNHAN, A.TRAITUYEN, A.NGAYMIENDONGCHITRA, A.TIEPNHAN_ID, A.DOITUONG_ID, A.TRANGTHAI,
      A.LOAITHANHVIEN_ID, A.SUDUNG_BHTN, A.THE_ID, A.THANHVIEN_ID, A.VIP, A.NGUON_BENHNHAN_ID, A.BAOLANH_VIENPHI,
      CASE WHEN (A.TRANGTHAI = 'NOITRU' OR A.TRANGTHAI = 'CAPCUU') THEN 'IN' ELSE 'OUT' END AS LOAIBENHAN,
      CASE WHEN (C.TRANGTHAI = 'CHUAKETQUA') THEN 'CHUAKETQUA' ELSE 'HOANTAT' END AS TRANGTHAIDICHVU, A.SOBHYT,
      B.*, F.TRANGTHAI as TRANGTHAI_BENHAN_NOITRU,
      CASE
      WHEN @ManhomDSA is not null and E.MANHOMDICHVU in (@ManhomDSA) THEN E.MANHOMDICHVU
      WHEN Left(E.MANHOMDICHVU,2) = '03' THEN '02' ELSE Left(E.MANHOMDICHVU,2) END AS MANHOMDICHVU
      , A.UUTIEN
      from TT_TIEPNHAN A
      inner join TT_BENHNHAN B on B.BENHNHAN_ID = A.BENHNHAN_ID and (A.TRANGTHAI = 'DATIEPNHAN' or A.TRANGTHAI = 'NOITRU' or A.TRANGTHAI = 'CAPCUU' or A.TRANGTHAI = 'NGOAITRU') and B.ACTIVE = '1'
      inner join TT_DVYEUCAU C on C.TIEPNHAN_ID = A.TIEPNHAN_ID
      left join TM_DICHVU D on D.DICHVU_ID = C.DICHVU_ID
      left join TM_NHOMDICHVU E on E.NHOMDICHVU_ID = D.NHOMDICHVU_ID
      left join TT_NOITRU_BENHAN F on F.TIEPNHAN_ID = A.TIEPNHAN_ID
      where C.NGAYHENCLS is NULL and A.BENHVIEN_ID = '$BENHVIEN_ID$'
      ) a WHERE a.num = 1
      <!--where A.BENHNHAN_ID not in (select BENHNHAN_ID from TT_NOITRU_BENHAN where (TRANGTHAI='DATHANHTOAN' OR TRANGTHAI='DANGDIEUTRI'))-->
    </statement>
    <!--Revision:0,ceffbdc278591ba0470687f7d67a592c-->
    <statement id="DAO00027_GetListTiepNhanAll" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select distinct A.SOTIEPNHAN, A.TRAITUYEN, A.NGAYMIENDONGCHITRA, A.TIEPNHAN_ID, A.DOITUONG_ID, isnull(C.SOBENHAN,NULL) as SOBENHAN,
      A.LOAITHANHVIEN_ID, A.SUDUNG_BHTN, A.THE_ID, A.THANHVIEN_ID, A.VIP, A.NGUON_BENHNHAN_ID, A.BAOLANH_VIENPHI, A.SOBHYT, CONVERT(VARCHAR(11),A.NGAYTIEPNHAN,103) as NGAYTIEPNHAN,
      B.*
      , A.UUTIEN
      from TT_TIEPNHAN A
      inner join TT_BENHNHAN B on B.BENHNHAN_ID = A.BENHNHAN_ID and (A.TRANGTHAI = 'DATIEPNHAN') and B.ACTIVE = '1'
      left join TT_NOITRU_BENHAN C on C.TIEPNHAN_ID = A.TIEPNHAN_ID
      where A.BENHVIEN_ID = '$BENHVIEN_ID$'
    </statement>
    <!--Revision:0,9eaaef86e258db859fa8d0fb22ff2dde-->
    <statement id="DAO00027_GetListTiepNhanNoiTru" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select distinct B.*, C.SOBENHAN, C.BENHAN_ID, A.SOTIEPNHAN, A.TRAITUYEN, A.NGAYMIENDONGCHITRA, A.TIEPNHAN_ID,
      isnull(C.KHOACHUYENDEN_ID,C.KHOAVAO_ID) as KHOACHUYENDEN_ID, A.TRANGTHAI, A.DOITUONG_ID, C.TRANGTHAI as TRANGTHAI_BENHAN,
      A.LOAITHANHVIEN_ID, A.SUDUNG_BHTN, A.THE_ID, A.THANHVIEN_ID, A.VIP, A.NGUON_BENHNHAN_ID, A.BAOLANH_VIENPHI, A.SOBHYT,
      CASE WHEN RIGHT(C.SOBENHAN,2) = 'CC' THEN 'CC' ELSE 'NT' END AS LOAIBENHAN, CONVERT(VARCHAR(11), C.NGAYVAOKHOA,103) as NGAYVAOKHOA
      , A.UUTIEN
      <!--'NT' AS LOAIBENHAN-->
      from TT_TIEPNHAN A
      inner join TT_BENHNHAN B on B.BENHNHAN_ID = A.BENHNHAN_ID and (A.TRANGTHAI = 'CAPCUU' or A.TRANGTHAI = 'NOITRU' or A.TRANGTHAI = 'HOANTHANH' or A.TRANGTHAI = 'NGOAITRU') and B.ACTIVE = '1'
      inner join TT_NOITRU_BENHAN C on C.TIEPNHAN_ID = A.TIEPNHAN_ID and (C.TRANGTHAI='DAXUATVIEN' or C.TRANGTHAI='DATHANHTOAN' OR C.TRANGTHAI='DANGDIEUTRI')
      <!--inner join TT_NOITRU_BENHAN C on C.TIEPNHAN_ID = A.TIEPNHAN_ID and (C.TRANGTHAI='DAXUATVIEN' or C.TRANGTHAI='DATHANHTOAN' OR C.TRANGTHAI='DANGDIEUTRI')-->
      where A.BENHVIEN_ID = '$BENHVIEN_ID$' and C.LOAIBENHAN != 2
    </statement>
    <!--Revision:0,8ee40035faf2bc77ff38ab4e50d25ed6-->
    <statement id="DAO00027_GetListTiepNhanNoiTruWithTiepNhanId" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select distinct B.*, C.SOBENHAN, C.BENHAN_ID, A.SOTIEPNHAN, A.TRAITUYEN, A.NGAYMIENDONGCHITRA, A.TIEPNHAN_ID,
      isnull(C.KHOACHUYENDEN_ID,C.KHOAVAO_ID) as KHOACHUYENDEN_ID, A.TRANGTHAI, A.DOITUONG_ID, C.TRANGTHAI as TRANGTHAI_BENHAN,
      A.LOAITHANHVIEN_ID, A.SUDUNG_BHTN, A.THE_ID, A.THANHVIEN_ID, A.VIP, A.NGUON_BENHNHAN_ID, A.BAOLANH_VIENPHI, A.SOBHYT,
      CASE WHEN RIGHT(C.SOBENHAN,2) = 'CC' THEN 'CC' ELSE 'NT' END AS LOAIBENHAN, CONVERT(VARCHAR(11), C.NGAYVAOKHOA,103) as NGAYVAOKHOA
      , A.UUTIEN
      <!--'NT' AS LOAIBENHAN-->
      from TT_TIEPNHAN A
      inner join TT_BENHNHAN B on B.BENHNHAN_ID = A.BENHNHAN_ID and (A.TRANGTHAI = 'CAPCUU' or A.TRANGTHAI = 'NOITRU' or A.TRANGTHAI = 'HOANTHANH' or A.TRANGTHAI = 'NGOAITRU') and B.ACTIVE = '1'
      inner join TT_NOITRU_BENHAN C on C.TIEPNHAN_ID = A.TIEPNHAN_ID and (C.TRANGTHAI='DAXUATVIEN' or C.TRANGTHAI='DATHANHTOAN' OR C.TRANGTHAI='DANGDIEUTRI')
      where
      A.TIEPNHAN_ID = '$TIEPNHAN_ID$' and A.BENHVIEN_ID = '$BENHVIEN_ID$'  and C.LOAIBENHAN != 2
    </statement>
    <!--Revision:0,309c859f7f7be7affe6be2dfe5ee4048-->
    <statement id="DAO00027_GetListTiepNhanNoiTruWithBenhAnId" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select distinct B.*, C.SOBENHAN, C.BENHAN_ID, A.SOTIEPNHAN, A.TRAITUYEN, A.NGAYMIENDONGCHITRA, A.TIEPNHAN_ID,
      isnull(C.KHOACHUYENDEN_ID,C.KHOAVAO_ID) as KHOACHUYENDEN_ID, A.TRANGTHAI, A.DOITUONG_ID, C.TRANGTHAI as TRANGTHAI_BENHAN,
      A.LOAITHANHVIEN_ID, A.SUDUNG_BHTN, A.THE_ID, A.THANHVIEN_ID, A.VIP, A.NGUON_BENHNHAN_ID, A.BAOLANH_VIENPHI, A.SOBHYT,
      CASE WHEN RIGHT(C.SOBENHAN,2) = 'CC' THEN 'CC' ELSE 'NT' END AS LOAIBENHAN, CONVERT(VARCHAR(11), C.NGAYVAOKHOA,103) as NGAYVAOKHOA
      , A.UUTIEN
      <!--'NT' AS LOAIBENHAN-->
      from TT_TIEPNHAN A
      inner join TT_BENHNHAN B on B.BENHNHAN_ID = A.BENHNHAN_ID and (A.TRANGTHAI = 'CAPCUU' or A.TRANGTHAI = 'NOITRU' or A.TRANGTHAI = 'HOANTHANH' or A.TRANGTHAI = 'NGOAITRU') and B.ACTIVE = '1'
      inner join TT_NOITRU_BENHAN C on C.TIEPNHAN_ID = A.TIEPNHAN_ID and (C.TRANGTHAI='DAXUATVIEN' or C.TRANGTHAI='DATHANHTOAN' OR C.TRANGTHAI='DANGDIEUTRI')
      where
      C.BENHAN_ID = '$BENHAN_ID$' and A.BENHVIEN_ID = '$BENHVIEN_ID$'  and C.LOAIBENHAN != 2
    </statement>
    <!--Revision:0,09b51a1e4b526938c0abbadcb8de4caa-->
    <statement id="DAO00027_GetListTiepNhanNoiTruWithSoBenhAn" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select distinct B.*, C.SOBENHAN, C.BENHAN_ID, A.SOTIEPNHAN, A.TRAITUYEN, A.NGAYMIENDONGCHITRA, A.TIEPNHAN_ID,
      isnull(C.KHOACHUYENDEN_ID,C.KHOAVAO_ID) as KHOACHUYENDEN_ID, A.TRANGTHAI, A.DOITUONG_ID, C.TRANGTHAI as TRANGTHAI_BENHAN,
      A.LOAITHANHVIEN_ID, A.SUDUNG_BHTN, A.THE_ID, A.THANHVIEN_ID, A.VIP, A.NGUON_BENHNHAN_ID, A.BAOLANH_VIENPHI, A.SOBHYT,
      CASE WHEN RIGHT(C.SOBENHAN,2) = 'CC' THEN 'CC' ELSE 'NT' END AS LOAIBENHAN
      , A.UUTIEN
      <!--'NT' AS LOAIBENHAN-->
      from TT_TIEPNHAN A
      inner join TT_BENHNHAN B on B.BENHNHAN_ID = A.BENHNHAN_ID and (A.TRANGTHAI = 'CAPCUU' or A.TRANGTHAI = 'NOITRU' or A.TRANGTHAI = 'HOANTHANH' or A.TRANGTHAI = 'NGOAITRU') and B.ACTIVE = '1'
      inner join TT_NOITRU_BENHAN C on C.TIEPNHAN_ID = A.TIEPNHAN_ID and (C.TRANGTHAI='DAXUATVIEN' or C.TRANGTHAI='DATHANHTOAN' OR C.TRANGTHAI='DANGDIEUTRI')
      where
      A.BENHVIEN_ID = '$BENHVIEN_ID$'  and C.LOAIBENHAN != 2
      <isNotEmpty prepend="and" property="SOBENHAN">
        C.SOBENHAN = '$SOBENHAN$'
      </isNotEmpty>
      <isNotEmpty prepend="and" property="SOCAPCUU">
        C.SOCAPCUU = '$SOCAPCUU$'
      </isNotEmpty>
    </statement>
    <!--Revision:0,aee17b2e4d6a9ca987f8ca30799e5739-->
    <statement id="DAO00027_GetListTiepNhanAllWithId" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select distinct A.SOTIEPNHAN, A.TRAITUYEN, A.NGAYMIENDONGCHITRA, A.TIEPNHAN_ID, A.DOITUONG_ID, isnull(C.SOBENHAN,NULL) as SOBENHAN,
      A.LOAITHANHVIEN_ID, A.SUDUNG_BHTN, A.THE_ID, A.THANHVIEN_ID, A.VIP, A.NGUON_BENHNHAN_ID, A.BAOLANH_VIENPHI, A.SOBHYT,
      B.*
      , A.UUTIEN
      from TT_TIEPNHAN A
      inner join TT_BENHNHAN B on B.BENHNHAN_ID = A.BENHNHAN_ID and (A.TRANGTHAI = 'DATIEPNHAN') and B.ACTIVE = '1'
      left join TT_NOITRU_BENHAN C on C.TIEPNHAN_ID = A.TIEPNHAN_ID
      where TIEPNHAN_ID = '$TIEPNHAN_ID$' and A.BENHVIEN_ID = '$BENHVIEN_ID$'
    </statement>
    <!--Revision:0,85603fe0fa23a83f833bed887c872bf7-->
    <statement id="DAO00027_GetThongTinBenhNhanDichVu" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select * from TT_BENHNHAN A
      where A.BENHNHAN_ID = '$BENHNHAN_ID$'
    </statement>
    <!--Revision:0,2a67e7d1b87bc4dbd3ebf643d948a46f-->
    <statement id="DAO00027_GetTUOITREEMANDTHANHTHIEUNIEN" resultClass="DataObject">
      <!--select VALUE as TUOITREEM, 0 as TUOITHANHTHIEUNIEN
      from TM_SYS_APPSETTINGS
      where CODE = 'TuoiTreEm';
      select 0 as TUOITREEM, VALUE as TUOITHANHTHIEUNIEN
      from TM_SYS_APPSETTINGS
      where CODE = 'TuoiTreThanhThieuNien';-->
      select VALUE as TUOITREEM, 0 as TUOITHANHTHIEUNIEN
      from TM_SYS_APPSETTINGS
      where CODE = 'MPI_TUOI_TRE_EM';
      select 0 as TUOITREEM, VALUE as TUOITHANHTHIEUNIEN
      from TM_SYS_APPSETTINGS
      where CODE = 'MPI_TUOI_TRE_THANH_THIEU_NIEN';
    </statement>
    <!--Revision:0,422b8817ff1b571e724ab1b8ce11a334-->
    <statement id="DAO00027_ThongTinTiepNhanCOM006" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select distinct CONVERT(VARCHAR(11),A.NGAYTIEPNHAN,103) as NGAYYEUCAU, C.DICHVU_ID, C.DVYEUCAU_ID, D.TENDICHVU, C.NOITHUCHIEN_ID,
      A.SOTIEPNHAN, A.TRAITUYEN, A.NGAYMIENDONGCHITRA, A.TIEPNHAN_ID, A.DOITUONG_ID, A.TRANGTHAI,
      A.LOAITHANHVIEN_ID, A.SUDUNG_BHTN, A.THE_ID, A.THANHVIEN_ID, A.VIP, A.NGUON_BENHNHAN_ID, A.BAOLANH_VIENPHI,
      CASE WHEN (A.TRANGTHAI = 'NOITRU' OR A.TRANGTHAI = 'CAPCUU'   or A.TRANGTHAI = 'NGOAITRU') THEN 'IN' ELSE 'OUT' END AS LOAIBENHAN,
      CASE WHEN (C.TRANGTHAI = 'CHUAKETQUA') THEN 'CHUAKETQUA' ELSE 'HOANTAT' END AS TRANGTHAIDICHVU, A.SOBHYT,
      B.*,
      CASE WHEN Left(E.MANHOMDICHVU,2) = '03' THEN '02' ELSE Left(E.MANHOMDICHVU,2) END AS MANHOMDICHVU
      , A.UUTIEN
      from TT_TIEPNHAN A
      inner join TT_BENHNHAN B on B.BENHNHAN_ID = A.BENHNHAN_ID and (A.TRANGTHAI = 'DATIEPNHAN' or A.TRANGTHAI = 'NOITRU' or A.TRANGTHAI = 'CAPCUU'  or A.TRANGTHAI = 'NGOAITRU') and B.ACTIVE = '1'
      inner join TT_DVYEUCAU C on C.TIEPNHAN_ID = A.TIEPNHAN_ID
      left join TM_DICHVU D on D.DICHVU_ID = C.DICHVU_ID
      left join TM_NHOMDICHVU E on E.NHOMDICHVU_ID = D.NHOMDICHVU_ID
      where C.NGAYHENCLS is NULL and A.TIEPNHAN_ID = '$TIEPNHAN_ID$' and C.DICHVU_ID = '$DICHVU_ID$' and A.BENHVIEN_ID = '$BENHVIEN_ID$'
      <isNotEmpty prepend="and" property="DVYEUCAU_ID">
        C.DVYEUCAU_ID = '$DVYEUCAU_ID$'
      </isNotEmpty>
      <!--where A.BENHNHAN_ID not in (select BENHNHAN_ID from TT_NOITRU_BENHAN where (TRANGTHAI='DATHANHTOAN' OR TRANGTHAI='DANGDIEUTRI'))-->
    </statement>
    <statement id="DAO00027_ThongTinTiepNhanCOM006NhieuDVYeucau" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select distinct CONVERT(VARCHAR(11),A.NGAYTIEPNHAN,103) as NGAYYEUCAU, C.DICHVU_ID, C.DVYEUCAU_ID, D.TENDICHVU, C.NOITHUCHIEN_ID,
      A.SOTIEPNHAN, A.TRAITUYEN, A.NGAYMIENDONGCHITRA, A.TIEPNHAN_ID, A.DOITUONG_ID, A.TRANGTHAI,
      A.LOAITHANHVIEN_ID, A.SUDUNG_BHTN, A.THE_ID, A.THANHVIEN_ID, A.VIP, A.NGUON_BENHNHAN_ID, A.BAOLANH_VIENPHI,
      CASE WHEN (A.TRANGTHAI = 'NOITRU' OR A.TRANGTHAI = 'CAPCUU'   or A.TRANGTHAI = 'NGOAITRU') THEN 'IN' ELSE 'OUT' END AS LOAIBENHAN,
      CASE WHEN (C.TRANGTHAI = 'CHUAKETQUA') THEN 'CHUAKETQUA' ELSE 'HOANTAT' END AS TRANGTHAIDICHVU, A.SOBHYT,
      B.*,
      CASE WHEN Left(E.MANHOMDICHVU,2) = '03' THEN '02' ELSE Left(E.MANHOMDICHVU,2) END AS MANHOMDICHVU
      , A.UUTIEN
      from TT_TIEPNHAN A
      inner join TT_BENHNHAN B on B.BENHNHAN_ID = A.BENHNHAN_ID and (A.TRANGTHAI = 'DATIEPNHAN' or A.TRANGTHAI = 'NOITRU' or A.TRANGTHAI = 'CAPCUU'  or A.TRANGTHAI = 'NGOAITRU') and B.ACTIVE = '1'
      inner join TT_DVYEUCAU C on C.TIEPNHAN_ID = A.TIEPNHAN_ID
      left join TM_DICHVU D on D.DICHVU_ID = C.DICHVU_ID
      left join TM_NHOMDICHVU E on E.NHOMDICHVU_ID = D.NHOMDICHVU_ID
      where C.NGAYHENCLS is NULL and A.TIEPNHAN_ID = '$TIEPNHAN_ID$' and A.BENHVIEN_ID = '$BENHVIEN_ID$'
      <isNotEmpty prepend="and" property="LST_DVYEUCAU_ID">
        C.DVYEUCAU_ID in ($LST_DVYEUCAU_ID$)
      </isNotEmpty>
      <!--where A.BENHNHAN_ID not in (select BENHNHAN_ID from TT_NOITRU_BENHAN where (TRANGTHAI='DATHANHTOAN' OR TRANGTHAI='DANGDIEUTRI'))-->
    </statement>
    <!--Revision:0,09c1535bca3177046486ae83c0ebb8d9-->
    <statement id="DAO00027_ThongTinTiepNhanCOM006List" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select distinct CONVERT(VARCHAR(11),A.NGAYTIEPNHAN,103) as NGAYYEUCAU, C.DICHVU_ID, C.DVYEUCAU_ID, D.TENDICHVU, C.NOITHUCHIEN_ID,
      A.SOTIEPNHAN, A.TRAITUYEN, A.NGAYMIENDONGCHITRA, A.TIEPNHAN_ID, A.DOITUONG_ID, A.TRANGTHAI,
      A.LOAITHANHVIEN_ID, A.SUDUNG_BHTN, A.THE_ID, A.THANHVIEN_ID, A.VIP, A.NGUON_BENHNHAN_ID, A.BAOLANH_VIENPHI,
      CASE WHEN (A.TRANGTHAI = 'NOITRU' OR A.TRANGTHAI = 'CAPCUU'   or A.TRANGTHAI = 'NGOAITRU') THEN 'IN' ELSE 'OUT' END AS LOAIBENHAN,
      CASE WHEN (C.TRANGTHAI = 'CHUAKETQUA') THEN 'CHUAKETQUA' ELSE 'HOANTAT' END AS TRANGTHAIDICHVU, A.SOBHYT,
      B.*,
      CASE WHEN Left(E.MANHOMDICHVU,2) = '03' THEN '02' ELSE Left(E.MANHOMDICHVU,2) END AS MANHOMDICHVU
      , A.UUTIEN
      from TT_TIEPNHAN A
      inner join TT_BENHNHAN B on B.BENHNHAN_ID = A.BENHNHAN_ID and (A.TRANGTHAI = 'DATIEPNHAN' or A.TRANGTHAI = 'NOITRU' or A.TRANGTHAI = 'CAPCUU'  or A.TRANGTHAI = 'NGOAITRU') and B.ACTIVE = '1'
      inner join TT_DVYEUCAU C on C.TIEPNHAN_ID = A.TIEPNHAN_ID
      left join TM_DICHVU D on D.DICHVU_ID = C.DICHVU_ID
      left join TM_NHOMDICHVU E on E.NHOMDICHVU_ID = D.NHOMDICHVU_ID
      where C.NGAYHENCLS is NULL and A.TIEPNHAN_ID = '$TIEPNHAN_ID$' and C.DICHVU_ID in ($LST_DICHVU_ID$) and A.BENHVIEN_ID = '$BENHVIEN_ID$'
      <!--where A.BENHNHAN_ID not in (select BENHNHAN_ID from TT_NOITRU_BENHAN where (TRANGTHAI='DATHANHTOAN' OR TRANGTHAI='DANGDIEUTRI'))-->
    </statement>
    <!--Revision:0,a34762362791a0ed9e30b636ecbd3d21-->
    <statement id="DAO00027_ThongTinTiepNhanCOM015" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      declare @ManhomDSA varchar(10);
      select top 1  @ManhomDSA = VALUE from TM_SYS_APPSETTINGS where CODE = 'MANHOM_DICHVU_DSA'
      SELECT * FROM
      (
      SELECT
      (A.SOTIEPNHAN + (CASE WHEN Left(E.MANHOMDICHVU,2) = '03' THEN '02' ELSE Left(E.MANHOMDICHVU,2) END) + LTRIM(C.NOITHUCHIEN_ID)) AS acss_lookupID,
      ROW_NUMBER() OVER
      (PARTITION BY (A.SOTIEPNHAN + (CASE WHEN Left(E.MANHOMDICHVU,2) = '03' THEN '02' ELSE Left(E.MANHOMDICHVU,2) END) + LTRIM(C.NOITHUCHIEN_ID))
      ORDER BY (A.SOTIEPNHAN + (CASE WHEN Left(E.MANHOMDICHVU,2) = '03' THEN '02' ELSE Left(E.MANHOMDICHVU,2) END) + LTRIM(C.NOITHUCHIEN_ID)))
      as num,
      A.SOTIEPNHAN + (CASE WHEN Left(E.MANHOMDICHVU,2) = '03' THEN '02' ELSE Left(E.MANHOMDICHVU,2) END) + LTRIM(C.NOITHUCHIEN_ID) as KEYCOM15,
      C.NOITHUCHIEN_ID, A.SOTIEPNHAN, A.TRAITUYEN, A.NGAYMIENDONGCHITRA, A.TIEPNHAN_ID, A.DOITUONG_ID, A.TRANGTHAI,
      CASE WHEN (A.TRANGTHAI = 'NOITRU' OR A.TRANGTHAI = 'CAPCUU' or A.TRANGTHAI = 'NGOAITRU') THEN 'IN' ELSE 'OUT' END AS LOAIBENHAN,
      CASE WHEN (C.TRANGTHAI = 'CHUAKETQUA') THEN 'CHUAKETQUA' ELSE 'HOANTAT' END AS TRANGTHAIDICHVU, A.SOBHYT,
      B.*, F.TRANGTHAI as TRANGTHAI_BENHAN_NOITRU,
      A.LOAITHANHVIEN_ID, A.SUDUNG_BHTN, A.THE_ID, A.THANHVIEN_ID, A.VIP, A.NGUON_BENHNHAN_ID, A.BAOLANH_VIENPHI,
      CASE
      WHEN @ManhomDSA is not null and E.MANHOMDICHVU in (@ManhomDSA) THEN E.MANHOMDICHVU
      WHEN Left(E.MANHOMDICHVU,2) = '03' THEN '02' ELSE Left(E.MANHOMDICHVU,2) END AS MANHOMDICHVU
      , A.UUTIEN
      from TT_TIEPNHAN A
      inner join TT_BENHNHAN B on B.BENHNHAN_ID = A.BENHNHAN_ID and (A.TRANGTHAI = 'DATIEPNHAN' or A.TRANGTHAI = 'NOITRU' or A.TRANGTHAI = 'CAPCUU' or A.TRANGTHAI = 'NGOAITRU') and B.ACTIVE = '1'
      inner join TT_DVYEUCAU C on C.TIEPNHAN_ID = A.TIEPNHAN_ID
      left join TM_DICHVU D on D.DICHVU_ID = C.DICHVU_ID
      left join TM_NHOMDICHVU E on E.NHOMDICHVU_ID = D.NHOMDICHVU_ID
      left join TT_NOITRU_BENHAN F on F.TIEPNHAN_ID = A.TIEPNHAN_ID
      where C.NGAYHENCLS is NULL and A.TIEPNHAN_ID = '$TIEPNHAN_ID$' and A.BENHVIEN_ID = '$BENHVIEN_ID$'
      ) a where a.num = 1
      <!--where C.NGAYHENCLS is NULL and A.SOTIEPNHAN = '$SOTIEPNHAN$' and A.BENHVIEN_ID = '$BENHVIEN_ID$'-->
      <!--where A.BENHNHAN_ID not in (select BENHNHAN_ID from TT_NOITRU_BENHAN where (TRANGTHAI='DATHANHTOAN' OR TRANGTHAI='DANGDIEUTRI'))-->
    </statement>
    <!--Revision:0,3ae55445b7368e6d4c9eff77b7c3f316-->
    <statement id="DAO00027_ThongTinTiepNhanCOM015All" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select distinct
      A.SOTIEPNHAN + (CASE WHEN Left(E.MANHOMDICHVU,2) = '03' THEN '02' ELSE Left(E.MANHOMDICHVU,2) END) + LTRIM(C.NOITHUCHIEN_ID) as KEYCOM15,
      C.NOITHUCHIEN_ID, A.SOTIEPNHAN, A.TIEPNHAN_ID, A.DOITUONG_ID, A.TRANGTHAI,
      CASE WHEN (A.TRANGTHAI = 'NOITRU' OR A.TRANGTHAI = 'CAPCUU' or A.TRANGTHAI = 'NGOAITRU') THEN 'IN' ELSE 'OUT' END AS LOAIBENHAN,
      CASE WHEN (C.TRANGTHAI = 'CHUAKETQUA') THEN 'CHUAKETQUA' ELSE 'HOANTAT' END AS TRANGTHAIDICHVU, A.SOBHYT,
      B.*, F.TRANGTHAI as TRANGTHAI_BENHAN_NOITRU,
      A.LOAITHANHVIEN_ID, A.SUDUNG_BHTN, A.THE_ID, A.THANHVIEN_ID, A.VIP, A.NGUON_BENHNHAN_ID, A.BAOLANH_VIENPHI,
      CASE WHEN Left(E.MANHOMDICHVU,2) = '03' THEN '02' ELSE Left(E.MANHOMDICHVU,2) END AS MANHOMDICHVU
      , A.UUTIEN
      from TT_TIEPNHAN A
      inner join TT_BENHNHAN B on B.BENHNHAN_ID = A.BENHNHAN_ID and B.ACTIVE = '1'
      inner join TT_DVYEUCAU C on C.TIEPNHAN_ID = A.TIEPNHAN_ID
      left join TM_DICHVU D on D.DICHVU_ID = C.DICHVU_ID
      left join TM_NHOMDICHVU E on E.NHOMDICHVU_ID = D.NHOMDICHVU_ID
      left join TT_NOITRU_BENHAN F on F.TIEPNHAN_ID = A.TIEPNHAN_ID
      where C.NGAYHENCLS is NULL and A.TIEPNHAN_ID = '$TIEPNHAN_ID$' and A.BENHVIEN_ID = '$BENHVIEN_ID$'
      <!--where C.NGAYHENCLS is NULL and A.SOTIEPNHAN = '$SOTIEPNHAN$' and A.BENHVIEN_ID = '$BENHVIEN_ID$'-->
      <!--where A.BENHNHAN_ID not in (select BENHNHAN_ID from TT_NOITRU_BENHAN where (TRANGTHAI='DATHANHTOAN' OR TRANGTHAI='DANGDIEUTRI'))-->
    </statement>
    <!--Revision:0,b872a93d0c6e41f521af9981dab991d0-->
    <statement id="DAO00027_GetListTiepNhanAllCOM30" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select distinct A.SOTIEPNHAN, A.TRAITUYEN, A.NGAYMIENDONGCHITRA, A.TIEPNHAN_ID, A.DOITUONG_ID, isnull(C.SOBENHAN,NULL) as SOBENHAN,
      A.LOAITHANHVIEN_ID, A.SUDUNG_BHTN, A.THE_ID, A.THANHVIEN_ID, A.VIP, A.NGUON_BENHNHAN_ID, A.BAOLANH_VIENPHI, A.SOBHYT, CONVERT(VARCHAR(11),A.NGAYTIEPNHAN,103) as NGAYTIEPNHAN,
      B.*
      , A.UUTIEN
      from TT_TIEPNHAN A
      inner join (select * from TT_BENHNHAN where MAYTE = '$MAYTE$' and ACTIVE = '1') B on B.BENHNHAN_ID = A.BENHNHAN_ID  and B.ACTIVE = '1'
      left join TT_NOITRU_BENHAN C on C.TIEPNHAN_ID = A.TIEPNHAN_ID
      where A.TIEPNHAN_ID = '$TIEPNHAN_ID$' and A.BENHVIEN_ID = '$BENHVIEN_ID$' and (A.TRANGTHAI not in ('HUY','CAPCUU', 'NOITRU', 'NGOAITRU'))
    </statement>
    <!--Revision:0,63d147da02d3a045ba7dadd64ef9a5b8-->
    <statement id="DAO00027_GetListDuocTonKho" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select distinct TT_TONKHO.DUOC_KEY, LTRIM(TT_TONKHO.KHODUOC_ID) as KHODUOC_ID, TM_DUOC.DUOC_ID, TM_LOAIDUOC.MALOAIDUOC,TM_DUOC.SOVISA,TM_DUOC.TYLE_VAT,TM_DUOC.COTOA,
      TM_DUOC.MADUOC, TM_DUOC.TENHANG, TM_DUOC.TENDUOCDAYDU, dvt.TENDONVITINH as DONVITINH,  TM_DUOC.DONVITINH_ID,TM_DUOC.BHYT,
      <!--TM_DUOC.TENHOATCHAT + ' (' + TM_DUOC.TENHANG + ') ' + TM_DUOC.HAMLUONG as TENHOATCHAT,-->
      TM_DUOC.TENHOATCHAT,

      TM_DUOC.HAMLUONG, TM_DUOC.HANGSANXUAT, TM_DUOC.QUOCGIA, TM_DUOC.LOAIDUOC_ID, TM_DUOC.DUONGDUNG_ID,
      TM_TENDUOC.TENDUOC, TM_TENDUOC.TENDUOC_EN, TM_TENDUOC.MAQUOCTE, TM_TENDUOC.MAQUOCTEBT,
      TM_LOAIDUOC.LOAIVATTU_ID, TM_DUOC.BENHVIEN_ID,
      TT_TONKHO.SOLUONG, TM_DUOC.VTYT_PHANLOAI, TM_DUOC.PHAMVI, TT_TONKHO.NGUONDUOC_ID, NG.TENNGUONDUOC AS TENNGUONDUOC
      , TAMNGUNG = CASE WHEN TM_DUOC.TAMNGUNG = '1' OR NG.TAMNGUNG = '1' OR KD.TAMNGUNG = '1' THEN '1' ELSE '0' END
      , TM_DUOC.DANGTRINHBAY
      from TM_DUOC
      left join TM_DONVITINH dvt on dvt.DONVITINH_ID = TM_DUOC.DONVITINH_ID
      left join TM_TENDUOC on TM_DUOC.TENDUOC_ID = TM_TENDUOC.TENDUOC_ID and TM_DUOC.BENHVIEN_ID = '$BENHVIEN_ID$' and TM_DUOC.TAMNGUNG = '0'
      left join TM_LOAIDUOC on TM_LOAIDUOC.LOAIDUOC_ID = TM_DUOC.LOAIDUOC_ID and TM_LOAIDUOC.BENHVIEN_ID = '$BENHVIEN_ID$'
      left join TM_DUOC_HANDUNG on (TM_LOAIDUOC.LOAIVATTU_ID = TM_DUOC_HANDUNG.LOAIDUOC and TM_DUOC_HANDUNG.BENHVIEN_ID = '$BENHVIEN_ID$')
      inner join
      (select LTRIM(A.KHODUOC_ID) + '_' + LTRIM(A.DUOC_ID) + '_' + LTRIM(ISNULL(A.NGUONDUOC_ID,'')) as DUOC_KEY, A.KHODUOC_ID, A.DUOC_ID, A.NGUONDUOC_ID,
      SUM(isnull(A.SOLUONG,0)) as SOLUONG
      from
      (select SUM(SOLUONG) as SOLUONG, KHODUOC_ID, DUOC_ID, NGUONDUOC_ID from TT_DUOC_TONKHO
      where BENHVIEN_ID = '$BENHVIEN_ID$' group by KHODUOC_ID, DUOC_ID, NGUONDUOC_ID) A
      group by LTRIM(A.KHODUOC_ID) + '_' + LTRIM(A.DUOC_ID) + '_' + LTRIM(ISNULL(A.NGUONDUOC_ID,'')), A.KHODUOC_ID, A.DUOC_ID, NGUONDUOC_ID
      ) TT_TONKHO on TT_TONKHO.DUOC_ID = TM_DUOC.DUOC_ID
      LEFT JOIN TM_NGUONHANG NG ON NG.NGUONDUOC_ID = TT_TONKHO.NGUONDUOC_ID
      LEFT JOIN TM_KHODUOC KD ON KD.KHODUOC_ID = TT_TONKHO.KHODUOC_ID
      where TM_DUOC.BENHVIEN_ID = '$BENHVIEN_ID$' and TT_TONKHO.SOLUONG >= 0 <!--and TM_DUOC.TAMNGUNG = '0' -->
    </statement>
    <statement id="DAO00027_GetListDuocTonKhoCOM18UpdateRedis" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select distinct TT_TONKHO.DUOC_KEY, LTRIM(TT_TONKHO.KHODUOC_ID) as KHODUOC_ID, TM_DUOC.DUOC_ID, TM_LOAIDUOC.MALOAIDUOC,TM_DUOC.SOVISA,TM_DUOC.TYLE_VAT,TM_DUOC.COTOA,
      TM_DUOC.MADUOC, TM_DUOC.TENHANG, TM_DUOC.TENDUOCDAYDU, dvt.TENDONVITINH as DONVITINH,  TM_DUOC.DONVITINH_ID,TM_DUOC.BHYT,
      TM_DUOC.TENHOATCHAT,
      TM_DUOC.HAMLUONG, TM_DUOC.HANGSANXUAT, TM_DUOC.QUOCGIA, TM_DUOC.LOAIDUOC_ID, TM_DUOC.DUONGDUNG_ID,
      TM_TENDUOC.TENDUOC, TM_TENDUOC.TENDUOC_EN, TM_TENDUOC.MAQUOCTE, TM_TENDUOC.MAQUOCTEBT,
      TM_LOAIDUOC.LOAIVATTU_ID, TM_DUOC.BENHVIEN_ID,
      TT_TONKHO.SOLUONG, TM_DUOC.VTYT_PHANLOAI, TM_DUOC.PHAMVI, TT_TONKHO.NGUONDUOC_ID, NG.TENNGUONDUOC AS TENNGUONDUOC
      , TAMNGUNG = CASE WHEN TM_DUOC.TAMNGUNG = '1' OR NG.TAMNGUNG = '1' OR KD.TAMNGUNG = '1' THEN '1' ELSE '0' END
      , TM_DUOC.DANGTRINHBAY
      from TM_DUOC
      left join TM_DONVITINH dvt on dvt.DONVITINH_ID = TM_DUOC.DONVITINH_ID
      left join TM_TENDUOC on TM_DUOC.TENDUOC_ID = TM_TENDUOC.TENDUOC_ID and TM_DUOC.BENHVIEN_ID = '$BENHVIEN_ID$' and TM_DUOC.TAMNGUNG = '0'
      left join TM_LOAIDUOC on TM_LOAIDUOC.LOAIDUOC_ID = TM_DUOC.LOAIDUOC_ID and TM_LOAIDUOC.BENHVIEN_ID = '$BENHVIEN_ID$'
      left join TM_DUOC_HANDUNG on (TM_LOAIDUOC.LOAIVATTU_ID = TM_DUOC_HANDUNG.LOAIDUOC and TM_DUOC_HANDUNG.BENHVIEN_ID = '$BENHVIEN_ID$')
      inner join
      (select LTRIM(A.KHODUOC_ID) + '_' + LTRIM(A.DUOC_ID) + '_' + LTRIM(ISNULL(A.NGUONDUOC_ID,'')) as DUOC_KEY, A.KHODUOC_ID, A.DUOC_ID, A.NGUONDUOC_ID,
      SUM(isnull(A.SOLUONG,0)) as SOLUONG
      from
      (select SUM(SOLUONG) as SOLUONG, KHODUOC_ID, DUOC_ID, NGUONDUOC_ID from TT_DUOC_TONKHO
      where BENHVIEN_ID = '$BENHVIEN_ID$' group by KHODUOC_ID, DUOC_ID, NGUONDUOC_ID) A
      group by LTRIM(A.KHODUOC_ID) + '_' + LTRIM(A.DUOC_ID) + '_' + LTRIM(ISNULL(A.NGUONDUOC_ID,'')), A.KHODUOC_ID, A.DUOC_ID, NGUONDUOC_ID
      ) TT_TONKHO on TT_TONKHO.DUOC_ID = TM_DUOC.DUOC_ID
      LEFT JOIN TM_NGUONHANG NG ON NG.NGUONDUOC_ID = TT_TONKHO.NGUONDUOC_ID
      LEFT JOIN TM_KHODUOC KD ON KD.KHODUOC_ID = TT_TONKHO.KHODUOC_ID
      where TM_DUOC.BENHVIEN_ID = '$BENHVIEN_ID$' and TT_TONKHO.SOLUONG >= 0
      and TM_DUOC.DUOC_ID in ($LST_DUOC_ID$)
    </statement>
    <!--Revision:0,5a94e7c78446bc308d66f2e877bfaacc-->
    <statement id="DAO00027_GetListDuocTonKho_NhaThuoc" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select distinct TT_TONKHO.DUOC_KEY, LTRIM(TT_TONKHO.KHODUOC_ID) as KHODUOC_ID, TM_DUOC.DUOC_ID, TM_LOAIDUOC.MALOAIDUOC,TM_DUOC.SOVISA,TM_DUOC.TYLE_VAT,TM_DUOC.COTOA,
      CASE WHEN TM_DUOC.COTOA = 1 THEN N'Có'ELSE N'Không'END  as COTOA_NAME,
      TM_DUOC.MADUOC, TM_DUOC.TENHANG, TM_DUOC.TENDUOCDAYDU, TM_DUOC.DONVITINH,  TM_DUOC.DONVITINH_ID,TM_DUOC.BHYT,
      TM_DUOC.TENHOATCHAT, TM_DUOC.HAMLUONG, TM_DUOC.HANGSANXUAT, TM_DUOC.QUOCGIA, TM_DUOC.LOAIDUOC_ID, TM_DUOC.DUONGDUNG_ID,
      TM_TENDUOC.TENDUOC, TM_TENDUOC.TENDUOC_EN, TM_TENDUOC.MAQUOCTE, TM_TENDUOC.MAQUOCTEBT,
      TM_LOAIDUOC.LOAIVATTU_ID, TM_DUOC.BENHVIEN_ID,
      TT_TONKHO.SOLUONG, TM_DUOC.VTYT_PHANLOAI, TM_DUOC.PHAMVI, TT_TONKHO.NGUONDUOC_ID,NG.TENNGUONDUOC
      from TM_DUOC
      left join TM_DONVITINH dvt on dvt.DONVITINH_ID = TM_DUOC.DONVITINH_ID
      left join TM_TENDUOC on TM_DUOC.TENDUOC_ID = TM_TENDUOC.TENDUOC_ID and TM_DUOC.BENHVIEN_ID = '$BENHVIEN_ID$' and TM_DUOC.TAMNGUNG = '0' and TM_DUOC.NHATHUOC = '1'
      left join TM_LOAIDUOC on TM_LOAIDUOC.LOAIDUOC_ID = TM_DUOC.LOAIDUOC_ID and TM_LOAIDUOC.BENHVIEN_ID = '$BENHVIEN_ID$'
      left join TM_DUOC_HANDUNG on (TM_LOAIDUOC.LOAIVATTU_ID = TM_DUOC_HANDUNG.LOAIDUOC and TM_DUOC_HANDUNG.BENHVIEN_ID = '$BENHVIEN_ID$')
      inner join
      (select LTRIM(A.KHODUOC_ID) + '_' + LTRIM(A.DUOC_ID)  + '_' + LTRIM(ISNULL(A.NGUONDUOC_ID,'')) as DUOC_KEY, A.KHODUOC_ID, A.DUOC_ID, A.NGUONDUOC_ID,
      SUM(isnull(A.SOLUONG,0)) as SOLUONG
      from
      (select SUM(SOLUONG) as SOLUONG, KHODUOC_ID, DUOC_ID, NGUONDUOC_ID from TT_DUOC_TONKHO
      where BENHVIEN_ID = '$BENHVIEN_ID$' group by KHODUOC_ID, DUOC_ID, NGUONDUOC_ID) A
      group by LTRIM(A.KHODUOC_ID) + '_' + LTRIM(A.DUOC_ID) + '_' + LTRIM(A.NGUONDUOC_ID), A.KHODUOC_ID, A.DUOC_ID, A.NGUONDUOC_ID
      )
      TT_TONKHO on TT_TONKHO.DUOC_ID = TM_DUOC.DUOC_ID
      LEFT JOIN TM_NGUONHANG NG ON NG.NGUONDUOC_ID = TT_TONKHO.NGUONDUOC_ID
      where TT_TONKHO.SOLUONG >= 0 and TM_DUOC.BENHVIEN_ID = '$BENHVIEN_ID$'  and TM_DUOC.TAMNGUNG = '0' and TM_DUOC.NHATHUOC = '1'
    </statement>
    <!--Revision:0,ff15c2e2857bde3ab40b298fa0e8cd4d-->
    <statement id="DAO00027_GetListDuocKyGuiTonKho" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select  distinct TT_TONKHO.DUOC_KEY, LTRIM(TT_TONKHO.KHODUOC_ID) as KHODUOC_ID, TM_DUOC.DUOC_ID, TM_LOAIDUOC.MALOAIDUOC,TM_DUOC.SOVISA,TM_DUOC.TYLE_VAT,TM_DUOC.COTOA,
      TM_DUOC.MADUOC, TM_DUOC.TENHANG, TM_DUOC.TENDUOCDAYDU, dvt.TENDONVITINH as DONVITINH,  TM_DUOC.DONVITINH_ID,TM_DUOC.BHYT,TM_DUOC.PHAMVI,
      TM_DUOC.TENHOATCHAT, TM_DUOC.HAMLUONG, TM_DUOC.HANGSANXUAT, TM_DUOC.QUOCGIA, TM_DUOC.LOAIDUOC_ID, TM_DUOC.DUONGDUNG_ID,
      TM_TENDUOC.TENDUOC, TM_TENDUOC.TENDUOC_EN, TM_TENDUOC.MAQUOCTE, TM_TENDUOC.MAQUOCTEBT,
      TM_LOAIDUOC.LOAIVATTU_ID, TM_DUOC.BENHVIEN_ID,TT_TONKHO.SOLUONG, TT_TONKHO.NGUONDUOC_ID, NH.TENNGUONDUOC
      , TAMNGUNG = CASE WHEN TM_DUOC.TAMNGUNG = '1' OR nh.TAMNGUNG = '1' OR KD.TAMNGUNG = '1' THEN '1' ELSE '0' END
      , TM_DUOC.DANGTRINHBAY
      from TM_DUOC
      left join TM_DONVITINH dvt on dvt.DONVITINH_ID = TM_DUOC.DONVITINH_ID
      left join TM_TENDUOC on TM_DUOC.TENDUOC_ID = TM_TENDUOC.TENDUOC_ID and TM_DUOC.BENHVIEN_ID = '$BENHVIEN_ID$' and TM_DUOC.TAMNGUNG = '0'
      left join TM_LOAIDUOC on TM_LOAIDUOC.LOAIDUOC_ID = TM_DUOC.LOAIDUOC_ID and TM_LOAIDUOC.BENHVIEN_ID = '$BENHVIEN_ID$'
      left join TM_DUOC_HANDUNG on (TM_LOAIDUOC.LOAIVATTU_ID = TM_DUOC_HANDUNG.LOAIDUOC and TM_DUOC_HANDUNG.BENHVIEN_ID = '$BENHVIEN_ID$')
      inner join
      (select LTRIM(A.KHODUOC_ID) + '_' + LTRIM(A.DUOC_ID) + '_' + LTRIM(ISNULL(A.NGUONDUOC_ID,'')) as DUOC_KEY, A.KHODUOC_ID, A.DUOC_ID,A.NGUONDUOC_ID,
      SUM(isnull(A.SOLUONG,0)) as SOLUONG
      from
      (select SUM(SOLUONG) as SOLUONG, KHODUOC_ID, DUOC_ID, NGUONDUOC_ID from TT_DUOC_KYGUI_TONKHO
      where BENHVIEN_ID = '$BENHVIEN_ID$' group by KHODUOC_ID, DUOC_ID, NGUONDUOC_ID) A
      group by LTRIM(A.KHODUOC_ID) + '_' + LTRIM(A.DUOC_ID) + '_' + LTRIM(A.NGUONDUOC_ID), A.KHODUOC_ID, A.DUOC_ID, A.NGUONDUOC_ID)
      TT_TONKHO on TT_TONKHO.DUOC_ID = TM_DUOC.DUOC_ID
      left join TM_NGUONHANG nh on nh.NGUONDUOC_ID = TT_TONKHO.NGUONDUOC_ID and nh.BENHVIEN_ID = '$BENHVIEN_ID$'
      LEFT JOIN TM_KHODUOC KD ON KD.KHODUOC_ID = TT_TONKHO.KHODUOC_ID
      where TM_DUOC.BENHVIEN_ID = '$BENHVIEN_ID$' AND TT_TONKHO.SOLUONG >= 0 <!--AND  TM_DUOC.TAMNGUNG = '0'-->
    </statement>
    <!--Revision:0,5a83c738a236175bd4580f528387cca8-->
    <statement id="DAO00027_GetListDuocKyGuiTonKhoCOM33" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select  distinct TT_TONKHO.DUOC_KEY, LTRIM(TT_TONKHO.KHODUOC_ID) as KHODUOC_ID, TM_DUOC.DUOC_ID, TM_LOAIDUOC.MALOAIDUOC,TM_DUOC.SOVISA,TM_DUOC.TYLE_VAT,TM_DUOC.COTOA,
      TM_DUOC.MADUOC, TM_DUOC.TENHANG, TM_DUOC.TENDUOCDAYDU, dvt.TENDONVITINH as DONVITINH,  TM_DUOC.DONVITINH_ID,TM_DUOC.BHYT,TM_DUOC.PHAMVI,
      TM_DUOC.TENHOATCHAT, TM_DUOC.HAMLUONG, TM_DUOC.HANGSANXUAT, TM_DUOC.QUOCGIA, TM_DUOC.LOAIDUOC_ID, TM_DUOC.DUONGDUNG_ID,
      TM_TENDUOC.TENDUOC, TM_TENDUOC.TENDUOC_EN, TM_TENDUOC.MAQUOCTE, TM_TENDUOC.MAQUOCTEBT,
      TM_LOAIDUOC.LOAIVATTU_ID, TM_DUOC.BENHVIEN_ID,
      TT_TONKHO.SOLUONG, TT_TONKHO.NGUONDUOC_ID, nh.TENNGUONDUOC
      , TAMNGUNG = CASE WHEN TM_DUOC.TAMNGUNG = '1' OR nh.TAMNGUNG = '1' OR KD.TAMNGUNG = '1' THEN '1' ELSE '0' END
      from TM_DUOC
      left join TM_DONVITINH dvt on dvt.DONVITINH_ID = TM_DUOC.DONVITINH_ID
      left join TM_TENDUOC on TM_DUOC.TENDUOC_ID = TM_TENDUOC.TENDUOC_ID and TM_DUOC.BENHVIEN_ID = '$BENHVIEN_ID$' and TM_DUOC.TAMNGUNG = '0'
      left join TM_LOAIDUOC on TM_LOAIDUOC.LOAIDUOC_ID = TM_DUOC.LOAIDUOC_ID and TM_LOAIDUOC.BENHVIEN_ID = '$BENHVIEN_ID$'
      left join TM_DUOC_HANDUNG on (TM_LOAIDUOC.LOAIVATTU_ID = TM_DUOC_HANDUNG.LOAIDUOC and TM_DUOC_HANDUNG.BENHVIEN_ID = '$BENHVIEN_ID$')
      inner join
      (select LTRIM(A.KHODUOC_ID) + '_' + LTRIM(A.DUOC_ID) + '_' + LTRIM(ISNULL(A.NGUONDUOC_ID,'')) as DUOC_KEY, A.KHODUOC_ID, A.DUOC_ID ,A.NGUONDUOC_ID,
      SUM(isnull(A.SOLUONG,0)) as SOLUONG
      from
      (select SUM(SOLUONG) as SOLUONG, KHODUOC_ID, DUOC_ID, NGUONDUOC_ID from TT_DUOC_KYGUI_TONKHO
      where BENHVIEN_ID = '$BENHVIEN_ID$' group by KHODUOC_ID, DUOC_ID, NGUONDUOC_ID) A
      group by LTRIM(A.KHODUOC_ID) + '_' + LTRIM(A.DUOC_ID) + '_' + LTRIM(A.NGUONDUOC_ID) , A.KHODUOC_ID, A.DUOC_ID, A.NGUONDUOC_ID)
      TT_TONKHO on TT_TONKHO.DUOC_ID = TM_DUOC.DUOC_ID
      left join TM_NGUONHANG nh on nh.NGUONDUOC_ID = TT_TONKHO.NGUONDUOC_ID and nh.BENHVIEN_ID = '$BENHVIEN_ID$'
      LEFT JOIN TM_KHODUOC KD ON KD.KHODUOC_ID = TT_TONKHO.KHODUOC_ID
      where TT_TONKHO.SOLUONG >= 0 and TM_DUOC.BENHVIEN_ID = '$BENHVIEN_ID$' and TM_DUOC.DUOC_ID in ($DUOC_ID$)  <!--and TM_DUOC.TAMNGUNG = '0'-->
    </statement>
    <!--Revision:0,90e952e0e4638298a39ec0c92fd20ce0-->
    <statement id="DAO00027_GetListDuocTonKhoCOM18" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select  distinct TT_TONKHO.DUOC_KEY, LTRIM(TT_TONKHO.KHODUOC_ID) as KHODUOC_ID, TM_DUOC.DUOC_ID, TM_LOAIDUOC.MALOAIDUOC,TM_DUOC.SOVISA,TM_DUOC.TYLE_VAT,TM_DUOC.COTOA,
      TM_DUOC.MADUOC, TM_DUOC.TENHANG, TM_DUOC.TENDUOCDAYDU, dvt.TENDONVITINH as DONVITINH, TM_DUOC.DONVITINH_ID, TM_DUOC.BHYT,
      TM_DUOC.TENHOATCHAT, TM_DUOC.HAMLUONG, TM_DUOC.HANGSANXUAT, TM_DUOC.QUOCGIA, TM_DUOC.LOAIDUOC_ID, TM_DUOC.DUONGDUNG_ID,
      TM_TENDUOC.TENDUOC, TM_TENDUOC.TENDUOC_EN, TM_TENDUOC.MAQUOCTE, TM_TENDUOC.MAQUOCTEBT,
      TM_LOAIDUOC.LOAIVATTU_ID, TM_DUOC.BENHVIEN_ID,
      TT_TONKHO.SOLUONG, TM_DUOC.VTYT_PHANLOAI, TM_DUOC.PHAMVI, TT_TONKHO.NGUONDUOC_ID, NG.TENNGUONDUOC
      , TAMNGUNG = CASE WHEN TM_DUOC.TAMNGUNG = '1' OR NG.TAMNGUNG = '1' OR KD.TAMNGUNG = '1' THEN '1' ELSE '0' END
      , TM_DUOC.DANGTRINHBAY
      from TM_DUOC
      left join TM_DONVITINH dvt on dvt.DONVITINH_ID = TM_DUOC.DONVITINH_ID
      left join TM_TENDUOC on TM_DUOC.TENDUOC_ID = TM_TENDUOC.TENDUOC_ID and TM_DUOC.BENHVIEN_ID = '$BENHVIEN_ID$'  and TM_DUOC.TAMNGUNG = '0'
      left join TM_LOAIDUOC on TM_LOAIDUOC.LOAIDUOC_ID = TM_DUOC.LOAIDUOC_ID and TM_LOAIDUOC.BENHVIEN_ID = '$BENHVIEN_ID$'
      left join TM_DUOC_HANDUNG on (TM_LOAIDUOC.LOAIVATTU_ID = TM_DUOC_HANDUNG.LOAIDUOC and TM_DUOC_HANDUNG.BENHVIEN_ID = '$BENHVIEN_ID$')
      inner join
      (select LTRIM(A.KHODUOC_ID) + '_' + LTRIM(A.DUOC_ID) + '_' + LTRIM(ISNULL(A.NGUONDUOC_ID,'')) as DUOC_KEY, A.KHODUOC_ID, A.DUOC_ID ,a.NGUONDUOC_ID,
      SUM(isnull(A.SOLUONG,0)) as SOLUONG
      from
      (select SUM(SOLUONG) as SOLUONG, KHODUOC_ID, DUOC_ID, NGUONDUOC_ID from TT_DUOC_TONKHO
      where KHODUOC_ID in ($KHODUOC_ID$) and DUOC_ID in ($DUOC_ID$) group by KHODUOC_ID, DUOC_ID, NGUONDUOC_ID
      ) A
      where A.KHODUOC_ID in ($KHODUOC_ID$) and A.DUOC_ID in ($DUOC_ID$)
      group by LTRIM(A.KHODUOC_ID) + '_' + LTRIM(A.DUOC_ID) + '_' + LTRIM(A.NGUONDUOC_ID), A.KHODUOC_ID, A.DUOC_ID, A.NGUONDUOC_ID)
      TT_TONKHO on TT_TONKHO.DUOC_ID = TM_DUOC.DUOC_ID
      LEFT JOIN TM_NGUONHANG NG ON NG.NGUONDUOC_ID = TT_TONKHO.NGUONDUOC_ID
      LEFT JOIN TM_KHODUOC KD ON KD.KHODUOC_ID = TT_TONKHO.KHODUOC_ID
      where TM_DUOC.BENHVIEN_ID = '$BENHVIEN_ID$' and TM_DUOC.DUOC_ID in ($DUOC_ID$)  <!--and TM_DUOC.TAMNGUNG = '0'-->
    </statement>
    <!--Revision:0,681aabbebbd32e8f569b81187fade68b-->
    <statement id="DAO00027_GetListDuocTonKhoCOM70" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select  distinct TT_TONKHO.DUOC_KEY, LTRIM(TT_TONKHO.KHODUOC_ID) as KHODUOC_ID, TM_DUOC.DUOC_ID, TM_LOAIDUOC.MALOAIDUOC,TM_DUOC.SOVISA,TM_DUOC.TYLE_VAT,TM_DUOC.COTOA,
      TM_DUOC.MADUOC, TM_DUOC.TENHANG, TM_DUOC.TENDUOCDAYDU, dvt.TENDONVITINH as DONVITINH, TM_DUOC.DONVITINH_ID, TM_DUOC.BHYT,
      TM_DUOC.TENHOATCHAT, TM_DUOC.HAMLUONG, TM_DUOC.HANGSANXUAT, TM_DUOC.QUOCGIA, TM_DUOC.LOAIDUOC_ID, TM_DUOC.DUONGDUNG_ID,
      TM_TENDUOC.TENDUOC, TM_TENDUOC.TENDUOC_EN, TM_TENDUOC.MAQUOCTE, TM_TENDUOC.MAQUOCTEBT,
      TM_LOAIDUOC.LOAIVATTU_ID, TM_DUOC.BENHVIEN_ID,
      TT_TONKHO.SOLUONG, TM_DUOC.VTYT_PHANLOAI, TM_DUOC.PHAMVI, TT_TONKHO.NGUONDUOC_ID, NG.TENNGUONDUOC
      from TM_DUOC
      left join TM_DONVITINH dvt on dvt.DONVITINH_ID = TM_DUOC.DONVITINH_ID
      left join TM_TENDUOC on TM_DUOC.TENDUOC_ID = TM_TENDUOC.TENDUOC_ID and TM_DUOC.BENHVIEN_ID = '$BENHVIEN_ID$'  and TM_DUOC.TAMNGUNG = '0'
      left join TM_LOAIDUOC on TM_LOAIDUOC.LOAIDUOC_ID = TM_DUOC.LOAIDUOC_ID and TM_LOAIDUOC.BENHVIEN_ID = '$BENHVIEN_ID$'
      left join TM_DUOC_HANDUNG on (TM_LOAIDUOC.LOAIVATTU_ID = TM_DUOC_HANDUNG.LOAIDUOC and TM_DUOC_HANDUNG.BENHVIEN_ID = '$BENHVIEN_ID$')
      inner join
      (select LTRIM(A.KHODUOC_ID) + '_' + LTRIM(A.DUOC_ID) + '_' + LTRIM(ISNULL(A.NGUONDUOC_ID,'')) as DUOC_KEY, A.KHODUOC_ID, A.DUOC_ID,A.NGUONDUOC_ID,
      SUM(isnull(A.SOLUONG,0)) as SOLUONG
      from
      (select SUM(SOLUONG) as SOLUONG, KHODUOC_ID, DUOC_ID, NGUONDUOC_ID from TT_DUOC_TONKHO
      where KHODUOC_ID in ($KHODUOC_ID$) and DUOC_ID in ($DUOC_ID$) group by KHODUOC_ID, DUOC_ID, NGUONDUOC_ID
      ) A
      where A.KHODUOC_ID in ($KHODUOC_ID$) and A.DUOC_ID in ($DUOC_ID$)
      group by LTRIM(A.KHODUOC_ID) + '_' + LTRIM(A.DUOC_ID) + '_' + LTRIM(A.NGUONDUOC_ID), A.KHODUOC_ID, A.DUOC_ID, A.NGUONDUOC_ID)
      TT_TONKHO on TT_TONKHO.DUOC_ID = TM_DUOC.DUOC_ID
      LEFT JOIN TM_NGUONHANG NG ON NG.NGUONDUOC_ID = TT_TONKHO.NGUONDUOC_ID
      where TM_DUOC.BENHVIEN_ID = '$BENHVIEN_ID$' and TM_DUOC.DUOC_ID in ($DUOC_ID$)  and TM_DUOC.TAMNGUNG = '0'
    </statement>
    <!--Revision:0,4f01a515a85935d9ce51f5bdd761f45d-->
    <statement id="DAO00027_GetListDuocTonKhoVaBooking" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      declare @NGUONDUOC_MACDINH varchar(5) = '0';
      declare @TOAMUANGOAI int = 0;
      select @NGUONDUOC_MACDINH = isnull(VALUE,0) from TM_SYS_APPSETTINGS where CODE = 'PHA_NGUONDUOC'
      select @TOAMUANGOAI = isnull(VALUE,0) from TM_SYS_APPSETTINGS where CODE = 'OPD_TOAMUANGOAI_DUNGDANHMUC_DUOC'
      <!--Co danh muc duoc all-->
      if @TOAMUANGOAI = 1
      begin
      select  distinct '0' + '_' + LTRIM(d.DUOC_ID) + '_' + @NGUONDUOC_MACDINH as DUOC_KEY, 0 as PHAMVI_ID, @NGUONDUOC_MACDINH as NGUONDUOC_ID, null as TENNGUONDUOC, null as TINHTIEN, d.DUOC_ID, ld.MALOAIDUOC,
      d.SOVISA,d.TYLE_VAT,d.COTOA, d.MADUOC, d.TENHANG, d.TENDUOCDAYDU, d.DONVITINH as DONVITINH, d.BHYT,
      d.TENHOATCHAT, d.HAMLUONG, d.HANGSANXUAT, d.QUOCGIA, d.LOAIDUOC_ID, d.DUONGDUNG_ID, d.TINHTIEN_PTTT,
      ten.TENDUOC, ten.TENDUOC_EN, ten.MAQUOCTE, ten.MAQUOCTEBT,
      '' as BHYT_TEXT
      , ld.LOAIVATTU_ID
      , d.BENHVIEN_ID,
      999999999 as SOLUONG, d.VTYT_PHANLOAI, d.PHAMVI, d.SUASOLUONGTONGHOP, d.MADUOCBV, d.DANGTRINHBAY
      , TAMNGUNG = CASE WHEN d.TAMNGUNG = '1' THEN '1' ELSE '0' END
      from TM_DUOC d
      left join TM_DONVITINH dvt on dvt.DONVITINH_ID = d.DONVITINH_ID
      left join TM_TENDUOC ten on d.TENDUOC_ID = ten.TENDUOC_ID
      left join TM_LOAIDUOC ld on ld.LOAIDUOC_ID = d.LOAIDUOC_ID and ld.BENHVIEN_ID = '$BENHVIEN_ID$'
      left join TM_DUOC_HANDUNG hd on (ld.LOAIVATTU_ID = hd.LOAIDUOC  and hd.BENHVIEN_ID = '$BENHVIEN_ID$')
      union all
      select  distinct tk.DUOC_KEY, LTRIM(tk.PHAMVI_ID) as PHAMVI_ID, tk.NGUONDUOC_ID, nh.TENNGUONDUOC, nh.TINHTIEN, d.DUOC_ID, ld.MALOAIDUOC,
      d.SOVISA,d.TYLE_VAT,d.COTOA, d.MADUOC, d.TENHANG, d.TENDUOCDAYDU, d.DONVITINH as DONVITINH, d.BHYT,
      d.TENHOATCHAT, d.HAMLUONG, d.HANGSANXUAT, d.QUOCGIA, d.LOAIDUOC_ID, d.DUONGDUNG_ID, d.TINHTIEN_PTTT,
      ten.TENDUOC, ten.TENDUOC_EN, ten.MAQUOCTE, ten.MAQUOCTEBT,
      CASE WHEN d.BHYT = '1' THEN 'BHYT' ELSE '' END as BHYT_TEXT
      , ld.LOAIVATTU_ID
      , d.BENHVIEN_ID,
      tk.SOLUONG, d.VTYT_PHANLOAI, d.PHAMVI, d.SUASOLUONGTONGHOP, d.MADUOCBV, d.DANGTRINHBAY
      , TAMNGUNG = CASE WHEN d.TAMNGUNG = '1' OR nh.TAMNGUNG = '1' OR kd.TAMNGUNG = '1' THEN '1' ELSE '0' END
      from TM_DUOC d
      left join TM_DONVITINH dvt on dvt.DONVITINH_ID = d.DONVITINH_ID
      left join TM_TENDUOC ten on d.TENDUOC_ID = ten.TENDUOC_ID
      left join TM_LOAIDUOC ld on ld.LOAIDUOC_ID = d.LOAIDUOC_ID and ld.BENHVIEN_ID = '$BENHVIEN_ID$'
      left join TM_DUOC_HANDUNG hd on (ld.LOAIVATTU_ID = hd.LOAIDUOC  and hd.BENHVIEN_ID = '$BENHVIEN_ID$')
      inner join
      (
      select  LTRIM(pvsd.PHAMVI_ID)  + '_' + LTRIM(dtk.DUOC_ID) + '_' + LTRIM(ISNULL(dtk.NGUONDUOC_ID,'')) DUOC_KEY, (SUM(dtk.SOLUONG) - isnull(sum(A.SOLUONG),0) - isnull(sum(B.SOLUONG),0)) SOLUONG, pvsd.PHAMVI_ID, dtk.NGUONDUOC_ID, dtk.DUOC_ID
      from (select sum(soluong) soluong,duoc_id,nguonduoc_id,khoduoc_id,benhvien_id from TT_DUOC_TONKHO  group by duoc_id,nguonduoc_id,khoduoc_id,benhvien_id) dtk
      inner join TM_DUOC_PHAMVISD_MAPPING pvsd on dtk.KHODUOC_ID = pvsd.KHODUOC_ID
      left join (select sum(SOLUONG) SOLUONG, PHAMVI_ID, DUOC_ID, NGUONHANG_ID from  TT_DUOC_TONKHO_BOOK_NOITRU where TRANGTHAI != 'HUY'
      group by  PHAMVI_ID, DUOC_ID, NGUONHANG_ID) B on B.DUOC_ID = dtk.DUOC_ID and B.SOLUONG > 0 and B.PHAMVI_ID = pvsd.PHAMVI_ID and B.NGUONHANG_ID = dtk.NGUONDUOC_ID
      left join (select sum(SOLUONG) SOLUONG, PHAMVI_ID, DUOC_ID, NGUONHANG_ID from  TT_DUOC_TONKHO_BOOK_NGOAITRU where TRANGTHAI != 'HUY'
      group by  PHAMVI_ID, DUOC_ID, NGUONHANG_ID) A on A.DUOC_ID = dtk.DUOC_ID and A.SOLUONG > 0 and A.PHAMVI_ID = pvsd.PHAMVI_ID and A.NGUONHANG_ID = dtk.NGUONDUOC_ID
      where dtk.SOLUONG > 0 and dtk.BENHVIEN_ID = '$BENHVIEN_ID$'
      group by LTRIM(pvsd.PHAMVI_ID)  + '_' + LTRIM(dtk.DUOC_ID) + '_' + LTRIM(ISNULL(dtk.NGUONDUOC_ID,'')), pvsd.PHAMVI_ID, dtk.NGUONDUOC_ID, dtk.DUOC_ID
      ) tk on tk.DUOC_ID = d.DUOC_ID
      left join TM_DUOC_PHAMVISUDUNG kd on kd.PHAMVI_ID = tk.PHAMVI_ID and kd.BENHVIEN_ID = '$BENHVIEN_ID$'
      left join TM_NGUONHANG nh on nh.NGUONDUOC_ID = tk.NGUONDUOC_ID and nh.BENHVIEN_ID = '$BENHVIEN_ID$'
      where d.BENHVIEN_ID = '$BENHVIEN_ID$'  and tk.SOLUONG >= 0
      end
      else
      begin
      <!--khong co danh muc all-->  
      select  distinct tk.DUOC_KEY, LTRIM(tk.PHAMVI_ID) as PHAMVI_ID, tk.NGUONDUOC_ID, nh.TENNGUONDUOC, nh.TINHTIEN, d.DUOC_ID, ld.MALOAIDUOC,
      d.SOVISA,d.TYLE_VAT,d.COTOA, d.MADUOC, d.TENHANG, d.TENDUOCDAYDU, d.DONVITINH as DONVITINH, d.BHYT,
      d.TENHOATCHAT, d.HAMLUONG, d.HANGSANXUAT, d.QUOCGIA, d.LOAIDUOC_ID, d.DUONGDUNG_ID, d.TINHTIEN_PTTT,
      ten.TENDUOC, ten.TENDUOC_EN, ten.MAQUOCTE, ten.MAQUOCTEBT,
      CASE WHEN d.BHYT = '1' THEN 'BHYT' ELSE '' END as BHYT_TEXT
      , ld.LOAIVATTU_ID
      , d.BENHVIEN_ID,
      tk.SOLUONG, d.VTYT_PHANLOAI, d.PHAMVI, d.SUASOLUONGTONGHOP, d.MADUOCBV, d.DANGTRINHBAY
      , TAMNGUNG = CASE WHEN d.TAMNGUNG = '1' OR nh.TAMNGUNG = '1' OR kd.TAMNGUNG = '1' THEN '1' ELSE '0' END
      from TM_DUOC d
      left join TM_DONVITINH dvt on dvt.DONVITINH_ID = d.DONVITINH_ID
      left join TM_TENDUOC ten on d.TENDUOC_ID = ten.TENDUOC_ID
      left join TM_LOAIDUOC ld on ld.LOAIDUOC_ID = d.LOAIDUOC_ID and ld.BENHVIEN_ID = '$BENHVIEN_ID$'
      left join TM_DUOC_HANDUNG hd on (ld.LOAIVATTU_ID = hd.LOAIDUOC  and hd.BENHVIEN_ID = '$BENHVIEN_ID$')
      inner join
      (
      select  LTRIM(pvsd.PHAMVI_ID)  + '_' + LTRIM(dtk.DUOC_ID) + '_' + LTRIM(ISNULL(dtk.NGUONDUOC_ID,'')) DUOC_KEY, (SUM(dtk.SOLUONG) - isnull(sum(A.SOLUONG),0) - isnull(sum(B.SOLUONG),0)) SOLUONG, pvsd.PHAMVI_ID, dtk.NGUONDUOC_ID, dtk.DUOC_ID
      from (select sum(soluong) soluong,duoc_id,nguonduoc_id,khoduoc_id,benhvien_id from TT_DUOC_TONKHO  group by duoc_id,nguonduoc_id,khoduoc_id,benhvien_id) dtk
      inner join TM_DUOC_PHAMVISD_MAPPING pvsd on dtk.KHODUOC_ID = pvsd.KHODUOC_ID
      left join (select sum(SOLUONG) SOLUONG, PHAMVI_ID, DUOC_ID, NGUONHANG_ID from  TT_DUOC_TONKHO_BOOK_NOITRU where TRANGTHAI != 'HUY'
      group by  PHAMVI_ID, DUOC_ID, NGUONHANG_ID) B on B.DUOC_ID = dtk.DUOC_ID and B.SOLUONG > 0 and B.PHAMVI_ID = pvsd.PHAMVI_ID and B.NGUONHANG_ID = dtk.NGUONDUOC_ID
      left join (select sum(SOLUONG) SOLUONG, PHAMVI_ID, DUOC_ID, NGUONHANG_ID from  TT_DUOC_TONKHO_BOOK_NGOAITRU where TRANGTHAI != 'HUY'
      group by  PHAMVI_ID, DUOC_ID, NGUONHANG_ID) A on A.DUOC_ID = dtk.DUOC_ID and A.SOLUONG > 0 and A.PHAMVI_ID = pvsd.PHAMVI_ID and A.NGUONHANG_ID = dtk.NGUONDUOC_ID
      where dtk.SOLUONG > 0 and dtk.BENHVIEN_ID = '$BENHVIEN_ID$'
      group by LTRIM(pvsd.PHAMVI_ID)  + '_' + LTRIM(dtk.DUOC_ID) + '_' + LTRIM(ISNULL(dtk.NGUONDUOC_ID,'')), pvsd.PHAMVI_ID, dtk.NGUONDUOC_ID, dtk.DUOC_ID
      ) tk on tk.DUOC_ID = d.DUOC_ID
      left join TM_DUOC_PHAMVISUDUNG kd on kd.PHAMVI_ID = tk.PHAMVI_ID and kd.BENHVIEN_ID = '$BENHVIEN_ID$'
      left join TM_NGUONHANG nh on nh.NGUONDUOC_ID = tk.NGUONDUOC_ID and nh.BENHVIEN_ID = '$BENHVIEN_ID$'
      where d.BENHVIEN_ID = '$BENHVIEN_ID$'  and tk.SOLUONG >= 0
      end
    </statement>
    <!--Revision:0,454c7f02a19e15ad27805e5a7bafdb02-->
    <statement id="DAO00027_GetListDuocTonKhoVaBookingCOM23" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      declare @NGUONDUOC_MACDINH varchar(5) = '0';
      declare @TOAMUANGOAI int = 0;
      select @NGUONDUOC_MACDINH = isnull(VALUE,0) from TM_SYS_APPSETTINGS where CODE = 'PHA_NGUONDUOC'
      select @TOAMUANGOAI = isnull(VALUE,0) from TM_SYS_APPSETTINGS where CODE = 'OPD_TOAMUANGOAI_DUNGDANHMUC_DUOC'
      <!--Co danh muc duoc all-->
      if @TOAMUANGOAI = 1
      begin
      select  distinct '0' + '_' + LTRIM(d.DUOC_ID) + '_' + @NGUONDUOC_MACDINH as DUOC_KEY, 0 as PHAMVI_ID, @NGUONDUOC_MACDINH as NGUONDUOC_ID, null as TENNGUONDUOC, null as TINHTIEN, d.DUOC_ID, ld.MALOAIDUOC,
      d.SOVISA,d.TYLE_VAT,d.COTOA, d.MADUOC, d.TENHANG, d.TENDUOCDAYDU, dvt.TENDONVITINH as DONVITINH, d.BHYT,
      d.TENHOATCHAT, d.HAMLUONG, d.HANGSANXUAT, d.QUOCGIA, d.LOAIDUOC_ID, d.DUONGDUNG_ID, d.TINHTIEN_PTTT,
      ten.TENDUOC, ten.TENDUOC_EN, ten.MAQUOCTE, ten.MAQUOCTEBT,
      '' as BHYT_TEXT
      , ld.LOAIVATTU_ID
      , d.BENHVIEN_ID,
      999999999 as SOLUONG, d.VTYT_PHANLOAI, d.PHAMVI, d.SUASOLUONGTONGHOP, d.MADUOCBV, d.DANGTRINHBAY
      , TAMNGUNG = CASE WHEN d.TAMNGUNG = '1' THEN '1' ELSE '0' END
      from TM_DUOC d
      left join TM_DONVITINH dvt on dvt.DONVITINH_ID = d.DONVITINH_ID
      left join TM_TENDUOC ten on d.TENDUOC_ID = ten.TENDUOC_ID
      left join TM_LOAIDUOC ld on ld.LOAIDUOC_ID = d.LOAIDUOC_ID and ld.BENHVIEN_ID = '$BENHVIEN_ID$'
      left join TM_DUOC_HANDUNG hd on (ld.LOAIVATTU_ID = hd.LOAIDUOC  and hd.BENHVIEN_ID = '$BENHVIEN_ID$')
      where d.DUOC_ID in ($DUOC_ID$)
      union all
      select  distinct tk.DUOC_KEY, LTRIM(tk.PHAMVI_ID) as PHAMVI_ID, tk.NGUONDUOC_ID, nh.TENNGUONDUOC, nh.TINHTIEN, d.DUOC_ID, ld.MALOAIDUOC,
      d.SOVISA,d.TYLE_VAT,d.COTOA, d.MADUOC, d.TENHANG, d.TENDUOCDAYDU, dvt.TENDONVITINH as DONVITINH, d.BHYT,
      d.TENHOATCHAT, d.HAMLUONG, d.HANGSANXUAT, d.QUOCGIA, d.LOAIDUOC_ID, d.DUONGDUNG_ID, d.TINHTIEN_PTTT,
      ten.TENDUOC, ten.TENDUOC_EN, ten.MAQUOCTE, ten.MAQUOCTEBT,
      CASE WHEN d.BHYT = '1' THEN 'BHYT' ELSE '' END as BHYT_TEXT
      , ld.LOAIVATTU_ID
      , d.BENHVIEN_ID,
      tk.SOLUONG, d.VTYT_PHANLOAI, d.PHAMVI, d.SUASOLUONGTONGHOP, d.MADUOCBV, d.DANGTRINHBAY
      , TAMNGUNG = CASE WHEN d.TAMNGUNG = '1' OR nh.TAMNGUNG = '1' OR kd.TAMNGUNG = '1' THEN '1' ELSE '0' END
      from TM_DUOC d
      left join TM_DONVITINH dvt on dvt.DONVITINH_ID = d.DONVITINH_ID
      left join TM_TENDUOC ten on d.TENDUOC_ID = ten.TENDUOC_ID
      left join TM_LOAIDUOC ld on ld.LOAIDUOC_ID = d.LOAIDUOC_ID and ld.BENHVIEN_ID = '$BENHVIEN_ID$'
      left join TM_DUOC_HANDUNG hd on (ld.LOAIVATTU_ID = hd.LOAIDUOC  and hd.BENHVIEN_ID = '$BENHVIEN_ID$')
      inner join
      (
      select  LTRIM(pvsd.PHAMVI_ID)  + '_' + LTRIM(dtk.DUOC_ID) + '_' + LTRIM(ISNULL(dtk.NGUONDUOC_ID,'')) DUOC_KEY, (SUM(dtk.SOLUONG) - isnull(sum(A.SOLUONG),0) - isnull(sum(B.SOLUONG),0)) SOLUONG, pvsd.PHAMVI_ID, dtk.NGUONDUOC_ID, dtk.DUOC_ID
      from (select sum(soluong) soluong,duoc_id,nguonduoc_id,khoduoc_id,benhvien_id from TT_DUOC_TONKHO  group by duoc_id,nguonduoc_id,khoduoc_id,benhvien_id) dtk
      inner join TM_DUOC_PHAMVISD_MAPPING pvsd on dtk.KHODUOC_ID = pvsd.KHODUOC_ID
      left join (select sum(SOLUONG) SOLUONG, PHAMVI_ID, DUOC_ID, NGUONHANG_ID from  TT_DUOC_TONKHO_BOOK_NOITRU where TRANGTHAI != 'HUY'
      group by  PHAMVI_ID, DUOC_ID, NGUONHANG_ID) B on B.DUOC_ID = dtk.DUOC_ID and B.SOLUONG > 0 and B.PHAMVI_ID = pvsd.PHAMVI_ID and B.NGUONHANG_ID = dtk.NGUONDUOC_ID
      left join (select sum(SOLUONG) SOLUONG, PHAMVI_ID, DUOC_ID, NGUONHANG_ID from  TT_DUOC_TONKHO_BOOK_NGOAITRU where TRANGTHAI != 'HUY'
      group by  PHAMVI_ID, DUOC_ID, NGUONHANG_ID) A on A.DUOC_ID = dtk.DUOC_ID and A.SOLUONG > 0 and A.PHAMVI_ID = pvsd.PHAMVI_ID and A.NGUONHANG_ID = dtk.NGUONDUOC_ID
      where dtk.SOLUONG > 0 and dtk.BENHVIEN_ID = '$BENHVIEN_ID$'
      group by LTRIM(pvsd.PHAMVI_ID)  + '_' + LTRIM(dtk.DUOC_ID) + '_' + LTRIM(ISNULL(dtk.NGUONDUOC_ID,'')), pvsd.PHAMVI_ID, dtk.NGUONDUOC_ID, dtk.DUOC_ID
      ) tk on tk.DUOC_ID = d.DUOC_ID
      left join TM_DUOC_PHAMVISUDUNG kd on kd.PHAMVI_ID = tk.PHAMVI_ID and kd.BENHVIEN_ID = '$BENHVIEN_ID$'
      left join TM_NGUONHANG nh on nh.NGUONDUOC_ID = tk.NGUONDUOC_ID and nh.BENHVIEN_ID = '$BENHVIEN_ID$'
      where <!--tk.SOLUONG >= 0 and--> d.BENHVIEN_ID = '$BENHVIEN_ID$' and d.DUOC_ID in ($DUOC_ID$) and TK.PHAMVI_ID in ($PHAMVI_ID$)
      and tk.NGUONDUOC_ID in ($NGUONDUOC_ID$) <!--and d.BENHVIEN = '1'-->
      end
      else
      begin
      <!--khong co danh muc all-->
      select  distinct tk.DUOC_KEY, LTRIM(tk.PHAMVI_ID) as PHAMVI_ID, tk.NGUONDUOC_ID, nh.TENNGUONDUOC, nh.TINHTIEN, d.DUOC_ID, ld.MALOAIDUOC,
      d.SOVISA,d.TYLE_VAT,d.COTOA, d.MADUOC, d.TENHANG, d.TENDUOCDAYDU, dvt.TENDONVITINH as DONVITINH, d.BHYT,
      d.TENHOATCHAT, d.HAMLUONG, d.HANGSANXUAT, d.QUOCGIA, d.LOAIDUOC_ID, d.DUONGDUNG_ID, d.TINHTIEN_PTTT,
      ten.TENDUOC, ten.TENDUOC_EN, ten.MAQUOCTE, ten.MAQUOCTEBT,
      CASE WHEN d.BHYT = '1' THEN 'BHYT' ELSE '' END as BHYT_TEXT
      , ld.LOAIVATTU_ID
      , d.BENHVIEN_ID,
      tk.SOLUONG, d.VTYT_PHANLOAI, d.PHAMVI, d.SUASOLUONGTONGHOP, d.MADUOCBV, d.DANGTRINHBAY
      , TAMNGUNG = CASE WHEN d.TAMNGUNG = '1' OR nh.TAMNGUNG = '1' OR kd.TAMNGUNG = '1' THEN '1' ELSE '0' END
      from TM_DUOC d
      left join TM_DONVITINH dvt on dvt.DONVITINH_ID = d.DONVITINH_ID
      left join TM_TENDUOC ten on d.TENDUOC_ID = ten.TENDUOC_ID
      left join TM_LOAIDUOC ld on ld.LOAIDUOC_ID = d.LOAIDUOC_ID and ld.BENHVIEN_ID = '$BENHVIEN_ID$'
      left join TM_DUOC_HANDUNG hd on (ld.LOAIVATTU_ID = hd.LOAIDUOC  and hd.BENHVIEN_ID = '$BENHVIEN_ID$')
      inner join
      (
      select  LTRIM(pvsd.PHAMVI_ID)  + '_' + LTRIM(dtk.DUOC_ID) + '_' + LTRIM(ISNULL(dtk.NGUONDUOC_ID,'')) DUOC_KEY, (SUM(dtk.SOLUONG) - isnull(sum(A.SOLUONG),0) - isnull(sum(B.SOLUONG),0)) SOLUONG, pvsd.PHAMVI_ID, dtk.NGUONDUOC_ID, dtk.DUOC_ID
      from (select sum(soluong) soluong,duoc_id,nguonduoc_id,khoduoc_id,benhvien_id from TT_DUOC_TONKHO  group by duoc_id,nguonduoc_id,khoduoc_id,benhvien_id) dtk
      inner join TM_DUOC_PHAMVISD_MAPPING pvsd on dtk.KHODUOC_ID = pvsd.KHODUOC_ID
      left join (select sum(SOLUONG) SOLUONG, PHAMVI_ID, DUOC_ID, NGUONHANG_ID from  TT_DUOC_TONKHO_BOOK_NOITRU where TRANGTHAI != 'HUY'
      group by  PHAMVI_ID, DUOC_ID, NGUONHANG_ID) B on B.DUOC_ID = dtk.DUOC_ID and B.SOLUONG > 0 and B.PHAMVI_ID = pvsd.PHAMVI_ID and B.NGUONHANG_ID = dtk.NGUONDUOC_ID
      left join (select sum(SOLUONG) SOLUONG, PHAMVI_ID, DUOC_ID, NGUONHANG_ID from  TT_DUOC_TONKHO_BOOK_NGOAITRU where TRANGTHAI != 'HUY'
      group by  PHAMVI_ID, DUOC_ID, NGUONHANG_ID) A on A.DUOC_ID = dtk.DUOC_ID and A.SOLUONG > 0 and A.PHAMVI_ID = pvsd.PHAMVI_ID and A.NGUONHANG_ID = dtk.NGUONDUOC_ID
      where dtk.SOLUONG > 0 and dtk.BENHVIEN_ID = '$BENHVIEN_ID$'
      group by LTRIM(pvsd.PHAMVI_ID)  + '_' + LTRIM(dtk.DUOC_ID) + '_' + LTRIM(ISNULL(dtk.NGUONDUOC_ID,'')), pvsd.PHAMVI_ID, dtk.NGUONDUOC_ID, dtk.DUOC_ID
      ) tk on tk.DUOC_ID = d.DUOC_ID
      left join TM_DUOC_PHAMVISUDUNG kd on kd.PHAMVI_ID = tk.PHAMVI_ID and kd.BENHVIEN_ID = '$BENHVIEN_ID$'
      left join TM_NGUONHANG nh on nh.NGUONDUOC_ID = tk.NGUONDUOC_ID and nh.BENHVIEN_ID = '$BENHVIEN_ID$'
      where <!--tk.SOLUONG >= 0 and--> d.BENHVIEN_ID = '$BENHVIEN_ID$' and d.DUOC_ID in ($DUOC_ID$) and TK.PHAMVI_ID in ($PHAMVI_ID$)
      and tk.NGUONDUOC_ID in ($NGUONDUOC_ID$) <!--and d.BENHVIEN = '1'-->
      end
    </statement>
    <statement id="DAO00027_GetListDuocTonKhoVaBookingCOM23UpdateRedis" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      declare @NGUONDUOC_MACDINH varchar(5) = '0';
      declare @TOAMUANGOAI int = 0;
      select @NGUONDUOC_MACDINH = isnull(VALUE,0) from TM_SYS_APPSETTINGS where CODE = 'PHA_NGUONDUOC'
      select @TOAMUANGOAI = isnull(VALUE,0) from TM_SYS_APPSETTINGS where CODE = 'OPD_TOAMUANGOAI_DUNGDANHMUC_DUOC'
      <!--Co danh muc duoc all-->
      if @TOAMUANGOAI = 1
      begin
      select  distinct '0' + '_' + LTRIM(d.DUOC_ID) + '_' + @NGUONDUOC_MACDINH as DUOC_KEY, 0 as PHAMVI_ID, @NGUONDUOC_MACDINH as NGUONDUOC_ID, null as TENNGUONDUOC, null as TINHTIEN, d.DUOC_ID, ld.MALOAIDUOC,
      d.SOVISA,d.TYLE_VAT,d.COTOA, d.MADUOC, d.TENHANG, d.TENDUOCDAYDU, dvt.TENDONVITINH as DONVITINH, d.BHYT,
      d.TENHOATCHAT, d.HAMLUONG, d.HANGSANXUAT, d.QUOCGIA, d.LOAIDUOC_ID, d.DUONGDUNG_ID, d.TINHTIEN_PTTT,
      ten.TENDUOC, ten.TENDUOC_EN, ten.MAQUOCTE, ten.MAQUOCTEBT,
      '' as BHYT_TEXT
      , ld.LOAIVATTU_ID
      , d.BENHVIEN_ID,
      999999999 as SOLUONG, d.VTYT_PHANLOAI, d.PHAMVI, d.SUASOLUONGTONGHOP, d.MADUOCBV, d.DANGTRINHBAY
      , TAMNGUNG = CASE WHEN d.TAMNGUNG = '1' THEN '1' ELSE '0' END
      from TM_DUOC d
      left join TM_DONVITINH dvt on dvt.DONVITINH_ID = d.DONVITINH_ID
      left join TM_TENDUOC ten on d.TENDUOC_ID = ten.TENDUOC_ID
      left join TM_LOAIDUOC ld on ld.LOAIDUOC_ID = d.LOAIDUOC_ID and ld.BENHVIEN_ID = '$BENHVIEN_ID$'
      left join TM_DUOC_HANDUNG hd on (ld.LOAIVATTU_ID = hd.LOAIDUOC  and hd.BENHVIEN_ID = '$BENHVIEN_ID$')
      where d.DUOC_ID in ($LST_DUOC_ID$)
      union all
      select  distinct tk.DUOC_KEY, LTRIM(tk.PHAMVI_ID) as PHAMVI_ID, tk.NGUONDUOC_ID, nh.TENNGUONDUOC, nh.TINHTIEN, d.DUOC_ID, ld.MALOAIDUOC,
      d.SOVISA,d.TYLE_VAT,d.COTOA, d.MADUOC, d.TENHANG, d.TENDUOCDAYDU, dvt.TENDONVITINH as DONVITINH, d.BHYT,
      d.TENHOATCHAT, d.HAMLUONG, d.HANGSANXUAT, d.QUOCGIA, d.LOAIDUOC_ID, d.DUONGDUNG_ID, d.TINHTIEN_PTTT,
      ten.TENDUOC, ten.TENDUOC_EN, ten.MAQUOCTE, ten.MAQUOCTEBT,
      CASE WHEN d.BHYT = '1' THEN 'BHYT' ELSE '' END as BHYT_TEXT
      , ld.LOAIVATTU_ID
      , d.BENHVIEN_ID,
      tk.SOLUONG, d.VTYT_PHANLOAI, d.PHAMVI, d.SUASOLUONGTONGHOP, d.MADUOCBV, d.DANGTRINHBAY
      , TAMNGUNG = CASE WHEN d.TAMNGUNG = '1' OR nh.TAMNGUNG = '1' OR kd.TAMNGUNG = '1' THEN '1' ELSE '0' END
      from TM_DUOC d
      left join TM_DONVITINH dvt on dvt.DONVITINH_ID = d.DONVITINH_ID
      left join TM_TENDUOC ten on d.TENDUOC_ID = ten.TENDUOC_ID
      left join TM_LOAIDUOC ld on ld.LOAIDUOC_ID = d.LOAIDUOC_ID and ld.BENHVIEN_ID = '$BENHVIEN_ID$'
      left join TM_DUOC_HANDUNG hd on (ld.LOAIVATTU_ID = hd.LOAIDUOC  and hd.BENHVIEN_ID = '$BENHVIEN_ID$')
      inner join
      (
      select  LTRIM(pvsd.PHAMVI_ID)  + '_' + LTRIM(dtk.DUOC_ID) + '_' + LTRIM(ISNULL(dtk.NGUONDUOC_ID,'')) DUOC_KEY, (SUM(dtk.SOLUONG) - isnull(sum(A.SOLUONG),0) - isnull(sum(B.SOLUONG),0)) SOLUONG, pvsd.PHAMVI_ID, dtk.NGUONDUOC_ID, dtk.DUOC_ID
      from (select sum(soluong) soluong,duoc_id,nguonduoc_id,khoduoc_id,benhvien_id from TT_DUOC_TONKHO  group by duoc_id,nguonduoc_id,khoduoc_id,benhvien_id) dtk
      inner join TM_DUOC_PHAMVISD_MAPPING pvsd on dtk.KHODUOC_ID = pvsd.KHODUOC_ID
      left join (select sum(SOLUONG) SOLUONG, PHAMVI_ID, DUOC_ID, NGUONHANG_ID from  TT_DUOC_TONKHO_BOOK_NOITRU where TRANGTHAI != 'HUY'
      group by  PHAMVI_ID, DUOC_ID, NGUONHANG_ID) B on B.DUOC_ID = dtk.DUOC_ID and B.SOLUONG > 0 and B.PHAMVI_ID = pvsd.PHAMVI_ID and B.NGUONHANG_ID = dtk.NGUONDUOC_ID
      left join (select sum(SOLUONG) SOLUONG, PHAMVI_ID, DUOC_ID, NGUONHANG_ID from  TT_DUOC_TONKHO_BOOK_NGOAITRU where TRANGTHAI != 'HUY'
      group by  PHAMVI_ID, DUOC_ID, NGUONHANG_ID) A on A.DUOC_ID = dtk.DUOC_ID and A.SOLUONG > 0 and A.PHAMVI_ID = pvsd.PHAMVI_ID and A.NGUONHANG_ID = dtk.NGUONDUOC_ID
      where dtk.SOLUONG > 0 and dtk.BENHVIEN_ID = '$BENHVIEN_ID$'
      group by LTRIM(pvsd.PHAMVI_ID)  + '_' + LTRIM(dtk.DUOC_ID) + '_' + LTRIM(ISNULL(dtk.NGUONDUOC_ID,'')), pvsd.PHAMVI_ID, dtk.NGUONDUOC_ID, dtk.DUOC_ID
      ) tk on tk.DUOC_ID = d.DUOC_ID
      left join TM_DUOC_PHAMVISUDUNG kd on kd.PHAMVI_ID = tk.PHAMVI_ID and kd.BENHVIEN_ID = '$BENHVIEN_ID$'
      left join TM_NGUONHANG nh on nh.NGUONDUOC_ID = tk.NGUONDUOC_ID and nh.BENHVIEN_ID = '$BENHVIEN_ID$'
      where <!--tk.SOLUONG >= 0 and--> d.BENHVIEN_ID = '$BENHVIEN_ID$' and d.DUOC_ID in ($LST_DUOC_ID$)
      end
      else
      begin
      select  distinct tk.DUOC_KEY, LTRIM(tk.PHAMVI_ID) as PHAMVI_ID, tk.NGUONDUOC_ID, nh.TENNGUONDUOC, nh.TINHTIEN, d.DUOC_ID, ld.MALOAIDUOC,
      d.SOVISA,d.TYLE_VAT,d.COTOA, d.MADUOC, d.TENHANG, d.TENDUOCDAYDU, dvt.TENDONVITINH as DONVITINH, d.BHYT,
      d.TENHOATCHAT, d.HAMLUONG, d.HANGSANXUAT, d.QUOCGIA, d.LOAIDUOC_ID, d.DUONGDUNG_ID, d.TINHTIEN_PTTT,
      ten.TENDUOC, ten.TENDUOC_EN, ten.MAQUOCTE, ten.MAQUOCTEBT,
      CASE WHEN d.BHYT = '1' THEN 'BHYT' ELSE '' END as BHYT_TEXT
      , ld.LOAIVATTU_ID
      , d.BENHVIEN_ID,
      tk.SOLUONG, d.VTYT_PHANLOAI, d.PHAMVI, d.SUASOLUONGTONGHOP, d.MADUOCBV, d.DANGTRINHBAY
      , TAMNGUNG = CASE WHEN d.TAMNGUNG = '1' OR nh.TAMNGUNG = '1' OR kd.TAMNGUNG = '1' THEN '1' ELSE '0' END
      from TM_DUOC d
      left join TM_DONVITINH dvt on dvt.DONVITINH_ID = d.DONVITINH_ID
      left join TM_TENDUOC ten on d.TENDUOC_ID = ten.TENDUOC_ID
      left join TM_LOAIDUOC ld on ld.LOAIDUOC_ID = d.LOAIDUOC_ID and ld.BENHVIEN_ID = '$BENHVIEN_ID$'
      left join TM_DUOC_HANDUNG hd on (ld.LOAIVATTU_ID = hd.LOAIDUOC  and hd.BENHVIEN_ID = '$BENHVIEN_ID$')
      inner join
      (
      select  LTRIM(pvsd.PHAMVI_ID)  + '_' + LTRIM(dtk.DUOC_ID) + '_' + LTRIM(ISNULL(dtk.NGUONDUOC_ID,'')) DUOC_KEY, (SUM(dtk.SOLUONG) - isnull(sum(A.SOLUONG),0) - isnull(sum(B.SOLUONG),0)) SOLUONG, pvsd.PHAMVI_ID, dtk.NGUONDUOC_ID, dtk.DUOC_ID
      from (select sum(soluong) soluong,duoc_id,nguonduoc_id,khoduoc_id,benhvien_id from TT_DUOC_TONKHO  group by duoc_id,nguonduoc_id,khoduoc_id,benhvien_id) dtk
      inner join TM_DUOC_PHAMVISD_MAPPING pvsd on dtk.KHODUOC_ID = pvsd.KHODUOC_ID
      left join (select sum(SOLUONG) SOLUONG, PHAMVI_ID, DUOC_ID, NGUONHANG_ID from  TT_DUOC_TONKHO_BOOK_NOITRU where TRANGTHAI != 'HUY'
      group by  PHAMVI_ID, DUOC_ID, NGUONHANG_ID) B on B.DUOC_ID = dtk.DUOC_ID and B.SOLUONG > 0 and B.PHAMVI_ID = pvsd.PHAMVI_ID and B.NGUONHANG_ID = dtk.NGUONDUOC_ID
      left join (select sum(SOLUONG) SOLUONG, PHAMVI_ID, DUOC_ID, NGUONHANG_ID from  TT_DUOC_TONKHO_BOOK_NGOAITRU where TRANGTHAI != 'HUY'
      group by  PHAMVI_ID, DUOC_ID, NGUONHANG_ID) A on A.DUOC_ID = dtk.DUOC_ID and A.SOLUONG > 0 and A.PHAMVI_ID = pvsd.PHAMVI_ID and A.NGUONHANG_ID = dtk.NGUONDUOC_ID
      where dtk.SOLUONG > 0 and dtk.BENHVIEN_ID = '$BENHVIEN_ID$'
      group by LTRIM(pvsd.PHAMVI_ID)  + '_' + LTRIM(dtk.DUOC_ID) + '_' + LTRIM(ISNULL(dtk.NGUONDUOC_ID,'')), pvsd.PHAMVI_ID, dtk.NGUONDUOC_ID, dtk.DUOC_ID
      ) tk on tk.DUOC_ID = d.DUOC_ID
      left join TM_DUOC_PHAMVISUDUNG kd on kd.PHAMVI_ID = tk.PHAMVI_ID and kd.BENHVIEN_ID = '$BENHVIEN_ID$'
      left join TM_NGUONHANG nh on nh.NGUONDUOC_ID = tk.NGUONDUOC_ID and nh.BENHVIEN_ID = '$BENHVIEN_ID$'
      where <!--tk.SOLUONG >= 0 and--> d.BENHVIEN_ID = '$BENHVIEN_ID$' and d.DUOC_ID in ($LST_DUOC_ID$)
      end
    </statement>
    <statement id="DAO00027_GetListDuocTonKhoVaBookingCOM23UpdateRedis_TheoPhamvi" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      declare @TOAMUANGOAI int = 0;
      select @TOAMUANGOAI = isnull(VALUE,0) from TM_SYS_APPSETTINGS where CODE = 'OPD_TOAMUANGOAI_DUNGDANHMUC_DUOC'
      <!--Co danh muc duoc all-->
      if @TOAMUANGOAI = 1
      begin
      select  distinct '0' + '_' + LTRIM(d.DUOC_ID) + '_' + '0' as DUOC_KEY, 999999999 as SOLUONG
      from TM_DUOC d
      left join TM_DONVITINH dvt on dvt.DONVITINH_ID = d.DONVITINH_ID
      left join TM_TENDUOC ten on d.TENDUOC_ID = ten.TENDUOC_ID
      left join TM_LOAIDUOC ld on ld.LOAIDUOC_ID = d.LOAIDUOC_ID and ld.BENHVIEN_ID = '$BENHVIEN_ID$'
      left join TM_DUOC_HANDUNG hd on (ld.LOAIVATTU_ID = hd.LOAIDUOC  and hd.BENHVIEN_ID = '$BENHVIEN_ID$')
      where #PHAMVI_ID# = 0
      union all
      select distinct tk.DUOC_KEY, tk.SOLUONG
      from TM_DUOC d
      left join TM_DONVITINH dvt on dvt.DONVITINH_ID = d.DONVITINH_ID
      left join TM_TENDUOC ten on d.TENDUOC_ID = ten.TENDUOC_ID
      left join TM_LOAIDUOC ld on ld.LOAIDUOC_ID = d.LOAIDUOC_ID and ld.BENHVIEN_ID = '$BENHVIEN_ID$'
      left join TM_DUOC_HANDUNG hd on (ld.LOAIVATTU_ID = hd.LOAIDUOC  and hd.BENHVIEN_ID = '$BENHVIEN_ID$')
      inner join
      (
      select  LTRIM(pvsd.PHAMVI_ID)  + '_' + LTRIM(dtk.DUOC_ID) + '_' + LTRIM(ISNULL(dtk.NGUONDUOC_ID,'')) DUOC_KEY, (SUM(dtk.SOLUONG) - isnull(sum(A.SOLUONG),0) - isnull(sum(B.SOLUONG),0)) SOLUONG, pvsd.PHAMVI_ID, dtk.NGUONDUOC_ID, dtk.DUOC_ID
      from (select sum(soluong) soluong,duoc_id,nguonduoc_id,khoduoc_id,benhvien_id from TT_DUOC_TONKHO  group by duoc_id,nguonduoc_id,khoduoc_id,benhvien_id) dtk
      inner join TM_DUOC_PHAMVISD_MAPPING pvsd on dtk.KHODUOC_ID = pvsd.KHODUOC_ID
      left join (select sum(SOLUONG) SOLUONG, PHAMVI_ID, DUOC_ID, NGUONHANG_ID from  TT_DUOC_TONKHO_BOOK_NOITRU where TRANGTHAI != 'HUY'
      group by  PHAMVI_ID, DUOC_ID, NGUONHANG_ID) B on B.DUOC_ID = dtk.DUOC_ID and B.PHAMVI_ID = pvsd.PHAMVI_ID and B.NGUONHANG_ID = dtk.NGUONDUOC_ID
      left join (select sum(SOLUONG) SOLUONG, PHAMVI_ID, DUOC_ID, NGUONHANG_ID from  TT_DUOC_TONKHO_BOOK_NGOAITRU where TRANGTHAI != 'HUY'
      group by  PHAMVI_ID, DUOC_ID, NGUONHANG_ID) A on A.DUOC_ID = dtk.DUOC_ID and A.PHAMVI_ID = pvsd.PHAMVI_ID and A.NGUONHANG_ID = dtk.NGUONDUOC_ID
      where dtk.BENHVIEN_ID = '$BENHVIEN_ID$'
      group by LTRIM(pvsd.PHAMVI_ID)  + '_' + LTRIM(dtk.DUOC_ID) + '_' + LTRIM(ISNULL(dtk.NGUONDUOC_ID,'')), pvsd.PHAMVI_ID, dtk.NGUONDUOC_ID, dtk.DUOC_ID
      ) tk on tk.DUOC_ID = d.DUOC_ID
      left join TM_DUOC_PHAMVISUDUNG kd on kd.PHAMVI_ID = tk.PHAMVI_ID and kd.BENHVIEN_ID = '$BENHVIEN_ID$'
      left join TM_NGUONHANG nh on nh.NGUONDUOC_ID = tk.NGUONDUOC_ID and nh.BENHVIEN_ID = '$BENHVIEN_ID$'
      where d.BENHVIEN_ID = '$BENHVIEN_ID$' and tk.PHAMVI_ID = #PHAMVI_ID#
      end
      else
      begin
      select distinct tk.DUOC_KEY, tk.SOLUONG
      from TM_DUOC d
      left join TM_DONVITINH dvt on dvt.DONVITINH_ID = d.DONVITINH_ID
      left join TM_TENDUOC ten on d.TENDUOC_ID = ten.TENDUOC_ID
      left join TM_LOAIDUOC ld on ld.LOAIDUOC_ID = d.LOAIDUOC_ID and ld.BENHVIEN_ID = '$BENHVIEN_ID$'
      left join TM_DUOC_HANDUNG hd on (ld.LOAIVATTU_ID = hd.LOAIDUOC  and hd.BENHVIEN_ID = '$BENHVIEN_ID$')
      inner join
      (
      select  LTRIM(pvsd.PHAMVI_ID)  + '_' + LTRIM(dtk.DUOC_ID) + '_' + LTRIM(ISNULL(dtk.NGUONDUOC_ID,'')) DUOC_KEY, (SUM(dtk.SOLUONG) - isnull(sum(A.SOLUONG),0) - isnull(sum(B.SOLUONG),0)) SOLUONG, pvsd.PHAMVI_ID, dtk.NGUONDUOC_ID, dtk.DUOC_ID
      from (select sum(soluong) soluong,duoc_id,nguonduoc_id,khoduoc_id,benhvien_id from TT_DUOC_TONKHO  group by duoc_id,nguonduoc_id,khoduoc_id,benhvien_id) dtk
      inner join TM_DUOC_PHAMVISD_MAPPING pvsd on dtk.KHODUOC_ID = pvsd.KHODUOC_ID
      left join (select sum(SOLUONG) SOLUONG, PHAMVI_ID, DUOC_ID, NGUONHANG_ID from  TT_DUOC_TONKHO_BOOK_NOITRU where TRANGTHAI != 'HUY'
      group by  PHAMVI_ID, DUOC_ID, NGUONHANG_ID) B on B.DUOC_ID = dtk.DUOC_ID and B.PHAMVI_ID = pvsd.PHAMVI_ID and B.NGUONHANG_ID = dtk.NGUONDUOC_ID
      left join (select sum(SOLUONG) SOLUONG, PHAMVI_ID, DUOC_ID, NGUONHANG_ID from  TT_DUOC_TONKHO_BOOK_NGOAITRU where TRANGTHAI != 'HUY'
      group by  PHAMVI_ID, DUOC_ID, NGUONHANG_ID) A on A.DUOC_ID = dtk.DUOC_ID and A.PHAMVI_ID = pvsd.PHAMVI_ID and A.NGUONHANG_ID = dtk.NGUONDUOC_ID
      where dtk.BENHVIEN_ID = '$BENHVIEN_ID$'
      group by LTRIM(pvsd.PHAMVI_ID)  + '_' + LTRIM(dtk.DUOC_ID) + '_' + LTRIM(ISNULL(dtk.NGUONDUOC_ID,'')), pvsd.PHAMVI_ID, dtk.NGUONDUOC_ID, dtk.DUOC_ID
      ) tk on tk.DUOC_ID = d.DUOC_ID
      left join TM_DUOC_PHAMVISUDUNG kd on kd.PHAMVI_ID = tk.PHAMVI_ID and kd.BENHVIEN_ID = '$BENHVIEN_ID$'
      left join TM_NGUONHANG nh on nh.NGUONDUOC_ID = tk.NGUONDUOC_ID and nh.BENHVIEN_ID = '$BENHVIEN_ID$'
      where d.BENHVIEN_ID = '$BENHVIEN_ID$' and tk.PHAMVI_ID = #PHAMVI_ID#
      end
    </statement>
    <!--Revision:0,3969e186d69a87544867f07fbd748c33-->
    <statement id="DAO00027_GetListDuyetToaThuoc" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select distinct A.SOTIEPNHAN, A.TRAITUYEN, A.NGAYMIENDONGCHITRA, A.TIEPNHAN_ID, A.DOITUONG_ID,
      A.LOAITHANHVIEN_ID, A.SUDUNG_BHTN, A.THE_ID, A.THANHVIEN_ID, A.VIP, A.NGUON_BENHNHAN_ID, A.BAOLANH_VIENPHI,
      B.*, 'NGOAITRU' as LOAITOA, C.PHAMVI_ID as PHAMVI_ID
      from TT_NGOAITRU_KHAMBENH_TOATHUOC C
      inner join TT_NGOAITRU_KHAMBENH D on C.KHAMBENH_ID = D.KHAMBENH_ID
      inner join TT_TIEPNHAN A on D.TIEPNHAN_ID = A.TIEPNHAN_ID
      inner join TT_BENHNHAN B on B.BENHNHAN_ID = A.BENHNHAN_ID
      where C.DUYET = '1' and C.TRANGTHAI = 'CHUAXUAT' and C.BENHVIEN_ID = '$BENHVIEN_ID$' and (C.LOAITOATHUOC = 'BV' or C.LOAITOATHUOC = 'MP' or C.LOAITOATHUOC = 'KTBV')
      union
      select distinct A.SOTIEPNHAN, A.TRAITUYEN, A.NGAYMIENDONGCHITRA, A.TIEPNHAN_ID, A.DOITUONG_ID,
      A.LOAITHANHVIEN_ID, A.SUDUNG_BHTN, A.THE_ID, A.THANHVIEN_ID, A.VIP, A.NGUON_BENHNHAN_ID, A.BAOLANH_VIENPHI,
      B.*, 'MUANGOAI' as LOAITOA, C.PHAMVI_ID as PHAMVI_ID
      from TT_NGOAITRU_KHAMBENH_TOATHUOC C
      inner join TT_NGOAITRU_KHAMBENH D on C.KHAMBENH_ID = D.KHAMBENH_ID
      inner join TT_TIEPNHAN A on D.TIEPNHAN_ID = A.TIEPNHAN_ID and (A.TRANGTHAI = 'DATIEPNHAN' or A.TRANGTHAI = 'NOITRU' or A.TRANGTHAI = 'CAPCUU' or A.TRANGTHAI = 'NGOAITRU')
      inner join TT_BENHNHAN B on B.BENHNHAN_ID = A.BENHNHAN_ID
      where C.DUYET = '1' and C.TRANGTHAI = 'CHUAXUAT' and C.BENHVIEN_ID = '$BENHVIEN_ID$' and (A.SOBHYT is null or A.SOBHYT = '')
      union
      select distinct A.SOTIEPNHAN, A.TRAITUYEN, A.NGAYMIENDONGCHITRA, A.TIEPNHAN_ID, A.DOITUONG_ID,
      A.LOAITHANHVIEN_ID, A.SUDUNG_BHTN, A.THE_ID, A.THANHVIEN_ID, A.VIP, A.NGUON_BENHNHAN_ID, A.BAOLANH_VIENPHI,
      B.*, 'NOITRU' as LOAITOA, C.PHAMVI_ID as PHAMVI_ID
      from TT_NOITRU_TOATHUOC C
      inner join TT_TIEPNHAN A on C.TIEPNHAN_ID = A.TIEPNHAN_ID and (A.TRANGTHAI = 'DATIEPNHAN' or A.TRANGTHAI = 'NOITRU' or A.TRANGTHAI = 'CAPCUU' or A.TRANGTHAI = 'NGOAITRU')
      inner join TT_BENHNHAN B on B.BENHNHAN_ID = A.BENHNHAN_ID
      where (C.TRANGTHAI = 'DADUYET' or C.TRANGTHAI = 'CHUAXUAT') and C.BENHVIEN_ID = '$BENHVIEN_ID$' and (A.SOBHYT is not null or A.SOBHYT != '')
      union
      select distinct A.SOTIEPNHAN, A.TRAITUYEN, A.NGAYMIENDONGCHITRA, A.TIEPNHAN_ID, A.DOITUONG_ID,
      A.LOAITHANHVIEN_ID, A.SUDUNG_BHTN, A.THE_ID, A.THANHVIEN_ID, A.VIP, A.NGUON_BENHNHAN_ID, A.BAOLANH_VIENPHI,
      B.*, 'MUANGOAI' as LOAITOA, C.PHAMVI_ID as PHAMVI_ID
      from TT_NOITRU_TOATHUOC C
      inner join TT_TIEPNHAN A on C.TIEPNHAN_ID = A.TIEPNHAN_ID and (A.TRANGTHAI = 'DATIEPNHAN' or A.TRANGTHAI = 'NOITRU' or A.TRANGTHAI = 'CAPCUU' or A.TRANGTHAI = 'NGOAITRU')
      inner join TT_BENHNHAN B on B.BENHNHAN_ID = A.BENHNHAN_ID
      inner join TT_NOITRU_BENHAN D on D.TIEPNHAN_ID = C.TIEPNHAN_ID
      where (C.TRANGTHAI = 'DADUYET' or C.TRANGTHAI = 'CHUAXUAT') and C.BENHVIEN_ID = '$BENHVIEN_ID$' and (A.SOBHYT is null or A.SOBHYT = '') and D.TRANGTHAI != 'DANGDIEUTRI'
    </statement>
    <!--Revision:0,a45a294c852dc27877ee9971a8d3c9d7-->
    <statement id="DAO00027_GetListDuyetToaThuocBHYTCOM24_Ngoai" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select distinct A.SOTIEPNHAN, A.TRAITUYEN, A.NGAYMIENDONGCHITRA, A.TIEPNHAN_ID, A.DOITUONG_ID,
      A.LOAITHANHVIEN_ID, A.SUDUNG_BHTN, A.THE_ID, A.THANHVIEN_ID, A.VIP, A.NGUON_BENHNHAN_ID, A.BAOLANH_VIENPHI,
      B.*, 'NGOAITRU' as LOAITOA, C.PHAMVI_ID as PHAMVI_ID
      from TT_NGOAITRU_KHAMBENH_TOATHUOC C
      inner join TT_NGOAITRU_KHAMBENH D on C.KHAMBENH_ID = D.KHAMBENH_ID
      inner join TT_TIEPNHAN A on D.TIEPNHAN_ID = A.TIEPNHAN_ID
      <!--and (A.TRANGTHAI = 'DATIEPNHAN' or A.TRANGTHAI = 'NOITRU' or A.TRANGTHAI = 'CAPCUU' or A.TRANGTHAI = 'NGOAITRU')-->
      inner join TT_BENHNHAN B on B.BENHNHAN_ID = A.BENHNHAN_ID
      where C.DUYET = '1' and C.TRANGTHAI = 'CHUAXUAT' and C.BENHVIEN_ID = '$BENHVIEN_ID$' and C.KHAMBENH_TOATHUOC_ID = '$KHAMBENH_TOATHUOC_ID$' and (C.LOAITOATHUOC = 'BV' or C.LOAITOATHUOC = 'MP' or C.LOAITOATHUOC = 'KTBV')
      <!--(A.SOBHYT is not null or A.SOBHYT != '')-->
    </statement>
     <statement id="DAO00027_GetListDuyetToaThuocBHYTCOM24_Ngoai_ForDelete" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select distinct A.SOTIEPNHAN, A.TRAITUYEN, A.NGAYMIENDONGCHITRA, A.TIEPNHAN_ID, A.DOITUONG_ID,
      A.LOAITHANHVIEN_ID, A.SUDUNG_BHTN, A.THE_ID, A.THANHVIEN_ID, A.VIP, A.NGUON_BENHNHAN_ID, A.BAOLANH_VIENPHI,
      B.*, 'NGOAITRU' as LOAITOA, C.PHAMVI_ID as PHAMVI_ID
      from TT_NGOAITRU_KHAMBENH_TOATHUOC C
      inner join TT_NGOAITRU_KHAMBENH D on C.KHAMBENH_ID = D.KHAMBENH_ID
      inner join TT_TIEPNHAN A on D.TIEPNHAN_ID = A.TIEPNHAN_ID      
      inner join TT_BENHNHAN B on B.BENHNHAN_ID = A.BENHNHAN_ID
      where C.KHAMBENH_TOATHUOC_ID = '$KHAMBENH_TOATHUOC_ID$'      
    </statement>
    <!--Revision:0,d4880d456ee7e65c764680ff080348cc-->
    <statement id="DAO00027_GetListDuyetToaThuocBHYTCOM24_Noi" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select distinct A.SOTIEPNHAN, A.TRAITUYEN, A.NGAYMIENDONGCHITRA, A.TIEPNHAN_ID, A.DOITUONG_ID,
      A.LOAITHANHVIEN_ID, A.SUDUNG_BHTN, A.THE_ID, A.THANHVIEN_ID, A.VIP, A.NGUON_BENHNHAN_ID, A.BAOLANH_VIENPHI,
      B.*, 'NOITRU' as LOAITOA, C.PHAMVI_ID as PHAMVI_ID
      from TT_NOITRU_TOATHUOC C
      inner join TT_TIEPNHAN A on C.TIEPNHAN_ID = A.TIEPNHAN_ID and (A.TRANGTHAI = 'DATIEPNHAN' or A.TRANGTHAI = 'NOITRU' or A.TRANGTHAI = 'CAPCUU' or A.TRANGTHAI = 'NGOAITRU')
      inner join TT_BENHNHAN B on B.BENHNHAN_ID = A.BENHNHAN_ID
      where (C.TRANGTHAI = 'DADUYET' or C.TRANGTHAI = 'CHUAXUAT' or C.TRANGTHAI = 'DAXUAT') and C.BENHVIEN_ID = '$BENHVIEN_ID$' and C.KHAMBENH_ID = '$KHAMBENH_TOATHUOC_ID$' and (A.SOBHYT is not null or A.SOBHYT != '')
    </statement>
    <!--Revision:0,81905d86b92156c8cf6580b005b98405-->
    <statement id="DAO00027_GetListDuyetToaThuocBHYTCOM24_MuaNgoai" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select distinct A.SOTIEPNHAN, A.TRAITUYEN, A.NGAYMIENDONGCHITRA, A.TIEPNHAN_ID, A.DOITUONG_ID,
      A.LOAITHANHVIEN_ID, A.SUDUNG_BHTN, A.THE_ID, A.THANHVIEN_ID, A.VIP, A.NGUON_BENHNHAN_ID, A.BAOLANH_VIENPHI,
      B.*, 'MUANGOAI' as LOAITOA, C.KHOXUAT_ID as KHOXUAT_ID, C.PHAMVI_ID
      from TT_NGOAITRU_KHAMBENH_TOATHUOC C
      inner join TT_NGOAITRU_KHAMBENH D on C.KHAMBENH_ID = D.KHAMBENH_ID
      inner join TT_TIEPNHAN A on D.TIEPNHAN_ID = A.TIEPNHAN_ID and (A.TRANGTHAI = 'DATIEPNHAN' or A.TRANGTHAI = 'NOITRU' or A.TRANGTHAI = 'CAPCUU' or A.TRANGTHAI = 'NGOAITRU' or A.TRANGTHAI = 'HOANTHANH')
      inner join TT_BENHNHAN B on B.BENHNHAN_ID = A.BENHNHAN_ID
      where (C.DUYET = '1' or C.TRANGTHAI = 'CHUAXUAT'  or C.TRANGTHAI = 'DAXUAT') and C.BENHVIEN_ID = '$BENHVIEN_ID$' and C.KHAMBENH_TOATHUOC_ID = '$KHAMBENH_TOATHUOC_ID$' and (C.LOAITOATHUOC = 'MN' or C.LOAITOATHUOC = 'TV')
      union
      select distinct A.SOTIEPNHAN, A.TRAITUYEN, A.NGAYMIENDONGCHITRA, A.TIEPNHAN_ID, A.DOITUONG_ID,
      A.LOAITHANHVIEN_ID, A.SUDUNG_BHTN, A.THE_ID, A.THANHVIEN_ID, A.VIP, A.NGUON_BENHNHAN_ID, A.BAOLANH_VIENPHI,
      B.*, 'MUANGOAI' as LOAITOA, C.KHOPHAT_ID as KHOXUAT_ID, C.PHAMVI_ID
      from TT_NOITRU_TOATHUOC C
      inner join TT_TIEPNHAN A on C.TIEPNHAN_ID = A.TIEPNHAN_ID and (A.TRANGTHAI = 'DATIEPNHAN' or A.TRANGTHAI = 'NOITRU' or A.TRANGTHAI = 'CAPCUU' or A.TRANGTHAI = 'NGOAITRU' or A.TRANGTHAI = 'HOANTHANH')
      inner join TT_BENHNHAN B on B.BENHNHAN_ID = A.BENHNHAN_ID
      inner join TT_NOITRU_BENHAN D on D.TIEPNHAN_ID = C.TIEPNHAN_ID
      inner join TT_NOITRU_KHAMBENH KB on KB.KHAMBENH_ID = C.KHAMBENH_ID
      where (C.TRANGTHAI = 'DADUYET' or C.TRANGTHAI = 'CHUAXUAT'  or C.TRANGTHAI = 'DAXUAT' ) and C.BENHVIEN_ID = '$BENHVIEN_ID$' and C.KHAMBENH_ID = '$KHAMBENH_TOATHUOC_ID$' and KB.ISTHUOCBV = '0' and D.TRANGTHAI != 'DANGDIEUTRI'
    </statement>
    <!--Revision:0,2c639c077dcb07f94907e2268a7422ee-->
    <statement id="DAO00027_GetListVatTuYteKTC" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      SELECT DV.*
      FROM TM_DICHVU_VATTU AS DV
      INNER JOIN TM_DUOC AS D ON D.DUOC_ID = DV.DUOC_ID AND D.TAMNGUNG = '0' AND D.BENHVIEN_ID = '$BENHVIEN_ID$'
      WHERE
      DV.TAMNGUNG = '0'
      AND DICHVU_ID in
      (
      select DICHVU_ID from TM_DICHVU_PHANNHOMDICHVU
      where
      <!--PHANNHOMDICHVU_ID in (select PHANNHOMDICHVU_ID from TM_PHANNHOMDICHVU where MAPHANNHOMDICHVU = 'KTC')-->
      exists (select PHANNHOMDICHVU_ID from TM_PHANNHOMDICHVU where MAPHANNHOMDICHVU = 'KTC' and TM_DICHVU_PHANNHOMDICHVU.PHANNHOMDICHVU_ID = PHANNHOMDICHVU_ID)
      )
      AND DV.BENHVIEN_ID = '$BENHVIEN_ID$'
    </statement>
    <!--Revision:0,28db8ed05a8bb33560704ad7e42926a6-->
    <statement id="DAO00027_GetListVatTuYtelaStent" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      <!--select * from TM_DUOC where TAMNGUNG = '0' AND BENHVIEN_ID = '$BENHVIEN_ID$' and VTYT_PHANLOAI in (select DICTIONARY_ID from LST_DICTIONARY where DICTIONARY_TYPE_CODE like 'Phanloai_VTYT' and DICTIONARY_CODE = '1')-->
      select * from TM_DUOC where TAMNGUNG = '0' AND BENHVIEN_ID = '$BENHVIEN_ID$'
      and exists (select DICTIONARY_ID from LST_DICTIONARY where TM_DUOC.VTYT_PHANLOAI = DICTIONARY_ID and DICTIONARY_TYPE_CODE like 'Phanloai_VTYT' and DICTIONARY_CODE = '1')
    </statement>
    <statement id="DAO00027_GetListDuocVattuMienPhi" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select DUOC_ID from TM_DUOC where TAMNGUNG = '0' AND BENHVIEN_ID = '$BENHVIEN_ID$' and MADUOC in ($LST_MADUOC$)
    </statement>
    <!--Revision:0,3be57b869d2beeb2aadaa8766d5c366c-->
    <statement id="DAO00027_GetListVatTuYtelaHatViCau" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      <!--select * from TM_DUOC where TAMNGUNG = '0' AND BENHVIEN_ID = '$BENHVIEN_ID$' and VTYT_PHANLOAI in (select DICTIONARY_ID from LST_DICTIONARY where DICTIONARY_TYPE_CODE like 'Phanloai_VTYT' and DICTIONARY_CODE = '2')-->
      select * from TM_DUOC where TAMNGUNG = '0' AND BENHVIEN_ID = '$BENHVIEN_ID$'
      and exists (select DICTIONARY_ID from LST_DICTIONARY where TM_DUOC.VTYT_PHANLOAI = DICTIONARY_ID and DICTIONARY_TYPE_CODE like 'Phanloai_VTYT' and DICTIONARY_CODE = '2')
    </statement>
    <!--Revision:0,60addc72f61207177483fff8368178e3-->
    <statement id="DAO00027_GetListDichVuPhauThuat" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select * from TM_DICHVU
      where
      exists (select NHOMDICHVU_ID from TM_NHOMDICHVU where TM_DICHVU.NHOMDICHVU_ID = NHOMDICHVU_ID and LEFT(MANHOMDICHVU, 2) = '05' and BENHVIEN_ID = '$BENHVIEN_ID$')
      <!--NHOMDICHVU_ID in (select NHOMDICHVU_ID from TM_NHOMDICHVU where LEFT(MANHOMDICHVU, 2) = '05' and BENHVIEN_ID = '$BENHVIEN_ID$')-->
    </statement>
    <!--Revision:0,ae66c903c8079f3255b8bcc64c668c25-->
    <statement id="DAO00027_GetSysAppSettings_WithCode" resultClass="DataObject">
      select VALUE
      from TM_SYS_APPSETTINGS
      where CODE = '$CODE$' and BENHVIEN_ID = '$BENHVIEN_ID$';
    </statement>
    <!--Revision:0,76b50b0ab7d42ca5e83f0c9269bc109d-->
    <statement id="DAO00027_GetWORKFLOWPROCESS_NOITRU" resultClass="DataObject">
      select VALUE
      from TM_SYS_APPSETTINGS
      where CODE = 'WorkFlow_NoiTru_Process';
    </statement>
    <!--Revision:0,506cdeecf9d7dad3b23207fbc72e3401-->
    <statement id="DAO00027_GetList_Ex" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select *
      from TM_SYS_APPSETTINGS
      <dynamic prepend="where">
        <isParameterPresent>
          <isNotEmpty prepend="and" property="SETTING_ID">
            TM_SYS_APPSETTINGS.SETTING_ID = '$SETTING_ID$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="CODE">
            TM_SYS_APPSETTINGS.CODE = '$CODE$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="LANGUAGE_ID">
            TM_SYS_APPSETTINGS.LANGUAGE_ID = '$LANGUAGE_ID$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="VALUE">
            TM_SYS_APPSETTINGS.VALUE = '$VALUE$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="DESCRIPTION">
            TM_SYS_APPSETTINGS.DESCRIPTION = '$DESCRIPTION$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="LOCKED">
            TM_SYS_APPSETTINGS.LOCKED = '$LOCKED$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="TYPE">
            TM_SYS_APPSETTINGS.TYPE = '$TYPE$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="CREATIONDATE">
            TM_SYS_APPSETTINGS.CREATIONDATE = '$CREATIONDATE$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="CREATEDBY">
            TM_SYS_APPSETTINGS.CREATEDBY = '$CREATEDBY$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="LASTUPDATEDATE">
            TM_SYS_APPSETTINGS.LASTUPDATEDATE = '$LASTUPDATEDATE$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="LASTUPDATEDBY">
            TM_SYS_APPSETTINGS.LASTUPDATEDBY = '$LASTUPDATEDBY$'
          </isNotEmpty>
        </isParameterPresent>
      </dynamic>
      order by SETTING_ID
    </statement>
    <!--Revision:0,b700e4d6e1e5f37afd0001e24fd5b691-->
    <statement id="DAO00027_GetListDichVuLoaiThanhVien" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select *
      from TT_CSKH_THETHANHVIEN_SUDUNG
      where THE_ID = '$THE_ID$' and  BENHVIEN_ID = '$BENHVIEN_ID$'
      <!--and ((SOLANDINHMUC - SOLANDASUDUNG) > 0)-->
    </statement>
    <!--Revision:0,188635f2b5b1bcce3735248d39b8a350-->
    <update id="DAO00027_UpdateDoiTuongTiepNhan" parameterClass="System.Collections.IDictionary">
      update TT_TIEPNHAN set
      BENHNHAN_ID = '$BENHNHAN_ID$'
      <isNotEmpty prepend="," property="DOITUONG_ID">
        DOITUONG_ID = #DOITUONG_ID#
        , SOBHYT = #SOBHYT#
        , BHYTTUNGAY = #BHYTTUNGAY#
        , BHYTDENNGAY = #BHYTDENNGAY#
        , BHYTNGAYCAP = #BHYTNGAYCAP#
        , TRAITUYEN = #TRAITUYEN#
        , NGUON_BENHNHAN_ID = #NGUON_BENHNHAN_ID#
        , NGAYCAPNHAT = #NGAYCAPNHAT#
        , NGUOICAPNHAT_ID = #NGUOICAPNHAT_ID#
      </isNotEmpty>
      <isNotEmpty prepend="," property="SUDUNG_BHTN">
        SUDUNG_BHTN = #SUDUNG_BHTN#
      </isNotEmpty>
      <isNotEmpty prepend="," property="BAOLANH_VIENPHI">
        BAOLANH_VIENPHI = #BAOLANH_VIENPHI#
      </isNotEmpty>
      <isNotEmpty prepend="," property="BHYTTREN5NAM">
        BHYTTREN5NAM = #BHYTTREN5NAM#
      </isNotEmpty>
      <isNotEmpty prepend="," property="NGAYMIENDONGCHITRA">
        NGAYMIENDONGCHITRA = #NGAYMIENDONGCHITRA#
      </isNotEmpty>
      <isNotEmpty prepend="," property="PROCESS_ID">
        PROCESS_ID = #PROCESS_ID#
      </isNotEmpty>
      where
      TIEPNHAN_ID = '$TIEPNHAN_ID$'
    </update>
    <!--Revision:0,4a1d6ada8de2bb626da50df5e2715d66-->
    <update id="DAO00027_UpdateTheThanhVienTiepNhan" parameterClass="System.Collections.IDictionary">
      update TT_TIEPNHAN set
      BENHNHAN_ID = '$BENHNHAN_ID$'
      , THANHVIEN_ID = '$THANHVIEN_ID$'
      , LOAITHANHVIEN_ID = '$LOAITHANHVIEN_ID$'
      , THE_ID = '$THE_ID$'
      , NGAYCAPNHAT = #NGAYCAPNHAT#
      , NGUOICAPNHAT_ID = #NGUOICAPNHAT_ID#
      where
      TIEPNHAN_ID = '$TIEPNHAN_ID$'
    </update>
    <!--Revision:0,6ed1b28d548313c53417464cc2b0f088-->
    <statement id="DAO00027_GetListCacheTiepNhanNgoaiTru" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select distinct B.*, C.SOBENHAN, C.BENHAN_ID, A.SOTIEPNHAN, A.TRAITUYEN, A.NGAYMIENDONGCHITRA, A.TIEPNHAN_ID,
      isnull(C.KHOACHUYENDEN_ID,C.KHOAVAO_ID) as KHOACHUYENDEN_ID, A.TRANGTHAI, A.DOITUONG_ID, C.TRANGTHAI as TRANGTHAI_BENHAN,
      A.LOAITHANHVIEN_ID, A.SUDUNG_BHTN, A.THE_ID, A.THANHVIEN_ID, A.VIP, A.NGUON_BENHNHAN_ID, A.BAOLANH_VIENPHI,
      'NGOAITRU' AS LOAIBENHAN, CONVERT(VARCHAR(11),C.NGAYVAOKHOA,103) as NGAYVAOKHOA, A.SOBHYT
      , A.UUTIEN
      from TT_TIEPNHAN A
      inner join TT_BENHNHAN B on B.BENHNHAN_ID = A.BENHNHAN_ID and (A.TRANGTHAI = 'HOANTHANH' or A.TRANGTHAI = 'NGOAITRU') and B.ACTIVE = '1'
      inner join TT_NOITRU_BENHAN C on C.TIEPNHAN_ID = A.TIEPNHAN_ID and (C.TRANGTHAI='DAXUATVIEN' or C.TRANGTHAI='DATHANHTOAN' OR C.TRANGTHAI='DANGDIEUTRI')
      where A.BENHVIEN_ID = '$BENHVIEN_ID$' and C.LOAIBENHAN = 2
    </statement>
    <!--Revision:0,7b3f6c64fffe4420ac14e9d4fb6af2c5-->
    <statement id="DAO00027_GetListCacheTiepNhanNgoaiTruWithTiepNhanId_COM68" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select distinct B.*, C.SOBENHAN, C.BENHAN_ID, A.SOTIEPNHAN, A.TRAITUYEN, A.NGAYMIENDONGCHITRA, A.TIEPNHAN_ID,
      isnull(C.KHOACHUYENDEN_ID,C.KHOAVAO_ID) as KHOACHUYENDEN_ID, A.TRANGTHAI, A.DOITUONG_ID, C.TRANGTHAI as TRANGTHAI_BENHAN,
      A.LOAITHANHVIEN_ID, A.SUDUNG_BHTN, A.THE_ID, A.THANHVIEN_ID, A.VIP, A.NGUON_BENHNHAN_ID, A.BAOLANH_VIENPHI,
      'NGOAITRU' AS LOAIBENHAN, CONVERT(VARCHAR(11),C.NGAYVAOKHOA,103) as NGAYVAOKHOA, A.SOBHYT
      , A.UUTIEN
      from TT_TIEPNHAN A
      inner join TT_BENHNHAN B on B.BENHNHAN_ID = A.BENHNHAN_ID and (A.TRANGTHAI = 'HOANTHANH' or A.TRANGTHAI = 'NGOAITRU') and B.ACTIVE = '1'
      inner join TT_NOITRU_BENHAN C on C.TIEPNHAN_ID = A.TIEPNHAN_ID and (C.TRANGTHAI='DAXUATVIEN' or C.TRANGTHAI='DATHANHTOAN' OR C.TRANGTHAI='DANGDIEUTRI')
      where
      A.TIEPNHAN_ID = '$TIEPNHAN_ID$' and A.BENHVIEN_ID = '$BENHVIEN_ID$' and C.LOAIBENHAN = 2
    </statement>
    <!--Revision:0,d71b39ba058d9c3b62b04535e955ca62-->
    <statement id="DAO00027_GetListCacheTiepNhanNgoaiTruWithBenhAnId_COM68" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select distinct B.*, C.SOBENHAN, C.BENHAN_ID, A.SOTIEPNHAN, A.TRAITUYEN, A.NGAYMIENDONGCHITRA, A.TIEPNHAN_ID,
      isnull(C.KHOACHUYENDEN_ID,C.KHOAVAO_ID) as KHOACHUYENDEN_ID, A.TRANGTHAI, A.DOITUONG_ID, C.TRANGTHAI as TRANGTHAI_BENHAN,
      A.LOAITHANHVIEN_ID, A.SUDUNG_BHTN, A.THE_ID, A.THANHVIEN_ID, A.VIP, A.NGUON_BENHNHAN_ID, A.BAOLANH_VIENPHI,
      'NGOAITRU' AS LOAIBENHAN, CONVERT(VARCHAR(11),C.NGAYVAOKHOA,103) as NGAYVAOKHOA, A.SOBHYT
      , A.UUTIEN
      from TT_TIEPNHAN A
      inner join TT_BENHNHAN B on B.BENHNHAN_ID = A.BENHNHAN_ID and (A.TRANGTHAI = 'HOANTHANH' or A.TRANGTHAI = 'NGOAITRU') and B.ACTIVE = '1'
      inner join TT_NOITRU_BENHAN C on C.TIEPNHAN_ID = A.TIEPNHAN_ID and (C.TRANGTHAI='DAXUATVIEN' or C.TRANGTHAI='DATHANHTOAN' OR C.TRANGTHAI='DANGDIEUTRI')
      where
      C.BENHAN_ID = '$BENHAN_ID$' and A.BENHVIEN_ID = '$BENHVIEN_ID$' and C.LOAIBENHAN = 2
    </statement>
    <!--Revision:0,5fea87763c1a0a0bca21e01a583f0e4f-->
    <statement id="DAO00027_GetListTuongTrinhDichVuPhauThuatCuaTiepNhan" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      declare @ManhomDSA varchar(10);
      declare @PhanLoaiNhomDV varchar(20) = '05';
      select top 1  @ManhomDSA = VALUE from TM_SYS_APPSETTINGS where CODE = 'MANHOM_DICHVU_DSA'
      if (@ManhomDSA is not null) set @PhanLoaiNhomDV += ',' + @ManhomDSA
      select distinct ptyc.*
      from TT_PHAUTHUAT_YEUCAU ptyc
      inner join TM_DICHVU dv on dv.DICHVU_ID = ptyc.DICHVU_ID
      inner join TM_NHOMDICHVU ndv on ndv.NHOMDICHVU_ID = dv.NHOMDICHVU_ID
      inner join TT_PHAUTHUAT pt on pt.PHAUTHUAT_ID = ptyc.PHAUTHUAT_ID
      where
      pt.TIEPNHAN_ID = $TIEPNHAN_ID$
      and (left(ndv.MANHOMDICHVU, 2) in (select * from STRING_SPLIT(@PhanLoaiNhomDV,',')) or ndv.MANHOMDICHVU in (select * from STRING_SPLIT(@PhanLoaiNhomDV,',')))
    </statement>
    <!--Revision:0,cab39c7853764164e72fcf6ef35b342d-->
    <statement id="DAO00027_GetListTuongTrinhVTYTPhauThuatCuaTiepNhan" parameterClass="System.Collections.IDictionary" resultClass="DataObject">      
      select distinct ptvt.*
      from TT_PHAUTHUAT_VTYT ptvt
      inner join TT_PHAUTHUAT pt on pt.PHAUTHUAT_ID = ptvt.PHAUTHUAT_ID
      inner join TM_DUOC d on d.DUOC_ID = ptvt.DUOC_ID
      inner join TM_LOAIDUOC ld on ld.LOAIVATTU_ID = 'V' and ld.LOAIDUOC_ID = d.LOAIDUOC_ID
      where pt.TIEPNHAN_ID = $TIEPNHAN_ID$
      order by ptvt.PHAUTHUAT_VTYT_ID asc
    </statement>
    <!--Revision:0,8e63bc1be7d0af43d4c67f0c076f4ba1-->
    <statement id="DAO00027_GetListTiepNhanNgoaiTru" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select distinct B.*, C.SOBENHAN, C.BENHAN_ID, A.SOTIEPNHAN, A.TRAITUYEN, A.NGAYMIENDONGCHITRA, A.TIEPNHAN_ID,
      isnull(C.KHOACHUYENDEN_ID,C.KHOAVAO_ID) as KHOACHUYENDEN_ID, A.TRANGTHAI, A.DOITUONG_ID, C.TRANGTHAI as TRANGTHAI_BENHAN,
      A.LOAITHANHVIEN_ID, A.SUDUNG_BHTN, A.THE_ID, A.THANHVIEN_ID, A.VIP, A.NGUON_BENHNHAN_ID, A.BAOLANH_VIENPHI,
      'NGOAITRU' AS LOAIBENHAN
      , A.UUTIEN
      from TT_TIEPNHAN A
      inner join TT_BENHNHAN B on B.BENHNHAN_ID = A.BENHNHAN_ID and (A.TRANGTHAI = 'HOANTHANH' or A.TRANGTHAI = 'NGOAITRU') and B.ACTIVE = '1'
      inner join TT_NOITRU_BENHAN C on C.TIEPNHAN_ID = A.TIEPNHAN_ID and (C.TRANGTHAI='DAXUATVIEN' or C.TRANGTHAI='DATHANHTOAN' OR C.TRANGTHAI='DANGDIEUTRI')
      where A.BENHVIEN_ID = '$BENHVIEN_ID$' and C.LOAIBENHAN = 2
    </statement>
    <statement id="DAO00027_GetListVienphiNgoaiTru" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select count(*) as TOTAL_ROWS from TT_VIENPHI
      where
      TIEPNHAN_ID = '$TIEPNHAN_ID$' and (BENHAN_ID is null or BENHAN_ID = 0)
      and BENHNHAN_PHAITHANHTOAN > GIATRI_BENHNHAN_DATHANHTOAN
      and ACTIVE = '1'
    </statement>
    <statement id="DAO00027_GetDuocTonKhoByListKey" parameterClass="HashTable" resultClass="DataObject">
      SELECT DUOC_KEY_KHODUOC, SUM(SOLUONG) SOLUONG
      FROM TT_DUOC_TONKHO
      WHERE     
        BENHVIEN_ID =  '$BENHVIEN_ID$'
        <dynamic prepend=" and DUOC_KEY_KHODUOC in ">
        <iterate open="(" close=")" conjunction=",  " property="LST_DUOC_KEY">'$LST_DUOC_KEY[]$'</iterate>
      </dynamic>
     GROUP BY DUOC_KEY_KHODUOC
    </statement>
    <statement id="DAO00027_GetDuocTonKhoByKey" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      SELECT DUOC_KEY_KHODUOC, SUM(SOLUONG) SOLUONG
      FROM TT_DUOC_TONKHO
      WHERE
      DUOC_KEY_KHODUOC = '$DUOC_KEY_KHODUOC$'     
      GROUP BY DUOC_KEY_KHODUOC
    </statement>
    <statement id="DAO00027_GetDuocTonKhoTruBookingByListKey" parameterClass="HashTable" resultClass="DataObject">      
      SELECT tk.DUOC_KEY_PHAMVI, SUM(isnull(tk.SOLUONG,0) - isnull(ngoai.SOLUONG,0) - isnull(noi.SOLUONG,0)) as SOLUONG
      from
      (
      select SUM(SOLUONG) as SOLUONG, DUOC_KEY_PHAMVI
      from TT_DUOC_TONKHO
      where BENHVIEN_ID = '$BENHVIEN_ID$'     
      <dynamic prepend="and DUOC_KEY_PHAMVI in ">
        <iterate open="(" close=")" conjunction=",  " property="LST_DUOC_KEY">'$LST_DUOC_KEY[]$'</iterate>
      </dynamic>
      group by DUOC_KEY_PHAMVI
      )TK
      left join
      (
      select SUM(SOLUONG) as SOLUONG, DUOC_KEY_PHAMVI
      from TT_DUOC_TONKHO_BOOK_NGOAITRU where TRANGTHAI != 'HUY' AND BENHVIEN_ID = '$BENHVIEN_ID$'
      <dynamic prepend="and DUOC_KEY_PHAMVI in ">
        <iterate open="(" close=")" conjunction=",  " property="LST_DUOC_KEY">'$LST_DUOC_KEY[]$'</iterate>
      </dynamic>
      group by DUOC_KEY_PHAMVI
      )ngoai on tk.DUOC_KEY_PHAMVI = ngoai.DUOC_KEY_PHAMVI
      left join
      (
      select SUM(SOLUONG) as SOLUONG, DUOC_KEY_PHAMVI
      from TT_DUOC_TONKHO_BOOK_NOITRU where TRANGTHAI != 'HUY' AND BENHVIEN_ID = '$BENHVIEN_ID$'
      <dynamic prepend="and DUOC_KEY_PHAMVI in ">
        <iterate open="(" close=")" conjunction=",  " property="LST_DUOC_KEY">'$LST_DUOC_KEY[]$'</iterate>
      </dynamic>
      group by DUOC_KEY_PHAMVI
      )noi on tk.DUOC_KEY_PHAMVI = noi.DUOC_KEY_PHAMVI   
      group by tk.DUOC_KEY_PHAMVI      
    </statement>
    <statement id="DAO00027_GetDuocTonKhoTruBookingByKey" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      SELECT tk.DUOC_KEY_PHAMVI, SUM(isnull(tk.SOLUONG,0) - isnull(ngoai.SOLUONG,0) - isnull(noi.SOLUONG,0)) as SOLUONG
      from
      (
      select SUM(SOLUONG) as SOLUONG, DUOC_KEY_PHAMVI
      from TT_DUOC_TONKHO
      where BENHVIEN_ID = '$BENHVIEN_ID$' and DUOC_KEY_PHAMVI = '$DUOC_KEY_PHAMVI$' and BENHVIEN_ID = '$BENHVIEN_ID$'
      group by DUOC_KEY_PHAMVI
      )TK
      left join
      (
      select SUM(SOLUONG) as SOLUONG, DUOC_KEY_PHAMVI
      from TT_DUOC_TONKHO_BOOK_NGOAITRU where DUOC_KEY_PHAMVI = '$DUOC_KEY_PHAMVI$' and TRANGTHAI != 'HUY' and BENHVIEN_ID = '$BENHVIEN_ID$'
      group by DUOC_KEY_PHAMVI
      )ngoai on tk.DUOC_KEY_PHAMVI = ngoai.DUOC_KEY_PHAMVI
      left join
      (
      select SUM(SOLUONG) as SOLUONG, DUOC_KEY_PHAMVI
      from TT_DUOC_TONKHO_BOOK_NOITRU where DUOC_KEY_PHAMVI = '$DUOC_KEY_PHAMVI$' and TRANGTHAI != 'HUY' and BENHVIEN_ID = '$BENHVIEN_ID$'
      group by DUOC_KEY_PHAMVI
      )noi on tk.DUOC_KEY_PHAMVI = noi.DUOC_KEY_PHAMVI
      group by tk.DUOC_KEY_PHAMVI

    </statement>
    
  </statements>
</sqlMap>
