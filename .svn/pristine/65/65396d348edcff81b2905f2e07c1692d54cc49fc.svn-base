<?xml version="1.0" encoding="utf-8" ?>
<!--============================================================================
//	CAUTION: This file is generated by IBatisNetGen.3.SQLMap.cst at 11/11/2015 9:30:18 AM
//				Any manual editing will be lost in re-generation.
//===========================================================================-->
<sqlMap namespace="eHospital" xmlns="http://ibatis.apache.org/mapping" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
  <statements>
    <!--<statement id="DAO00063_GetSLDuocDaLuu" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select sum(SOLUONG) as SOLUONG
      from TT_NOITRU_TOATHUOC
      where KHAMBENH_ID  = '$KHAMBENH_ID$'
      and DUOC_ID  = '$DUOC_ID$'
    </statement>-->
    <statement id="DAO00063_GetTrangThaiTruocKhiXoa_Update_Thuoc_VTYT" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      SELECT TOATHUOC_ID FROM TT_NOITRU_TOATHUOC TT WHERE TT.KHAMBENH_ID ='$KHAMBENH_ID$' AND BENHVIEN_ID='$BENHVIEN_ID$'
      AND ( PHIEULINH_ID IS NOT NULL OR CHUNGTU_ID IS NOT NULL)
    </statement>
    <statement id="DAO00063_GetAll" resultClass="DataObject">
      select *
      from TT_NOITRU_TOATHUOC
      order by TOATHUOC_ID
    </statement>
    <statement id="DAO00063_CapNhatTrangThaiThuoc" resultClass="DataObject">
      update TT_NOITRU_TOATHUOC
      set TRANGTHAI = #TRANGTHAI#,
      NGUOICAPNHAT_ID = #NGUOICAPNHAT_ID#,
      NGAYCAPNHAT = #NGAYCAPNHAT#
      where TOATHUOC_ID = '$TOATHUOC_ID$'
    </statement>
    <statement id="DAO00063_GetList" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select *
      from TT_NOITRU_TOATHUOC
      <dynamic prepend="where">
        <isParameterPresent>
          <isNotEmpty prepend="and" property="TOATHUOC_ID">
            TOATHUOC_ID = '$TOATHUOC_ID$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="SOTHUTUTOA">
            SOTHUTUTOA = '$SOTHUTUTOA$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="KHAMBENH_ID">
            KHAMBENH_ID = '$KHAMBENH_ID$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="TIEPNHAN_ID">
            TIEPNHAN_ID = '$TIEPNHAN_ID$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="BENHNHAN_ID">
            BENHNHAN_ID = '$BENHNHAN_ID$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="DUOC_ID">
            DUOC_ID = '$DUOC_ID$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="SOLUONG">
            SOLUONG = '$SOLUONG$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="SONGAY">
            SONGAY = '$SONGAY$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="SOLANTRENNGAY">
            SOLANTRENNGAY = '$SOLANTRENNGAY$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="SOLUONGTRENLAN">
            SOLUONGTRENLAN = '$SOLUONGTRENLAN$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="SOLUONG_BUOISANG">
            SOLUONG_BUOISANG = '$SOLUONG_BUOISANG$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="SOLUONG_BUOITRUA">
            SOLUONG_BUOITRUA = '$SOLUONG_BUOITRUA$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="SOLUONG_BUOICHIEU">
            SOLUONG_BUOICHIEU = '$SOLUONG_BUOICHIEU$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="SOLUONG_BUOITOI">
            SOLUONG_BUOITOI = '$SOLUONG_BUOITOI$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="DUONGDUNG_ID">
            DUONGDUNG_ID = '$DUONGDUNG_ID$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="GHICHU">
            GHICHU = '$GHICHU$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="NGUONDUOC_ID">
            NGUONDUOC_ID = '$NGUONDUOC_ID$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="PHIEULINH_ID">
            PHIEULINH_ID = '$PHIEULINH_ID$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="CHUNGTU_ID">
            CHUNGTU_ID = '$CHUNGTU_ID$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="NGUONLAYTHUOC">
            NGUONLAYTHUOC = '$NGUONLAYTHUOC$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="COSO">
            COSO = '$COSO$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="KHOPHAT_ID">
            KHOPHAT_ID = '$KHOPHAT_ID$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="PHATTHUOCTAIQUAY">
            PHATTHUOCTAIQUAY = '$PHATTHUOCTAIQUAY$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="MUANGOAI">
            MUANGOAI = '$MUANGOAI$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="TINHTIEN">
            TINHTIEN = '$TINHTIEN$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="MIENPHI">
            MIENPHI = '$MIENPHI$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="BHYTDONGTIEN">
            BHYTDONGTIEN = '$BHYTDONGTIEN$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="KHONGTHUTIEN">
            KHONGTHUTIEN = '$KHONGTHUTIEN$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="TRANGTHAI">
            TRANGTHAI = '$TRANGTHAI$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="HUYTOATHUOC">
            HUYTOATHUOC = '$HUYTOATHUOC$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="BENHVIEN_ID">
            BENHVIEN_ID = '$BENHVIEN_ID$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="NGAYTAO">
            NGAYTAO = '$NGAYTAO$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="NGUOITAO_ID">
            NGUOITAO_ID = '$NGUOITAO_ID$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="NGAYCAPNHAT">
            NGAYCAPNHAT = '$NGAYCAPNHAT$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="NGUOICAPNHAT_ID">
            NGUOICAPNHAT_ID = '$NGUOICAPNHAT_ID$'
          </isNotEmpty>
        </isParameterPresent>
      </dynamic>
      order by TOATHUOC_ID
    </statement>
    <statement id="DAO00063_GetDetail" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select *
      from TT_NOITRU_TOATHUOC
      where TOATHUOC_ID  = '$value$'
      order by TOATHUOC_ID
    </statement>
    <statement id="DAO00063_GetDetailP" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select *
      from TT_NOITRU_TOATHUOC
      where TOATHUOC_ID  = '$TOATHUOC_ID$'
      order by TOATHUOC_ID
    </statement>
    <insert id="DAO00063_Add" parameterClass="System.Collections.IDictionary" resultClass="System.Int64">
      insert into TT_NOITRU_TOATHUOC (
      SOTHUTUTOA
      , KHAMBENH_ID
      , TIEPNHAN_ID
      , BENHNHAN_ID
      , DUOC_ID
      , SOLUONG
      , SONGAY
      , SOLANTRENNGAY
      , SOLUONGTRENLAN
      , SOLUONG_BUOISANG
      , SOLUONG_BUOITRUA
      , SOLUONG_BUOICHIEU
      , SOLUONG_BUOITOI
      , DUONGDUNG_ID
      , GHICHU
      , NGUONDUOC_ID
      , PHIEULINH_ID
      , CHUNGTU_ID
      , PHONGBANRATOA_ID
      , NGUONLAYTHUOC
      , COSO
      , KHOPHAT_ID
      , KHOTAO_ID
      , PHATTHUOCTAIQUAY
      , MUANGOAI
      , TINHTIEN
      , MIENPHI
      , BHYTDONGTIEN
      , KHONGTHUTIEN
      , TRANGTHAI
      , HUYTOATHUOC
      , BENHVIEN_ID
      , NGAYTAO
      , NGUOITAO_ID
      , NGAYCAPNHAT
      , NGUOICAPNHAT_ID
      <isNotEmpty prepend="," property="PHAMVI_ID">
        PHAMVI_ID
      </isNotEmpty>   
      ) values (
      #SOTHUTUTOA#
      , #KHAMBENH_ID#
      , #TIEPNHAN_ID#
      , #BENHNHAN_ID#
      , #DUOC_ID#
      , #SOLUONG#
      , #SONGAY#
      , #SOLANTRENNGAY#
      , #SOLUONGTRENLAN#
      , #SOLUONG_BUOISANG#
      , #SOLUONG_BUOITRUA#
      , #SOLUONG_BUOICHIEU#
      , #SOLUONG_BUOITOI#
      , #DUONGDUNG_ID#
      , #GHICHU#
      , #NGUONDUOC_ID#
      , #PHIEULINH_ID#
      , #CHUNGTU_ID#
      , #PHONGBANRATOA_ID#
      , #NGUONLAYTHUOC#
      , #COSO#
      , #KHOPHAT_ID#
      , #KHOTAO_ID#
      , #PHATTHUOCTAIQUAY#
      , #MUANGOAI#
      , #TINHTIEN#
      , #MIENPHI#
      , #BHYTDONGTIEN#
      , #KHONGTHUTIEN#
      , #TRANGTHAI#
      , #HUYTOATHUOC#
      , #BENHVIEN_ID#
      , #NGAYTAO#
      , #NGUOITAO_ID#
      , #NGAYCAPNHAT#
      , #NGUOICAPNHAT_ID#
      <isNotEmpty prepend="," property="PHAMVI_ID">
        #PHAMVI_ID#
      </isNotEmpty>     
      )
      <selectKey resultClass="System.Int64" type="post" >
        SELECT @@IDENTITY as value
      </selectKey>
    </insert>

    <update id="DAO00063_Update" parameterClass="System.Collections.IDictionary">
      update TT_NOITRU_TOATHUOC set
      KHAMBENH_ID = #KHAMBENH_ID#
      , TIEPNHAN_ID = #TIEPNHAN_ID#
      , BENHNHAN_ID = #BENHNHAN_ID#
      , DUOC_ID = #DUOC_ID#
      , SOLUONG = #SOLUONG#
      , SONGAY = #SONGAY#
      , SOLANTRENNGAY = #SOLANTRENNGAY#
      , SOLUONGTRENLAN = #SOLUONGTRENLAN#
      , SOLUONG_BUOISANG = #SOLUONG_BUOISANG#
      , SOLUONG_BUOITRUA = #SOLUONG_BUOITRUA#
      , SOLUONG_BUOICHIEU = #SOLUONG_BUOICHIEU#
      , SOLUONG_BUOITOI = #SOLUONG_BUOITOI#
      , DUONGDUNG_ID = #DUONGDUNG_ID#
      , GHICHU = #GHICHU#
      , NGUONDUOC_ID = #NGUONDUOC_ID#
      , PHIEULINH_ID = #PHIEULINH_ID#
      , CHUNGTU_ID = #CHUNGTU_ID#
      , PHONGBANRATOA_ID = #PHONGBANRATOA_ID#
      , NGUONLAYTHUOC = #NGUONLAYTHUOC#
      , COSO = #COSO#
      , KHOPHAT_ID = #KHOPHAT_ID#
      , PHATTHUOCTAIQUAY = #PHATTHUOCTAIQUAY#
      , MUANGOAI = #MUANGOAI#
      , TINHTIEN = #TINHTIEN#
      , MIENPHI = #MIENPHI#
      , BHYTDONGTIEN = #BHYTDONGTIEN#
      , KHONGTHUTIEN = #KHONGTHUTIEN#
      , TRANGTHAI = #TRANGTHAI#
      , HUYTOATHUOC = #HUYTOATHUOC#
      , BENHVIEN_ID = #BENHVIEN_ID#
      , NGAYCAPNHAT = #NGAYCAPNHAT#
      , NGUOICAPNHAT_ID = #NGUOICAPNHAT_ID#
      <isNotEmpty prepend="," property="PHAMVI_ID">
        PHAMVI_ID = #PHAMVI_ID#
      </isNotEmpty>     
      where
      TOATHUOC_ID = '$TOATHUOC_ID$'
    </update>

    <statement id="DAO00063_Delete" parameterClass="System.Collections.IDictionary" resultClass="System.Int32">
      delete from TT_NOITRU_TOATHUOC
      where
      TOATHUOC_ID = '$TOATHUOC_ID$'
    </statement>
    <statement id="DAO00063_KiemTraYLenhDaPhatSinhPhieuHoanTra" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      Select *
      from TT_NOITRU_TRATHUOC
      where
      KHAMBENH_ID = '$KHAMBENH_ID$'
    </statement>
    <statement id="DAO00063_DeleteToaThuocByKhamBenhID" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      delete from TT_NOITRU_TOATHUOC
      where
      KHAMBENH_ID = '$KHAMBENH_ID$'
    </statement>
    <statement id="DAO00063_GetListToaThuocByKhamBenhID" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      Select TOATHUOC_ID, DUOC_ID, KHOPHAT_ID, SOLUONG, KHAMBENH_ID, BENHVIEN_ID, NGUONDUOC_ID, PHAMVI_ID
      from TT_NOITRU_TOATHUOC
      where
      KHAMBENH_ID = '$KHAMBENH_ID$'
    </statement>

    <statement id="DAO00063_DeleteP" parameterClass="System.Collections.IDictionary" resultClass="System.Int32">
      delete from TT_NOITRU_TOATHUOC
      <dynamic prepend="where">
        <isParameterPresent>
          <isNotEmpty prepend="and" property="TOATHUOC_ID">
            TOATHUOC_ID = '$TOATHUOC_ID$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="SOTHUTUTOA">
            SOTHUTUTOA = '$SOTHUTUTOA$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="KHAMBENH_ID">
            KHAMBENH_ID = '$KHAMBENH_ID$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="TIEPNHAN_ID">
            TIEPNHAN_ID = '$TIEPNHAN_ID$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="BENHNHAN_ID">
            BENHNHAN_ID = '$BENHNHAN_ID$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="DUOC_ID">
            DUOC_ID = '$DUOC_ID$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="SOLUONG">
            SOLUONG = '$SOLUONG$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="SONGAY">
            SONGAY = '$SONGAY$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="SOLANTRENNGAY">
            SOLANTRENNGAY = '$SOLANTRENNGAY$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="SOLUONGTRENLAN">
            SOLUONGTRENLAN = '$SOLUONGTRENLAN$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="SOLUONG_BUOISANG">
            SOLUONG_BUOISANG = '$SOLUONG_BUOISANG$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="SOLUONG_BUOITRUA">
            SOLUONG_BUOITRUA = '$SOLUONG_BUOITRUA$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="SOLUONG_BUOICHIEU">
            SOLUONG_BUOICHIEU = '$SOLUONG_BUOICHIEU$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="SOLUONG_BUOITOI">
            SOLUONG_BUOITOI = '$SOLUONG_BUOITOI$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="DUONGDUNG_ID">
            DUONGDUNG_ID = '$DUONGDUNG_ID$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="GHICHU">
            GHICHU = '$GHICHU$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="NGUONDUOC_ID">
            NGUONDUOC_ID = '$NGUONDUOC_ID$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="PHIEULINH_ID">
            PHIEULINH_ID = '$PHIEULINH_ID$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="CHUNGTU_ID">
            CHUNGTU_ID = '$CHUNGTU_ID$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="NGUONLAYTHUOC">
            NGUONLAYTHUOC = '$NGUONLAYTHUOC$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="COSO">
            COSO = '$COSO$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="KHOPHAT_ID">
            KHOPHAT_ID = '$KHOPHAT_ID$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="PHATTHUOCTAIQUAY">
            PHATTHUOCTAIQUAY = '$PHATTHUOCTAIQUAY$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="MUANGOAI">
            MUANGOAI = '$MUANGOAI$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="TINHTIEN">
            TINHTIEN = '$TINHTIEN$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="MIENPHI">
            MIENPHI = '$MIENPHI$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="BHYTDONGTIEN">
            BHYTDONGTIEN = '$BHYTDONGTIEN$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="KHONGTHUTIEN">
            KHONGTHUTIEN = '$KHONGTHUTIEN$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="TRANGTHAI">
            TRANGTHAI = '$TRANGTHAI$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="HUYTOATHUOC">
            HUYTOATHUOC = '$HUYTOATHUOC$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="BENHVIEN_ID">
            BENHVIEN_ID = '$BENHVIEN_ID$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="NGAYTAO">
            NGAYTAO = '$NGAYTAO$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="NGUOITAO_ID">
            NGUOITAO_ID = '$NGUOITAO_ID$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="NGAYCAPNHAT">
            NGAYCAPNHAT = '$NGAYCAPNHAT$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="NGUOICAPNHAT_ID">
            NGUOICAPNHAT_ID = '$NGUOICAPNHAT_ID$'
          </isNotEmpty>
        </isParameterPresent>
      </dynamic>
    </statement>

    <statement id="DAO00063_GetBookingInfo" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select *
      from TT_DUOC_TONKHO_BOOK_NOITRU
      where DUOC_ID = '$DUOC_ID$'
      and NGUONHANG_ID = '$NGUONHANG_ID$'
      and REF_ID = '$TOATHUOC_ID$'
      and REF_TABLE = '$REF_TABLE$'
      
      <isNotEmpty prepend="and" property="PHAMVI_ID">
        PHAMVI_ID = #PHAMVI_ID#
      </isNotEmpty>
    </statement>
    <statement id="DAO00063_KiemtraSoluongDuocXuat" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select A.TONKHO, isnull(B.BOOK_NGOAI,0) BOOK_NGOAI, isnull(D.BOOK_NOI,0) BOOK_NOI, isnull(C.BOOK_NOI_THUOC,0) BOOK_NOI_THUOC, (A.TONKHO - isnull(B.BOOK_NGOAI,0) - isnull(D.BOOK_NOI,0)) TONKHO_BOOK
      from(
      select SUM(tk.SOLUONG) TONKHO, tk.DUOC_ID, sd.PHAMVI_ID, tk.NGUONDUOC_ID from TT_DUOC_TONKHO tk
      inner join TM_DUOC_PHAMVISD_MAPPING sd on sd.KHODUOC_ID = tk.KHODUOC_ID
      where sd.PHAMVI_ID  = '$PHAMVI_ID$' and tk.DUOC_ID = '$DUOC_ID$' and tk.NGUONDUOC_ID = '$NGUONHANG_ID$'
      group by tk.DUOC_ID, sd.PHAMVI_ID, tk.NGUONDUOC_ID) A
      left join (
      select SUM(SOLUONG) BOOK_NGOAI,DUOC_ID, PHAMVI_ID, NGUONHANG_ID from TT_DUOC_TONKHO_BOOK_NGOAITRU
      where PHAMVI_ID  = '$PHAMVI_ID$' and DUOC_ID = '$DUOC_ID$' and NGUONHANG_ID = '$NGUONHANG_ID$' and TRANGTHAI = 'HIEULUC'  and SOLUONG > 0
      group by DUOC_ID, PHAMVI_ID, NGUONHANG_ID) B on A.DUOC_ID = B.DUOC_ID and A.PHAMVI_ID = B.PHAMVI_ID and A.NGUONDUOC_ID = B.NGUONHANG_ID
      left join (
      select SUM(SOLUONG) BOOK_NOI_THUOC,DUOC_ID, PHAMVI_ID, NGUONHANG_ID from TT_DUOC_TONKHO_BOOK_NOITRU
      where PHAMVI_ID  = '$PHAMVI_ID$' and DUOC_ID = '$DUOC_ID$' and NGUONHANG_ID = '$NGUONHANG_ID$' and REF_ID = '$TOATHUOC_ID$' and REF_TABLE = '$REF_TABLE$' and TRANGTHAI = 'HIEULUC' and SOLUONG > 0
      group by DUOC_ID, PHAMVI_ID, NGUONHANG_ID) C on A.DUOC_ID = C.DUOC_ID and A.PHAMVI_ID = C.PHAMVI_ID and A.NGUONDUOC_ID = C.NGUONHANG_ID
      left join (
      select SUM(SOLUONG) BOOK_NOI,DUOC_ID, PHAMVI_ID, NGUONHANG_ID from TT_DUOC_TONKHO_BOOK_NOITRU
      where PHAMVI_ID  = '$PHAMVI_ID$' and DUOC_ID = '$DUOC_ID$' and NGUONHANG_ID = '$NGUONHANG_ID$' and TRANGTHAI = 'HIEULUC'  and SOLUONG > 0
      group by DUOC_ID, PHAMVI_ID, NGUONHANG_ID) D on A.DUOC_ID = D.DUOC_ID and A.PHAMVI_ID = D.PHAMVI_ID and A.NGUONDUOC_ID = D.NGUONHANG_ID
    </statement>
    <statement id="DAO00063_KiemtraSoluongDuocXuatNgoaitru" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select A.TONKHO, isnull(B.BOOK_NGOAI,0) BOOK_NGOAI, isnull(D.BOOK_NOI,0) BOOK_NOI,  (A.TONKHO - isnull(B.BOOK_NGOAI,0) - isnull(D.BOOK_NOI,0)) TONKHO_BOOK
      from(
      select SUM(tk.SOLUONG) TONKHO, tk.DUOC_ID, sd.PHAMVI_ID, tk.NGUONDUOC_ID from TT_DUOC_TONKHO tk
      inner join TM_DUOC_PHAMVISD_MAPPING sd on sd.KHODUOC_ID = tk.KHODUOC_ID
      where sd.PHAMVI_ID  = '$PHAMVI_ID$' and tk.DUOC_ID = '$DUOC_ID$' and tk.NGUONDUOC_ID = '$NGUONHANG_ID$'
      group by tk.DUOC_ID, sd.PHAMVI_ID, tk.NGUONDUOC_ID) A
      left join (
      select SUM(SOLUONG) BOOK_NGOAI,DUOC_ID, PHAMVI_ID, NGUONHANG_ID from TT_DUOC_TONKHO_BOOK_NGOAITRU
      where PHAMVI_ID  = '$PHAMVI_ID$' and DUOC_ID = '$DUOC_ID$' and NGUONHANG_ID = '$NGUONHANG_ID$' and TRANGTHAI = 'HIEULUC' and SOLUONG > 0
      group by DUOC_ID, PHAMVI_ID, NGUONHANG_ID) B on A.DUOC_ID = B.DUOC_ID and A.PHAMVI_ID = B.PHAMVI_ID and A.NGUONDUOC_ID = B.NGUONHANG_ID
      left join (
      select SUM(SOLUONG) BOOK_NOI,DUOC_ID, PHAMVI_ID, NGUONHANG_ID from TT_DUOC_TONKHO_BOOK_NOITRU
      where PHAMVI_ID  = '$PHAMVI_ID$' and DUOC_ID = '$DUOC_ID$' and NGUONHANG_ID = '$NGUONHANG_ID$' and TRANGTHAI = 'HIEULUC'  and SOLUONG > 0
      group by DUOC_ID, PHAMVI_ID, NGUONHANG_ID) D on A.DUOC_ID = D.DUOC_ID and A.PHAMVI_ID = D.PHAMVI_ID and A.NGUONDUOC_ID = D.NGUONHANG_ID
    </statement>
    <insert id="DAO00063_Add_Booking" parameterClass="HashTable" resultClass="System.Int64">
      insert into TT_DUOC_TONKHO_BOOK_NOITRU (
      REF_TABLE
      , REF_ID
      , KHODUOC_ID
      , DUOC_ID
      , CHUYENKHOA_ID
      , NGUONHANG_ID
      , BENHVIEN_ID
      , SOLUONG
      , NGAYHIEULUC
      , NGAYTAO
      , NGUOITAO_ID
      , NGAYCAPNHAT
      , NGUOICAPNHAT_ID
      <isNotEmpty prepend="," property="PHAMVI_ID">
        PHAMVI_ID
      </isNotEmpty>     
      ) values (
      #REF_TABLE#
      , #TOATHUOC_ID#
      <!--, #SOTHUTUTOA#-->
      , #KHODUOC_ID#
      , #DUOC_ID#
      , #CHUYENKHOA_ID#
      , #NGUONHANG_ID#
      , #BENHVIEN_ID#
      , #SOLUONG#
      , #NGAYHIEULUC#
      , #NGAYTAO#
      , #NGUOITAO_ID#
      , #NGAYCAPNHAT#
      , #NGUOICAPNHAT_ID#
      <isNotEmpty prepend="," property="PHAMVI_ID">
        #PHAMVI_ID#
      </isNotEmpty>    
      )
    </insert>

    <update id="DAO00063_Update_Booking" parameterClass="HashTable" resultClass="System.Int64">
      update TT_DUOC_TONKHO_BOOK_NOITRU set
      SOLUONG = #SOLUONG#,
      DUOC_ID = #DUOC_ID#,
      NGAYHIEULUC = #NGAYHIEULUC#,
      NGUOICAPNHAT_ID = #NGUOICAPNHAT_ID#,
      NGAYCAPNHAT = #NGAYCAPNHAT#
      <isNotEmpty prepend="," property="PHAMVI_ID">
        PHAMVI_ID = #PHAMVI_ID#
      </isNotEmpty>
      <isNotEmpty prepend="," property="KHODUOC_ID">
        KHODUOC_ID = #KHODUOC_ID#
      </isNotEmpty>
      where
      BOOKING_ID = '$BOOKING_ID$'
    </update>

    <delete id="DAO00063_Delete_Booking" parameterClass="HashTable">
      delete from TT_DUOC_TONKHO_BOOK_NOITRU
      where REF_ID = #TOATHUOC_ID#
      and REF_TABLE = #REF_TABLE#
      and DUOC_ID = #DUOC_ID#
      and BENHVIEN_ID = #BENHVIEN_ID#
      <isNotEmpty prepend="and" property="PHAMVI_ID">
          PHAMVI_ID = #PHAMVI_ID#
        </isNotEmpty>
    </delete>

    <update id="DAO00063_UpdateBookingInfo" parameterClass="HashTable">
      update TT_DUOC_TONKHO_BOOK_NOITRU set
      SOLUONG = #SOLUONG#
      where
      KHODUOC_ID = '$KHODUOC_ID$'
      and DUOC_ID = '$DUOC_ID$'
      and BENHVIEN_ID = '$BENHVIEN_ID$'
      and NGAYHIEULUC = '$NGAYHIEULUC$'
      <isNotEmpty prepend="and" property="PHAMVI_ID">
      PHAMVI_ID = #PHAMVI_ID#
    </isNotEmpty>
    </update>

    <statement id="DAO00063_GetSLDuocDaLuu" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select sum(SOLUONG) as SOLUONG
      from TT_NOITRU_TOATHUOC
      where KHAMBENH_ID  = '$KHAMBENH_ID$'
      and DUOC_ID  = '$DUOC_ID$'
    </statement>

    <statement id="DAO00063_GetTrangThaiThuoc" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select CHUNGTU_ID, PHIEULINH_ID, HUYTOATHUOC, NGUOITAO_ID
      from TT_NOITRU_TOATHUOC
      where TOATHUOC_ID  = '$TOATHUOC_ID$'
    </statement>
    <statement id="DAO00063_AllGetTrangThaiThuocbyBenan_Id" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select A.CHUNGTU_ID, A.PHIEULINH_ID, A.HUYTOATHUOC, A.NGUOITAO_ID, A.TOATHUOC_ID
      from TT_NOITRU_TOATHUOC A
      inner join TT_NOITRU_KHAMBENH B on B.KHAMBENH_ID = A.KHAMBENH_ID
      where B.BENHAN_ID  = '$BENHAN_ID$'
    </statement>
    <statement id="DAO00063_DeleteThuocInList" parameterClass="HashTable" resultClass="DataObject">
      <!--select DUOC_ID, KHOPHAT_ID, SOLUONG, KHAMBENH_ID, BENHVIEN_ID
      from TT_NOITRU_TOATHUOC
      where KHAMBENH_ID = #KHAMBENH_ID#
      <dynamic prepend=" and TOATHUOC_ID in ">
        <iterate open="(" close=")" conjunction=",  " property="LSTTOATHUOC_ID">#LSTTOATHUOC_ID[]#</iterate>
      </dynamic>-->

      delete from TT_NOITRU_TOATHUOC
      where KHAMBENH_ID = #KHAMBENH_ID#
      <dynamic prepend=" and TOATHUOC_ID in ">
        <iterate open="(" close=")" conjunction=",  " property="LSTTOATHUOC_ID">#LSTTOATHUOC_ID[]#</iterate>
      </dynamic>
    </statement>

    <statement id="DAO00063_DeleteBookingInList" parameterClass="HashTable" resultClass="DataObject">
      delete from TT_DUOC_TONKHO_BOOK_NOITRU
      where REF_TABLE = #REF_TABLE#
      <dynamic prepend=" and REF_ID in ">
        <iterate open="(" close=")" conjunction=",  " property="LSTTOATHUOC_ID">#LSTTOATHUOC_ID[]#</iterate>
      </dynamic>
    </statement>
    <statement id="DAO00063_GetListDuocTonKho_Book_NoiTru" parameterClass="HashTable" resultClass="DataObject">
      select * from TT_DUOC_TONKHO_BOOK_NOITRU
      where REF_TABLE = #REF_TABLE#
      <dynamic prepend=" and REF_ID in ">
        <iterate open="(" close=")" conjunction=",  " property="LSTTOATHUOC_ID">#LSTTOATHUOC_ID[]#</iterate>
      </dynamic>
    </statement>
    <statement id="DAO00063_GetToaThuocByKhamBenhID" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      <!--select distinct a.*, b.SOLUONG as SOLUONGTAMNGUNG,
      vp.DONGIA_DOANHTHU, vp.THANHTIEN_DOANHTHU, vp.BHYT_DONGIA, vp.BHYT_THANHTIEN, vp.BHYT_DONGIA_CHITRA, vp.BHYT_THANHTIEN_CHITRA,
      pl.MACHUNGTU as SOPHIEULINH, ct.MACHUNGTU as SOCHUNGTU
      from TT_NOITRU_TOATHUOC a
      left join TT_NOITRU_TRATHUOC_CHITIET b on a.TOATHUOC_ID = b.TOATHUOC_ID
      left join TT_DUOC_PHIEULINH pl on pl.CHUNGTU_ID = a.PHIEULINH_ID
      left join TT_DUOC_CHUNGTU ct on ct.CHUNGTU_ID = a.CHUNGTU_ID
      inner join TT_VIENPHI vp on vp.REF_ID = a.TOATHUOC_ID and vp.REF_TABLE = 'TT_NOITRU_TOATHUOC' and vp.DUOC_ID = a.DUOC_ID
      where a.KHAMBENH_ID  = '$KHAMBENH_ID$'-->
      <!--select distinct a.*, b.SOLUONG as SOLUONGTAMNGUNG,
      --><!--vp.BHYT_DONGIA, vp.BHYT_THANHTIEN, vp.BHYT_DONGIA_CHITRA, vp.BHYT_THANHTIEN_CHITRA,--><!--
      pl.MACHUNGTU as SOPHIEULINH, ct.MACHUNGTU as SOCHUNGTU,
      (select top 1 THANHTIEN_DOANHTHU from TT_VIENPHI where REF_ID = a.TOATHUOC_ID and REF_TABLE = 'TT_NOITRU_TOATHUOC' and DUOC_ID = a.DUOC_ID and KHAMBENH_ID = '$KHAMBENH_ID$') THANHTIEN_DOANHTHU,
      (select top 1 DONGIA_DOANHTHU from TT_VIENPHI where REF_ID = a.TOATHUOC_ID and REF_TABLE = 'TT_NOITRU_TOATHUOC' and DUOC_ID = a.DUOC_ID and KHAMBENH_ID = '$KHAMBENH_ID$') DONGIA_DOANHTHU
      --><!--,(DONGIA_DOANHTHU * a.SOLUONG) THANHTIEN_DOANHTHU--><!--
      from TT_NOITRU_TOATHUOC a
      left join TT_NOITRU_TRATHUOC_CHITIET b on a.TOATHUOC_ID = b.TOATHUOC_ID
      left join TT_DUOC_PHIEULINH pl on pl.CHUNGTU_ID = a.PHIEULINH_ID
      left join TT_DUOC_CHUNGTU ct on ct.CHUNGTU_ID = a.CHUNGTU_ID
      --><!--inner join TT_VIENPHI vp on vp.REF_ID = a.TOATHUOC_ID and vp.REF_TABLE = 'TT_NOITRU_TOATHUOC' and vp.DUOC_ID = a.DUOC_ID--><!--
      where a.KHAMBENH_ID  = '$KHAMBENH_ID$'-->
      select distinct a.*, b.SOLUONG as SOLUONGTAMNGUNG,
      pl.MACHUNGTU as SOPHIEULINH, ct.MACHUNGTU as SOCHUNGTU
      ,vp.BHYT_DONGIA, vp.BHYT_THANHTIEN, vp.BHYT_DONGIA_CHITRA, vp.BHYT_THANHTIEN_CHITRA,
      vp.THANHTIEN_DOANHTHU, vp.DONGIA_DOANHTHU, dc.TENDUOCDAYDU, dc.BHYT DUOC_BHYT, ld.LOAIVATTU_ID, dc.DONVITINH
      , d.TAMNGUNG
      from TT_NOITRU_TOATHUOC a
      left join TT_NOITRU_TRATHUOC_CHITIET b on a.TOATHUOC_ID = b.TOATHUOC_ID
      left join TT_DUOC_PHIEULINH pl on pl.CHUNGTU_ID = a.PHIEULINH_ID
      left join TT_DUOC_CHUNGTU ct on ct.CHUNGTU_ID = a.CHUNGTU_ID
      left join TM_DUOC dc on a.DUOC_ID = dc.DUOC_ID
      left join TM_LOAIDUOC ld on dc.LOAIDUOC_ID = ld.LOAIDUOC_ID
      inner join TM_DUOC d on d.DUOC_ID = a.DUOC_ID
      left join (select max(BHYT_DONGIA) BHYT_DONGIA, Max(BHYT_THANHTIEN) BHYT_THANHTIEN, max(BHYT_DONGIA_CHITRA) BHYT_DONGIA_CHITRA,
      max(BHYT_THANHTIEN_CHITRA) BHYT_THANHTIEN_CHITRA, max(THANHTIEN_DOANHTHU) THANHTIEN_DOANHTHU, max(DONGIA_DOANHTHU) DONGIA_DOANHTHU,
      KHAMBENH_ID, REF_ID, REF_TABLE, DUOC_ID from TT_VIENPHI where KHAMBENH_ID = '$KHAMBENH_ID$' and REF_TABLE = 'TT_NOITRU_TOATHUOC'  group by KHAMBENH_ID, REF_ID, REF_TABLE, DUOC_ID)
      vp on vp.REF_ID = a.TOATHUOC_ID and vp.REF_TABLE = 'TT_NOITRU_TOATHUOC' and vp.DUOC_ID = a.DUOC_ID
      where a.KHAMBENH_ID  = '$KHAMBENH_ID$' and a.BENHVIEN_ID = '$BENHVIEN_ID$'
    </statement>

    <statement id="DAO00063_GetSoPhieuLinhByPhieuLinhID" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select MACHUNGTU as SOPHIEULINH
      from TT_DUOC_PHIEULINH
      where CHUNGTU_ID  = '$PHIEULINH_ID$'
    </statement>    

    <statement id="DAO00063_GetSoChungTuByChungTuID" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select MACHUNGTU as SOCHUNGTU
      from TT_DUOC_CHUNGTU
      where CHUNGTU_ID  = '$CHUNGTU_ID$'
    </statement>
    
    <statement id="DAO00063_GetTThaiNhapNoiBo" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select * from TT_DUOC_CHUNGTU where CHUNGTU_ID in
      (select CHUNGTU_ID from TT_DUOC_CHUNGTU_CHITIET where TOATHUOCNOITRU_ID = '$TOATHUOC_ID$')
      <!--and LOAICHUNGTU = 'N'-->
      and BENHVIEN_ID = '$BENHVIEN_ID$'
    </statement>

    <statement id="DAO00063_GetDSThuocByBenhNhanID" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select DUOC_ID, SOLUONG, NGAYTAO, SONGAY from TT_NOITRU_TOATHUOC
      where exists (select KHAMBENH_ID from TT_NOITRU_KHAMBENH
      where TT_NOITRU_TOATHUOC.KHAMBENH_ID = KHAMBENH_ID and ISYLENHVTYT = '0'
      and exists (select TIEPNHAN_ID from TT_TIEPNHAN where TT_NOITRU_KHAMBENH.TIEPNHAN_ID = TIEPNHAN_ID and BENHNHAN_ID = '$BENHNHAN_ID$'))
      and BENHVIEN_ID = '$BENHVIEN_ID$'

      <isNotEmpty prepend="and" property="TUNGAY">
        convert(date, NGAYTAO) &#62;&#61; convert(date, '$TUNGAY$')
      </isNotEmpty>
      <isNotEmpty prepend="and" property="DENNGAY">
        convert(date, NGAYTAO) &#60;&#61; convert(date, '$DENNGAY$')
      </isNotEmpty>
      <!--order by NGAYTAO-->

      union

      select A.DUOC_ID, SOLUONG, A.NGAYTAO, SONGAY
      from TT_NGOAITRU_TOATHUOC A
      inner join TM_DUOC B on B.DUOC_ID = A.DUOC_ID
      left join TM_LOAIDUOC C on C.LOAIDUOC_ID = B.LOAIDUOC_ID
      where exists (select KHAMBENH_ID from TT_NGOAITRU_KHAMBENH
      where TT_NGOAITRU_KHAMBENH.KHAMBENH_ID = KHAMBENH_ID and exists (select TIEPNHAN_ID from TT_TIEPNHAN where TT_NGOAITRU_KHAMBENH.TIEPNHAN_ID = TIEPNHAN_ID and BENHNHAN_ID = '$BENHNHAN_ID$'))
      and A.BENHVIEN_ID = '$BENHVIEN_ID$'

      <isNotEmpty prepend="and" property="TUNGAY">
        convert(date, A.NGAYTAO) &#62;&#61; convert(date, '$TUNGAY$')
      </isNotEmpty>
      <isNotEmpty prepend="and" property="DENNGAY">
        convert(date, A.NGAYTAO) &#60;&#61; convert(date, '$DENNGAY$')
      </isNotEmpty>
      order by NGAYTAO

    </statement>
    <statement id="DAO00063_GetListKhoThuocPhongBanPhamvi" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select distinct dpv.*
      from TM_DUOC_PHAMVISD_MAPPING dmap
      left join TM_DUOC_PHAMVISUDUNG dpv on dpv.PHAMVI_ID = dmap.PHAMVI_ID
      where dmap.KHODUOC_ID in (select KHODUOC_ID from TM_PHONGBAN_KHODUOC where PHONGBAN_ID = '$PHONGBAN_ID$')
    </statement>
    <statement id="DAO00063_GetListPhamviTuKhoThuocVaPhongBan" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select distinct dpv.*, dmap.KHODUOC_ID
      from TM_DUOC_PHAMVISD_MAPPING dmap
      left join TM_DUOC_PHAMVISUDUNG dpv on dpv.PHAMVI_ID = dmap.PHAMVI_ID and dpv.TAMNGUNG != '1'
      where dmap.KHODUOC_ID in (select KHODUOC_ID from TM_PHONGBAN_KHODUOC where PHONGBAN_ID = '$PHONGBAN_ID$')
      and dmap.KHODUOC_ID = '$KHODUOC_ID$' and dpv.MAPHAMVI is not null
    </statement>
    <statement id="DAO00063_GetKhoduocUuTienTuPhamvi" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select top 1 dmap.*
      from TM_DUOC_PHAMVISD_MAPPING dmap
      where dmap.PHAMVI_ID = '$PHAMVI_ID$'
    </statement>
    <statement id="DAO00063_GetTrangThaiYLenhTheoTiepnhanId" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select tt.CHUNGTU_ID, tt.PHIEULINH_ID, tt.TRANGTHAI, pl.DUYET as DUYETPHIEULINH,
      ct.CHUNGTU_ID as CHUNGTUXUATNOIBO_ID, ct.LOAICHUNGTU, tt.KHAMBENH_ID, tt.DUOC_ID, tt.SOLUONG
      from TT_NOITRU_TOATHUOC tt
      left join TT_DUOC_PHIEULINH pl on tt.PHIEULINH_ID = pl.CHUNGTU_ID
      left join TT_DUOC_CHUNGTU ct on pl.CHUNGTU_ID = ct.PHIEULINH_ID
      where tt.TIEPNHAN_ID = '$TIEPNHAN_ID$'
      and (tt.PHIEULINH_ID is not null or tt.CHUNGTU_ID is not null or (tt.TRANGTHAI = 'DADUYET'))
      order by tt.CHUNGTU_ID DESC
    </statement>
    <statement id="DAO00063_GetDanhsachTrathuocTheoBenhanId" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select A.KHAMBENH_ID, B.TOATHUOC_ID, B.DUOC_ID, SUM(B.SOLUONG) SOLUONG
      from TT_NOITRU_TRATHUOC A
      left join TT_NOITRU_TRATHUOC_CHITIET B on A.TRATHUOC_ID = B.TRATHUOC_ID
      where A.BENHAN_ID = '$BENHAN_ID$' <!--and B.DAHOANTRA = '1'-->
      group by A.KHAMBENH_ID, B.TOATHUOC_ID, B.DUOC_ID
    </statement>
    <statement id="DAO00063_Add_YLenhThuoc" parameterClass="System.String" resultClass="System.Int32">
      declare @jsonVienPhi nvarchar(max);
      set @jsonVienPhi = N'{
      "DATA": $JSON_DATA$
      }';

      declare @TOATHUOC_ID int;
      declare @SOTHUTUTOA varchar(10);
      declare @KHAMBENH_ID int;
      declare @TIEPNHAN_ID int;
      declare @BENHNHAN_ID int;
      declare @NGUONDUOC_ID int;
      declare @DUOC_ID int;
      declare @SOLUONG numeric(18, 4);
      declare @SONGAY numeric(4, 2);
      declare @SOLANTRENNGAY numeric(4, 2);
      declare @SOLUONGTRENLAN numeric(18, 4);
      declare @SOLUONG_BUOISANG numeric(18, 4);
      declare @SOLUONG_BUOITRUA numeric(18, 4);
      declare @SOLUONG_BUOICHIEU numeric(18, 4);
      declare @SOLUONG_BUOITOI numeric(18, 4);
      declare @DUONGDUNG_ID int;
      declare @COSO char(1);
      declare @KHOTAO_ID int;
      declare @KHOPHAT_ID int;
      declare @GHICHU nvarchar(max);
      declare @PHIEULINH_ID int;
      declare @CHUNGTU_ID int;
      declare @PHONGBANRATOA_ID int;
      declare @NGUONLAYTHUOC char(1);
      declare @VTYT char(1);
      declare @PHATTHUOCTAIQUAY char(1);
      declare @MUANGOAI char(1);
      declare @TINHTIEN char(1);
      declare @MIENPHI char(1);
      declare @BHYTDONGTIEN char(1);
      declare @KHONGTHUTIEN char(1);
      declare @HUYTOATHUOC char(1);
      declare @TRANGTHAI varchar(20);
      declare @BENHVIEN_ID varchar(10);
      declare @NGAYTAO datetime;
      declare @NGUOITAO_ID int;
      declare @NGAYCAPNHAT datetime;
      declare @NGUOICAPNHAT_ID int;
      declare @PHAMVI_ID int;
      declare @CHEDODINHDUONG nvarchar(max);

      declare @VIENPHI nvarchar(max);
      declare @BENHAN_ID int = #BENHAN_ID#;
      declare @DOTDIEUTRI_ID int;
      declare @DONGIA_DOANHTHU numeric(25, 4);
      declare @THANHTIEN_DOANHTHU numeric(25, 4);
      declare @BHYT_DONGIA numeric(25, 4);
      declare @BHYT_THANHTIEN numeric(25, 4);
      declare @BHYT_DONGIA_CHITRA numeric(25, 4);
      declare @BHYT_THANHTIEN_CHITRA numeric(25, 4);
      declare @BENHNHAN_PHAITHANHTOAN numeric(25, 4);
      declare @DOITUONG_HUONG_ID numeric(25, 4);
      declare @SOBHYT_HUONG_ID numeric(25, 4);

      declare @iTotal int = #TOTAL_RECORD#;
      declare @icnt int = 0;
      WHILE @iTotal > @icnt
      BEGIN
      declare @dyn_sql nvarchar(1000) = 'select @data = json_query(@json_dyn, ''' + CHAR(36) +'.DATA[' + cast(@icnt as varchar(10)) + ']'');'
      declare @jsondatamax nvarchar(max);

      exec sp_executesql @dyn_sql
      , N'@json_dyn nvarchar(max), @data nvarchar(max) OUTPUT'
      , @json_dyn = @jsonVienPhi
      , @data = @jsondatamax OUTPUT

      select
      @SOTHUTUTOA =  JSON_VALUE(@jsondatamax, '' + CHAR(36) +'.SOTHUTUTOA'),
      @KHAMBENH_ID =  JSON_VALUE(@jsondatamax, '' + CHAR(36) +'.KHAMBENH_ID'),
      @TIEPNHAN_ID =  JSON_VALUE(@jsondatamax, '' + CHAR(36) +'.TIEPNHAN_ID'),
      @BENHNHAN_ID =  JSON_VALUE(@jsondatamax, '' + CHAR(36) +'.BENHNHAN_ID'),
      @NGUONDUOC_ID =  JSON_VALUE(@jsondatamax, '' + CHAR(36) +'.NGUONDUOC_ID'),
      @DUOC_ID =  JSON_VALUE(@jsondatamax, '' + CHAR(36) +'.DUOC_ID'),
      @SOLUONG =  JSON_VALUE(@jsondatamax, '' + CHAR(36) +'.SOLUONG'),
      @SONGAY =  JSON_VALUE(@jsondatamax, '' + CHAR(36) +'.SONGAY'),
      @SOLANTRENNGAY =  JSON_VALUE(@jsondatamax, '' + CHAR(36) +'.SOLANTRENNGAY'),
      @SOLUONGTRENLAN =  JSON_VALUE(@jsondatamax, '' + CHAR(36) +'.SOLUONGTRENLAN'),
      @SOLUONG_BUOISANG =  JSON_VALUE(@jsondatamax, '' + CHAR(36) +'.SOLUONG_BUOISANG'),
      @SOLUONG_BUOITRUA =  JSON_VALUE(@jsondatamax, '' + CHAR(36) +'.SOLUONG_BUOITRUA'),
      @SOLUONG_BUOICHIEU =  JSON_VALUE(@jsondatamax, '' + CHAR(36) +'.SOLUONG_BUOICHIEU'),
      @SOLUONG_BUOITOI =  JSON_VALUE(@jsondatamax, '' + CHAR(36) +'.SOLUONG_BUOITOI'),
      @DUONGDUNG_ID =  JSON_VALUE(@jsondatamax, '' + CHAR(36) +'.DUONGDUNG_ID'),
      @COSO =  JSON_VALUE(@jsondatamax, '' + CHAR(36) +'.COSO'),
      @KHOTAO_ID =  JSON_VALUE(@jsondatamax, '' + CHAR(36) +'.KHOTAO_ID'),
      @KHOPHAT_ID =  JSON_VALUE(@jsondatamax, '' + CHAR(36) +'.KHOPHAT_ID'),
      @GHICHU =  JSON_VALUE(@jsondatamax, '' + CHAR(36) +'.GHICHU'),
      @PHIEULINH_ID =  JSON_VALUE(@jsondatamax, '' + CHAR(36) +'.PHIEULINH_ID'),
      @CHUNGTU_ID =  JSON_VALUE(@jsondatamax, '' + CHAR(36) +'.CHUNGTU_ID'),
      @PHONGBANRATOA_ID =  JSON_VALUE(@jsondatamax, '' + CHAR(36) +'.PHONGBANRATOA_ID'),
      @NGUONLAYTHUOC =  JSON_VALUE(@jsondatamax, '' + CHAR(36) +'.NGUONLAYTHUOC'),
      @VTYT =  JSON_VALUE(@jsondatamax, '' + CHAR(36) +'.VTYT'),
      @PHATTHUOCTAIQUAY =  JSON_VALUE(@jsondatamax, '' + CHAR(36) +'.PHATTHUOCTAIQUAY'),
      @MUANGOAI =  JSON_VALUE(@jsondatamax, '' + CHAR(36) +'.MUANGOAI'),
      @TINHTIEN =  JSON_VALUE(@jsondatamax, '' + CHAR(36) +'.TINHTIEN'),
      @MIENPHI =  JSON_VALUE(@jsondatamax, '' + CHAR(36) +'.MIENPHI'),
      @BHYTDONGTIEN =  JSON_VALUE(@jsondatamax, '' + CHAR(36) +'.BHYTDONGTIEN'),
      @KHONGTHUTIEN =  JSON_VALUE(@jsondatamax, '' + CHAR(36) +'.KHONGTHUTIEN'),
      @HUYTOATHUOC =  JSON_VALUE(@jsondatamax, '' + CHAR(36) +'.HUYTOATHUOC'),
      @TRANGTHAI =  JSON_VALUE(@jsondatamax, '' + CHAR(36) +'.TRANGTHAI'),
      @BENHVIEN_ID =  JSON_VALUE(@jsondatamax, '' + CHAR(36) +'.BENHVIEN_ID'),
      @NGAYTAO =  JSON_VALUE(@jsondatamax, '' + CHAR(36) +'.NGAYTAO'),
      @NGUOITAO_ID =  JSON_VALUE(@jsondatamax, '' + CHAR(36) +'.NGUOITAO_ID'),
      @NGAYCAPNHAT =  JSON_VALUE(@jsondatamax, '' + CHAR(36) +'.NGAYCAPNHAT'),
      @NGUOICAPNHAT_ID =  JSON_VALUE(@jsondatamax, '' + CHAR(36) +'.NGUOICAPNHAT_ID'),
      @PHAMVI_ID =  JSON_VALUE(@jsondatamax, '' + CHAR(36) +'.PHAMVI_ID'),
      @CHEDODINHDUONG =  JSON_VALUE(@jsondatamax, '' + CHAR(36) +'.CHEDODINHDUONG'),
      @DOTDIEUTRI_ID =  JSON_VALUE(@jsondatamax, '' + CHAR(36) +'.DOTDIEUTRI_ID'),
      @DOITUONG_HUONG_ID =  JSON_VALUE(@jsondatamax, '' + CHAR(36) +'.DOITUONG_HUONG_ID'),
      @SOBHYT_HUONG_ID =  JSON_VALUE(@jsondatamax, '' + CHAR(36) +'.SOBHYT_HUONG_ID'),

      <!--TT_VIENPHI-->
      @DONGIA_DOANHTHU =  JSON_VALUE(@jsondatamax, '' + CHAR(36) +'.VIENPHI.DONGIA_DOANHTHU'),
      @THANHTIEN_DOANHTHU =  JSON_VALUE(@jsondatamax, '' + CHAR(36) +'.VIENPHI.THANHTIEN_DOANHTHU'),
      @BHYT_DONGIA =  JSON_VALUE(@jsondatamax, '' + CHAR(36) +'.VIENPHI.BHYT_DONGIA'),
      @BHYT_THANHTIEN =  JSON_VALUE(@jsondatamax, '' + CHAR(36) +'.VIENPHI.BHYT_THANHTIEN'),
      @BHYT_DONGIA_CHITRA =  JSON_VALUE(@jsondatamax, '' + CHAR(36) +'.VIENPHI.BHYT_DONGIA_CHITRA'),
      @BHYT_THANHTIEN_CHITRA =  JSON_VALUE(@jsondatamax, '' + CHAR(36) +'.VIENPHI.BHYT_THANHTIEN_CHITRA'),
      @BENHNHAN_PHAITHANHTOAN =  JSON_VALUE(@jsondatamax, '' + CHAR(36) +'.VIENPHI.BENHNHAN_PHAITHANHTOAN')

      insert into TT_NOITRU_TOATHUOC
      ([SOTHUTUTOA],[KHAMBENH_ID],[TIEPNHAN_ID],[BENHNHAN_ID],[NGUONDUOC_ID]
      ,[DUOC_ID],[SOLUONG],[SONGAY],[SOLANTRENNGAY],[SOLUONGTRENLAN],[SOLUONG_BUOISANG],[SOLUONG_BUOITRUA],[SOLUONG_BUOICHIEU]
      ,[SOLUONG_BUOITOI],[DUONGDUNG_ID],[COSO],[KHOTAO_ID],[KHOPHAT_ID],[GHICHU],[PHIEULINH_ID],[CHUNGTU_ID],[PHONGBANRATOA_ID]
      ,[NGUONLAYTHUOC],[VTYT],[PHATTHUOCTAIQUAY],[MUANGOAI],[TINHTIEN],[MIENPHI],[BHYTDONGTIEN],[KHONGTHUTIEN],[HUYTOATHUOC]
      ,[TRANGTHAI],[BENHVIEN_ID],[NGAYTAO],[NGUOITAO_ID],[NGAYCAPNHAT],[NGUOICAPNHAT_ID],[PHAMVI_ID],[CHEDODINHDUONG])
      VALUES
      (@SOTHUTUTOA,@KHAMBENH_ID,@TIEPNHAN_ID,@BENHNHAN_ID,@NGUONDUOC_ID
      ,@DUOC_ID,@SOLUONG,@SONGAY,@SOLANTRENNGAY,@SOLUONGTRENLAN,@SOLUONG_BUOISANG,@SOLUONG_BUOITRUA,@SOLUONG_BUOICHIEU
      ,@SOLUONG_BUOITOI,@DUONGDUNG_ID,@COSO,@KHOTAO_ID,@KHOPHAT_ID,@GHICHU,@PHIEULINH_ID,@CHUNGTU_ID,@PHONGBANRATOA_ID
      ,@NGUONLAYTHUOC,@VTYT,@PHATTHUOCTAIQUAY,@MUANGOAI,@TINHTIEN,@MIENPHI,@BHYTDONGTIEN,@KHONGTHUTIEN,@HUYTOATHUOC
      ,@TRANGTHAI,@BENHVIEN_ID,GETDATE(),@NGUOITAO_ID,GETDATE(),@NGUOICAPNHAT_ID,@PHAMVI_ID,@CHEDODINHDUONG)
      <!--get toathuoc_id-->
      set @TOATHUOC_ID = SCOPE_IDENTITY()

      <!--insert TT_VIENPHI-->
      INSERT INTO TT_VIENPHI
      ([TIEPNHAN_ID],[BENHAN_ID]
      ,[DOTDIEUTRI_ID],[BENHNHAN_ID],[KHAMBENH_ID],[REF_ID],[REF_TABLE],[DICHVU_ID],[DUOC_ID],[LOAI_CHIPHI]
      ,[SOLUONG],[DONGIA_DOANHTHU],[THANHTIEN_DOANHTHU],[BHYT_DONGIA],[BHYT_THANHTIEN],[HUY],[DATHANHTOAN]
      ,[DATHUCHIEN],[KHONGTHUTIEN],[BHYTDONGTIEN],[BENHVIEN_ID],[NGUOITAO_ID],[NGAYTAO],[NGUOICAPNHAT_ID],
      [NGAYCAPNHAT], [DOITUONG_HUONG_ID], [SOBHYT_HUONG_ID], [BHYT_DONGIA_CHITRA], [BHYT_THANHTIEN_CHITRA], [BENHNHAN_PHAITHANHTOAN])
      VALUES
      (@TIEPNHAN_ID,@BENHAN_ID
      ,@DOTDIEUTRI_ID,@BENHNHAN_ID,@KHAMBENH_ID,@TOATHUOC_ID,'TT_NOITRU_TOATHUOC',null,@DUOC_ID,'TT'
      ,@SOLUONG,@DONGIA_DOANHTHU,@THANHTIEN_DOANHTHU,@BHYT_DONGIA,@BHYT_THANHTIEN,'0','0'
      ,'0',@KHONGTHUTIEN,@BHYTDONGTIEN,@BENHVIEN_ID,@NGUOITAO_ID,GETDATE(),@NGUOICAPNHAT_ID,GETDATE(), @DOITUONG_HUONG_ID, @SOBHYT_HUONG_ID
      ,@BHYT_DONGIA_CHITRA, @BHYT_THANHTIEN_CHITRA, @BENHNHAN_PHAITHANHTOAN)

      <!--insert TT_DUOC_TONKHO_BOOK_NOITRU-->
      insert into TT_DUOC_TONKHO_BOOK_NOITRU
      ([REF_TABLE],[REF_ID],[PHAMVI_ID],[KHODUOC_ID],[DUOC_ID],[SOLUONG],[NGUONHANG_ID],[CHUYENKHOA_ID]
      ,[GHICHU],[BENHVIEN_ID],[NGAYTAO],[NGUOITAO_ID],[NGAYCAPNHAT],[NGUOICAPNHAT_ID], [TRANGTHAI], [NGAYHIEULUC])
      VALUES
      ('TT_NOITRU_TOATHUOC',@TOATHUOC_ID,@PHAMVI_ID,@KHOPHAT_ID,@DUOC_ID,@SOLUONG,@NGUONDUOC_ID,@PHONGBANRATOA_ID
      ,@GHICHU,@BENHVIEN_ID,GETDATE(),@NGUOITAO_ID,GETDATE(),@NGUOICAPNHAT_ID, 'HIEULUC', GETDATE())

      set @icnt = @icnt + 1;
      END
      select @TOATHUOC_ID
    </statement>
    <statement id="DAO00063_Getlist_Thuoc_Delete" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select * FROM TT_NOITRU_TOATHUOC where TOATHUOC_ID in ($LST_TOATHUOC_ID$)
    </statement>
    <statement id="DAO00063_Getlist_Thuoc_Tamngung" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select DUOC_ID FROM TM_DUOC where TAMNGUNG = '1'
    </statement>
    <statement id="DAO00063_Delete_YLenhThuoc" parameterClass="System.String" resultClass="System.Int32">
      DELETE FROM TT_DUOC_TONKHO_BOOK_NOITRU where REF_TABLE = 'TT_NOITRU_TOATHUOC' and REF_ID in ($LST_TOATHUOC_ID$)

      DELETE FROM TT_VIENPHI where REF_TABLE = 'TT_NOITRU_TOATHUOC' and REF_ID in ($LST_TOATHUOC_ID$)

      DELETE FROM TT_NOITRU_TOATHUOC where TOATHUOC_ID in ($LST_TOATHUOC_ID$)
      
    </statement>
    <statement id="DAO00063_Update_YLenhThuoc" parameterClass="System.String" resultClass="System.Int32">
      declare @jsonVienPhi nvarchar(max);
      set @jsonVienPhi = N'{
      "DATA": $JSON_DATA$
      }';

      declare @TOATHUOC_ID int;
      declare @KHAMBENH_ID int;
      declare @TIEPNHAN_ID int;
      declare @BENHNHAN_ID int;
      declare @SOLUONG numeric(18, 4);
      declare @SONGAY numeric(4, 2);
      declare @SOLANTRENNGAY numeric(4, 2);
      declare @SOLUONGTRENLAN numeric(18, 4);
      declare @SOLUONG_BUOISANG numeric(18, 4);
      declare @SOLUONG_BUOITRUA numeric(18, 4);
      declare @SOLUONG_BUOICHIEU numeric(18, 4);
      declare @SOLUONG_BUOITOI numeric(18, 4);
      declare @GHICHU nvarchar(max);
      declare @NGUOICAPNHAT_ID int;

      declare @TINHTIEN char(1);
      declare @MIENPHI char(1);
      declare @BHYTDONGTIEN char(1);
      declare @KHONGTHUTIEN char(1);

      declare @VIENPHI nvarchar(max);
      declare @BENHAN_ID int = #BENHAN_ID#;

      declare @iTotal int = #TOTAL_RECORD#;
      declare @icnt int = 0;
      WHILE @iTotal > @icnt
      BEGIN
      declare @dyn_sql nvarchar(1000) = 'select @data = json_query(@json_dyn, ''' + CHAR(36) +'.DATA[' + cast(@icnt as varchar(10)) + ']'');'
      declare @jsondatamax nvarchar(max);

      exec sp_executesql @dyn_sql
      , N'@json_dyn nvarchar(max), @data nvarchar(max) OUTPUT'
      , @json_dyn = @jsonVienPhi
      , @data = @jsondatamax OUTPUT

      select
      @TOATHUOC_ID =  JSON_VALUE(@jsondatamax, '' + CHAR(36) +'.TOATHUOC_ID'),
      @KHAMBENH_ID =  JSON_VALUE(@jsondatamax, '' + CHAR(36) +'.KHAMBENH_ID'),
      @TIEPNHAN_ID =  JSON_VALUE(@jsondatamax, '' + CHAR(36) +'.TIEPNHAN_ID'),
      @BENHNHAN_ID =  JSON_VALUE(@jsondatamax, '' + CHAR(36) +'.BENHNHAN_ID'),
      @SOLUONG =  JSON_VALUE(@jsondatamax, '' + CHAR(36) +'.SOLUONG'),
      @SONGAY =  JSON_VALUE(@jsondatamax, '' + CHAR(36) +'.SONGAY'),
      @SOLANTRENNGAY =  JSON_VALUE(@jsondatamax, '' + CHAR(36) +'.SOLANTRENNGAY'),
      @SOLUONGTRENLAN =  JSON_VALUE(@jsondatamax, '' + CHAR(36) +'.SOLUONGTRENLAN'),
      @SOLUONG_BUOISANG =  JSON_VALUE(@jsondatamax, '' + CHAR(36) +'.SOLUONG_BUOISANG'),
      @SOLUONG_BUOITRUA =  JSON_VALUE(@jsondatamax, '' + CHAR(36) +'.SOLUONG_BUOITRUA'),
      @SOLUONG_BUOICHIEU =  JSON_VALUE(@jsondatamax, '' + CHAR(36) +'.SOLUONG_BUOICHIEU'),
      @SOLUONG_BUOITOI =  JSON_VALUE(@jsondatamax, '' + CHAR(36) +'.SOLUONG_BUOITOI'),
      @GHICHU =  JSON_VALUE(@jsondatamax, '' + CHAR(36) +'.GHICHU'),
      @NGUOICAPNHAT_ID =  JSON_VALUE(@jsondatamax, '' + CHAR(36) +'.NGUOICAPNHAT_ID'),
      @TINHTIEN =  JSON_VALUE(@jsondatamax, '' + CHAR(36) +'.TINHTIEN'),
      @MIENPHI =  JSON_VALUE(@jsondatamax, '' + CHAR(36) +'.MIENPHI'),
      @BHYTDONGTIEN =  JSON_VALUE(@jsondatamax, '' + CHAR(36) +'.BHYTDONGTIEN'),
      @KHONGTHUTIEN =  JSON_VALUE(@jsondatamax, '' + CHAR(36) +'.KHONGTHUTIEN')
      <!--update TT_NOITRU_TOATHUOC-->
      update TT_NOITRU_TOATHUOC
      set [SOLUONG] = @SOLUONG
      ,[SONGAY] = @SONGAY
      ,[SOLANTRENNGAY] = @SOLANTRENNGAY
      ,[SOLUONGTRENLAN] = @SOLUONGTRENLAN
      ,[SOLUONG_BUOISANG] = @SOLUONG_BUOISANG
      ,[SOLUONG_BUOITRUA] = @SOLUONG_BUOITRUA
      ,[SOLUONG_BUOICHIEU] = @SOLUONG_BUOICHIEU
      ,[SOLUONG_BUOITOI] = @SOLUONG_BUOITOI
      ,[GHICHU] = @GHICHU
      ,[NGAYCAPNHAT] = GETDATE()
      ,[NGUOICAPNHAT_ID] =  @NGUOICAPNHAT_ID
      , TINHTIEN =  @TINHTIEN
      , MIENPHI =  @MIENPHI
      , BHYTDONGTIEN =  @BHYTDONGTIEN
      , KHONGTHUTIEN =  @KHONGTHUTIEN
      where TOATHUOC_ID = @TOATHUOC_ID
      <!--update TT_VIENPHI-->
      update TT_VIENPHI set SOLUONG = @SOLUONG, NGUOICAPNHAT_ID = @NGUOICAPNHAT_ID
      , THANHTIEN_DOANHTHU = @SOLUONG * DONGIA_DOANHTHU
      , BHYT_THANHTIEN = @SOLUONG * BHYT_DONGIA
      , BHYT_THANHTIEN_CHITRA = @SOLUONG * BHYT_DONGIA_CHITRA
      , BENHNHAN_PHAITHANHTOAN = THANHTIEN_DOANHTHU - BHYT_THANHTIEN_CHITRA
      , NGAYCAPNHAT = GETDATE()
      , BHYTDONGTIEN =  @BHYTDONGTIEN
      , KHONGTHUTIEN =  @KHONGTHUTIEN
      where REF_TABLE = 'TT_NOITRU_TOATHUOC' and KHAMBENH_ID = @KHAMBENH_ID and REF_ID = @TOATHUOC_ID

      <!--update TT_DUOC_TONKHO_BOOK_NOITRU-->
      update TT_DUOC_TONKHO_BOOK_NOITRU set SOLUONG = @SOLUONG, NGUOICAPNHAT_ID = @NGUOICAPNHAT_ID, NGAYCAPNHAT = GETDATE()
      where REF_TABLE = 'TT_NOITRU_TOATHUOC' and REF_ID = @TOATHUOC_ID  

      set @icnt = @icnt + 1;
      END

      select @TOATHUOC_ID
    </statement>
    
  </statements>
</sqlMap>
