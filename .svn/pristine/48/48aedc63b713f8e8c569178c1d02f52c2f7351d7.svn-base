<?xml version="1.0" encoding="utf-8" ?>
<!--============================================================================
//	CAUTION: This file is generated by IBatisNetGen.3.SQLMap.cst at 12/21/2015 2:22:43 PM
//				Any manual editing will be lost in re-generation.
//===========================================================================-->
<sqlMap namespace="eHospital" xmlns="http://ibatis.apache.org/mapping" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">

  <statements>
    <statement id="DAO00090_GetAll" resultClass="DataObject">
      select *
      from TT_NOITRU_TRATHUOC_CHITIET
      order by TRATHUOCCHITIET_ID
    </statement>
    <statement id="DAO00090_GetList" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select ttct.*, dc.TENDUOCDAYDU, tt.SOLUONG as SLYLENH, kb.THOIGIANKHAM
      from TT_NOITRU_TRATHUOC_CHITIET ttct
      left join TT_NOITRU_TOATHUOC tt on ttct.TOATHUOC_ID = tt.TOATHUOC_ID
      left join TT_NOITRU_KHAMBENH kb on kb.KHAMBENH_ID = tt.KHAMBENH_ID
      left join TM_DUOC dc on tt.DUOC_ID = dc.DUOC_ID
      <dynamic prepend="where">
        <isParameterPresent>
          <isNotEmpty prepend="and" property="TRATHUOC_ID">
            ttct.TRATHUOC_ID = '$TRATHUOC_ID$'
          </isNotEmpty>          
        </isParameterPresent>
      </dynamic>
      order by ttct.TRATHUOCCHITIET_ID
    </statement>
    <statement id="DAO00090_GetDetail" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select *
      from TT_NOITRU_TRATHUOC_CHITIET
      where TRATHUOCCHITIET_ID  = '$value$'
      order by TRATHUOCCHITIET_ID
    </statement>
    <statement id="DAO00090_GetDetailP" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select *
      from TT_NOITRU_TRATHUOC_CHITIET
      where TRATHUOCCHITIET_ID  = '$TRATHUOCCHITIET_ID$'
      order by TRATHUOCCHITIET_ID
    </statement>
    <statement id="DAO00090_Add" parameterClass="System.Collections.IDictionary" resultClass="System.Int64">
      declare @SOLUONGYLENH numeric(25,4) = 0
      declare @SOLUONGBOOK numeric(25,4) = 0
      select @SOLUONGYLENH = isnull(SOLUONG,0) from TT_NOITRU_TOATHUOC where TOATHUOC_ID = #TOATHUOC_ID#
      set @SOLUONGBOOK = @SOLUONGYLENH - #SOLUONG#

      update TT_DUOC_TONKHO_BOOK_NOITRU set SOLUONG = @SOLUONGBOOK where REF_TABLE = 'TT_NOITRU_TOATHUOC' and REF_ID = #TOATHUOC_ID#

      insert into TT_NOITRU_TRATHUOC_CHITIET (
      TRATHUOC_ID
      , TOATHUOC_ID
      , DUOC_ID
      , SOLUONG
      , DAHOANTRA
      , CHUNGTUTRA_ID
      , CHUNGTUCHITIET_ID
      , NGUOITAO_ID
      , NGAYTAO
      , NGUOICAPNHAT_ID
      , NGAYCAPNHAT
      , BENHVIEN_ID
      ) values (
      #TRATHUOC_ID#
      , #TOATHUOC_ID#
      , #DUOC_ID#
      , #SOLUONG#
      , #DAHOANTRA#
      , #CHUNGTUTRA_ID#
      , #CHUNGTUCHITIET_ID#
      , #NGUOITAO_ID#
      , #NGAYTAO#
      , #NGUOICAPNHAT_ID#
      , #NGAYCAPNHAT#
      , #BENHVIEN_ID#
      )
      SELECT SCOPE_IDENTITY()
      <!--<selectKey resultClass="System.Int64" type="post" >
        SELECT @@IDENTITY as value
      </selectKey>-->
    </statement>

    <update id="DAO00090_Update" parameterClass="System.Collections.IDictionary">
      update TT_NOITRU_TRATHUOC_CHITIET set
      TRATHUOC_ID = #TRATHUOC_ID#
      , TOATHUOC_ID = #TOATHUOC_ID#
      , DUOC_ID = #DUOC_ID#
      , SOLUONG = #SOLUONG#
      <!--, DAHOANTRA = #DAHOANTRA#
      , CHUNGTUTRA_ID = #CHUNGTUTRA_ID#
      , CHUNGTUCHITIET_ID = #CHUNGTUCHITIET_ID#-->
      , NGUOICAPNHAT_ID = #NGUOICAPNHAT_ID#
      , NGAYCAPNHAT = #NGAYCAPNHAT#
      , BENHVIEN_ID = #BENHVIEN_ID#
      where
      TRATHUOCCHITIET_ID = '$TRATHUOCCHITIET_ID$'
      AND CHUNGTUTRA_ID IS NULL

      declare @SOLUONGYLENH numeric(25,4) = 0
      declare @SOLUONGBOOK numeric(25,4) = 0
      select @SOLUONGYLENH = isnull(SOLUONG,0) from TT_NOITRU_TOATHUOC where TOATHUOC_ID = #TOATHUOC_ID#
      set @SOLUONGBOOK = @SOLUONGYLENH - #SOLUONG#

      update TT_DUOC_TONKHO_BOOK_NOITRU set SOLUONG = @SOLUONGBOOK where REF_TABLE = 'TT_NOITRU_TOATHUOC' and REF_ID = #TOATHUOC_ID#

    </update>

    <statement id="DAO00090_Delete" parameterClass="System.Collections.IDictionary" resultClass="System.Int32">
      declare @SOLUONGYLENH numeric(25,4) = 0
      declare @TOATHUOC_ID int
      select @TOATHUOC_ID = TOATHUOC_ID from TT_NOITRU_TRATHUOC_CHITIET where TRATHUOCCHITIET_ID = '$TRATHUOCCHITIET_ID$'

      select @SOLUONGYLENH = isnull(SOLUONG,0) from TT_NOITRU_TOATHUOC where TOATHUOC_ID = @TOATHUOC_ID

      update TT_DUOC_TONKHO_BOOK_NOITRU set SOLUONG = @SOLUONGYLENH where REF_TABLE = 'TT_NOITRU_TOATHUOC' and REF_ID = @TOATHUOC_ID

      delete from TT_NOITRU_TRATHUOC_CHITIET
      where
      TRATHUOCCHITIET_ID = '$TRATHUOCCHITIET_ID$'
    </statement>

    <statement id="DAO00090_DeleteP" parameterClass="System.Collections.IDictionary" resultClass="System.Int32">
      delete from TT_NOITRU_TRATHUOC_CHITIET
      <dynamic prepend="where">
        <isParameterPresent>
          <isNotEmpty prepend="and" property="TRATHUOCCHITIET_ID">
            TRATHUOCCHITIET_ID = '$TRATHUOCCHITIET_ID$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="TRATHUOC_ID">
            TRATHUOC_ID = '$TRATHUOC_ID$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="TOATHUOC_ID">
            TOATHUOC_ID = '$TOATHUOC_ID$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="DUOC_ID">
            DUOC_ID = '$DUOC_ID$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="SOLUONG">
            SOLUONG = '$SOLUONG$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="DAHOANTRA">
            DAHOANTRA = '$DAHOANTRA$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="CHUNGTUTRA_ID">
            CHUNGTUTRA_ID = '$CHUNGTUTRA_ID$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="CHUNGTUCHITIET_ID">
            CHUNGTUCHITIET_ID = '$CHUNGTUCHITIET_ID$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="BENHVIEN_ID">
            BENHVIEN_ID = '$BENHVIEN_ID$'
          </isNotEmpty>
        </isParameterPresent>
      </dynamic>
    </statement>
    <statement id="DAO00090_GetSLDaXuat" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      SELECT SUM(SOLUONGDAXUAT) SOLUONGDAXUAT FROM TT_DUOC_CHUNGTU_CHITIET
      WHERE CHUNGTU_ID IN
      (SELECT CHUNGTU_ID FROM TT_DUOC_CHUNGTU WHERE BENHAN_ID = '$BENHAN_ID$' and DUOC_ID = '$DUOC_ID$')
    </statement>
    
    <statement id="DAO00090_GetSLTamNgung" parameterClass="System.Collections.IDictionary" resultClass="DataObject">      
      SELECT SOLUONG as SOLUONGDANGUNG FROM TT_NOITRU_TRATHUOC_CHITIET
      <!--WHERE TRATHUOC_ID IN
      (SELECT TRATHUOC_ID FROM TT_NOITRU_TRATHUOC WHERE BENHAN_ID = '$BENHAN_ID$' and DUOC_ID = '$DUOC_ID$')-->
      where TRATHUOCCHITIET_ID = '$TRATHUOCCHITIET_ID$'
      and BENHVIEN_ID = '$BENHVIEN_ID$'
    </statement>
  
    <statement id="DAO00090_CapNhatTThaiThuocTamNgung" parameterClass="System.Collections.IDictionary" resultClass="DataObject">      
      select *
      from TT_NOITRU_TRATHUOC_CHITIET
      where TRATHUOCCHITIET_ID  = '$TRATHUOCCHITIET_ID$'
    </statement>
  
    <statement id="DAO00090_DeleteThuocInList" parameterClass="HashTable" resultClass="DataObject">
      select TOATHUOC_ID, SOLUONG, DUOC_ID from TT_NOITRU_TRATHUOC_CHITIET
      where TRATHUOC_ID = #TRATHUOC_ID#
      <dynamic prepend=" and TRATHUOCCHITIET_ID in ">
        <iterate open="(" close=")" conjunction=",  " property="LSTTRATHUOC_ID">#LSTTRATHUOC_ID[]#</iterate>
      </dynamic>

      delete from TT_NOITRU_TRATHUOC_CHITIET
      where TRATHUOC_ID = #TRATHUOC_ID#
      <dynamic prepend=" and TRATHUOCCHITIET_ID in ">
        <iterate open="(" close=")" conjunction=",  " property="LSTTRATHUOC_ID">#LSTTRATHUOC_ID[]#</iterate>
      </dynamic>
    </statement>

    <statement id="DAO00090_XoaTraThuocChiTietByTraThuocID" parameterClass="HashTable" resultClass="DataObject">
      UPDATE book      
      SET
      book.SOLUONG = toathuoc.SOLUONG,
      NGAYCAPNHAT = getdate()
      FROM
      TT_DUOC_TONKHO_BOOK_NOITRU AS book
      INNER JOIN TT_NOITRU_TOATHUOC AS toathuoc
      ON book.REF_ID = toathuoc.TOATHUOC_ID and book.REF_TABLE = 'TT_NOITRU_TOATHUOC'
      WHERE
      toathuoc.TOATHUOC_ID in(select TOATHUOC_ID FROM TT_NOITRU_TRATHUOC_CHITIET WHERE TRATHUOC_ID = #TRATHUOC_ID#)
    

      select TOATHUOC_ID, DUOC_ID, SOLUONG from TT_NOITRU_TRATHUOC_CHITIET
      where TRATHUOC_ID = #TRATHUOC_ID#
      and BENHVIEN_ID = #BENHVIEN_ID#

      delete from TT_NOITRU_TRATHUOC_CHITIET
      where TRATHUOC_ID = #TRATHUOC_ID#
      and BENHVIEN_ID = #BENHVIEN_ID#
    </statement>
    <statement id="DAO00090_CheckChungTuX05XoaTraThuoc" parameterClass="HashTable" resultClass="DataObject">
      IF EXISTS (
      select TT.TRATHUOC_ID
      from TT_NOITRU_TRATHUOC TT
      inner join TT_NOITRU_TRATHUOC_CHITIET CT on TT.TRATHUOC_ID = CT.TRATHUOC_ID
      where TT.TRATHUOC_ID = $TRATHUOC_ID$ AND CT.CHUNGTUTRA_ID IS NOT NULL
      )
      BEGIN
      SELECT -1 AS RESULT
      END
      ELSE
      BEGIN
      SELECT 1 AS RESULT
      END
    </statement>
        
  </statements>

</sqlMap>
