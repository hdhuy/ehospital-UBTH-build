<?xml version="1.0" encoding="utf-8" ?>
<!--============================================================================
//	CAUTION: This file is generated by IBatisNetGen.3.SQLMap.cst at 11/11/2015 9:27:48 AM
//				Any manual editing will be lost in re-generation.
//===========================================================================-->
<sqlMap namespace="eHospital" xmlns="http://ibatis.apache.org/mapping" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" >

  <statements>

    <statement id="DAO00064_CapNhatKhoaCaKham" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      update TT_TIEPNHAN set
      TRANGTHAI = #TRANGTHAI#,
      KHOADULIEU = #KHOADULIEU#,
      NGUOIKHOA_ID = #NGUOIKHOA_ID#,
      NGAYKHOA = #NGAYKHOA#,
      <IsPropertyAvailable prepend="" property="GHICHU_KHOADULIEU">
        GHICHU_KHOADULIEU = #GHICHU_KHOADULIEU#,
      </IsPropertyAvailable>
      NGUOICAPNHAT_ID = #NGUOICAPNHAT_ID#,
      NGAYCAPNHAT = #NGAYCAPNHAT#
      where
      TIEPNHAN_ID = '$TIEPNHAN_ID$'
      and BENHVIEN_ID = '$BENHVIEN_ID$'
    </statement>

    <statement id="DAO00064_CapNhatGhiChuKhoaCaKham" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      update TT_TIEPNHAN set
      GHICHU_KHOADULIEU = #GHICHU_KHOADULIEU#,
      NGUOICAPNHAT_ID = #NGUOICAPNHAT_ID#,
      NGAYCAPNHAT = #NGAYCAPNHAT#
      where
      TIEPNHAN_ID = '$TIEPNHAN_ID$'
      and BENHVIEN_ID = '$BENHVIEN_ID$'
    </statement>

    <statement id="DAO00064_GetListBenhNhanVienPhi" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select *
      from
      (select COUNT(*) OVER() as TOTALROWS,  ROW_NUMBER() OVER(order by B.SOTIEPNHAN desc) as ROWNUMBER,
      B.SOBHYT, B.NGAYTIEPNHAN , B.THOIGIANTIEPNHAN as NGAYVAO, B.SOTIEPNHAN, B.DOITUONG_ID, B.TIEPNHAN_ID, B.GHICHU_KHOADULIEU,
      C.MAYTE as MABN, C.TENBENHNHAN as TENBN, C.NAMSINH, Convert(varchar(10),C.NGAYSINH,103) as NGAYSINH , ISNULL(C.DIACHILIENLAC,C.SONHA) as DIACHI, C.SODIENTHOAI, C.BENHNHAN_ID, B.BENHVIEN_ID,
      D.XACNHANCHIPHI_ID, D.NGAYXACNHAN, B.KHOADULIEU, B.NGAYKHOA
      from TT_TIEPNHAN B
      inner join TT_BENHNHAN C on B.BENHNHAN_ID = C.BENHNHAN_ID
      left join TT_XACNHANCHIPHI D on D.TIEPNHAN_ID = B.TIEPNHAN_ID
      where
      (not exists (select TIEPNHAN_ID from TT_NOITRU_BENHAN where TIEPNHAN_ID = B.TIEPNHAN_ID)) and
      <isNotEmpty prepend="" property="BIL10_CHOPHEP_TIEPNHAN_BHYT">
        <isEqual prepend="" property="BIL10_CHOPHEP_TIEPNHAN_BHYT" compareValue="False">
          (B.SOBHYT is null or B.SOBHYT = '') and
        </isEqual>
      </isNotEmpty>
      (B.TRANGTHAI = 'DATIEPNHAN' or B.TRANGTHAI = 'HOANTHANH' ) and C.MAYTE is not null
      <isNotEmpty prepend="and" property="TUNGAY">
        B.NGAYTIEPNHAN &#62;&#61; '$TUNGAY$'
      </isNotEmpty>
      <isNotEmpty prepend="and" property="DENNGAY">
        B.NGAYTIEPNHAN &#60;&#61; '$DENNGAY$'
      </isNotEmpty>
      and B.BENHVIEN_ID = '$BENHVIEN_ID$'
      <isNotEmpty prepend="and" property="MABENHNHAN">
        (C.TENBENHNHAN like '%' + #MABENHNHAN# + '%' OR C.MAYTE like '%' + #MABENHNHAN# + '%')
      </isNotEmpty>
      <isNotEmpty prepend="and" property="NGAYKHOA">
        convert(date, B.NGAYKHOA) = '$NGAYKHOA$'
      </isNotEmpty>
      <isNotEmpty prepend="" property="TRANGTHAI">
        <isEqual prepend="AND" property="TRANGTHAI" compareValue="LOCKED">
          B.KHOADULIEU = 1
        </isEqual>
        <isEqual prepend="AND" property="TRANGTHAI" compareValue="NOTLOCKED">
          B.KHOADULIEU = 0
        </isEqual>
      </isNotEmpty>
      ) lst
      <isNotEmpty prepend="" property="FROMROW">
        where
        lst.ROWNUMBER between $FROMROW$ and $TOROW$
      </isNotEmpty>
    </statement>
    <statement id="DAO00064_GetListBenhNhan" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select * from
      (
      select *, COUNT(*) OVER() as TOTALROWS,  ROW_NUMBER() OVER(order by lst.SOTIEPNHAN desc) as ROWNUMBER
      from
      (select distinct
      B.SOBHYT, B.NGAYTIEPNHAN , B.THOIGIANTIEPNHAN as NGAYVAO, B.SOTIEPNHAN, B.DOITUONG_ID, B.TIEPNHAN_ID, B.GHICHU_KHOADULIEU,
      C.MAYTE as MABN, C.TENBENHNHAN as TENBN, C.NAMSINH , C.BENHNHAN_ID, B.BENHVIEN_ID,
      D.XACNHANCHIPHI_ID, D.NGAYXACNHAN, C.SONHA as DIACHITHUONGTRU, isnull(C.SONHA, C.DIACHITHUONGTRU) AS DIACHILIENLAC, PB.TENPHONGBAN
      from TT_TIEPNHAN B
      inner join TT_BENHNHAN C on B.BENHNHAN_ID = C.BENHNHAN_ID
      left join TT_XACNHANCHIPHI D on D.TIEPNHAN_ID = B.TIEPNHAN_ID
      left join (
      select tn.TIEPNHAN_ID, max(kb.KHAMBENH_ID) AS KHAMBENH_ID
      from TT_TIEPNHAN TN
      inner join TT_NGOAITRU_KHAMBENH kb on kb.TIEPNHAN_ID = tn.TIEPNHAN_ID and kb.BENHVIEN_ID = tn.BENHVIEN_ID
      where 1=1
      <isNotEmpty prepend="and" property="TUNGAY">
        TN.NGAYTIEPNHAN &#62;&#61; '$TUNGAY$'
      </isNotEmpty>
      <isNotEmpty prepend="and" property="DENNGAY">
        TN.NGAYTIEPNHAN &#60;&#61; '$DENNGAY$'
      </isNotEmpty>
      group by tn.TIEPNHAN_ID
      ) E on E.TIEPNHAN_ID = B.TIEPNHAN_ID
      left join TT_NGOAITRU_KHAMBENH kb on kb.KHAMBENH_ID = E.KHAMBENH_ID
      left join TM_PHONGBAN PB on PB.PHONGBAN_ID = KB.PHONGBAN_ID
      where
      (not exists (select TIEPNHAN_ID from TT_NOITRU_BENHAN where TIEPNHAN_ID = B.TIEPNHAN_ID)
      and not exists (select TIEPNHAN_ID from TT_NOITRU_NHAPVIEN where TIEPNHAN_ID = B.TIEPNHAN_ID)) and
      (B.SOBHYT is not null and B.SOBHYT != '') and
      (B.TRANGTHAI = 'DATIEPNHAN' or B.TRANGTHAI = 'HOANTHANH' ) and C.MAYTE is not null
      <isNotEmpty prepend="and" property="TUNGAY">
        B.NGAYTIEPNHAN &#62;&#61; '$TUNGAY$'
      </isNotEmpty>
      <isNotEmpty prepend="and" property="DENNGAY">
        B.NGAYTIEPNHAN &#60;&#61; '$DENNGAY$'
      </isNotEmpty>
      <!--(B.NGAYTIEPNHAN BETWEEN '$TUNGAY$' AND '$DENNGAY$')-->
      and B.BENHVIEN_ID = '$BENHVIEN_ID$'
      <isNotEmpty prepend="and" property="MABENHNHAN">
        <!--B.SOTIEPNHAN = '$MABENHNHAN$'-->
        (C.TENBENHNHAN like '%' + #MABENHNHAN# + '%' OR C.MAYTE like '%' + #MABENHNHAN# + '%' OR B.SOBHYT like '%' + #MABENHNHAN# + '%')
      </isNotEmpty>
      <isNotEmpty prepend="and" property="NGAYXACNHAN">
        D.NGAYXACNHAN = '$NGAYXACNHAN$'
      </isNotEmpty>
      <isNotEmpty prepend="" property="TRANGTHAI">
        <isEqual prepend="AND" property="TRANGTHAI" compareValue="2">
          D.XACNHANCHIPHI_ID is NULL
        </isEqual>
        <isEqual prepend="AND" property="TRANGTHAI" compareValue="3">
          D.XACNHANCHIPHI_ID is not NULL
        </isEqual>
        <isEqual prepend="AND" property="TRANGTHAI" compareValue="02">
          D.XACNHANCHIPHI_ID is NULL
        </isEqual>
        <isEqual prepend="AND" property="TRANGTHAI" compareValue="03">
          D.XACNHANCHIPHI_ID is not NULL
        </isEqual>
      </isNotEmpty>
      ) lst
      ) ds
      <isNotEmpty prepend="" property="FROMROW">
        where
        ds.ROWNUMBER between $FROMROW$ and $TOROW$
      </isNotEmpty>
    </statement>
    <statement id="DAO00064_GetThongtinKhambenh" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select top 1 pb.TENPHONGBAN, nv.TENNHANVIEN
      from TT_NGOAITRU_KHAMBENH A
      left join TT_DVYEUCAU B on A.KHAMBENH_ID = B.KHAMBENH_NGOAITRU_ID
      left join TM_NHANVIEN nv on nv.NHANVIEN_ID = A.BACSIKHAM_ID
      left join TM_PHONGBAN pb on pb.PHONGBAN_ID = B.NOITHUCHIEN_ID
      where A.TIEPNHAN_ID = '$TIEPNHAN_ID$'
    </statement>
    <statement id="DAO00064_GetListBenhNhanNoiTru" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select *
      from
      (select COUNT(*) OVER() as TOTALROWS,  ROW_NUMBER() OVER(order by B.SOTIEPNHAN desc) as ROWNUMBER,
      E.CHANDOANKHAMBENH as CHANDOAN, E.KHOAVAO_ID  as PHONGBAN_ID,  E.BENHAN_ID,
      E.ICD_BENHCHINH as MABENH, E.ICD_BENHPHU as BENHKHAC, E.SOBENHAN, E.SOCAPCUU,
      B.SOBHYT, B.NGAYTIEPNHAN , B.THOIGIANTIEPNHAN as NGAYVAO, B.SOTIEPNHAN, B.DOITUONG_ID, B.TIEPNHAN_ID,
      C.MAYTE as MABN, C.TENBENHNHAN as TENBN, C.NAMSINH , C.BENHNHAN_ID, E.BENHVIEN_ID,
      D.XACNHANCHIPHI_ID, D.NGAYXACNHAN, E.TRANGTHAI, E.THOIGIANRAVIEN,
      D.NGUOICAPNHAT_ID as NGUOIKHOABENHAN, E.LOAIBENHAN, C.SONHA as DIACHITHUONGTRU, nv.TENNHANVIEN, pb.TENPHONGBAN,
      isnull(C.SONHA, C.DIACHITHUONGTRU) AS DIACHILIENLAC, F.TENPHONGBAN AS KHOAHIENTAI
      from TT_NOITRU_BENHAN E
      inner join TT_TIEPNHAN B on B.TIEPNHAN_ID = E.TIEPNHAN_ID
      inner join TT_BENHNHAN C on E.BENHNHAN_ID = C.BENHNHAN_ID
      left join TT_XACNHANCHIPHI D on D.BENHAN_ID = E.BENHAN_ID
      left join TM_NHANVIEN nv on nv.NHANVIEN_ID = e.BACSIDIEUTRICHINH_ID
      left join TM_PHONGBAN pb on pb.PHONGBAN_ID = e.KHOACHUYENDEN_ID
      <!--left join (select top 1 * from TT_NOITRU_LUUTRU where LUUTRU_CURRENT = '1' order by LUUTRU_ID desc) LTHT on LTHT.BENHAN_ID = E.BENHAN_ID and LTHT.LUUTRU_CURRENT = '1'
      left join TM_PHONGBAN F on F.PHONGBAN_ID = LTHT.PHONGBAN_ID-->
      left join (
      select BENHAN_ID, MAX(LUUTRU_ID) AS LUUTRU_ID
      from TT_NOITRU_LUUTRU
      where LUUTRU_CURRENT = '1'
      group by BENHAN_ID
      ) LTHT on LTHT.BENHAN_ID = E.BENHAN_ID
      left join TT_NOITRU_LUUTRU LT on LT.LUUTRU_ID = LTHT.LUUTRU_ID
      left join TM_PHONGBAN F on F.PHONGBAN_ID = LT.PHONGBAN_ID
      where
      (B.SOBHYT is not null and B.SOBHYT != '') AND (E.LOAIBENHAN is null or E.LOAIBENHAN != 2) AND
      (E.TRANGTHAI = 'DATHANHTOAN' or E.TRANGTHAI = 'DAKHOA'
      <isNotEmpty prepend="" property="IPD16_XACNHANBHYT_DELETE_CACHE">
        <isEqual prepend="Or" property="IPD16_XACNHANBHYT_DELETE_CACHE" compareValue="True">
          E.TRANGTHAI = 'DAXUATVIEN'
        </isEqual>
      </isNotEmpty>
      )
      <!--(E.TRANGTHAI = 'DATHANHTOAN' or E.TRANGTHAI = 'DAKHOA' or E.TRANGTHAI = 'DAXUATVIEN')-->
      <isNotEmpty prepend="and" property="TUNGAY">
        E.NGAYRAVIEN &#62;&#61; '$TUNGAY$'
      </isNotEmpty>
      <isNotEmpty prepend="and" property="DENNGAY">
        E.NGAYRAVIEN &#60;&#61; '$DENNGAY$'
      </isNotEmpty>
      <!--(E.NGAYLAP BETWEEN '$TUNGAY$' AND '$DENNGAY$')-->
      and E.BENHVIEN_ID = '$BENHVIEN_ID$'
      <isNotEmpty prepend="and" property="MABENHAN">
        <!--(E.SOBENHAN like '%$MABENHAN$%' OR C.MAYTE like '%$MABENHAN$%')-->
        (C.TENBENHNHAN like '%' + #MABENHAN# + '%' OR C.MAYTE like '%' + #MABENHAN# + '%' OR B.SOBHYT like '%' + #MABENHAN# + '%')
      </isNotEmpty>
      <isNotEmpty prepend="and" property="NGAYXACNHAN">
        D.NGAYXACNHAN = '$NGAYXACNHAN$'
      </isNotEmpty>
      <isNotEmpty prepend="" property="TRANGTHAI">
        <isEqual prepend="AND" property="TRANGTHAI" compareValue="2">
          D.XACNHANCHIPHI_ID is NULL
        </isEqual>
        <isEqual prepend="AND" property="TRANGTHAI" compareValue="3">
          D.XACNHANCHIPHI_ID is not NULL
        </isEqual>
        <isEqual prepend="AND" property="TRANGTHAI" compareValue="02">
          D.XACNHANCHIPHI_ID is NULL
        </isEqual>
        <isEqual prepend="AND" property="TRANGTHAI" compareValue="03">
          D.XACNHANCHIPHI_ID is not NULL
        </isEqual>
      </isNotEmpty>
      <isNotEmpty prepend="" property="CAPCUU_NOITRU">
        <isEqual prepend="AND" property="CAPCUU_NOITRU" compareValue="CAPCUU">
          E.SOBENHAN like '%CC'
        </isEqual>
        <isEqual prepend="AND" property="CAPCUU_NOITRU" compareValue="NOITRU">
          E.SOBENHAN not like '%CC'
        </isEqual>
      </isNotEmpty>
      ) lst
      <isNotEmpty prepend="" property="FROMROW">
        where
        lst.ROWNUMBER between $FROMROW$ and $TOROW$
      </isNotEmpty>
    </statement>

    <statement id="DAO00064_GetListBenhNhanNoiTruVP" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select *
      from
      (select COUNT(*) OVER() as TOTALROWS,  ROW_NUMBER() OVER(order by B.SOTIEPNHAN desc) as ROWNUMBER,
      E.CHANDOANKHAMBENH as CHANDOAN, E.KHOAVAO_ID  as PHONGBAN_ID,  E.BENHAN_ID,
      E.ICD_BENHCHINH as MABENH, E.ICD_BENHPHU as BENHKHAC, E.SOBENHAN, E.SOCAPCUU,
      B.SOBHYT, B.NGAYTIEPNHAN , B.THOIGIANTIEPNHAN as NGAYVAO, E.THOIGIANRAVIEN, B.SOTIEPNHAN, B.DOITUONG_ID, B.TIEPNHAN_ID,
      C.MAYTE as MABN, C.TENBENHNHAN as TENBN, case when (C.NGAYSINH IS NOT NULL OR C.NGAYSINH != '') THEN CONVERT(VARCHAR(10), C.NGAYSINH, 103) ELSE CAST(C.NAMSINH AS VARCHAR(10)) END as NGAYSINH
      , C.NAMSINH , C.BENHNHAN_ID, E.BENHVIEN_ID,
      D.XACNHANCHIPHI_ID, E.TRANGTHAI,
      gd.DESCRIPTION  as TENGIOITINH, pb.TENPHONGBAN, D.NGUOICAPNHAT_ID as NGUOIKHOABENHAN, C.DIACHILIENLAC,
      CASE WHEN balt.MABENHAN is null THEN 0 ELSE 1 END as CHUYENLUUTRU,
      E.LOAIBENHAN,
      CASE WHEN (E.KHOABENHAN = '1' OR E.TRANGTHAI = 'DAKHOA') THEN CONVERT(VARCHAR(10),ISNULL(E.NGAYKHOABENHAN,E.NGAYCAPNHAT),103) ELSE NULL END AS NGAYXACNHAN,
      CASE WHEN (E.KHOABENHAN = '1' OR E.TRANGTHAI = 'DAKHOA') THEN NV.TENNHANVIEN ELSE '' END AS NGUOIKHOA
      from TT_NOITRU_BENHAN E
      inner join TT_TIEPNHAN B on B.TIEPNHAN_ID = E.TIEPNHAN_ID
      left join TT_BENHNHAN C on B.BENHNHAN_ID = C.BENHNHAN_ID
      left join TT_XACNHANCHIPHI D on D.BENHAN_ID = E.BENHAN_ID
      left join TM_GENDER gd on gd.ID = C.GIOITINH
      left join TT_BENHAN_LUUTRU balt on balt.BENHAN_ID = E.BENHAN_ID and balt.REF_TABLE = 'TT_NOITRU_BENHAN'
      left join TM_PHONGBAN pb on pb.PHONGBAN_ID = isnull(E.KHOACHUYENDEN_ID, E.KHOAVAO_ID)
      left join TM_NHANVIEN NV ON NV.NHANVIEN_ID = E.NGUOICAPNHAT_ID
      where
      <!--(B.SOBHYT is null or B.SOBHYT = '') AND--> (E.LOAIBENHAN is null or E.LOAIBENHAN != 2) AND
      <!--E.TRANGTHAI != 'DANGDIEUTRI' AND-->
      (E.TRANGTHAI = 'DATHANHTOAN' or E.TRANGTHAI = 'DAKHOA' or E.TRANGTHAI = 'DAXUATVIEN')
      <isNotEmpty prepend="and" property="TUNGAY">
        E.NGAYRAVIEN &#62;&#61; '$TUNGAY$'
      </isNotEmpty>
      <isNotEmpty prepend="and" property="DENNGAY">
        E.NGAYRAVIEN &#60;&#61; '$DENNGAY$'
      </isNotEmpty>
      <!--(E.NGAYLAP BETWEEN '$TUNGAY$' AND '$DENNGAY$')-->
      and E.BENHVIEN_ID = '$BENHVIEN_ID$'
      <isNotEmpty prepend="and" property="MABENHAN">
        (E.SOBENHAN like '%' + #MABENHAN# + '%' or C.TENBENHNHAN like '%' + #MABENHAN# + '%' or C.MAYTE like '%' + #MABENHAN# + '%')
      </isNotEmpty>
      <isNotEmpty prepend="and" property="NGAYXACNHAN">
        D.NGAYXACNHAN = '$NGAYXACNHAN$'
      </isNotEmpty>
      <isNotEmpty prepend="" property="TRANGTHAI">
        <isEqual prepend="AND" property="TRANGTHAI" compareValue="2">
          D.XACNHANCHIPHI_ID is NULL
        </isEqual>
        <isEqual prepend="AND" property="TRANGTHAI" compareValue="3">
          D.XACNHANCHIPHI_ID is not NULL
        </isEqual>
        <isEqual prepend="AND" property="TRANGTHAI" compareValue="02">
          E.TRANGTHAI != 'DAKHOA'
        </isEqual>
        <isEqual prepend="AND" property="TRANGTHAI" compareValue="03">
          E.TRANGTHAI = 'DAKHOA'
        </isEqual>
      </isNotEmpty>
      <!--<isNotEmpty prepend="" property="IPD_OPD_XACNHANBHYT_KHOABENHAN">
        <isEqual prepend="AND" property="IPD_OPD_XACNHANBHYT_KHOABENHAN" compareValue="False">
          (B.SOBHYT is null or B.SOBHYT = '')
        </isEqual>      
      </isNotEmpty>-->
      ) lst
      <isNotEmpty prepend="" property="FROMROW">
        where
        lst.ROWNUMBER between $FROMROW$ and $TOROW$
      </isNotEmpty>
    </statement>
    <statement id="DAO00064_GetVienphiTamUngTiepNhan" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select * from TT_HOADON
      where LOAIHOADON = 'TU' and TIEPNHAN_ID = '$TIEPNHAN_ID$' and (BENHAN_ID is NULL or BENHAN_ID = '')
      and DATHANHTOAN = '1' and HUYHOADON = '0' and HOANTRA = '0'
    </statement>
    <statement id="DAO00064_GetVienphiTiepNhan" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select distinct C.TRANGTHAI, C.NOITHUCHIEN_ID as PHONGBAN_ID, D.NGAYKHAM,
      ISNULL(A.DICHVU_ID, A.DUOC_ID) as NOIDUNG_ID, A.REF_ID as IDREF, A.VIENPHI_ID,
      A.SOLUONG as SOLUONG, A.SOLUONG as SOLUONG_NEW, A.DICHVU_ID, A.DUOC_ID, A.BHYT_DONGIA_CHITRA,
      A.DONGIA_DOANHTHU, A.DONGIA_DOANHTHU as DONGIADOANHTHU, A.BHYT_DONGIA as DONGIAHOTRO, A.BHYT_THANHTIEN_CHITRA as DONGIAHOTROCHITRA,
      A.REF_TABLE as LOAI, A.BHYT_DONGIA, A.BHYT_THANHTIEN, A.BHYT_THANHTIEN_CHITRA, A.BENHNHAN_PHAITHANHTOAN, A.GIATRI_BENHNHAN_DATHANHTOAN, A.BENHVIEN_ID, A.THANHTIEN_DOANHTHU,
      A.LOAI_CHIPHI, A.LOAIGIA_ID, REF_TABLE, A.KHAMBENH_ID, A.REF_ID, A.DUOCPHEPTHUCHIEN,
      A.HUY, A.KHONGTHUTIEN, A.DATHANHTOAN, A.HOADON_ID, A.ACTIVE, C.DVYEUCAU_ID, C.NGAYYEUCAU, ISNULL(C.BACSICHIDINH_ID, C.NGUOIGIOITHIEU_ID) as BACSICHIDINH_ID, C.NOIYEUCAU_ID
      , A.DATHUCHIEN,
      isnull(dv.TENDICHVU, dc.TENDUOCDAYDU) NOIDUNG, isnull(dv.MADICHVU, dc.MADUOC) MADICHVU, dv.NORESULT, dc.DONVITINH, ld.MALOAIDUOC, dc.BHYT DUOC_BHYT, ld.LOAIVATTU_ID,
      ndv.MANHOMDICHVU
      from TT_VIENPHI A
      left join (select * from TT_DVYEUCAU where TIEPNHAN_ID = '$TIEPNHAN_ID$') C on C.TIEPNHAN_ID = A.TIEPNHAN_ID and C.DICHVU_ID = A.DICHVU_ID  and C.DVYEUCAU_ID = A.REF_ID
      left join (select * from TT_NGOAITRU_KHAMBENH where TIEPNHAN_ID = '$TIEPNHAN_ID$') D on D.TIEPNHAN_ID = A.TIEPNHAN_ID and D.DICHVU_ID = A.DICHVU_ID
      left join TT_NGOAITRU_TOATHUOC E on E.DUOC_ID = A.DUOC_ID and E.TOATHUOC_ID = A.REF_ID
      left join TT_DUOC_CHUNGTU_CHITIET  ctct on ctct.CHUNGTUCHITIET_ID = A.REF_ID and A.REF_TABLE = 'TT_DUOC_CHUNGTU_CHITIET'
      left join TM_DICHVU dv on A.DICHVU_ID = dv.DICHVU_ID and A.REF_TABLE = 'TT_DVYEUCAU'
      left join TM_DUOC dc on A.DUOC_ID = dc.DUOC_ID
      left join TM_LOAIDUOC ld on dc.LOAIDUOC_ID = ld.LOAIDUOC_ID
      left join TM_NHOMDICHVU ndv on ndv.NHOMDICHVU_ID = dv.NHOMDICHVU_ID
      where
      A.TIEPNHAN_ID = '$TIEPNHAN_ID$' and A.BENHVIEN_ID = '$BENHVIEN_ID$' and (A.BENHAN_ID is NULL or A.BENHAN_ID = '') and A.HUY = '0'
      and
      (
      (A.DICHVU_ID is not null and C.HUYYEUCAU != '1')
      or (A.DICHVU_ID is null and A.DUOC_ID is not null and A.REF_TABLE != 'TT_DUOC_CHUNGTU_CHITIET')
      or (A.DICHVU_ID is null and A.DUOC_ID is not null and A.REF_TABLE = 'TT_DUOC_CHUNGTU_CHITIET' and ctct.CHUNGTUCHITIET_ID is not null)
      )
      <isNotEmpty prepend="" property="IPD03_CHIPHICHUATHANHTOAN_VIENPHI">
      <isEqual prepend="AND" property="IPD03_CHIPHICHUATHANHTOAN_VIENPHI" compareValue="True">
        A.HOADON_ID IS NULL AND A.DATHANHTOAN = '0'
      </isEqual>
    </isNotEmpty>
      ORDER BY A.VIENPHI_ID
    </statement>
    <statement id="DAO00064_GetVienphiTiepNhan_BIL33" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select distinct C.TRANGTHAI, C.NOITHUCHIEN_ID as PHONGBAN_ID, D.NGAYKHAM,
      ISNULL(A.DICHVU_ID, A.DUOC_ID) as NOIDUNG_ID, A.REF_ID as IDREF, A.VIENPHI_ID,
      A.SOLUONG as SOLUONG, A.SOLUONG as SOLUONG_NEW, A.DICHVU_ID, A.DUOC_ID, A.BHYT_DONGIA_CHITRA,
      A.DONGIA_DOANHTHU, A.DONGIA_DOANHTHU as DONGIADOANHTHU, A.BHYT_DONGIA as DONGIAHOTRO, A.BHYT_THANHTIEN_CHITRA as DONGIAHOTROCHITRA,
      A.REF_TABLE as LOAI, A.BHYT_DONGIA, A.BHYT_THANHTIEN, A.BHYT_THANHTIEN_CHITRA, A.BENHNHAN_PHAITHANHTOAN, A.GIATRI_BENHNHAN_DATHANHTOAN, A.BENHVIEN_ID, A.THANHTIEN_DOANHTHU,
      A.LOAI_CHIPHI, A.LOAIGIA_ID, REF_TABLE, A.KHAMBENH_ID, A.REF_ID, A.DUOCPHEPTHUCHIEN,
      A.HUY, A.KHONGTHUTIEN, A.DATHANHTOAN, A.HOADON_ID, A.ACTIVE, C.DVYEUCAU_ID, C.NGAYYEUCAU, ISNULL(C.BACSICHIDINH_ID, C.NGUOIGIOITHIEU_ID) as BACSICHIDINH_ID, C.NOIYEUCAU_ID
      , A.DATHUCHIEN,
      isnull(dv.TENDICHVU, dc.TENDUOCDAYDU) NOIDUNG, isnull(dv.MADICHVU, dc.MADUOC) MADICHVU, dv.NORESULT, dc.DONVITINH, ld.MALOAIDUOC, dc.BHYT DUOC_BHYT, ld.LOAIVATTU_ID, ndv.MANHOMDICHVU
      from TT_VIENPHI A
      left join (select * from TT_DVYEUCAU where TIEPNHAN_ID = '$TIEPNHAN_ID$') C on C.TIEPNHAN_ID = A.TIEPNHAN_ID and C.DICHVU_ID = A.DICHVU_ID  and C.DVYEUCAU_ID = A.REF_ID
      left join (select * from TT_NGOAITRU_KHAMBENH where TIEPNHAN_ID = '$TIEPNHAN_ID$') D on D.TIEPNHAN_ID = A.TIEPNHAN_ID and D.DICHVU_ID = A.DICHVU_ID
      left join TT_NGOAITRU_TOATHUOC E on E.DUOC_ID = A.DUOC_ID and E.TOATHUOC_ID = A.REF_ID
      left join TT_DUOC_CHUNGTU_CHITIET  ctct on ctct.CHUNGTUCHITIET_ID = A.REF_ID and A.REF_TABLE = 'TT_DUOC_CHUNGTU_CHITIET'
      left join TM_DUOC dc on A.DUOC_ID = dc.DUOC_ID
      left join TM_LOAIDUOC ld on dc.LOAIDUOC_ID = ld.LOAIDUOC_ID
      left join TM_DICHVU dv on A.DICHVU_ID = dv.DICHVU_ID and A.REF_TABLE = 'TT_DVYEUCAU'
      left join TM_NHOMDICHVU ndv on ndv.NHOMDICHVU_ID = dv.NHOMDICHVU_ID
      where
      A.TIEPNHAN_ID = '$TIEPNHAN_ID$' and A.BENHVIEN_ID = '$BENHVIEN_ID$' and (A.BENHAN_ID is NULL or A.BENHAN_ID = '') and A.HUY = '0'
      and
      (
      (A.DICHVU_ID is not null and C.HUYYEUCAU != '1')
      or (A.DICHVU_ID is null and A.DUOC_ID is not null and A.REF_TABLE != 'TT_DUOC_CHUNGTU_CHITIET')
      or (A.DICHVU_ID is null and A.DUOC_ID is not null and A.REF_TABLE = 'TT_DUOC_CHUNGTU_CHITIET' and ctct.CHUNGTUCHITIET_ID is not null)
      )
      and (A.VIENPHI_ID not in
      (select VIENPHI_ID from TT_XACNHANCHIPHICHITIET where LOAI = 'NGOAITRU' and
      XACNHANCHIPHI_ID = (select XACNHANCHIPHI_ID from TT_XACNHANCHIPHI where TIEPNHAN_ID = '$TIEPNHAN_ID$')))
      ORDER BY A.VIENPHI_ID
    </statement>
    <statement id="DAO00064_GetVienphiTiepNhan_BIL09" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select distinct case when c.DVYEUCAU_ID is not null then c.TRANGTHAI
      when tk.KHAMBENH_TOATHUOC_ID is not null then case when tk.CHUNGTUPHATTHUOC_ID is not null then 'DAXUAT' else 'CHUAXUAT' end
      when vtyt.PHAUTHUAT_VTYT_ID is not null then case when vtyt.CHUNGTU_ID is not null then 'DAXUAT' else 'CHUAXUAT' end
      when kqvtyt.CLSKETQUA_VTYT_ID is not null then case when kqvtyt.TRANGTHAI is not null then 'DAXUAT' else 'CHUAXUAT' end
      else '' end as TRANGTHAI
      , C.NOITHUCHIEN_ID as PHONGBAN_ID, D.NGAYKHAM,
      ISNULL(A.DICHVU_ID, A.DUOC_ID) as NOIDUNG_ID, A.REF_ID as IDREF, A.VIENPHI_ID,
      A.SOLUONG as SOLUONG, A.SOLUONG as SOLUONG_NEW, A.DICHVU_ID, A.DUOC_ID, A.BHYT_DONGIA_CHITRA,
      A.DONGIA_DOANHTHU, A.DONGIA_DOANHTHU as DONGIADOANHTHU, A.BHYT_DONGIA as DONGIAHOTRO, A.BHYT_THANHTIEN_CHITRA as DONGIAHOTROCHITRA, A.BHYT_DONGIA_CHITRA as DONGIAHOTROCHITRA_NEW,
      A.REF_TABLE as LOAI, A.BHYT_DONGIA, A.BHYT_THANHTIEN, A.BHYT_THANHTIEN_CHITRA, A.BENHNHAN_PHAITHANHTOAN, A.GIATRI_BENHNHAN_DATHANHTOAN, A.BENHVIEN_ID, A.THANHTIEN_DOANHTHU,
      A.LOAI_CHIPHI, A.LOAIGIA_ID, REF_TABLE, A.KHAMBENH_ID, A.REF_ID, A.DUOCPHEPTHUCHIEN,
      A.HUY, A.KHONGTHUTIEN, A.DATHANHTOAN, A.HOADON_ID, A.ACTIVE, C.DVYEUCAU_ID, C.NGAYYEUCAU, ISNULL(C.BACSICHIDINH_ID, C.NGUOIGIOITHIEU_ID) as BACSICHIDINH_ID, C.NOIYEUCAU_ID
      , A.DATHUCHIEN,
      isnull(dv.TENDICHVU, dc.TENDUOCDAYDU) NOIDUNG, isnull(dv.MADICHVU, dc.MADUOC) MADICHVU, dv.NORESULT, dc.DONVITINH, ld.MALOAIDUOC, dc.BHYT DUOC_BHYT, ld.LOAIVATTU_ID,
      ndv.MANHOMDICHVU, D.KBPBHUONGGIAIQUYET NOIDUNG2, D.HUONGGIAIQUYET_ID
      from TT_VIENPHI A
      left join (select * from TT_DVYEUCAU where TIEPNHAN_ID = '$TIEPNHAN_ID$') C on C.TIEPNHAN_ID = A.TIEPNHAN_ID and C.DICHVU_ID = A.DICHVU_ID  and C.DVYEUCAU_ID = A.REF_ID
      left join (
      select pb.TENPHONGBAN + ' - ' + nv.TENNHANVIEN + ' - '+ hgq.DICTIONARY_NAME KBPBHUONGGIAIQUYET, kb.* from TT_NGOAITRU_KHAMBENH kb
      left join TM_PHONGBAN pb on pb.PHONGBAN_ID = kb.PHONGBAN_ID
      left join TM_NHANVIEN nv on nv.NHANVIEN_ID = kb.BACSIKHAM_ID
      left join (select * from LST_DICTIONARY where DICTIONARY_TYPE_CODE = 'GiaiQuyetKhamBenh') hgq on hgq.DICTIONARY_ID = kb.HUONGGIAIQUYET_ID
      where kb.TIEPNHAN_ID = '$TIEPNHAN_ID$'
      ) D on D.TIEPNHAN_ID = A.TIEPNHAN_ID and D.DICHVU_ID = A.DICHVU_ID and C.KHAMBENH_NGOAITRU_ID = D.KHAMBENH_ID
      left join (select * from TT_NGOAITRU_TOATHUOC where TIEPNHAN_ID = '$TIEPNHAN_ID$') E on E.DUOC_ID = A.DUOC_ID and E.TOATHUOC_ID = A.REF_ID and A.REF_TABLE = 'TT_NGOAITRU_TOATHUOC'
      left join TT_NGOAITRU_KHAMBENH_TOATHUOC tk on tk.KHAMBENH_TOATHUOC_ID = e.KHAMBENH_TOATHUOC_ID
      left join TT_PHAUTHUAT_VTYT vtyt on vtyt.PHAUTHUAT_VTYT_ID = a.REF_ID and a.REF_TABLE = 'TT_PHAUTHUAT_VTYT'
      left join TT_CLSKETQUA_VTYT kqvtyt on kqvtyt.CLSKETQUA_VTYT_ID = a.REF_ID and a.REF_TABLE = 'TT_CLSKETQUA_VTYT'
      left join TM_DICHVU dv on A.DICHVU_ID = dv.DICHVU_ID and A.REF_TABLE = 'TT_DVYEUCAU'
      left join TM_DUOC dc on A.DUOC_ID = dc.DUOC_ID
      left join TM_LOAIDUOC ld on dc.LOAIDUOC_ID = ld.LOAIDUOC_ID
      left join TM_NHOMDICHVU ndv on ndv.NHOMDICHVU_ID = dv.NHOMDICHVU_ID
      where
      A.TIEPNHAN_ID = '$TIEPNHAN_ID$' AND A.REF_TABLE!='TT_MAU_CHUNGTU_CHITIET' and A.BENHVIEN_ID = '$BENHVIEN_ID$' and (A.BENHAN_ID is NULL or A.BENHAN_ID = '') <!--and A.HUY = '0'-->
      and A.REF_TABLE != 'TT_DUOC_CHUNGTU_CHITIET' and A.KHONGTHUTIEN != '1'
      and (exists (select KHAMBENH_ID from TT_NGOAITRU_KHAMBENH where A.KHAMBENH_ID = KHAMBENH_ID and TIEPNHAN_ID = '$TIEPNHAN_ID$') or A.KHAMBENH_ID is null)
      and (C.HUYYEUCAU = '0' or C.HUYYEUCAU is null)
      <isNotEmpty prepend="" property="BIL_XACNHANBHYT_HIENTHI_TATCA">
        <isEqual prepend="AND" property="BIL_XACNHANBHYT_HIENTHI_TATCA" compareValue="False">
          (A.BHYT_DONGIA > 0
          <isNotEmpty prepend="" property="PHA_DUOC_KHONG_KIEMTRA_GIA">
            <isEqual prepend="OR" property="PHA_DUOC_KHONG_KIEMTRA_GIA" compareValue="True">
              (A.DUOC_ID is not null and A.BHYT_DONGIA = 0 and A.DONGIA_DOANHTHU = 0)
            </isEqual>
          </isNotEmpty>
          )
        </isEqual>
      </isNotEmpty>
      and
      (
      (A.DICHVU_ID is not null and C.HUYYEUCAU != '1') or (A.DICHVU_ID is null and A.DUOC_ID is not null and A.REF_TABLE != 'TT_DUOC_CHUNGTU_CHITIET')
      )
      ORDER BY A.VIENPHI_ID
    </statement>
    <statement id="DAO00064_GetVienphiBenhanIdCapCuu" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select distinct C.TRANGTHAI, C.NOITHUCHIEN_ID as PHONGBAN_ID,
      ISNULL(A.DICHVU_ID, A.DUOC_ID) as NOIDUNG_ID, A.REF_ID as IDREF, A.VIENPHI_ID,
      A.SOLUONG as SOLUONG, A.SOLUONG as SOLUONG_NEW, A.DICHVU_ID, A.DUOC_ID, A.BHYT_DONGIA_CHITRA,
      A.DONGIA_DOANHTHU, A.DONGIA_DOANHTHU as DONGIADOANHTHU, A.BHYT_DONGIA as DONGIAHOTRO, A.BHYT_THANHTIEN_CHITRA as DONGIAHOTROCHITRA,
      A.REF_TABLE as LOAI, A.BHYT_DONGIA, A.BHYT_THANHTIEN, A.BHYT_THANHTIEN_CHITRA, A.BENHNHAN_PHAITHANHTOAN, A.GIATRI_BENHNHAN_DATHANHTOAN, A.BENHVIEN_ID, A.THANHTIEN_DOANHTHU,
      A.LOAI_CHIPHI, A.LOAIGIA_ID, REF_TABLE, A.KHAMBENH_ID, A.REF_ID, A.DUOCPHEPTHUCHIEN,
      A.HUY, A.KHONGTHUTIEN, A.DATHANHTOAN, A.HOADON_ID, A.ACTIVE, C.DVYEUCAU_ID, C.NGAYYEUCAU, ISNULL(C.BACSICHIDINH_ID, C.NGUOIGIOITHIEU_ID) as BACSICHIDINH_ID, C.NOIYEUCAU_ID,
      isnull(dv.TENDICHVU, dc.TENDUOCDAYDU) NOIDUNG, isnull(dv.MADICHVU, dc.MADUOC) MADICHVU, dv.NORESULT, dc.DONVITINH, ld.MALOAIDUOC, dc.BHYT DUOC_BHYT, ld.LOAIVATTU_ID, ndv.MANHOMDICHVU
      from TT_VIENPHI A
      left join (select * from TT_DVYEUCAU where TIEPNHAN_ID = '$TIEPNHAN_ID$') C on C.TIEPNHAN_ID = A.TIEPNHAN_ID and C.DICHVU_ID = A.DICHVU_ID  and C.DVYEUCAU_ID = A.REF_ID
      left join (select * from TT_NOITRU_TOATHUOC where TIEPNHAN_ID = '$TIEPNHAN_ID$') D on D.TIEPNHAN_ID = A.TIEPNHAN_ID and D.DUOC_ID = A.DUOC_ID and D.TOATHUOC_ID = A.REF_ID
      left join (select * from TT_PHAUTHUAT_VTYT) E on E.DUOC_ID = A.DUOC_ID and E.PHAUTHUAT_VTYT_ID = A.REF_ID
      left join (select * from TT_CLSKETQUA_VTYT) F on F.DUOC_ID = A.DUOC_ID and F.CLSKETQUA_VTYT_ID = A.REF_ID
      left join TM_DUOC dc on A.DUOC_ID = dc.DUOC_ID
      left join TM_LOAIDUOC ld on dc.LOAIDUOC_ID = ld.LOAIDUOC_ID
      left join TM_DICHVU dv on A.DICHVU_ID = dv.DICHVU_ID and A.REF_TABLE = 'TT_DVYEUCAU'
      left join TM_NHOMDICHVU ndv on ndv.NHOMDICHVU_ID = dv.NHOMDICHVU_ID
      where
      A.BENHAN_ID = '$BENHAN_CAPCUU$' and A.TIEPNHAN_ID = '$TIEPNHAN_ID$' and A.BENHVIEN_ID = '$BENHVIEN_ID$' and A.HUY = '0'
      ORDER BY A.VIENPHI_ID
    </statement>
    <statement id="DAO00064_UpdateVienphiBenhanIdCapCuu" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      update TT_VIENPHI set BENHAN_ID = '$BENHAN_ID$'
      where VIENPHI_ID in ($LST_VIENPHI_ID$)
    </statement>
    <statement id="DAO00064_GetREGListVienphiTiepNhan" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select A.*, B.THUTIENSAU
      from TT_VIENPHI A
      left join TT_DVYEUCAU B on A.REF_ID =  B.DVYEUCAU_ID and A.REF_TABLE = 'TT_DVYEUCAU' and B.HUYYEUCAU = '0'
      where
      A.TIEPNHAN_ID = '$TIEPNHAN_ID$' and A.BENHVIEN_ID = '$BENHVIEN_ID$' and (A.BENHAN_ID is NULL or A.BENHAN_ID = '')
      and A.HUY = '0'
      ORDER BY A.VIENPHI_ID
    </statement>
    <statement id="DAO00064_GetChiTietVienphiNoiTru" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select distinct
      C.GIATRIMIENGIAM as GIATRIMIENGIAM, D.GIATRIMIENGIAM as GIATRIMIENGIAM_BHTN, E.GIATRIMIENGIAM as GIATRIMIENGIAM_THANHVIEN,
      A.*, dv.NGAYGIOYEUCAU, dv.NOIYEUCAU_ID, dv.NOITHUCHIEN_ID, dv.TRANGTHAI, dv.NGAYYEUCAU1, hd.SOHOADON, dv.KHOTHUCHIEN_ID,
      mgct.GIATRIMIENGIAM as GIATRIMIENGIAM_CONGTY, CONVERT(VARCHAR(10), dv.NGAYYEUCAU1, 103) as NGAYYEUCAU,
      C.GIATRIMIENGIAM as GIATRIMIENGIAM_BH, mgct.GIATRIMIENGIAM as GIATRIMIENGIAM_CTCT,
      isnull(tmdv.TENDICHVU, dc.TENDUOCDAYDU) NOIDUNG, isnull(tmdv.THONGTUBOYTE, dc.SO_QDTT) MATHEOBHYT, isnull(tmdv.MADICHVU, dc.MADUOC) MADICHVU, tmdv.NORESULT, dc.DONVITINH, ld.MALOAIDUOC, dc.BHYT DUOC_BHYT, ld.LOAIVATTU_ID, ndv.MANHOMDICHVU
      from TT_VIENPHI A
      left join TM_DUOC dc on A.DUOC_ID = dc.DUOC_ID
      left join TM_LOAIDUOC ld on dc.LOAIDUOC_ID = ld.LOAIDUOC_ID
      left join TM_DICHVU tmdv on A.DICHVU_ID = tmdv.DICHVU_ID and A.REF_TABLE = 'TT_DVYEUCAU'
      left join TM_NHOMDICHVU ndv on ndv.NHOMDICHVU_ID = tmdv.NHOMDICHVU_ID
      left join TT_HOADON hd on hd.HOADON_ID = A.HOADON_ID and hd.BENHAN_ID is null
      left join (select sum(GIATRIMIENGIAM) as GIATRIMIENGIAM, VIENPHI_ID, REF_TABLE
      from TT_MIENGIAM_CHITIET
      where REF_TABLE = 'TT_MIENGIAM'
      and exists (select MIENGIAM_ID from TT_MIENGIAM where TT_MIENGIAM_CHITIET.MIENGIAM_ID = MIENGIAM_ID and TINHTRANG = 1 and TIEPNHAN_ID = '$TIEPNHAN_ID$')
      group by VIENPHI_ID, REF_TABLE) C on C.REF_TABLE = 'TT_MIENGIAM' and C.VIENPHI_ID = A.VIENPHI_ID
      left join (select sum(GIATRIMIENGIAM) as GIATRIMIENGIAM, VIENPHI_ID, REF_TABLE
      from TT_MIENGIAM_CHITIET
      where REF_TABLE = 'TT_MIENGIAM_BHTN'
      and exists (select MIENGIAM_BHTN_ID from TT_MIENGIAM_BHTN where TT_MIENGIAM_CHITIET.MIENGIAM_ID = MIENGIAM_BHTN_ID and TINHTRANG = 1 and TIEPNHAN_ID = '$TIEPNHAN_ID$')
      group by VIENPHI_ID, REF_TABLE) D on D.REF_TABLE = 'TT_MIENGIAM_BHTN' and D.VIENPHI_ID = A.VIENPHI_ID
      left join (select sum(GIATRIMIENGIAM) as GIATRIMIENGIAM, VIENPHI_ID, REF_TABLE
      from TT_MIENGIAM_CHITIET
      where REF_TABLE = 'TT_MIENGIAM_THANHVIEN'
      and exists (select MIENGIAM_THANHVIEN_ID from TT_MIENGIAM_THANHVIEN where TT_MIENGIAM_CHITIET.MIENGIAM_ID = MIENGIAM_THANHVIEN_ID and TINHTRANG = 1 and  TINHTRANG = 1 and TIEPNHAN_ID = '$TIEPNHAN_ID$')
      group by VIENPHI_ID, REF_TABLE) E on E.REF_TABLE = 'TT_MIENGIAM_THANHVIEN' and E.VIENPHI_ID = A.VIENPHI_ID
      left join (select sum(GIATRIMIENGIAM) as GIATRIMIENGIAM, VIENPHI_ID, REF_TABLE
      from TT_MIENGIAM_CHITIET
      where REF_TABLE = 'TT_MIENGIAM_CONGTY'
      and exists (select MIENGIAM_CONGTY_ID from TT_MIENGIAM_CONGTY where TT_MIENGIAM_CHITIET.MIENGIAM_ID = MIENGIAM_CONGTY_ID and  TIEPNHAN_ID = '$TIEPNHAN_ID$')
      group by VIENPHI_ID, REF_TABLE) mgct on mgct.REF_TABLE = 'TT_MIENGIAM_CONGTY' and mgct.VIENPHI_ID = A.VIENPHI_ID
      left join (
      <!--dich vu-->
      select DVYEUCAU_ID as REF_ID, DICHVU_ID, NGAYGIOYEUCAU, CONVERT(date, NGAYGIOYEUCAU, 103) as NGAYYEUCAU1, NOIYEUCAU_ID, '' as KHOTHUCHIEN_ID, NOITHUCHIEN_ID, TRANGTHAI, 'TT_DVYEUCAU' as REF_TABLE
      from TT_DVYEUCAU where TIEPNHAN_ID = '$TIEPNHAN_ID$' and DANGKY_ID is null  and HUYYEUCAU = '0' <!--and BENHAN_ID = '$BENHAN_ID$'-->
      union
      <!--thuoc noi tru-->
      select A.TOATHUOC_ID as REF_ID, A.DUOC_ID as DICHVU_ID, B.THOIGIANKHAM as NGAYGIOYEUCAU, CONVERT(date, B.THOIGIANKHAM, 103) as NGAYYEUCAU1, A.PHONGBANRATOA_ID as NOIYEUCAU_ID, A.KHOPHAT_ID as KHOTHUCHIEN_ID, '' as NOITHUCHIEN_ID, CASE WHEN A.CHUNGTU_ID is null THEN 'CHUAXUAT' ELSE 'DAXUAT' END AS TRANGTHAI, 'TT_NOITRU_TOATHUOC' as REF_TABLE
      from TT_NOITRU_TOATHUOC A
      LEFT JOIN TT_NOITRU_TRATHUOC_CHITIET C ON C.TOATHUOC_ID = A.TOATHUOC_ID
      left join TT_NOITRU_KHAMBENH B on A.KHAMBENH_ID = B.KHAMBENH_ID
      where TIEPNHAN_ID = '$TIEPNHAN_ID$' and (A.SOLUONG > isnull(C.SOLUONG, 0))
      union
      <!--vtyt cls-->
      select CLSKETQUA_VTYT_ID as REF_ID, DUOC_ID as DICHVU_ID, NGAYTAO as NGAYGIOYEUCAU, CONVERT(date, NGAYTAO, 103) as NGAYYEUCAU1, PHONGBAN_ID as NOIYEUCAU_ID, KHOSUDUNG_ID as KHOTHUCHIEN_ID, PHONGBAN_ID as NOITHUCHIEN_ID, CASE WHEN CHUNGTU_ID is null THEN 'CHUAXUAT' ELSE 'DAXUAT' END AS TRANGTHAI, 'TT_CLSKETQUA_VTYT' as REF_TABLE
      from TT_CLSKETQUA_VTYT
      where exists (select DVYEUCAU_ID from TT_DVYEUCAU where TT_CLSKETQUA_VTYT.DVYEUCAU_ID = DVYEUCAU_ID and TIEPNHAN_ID= '$TIEPNHAN_ID$')
      union
      <!--vtyt kham benh-->
      select KHAMBENH_VTYT_ID as REF_ID, DUOC_ID as DICHVU_ID, NGAYTAO as NGAYGIOYEUCAU, CONVERT(date, NGAYTAO, 103) as NGAYYEUCAU1, PHONGBAN_ID as NOIYEUCAU_ID, KHOSUDUNG_ID as KHOTHUCHIEN_ID, PHONGBAN_ID as NOITHUCHIEN_ID, CASE WHEN CHUNGTU_ID is null THEN 'CHUAXUAT' ELSE 'DAXUAT' END AS TRANGTHAI, 'TT_NGOAITRU_KHAMBENH_VTYT' as REF_TABLE
      from TT_NGOAITRU_KHAMBENH_VTYT
      where exists (select DVYEUCAU_ID from TT_DVYEUCAU where TT_NGOAITRU_KHAMBENH_VTYT.DVYEUCAU_ID = DVYEUCAU_ID and TIEPNHAN_ID= '$TIEPNHAN_ID$')
      union
      <!--vtyt phau thuat-->
      select B.PHAUTHUAT_VTYT_ID as REF_ID, B.DUOC_ID as DICHVU_ID, A.NGAYTAO as NGAYGIOYEUCAU, CONVERT(date, A.NGAYTHUCHIEN, 103) as NGAYYEUCAU1, A.PHONGBANTHUCHIEN_ID as NOIYEUCAU_ID, B.KHOSUDUNG_ID as KHOTHUCHIEN_ID, '' as NOITHUCHIEN_ID, CASE WHEN B.CHUNGTU_ID is null THEN 'CHUAXUAT' ELSE 'DAXUAT' END AS TRANGTHAI, 'TT_PHAUTHUAT_VTYT' as REF_TABLE
      from TT_PHAUTHUAT A
      left join TT_PHAUTHUAT_VTYT B on A.PHAUTHUAT_ID = B.PHAUTHUAT_ID
      left join TT_PHAUTHUAT_YEUCAU C on C.PHAUTHUAT_ID = A.PHAUTHUAT_ID
      left join TT_DVYEUCAU D on C.DVYEUCAU_ID = D.DVYEUCAU_ID and D.TIEPNHAN_ID= '$TIEPNHAN_ID$' and D.DANGKY_ID is null
      where A.TIEPNHAN_ID= '$TIEPNHAN_ID$' and B.DUOC_ID is not null
      union
      <!--xuat an-->
      select A.XACNHANSUATANCHITIET_ID as REF_ID, B.KHAUPHANAN_ID as DICHVU_ID, B.NGAYCHIDINHSUATAN as NGAYGIOYEUCAU,CONVERT(date, B.NGAYCHIDINH, 103) as NGAYYEUCAU1
      , B.PHONGBAN_ID as NOIYEUCAU_ID, '' as KHOTHUCHIEN_ID, B.PHONGBAN_ID as NOITHUCHIEN_ID, 'DAXACNHAN' as TRANGTHAI, 'TT_NUT_XACNHANSUATAN_CHITIET' as REF_TABLE
      from TT_NUT_XACNHANSUATAN_CHITIET A
      left join (select A.*, B.NGAYCHIDINH as NGAYCHIDINHSUATAN, B.PHONGBAN_ID from TT_NUT_CHIDINHKHAUPHAN_CHITIET A
      left join TT_NUT_CHIDINHKHAUPHAN B on B.CHIDINHKHAUPHAN_ID = A.CHIDINHKHAUPHAN_ID and A.BENHAN_ID = '$BENHAN_ID$') B on B.CHIDINHKHAUPHANCHITIET_ID = A.CHIDINHKHAUPHANCHITIET_ID
      ) dv on dv.REF_TABLE = A.REF_TABLE and dv.REF_ID = A.REF_ID
      where
      A.TIEPNHAN_ID = '$TIEPNHAN_ID$' and A.BENHVIEN_ID = '$BENHVIEN_ID$' and A.BENHAN_ID = '$BENHAN_ID$'
      and dv.NGAYYEUCAU1 is not null and A.ACTIVE = '1' and A.REF_ID > 0
      <isNotEmpty prepend="" property="BIL18_THANHTOAN_BL_NOITRU">
        <isEqual prepend="AND" property="BIL18_THANHTOAN_BL_NOITRU" compareValue="1">
          (A.DATHANHTOAN = '0' or (A.DATHANHTOAN = '1' and A.BENHNHAN_PHAITHANHTOAN > A.GIATRI_BENHNHAN_DATHANHTOAN))
        </isEqual>
      </isNotEmpty>
      <isPropertyAvailable prepend=""  property="BIL_THUDICHVU_KHONGTHUTIEN">
        <isEqual prepend="AND" property="BIL_THUDICHVU_KHONGTHUTIEN" compareValue="False">
          (A.KHONGTHUTIEN = '0' or A.KHONGTHUTIEN is null)
        </isEqual>
      </isPropertyAvailable>
      <isNotPropertyAvailable prepend="AND" property="BIL_THUDICHVU_KHONGTHUTIEN" >
        (A.KHONGTHUTIEN = '0' or A.KHONGTHUTIEN is null)
      </isNotPropertyAvailable>

      ORDER BY dv.NGAYYEUCAU1 desc
    </statement>
    <statement id="DAO00064_GetVienphiBenhAnNoiTru" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      <!--dich vu-->
      select
      D.KHOAVAO_ID  as PHONGBAN_ID,
      ISNULL(A.DICHVU_ID, A.DUOC_ID) as NOIDUNG_ID, A.REF_ID as IDREF, A.VIENPHI_ID,
      A.SOLUONG as SOLUONG, A.SOLUONG as SOLUONG_NEW, A.DICHVU_ID, A.DUOC_ID,
      A.DONGIA_DOANHTHU, A.DONGIA_DOANHTHU as DONGIADOANHTHU, A.BHYT_DONGIA_CHITRA,
      A.BHYT_DONGIA as DONGIAHOTRO, A.BHYT_THANHTIEN_CHITRA as DONGIAHOTROCHITRA, A.BHYT_DONGIA_CHITRA as DONGIAHOTROCHITRA_NEW,
      A.REF_TABLE as LOAI, A.BHYT_DONGIA, A.BHYT_THANHTIEN, A.BHYT_THANHTIEN_CHITRA, A.BENHNHAN_PHAITHANHTOAN,
      A.GIATRI_BENHNHAN_DATHANHTOAN, A.BENHVIEN_ID, A.THANHTIEN_DOANHTHU,
      A.LOAI_CHIPHI, A.LOAIGIA_ID, A.REF_TABLE, A.KHAMBENH_ID, A.REF_ID, A.DUOCPHEPTHUCHIEN,
      A.HUY, A.KHONGTHUTIEN, A.DATHANHTOAN, A.HOADON_ID, A.ACTIVE, D.BENHNHAN_ID, A.DOTDIEUTRI_ID,
      dv.TENDICHVU NOIDUNG, dv.MADICHVU MADICHVU, dv.NORESULT, null DONVITINH, null MALOAIDUOC, null DUOC_BHYT, null LOAIVATTU_ID, ndv.MANHOMDICHVU
      from TT_VIENPHI A
      inner join TT_NOITRU_BENHAN D on D.BENHAN_ID = A.BENHAN_ID
      inner join TT_DVYEUCAU dvyc on dvyc.DVYEUCAU_ID = A.REF_ID
      left join TM_DICHVU dv on A.DICHVU_ID = dv.DICHVU_ID and A.REF_TABLE = 'TT_DVYEUCAU'
      left join TM_NHOMDICHVU ndv on ndv.NHOMDICHVU_ID = dv.NHOMDICHVU_ID
      where A.BENHAN_ID = '$BENHAN_ID$' and A.BENHVIEN_ID = '$BENHVIEN_ID$'
      and (A.DICHVU_ID is not null and A.DUOC_ID is null)
      and A.KHONGTHUTIEN != '1' and dvyc.HUYYEUCAU != '1' and A.REF_TABLE = 'TT_DVYEUCAU'
      and A.TIEPNHAN_ID = '$TIEPNHAN_ID$' and A.BHYT_DONGIA > 0 and A.ACTIVE = '1'
      <isNotEmpty prepend="and" property="DATHANHTOAN">
        A.DATHANHTOAN = '$DATHANHTOAN$'
      </isNotEmpty>
      <!--thuoc-->
      union
      select
      D.KHOAVAO_ID  as PHONGBAN_ID,
      ISNULL(A.DICHVU_ID, A.DUOC_ID) as NOIDUNG_ID, A.REF_ID as IDREF, A.VIENPHI_ID,
      A.SOLUONG as SOLUONG, A.SOLUONG as SOLUONG_NEW, A.DICHVU_ID, A.DUOC_ID,
      A.DONGIA_DOANHTHU, A.DONGIA_DOANHTHU as DONGIADOANHTHU, A.BHYT_DONGIA_CHITRA,
      A.BHYT_DONGIA as DONGIAHOTRO, A.BHYT_THANHTIEN_CHITRA as DONGIAHOTROCHITRA, A.BHYT_DONGIA_CHITRA as DONGIAHOTROCHITRA_NEW,
      A.REF_TABLE as LOAI, A.BHYT_DONGIA, A.BHYT_THANHTIEN, A.BHYT_THANHTIEN_CHITRA, A.BENHNHAN_PHAITHANHTOAN,
      A.GIATRI_BENHNHAN_DATHANHTOAN, A.BENHVIEN_ID, A.THANHTIEN_DOANHTHU,
      A.LOAI_CHIPHI, A.LOAIGIA_ID, A.REF_TABLE, A.KHAMBENH_ID, A.REF_ID, A.DUOCPHEPTHUCHIEN,
      A.HUY, A.KHONGTHUTIEN, A.DATHANHTOAN, A.HOADON_ID, A.ACTIVE, D.BENHNHAN_ID, A.DOTDIEUTRI_ID,
      dc.TENDUOCDAYDU NOIDUNG, dc.MADUOC MADICHVU, null NORESULT, dc.DONVITINH, ld.MALOAIDUOC, dc.BHYT DUOC_BHYT, ld.LOAIVATTU_ID, null MANHOMDICHVU
      from TT_VIENPHI A
      inner join TT_NOITRU_BENHAN D on D.BENHAN_ID = A.BENHAN_ID
      inner join TT_NOITRU_TOATHUOC B on A.TIEPNHAN_ID = B.TIEPNHAN_ID and A.REF_ID = B.TOATHUOC_ID
      left join TM_DUOC dc on A.DUOC_ID = dc.DUOC_ID
      left join TM_LOAIDUOC ld on dc.LOAIDUOC_ID = ld.LOAIDUOC_ID
      where A.BENHAN_ID = '$BENHAN_ID$' and A.BENHVIEN_ID = '$BENHVIEN_ID$'
      and (A.DICHVU_ID is null and A.DUOC_ID is not null) and REF_TABLE = 'TT_NOITRU_TOATHUOC'
      and A.KHONGTHUTIEN != '1'
      and A.TIEPNHAN_ID = '$TIEPNHAN_ID$' and A.BHYT_DONGIA > 0 and A.ACTIVE = '1'
      <isNotEmpty prepend="and" property="DATHANHTOAN">
        A.DATHANHTOAN = '$DATHANHTOAN$'
      </isNotEmpty>
      <!--vtyt-->
      union
      select
      D.KHOAVAO_ID  as PHONGBAN_ID,
      ISNULL(A.DICHVU_ID, A.DUOC_ID) as NOIDUNG_ID, A.REF_ID as IDREF, A.VIENPHI_ID,
      A.SOLUONG as SOLUONG, A.SOLUONG as SOLUONG_NEW, A.DICHVU_ID, A.DUOC_ID,
      A.DONGIA_DOANHTHU, A.DONGIA_DOANHTHU as DONGIADOANHTHU, A.BHYT_DONGIA_CHITRA,
      A.BHYT_DONGIA as DONGIAHOTRO, A.BHYT_THANHTIEN_CHITRA as DONGIAHOTROCHITRA, A.BHYT_DONGIA_CHITRA as DONGIAHOTROCHITRA_NEW,
      A.REF_TABLE as LOAI, A.BHYT_DONGIA, A.BHYT_THANHTIEN, A.BHYT_THANHTIEN_CHITRA, A.BENHNHAN_PHAITHANHTOAN,
      A.GIATRI_BENHNHAN_DATHANHTOAN, A.BENHVIEN_ID, A.THANHTIEN_DOANHTHU,
      A.LOAI_CHIPHI, A.LOAIGIA_ID, A.REF_TABLE, A.KHAMBENH_ID, A.REF_ID, A.DUOCPHEPTHUCHIEN,
      A.HUY, A.KHONGTHUTIEN, A.DATHANHTOAN, A.HOADON_ID, A.ACTIVE, D.BENHNHAN_ID, A.DOTDIEUTRI_ID,
      dc.TENDUOCDAYDU NOIDUNG, dc.MADUOC MADICHVU, null NORESULT, dc.DONVITINH, ld.MALOAIDUOC, dc.BHYT DUOC_BHYT, ld.LOAIVATTU_ID, null MANHOMDICHVU
      from TT_VIENPHI A
      inner join TT_NOITRU_BENHAN D on D.BENHAN_ID = A.BENHAN_ID
      left join TM_DUOC dc on A.DUOC_ID = dc.DUOC_ID
      left join TM_LOAIDUOC ld on dc.LOAIDUOC_ID = ld.LOAIDUOC_ID
      where A.BENHAN_ID = '$BENHAN_ID$' and A.BENHVIEN_ID = '$BENHVIEN_ID$' <!--and A.HUY = '0'-->
      and (A.DICHVU_ID is null and A.DUOC_ID is not null) and REF_TABLE not in ('TT_DVYEUCAU', 'TT_NOITRU_TOATHUOC', 'TT_NUT_XACNHANSUATAN_CHITIET', 'TT_MAU_CHUNGTU_CHITIET')
      and A.KHONGTHUTIEN != '1' and A.TIEPNHAN_ID = '$TIEPNHAN_ID$' and A.BHYT_DONGIA > 0 and A.ACTIVE = '1'
      <isNotEmpty prepend="and" property="DATHANHTOAN">
        A.DATHANHTOAN = '$DATHANHTOAN$'
      </isNotEmpty>
    </statement>
    <statement id="DAO00064_GetVienphiBenhAnNoiTru_BIL16" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      <!--dich vu-->
      select
      D.KHOAVAO_ID  as PHONGBAN_ID,
      ISNULL(A.DICHVU_ID, A.DUOC_ID) as NOIDUNG_ID, A.REF_ID as IDREF, A.VIENPHI_ID,
      A.SOLUONG as SOLUONG, A.SOLUONG as SOLUONG_NEW, A.DICHVU_ID, A.DUOC_ID,
      A.DONGIA_DOANHTHU, A.DONGIA_DOANHTHU as DONGIADOANHTHU, A.BHYT_DONGIA_CHITRA,
      A.BHYT_DONGIA as DONGIAHOTRO, A.BHYT_THANHTIEN_CHITRA as DONGIAHOTROCHITRA, A.BHYT_DONGIA_CHITRA as DONGIAHOTROCHITRA_NEW,
      A.REF_TABLE as LOAI, A.BHYT_DONGIA, A.BHYT_THANHTIEN, A.BHYT_THANHTIEN_CHITRA, A.BENHNHAN_PHAITHANHTOAN,
      A.GIATRI_BENHNHAN_DATHANHTOAN, A.BENHVIEN_ID, A.THANHTIEN_DOANHTHU,
      A.LOAI_CHIPHI, A.LOAIGIA_ID, A.REF_TABLE, A.KHAMBENH_ID, A.REF_ID, A.DUOCPHEPTHUCHIEN,
      A.HUY, A.KHONGTHUTIEN, A.DATHANHTOAN, A.HOADON_ID, A.ACTIVE, D.BENHNHAN_ID, A.DOTDIEUTRI_ID,
      dv.TENDICHVU NOIDUNG, dv.MADICHVU MADICHVU, dv.NORESULT, null DONVITINH, null MALOAIDUOC, null DUOC_BHYT, null LOAIVATTU_ID, ndv.MANHOMDICHVU
      from TT_VIENPHI A
      inner join TT_NOITRU_BENHAN D on D.BENHAN_ID = A.BENHAN_ID
      inner join TT_DVYEUCAU dvyc on dvyc.DVYEUCAU_ID = A.REF_ID
      left join TM_DICHVU dv on A.DICHVU_ID = dv.DICHVU_ID and A.REF_TABLE = 'TT_DVYEUCAU'
      left join TM_NHOMDICHVU ndv on ndv.NHOMDICHVU_ID = dv.NHOMDICHVU_ID
      where A.BENHAN_ID = '$BENHAN_ID$' and A.BENHVIEN_ID = '$BENHVIEN_ID$'
      and (A.DICHVU_ID is not null and A.DUOC_ID is null)
      and A.KHONGTHUTIEN != '1' and dvyc.HUYYEUCAU != '1' and A.REF_TABLE = 'TT_DVYEUCAU'
      and A.TIEPNHAN_ID = '$TIEPNHAN_ID$' and A.ACTIVE = '1'
      <isNotEmpty prepend="" property="BIL_XACNHANBHYT_HIENTHI_TATCA">
        <isEqual prepend="AND" property="BIL_XACNHANBHYT_HIENTHI_TATCA" compareValue="False">
          A.BHYT_DONGIA > 0
        </isEqual>
      </isNotEmpty>
      <isNotEmpty prepend="and" property="DATHANHTOAN">
        A.DATHANHTOAN = '$DATHANHTOAN$'
      </isNotEmpty>
      <!--thuoc-->
      union
      select
      D.KHOAVAO_ID  as PHONGBAN_ID,
      ISNULL(A.DICHVU_ID, A.DUOC_ID) as NOIDUNG_ID, A.REF_ID as IDREF, A.VIENPHI_ID,
      A.SOLUONG as SOLUONG, A.SOLUONG as SOLUONG_NEW, A.DICHVU_ID, A.DUOC_ID,
      A.DONGIA_DOANHTHU, A.DONGIA_DOANHTHU as DONGIADOANHTHU, A.BHYT_DONGIA_CHITRA,
      A.BHYT_DONGIA as DONGIAHOTRO, A.BHYT_THANHTIEN_CHITRA as DONGIAHOTROCHITRA, A.BHYT_DONGIA_CHITRA as DONGIAHOTROCHITRA_NEW,
      A.REF_TABLE as LOAI, A.BHYT_DONGIA, A.BHYT_THANHTIEN, A.BHYT_THANHTIEN_CHITRA, A.BENHNHAN_PHAITHANHTOAN,
      A.GIATRI_BENHNHAN_DATHANHTOAN, A.BENHVIEN_ID, A.THANHTIEN_DOANHTHU,
      A.LOAI_CHIPHI, A.LOAIGIA_ID, A.REF_TABLE, A.KHAMBENH_ID, A.REF_ID, A.DUOCPHEPTHUCHIEN,
      A.HUY, A.KHONGTHUTIEN, A.DATHANHTOAN, A.HOADON_ID, A.ACTIVE, D.BENHNHAN_ID, A.DOTDIEUTRI_ID,
      dc.TENDUOCDAYDU NOIDUNG, dc.MADUOC MADICHVU, null NORESULT, dc.DONVITINH, ld.MALOAIDUOC, dc.BHYT DUOC_BHYT, ld.LOAIVATTU_ID, null MANHOMDICHVU
      from TT_VIENPHI A
      inner join TT_NOITRU_BENHAN D on D.BENHAN_ID = A.BENHAN_ID
      inner join TT_NOITRU_TOATHUOC B on A.TIEPNHAN_ID = B.TIEPNHAN_ID and A.REF_ID = B.TOATHUOC_ID
      left join TM_DUOC dc on A.DUOC_ID = dc.DUOC_ID
      left join TM_LOAIDUOC ld on dc.LOAIDUOC_ID = ld.LOAIDUOC_ID
      where A.BENHAN_ID = '$BENHAN_ID$' and A.BENHVIEN_ID = '$BENHVIEN_ID$'
      and (A.DICHVU_ID is null and A.DUOC_ID is not null) and REF_TABLE = 'TT_NOITRU_TOATHUOC'
      and A.KHONGTHUTIEN != '1'
      and A.TIEPNHAN_ID = '$TIEPNHAN_ID$' and A.ACTIVE = '1'
      <isNotEmpty prepend="" property="BIL_XACNHANBHYT_HIENTHI_TATCA">
        <isEqual prepend="AND" property="BIL_XACNHANBHYT_HIENTHI_TATCA" compareValue="False">
          A.BHYT_DONGIA > 0
        </isEqual>
      </isNotEmpty>
      <isNotEmpty prepend="and" property="DATHANHTOAN">
        A.DATHANHTOAN = '$DATHANHTOAN$'
      </isNotEmpty>
      <!--vtyt-->
      union
      select
      D.KHOAVAO_ID  as PHONGBAN_ID,
      ISNULL(A.DICHVU_ID, A.DUOC_ID) as NOIDUNG_ID, A.REF_ID as IDREF, A.VIENPHI_ID,
      A.SOLUONG as SOLUONG, A.SOLUONG as SOLUONG_NEW, A.DICHVU_ID, A.DUOC_ID,
      A.DONGIA_DOANHTHU, A.DONGIA_DOANHTHU as DONGIADOANHTHU, A.BHYT_DONGIA_CHITRA,
      A.BHYT_DONGIA as DONGIAHOTRO, A.BHYT_THANHTIEN_CHITRA as DONGIAHOTROCHITRA, A.BHYT_DONGIA_CHITRA as DONGIAHOTROCHITRA_NEW,
      A.REF_TABLE as LOAI, A.BHYT_DONGIA, A.BHYT_THANHTIEN, A.BHYT_THANHTIEN_CHITRA, A.BENHNHAN_PHAITHANHTOAN,
      A.GIATRI_BENHNHAN_DATHANHTOAN, A.BENHVIEN_ID, A.THANHTIEN_DOANHTHU,
      A.LOAI_CHIPHI, A.LOAIGIA_ID, A.REF_TABLE, A.KHAMBENH_ID, A.REF_ID, A.DUOCPHEPTHUCHIEN,
      A.HUY, A.KHONGTHUTIEN, A.DATHANHTOAN, A.HOADON_ID, A.ACTIVE, D.BENHNHAN_ID, A.DOTDIEUTRI_ID,
      dc.TENDUOCDAYDU NOIDUNG, dc.MADUOC MADICHVU, null NORESULT, dc.DONVITINH, ld.MALOAIDUOC, dc.BHYT DUOC_BHYT, ld.LOAIVATTU_ID, null MANHOMDICHVU
      from TT_VIENPHI A
      inner join TT_NOITRU_BENHAN D on D.BENHAN_ID = A.BENHAN_ID
      left join TM_DUOC dc on A.DUOC_ID = dc.DUOC_ID
      left join TM_LOAIDUOC ld on dc.LOAIDUOC_ID = ld.LOAIDUOC_ID
      where A.BENHAN_ID = '$BENHAN_ID$' and A.BENHVIEN_ID = '$BENHVIEN_ID$' <!--and A.HUY = '0'-->
      and (A.DICHVU_ID is null and A.DUOC_ID is not null) and REF_TABLE not in ('TT_DVYEUCAU', 'TT_NOITRU_TOATHUOC', 'TT_NUT_XACNHANSUATAN_CHITIET', 'TT_MAU_CHUNGTU_CHITIET')
      and A.KHONGTHUTIEN != '1' and A.TIEPNHAN_ID = '$TIEPNHAN_ID$' and A.ACTIVE = '1'
      <isNotEmpty prepend="" property="BIL_XACNHANBHYT_HIENTHI_TATCA">
        <isEqual prepend="AND" property="BIL_XACNHANBHYT_HIENTHI_TATCA" compareValue="False">
          A.BHYT_DONGIA > 0
        </isEqual>
      </isNotEmpty>
      <isNotEmpty prepend="and" property="DATHANHTOAN">
        A.DATHANHTOAN = '$DATHANHTOAN$'
      </isNotEmpty>
      order by VIENPHI_ID
    </statement>
    <statement id="DAO00064_GetListBenhNhanNgoaiTru2NoiTru" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select distinct
      A.HUONGGIAIQUYET_ID, A.CHANDOANKHOAKHAM as CHANDOAN, A.PHONGBAN_ID, A.CHANDOANICD_ID as MABENH, A.CHANDOANPHUICD_ID as BENHKHAC,
      B.SOBHYT, B.NGAYTIEPNHAN , B.THOIGIANTIEPNHAN as NGAYVAO, B.SOTIEPNHAN, B.DOITUONG_ID, B.TIEPNHAN_ID,
      C.MAYTE as MABN, C.TENBENHNHAN as TENBN, C.NAMSINH , C.BENHNHAN_ID, B.BENHVIEN_ID, D.BENHAN_ID, D.SOBENHAN, B.TRAITUYEN, B.NGAYMIENDONGCHITRA,
      D.LOAIBENHAN
      from TT_TIEPNHAN B
      left join TT_BENHNHAN C on B.BENHNHAN_ID = C.BENHNHAN_ID
      left join TT_NGOAITRU_KHAMBENH A on B.TIEPNHAN_ID = A.TIEPNHAN_ID
      left join TT_NOITRU_BENHAN D on D.TIEPNHAN_ID = B.TIEPNHAN_ID and D.SOBENHAN is not NULL
      left join (select count(1) as NUMOFVP, TIEPNHAN_ID, BENHAN_ID from TT_VIENPHI where BENHAN_ID is null and THANHTIEN_DOANHTHU &#62; 0 group by TIEPNHAN_ID, BENHAN_ID) E on E.TIEPNHAN_ID = A.TIEPNHAN_ID
      left join (
      select count(1) as NUMOFTU, TIEPNHAN_ID, BENHAN_ID
      from TT_HOADON
      where LOAIHOADON = 'TU' and BENHAN_ID is null
      and (TRANGTHAI != 'CHUATHUTIEN' and TRANGTHAI != 'DAHOANUNG')
      and HUYHOADON = 0 and HOANTRA = 0
      group by TIEPNHAN_ID, BENHAN_ID
      ) F on F.TIEPNHAN_ID = A.TIEPNHAN_ID
      where
      <!--E.NUMOFVP is not null-->
      ((E.NUMOFVP is not null and E.NUMOFVP &#62; 0) or (F.NUMOFTU is not null and F.NUMOFTU &#62; 0))
      <isNotEmpty prepend="" property="BIL_CHUYENCHIPHI_NT_CC">
        <isEqual prepend="AND" property="BIL_CHUYENCHIPHI_NT_CC" compareValue="False">
          (B.SOBHYT is not null and B.SOBHYT != '')
        </isEqual>
      </isNotEmpty>
      <!--and (B.SOBHYT is not null and B.SOBHYT != '')-->
      <!--and E.BENHAN_ID is null-->
      and (E.BENHAN_ID is null or F.BENHAN_ID is null)
      and (B.TRANGTHAI = 'NOITRU' or B.TRANGTHAI = 'CAPCUU' or B.TRANGTHAI='NGOAITRU')
      <isNotEmpty prepend="and" property="TUNGAY">
        B.NGAYTIEPNHAN &#62;&#61; '$TUNGAY$'
      </isNotEmpty>
      <isNotEmpty prepend="and" property="DENNGAY">
        B.NGAYTIEPNHAN &#60;&#61; '$DENNGAY$'
      </isNotEmpty>
      <!--(B.NGAYTIEPNHAN BETWEEN '$TUNGAY$' AND '$DENNGAY$')-->
      and B.BENHVIEN_ID = '$BENHVIEN_ID$'
      <isNotEmpty prepend="and" property="MABENHNHAN">
        C.MAYTE = '$MABENHNHAN$'
      </isNotEmpty>
      order by B.SOTIEPNHAN desc
    </statement>
    <statement id="DAO00064_GetListBenhNhanCapCuu2NoiTru" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select distinct
      B.SOBHYT, B.NGAYTIEPNHAN ,  D.THOIGIANVAOKHOA as NGAYVAO, B.SOTIEPNHAN, B.DOITUONG_ID, B.TIEPNHAN_ID,
      C.MAYTE as MABN, C.TENBENHNHAN as TENBN, C.NAMSINH , C.BENHNHAN_ID, B.BENHVIEN_ID, D.BENHAN_ID, D.SOBENHAN, B.TRAITUYEN, B.NGAYMIENDONGCHITRA,
      D.LOAIBENHAN, D.SOCAPCUU, D.BENHAN_CAPCUU
      from TT_TIEPNHAN B
      left join TT_BENHNHAN C on B.BENHNHAN_ID = C.BENHNHAN_ID
      left join (
      select A.*, B.BENHAN_ID as BENHAN_CAPCUU
      from TT_NOITRU_BENHAN A
      left join (select * from TT_NOITRU_BENHAN where LOAIBENHAN = '1' and TRANGTHAI in ('DAXUATVIEN', 'DAKHOA', 'DATHANHTOAN')) B on A.TIEPNHAN_ID = B.TIEPNHAN_ID
      where A.LOAIBENHAN = '3' and B.SOBENHAN is not null) D on D.TIEPNHAN_ID = B.TIEPNHAN_ID
      <!--left join (select count(*) as NUMOFVP, TIEPNHAN_ID, BENHAN_ID from TT_VIENPHI where BENHAN_ID is not null and THANHTIEN_DOANHTHU > 0 group by TIEPNHAN_ID, BENHAN_ID)
      E on E.BENHAN_ID = D.BENHAN_CAPCUU-->
      where B.TRANGTHAI = 'NOITRU' and D.BENHAN_CAPCUU is not null
      <!--and E.NUMOFVP is not null
      and E.BENHAN_ID is not null-->
      <isNotEmpty prepend="and" property="TUNGAY">
        D.NGAYVAOKHOA &#62;&#61; '$TUNGAY$'
      </isNotEmpty>
      <isNotEmpty prepend="and" property="DENNGAY">
        D.NGAYVAOKHOA &#60;&#61; '$DENNGAY$'
      </isNotEmpty>
      <!--(B.NGAYTIEPNHAN BETWEEN '$TUNGAY$' AND '$DENNGAY$')-->
      and B.BENHVIEN_ID = '$BENHVIEN_ID$'
      <isNotEmpty prepend="and" property="MABENHNHAN">
        C.MAYTE = '$MABENHNHAN$'
      </isNotEmpty>
      order by B.SOTIEPNHAN desc
    </statement>
    <statement id="DAO00064_Add" parameterClass="System.Collections.IDictionary" resultClass="System.Int64">
      insert into TT_XACNHANCHIPHI (
      SOXACNHAN
      , TIEPNHAN_ID
      , BENHAN_ID
      , KHAMBENH_ID
      , BENHNHAN_ID
      , DOITUONG_ID
      , SOBHYT
      , NGAYVAO
      , NGAYRA
      , NGAYKHAM
      , CHANDOAN
      , LOAI
      , NGAYXACNHAN
      , BENHVIEN_ID
      , IDCHUYEN
      , IDCHUYENHUY
      , IDCHUYENHOAN
      , TUYENKHAMBENH
      , THOIGIANXACNHAN
      , NGAYXUATTHUOC
      , NOIXACNHAN_ID
      , MABENH
      , BENHKHAC
      , TENPHONGKHAM
      , NGAYTAO
      , NGUOITAO_ID
      , NGAYCAPNHAT
      , NGUOICAPNHAT_ID
      , DOTDIEUTRI_ID
      ) values (
      #SOXACNHAN#
      , #TIEPNHAN_ID#
      , #BENHAN_ID#
      , #KHAMBENH_ID#
      , #BENHNHAN_ID#
      , #DOITUONG_ID#
      , #SOBHYT#
      , #NGAYVAO#
      , #NGAYRA#
      , #NGAYKHAM#
      , #CHANDOAN#
      , #LOAI#
      , #NGAYXACNHAN#
      , #BENHVIEN_ID#
      , #IDCHUYEN#
      , #IDCHUYENHUY#
      , #IDCHUYENHOAN#
      , #TUYENKHAMBENH#
      , #THOIGIANXACNHAN#
      , #NGAYXUATTHUOC#
      , #NOIXACNHAN_ID#
      , #MABENH#
      , #BENHKHAC#
      , #TENPHONGKHAM#
      , #NGAYTAO#
      , #NGUOITAO_ID#
      , #NGAYCAPNHAT#
      , #NGUOICAPNHAT_ID#
      , #DOTDIEUTRI_ID#
      )
      SELECT SCOPE_IDENTITY()
      <!--<selectKey resultClass="System.Int64" type="post" >
        SELECT @@IDENTITY as value
      </selectKey>-->
    </statement>
    <update id="DAO00064_Update" parameterClass="System.Collections.IDictionary">
      update TT_XACNHANCHIPHI set
      SOXACNHAN = #SOXACNHAN#
      , TIEPNHAN_ID = #TIEPNHAN_ID#
      , BENHAN_ID = #BENHAN_ID#
      , KHAMBENH_ID = #KHAMBENH_ID#
      , BENHNHAN_ID = #BENHNHAN_ID#
      , DOITUONG_ID = #DOITUONG_ID#
      , SOBHYT = #SOBHYT#
      , NGAYVAO = #NGAYVAO#
      , NGAYRA = #NGAYRA#
      , NGAYKHAM = #NGAYKHAM#
      , CHANDOAN = #CHANDOAN#
      , LOAI = #LOAI#
      , NGAYXACNHAN = #NGAYXACNHAN#
      , BENHVIEN_ID = #BENHVIEN_ID#
      , IDCHUYEN = #IDCHUYEN#
      , IDCHUYENHUY = #IDCHUYENHUY#
      , IDCHUYENHOAN = #IDCHUYENHOAN#
      , TUYENKHAMBENH = #TUYENKHAMBENH#
      , THOIGIANXACNHAN = #THOIGIANXACNHAN#
      , NGAYXUATTHUOC = #NGAYXUATTHUOC#
      , NOIXACNHAN_ID = #NOIXACNHAN_ID#
      , MABENH = #MABENH#
      , BENHKHAC = #BENHKHAC#
      , TENPHONGKHAM = #TENPHONGKHAM#
      <!--, NGAYTAO = #NGAYTAO#
      , NGUOITAO_ID = #NGUOITAO_ID#-->
      , NGAYCAPNHAT = #NGAYCAPNHAT#
      , NGUOICAPNHAT_ID = #NGUOICAPNHAT_ID#
      where
      XACNHANCHIPHI_ID = '$XACNHANCHIPHI_ID$'
    </update>
    <statement id="DAO00064_Add_Chitiet" parameterClass="System.Collections.IDictionary" resultClass="System.Int64">
      insert into TT_XACNHANCHIPHICHITIET (
      XACNHANCHIPHI_ID
      , VIENPHI_ID
      , IDREF
      , NOIDUNG_ID
      , NOIDUNG
      , SOLUONG
      , DONGIADOANHTHU
      , DONGIAHOTRO
      , DONGIAHOTROCHITRA
      , DONGIATHANHTOAN
      , LOAI
      , NGAYCAPNHAT
      , NGUOICAPNHAT_ID
      , PHONGBAN_ID
      , NGOAITRU_TOATHUOC_ID
      , NOITRU_TOATHUOC_ID
      , BENHVIEN_ID
      ) values (
      #XACNHANCHIPHI_ID#
      , #VIENPHI_ID#
      , #IDREF#
      , #NOIDUNG_ID#
      , #NOIDUNG#
      , #SOLUONG#
      , #DONGIADOANHTHU#
      , #DONGIAHOTRO#
      , #DONGIAHOTROCHITRA#
      , #DONGIAHOTROCHITRA_NEW#
      , #LOAI#
      , #NGAYCAPNHAT#
      , #NGUOICAPNHAT_ID#
      , #PHONGBAN_ID#
      , #NGOAITRU_TOATHUOC_ID#
      , #NOITRU_TOATHUOC_ID#
      , #BENHVIEN_ID#
      )
      SELECT SCOPE_IDENTITY()
      <!--<selectKey resultClass="System.Int64" type="post" >
        SELECT @@IDENTITY as value
      </selectKey>-->
    </statement>
    <update id="DAO00064_Update_Chitiet" parameterClass="System.Collections.IDictionary">
      update TT_XACNHANCHIPHICHITIET set
      XACNHANCHIPHI_ID = #XACNHANCHIPHI_ID#
      , VIENPHI_ID = #VIENPHI_ID#
      <!--, LOAI_IDREF = #LOAI_IDREF#-->
      , IDREF = #IDREF#
      , NOIDUNG_ID = #NOIDUNG_ID#
      , NOIDUNG = #NOIDUNG#
      , SOLUONG = #SOLUONG#
      , DONGIADOANHTHU = #DONGIADOANHTHU#
      , DONGIAHOTRO = #DONGIAHOTRO#
      , DONGIAHOTROCHITRA = #DONGIAHOTROCHITRA#
      , DONGIATHANHTOAN = #DONGIATHANHTOAN#
      <!--, SOLUONG_NEW = #SOLUONG_NEW#
      , DONGIAHOTROCHITRA_NEW = #DONGIAHOTROCHITRA_NEW#-->
      , LOAI = #LOAI#
      , NGAYCAPNHAT = #NGAYCAPNHAT#
      , NGUOICAPNHAT_ID = #NGUOICAPNHAT_ID#
      , PHONGBAN_ID = #PHONGBAN_ID#
      , NGOAITRU_TOATHUOC_ID = #NGOAITRU_TOATHUOC_ID#
      , NOITRU_TOATHUOC_ID = #NOITRU_TOATHUOC_ID#
      , BENHVIEN_ID = #BENHVIEN_ID#
      where
      XACNHANCHIPHICHITIET_ID = '$XACNHANCHIPHICHITIET_ID$'
    </update>
    <statement id="DAO00064_Delete" parameterClass="System.Collections.IDictionary" resultClass="System.Int32">
      delete from TT_XACNHANCHIPHICHITIET
      where XACNHANCHIPHI_ID in
      (select XACNHANCHIPHI_ID from TT_XACNHANCHIPHI where TIEPNHAN_ID = '$TIEPNHAN_ID$');
      delete from TT_XACNHANCHIPHI where TIEPNHAN_ID = '$TIEPNHAN_ID$';
    </statement>

    <!--============================================================================
//CONG NO NOI TRU
//===========================================================================-->
    <statement id="DAO00064_GetListCongNoNoiTru" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select
      ntba.BENHAN_ID, ntba.TIEPNHAN_ID, ntba.SOBENHAN, ntba.NGAYVAOKHOA as NGAYVAOVIEN,
      tn.SOBHYT, tn.SOTIEPNHAN,
      bn.MAYTE, bn.TENBENHNHAN,
      dt.TENDOITUONG, gb.MAGIUONG, pb.TENPHONGBAN as TENKHOA, pb.MAPHONGBAN,
      tu.TAMUNG, hu.HOANUNG,cth.DICHVU_CHUATHUCHIEN,
      vp.CHIPHITHANHTOAN, vp.BENHNHANTHANHTOAN, vp.BHYTCHITRA<!--, vp.CHENHLECH-->
      , ntba.LOAIBENHAN
      from  TT_NOITRU_BENHAN ntba

      left join TT_TIEPNHAN tn on tn.TIEPNHAN_ID = ntba.TIEPNHAN_ID <!--and ntba.BENHNHAN_ID = tn.BENHNHAN_ID-->
      left join TT_BENHNHAN bn on bn.BENHNHAN_ID = tn.BENHNHAN_ID
      inner join TM_DOITUONG dt on tn.DOITUONG_ID = dt.DOITUONG_ID
      inner join TM_PHONGBAN pb on pb.PHONGBAN_ID = isnull(ntba.KHOACHUYENDEN_ID, ntba.KHOAVAO_ID)
      left join
      (
      select ntltct.GIUONGBENH_ID, ntlt.BENHAN_ID
      from TT_NOITRU_LUUTRU ntlt
      left join TT_NOITRU_LUUTRUCHITIET ntltct on ntlt.LUUTRU_ID = ntltct.LUUTRU_ID
      where ntlt.LUUTRU_CURRENT = '1' and ntltct.LUUTRUCHITIET_CURRENT = '1' and ntlt.BENHVIEN_ID = '$BENHVIEN_ID$'
      ) as lt on lt.BENHAN_ID = ntba.BENHAN_ID
      left join TM_GIUONGBENH gb on GB.GIUONGBENH_ID = lt.GIUONGBENH_ID
      left join
      (
      SELECT BENHAN_ID, SUM(GIATRITHUCTHU) AS TAMUNG
      FROM TT_HOADON WHERE LOAIHOADON ='TU'and (TRANGTHAI = 'DATHUTIEN' or TRANGTHAI = 'CHODUYET'  or TRANGTHAI = 'DADUYET') and BENHAN_ID is not null and HUYHOADON = 0 and BENHVIEN_ID = '$BENHVIEN_ID$'
      GROUP BY BENHAN_ID
      ) tu on tu.BENHAN_ID = ntba.BENHAN_ID
      left join
      (
      SELECT BENHAN_ID, SUM(GIATRIHOADON) AS HOANUNG
      FROM TT_HOADON WHERE LOAIHOADON ='HU' and BENHAN_ID is not null and BENHVIEN_ID = '$BENHVIEN_ID$' GROUP BY BENHAN_ID
      ) hu on hu.BENHAN_ID = ntba.BENHAN_ID
      left join
      (
      select A.BENHAN_ID, SUM(BENHNHAN_PHAITHANHTOAN) as CHIPHITHANHTOAN,
      sum(GIATRI_BENHNHAN_DATHANHTOAN) as BENHNHANTHANHTOAN,
      <!--(SUM(BENHNHAN_PHAITHANHTOAN) - sum(GIATRI_BENHNHAN_DATHANHTOAN)) as CHENHLECH ,-->
      sum (BHYT_THANHTIEN_CHITRA) as BHYTCHITRA
      from TT_VIENPHI A
      left join TT_DVYEUCAU B on A.REF_ID = B.DVYEUCAU_ID and A.REF_TABLE = 'TT_DVYEUCAU'
      left join TT_NOITRU_TOATHUOC C on A.REF_ID = C.TOATHUOC_ID and A.REF_TABLE = 'TT_NOITRU_TOATHUOC'
      left join TT_PHAUTHUAT_VTYT D on A.REF_ID = D.PHAUTHUAT_VTYT_ID and A.REF_TABLE = 'TT_PHAUTHUAT_VTYT'
      left join TT_CLSKETQUA_VTYT E on A.REF_ID = E.CLSKETQUA_VTYT_ID and A.REF_TABLE = 'TT_CLSKETQUA_VTYT'
      where A.BENHAN_ID is not null and A.BENHVIEN_ID = '$BENHVIEN_ID$' and ACTIVE = '1'
      and (
      (B.HUYYEUCAU != '1' and A.DICHVU_ID is not null) or
      (A.DICHVU_ID is not null and A.REF_TABLE = 'TT_NUT_XACNHANSUATAN_CHITIET') or
      (A.DUOC_ID is not null and C.TOATHUOC_ID is not null and A.REF_TABLE = 'TT_NOITRU_TOATHUOC') or
      (A.DUOC_ID is not null and D.PHAUTHUAT_VTYT_ID is not null and A.REF_TABLE = 'TT_PHAUTHUAT_VTYT') or
      (A.DUOC_ID is not null and E.CLSKETQUA_VTYT_ID is not null and A.REF_TABLE = 'TT_CLSKETQUA_VTYT') or
      (A.DUOC_ID is not null and A.REF_TABLE != 'TT_NOITRU_TOATHUOC' and A.REF_TABLE != 'TT_PHAUTHUAT_VTYT' and A.REF_TABLE != 'TT_CLSKETQUA_VTYT' and A.REF_TABLE != 'TT_MAU_CHUNGTU_CHITIET')
      ) and A.REF_ID is not null and A.REF_ID != 0 and A.SOLUONG > 0
      GROUP BY A.BENHAN_ID
      ) vp on vp.BENHAN_ID = ntba.BENHAN_ID

      left join
      (
      select vp.BENHAN_ID, vp.TIEPNHAN_ID, sum(vp.BENHNHAN_PHAITHANHTOAN) as DICHVU_CHUATHUCHIEN
      from TT_VIENPHI vp
      left join TT_DVYEUCAU dv on vp.TIEPNHAN_ID = dv.TIEPNHAN_ID and vp.REF_ID = dv.DVYEUCAU_ID
      where vp.BENHAN_ID is not null and REF_TABLE = 'TT_DVYEUCAU'
      and dv.TRANGTHAI = 'CHUAKETQUA' and vp.BENHVIEN_ID = '$BENHVIEN_ID$'
      and vp.ACTIVE = '1' and vp.SOLUONG > 0
      GROUP BY vp.BENHAN_ID, vp.TIEPNHAN_ID
      ) cth on cth.BENHAN_ID = ntba.BENHAN_ID
      where
      (ntba.KHOACHUYENDEN_ID IN ($LIST_KHOADIEUTRI_ID$) or (ntba.KHOAVAO_ID IN ($LIST_KHOADIEUTRI_ID$) and ntba.KHOACHUYENDEN_ID is null)) and ntba.BENHVIEN_ID = '$BENHVIEN_ID$'
      <isNotEmpty prepend="and" property="TUNGAY">
        ntba.NGAYVAOKHOA &#62;&#61; '$TUNGAY$'
      </isNotEmpty>
      <isNotEmpty prepend="and" property="DENNGAY">
        ntba.NGAYVAOKHOA &#60;&#61; '$DENNGAY$'
      </isNotEmpty>
      AND ntba.TRANGTHAI = '$TRANGTHAI$'
      <isNotEmpty prepend="and" property="TENBENHNHAN">
        (bn.TENBENHNHAN like '%' + #TENBENHNHAN# + '%' or bn.MAYTE like '%' + #TENBENHNHAN# + '%')
      </isNotEmpty>

      <!--SELECT BA.*
      , case
      when BA.TRANGTHAI = 'DATHANHTOAN' then 0
      else PTT.CHIPHITHANHTOAN
      end CHIPHITHANHTOAN

      , case
      when BA.TRANGTHAI = 'DATHANHTOAN' then 0
      else TU.TAMUNG
      end TAMUNG

      , case
      when BA.TRANGTHAI = 'DATHANHTOAN' then 0
      else TU.TAMUNG - PTT.CHIPHITHANHTOAN
      end CHENHLECH

      , case
      when BA.TRANGTHAI = 'DATHANHTOAN' then 0
      else HU.HOANUNG
      end HOANUNG

      , GB.MAGIUONG
      FROM
      ( SELECT BA.TIEPNHAN_ID, BA.BENHAN_ID, BA.SOBENHAN, BN.TENBENHNHAN, PB.TENPHONGBAN AS TENKHOA,
      BA.NGAYVAOVIEN, BN.MAYTE, TN.SOBHYT, DT.TENDOITUONG, BA.TRANGTHAI
      FROM
      TT_NOITRU_BENHAN BA,
      TT_BENHNHAN BN,
      TM_PHONGBAN PB,
      TT_TIEPNHAN TN,
      TM_DOITUONG DT
      WHERE
      BA.BENHNHAN_ID = BN.BENHNHAN_ID
      AND (BA.KHOACHUYENDEN_ID = PB.PHONGBAN_ID or (BA.KHOAVAO_ID = PB.PHONGBAN_ID and BA.KHOACHUYENDEN_ID is null))
      AND BA.TIEPNHAN_ID = TN.TIEPNHAN_ID
      AND TN.DOITUONG_ID = DT.DOITUONG_ID
      AND PB.PHONGBAN_ID IN ($LIST_KHOADIEUTRI_ID$)
      <isNotEmpty prepend="and" property="TUNGAY">
          BA.NGAYVAOKHOA &#62;&#61; '$TUNGAY$'
      </isNotEmpty>
      <isNotEmpty prepend="and" property="DENNGAY">
        BA.NGAYVAOKHOA &#60;&#61; '$DENNGAY$'
      </isNotEmpty>
      AND BA.TRANGTHAI = '$TRANGTHAI$'
      <isNotEmpty prepend="and" property="TENBENHNHAN">
        (BN.TENBENHNHAN like N'%$TENBENHNHAN$%' or BN.MAYTE like N'%$TENBENHNHAN$%')
      </isNotEmpty>
      )BA
      left join TT_NOITRU_LUUTRU LT on LT.BENHAN_ID = BA.BENHAN_ID and LT.LUUTRU_CURRENT = '1'
      left join TT_NOITRU_LUUTRUCHITIET LTCT on LTCT.LUUTRU_ID = LT.LUUTRU_ID and ltct.LUUTRUCHITIET_CURRENT = '1'
      left join TM_GIUONGBENH GB on GB.GIUONGBENH_ID = LTCT.GIUONGBENH_ID
      left join (SELECT TIEPNHAN_ID, SUM(BENHNHAN_PHAITHANHTOAN) AS CHIPHITHANHTOAN
      FROM TT_VIENPHI where BENHAN_ID is not null and DATHANHTOAN = '0' GROUP BY TIEPNHAN_ID) PTT on BA.TIEPNHAN_ID = PTT.TIEPNHAN_ID
      left join (SELECT TIEPNHAN_ID, SUM(GIATRITHUCTHU) AS TAMUNG
      FROM TT_HOADON WHERE LOAIHOADON ='TU'and TRANGTHAI = 'DATHUTIEN' and HUYHOADON = 0
      GROUP BY TIEPNHAN_ID) TU on TU.TIEPNHAN_ID = BA.TIEPNHAN_ID
      left join (SELECT TIEPNHAN_ID, SUM(GIATRIHOADON) AS HOANUNG
      FROM TT_HOADON WHERE LOAIHOADON ='HU' GROUP BY TIEPNHAN_ID) HU on HU.TIEPNHAN_ID = BA.TIEPNHAN_ID
      order by BA.NGAYVAOVIEN DESC-->
    </statement>
    <statement id="DAO00064_GetThongTinGiuongCHoCongNo" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select * from TT_NOITRU_LUUTRUCHITIET
      where LUUTRU_ID in (select top 1 LUUTRU_ID from TT_NOITRU_LUUTRU
      where LUUTRU_CURRENT = '1' and BENHAN_ID = '$BENHAN_ID$' order by LUUTRU_ID desc)
    </statement>
    <statement id="DAO00064_GetThongTinBenhAnTamUng" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      SELECT BENHAN_ID, GIATRITHUCTHU, NGAYHOADON
      FROM TT_HOADON WHERE
      LOAIHOADON ='TU'and
      (TRANGTHAI != 'CHUATHUTIEN' and TRANGTHAI != 'DAHOANUNG') and
      BENHAN_ID is not null and
      HUYHOADON = 0 and
      BENHAN_ID = '$BENHAN_ID$' and
      BENHVIEN_ID = '$BENHVIEN_ID$'
    </statement>
    <statement id="DAO00064_GetThongTinBenhAnCapcuuTamUng" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      SELECT *, 1 as CHON
      FROM TT_HOADON WHERE
      LOAIHOADON ='TU'and
      (TRANGTHAI != 'CHUATHUTIEN' and TRANGTHAI != 'DAHOANUNG') and
      BENHAN_ID is not null and
      HUYHOADON = 0 and
      TIEPNHAN_ID = '$TIEPNHAN_ID$'
      and BENHAN_ID = (select BENHAN_ID from TT_NOITRU_BENHAN where TIEPNHAN_ID = '$TIEPNHAN_ID$' and right(SOBENHAN,2) = 'CC')
      and BENHVIEN_ID = '$BENHVIEN_ID$'
    </statement>
    <statement id="DAO00064_GetThongTinBenhAnNgoaitruTamUng" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      SELECT *, 1 as CHON
      FROM TT_HOADON
      WHERE      LOAIHOADON ='TU'
      and (TRANGTHAI != 'CHUATHUTIEN' and TRANGTHAI != 'DAHOANUNG')
      and HUYHOADON = 0 and HOANTRA = 0
      and TIEPNHAN_ID = '$TIEPNHAN_ID$'
      and (BENHAN_ID = 0 or BENHAN_ID is null)
      and BENHVIEN_ID = '$BENHVIEN_ID$'
    </statement>
    <statement id="DAO00064_UpdateTinBenhAnCapcuuTamUng" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      update TT_HOADON set BENHAN_ID = '$BENHAN_ID$' where BENHAN_ID in ($LST_BENHAN_CAPCUU_ID$)
      and LOAIHOADON ='TU'and
      (TRANGTHAI != 'CHUATHUTIEN' and TRANGTHAI != 'DAHOANUNG')
    </statement>
    <statement id="DAO00064_UpdateTinBenhAnNgoaitruTamUng" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      update TT_HOADON set BENHAN_ID = '$BENHAN_ID$' where TIEPNHAN_ID in ($LST_BENHAN_TIEPNHAN_ID$)
      and LOAIHOADON ='TU'and
      (TRANGTHAI != 'CHUATHUTIEN' and TRANGTHAI != 'DAHOANUNG')
      and (BENHAN_ID = 0 or BENHAN_ID is null)
    </statement>
    <!--============================================================================
//CAP NHAT DOI TUONG/GIA
//===========================================================================-->
    <statement id="DAO00064_GetDOITUONG" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      SELECT TOP 1
      DT.TENDOITUONG,
      BHYT.SOTHE,
      BHYT.NGAYHIEULUC,
      BHYT.NGAYHETHIEULUC,
      BHYT.BENHVIEN_KCB_ID AS MABENHVIEN,
      BV.TENBENHVIEN,
      BHYT.NGAYMIENDONGCHITRA,
      BHYT.TREN5NAM

      FROM TT_BENHNHAN_BHYT BHYT, TM_DOITUONG DT, TM_BENHVIEN BV
      WHERE
      DT.NHOMTHE LIKE '%' + LEFT(BHYT.SOTHE,3) + '%'
      AND BHYT.BENHNHAN_ID = '$BENHNHAN_ID$'
      AND BHYT.BENHVIEN_KCB_ID = BV.MABENHVIEN
      ORDER BY BHYT.NGAYTAO DESC
    </statement>

    <statement id="DAO00064_GetNgayDangKyDichVu" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      SELECT
      DISTINCT CONVERT(date, NGAYTAO) as NGAYCHIPHI
      FROM TT_VIENPHI
      WHERE
      TIEPNHAN_ID = '$TIEPNHAN_ID$'
      <isNotEmpty prepend="and" property="BENHAN_ID">
        BENHAN_ID = '$BENHAN_ID$'
      </isNotEmpty>
      ORDER BY NGAYCHIPHI
    </statement>

    <statement id="DAO00064_GetLoaiGiaDichVu" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      <!--select lg.LOAIGIA_ID, lg.TENLOAIGIA, lg.MALOAIGIA
      from TM_LOAIGIA lg
      inner join LST_DICTIONARY dic on lg.NHOMGIA_ID = dic.DICTIONARY_ID
      where
      lg.TAMNGUNG = 0
      and dic.DICTIONARY_TYPE_CODE = 'NhomGia'
      and lg.MALOAIGIA like 'GiaDichVu%'-->

      select lg.LOAIGIA_ID, lg.TENLOAIGIA, lg.MALOAIGIA
      from TM_LOAIGIA lg
      where
      lg.TAMNGUNG = 0
      and lg.CAPTREN_ID = (select LOAIGIA_ID from TM_LOAIGIA
      where MALOAIGIA = 'GiaDichVu'
      and BENHVIEN_ID = '$BENHVIEN_ID$')
      and lg.BENHVIEN_ID = '$BENHVIEN_ID$'
    </statement>

    <statement id="DAO00064_GetLoaiGiaThuoc" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      <!--select lg.LOAIGIA_ID, lg.TENLOAIGIA, lg.MALOAIGIA, dic.DICTIONARY_CODE
      from TM_LOAIGIA lg
      inner join LST_DICTIONARY dic on lg.NHOMGIA_ID = dic.DICTIONARY_ID
      where
      lg.TAMNGUNG = 0
      and dic.DICTIONARY_TYPE_CODE = 'NhomGia'
      and lg.MALOAIGIA like 'GiaThuoc%'-->

      <!--select lg.LOAIGIA_ID, lg.TENLOAIGIA, lg.MALOAIGIA
      from TM_LOAIGIA lg
      where
      lg.TAMNGUNG = 0
      and lg.CAPTREN_ID = (select LOAIGIA_ID from TM_LOAIGIA
      where MALOAIGIA = 'GiaThuoc'
      and BENHVIEN_ID = '$BENHVIEN_ID$')
      and lg.BENHVIEN_ID = '$BENHVIEN_ID$'-->

      select C.LOAIGIA_ID, C.TENLOAIGIA, C.MALOAIGIA from
      TM_DOITUONG_LOAIGIA A
      inner join TM_LOAIGIA C on A.LOAIGIA_ID = C.LOAIGIA_ID and C.BENHVIEN_ID = '$BENHVIEN_ID$'
      where C.CAPTREN_ID = (select LOAIGIA_ID from TM_LOAIGIA
      where MALOAIGIA = 'GiaThuoc'          and BENHVIEN_ID = '$BENHVIEN_ID$')
      and A.DOITUONG_ID = '$DOITUONG_ID$' and (A.GIAHOTRO = '0')
    </statement>
    <statement id="DAO00064_GetLoaiGiaThuocMKT" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select lg.LOAIGIA_ID, lg.TENLOAIGIA, lg.MALOAIGIA
      from TM_LOAIGIA lg
      where
      lg.TAMNGUNG = 0
      and lg.CAPTREN_ID = (select LOAIGIA_ID from TM_LOAIGIA
      where MALOAIGIA = 'GiaThuoc'
      and BENHVIEN_ID = '$BENHVIEN_ID$')
      and lg.BENHVIEN_ID = '$BENHVIEN_ID$'
    </statement>
    <statement id="DAO00064_GetLoaiGiaGiuong" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      <!--select lg.LOAIGIA_ID, lg.TENLOAIGIA, lg.MALOAIGIA, dic.DICTIONARY_CODE
      from TM_LOAIGIA lg
      inner join LST_DICTIONARY dic on lg.NHOMGIA_ID = dic.DICTIONARY_ID
      where
      lg.TAMNGUNG = 0
      and dic.DICTIONARY_TYPE_CODE = 'NhomGia'
      and lg.MALOAIGIA like 'GiaGiuong%'-->

      <!--select lg.LOAIGIA_ID, lg.TENLOAIGIA, lg.MALOAIGIA
      from TM_LOAIGIA lg
      where
      lg.TAMNGUNG = 0
      and lg.CAPTREN_ID = (select LOAIGIA_ID from TM_LOAIGIA
      where MALOAIGIA = 'GiaGiuong'
      and BENHVIEN_ID = '$BENHVIEN_ID$')
      and lg.BENHVIEN_ID = '$BENHVIEN_ID$'-->

      select C.LOAIGIA_ID, C.TENLOAIGIA, C.MALOAIGIA from
      TM_DOITUONG_LOAIGIA A
      inner join TM_LOAIGIA C on A.LOAIGIA_ID = C.LOAIGIA_ID and C.BENHVIEN_ID = '$BENHVIEN_ID$'
      where C.CAPTREN_ID = (select LOAIGIA_ID from TM_LOAIGIA
      where MALOAIGIA = 'GiaGiuong'          and BENHVIEN_ID = '$BENHVIEN_ID$')
      and A.DOITUONG_ID = '$DOITUONG_ID$' and (A.GIAHOTRO = '0')
    </statement>

    <!--============================================================================
//TT_MIENGIAM
//===========================================================================-->
    <statement id="DAO00064_TT_VIENPHI_GetList" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select distinct a.*, b.TINHTRANG AS TINHTRANG_MG, d.TINHTRANG_BHTN, e.TINHTRANG_MGCT
      , b.MIENGIAMCHITIET_ID, b.GIATRIMIENGIAM, d.GIATRIMIENGIAM_BHTN, e.GIATRIMIENGIAM_CONGTY, e.GIATRIMIENGIAM_CONGTY as GIATRIMIENGIAM_CTCT, f.GIATRIMIENGIAM_THANHVIEN
      , c.DVKEMTHEO, c.DVKEMTHEO_KHACEKIP, isnull(ttnt.PHONGBANRATOA_ID,c.NOIYEUCAU_ID) NOIYEUCAU_ID, c.NOITHUCHIEN_ID, c.DVYEUCAU_ID, c.HUYYEUCAU, c.DANGKY_ID,
      isnull(dv.TENDICHVU, dc.TENDUOCDAYDU) NOIDUNG, isnull(dv.MADICHVU, dc.MADUOC) MADICHVU, dv.NORESULT, dc.DONVITINH, ld.MALOAIDUOC, dc.BHYT DUOC_BHYT, ld.LOAIVATTU_ID, ndv.MANHOMDICHVU,
      dv.BHYT DV_BHYT
      from
      (select VP.*, sbh.SOBHYT as SOBHYT_HUONG
      from TT_VIENPHI VP
      left join TT_TIEPNHAN_SOTHEBHYT sbh on sbh.SOBHYT_HUONG_ID = VP.SOBHYT_HUONG_ID
      where
      ((isnull(VP.GIATRI_BENHNHAN_DATHANHTOAN, 0) = 0 and isnull(VP.DATHANHTOAN, 0) = 0)
      and VP.REF_TABLE != 'TT_MAU_CHUNGTU_CHITIET'
      <isNotEmpty prepend="" property="CAPNHAT_ALL">
        <isEqual prepend="" property="CAPNHAT_ALL" compareValue="True">
          or isnull(VP.GIATRI_BENHNHAN_DATHANHTOAN,0) > 0
        </isEqual>
      </isNotEmpty>
      )
      <isNotEmpty prepend="and" property="TIEPNHAN_ID">
        VP.TIEPNHAN_ID = '$TIEPNHAN_ID$'
      </isNotEmpty>
      <isNotEmpty prepend="and" property="BENHAN_ID">
        VP.BENHAN_ID = '$BENHAN_ID$'
      </isNotEmpty>
      <isNotEmpty prepend="and" property="BENHVIEN_ID">
        VP.BENHVIEN_ID = '$BENHVIEN_ID$'
      </isNotEmpty>
      <isNotEmpty prepend="and" property="LISTDATE">
        CONVERT(date, NGAYTAO) IN ($LISTDATE$)
      </isNotEmpty>
      <!--TT_VIENPHI-->
      )a left join

      <!--TT_MIENGIAM-->
      (
      select VIENPHI_ID, MG.TINHTRANG, MGCT.MIENGIAMCHITIET_ID, Sum(MGCT.GIATRIMIENGIAM) as GIATRIMIENGIAM
      from TT_MIENGIAM MG INNER JOIN TT_MIENGIAM_CHITIET MGCT ON MG.MIENGIAM_ID = MGCT.MIENGIAM_ID
      where MG.TIEPNHAN_ID= '$TIEPNHAN_ID$' and MGCT.REF_TABLE = 'TT_MIENGIAM'
      group by VIENPHI_ID, MG.TINHTRANG, MGCT.MIENGIAMCHITIET_ID
      )b
      on a.VIENPHI_ID = b.VIENPHI_ID

      left join(
      select VIENPHI_ID, MG.TINHTRANG AS TINHTRANG_BHTN, SUM(MGCT.GIATRIMIENGIAM) as GIATRIMIENGIAM_BHTN
      from TT_MIENGIAM_BHTN MG INNER JOIN TT_MIENGIAM_CHITIET MGCT ON MG.MIENGIAM_BHTN_ID = MGCT.MIENGIAM_ID
      where MG.TIEPNHAN_ID= '$TIEPNHAN_ID$' and MGCT.REF_TABLE = 'TT_MIENGIAM_BHTN'
      group by VIENPHI_ID, MG.TINHTRANG
      )d
      on a.VIENPHI_ID = d.VIENPHI_ID

      left join(
      select VIENPHI_ID, MG.TINHTRANG AS TINHTRANG_MGCT, Sum(MGCT.GIATRIMIENGIAM) as GIATRIMIENGIAM_CONGTY
      from TT_MIENGIAM_CONGTY MG INNER JOIN TT_MIENGIAM_CHITIET MGCT ON MG.MIENGIAM_CONGTY_ID = MGCT.MIENGIAM_ID
      where MG.TIEPNHAN_ID= '$TIEPNHAN_ID$' and MGCT.REF_TABLE = 'TT_MIENGIAM_CONGTY'
      group by VIENPHI_ID, MG.TINHTRANG
      )e
      on a.VIENPHI_ID = e.VIENPHI_ID

      left join(
      select VIENPHI_ID, MG.TINHTRANG AS TINHTRANG_MGCT, Sum(MGCT.GIATRIMIENGIAM) as GIATRIMIENGIAM_THANHVIEN
      from TT_MIENGIAM_THANHVIEN MG INNER JOIN TT_MIENGIAM_CHITIET MGCT ON MG.MIENGIAM_THANHVIEN_ID = MGCT.MIENGIAM_ID
      where MG.TIEPNHAN_ID= '$TIEPNHAN_ID$' and MGCT.REF_TABLE = 'TT_MIENGIAM_THANHVIEN'
      group by VIENPHI_ID, MG.TINHTRANG
      )f
      on a.VIENPHI_ID = f.VIENPHI_ID

      left join
      (
      select DVYEUCAU_ID, TRANGTHAI, BHYTDONGTIEN, HUYYEUCAU, DVKEMTHEO, DVKEMTHEO_KHACEKIP, NOIYEUCAU_ID, NOITHUCHIEN_ID, DANGKY_ID from TT_DVYEUCAU
      where TIEPNHAN_ID = '$TIEPNHAN_ID$'
      )c on c.DVYEUCAU_ID = a.REF_ID and a.REF_TABLE = 'TT_DVYEUCAU'
      left join
      (
      select PHONGBANRATOA_ID, TOATHUOC_ID, 'TT_NOITRU_TOATHUOC' REF_TABLE  from TT_NOITRU_TOATHUOC where TIEPNHAN_ID  = '$TIEPNHAN_ID$'
      union
      select PHONGBAN_ID as PHONGBANRATOA_ID, CLSKETQUA_VTYT_ID as TOATHUOC_ID, 'TT_CLSKETQUA_VTYT' REF_TABLE
      from TT_CLSKETQUA_VTYT where exists (select DVYEUCAU_ID from TT_DVYEUCAU where TT_CLSKETQUA_VTYT.DVYEUCAU_ID = DVYEUCAU_ID and TIEPNHAN_ID  = '$TIEPNHAN_ID$')
      union
      select PHONGBAN_ID as PHONGBANRATOA_ID, KHAMBENH_VTYT_ID as TOATHUOC_ID, 'TT_NGOAITRU_KHAMBENH_VTYT' REF_TABLE
      from TT_NGOAITRU_KHAMBENH_VTYT where exists (select DVYEUCAU_ID from TT_DVYEUCAU where TT_NGOAITRU_KHAMBENH_VTYT.DVYEUCAU_ID = DVYEUCAU_ID and  TIEPNHAN_ID  = '$TIEPNHAN_ID$')
      union
      select B.PHONGBANTHUCHIEN_ID as PHONGBANRATOA_ID, PHAUTHUAT_VTYT_ID as TOATHUOC_ID, 'TT_PHAUTHUAT_VTYT' REF_TABLE
      from TT_PHAUTHUAT_VTYT A
      left join TT_PHAUTHUAT B on A.PHAUTHUAT_ID = B.PHAUTHUAT_ID
      where B.TIEPNHAN_ID  = '$TIEPNHAN_ID$'
      union
      select B.PHONGBAN_ID as PHONGBANRATOA_ID, TOATHUOC_ID, 'TT_NGOAITRU_TOATHUOC' REF_TABLE
      from TT_NGOAITRU_TOATHUOC A
      left join TT_NGOAITRU_KHAMBENH B on A.KHAMBENH_ID = B.KHAMBENH_ID
      where B.TIEPNHAN_ID  = '$TIEPNHAN_ID$'
      ) ttnt on ttnt.TOATHUOC_ID = a.REF_ID and a.REF_TABLE = ttnt.REF_TABLE
      left join TM_DUOC dc on A.DUOC_ID = dc.DUOC_ID
      left join TM_LOAIDUOC ld on dc.LOAIDUOC_ID = ld.LOAIDUOC_ID
      left join TM_DICHVU dv on A.DICHVU_ID = dv.DICHVU_ID and A.REF_TABLE = 'TT_DVYEUCAU'
      left join TM_NHOMDICHVU ndv on ndv.NHOMDICHVU_ID = dv.NHOMDICHVU_ID
      where
      c.HUYYEUCAU = '0' or c.HUYYEUCAU is null
    </statement>
    <statement id="DAO00064_TT_VIENPHI_CheckList" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select  a.*, b.TINHTRANG AS TINHTRANG_MG, d.TINHTRANG_BHTN, e.TINHTRANG_MGCT
      <!--, c.BHYTDONGTIEN-->
      , b.MIENGIAMCHITIET_ID, b.GIATRIMIENGIAM, e.GIATRIMIENGIAM_CONGTY, e.GIATRIMIENGIAM_CONGTY as GIATRIMIENGIAM_CTCT, f.GIATRIMIENGIAM_THANHVIEN
      , c.DVKEMTHEO, c.DVKEMTHEO_KHACEKIP, c.NOIYEUCAU_ID, c.NOITHUCHIEN_ID, c.DVYEUCAU_ID, c.HUYYEUCAU

      <!--TT_VIENPHI-->
      from
      (
      select VP.*
      from TT_VIENPHI VP
      where VP.BENHNHAN_PHAITHANHTOAN &gt;= 0
      <isParameterPresent>
        <isNotEmpty prepend="and" property="LIST_VIENPHI">
          VP.VIENPHI_ID in ($LIST_VIENPHI$)
        </isNotEmpty>
        <isNotEmpty prepend="and" property="LIST_BENHNHAN_PHAITHANHTOAN">
          VP.BENHNHAN_PHAITHANHTOAN in ($LIST_BENHNHAN_PHAITHANHTOAN$)
        </isNotEmpty>
        <isNotEmpty prepend="and" property="VIENPHI_ID">
          VP.VIENPHI_ID = '$VIENPHI_ID$'
        </isNotEmpty>
        <isNotEmpty prepend="and" property="TIEPNHAN_ID">
          VP.TIEPNHAN_ID = '$TIEPNHAN_ID$'
        </isNotEmpty>
        <isNotEmpty prepend="and" property="BENHAN_ID">
          VP.BENHAN_ID = '$BENHAN_ID$'
        </isNotEmpty>
        <isNotEmpty prepend="and" property="REF_ID">
          VP.REF_ID = '$REF_ID$'
        </isNotEmpty>
        <isNotEmpty prepend="and" property="REF_TABLE">
          VP.REF_TABLE = '$REF_TABLE$'
        </isNotEmpty>
        <isNotEmpty prepend="and" property="DICHVU_ID">
          VP.DICHVU_ID is NULL
        </isNotEmpty>
        <isNotEmpty prepend="and" property="DUOC_ID">
          (DUOC_ID = '0' or DUOC_ID is NULL)
        </isNotEmpty>
        <isNotEmpty prepend="and" property="LOAI_CHIPHI">
          VP.LOAI_CHIPHI = '$LOAI_CHIPHI$'
        </isNotEmpty>
        <isNotEmpty prepend="and" property="LOAIGIA_ID">
          VP.LOAIGIA_ID = '$LOAIGIA_ID$'
        </isNotEmpty>
        <isNotEmpty prepend="and" property="SOLUONG">
          VP.SOLUONG = '$SOLUONG$'
        </isNotEmpty>
        <isNotEmpty prepend="and" property="DONGIA_DOANHTHU">
          VP.DONGIA_DOANHTHU = '$DONGIA_DOANHTHU$'
        </isNotEmpty>
        <isNotEmpty prepend="and" property="THANHTIEN_DOANHTHU">
          VP.THANHTIEN_DOANHTHU = '$THANHTIEN_DOANHTHU$'
        </isNotEmpty>
        <isNotEmpty prepend="and" property="BHYT_TL">
          VP.BHYT_TL = '$BHYT_TL$'
        </isNotEmpty>
        <isNotEmpty prepend="and" property="BHYT_DONGIA">
          VP.BHYT_DONGIA = '$BHYT_DONGIA$'
        </isNotEmpty>
        <isNotEmpty prepend="and" property="BHYT_THANHTIEN">
          VP.BHYT_THANHTIEN = '$BHYT_THANHTIEN$'
        </isNotEmpty>
        <isNotEmpty prepend="and" property="BHYT_DONGIA_CHITRA">
          VP.BHYT_DONGIA_CHITRA = '$BHYT_DONGIA_CHITRA$'
        </isNotEmpty>
        <isNotEmpty prepend="and" property="BHYT_THANHTIEN_CHITRA">
          VP.BHYT_THANHTIEN_CHITRA = '$BHYT_THANHTIEN_CHITRA$'
        </isNotEmpty>
        <isNotEmpty prepend="and" property="BENHNHAN_PHAITHANHTOAN">
          VP.BENHNHAN_PHAITHANHTOAN = '$BENHNHAN_PHAITHANHTOAN$'
        </isNotEmpty>
        <isNotEmpty prepend="and" property="GIATRI_HOADON">
          VP.GIATRI_HOADON = '$GIATRI_HOADON$'
        </isNotEmpty>
        <isNotEmpty prepend="and" property="GIATRI_HOADON_DATHANHTOAN">
          VP.GIATRI_HOADON_DATHANHTOAN = '$GIATRI_HOADON_DATHANHTOAN$'
        </isNotEmpty>
        <isNotEmpty prepend="and" property="GIATRI_BIENLAI">
          VP.GIATRI_BIENLAI = '$GIATRI_BIENLAI$'
        </isNotEmpty>
        <isNotEmpty prepend="and" property="GIATRI_BIENLAI_DATHANHTOAN">
          VP.GIATRI_BIENLAI_DATHANHTOAN = '$GIATRI_BIENLAI_DATHANHTOAN$'
        </isNotEmpty>
        <isNotEmpty prepend="and" property="GIATRI_BENHNHAN_DATHANHTOAN">
          VP.GIATRI_BENHNHAN_DATHANHTOAN = '$GIATRI_BENHNHAN_DATHANHTOAN$'
        </isNotEmpty>
        <isNotEmpty prepend="and" property="GIATRI_THATTHU">
          VP.GIATRI_THATTHU = '$GIATRI_THATTHU$'
        </isNotEmpty>
        <isNotEmpty prepend="and" property="MIENGIAM_TL">
          VP.MIENGIAM_TL = '$MIENGIAM_TL$'
        </isNotEmpty>
        <isNotEmpty prepend="and" property="MIENGIAM_GIATRI">
          VP.MIENGIAM_GIATRI = '$MIENGIAM_GIATRI$'
        </isNotEmpty>
        <isNotEmpty prepend="and" property="NGANSACH_TL">
          VP.NGANSACH_TL = '$NGANSACH_TL$'
        </isNotEmpty>
        <isNotEmpty prepend="and" property="NGANSACH_GIATRI">
          VP.NGANSACH_GIATRI = '$NGANSACH_GIATRI$'
        </isNotEmpty>
        <isNotEmpty prepend="and" property="TAITRO_TL">
          VP.TAITRO_TL = '$TAITRO_TL$'
        </isNotEmpty>
        <isNotEmpty prepend="and" property="TAITRO_GIATRI">
          VP.TAITRO_GIATRI = '$TAITRO_GIATRI$'
        </isNotEmpty>
        <isNotEmpty prepend="and" property="BHTN_TL">
          VP.BHTN_TL = '$BHTN_TL$'
        </isNotEmpty>
        <isNotEmpty prepend="and" property="BHTN_DONGIA">
          VP.BHTN_DONGIA = '$BHTN_DONGIA$'
        </isNotEmpty>
        <isNotEmpty prepend="and" property="BHTN_THANHTIEN">
          VP.BHTN_THANHTIEN = '$BHTN_THANHTIEN$'
        </isNotEmpty>
        <isNotEmpty prepend="and" property="BHTN_DONGIA_CHITRA">
          VP.BHTN_DONGIA_CHITRA = '$BHTN_DONGIA_CHITRA$'
        </isNotEmpty>
        <isNotEmpty prepend="and" property="BHTN_THANHTIEN_CHITRA">
          VP.BHTN_THANHTIEN_CHITRA = '$BHTN_THANHTIEN_CHITRA$'
        </isNotEmpty>
        <isNotEmpty prepend="and" property="DUOCPHEPTHUCHIEN">
          VP.DUOCPHEPTHUCHIEN = '$DUOCPHEPTHUCHIEN$'
        </isNotEmpty>
        <isNotEmpty prepend="and" property="HUY">
          VP.HUY = '$HUY$'
        </isNotEmpty>
        <isNotEmpty prepend="and" property="DATHANHTOAN">
          VP.DATHANHTOAN = '$DATHANHTOAN$'
        </isNotEmpty>
        <isNotEmpty prepend="and" property="DATHUCHIEN">
          VP.DATHUCHIEN = '$DATHUCHIEN$'
        </isNotEmpty>
        <isNotEmpty prepend="and" property="KHONGTHUTIEN">
          VP.KHONGTHUTIEN = '$KHONGTHUTIEN$'
        </isNotEmpty>
        <isNotEmpty prepend="and" property="HOADON_ID">
          VP.HOADON_ID = '$HOADON_ID$'
        </isNotEmpty>
        <isNotEmpty prepend="and" property="ACTIVE">
          VP.ACTIVE = '$ACTIVE$'
        </isNotEmpty>
        <isNotEmpty prepend="and" property="BENHVIEN_ID">
          VP.BENHVIEN_ID = '$BENHVIEN_ID$'
        </isNotEmpty>
        <isNotEmpty prepend="and" property="NGUOITAO_ID">
          VP.NGUOITAO_ID = '$NGUOITAO_ID$'
        </isNotEmpty>
        <isNotEmpty prepend="and" property="NGAYTAO">
          VP.NGAYTAO = '$NGAYTAO$'
        </isNotEmpty>
        <isNotEmpty prepend="and" property="NGUOICAPNHAT_ID">
          VP.NGUOICAPNHAT_ID = '$NGUOICAPNHAT_ID$'
        </isNotEmpty>
        <isNotEmpty prepend="and" property="NGAYCAPNHAT">
          VP.NGAYCAPNHAT = '$NGAYCAPNHAT$'
        </isNotEmpty>
        <isNotEmpty prepend="and" property="LISTDATE">
          CONVERT(date, NGAYTAO) IN ($LISTDATE$)
        </isNotEmpty>
      </isParameterPresent>
      <!--TT_VIENPHI-->
      )a left join

      <!--TT_MIENGIAM-->
      (
      select VIENPHI_ID, MG.TINHTRANG, MGCT.MIENGIAMCHITIET_ID, MGCT.GIATRIMIENGIAM
      from TT_MIENGIAM MG INNER JOIN TT_MIENGIAM_CHITIET MGCT ON MG.MIENGIAM_ID = MGCT.MIENGIAM_ID
      where
      MG.TIEPNHAN_ID= '$TIEPNHAN_ID$' and MGCT.REF_TABLE = 'TT_MIENGIAM'
      <isParameterPresent>
        <isNotEmpty prepend="and" property="TINHTRANG">
          MG.TINHTRANG = '$TINHTRANG$'
        </isNotEmpty>
      </isParameterPresent>
      )b
      on a.VIENPHI_ID = b.VIENPHI_ID

      left join
      (
      select VIENPHI_ID, MG.TINHTRANG AS TINHTRANG_BHTN
      from TT_MIENGIAM_BHTN MG INNER JOIN TT_MIENGIAM_CHITIET MGCT ON MG.MIENGIAM_BHTN_ID = MGCT.MIENGIAM_ID
      where
      MG.TIEPNHAN_ID= '$TIEPNHAN_ID$' and MGCT.REF_TABLE = 'TT_MIENGIAM_BHTN'
      <isParameterPresent>
        <isNotEmpty prepend="and" property="TINHTRANG">
          MG.TINHTRANG = '$TINHTRANG$'
        </isNotEmpty>
      </isParameterPresent>
      )d
      on a.VIENPHI_ID = d.VIENPHI_ID

      left join
      (
      select VIENPHI_ID, MG.TINHTRANG AS TINHTRANG_MGCT, MGCT.GIATRIMIENGIAM as GIATRIMIENGIAM_CONGTY
      from TT_MIENGIAM_CONGTY MG INNER JOIN TT_MIENGIAM_CHITIET MGCT ON MG.MIENGIAM_CONGTY_ID = MGCT.MIENGIAM_ID
      where
      MG.TIEPNHAN_ID= '$TIEPNHAN_ID$' and MGCT.REF_TABLE = 'TT_MIENGIAM_CONGTY'
      <isParameterPresent>
        <isNotEmpty prepend="and" property="TINHTRANG">
          MG.TINHTRANG = '$TINHTRANG$'
        </isNotEmpty>
      </isParameterPresent>
      )e
      on a.VIENPHI_ID = e.VIENPHI_ID

      left join
      (
      select VIENPHI_ID, MG.TINHTRANG AS TINHTRANG_MGCT, MGCT.GIATRIMIENGIAM as GIATRIMIENGIAM_THANHVIEN
      from TT_MIENGIAM_THANHVIEN MG INNER JOIN TT_MIENGIAM_CHITIET MGCT ON MG.MIENGIAM_THANHVIEN_ID = MGCT.MIENGIAM_ID
      where
      MG.TIEPNHAN_ID= '$TIEPNHAN_ID$' and MGCT.REF_TABLE = 'TT_MIENGIAM_THANHVIEN'
      <isParameterPresent>
        <isNotEmpty prepend="and" property="TINHTRANG">
          MG.TINHTRANG = '$TINHTRANG$'
        </isNotEmpty>
      </isParameterPresent>
      )f
      on a.VIENPHI_ID = f.VIENPHI_ID

      left join
      (
      select DVYEUCAU_ID, TRANGTHAI, BHYTDONGTIEN, HUYYEUCAU, DVKEMTHEO, DVKEMTHEO_KHACEKIP, NOIYEUCAU_ID, NOITHUCHIEN_ID from TT_DVYEUCAU
      <dynamic prepend="where">
        <isParameterPresent>
          <isNotEmpty prepend="and" property="TIEPNHAN_ID">
            TIEPNHAN_ID = '$TIEPNHAN_ID$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="HUYYEUCAU">
            HUYYEUCAU = '$HUYYEUCAU$'
          </isNotEmpty>
        </isParameterPresent>
      </dynamic>
      )c on c.DVYEUCAU_ID = a.REF_ID
      <dynamic prepend="where">
        <isParameterPresent>
          <isNotEmpty property="HUYYEUCAU">
            c.HUYYEUCAU = '$HUYYEUCAU$' or c.HUYYEUCAU is null
          </isNotEmpty>
        </isParameterPresent>
      </dynamic>
    </statement>

    <statement id="DAO00064_TT_MIENGIAM_GetAll" resultClass="DataObject">
      select *
      from TT_MIENGIAM
      order by MIENGIAM_ID
    </statement>
    <statement id="DAO00064_TT_MIENGIAM_GetList" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select *
      from TT_MIENGIAM
      <dynamic prepend="where">
        <isParameterPresent>
          <isNotEmpty prepend="and" property="MIENGIAM_ID">
            TT_MIENGIAM.MIENGIAM_ID = '$MIENGIAM_ID$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="MAMIENGIAM">
            TT_MIENGIAM.MAMIENGIAM = '$MAMIENGIAM$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="SOPHIEUMIENGIAM">
            TT_MIENGIAM.SOPHIEUMIENGIAM = '$SOPHIEUMIENGIAM$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="TIEPNHAN_ID">
            TT_MIENGIAM.TIEPNHAN_ID = '$TIEPNHAN_ID$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="BENHAN_ID">
            TT_MIENGIAM.BENHAN_ID = '$BENHAN_ID$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="BENHNHAN_ID">
            TT_MIENGIAM.BENHNHAN_ID = '$BENHNHAN_ID$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="TYLEMIENGIAM">
            TT_MIENGIAM.TYLEMIENGIAM = '$TYLEMIENGIAM$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="GIATRIMIENGIAM">
            TT_MIENGIAM.GIATRIMIENGIAM = '$GIATRIMIENGIAM$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="LYDO_ID">
            TT_MIENGIAM.LYDO_ID = '$LYDO_ID$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="NGAYLAP">
            TT_MIENGIAM.NGAYLAP = '$NGAYLAP$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="NGUOIDUYET_ID">
            TT_MIENGIAM.NGUOIDUYET_ID = '$NGUOIDUYET_ID$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="GHICHU">
            TT_MIENGIAM.GHICHU = '$GHICHU$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="TINHTRANG">
            TT_MIENGIAM.TINHTRANG = '$TINHTRANG$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="BENHVIEN_ID">
            TT_MIENGIAM.BENHVIEN_ID = '$BENHVIEN_ID$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="NGUOITAO_ID">
            TT_MIENGIAM.NGUOITAO_ID = '$NGUOITAO_ID$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="NGAYTAO">
            TT_MIENGIAM.NGAYTAO = '$NGAYTAO$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="NGUOICAPNHAT_ID">
            TT_MIENGIAM.NGUOICAPNHAT_ID = '$NGUOICAPNHAT_ID$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="NGAYCAPNHAT">
            TT_MIENGIAM.NGAYCAPNHAT = '$NGAYCAPNHAT$'
          </isNotEmpty>
        </isParameterPresent>
      </dynamic>
      order by MIENGIAM_ID
    </statement>

    <statement id="DAO00064_TT_MIENGIAM_CONGTY_GetList" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select *
      from TT_MIENGIAM_CONGTY
      <dynamic prepend="where">
        <isParameterPresent>
          <isNotEmpty prepend="and" property="MIENGIAM_ID">
            TT_MIENGIAM_CONGTY.MIENGIAM_CONGTY_ID = '$MIENGIAM_ID$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="MAMIENGIAM">
            TT_MIENGIAM_CONGTY.MAMIENGIAM = '$MAMIENGIAM$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="SOPHIEUMIENGIAM">
            TT_MIENGIAM_CONGTY.SOPHIEUMIENGIAM = '$SOPHIEUMIENGIAM$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="TIEPNHAN_ID">
            TT_MIENGIAM_CONGTY.TIEPNHAN_ID = '$TIEPNHAN_ID$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="BENHAN_ID">
            TT_MIENGIAM_CONGTY.BENHAN_ID = '$BENHAN_ID$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="BENHNHAN_ID">
            TT_MIENGIAM_CONGTY.BENHNHAN_ID = '$BENHNHAN_ID$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="TYLEMIENGIAM">
            TT_MIENGIAM_CONGTY.TYLEMIENGIAM = '$TYLEMIENGIAM$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="GIATRIMIENGIAM">
            TT_MIENGIAM_CONGTY.GIATRIMIENGIAM = '$GIATRIMIENGIAM$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="CONGTY_CHITRA_ID">
            TT_MIENGIAM_CONGTY.CONGTYCHITRA_ID = '$CONGTY_CHITRA_ID$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="NGAYLAP">
            TT_MIENGIAM_CONGTY.NGAYLAP = '$NGAYLAP$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="NGUOIDUYET_ID">
            TT_MIENGIAM_CONGTY.NGUOIDUYET_ID = '$NGUOIDUYET_ID$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="GHICHU">
            TT_MIENGIAM_CONGTY.GHICHU = '$GHICHU$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="TINHTRANG">
            TT_MIENGIAM_CONGTY.TINHTRANG = '$TINHTRANG$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="BENHVIEN_ID">
            TT_MIENGIAM_CONGTY.BENHVIEN_ID = '$BENHVIEN_ID$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="NGUOITAO_ID">
            TT_MIENGIAM_CONGTY.NGUOITAO_ID = '$NGUOITAO_ID$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="NGAYTAO">
            TT_MIENGIAM_CONGTY.NGAYTAO = '$NGAYTAO$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="NGUOICAPNHAT_ID">
            TT_MIENGIAM_CONGTY.NGUOICAPNHAT_ID = '$NGUOICAPNHAT_ID$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="NGAYCAPNHAT">
            TT_MIENGIAM_CONGTY.NGAYCAPNHAT = '$NGAYCAPNHAT$'
          </isNotEmpty>
        </isParameterPresent>
      </dynamic>
      order by MIENGIAM_CONGTY_ID
    </statement>


    <statement id="DAO00064_TT_MIENGIAM_SearchDetail" parameterClass="System.Collections.IDictionary" resultClass="DataObject">

      select MG.*
      , TN.SOTIEPNHAN, BA.SOBENHAN, BN.TENBENHNHAN, a.TINHTRANG_TEXT, BN.MAYTE
      , CASE ISNULL(BN.NGAYSINH,'')
      WHEN '' THEN CONVERT(VARCHAR(10), BN.NAMSINH)
      ELSE CONVERT(VARCHAR(10), BN.NGAYSINH, 103)
      END AS NAMSINH
      , vp.DATHUCHIEN, gt.DESCRIPTION as GIOITINH
      from TT_MIENGIAM MG
      left join TT_TIEPNHAN TN on TN.TIEPNHAN_ID = MG.TIEPNHAN_ID
      left join TT_MIENGIAM_CHITIET mgct on mgct.MIENGIAM_ID = mg.MIENGIAM_ID
      left join TT_NOITRU_BENHAN BA on BA.BENHAN_ID = MG.BENHAN_ID
      left join TT_BENHNHAN BN on BN.BENHNHAN_ID = MG.BENHNHAN_ID
      left join TM_GENDER gt on gt.ID = bn.GIOITINH
      left join TT_VIENPHI vp on vp.VIENPHI_ID = MGct.VIENPHI_ID and vp.TIEPNHAN_ID = mg.TIEPNHAN_ID and vp.HUY=0
      LEFT JOIN
      (
      select MIENGIAM_ID, N'đã thanh tóan' as TINHTRANG_TEXT from TT_MIENGIAM mg
      where mg.MIENGIAM_ID in (
      select  MIENGIAM_ID from TT_MIENGIAM_CHITIET mgct
      left join TT_VIENPHI vp on vp.VIENPHI_ID = mgct.VIENPHI_ID
      where vp.DATHANHTOAN = '1')

      union all

      select MIENGIAM_ID, N'chưa thanh tóan' as TINHTRANG_TEXT from TT_MIENGIAM mg
      where mg.MIENGIAM_ID not in (
      select MIENGIAM_ID from TT_MIENGIAM_CHITIET mgct
      left join TT_VIENPHI vp on vp.VIENPHI_ID = mgct.VIENPHI_ID
      where vp.DATHANHTOAN = '1')

      )a ON A.MIENGIAM_ID = MG.MIENGIAM_ID
      <dynamic prepend="where">
        <isParameterPresent>
          <isNotEmpty prepend="and" property="MAMIENGIAM">
            MG.MAMIENGIAM like '%' + #MAMIENGIAM# + '%'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="USER_ID">
            (MG.NGUOIDUYET_ID = '$USER_ID$' or MG.NGUOITAO_ID = '$USER_ID$')
          </isNotEmpty>
          <isNotEmpty prepend="and" property="BENHVIEN_ID">
            MG.BENHVIEN_ID = '$BENHVIEN_ID$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="TINHTRANG">
            MG.TINHTRANG = '$TINHTRANG$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="BENHNHAN_ID">
            TN.BENHNHAN_ID = '$BENHNHAN_ID$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="TUNGAY">
            convert(date, MG.NGAYLAP) between convert(date, '$TUNGAY$') and convert(date, '$DENNGAY$')
          </isNotEmpty>

        </isParameterPresent>
      </dynamic>
      order by MG.MIENGIAM_ID DESC
    </statement>

    <statement id="DAO00064_TT_MIENGIAM_Search" parameterClass="System.Collections.IDictionary" resultClass="DataObject">

      select MG.*
      , TN.SOTIEPNHAN, BA.SOBENHAN, BN.TENBENHNHAN, BN.MAYTE
      , CASE ISNULL(BN.NGAYSINH,'')
      WHEN '' THEN CONVERT(VARCHAR(10), BN.NAMSINH)
      ELSE CONVERT(VARCHAR(10), BN.NGAYSINH, 103)
      END AS NAMSINH
      ,gt.DESCRIPTION as GIOITINH
      from TT_MIENGIAM MG
      left join TT_TIEPNHAN TN on TN.TIEPNHAN_ID = MG.TIEPNHAN_ID
      <!--left join TT_MIENGIAM_CHITIET mgct on mgct.MIENGIAM_ID = mg.MIENGIAM_ID-->
      left join TT_NOITRU_BENHAN BA on BA.BENHAN_ID = MG.BENHAN_ID
      left join TT_BENHNHAN BN on BN.BENHNHAN_ID = MG.BENHNHAN_ID
      left join TM_GENDER gt on gt.ID = bn.GIOITINH
      <!--left join TT_VIENPHI vp on vp.VIENPHI_ID = MGct.VIENPHI_ID and vp.TIEPNHAN_ID = mg.TIEPNHAN_ID and vp.HUY=0-->

      <dynamic prepend="where">
        <isParameterPresent>
          <isNotEmpty prepend="and" property="MAMG">
            MG.MAMIENGIAM like '%' + #MAMG# + '%'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="TUKHOA">
            (BN.TENBENHNHAN like '%' + #TUKHOA# + '%' or BN.MAYTE like '%' + #TUKHOA# + '%')
          </isNotEmpty>
          <isNotEmpty prepend="and" property="MAMIENGIAM">
            (MG.MAMIENGIAM like '%' + #MAMIENGIAM# + '%' or BN.TENBENHNHAN like '%' + #TUKHOA# + '%' or BN.MAYTE like '%' + #TUKHOA# + '%')
          </isNotEmpty>
          <isNotEmpty prepend="and" property="USER_ID">
            (MG.NGUOIDUYET_ID = '$USER_ID$' or MG.NGUOITAO_ID = '$USER_ID$')
          </isNotEmpty>
          <isNotEmpty prepend="and" property="BENHVIEN_ID">
            MG.BENHVIEN_ID = '$BENHVIEN_ID$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="TINHTRANG">
            MG.TINHTRANG = '$TINHTRANG$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="BENHNHAN_ID">
            TN.BENHNHAN_ID = '$BENHNHAN_ID$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="TUNGAY">
            convert(date, MG.NGAYLAP) between convert(date, '$TUNGAY$') and convert(date, '$DENNGAY$')
          </isNotEmpty>

        </isParameterPresent>
      </dynamic>
      order by MG.MIENGIAM_ID DESC
    </statement>

    <statement id="DAO00064_TT_MIENGIAM_CONGTY_Search" parameterClass="System.Collections.IDictionary" resultClass="DataObject">

      select MG.*
      , TN.SOTIEPNHAN, BA.SOBENHAN, BN.TENBENHNHAN, BN.MAYTE
      , CASE ISNULL(BN.NGAYSINH,'')
      WHEN '' THEN CONVERT(VARCHAR(10), BN.NAMSINH)
      ELSE CONVERT(VARCHAR(10), BN.NGAYSINH, 103)
      END AS NAMSINH
      ,gt.DESCRIPTION as GIOITINH
      from TT_MIENGIAM_CONGTY MG
      left join TT_TIEPNHAN TN on TN.TIEPNHAN_ID = MG.TIEPNHAN_ID
      <!--left join TT_MIENGIAM_CHITIET mgct on mgct.MIENGIAM_ID = mg.MIENGIAM_ID-->
      left join TT_NOITRU_BENHAN BA on BA.BENHAN_ID = MG.BENHAN_ID
      left join TT_BENHNHAN BN on BN.BENHNHAN_ID = MG.BENHNHAN_ID
      left join TM_GENDER gt on gt.ID = bn.GIOITINH
      <!--left join TT_VIENPHI vp on vp.VIENPHI_ID = MGct.VIENPHI_ID and vp.TIEPNHAN_ID = mg.TIEPNHAN_ID and vp.HUY=0-->

      <dynamic prepend="where">
        <isParameterPresent>
          <isNotEmpty prepend="and" property="MAMG">
            MG.MAMIENGIAM like '%' + #MAMG# + '%'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="TUKHOA">
            (BN.TENBENHNHAN like '%' + #TUKHOA# + '%' or BN.MAYTE like '%' + #TUKHOA# + '%')
          </isNotEmpty>
          <isNotEmpty prepend="and" property="MAMIENGIAM">
            MG.MAMIENGIAM like '%' + #MAMIENGIAM# + '%'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="USER_ID">
            (MG.NGUOIDUYET_ID = '$USER_ID$' or MG.NGUOITAO_ID = '$USER_ID$')
          </isNotEmpty>
          <isNotEmpty prepend="and" property="BENHVIEN_ID">
            MG.BENHVIEN_ID = '$BENHVIEN_ID$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="TINHTRANG">
            MG.TINHTRANG = '$TINHTRANG$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="BENHNHAN_ID">
            TN.BENHNHAN_ID = '$BENHNHAN_ID$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="TUNGAY">
            convert(date, MG.NGAYLAP) between convert(date, '$TUNGAY$') and convert(date, '$DENNGAY$')
          </isNotEmpty>

        </isParameterPresent>
      </dynamic>
      order by MG.MIENGIAM_CONGTY_ID DESC
    </statement>

    <statement id="DAO00064_TT_MIENGIAM_GetDetail" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select mg.*, ba.SOBENHAN
      from TT_MIENGIAM mg
      left join TT_NOITRU_BENHAN ba on ba.BENHAN_ID = mg.BENHAN_ID
      where mg.MIENGIAM_ID  = '$MIENGIAM_ID$'
    </statement>
    <statement id="DAO00064_TT_MIENGIAM_CONGTY_GetDetail" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select mg.*, ba.SOBENHAN
      from TT_MIENGIAM_CONGTY mg
      left join TT_NOITRU_BENHAN ba on ba.BENHAN_ID = mg.BENHAN_ID
      where mg.MIENGIAM_CONGTY_ID  = '$MIENGIAM_ID$'
    </statement>
    <statement id="DAO00064_TT_MIENGIAM_GetDetailP" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select *
      from TT_MIENGIAM
      where TT_MIENGIAM.MIENGIAM_ID  = '$MIENGIAM_ID$'
      order by MIENGIAM_ID
    </statement>
    <statement id="DAO00064_TT_MIENGIAM_Add" parameterClass="System.Collections.IDictionary" resultClass="System.Int64">
      insert into TT_MIENGIAM (
      MAMIENGIAM
      , SOPHIEUMIENGIAM
      , TIEPNHAN_ID
      , BENHAN_ID
      , BENHNHAN_ID
      , TYLEMIENGIAM
      , GIATRIMIENGIAM
      , LYDO_ID
      , NGAYLAP
      , NGUOIDUYET_ID
      , GHICHU
      , TINHTRANG
      , BENHVIEN_ID
      , NGUOITAO_ID
      , NGAYTAO
      , NGUOICAPNHAT_ID
      , NGAYCAPNHAT
      ) values (
      #MAMIENGIAM#
      , #SOPHIEUMIENGIAM#
      , #TIEPNHAN_ID#
      , #BENHAN_ID#
      , #BENHNHAN_ID#
      , #TYLEMIENGIAM#
      , #GIATRIMIENGIAM#
      , #LYDO_ID#
      , #NGAYLAP#
      , #NGUOIDUYET_ID#
      , #GHICHU#
      , #TINHTRANG#
      , #BENHVIEN_ID#
      , #NGUOITAO_ID#
      , #NGAYTAO#
      , #NGUOICAPNHAT_ID#
      , #NGAYCAPNHAT#
      )
      SELECT SCOPE_IDENTITY()
      <!--<selectKey resultClass="System.Int64" type="post" >
        SELECT @@IDENTITY as value
      </selectKey>-->
    </statement>

    <statement id="DAO00064_TT_MIENGIAM_CONGTY_Add" parameterClass="System.Collections.IDictionary" resultClass="System.Int64">
      insert into TT_MIENGIAM_CONGTY (
      MAMIENGIAM
      , SOPHIEUMIENGIAM
      , TIEPNHAN_ID
      , BENHAN_ID
      , BENHNHAN_ID
      , TYLEMIENGIAM
      , GIATRIMIENGIAM
      , CONGTYCHITRA_ID
      , NGAYLAP
      , NGUOIDUYET_ID
      , GHICHU
      , TINHTRANG
      , BENHVIEN_ID
      , NGUOITAO_ID
      , NGAYTAO
      , NGUOICAPNHAT_ID
      , NGAYCAPNHAT
      ) values (
      #MAMIENGIAM#
      , #SOPHIEUMIENGIAM#
      , #TIEPNHAN_ID#
      , #BENHAN_ID#
      , #BENHNHAN_ID#
      , #TYLEMIENGIAM#
      , #GIATRIMIENGIAM#
      , #CONGTY_CHITRA_ID#
      , #NGAYLAP#
      , #NGUOIDUYET_ID#
      , #GHICHU#
      , #TINHTRANG#
      , #BENHVIEN_ID#
      , #NGUOITAO_ID#
      , #NGAYTAO#
      , #NGUOICAPNHAT_ID#
      , #NGAYCAPNHAT#
      )
      SELECT SCOPE_IDENTITY()
      <!--<selectKey resultClass="System.Int64" type="post" >
        SELECT @@IDENTITY as value
      </selectKey>-->
    </statement>

    <statement id="DAO00064_TT_MIENGIAM_AddTransaction" parameterClass="System.Collections.IDictionary">
      SET TRANSACTION ISOLATION LEVEL READ COMMITTED;
      IF(SELECT COUNT(*)
      FROM TT_VIENPHI
      WHERE
      REF_TABLE = '$REF_TABLE$'
      AND (DICHVU_ID IN ($LIST_DICHVU$) OR DUOC_ID IN ($LIST_DUOC$))
      AND VIENPHI_ID IN ($LIST_VIENPHI$)) = 0
      BEGIN
      BEGIN TRY
      BEGIN TRANSACTION
      UPDATE TT_VIENPHI
      SET REF_TABLE = '$REF_TABLE$'
      WHERE
      (DICHVU_ID IN ($LIST_DICHVU$) OR DUOC_ID IN ($LIST_DUOC$))
      AND VIENPHI_ID IN ($LIST_VIENPHI$)
      SELECT 1 AS RESULT
      COMMIT TRANSACTION
      END TRY

      BEGIN CATCH
      IF @@TRANCOUNT > 0
      ROLLBACK TRANSACTION
      SELECT -1 AS RESULT
      END CATCH
      END
      ELSE
      SELECT 0 AS RESULT
    </statement>

    <update id="DAO00064_TT_MIENGIAM_Update" parameterClass="System.Collections.IDictionary">
      update TT_MIENGIAM set
      MAMIENGIAM = #MAMIENGIAM#
      , SOPHIEUMIENGIAM = #SOPHIEUMIENGIAM#
      , TIEPNHAN_ID = #TIEPNHAN_ID#
      , BENHAN_ID = #BENHAN_ID#
      , BENHNHAN_ID = #BENHNHAN_ID#
      , TYLEMIENGIAM = #TYLEMIENGIAM#
      , GIATRIMIENGIAM = #GIATRIMIENGIAM#
      , LYDO_ID = #LYDO_ID#
      , NGAYLAP = #NGAYLAP#
      , NGUOIDUYET_ID = #NGUOIDUYET_ID#
      , GHICHU = #GHICHU#
      , TINHTRANG = #TINHTRANG#
      <!--, BENHVIEN_ID = #BENHVIEN_ID#
      , NGUOITAO_ID = #NGUOITAO_ID#
      , NGAYTAO = #NGAYTAO#-->
      , NGUOICAPNHAT_ID = #NGUOICAPNHAT_ID#
      , NGAYCAPNHAT = #NGAYCAPNHAT#
      where
      MIENGIAM_ID = '$MIENGIAM_ID$'
    </update>

    <update id="DAO00064_TT_MIENGIAM_CONGTY_Update" parameterClass="System.Collections.IDictionary">
      update TT_MIENGIAM_CONGTY set
      MAMIENGIAM = #MAMIENGIAM#
      , SOPHIEUMIENGIAM = #SOPHIEUMIENGIAM#
      , TIEPNHAN_ID = #TIEPNHAN_ID#
      , BENHAN_ID = #BENHAN_ID#
      , BENHNHAN_ID = #BENHNHAN_ID#
      , TYLEMIENGIAM = #TYLEMIENGIAM#
      , GIATRIMIENGIAM = #GIATRIMIENGIAM#
      , CONGTYCHITRA_ID = #CONGTY_CHITRA_ID#
      , NGAYLAP = #NGAYLAP#
      , NGUOIDUYET_ID = #NGUOIDUYET_ID#
      , GHICHU = #GHICHU#
      , TINHTRANG = #TINHTRANG#
      <!--, BENHVIEN_ID = #BENHVIEN_ID#
      , NGUOITAO_ID = #NGUOITAO_ID#
      , NGAYTAO = #NGAYTAO#-->
      , NGUOICAPNHAT_ID = #NGUOICAPNHAT_ID#
      , NGAYCAPNHAT = #NGAYCAPNHAT#
      where
      MIENGIAM_CONGTY_ID = '$MIENGIAM_ID$'
    </update>

    <update id="DAO00064_TT_MIENGIAM_Approve" parameterClass="System.Collections.IDictionary">
      update TT_MIENGIAM set
      MAMIENGIAM = #MAMIENGIAM#
      , SOPHIEUMIENGIAM = #SOPHIEUMIENGIAM#
      , TIEPNHAN_ID = #TIEPNHAN_ID#
      , BENHAN_ID = #BENHAN_ID#
      , BENHNHAN_ID = #BENHNHAN_ID#
      , TYLEMIENGIAM = #TYLEMIENGIAM#
      , GIATRIMIENGIAM = #GIATRIMIENGIAM#
      , LYDO_ID = #LYDO_ID#
      , NGAYLAP = #NGAYLAP#
      , NGUOIDUYET_ID = #NGUOIDUYET_ID#
      , GHICHU = #GHICHU#
      , TINHTRANG = #TINHTRANG#
      <!--, BENHVIEN_ID = #BENHVIEN_ID#
      , NGUOITAO_ID = #NGUOITAO_ID#
      , NGAYTAO = #NGAYTAO#-->
      , NGUOICAPNHAT_ID = #NGUOICAPNHAT_ID#
      , NGAYCAPNHAT = #NGAYCAPNHAT#
      where
      MIENGIAM_ID = '$MIENGIAM_ID$'
    </update>

    <update id="DAO00064_TT_MIENGIAM_CONGTY_Approve" parameterClass="System.Collections.IDictionary">
      update TT_MIENGIAM_CONGTY set
      MAMIENGIAM = #MAMIENGIAM#
      , SOPHIEUMIENGIAM = #SOPHIEUMIENGIAM#
      , TIEPNHAN_ID = #TIEPNHAN_ID#
      , BENHAN_ID = #BENHAN_ID#
      , BENHNHAN_ID = #BENHNHAN_ID#
      , TYLEMIENGIAM = #TYLEMIENGIAM#
      , GIATRIMIENGIAM = #GIATRIMIENGIAM#
      <!--, CONGTYCHITRA_ID = #CONGTY_CHITRA_ID#-->
      , NGAYLAP = #NGAYLAP#
      , NGUOIDUYET_ID = #NGUOIDUYET_ID#
      , GHICHU = #GHICHU#
      , TINHTRANG = #TINHTRANG#
      <!--, BENHVIEN_ID = #BENHVIEN_ID#
      , NGUOITAO_ID = #NGUOITAO_ID#
      , NGAYTAO = #NGAYTAO#-->
      , NGUOICAPNHAT_ID = #NGUOICAPNHAT_ID#
      , NGAYCAPNHAT = #NGAYCAPNHAT#
      where
      MIENGIAM_CONGTY_ID = '$MIENGIAM_CONGTY_ID$'
    </update>

    <statement id="DAO00064_TT_MIENGIAM_Delete" parameterClass="System.Collections.IDictionary" resultClass="System.Int32">
      delete from TT_MIENGIAM
      where
      MIENGIAM_ID = '$MIENGIAM_ID$'
    </statement>
    <statement id="DAO00064_TT_MIENGIAM_CONGTY_Delete" parameterClass="System.Collections.IDictionary" resultClass="System.Int32">
      delete from TT_MIENGIAM_CONGTY
      where
      MIENGIAM_CONGTY_ID = '$MIENGIAM_ID$'
    </statement>

    <statement id="DAO00064_TT_MIENGIAM_DeleteP" parameterClass="System.Collections.IDictionary" resultClass="System.Int32">
      delete from TT_MIENGIAM
      <dynamic prepend="where">
        <isParameterPresent>
          <isNotEmpty prepend="and" property="MIENGIAM_ID">
            TT_MIENGIAM.MIENGIAM_ID = '$MIENGIAM_ID$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="MAMIENGIAM">
            TT_MIENGIAM.MAMIENGIAM = '$MAMIENGIAM$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="SOPHIEUMIENGIAM">
            TT_MIENGIAM.SOPHIEUMIENGIAM = '$SOPHIEUMIENGIAM$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="TIEPNHAN_ID">
            TT_MIENGIAM.TIEPNHAN_ID = '$TIEPNHAN_ID$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="BENHAN_ID">
            TT_MIENGIAM.BENHAN_ID = '$BENHAN_ID$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="BENHNHAN_ID">
            TT_MIENGIAM.BENHNHAN_ID = '$BENHNHAN_ID$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="TYLEMIENGIAM">
            TT_MIENGIAM.TYLEMIENGIAM = '$TYLEMIENGIAM$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="GIATRIMIENGIAM">
            TT_MIENGIAM.GIATRIMIENGIAM = '$GIATRIMIENGIAM$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="LYDO_ID">
            TT_MIENGIAM.LYDO_ID = '$LYDO_ID$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="NGAYLAP">
            TT_MIENGIAM.NGAYLAP = '$NGAYLAP$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="NGUOIDUYET_ID">
            TT_MIENGIAM.NGUOIDUYET_ID = '$NGUOIDUYET_ID$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="GHICHU">
            TT_MIENGIAM.GHICHU = '$GHICHU$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="BENHVIEN_ID">
            TT_MIENGIAM.BENHVIEN_ID = '$BENHVIEN_ID$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="NGUOITAO_ID">
            TT_MIENGIAM.NGUOITAO_ID = '$NGUOITAO_ID$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="NGAYTAO">
            TT_MIENGIAM.NGAYTAO = '$NGAYTAO$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="NGUOICAPNHAT_ID">
            TT_MIENGIAM.NGUOICAPNHAT_ID = '$NGUOICAPNHAT_ID$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="NGAYCAPNHAT">
            TT_MIENGIAM.NGAYCAPNHAT = '$NGAYCAPNHAT$'
          </isNotEmpty>
        </isParameterPresent>
      </dynamic>
    </statement>
    <statement id="DAO00064_TT_MIENGIAM_SumTyLeMG_DaDuyet" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      SELECT SUM(TYLEMIENGIAM) AS TYLEMG
      FROM TT_MIENGIAM
      WHERE TIEPNHAN_ID = '$TIEPNHAN_ID$'
      AND BENHVIEN_ID = '$BENHVIEN_ID$' AND TINHTRANG = '$TINHTRANG$'
    </statement>

    <!--============================================================================
//TT_MIENGIAM_CHITIET
//===========================================================================-->
    <statement id="DAO00064_TT_MIENGIAM_CHITIET_GetAll" resultClass="DataObject">
      select *
      from TT_MIENGIAM_CHITIET
      order by MIENGIAMCHITIET_ID
    </statement>

    <!--Get thông tin miễn giảm-->
    <statement id="DAO00064_TT_MIENGIAM_CHITIET_GetList" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select VP.*, MGCT.MIENGIAMCHITIET_ID, MGCT.GIATRIMIENGIAM as GIATRIMIENGIAM_CTCT, MGCT.GIATRISAUMIENGIAM
      from TT_VIENPHI VP
      left join TT_MIENGIAM_CHITIET MGCT on VP.VIENPHI_ID = MGCT.VIENPHI_ID
      <dynamic prepend="where">
        <isParameterPresent>
          <isNotEmpty prepend="and" property="MIENGIAM_ID">
            MGCT.MIENGIAM_ID = '$MIENGIAM_ID$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="REF_TABLE">
            MGCT.REF_TABLE = '$REF_TABLE$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="DATHANHTOAN">
            VP.DATHANHTOAN = '$DATHANHTOAN$'
          </isNotEmpty>
        </isParameterPresent>
      </dynamic>
    </statement>

    <!--Get thông tin miễn giảm công ty-->
    <statement id="DAO00064_TT_MIENGIAM_CHITIET_CONGTY_GetList" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select A.*, B.GIATRIMIENGIAM, C.GIATRIMIENGIAM_THANHVIEN
      from
      (
      select VP.*, MGCT.MIENGIAMCHITIET_ID, MGCT.GIATRIMIENGIAM as GIATRIMIENGIAM_CTCT, MGCT.GIATRISAUMIENGIAM
      from TT_VIENPHI VP
      left join TT_MIENGIAM_CHITIET MGCT on VP.VIENPHI_ID = MGCT.VIENPHI_ID
      <dynamic prepend="where">
        <isParameterPresent>
          <isNotEmpty prepend="and" property="MIENGIAM_ID">
            MGCT.MIENGIAM_ID = '$MIENGIAM_ID$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="REF_TABLE">
            MGCT.REF_TABLE = '$REF_TABLE$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="DATHANHTOAN">
            VP.DATHANHTOAN = '$DATHANHTOAN$'
          </isNotEmpty>
        </isParameterPresent>
      </dynamic>
      )A
      left join
      (
      select VIENPHI_ID, mgct.GIATRIMIENGIAM
      from TT_MIENGIAM MG
      left join TT_MIENGIAM_CHITIET mgct on mgct.MIENGIAM_ID = mg.miengiam_id
      where
      MGCT.REF_TABLE = 'TT_MIENGIAM' and MG.TINHTRANG = 1
      <isParameterPresent>
        <isNotEmpty prepend="and" property="VIENPHI_ID">
          MGCT.VIENPHI_ID = '$VIENPHI_ID$'
        </isNotEmpty>
      </isParameterPresent>

      )B
      on A.VIENPHI_ID = B.VIENPHI_ID

      left join
      (
      select VIENPHI_ID, mgct.GIATRIMIENGIAM as GIATRIMIENGIAM_THANHVIEN
      from TT_MIENGIAM MG
      left join TT_MIENGIAM_CHITIET mgct on mgct.MIENGIAM_ID = mg.miengiam_id
      where
      MGCT.REF_TABLE = 'TT_MIENGIAM_THANHVIEN' and MG.TINHTRANG = 1
      <isParameterPresent>
        <isNotEmpty prepend="and" property="VIENPHI_ID">
          MGCT.VIENPHI_ID = '$VIENPHI_ID$'
        </isNotEmpty>
      </isParameterPresent>

      )C
      on A.VIENPHI_ID = C.VIENPHI_ID

      <!--left join 
      (
      select VIENPHI_ID, mgct.GIATRIMIENGIAM as GIATRIMIENGIAM_THANHVIEN
          from TT_MIENGIAM MG 
	      left join TT_MIENGIAM_CHITIET mgct on mgct.MIENGIAM_ID = mg.miengiam_id
          where
	      MGCT.REF_TABLE = 'TT_MIENGIAM_THANHVIEN' and MG.TINHTRANG = 1
	        <isParameterPresent>
        <isNotEmpty prepend="and" property="VIENPHI_ID">
          MGCT.VIENPHI_ID = '$VIENPHI_ID$'
        </isNotEmpty>       
      </isParameterPresent>

      )D-->
      <!--on A.VIENPHI_ID = D.VIENPHI_ID-->
    </statement>

    <!--Get thông tin miễn giảm-->
    <statement id="DAO00064_TT_MIENGIAM_CHITIET_Detail_GetList" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select A.*, D.GIATRIMIENGIAM_BHTN, e.GIATRIMIENGIAM_CTCT, f.GIATRIMIENGIAM_THANHVIEN
      from
      (
      select VP.*, MGCT.MIENGIAMCHITIET_ID, MGCT.GIATRIMIENGIAM, MGCT.GIATRISAUMIENGIAM
      from TT_VIENPHI VP
      left join TT_MIENGIAM_CHITIET MGCT on VP.VIENPHI_ID = MGCT.VIENPHI_ID
      <dynamic prepend="where">
        <isParameterPresent>
          <isNotEmpty prepend="and" property="MIENGIAM_ID">
            MGCT.MIENGIAM_ID = '$MIENGIAM_ID$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="REF_TABLE">
            MGCT.REF_TABLE = '$REF_TABLE$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="DATHANHTOAN">
            VP.DATHANHTOAN = '$DATHANHTOAN$'
          </isNotEmpty>
        </isParameterPresent>
      </dynamic>
      )A
      left join
      (
      select VIENPHI_ID, MG.TINHTRANG AS TINHTRANG_BHTN, MGCT.GIATRIMIENGIAM as GIATRIMIENGIAM_BHTN
      from TT_MIENGIAM_BHTN MG INNER JOIN TT_MIENGIAM_CHITIET MGCT ON MG.MIENGIAM_BHTN_ID = MGCT.MIENGIAM_ID
      where
      MG.TIEPNHAN_ID= '$TIEPNHAN_ID$' and MGCT.REF_TABLE = 'TT_MIENGIAM_BHTN'
      <isParameterPresent>
        <isNotEmpty prepend="and" property="TINHTRANG">
          MG.TINHTRANG = 1
        </isNotEmpty>
      </isParameterPresent>
      )d
      on a.VIENPHI_ID = d.VIENPHI_ID

      left join
      (
      select VIENPHI_ID, MG.TINHTRANG AS TINHTRANG_MGCT, MGCT.GIATRIMIENGIAM as GIATRIMIENGIAM_CTCT
      from TT_MIENGIAM_CONGTY MG INNER JOIN TT_MIENGIAM_CHITIET MGCT ON MG.MIENGIAM_CONGTY_ID = MGCT.MIENGIAM_ID
      where
      MG.TIEPNHAN_ID= '$TIEPNHAN_ID$' and MGCT.REF_TABLE = 'TT_MIENGIAM_CONGTY'
      <isParameterPresent>
        <isNotEmpty prepend="and" property="TINHTRANG">
          MG.TINHTRANG = 1
        </isNotEmpty>
      </isParameterPresent>
      )e
      on a.VIENPHI_ID = e.VIENPHI_ID

      left join
      (
      select VIENPHI_ID, MG.TINHTRANG AS TINHTRANG_MGCT, MGCT.GIATRIMIENGIAM as GIATRIMIENGIAM_THANHVIEN
      from TT_MIENGIAM_THANHVIEN MG INNER JOIN TT_MIENGIAM_CHITIET MGCT ON MG.MIENGIAM_THANHVIEN_ID = MGCT.MIENGIAM_ID
      where
      MG.TIEPNHAN_ID= '$TIEPNHAN_ID$' and MGCT.REF_TABLE = 'TT_MIENGIAM_THANHVIEN'
      <isParameterPresent>
        <isNotEmpty prepend="and" property="TINHTRANG">
          MG.TINHTRANG = 1
        </isNotEmpty>
      </isParameterPresent>
      )f
      on a.VIENPHI_ID = f.VIENPHI_ID

    </statement>

    <statement id="DAO00064_TT_MIENGIAM_CHITIET_GetDetail" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select *
      from TT_MIENGIAM_CHITIET
      where TT_MIENGIAM_CHITIET.MIENGIAMCHITIET_ID  = '$value$'
      order by MIENGIAMCHITIET_ID
    </statement>
    <statement id="DAO00064_TT_MIENGIAM_CHITIET_GetDetailP" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select *
      from TT_MIENGIAM_CHITIET
      where TT_MIENGIAM_CHITIET.MIENGIAMCHITIET_ID  = '$MIENGIAMCHITIET_ID$'
      order by MIENGIAMCHITIET_ID
    </statement>
    <insert id="DAO00064_TT_MIENGIAM_CHITIET_Add" parameterClass="System.Collections.IDictionary" resultClass="System.Int64">
      insert into TT_MIENGIAM_CHITIET (
      MIENGIAM_ID
      , REF_TABLE
      , VIENPHI_ID
      , TYLEMIENGIAM
      , GIATRIMIENGIAM
      , BENHVIEN_ID
      , NGUOITAO_ID
      , NGAYTAO
      , NGUOICAPNHAT_ID
      , NGAYCAPNHAT
      , GIATRISAUMIENGIAM
      ) values (
      #MIENGIAM_ID#
      , #REF_TABLE#
      , #VIENPHI_ID#
      , #TYLEMIENGIAM#
      , #GIATRIMIENGIAM#
      , #BENHVIEN_ID#
      , #NGUOITAO_ID#
      , #NGAYTAO#
      , #NGUOICAPNHAT_ID#
      , #NGAYCAPNHAT#
      , #GIATRISAUMIENGIAM#
      )
    </insert>

    <update id="DAO00064_TT_MIENGIAM_CHITIET_Update" parameterClass="System.Collections.IDictionary">
      update TT_MIENGIAM_CHITIET set
      MIENGIAM_ID = #MIENGIAM_ID#
      , VIENPHI_ID = #VIENPHI_ID#
      , TYLEMIENGIAM = #TYLEMIENGIAM#
      , GIATRIMIENGIAM = #GIATRIMIENGIAM#
      <!--, BENHVIEN_ID = #BENHVIEN_ID#
      , NGUOITAO_ID = #NGUOITAO_ID#
      , NGAYTAO = #NGAYTAO#-->
      , NGUOICAPNHAT_ID = #NGUOICAPNHAT_ID#
      , NGAYCAPNHAT = #NGAYCAPNHAT#
      , GIATRISAUMIENGIAM = #GIATRISAUMIENGIAM#
      where
      MIENGIAMCHITIET_ID = '$MIENGIAMCHITIET_ID$'
    </update>

    <statement id="DAO00064_TT_MIENGIAM_CHITIET_Delete" parameterClass="System.Collections.IDictionary" resultClass="System.Int32">
      delete from TT_MIENGIAM_CHITIET
      where
      MIENGIAMCHITIET_ID = '$MIENGIAMCHITIET_ID$'
    </statement>

    <statement id="DAO00064_TT_MIENGIAM_CHITIET_DeleteP" parameterClass="System.Collections.IDictionary" resultClass="System.Int32">
      delete from TT_MIENGIAM_CHITIET
      <dynamic prepend="where">
        <isParameterPresent>
          <isNotEmpty prepend="and" property="MIENGIAMCHITIET_ID">
            TT_MIENGIAM_CHITIET.MIENGIAMCHITIET_ID = '$MIENGIAMCHITIET_ID$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="MIENGIAM_ID">
            TT_MIENGIAM_CHITIET.MIENGIAM_ID = '$MIENGIAM_ID$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="VIENPHI_ID">
            TT_MIENGIAM_CHITIET.VIENPHI_ID = '$VIENPHI_ID$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="TYLEMIENGIAM">
            TT_MIENGIAM_CHITIET.TYLEMIENGIAM = '$TYLEMIENGIAM$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="GIATRIMIENGIAM">
            TT_MIENGIAM_CHITIET.GIATRIMIENGIAM = '$GIATRIMIENGIAM$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="BENHVIEN_ID">
            TT_MIENGIAM_CHITIET.BENHVIEN_ID = '$BENHVIEN_ID$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="NGUOITAO_ID">
            TT_MIENGIAM_CHITIET.NGUOITAO_ID = '$NGUOITAO_ID$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="NGAYTAO">
            TT_MIENGIAM_CHITIET.NGAYTAO = '$NGAYTAO$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="NGUOICAPNHAT_ID">
            TT_MIENGIAM_CHITIET.NGUOICAPNHAT_ID = '$NGUOICAPNHAT_ID$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="NGAYCAPNHAT">
            TT_MIENGIAM_CHITIET.NGAYCAPNHAT = '$NGAYCAPNHAT$'
          </isNotEmpty>
        </isParameterPresent>
      </dynamic>
    </statement>

    <statement id="DAO00064_TT_MIENGIAM_DichVu" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select *
      from TT_MIENGIAM mg
      left join TT_MIENGIAM_CHITIET mgct on mgct.MIENGIAM_ID = mg.MIENGIAM_ID
      left join TT_VIENPHI vp on vp.VIENPHI_ID = mgct.VIENPHI_ID
      where mg.TINHTRANG = '$TINHTRANG$'
      <dynamic prepend=" and REF_ID in ">
        <iterate property="REF_ID" open="(" close=")" conjunction=",">
          #REF_ID[]#
        </iterate>
      </dynamic>
    </statement>

    <insert id="DAO00064_TT_BENHNHAN_BHYT_Add" parameterClass="System.Collections.IDictionary" resultClass="System.Int64">
      insert into TT_BENHNHAN_BHYT (
      BENHNHAN_ID
      , LOAIBHYT
      , SOTHE
      , NGAYCAP
      , NGAYHIEULUC
      , NGAYHETHIEULUC
      , TINHTHANH_CAPTHE_ID
      , BENHVIEN_ID
      , BENHVIEN_KCB_ID
      , TREN3NAM
      , TREN5NAM
      , NGAYMIENDONGCHITRA
      , TREN6THANG
      , KHUVUCSONG_ID
      , TAMNGUNG
      , NGAYTAO
      , NGUOITAO_ID
      , NGAYCAPNHAT
      , NGUOICAPNHAT_ID
      ) values (
      #BENHNHAN_ID#
      , #LOAIBHYT#
      , #SOTHE#
      , #NGAYCAP#
      , #NGAYHIEULUC#
      , #NGAYHETHIEULUC#
      , #TINHTHANH_CAPTHE_ID#
      , #BENHVIEN_ID#
      , #BENHVIEN_KCB_ID#
      , #TREN3NAM#
      , #TREN5NAM#
      , #NGAYMIENDONGCHITRA#
      , #TREN6THANG#
      , #KHUVUCSONG_ID#
      , #TAMNGUNG#
      , #NGAYTAO#
      , #NGUOITAO_ID#
      , #NGAYCAPNHAT#
      , #NGUOICAPNHAT_ID#
      )
    </insert>
    <insert id="DAO00064_TT_DOITUONG_THAYDOI_Add" parameterClass="System.Collections.IDictionary" resultClass="System.Int64">
      insert into TT_DOITUONG_THAYDOI (
      BENHNHAN_ID
      ,TIEPNHAN_ID
      ,BENHAN_ID
      ,DOITUONG_ID
      ,SOBHYT
      ,BHYTTUNGAY
      ,BHYTDENNGAY
      ,BHYTTREN3NAM
      ,BHYTTREN5NAM
      ,NGAYMIENDONGCHITRA
      ,OLD_DOITUONG_ID
      ,OLD_SOBHYT
      ,OLD_BHYTTUNGAY
      ,OLD_BHYTDENNGAY
      ,OLD_BHYTTREN3NAM
      ,OLD_BHYTTREN5NAM
      ,OLD_NGAYMIENDONGCHITRA
      ,BENHVIEN_ID
      ,NGAYTAO
      ,NGUOITAO_ID
      ,NGAYCAPNHAT
      ,NGUOICAPNHAT_ID
      ) values (
      #BENHNHAN_ID#
      ,#TIEPNHAN_ID#
      ,#BENHAN_ID#
      ,#DOITUONG_ID#
      ,#SOBHYT#
      ,#BHYTTUNGAY#
      ,#BHYTDENNGAY#
      ,#BHYTTREN3NAM#
      ,#BHYTTREN5NAM#
      ,#NGAYMIENDONGCHITRA#
      ,#OLD_DOITUONG_ID#
      ,#OLD_SOBHYT#
      ,#OLD_BHYTTUNGAY#
      ,#OLD_BHYTDENNGAY#
      ,#OLD_BHYTTREN3NAM#
      ,#OLD_BHYTTREN5NAM#
      ,#OLD_NGAYMIENDONGCHITRA#
      ,#BENHVIEN_ID#
      ,#NGAYTAO#
      ,#NGUOITAO_ID#
      ,#NGAYCAPNHAT#
      ,#NGUOICAPNHAT_ID#
      )
    </insert>
    <insert id="DAO00064_TT_XACNHAN_BHYT_Add" parameterClass="System.Collections.IDictionary" resultClass="System.Int64">
      INSERT INTO [TT_XACNHAN_BHYT]
      ([BENHNHAN_ID]
      ,[TIEPNHAN_ID]
      ,[BENHAN_ID]
      ,[SOBHYT]
      ,[TRANGTHAI_XACNHAN]
      ,[NOITHUCHIEN_ID]
      ,[NGUOITHUCHIEN_ID]
      ,[NGAYTHUCHIEN])
      VALUES
      (#BENHNHAN_ID#
      ,#TIEPNHAN_ID#
      ,#BENHAN_ID#
      ,#SOBHYT#
      ,#TRANGTHAI_XACNHAN#
      ,#NOITHUCHIEN_ID#
      ,#NGUOITHUCHIEN_ID#
      ,#NGAYTHUCHIEN#)
    </insert>
    <update id="DAO00064_TT_BENHNHAN_BHYT_Update" parameterClass="System.Collections.IDictionary">
      update TT_BENHNHAN_BHYT set
      BENHNHAN_ID = #BENHNHAN_ID#
      , LOAIBHYT = #LOAIBHYT#
      , SOTHE = #SOTHE#
      , NGAYCAP = #NGAYCAP#
      , NGAYHIEULUC = #NGAYHIEULUC#
      , NGAYHETHIEULUC = #NGAYHETHIEULUC#
      , TINHTHANH_CAPTHE_ID = #TINHTHANH_CAPTHE_ID#
      , BENHVIEN_ID = #BENHVIEN_ID#
      , BENHVIEN_KCB_ID = #BENHVIEN_KCB_ID#
      , TREN3NAM = #TREN3NAM#
      , TREN5NAM = #TREN5NAM#
      , NGAYMIENDONGCHITRA = #NGAYMIENDONGCHITRA#
      , TREN6THANG = #TREN6THANG#
      , KHUVUCSONG_ID = #KHUVUCSONG_ID#
      , TAMNGUNG = #TAMNGUNG#
      <!--, NGAYTAO = #NGAYTAO#
      , NGUOITAO_ID = #NGUOITAO_ID#-->
      , NGAYCAPNHAT = #NGAYCAPNHAT#
      , NGUOICAPNHAT_ID = #NGUOICAPNHAT_ID#
      where
      BENHNHAN_BHYT_ID = '$BENHNHAN_BHYT_ID$'
    </update>

    <statement id="DAO00064_GetGiaTriMienGiamByVienPhiID" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select CT.GIATRIMIENGIAM
      from TT_MIENGIAM_CHITIET CT
      left join TT_MIENGIAM MG
      on CT.MIENGIAM_ID = MG.MIENGIAM_ID
      where
      VIENPHI_ID = '$VIENPHI_ID$' and
      MG.TINHTRANG = 1
    </statement>

    <statement id="DAO00064_TT_TIEPNHAN_GetHoanThanh" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select *
      from TT_TIEPNHAN
      where
      TIEPNHAN_ID = '$TIEPNHAN_ID$'
      and TRANGTHAI  = 'HOANTHANH'
    </statement>
    <statement id="DAO00064_KiemTraPhongBanKhoaNoi" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select PHONGBAN_ID from TM_PHONGBAN
      where
      LOAIPHONGBAN_ID = (select DICTIONARY_ID from LST_DICTIONARY where DICTIONARY_CODE = 'KhoaNoi')
      and PHONGBAN_ID = '$PHONGBAN_ID$'
      and BENHVIEN_ID = '$BENHVIEN_ID$'
    </statement>
    <statement id="DAO00064_GetListVienPhiByTiepNnan" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select distinct
      B.DOITUONG_ID, B.NGAYMIENDONGCHITRA, B.BENHNHAN_ID as TIEPNHAN_BENHNHAN_ID, B.TRAITUYEN,
      B.BHYTTREN3NAM as TREN3NAM, B.BHYTTREN5NAM as TREN5NAM, B.SOTIEPNHAN, B.SOBENHAN,
      B.LOAITHANHVIEN_ID, B.SUDUNG_BHTN, B.THE_ID, B.THANHVIEN_ID, B.BAOLANH_VIENPHI, B.VIP, B.NGUOINUOCNGOAI,
      C.GIATRIMIENGIAM as GIATRIMIENGIAM, D.GIATRIMIENGIAM as GIATRIMIENGIAM_BHTN, E.GIATRIMIENGIAM as GIATRIMIENGIAM_THANHVIEN,
      F.GIATRIMIENGIAM as GIATRIMIENGIAM_CONGTY, DVYC.THE_ID as DVDUNGTHE, DVYC.TRANGTHAI as TRANGTHAIDICHVU, ndv.MANHOMDICHVU,
      A.* from TT_VIENPHI A
      left join
      (select B.*, C.SOBENHAN, C.BENHAN_ID
      from TT_TIEPNHAN B
      left join TT_NOITRU_BENHAN C on B.TIEPNHAN_ID = C.TIEPNHAN_ID
      <isNotEmpty prepend="and" property="BENHAN_ID">
        C.BENHAN_ID = '$BENHAN_ID$'
      </isNotEmpty>
      where B.TIEPNHAN_ID = '$TIEPNHAN_ID$') B on B.TIEPNHAN_ID = A.TIEPNHAN_ID
      left join (select sum(GIATRIMIENGIAM) as GIATRIMIENGIAM, VIENPHI_ID, REF_TABLE
      from TT_MIENGIAM_CHITIET
      where REF_TABLE = 'TT_MIENGIAM'
      and exists (select MIENGIAM_ID from TT_MIENGIAM where TT_MIENGIAM_CHITIET.MIENGIAM_ID = MIENGIAM_ID and TINHTRANG = 1 and TIEPNHAN_ID = '$TIEPNHAN_ID$')
      group by VIENPHI_ID, REF_TABLE) C on C.REF_TABLE = 'TT_MIENGIAM' and C.VIENPHI_ID = A.VIENPHI_ID
      left join (select sum(GIATRIMIENGIAM) as GIATRIMIENGIAM, VIENPHI_ID, REF_TABLE
      from TT_MIENGIAM_CHITIET
      where REF_TABLE = 'TT_MIENGIAM_BHTN'
      and exists (select MIENGIAM_BHTN_ID from TT_MIENGIAM_BHTN where TT_MIENGIAM_CHITIET.MIENGIAM_ID = MIENGIAM_BHTN_ID and  TINHTRANG = 1 and TIEPNHAN_ID = '$TIEPNHAN_ID$')
      group by VIENPHI_ID, REF_TABLE) D on D.REF_TABLE = 'TT_MIENGIAM_BHTN' and D.VIENPHI_ID = A.VIENPHI_ID
      left join (select sum(GIATRIMIENGIAM) as GIATRIMIENGIAM, VIENPHI_ID, REF_TABLE
      from TT_MIENGIAM_CHITIET
      where REF_TABLE = 'TT_MIENGIAM_THANHVIEN'
      and exists (select MIENGIAM_THANHVIEN_ID from TT_MIENGIAM_THANHVIEN where TT_MIENGIAM_CHITIET.MIENGIAM_ID = MIENGIAM_THANHVIEN_ID and TINHTRANG = 1 and TIEPNHAN_ID = '$TIEPNHAN_ID$')
      group by VIENPHI_ID, REF_TABLE) E on E.REF_TABLE = 'TT_MIENGIAM_THANHVIEN' and E.VIENPHI_ID = A.VIENPHI_ID
      left join (select sum(GIATRIMIENGIAM) as GIATRIMIENGIAM, VIENPHI_ID, REF_TABLE
      from TT_MIENGIAM_CHITIET
      where REF_TABLE = 'TT_MIENGIAM_CONGTY'
      and exists (select MIENGIAM_CONGTY_ID from TT_MIENGIAM_CONGTY where TT_MIENGIAM_CHITIET.MIENGIAM_ID = MIENGIAM_CONGTY_ID and TINHTRANG = 1 and TIEPNHAN_ID = '$TIEPNHAN_ID$')
      group by VIENPHI_ID, REF_TABLE) F on F.REF_TABLE = 'TT_MIENGIAM_CONGTY' and F.VIENPHI_ID = A.VIENPHI_ID
      left join TT_DVYEUCAU DVYC on DVYC.DVYEUCAU_ID = A.REF_ID and A.REF_TABLE = 'TT_DVYEUCAU'
      left join TM_DICHVU DV on DVYC.DICHVU_ID = DV.DICHVU_ID and A.REF_TABLE = 'TT_DVYEUCAU'
      left join TM_NHOMDICHVU ndv on ndv.NHOMDICHVU_ID = DV.NHOMDICHVU_ID and A.REF_TABLE = 'TT_DVYEUCAU'
      where
      A.TIEPNHAN_ID = '$TIEPNHAN_ID$' and ((DVYC.HUYYEUCAU = '0' and A.DICHVU_ID is not null)
      or A.DUOC_ID is not null or A.REF_TABLE = 'TT_NUT_XACNHANSUATAN_CHITIET')
      and A.ACTIVE = '1'
      <isNotEmpty prepend="and" property="BENHAN_ID">
        A.BENHAN_ID = '$BENHAN_ID$'
      </isNotEmpty>
      and A.BENHVIEN_ID = '$BENHVIEN_ID$'
      order by A.VIENPHI_ID
    </statement>
    <statement id="DAO00064_GetListVienphiDuocNoitruByTiepNnan" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select distinct
      B.DOITUONG_ID, B.NGAYMIENDONGCHITRA, B.BENHNHAN_ID as TIEPNHAN_BENHNHAN_ID, B.TRAITUYEN,
      B.BHYTTREN3NAM as TREN3NAM, B.BHYTTREN5NAM as TREN5NAM, B.SOTIEPNHAN, B.SOBENHAN,
      B.LOAITHANHVIEN_ID, B.SUDUNG_BHTN, B.THE_ID, B.THANHVIEN_ID, B.BAOLANH_VIENPHI, B.VIP, B.NGUOINUOCNGOAI
      A.* from TT_VIENPHI A
      left join (select B.*, C.SOBENHAN, C.BENHAN_ID
      from TT_TIEPNHAN B
      left join TT_NOITRU_BENHAN C on B.TIEPNHAN_ID = C.TIEPNHAN_ID and C.BENHAN_ID = '$BENHAN_ID$'
      where B.TIEPNHAN_ID = '$TIEPNHAN_ID$') B on B.TIEPNHAN_ID = A.TIEPNHAN_ID
      where
      A.TIEPNHAN_ID = '$TIEPNHAN_ID$' and (A.DUOC_ID is not null or A.REF_TABLE = 'TT_NOITRU_TOATHUOC')
      and A.ACTIVE = '1' and A.BENHAN_ID = '$BENHAN_ID$'
      and A.BENHVIEN_ID = '$BENHVIEN_ID$' and A.KHAMBENH_ID = '$KHAMBENH_ID$'
      order by A.VIENPHI_ID
    </statement>
    <statement id="DAO00064_UpdateGiatriAllVienPhiCoSL0vaREF_ID0" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      <isNotEmpty prepend="" property="TIEPNHAN_ID">
        update TT_VIENPHI set
        THANHTIEN_DOANHTHU = 0, BHYT_THANHTIEN = 0, BHYT_THANHTIEN_CHITRA = 0
        , GIATRI_BENHNHAN_DATHANHTOAN = 0, BENHNHAN_PHAITHANHTOAN = 0
        where
        TIEPNHAN_ID = '$TIEPNHAN_ID$' and SOLUONG = 0
        <isNotEmpty prepend="and" property="BENHAN_ID">
          BENHAN_ID = '$BENHAN_ID$'
        </isNotEmpty>

        delete from TT_VIENPHI
        where
        TIEPNHAN_ID = '$TIEPNHAN_ID$' and REF_ID = 0
        <isNotEmpty prepend="and" property="BENHAN_ID">
          BENHAN_ID = '$BENHAN_ID$'
        </isNotEmpty>

        delete from TT_VIENPHI
        where
        REF_TABLE = 'TT_NOITRU_TOATHUOC'
        and TIEPNHAN_ID = '$TIEPNHAN_ID$'
        and KHAMBENH_ID not in (select KHAMBENH_ID from TT_NOITRU_TOATHUOC where TIEPNHAN_ID = '$TIEPNHAN_ID$')
        and HOADON_ID is null
        <isNotEmpty prepend="and" property="BENHAN_ID">
          BENHAN_ID = '$BENHAN_ID$'
        </isNotEmpty>
      </isNotEmpty>
    </statement>
    <statement id="DAO00064_GetTT_MIENGIAM_THANHVIEN" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select * from TT_MIENGIAM_THANHVIEN where TIEPNHAN_ID = '$TIEPNHAN_ID$'
    </statement>
    <statement id="DAO00064_TT_MIENGIAM_THANHVIEN_Add" parameterClass="System.Collections.IDictionary" resultClass="System.Int64">
      insert into TT_MIENGIAM_THANHVIEN (
      SOPHIEU_THANHVIEN
      , TIEPNHAN_ID
      , BENHAN_ID
      , BENHNHAN_ID
      , LOAITHANHVIEN_ID
      , THE_ID
      , NGAYHIEULUC
      , NGAYHETHAN
      , NGUOIDUYET_ID
      , GHICHU
      , TINHTRANG
      , BENHVIEN_ID
      , NGUOITAO_ID
      , NGAYTAO
      , NGUOICAPNHAT_ID
      , NGAYCAPNHAT
      ) values (
      #SOPHIEU_THANHVIEN#
      , #TIEPNHAN_ID#
      , #BENHAN_ID#
      , #BENHNHAN_ID#
      , #LOAITHANHVIEN_ID#
      , #THE_ID#
      , #NGAYHIEULUC#
      , #NGAYHETHAN#
      , #NGUOIDUYET_ID#
      , #GHICHU#
      , '1'
      , #BENHVIEN_ID#
      , #NGUOITAO_ID#
      , #NGAYTAO#
      , #NGUOICAPNHAT_ID#
      , #NGAYCAPNHAT#
      )
      SELECT SCOPE_IDENTITY()
      <!--<selectKey resultClass="System.Int64" type="post" >
        SELECT @@IDENTITY as value
      </selectKey>-->
    </statement>
    <insert id="DAO00064_TT_MIENGIAM_CHITIET_THANHVIEN_Add" parameterClass="System.Collections.IDictionary" resultClass="System.Int64">
      insert into TT_MIENGIAM_CHITIET (
      MIENGIAM_ID
      , REF_TABLE
      , VIENPHI_ID
      , TYLEMIENGIAM
      , GIATRIMIENGIAM
      , BENHVIEN_ID
      , NGUOITAO_ID
      , NGAYTAO
      , NGUOICAPNHAT_ID
      , NGAYCAPNHAT
      , GIATRISAUMIENGIAM
      ) values (
      #MIENGIAM_ID#
      , 'TT_MIENGIAM_THANHVIEN'
      , #VIENPHI_ID#
      , #TYLEMIENGIAM#
      , #GIATRIMIENGIAM_UPDATE#
      , #BENHVIEN_ID#
      , #NGUOITAO_ID#
      , #NGAYTAO#
      , #NGUOICAPNHAT_ID#
      , #NGAYCAPNHAT#
      , #GIATRISAUMIENGIAM#
      )
    </insert>
    <update id="DAO00064_TT_MIENGIAM_CHITIET_THANHVIEN_Update" parameterClass="System.Collections.IDictionary">
      update TT_MIENGIAM_CHITIET set
      <isPropertyAvailable prepend="" property="TYLEMIENGIAM">
        TYLEMIENGIAM = #TYLEMIENGIAM#
      </isPropertyAvailable>
      <isPropertyAvailable prepend="," property="GIATRIMIENGIAM">
        GIATRIMIENGIAM = #GIATRIMIENGIAM_UPDATE#
      </isPropertyAvailable>
      <isPropertyAvailable prepend="," property="NGUOICAPNHAT_ID">
        NGUOICAPNHAT_ID = #NGUOICAPNHAT_ID#
      </isPropertyAvailable>
      <isPropertyAvailable prepend="," property="NGAYCAPNHAT">
        NGAYCAPNHAT = #NGAYCAPNHAT#
      </isPropertyAvailable>
      <isPropertyAvailable prepend="," property="GIATRISAUMIENGIAM">
        GIATRISAUMIENGIAM = #GIATRISAUMIENGIAM#
      </isPropertyAvailable>
      where
      VIENPHI_ID = '$VIENPHI_ID$'
      and REF_TABLE = 'TT_MIENGIAM_THANHVIEN'
    </update>
    <statement id="DAO00064_GetListBenhNhanNgoaiTru" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select distinct
      E.CHANDOANKHAMBENH as CHANDOAN, E.KHOAVAO_ID  as PHONGBAN_ID,  E.BENHAN_ID,
      E.ICD_BENHCHINH as MABENH, E.ICD_BENHPHU as BENHKHAC, E.SOBENHAN, E.SOCAPCUU,
      B.SOBHYT, B.NGAYTIEPNHAN , B.THOIGIANTIEPNHAN as NGAYVAO, B.SOTIEPNHAN, B.DOITUONG_ID, B.TIEPNHAN_ID,
      C.MAYTE as MABN, C.TENBENHNHAN as TENBN, C.NAMSINH , C.BENHNHAN_ID, E.BENHVIEN_ID,
      D.XACNHANCHIPHI_ID, D.NGAYXACNHAN, E.TRANGTHAI, G.GIATRI_BENHNHAN_DATHANHTOAN,
      F.NGAYCHUNGTU as NGAYXUATTHUOC, D.NGUOICAPNHAT_ID as NGUOIKHOABENHAN, nv.TENNHANVIEN, pb.TENPHONGBAN
      from TT_NOITRU_BENHAN E
      inner join TT_TIEPNHAN B on B.TIEPNHAN_ID = E.TIEPNHAN_ID
      left join TT_BENHNHAN C on E.BENHNHAN_ID = C.BENHNHAN_ID
      left join TT_XACNHANCHIPHI D on D.BENHAN_ID = E.BENHAN_ID
      left join TT_NOITRU_KHAMBENH A on E.BENHAN_ID = A.BENHAN_ID
      left join TT_DUOC_CHUNGTU F on F.KHAMBENH_ID = A.KHAMBENH_ID
      left join TM_NHANVIEN nv on nv.NHANVIEN_ID = e.BACSIDIEUTRICHINH_ID
      left join TM_PHONGBAN pb on pb.PHONGBAN_ID = e.KHOACHUYENDEN_ID
      left join (select BENHAN_ID, SUM(GIATRI_BENHNHAN_DATHANHTOAN) as GIATRI_BENHNHAN_DATHANHTOAN
      from TT_VIENPHI vp
      inner join TT_NOITRU_DOTDIEUTRI_CHITIET ct ON ct.VIENPHI_ID = vp.VIENPHI_ID
      inner join TT_NOITRU_DOTDIEUTRI dt on dt.DOTDIEUTRI_ID = ct.DOTDIEUTRI_ID
      where vp.BENHVIEN_ID = '$BENHVIEN_ID$'
      and dt.TRANGTHAI = '1' and ct.TRANGTHAI = 'DATHANHTOAN' group by vp.BENHAN_ID) G on E.BENHAN_ID = A.BENHAN_ID
      where
      (B.SOBHYT is not null and B.SOBHYT != '') AND E.LOAIBENHAN = 2 AND
      (E.TRANGTHAI = 'DAKHOA'  or (E.TRANGTHAI = 'DAXUATVIEN' and (G.GIATRI_BENHNHAN_DATHANHTOAN = 0 or G.GIATRI_BENHNHAN_DATHANHTOAN is null)))
      <isNotEmpty prepend="and" property="TUNGAY">
        E.NGAYLAP &#62;&#61; '$TUNGAY$'
      </isNotEmpty>
      <isNotEmpty prepend="and" property="DENNGAY">
        E.NGAYLAP &#60;&#61; '$DENNGAY$'
      </isNotEmpty>
      and E.BENHVIEN_ID = '$BENHVIEN_ID$'
      <isNotEmpty prepend="and" property="MABENHAN">
        (C.TENBENHNHAN like '%' + #MABENHAN# + '%' OR C.MAYTE like '%' + #MABENHAN# + '%')
      </isNotEmpty>
      <isNotEmpty prepend="and" property="NGAYXACNHAN">
        D.NGAYXACNHAN = '$NGAYXACNHAN$'
      </isNotEmpty>
      <isNotEmpty prepend="" property="TRANGTHAI">
        <isEqual prepend="AND" property="TRANGTHAI" compareValue="2">
          D.XACNHANCHIPHI_ID is NULL
        </isEqual>
        <isEqual prepend="AND" property="TRANGTHAI" compareValue="3">
          D.XACNHANCHIPHI_ID is not NULL
        </isEqual>
        <isEqual prepend="AND" property="TRANGTHAI" compareValue="02">
          D.XACNHANCHIPHI_ID is NULL
        </isEqual>
        <isEqual prepend="AND" property="TRANGTHAI" compareValue="03">
          D.XACNHANCHIPHI_ID is not NULL
        </isEqual>
      </isNotEmpty>
      order by B.SOTIEPNHAN desc
    </statement>
    <statement id="DAO00064_TT_DUOC_CHUNGTU_KiemtraChungtuPhatThuoc" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select * from TT_DUOC_CHUNGTU where CHUNGTU_ID = '$CHUNGTUPHATTHUOC_ID$'
    </statement>
    <statement id="DAO00064_TT_NGOAITRU_KHAMBENH_TOATHUOC_UpdateChungtuPhatThuoc" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      UPDATE TT_NGOAITRU_KHAMBENH_TOATHUOC
      SET CHUNGTUPHATTHUOC_ID = 0, TRANGTHAI = 'CHUAXUAT'
      WHERE CHUNGTUPHATTHUOC_ID = '$CHUNGTUPHATTHUOC_ID$'
    </statement>
    <statement id="DAO00064_TT_NGOAITRU_KHAMBENH_TOATHUOC_GetListToaThuocBHYT" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select * from TT_NGOAITRU_KHAMBENH_TOATHUOC
      where (exists (select KHAMBENH_NGOAITRU_ID from TT_DVYEUCAU
      where TT_NGOAITRU_KHAMBENH_TOATHUOC.KHAMBENH_ID = KHAMBENH_NGOAITRU_ID and TIEPNHAN_ID = '$TIEPNHAN_ID$'))
      and TIEPNHAN_ID = '$TIEPNHAN_ID$' and (LOAITOATHUOC = 'BV'
      <isNotEmpty prepend="or" property="LOAITOATHUOCBHYT">
        LOAITOATHUOC in ($LOAITOATHUOCBHYT$)
      </isNotEmpty>
      )
    </statement>
    <statement id="DAO00064_TT_NGOAITRU_KHAMBENH_TOATHUOC_DaPhatThuocBHYT" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select * from TT_DUOC_CHUNGTU
      where CHUNGTU_ID = '$CHUNGTUPHATTHUOC_ID$' and DAXACNHAN is not null and DAXACNHAN = '1'
    </statement>
    <statement id="DAO00064_TT_NOITRU_TOATHUOC_GetListToaThuocBHYT" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select distinct kb.*, tt.TRANGTHAI,tt.CHUNGTU_ID
      from TT_NOITRU_KHAMBENH kb
      left join TT_NOITRU_TOATHUOC tt on KB.KHAMBENH_ID = TT.KHAMBENH_ID
      where kb.BENHAN_ID = '$BENHAN_ID$' and kb.RAVIEN = '1' and kb.ISTHUOCBV = '1' and tt.HUYTOATHUOC = '0'
    </statement>
    <statement id="DAO00064_DeleteXacNhanBHYTDTNGoaiTru" parameterClass="System.Collections.IDictionary" resultClass="System.Int32">
      delete from TT_XACNHANCHIPHICHITIET
      where XACNHANCHIPHI_ID in
      (select XACNHANCHIPHI_ID from TT_XACNHANCHIPHI where XACNHANCHIPHI_ID = '$XACNHANCHIPHI_ID$');
      delete from TT_XACNHANCHIPHI where XACNHANCHIPHI_ID = '$XACNHANCHIPHI_ID$';
    </statement>
    <statement id="DAO00064_TT_VIENPHI_GetList_DaThanhToan" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select A.* from TT_VIENPHI A
      where
      A.TIEPNHAN_ID = '$TIEPNHAN_ID$'
      and A.DATHANHTOAN = '0'
    </statement>
    <statement id="DAO00064_TT_VIENPHI_GetList_NoiTRuBHYT_XacnhanBHYT" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select * from TT_XACNHANCHIPHI
      where exists (
      select distinct TIEPNHAN_ID from TT_VIENPHI A
      where
      A.BENHAN_ID = '$BENHAN_ID$'
      and A.BHYT_THANHTIEN_CHITRA > 0 and TT_XACNHANCHIPHI.TIEPNHAN_ID = TIEPNHAN_ID)
    </statement>
    <statement id="DAO00064_TT_VIENPHI_GetList_NoiTRu_Chuathanhtoan" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      <!--select count(*) as TOTALROWS from TT_VIENPHI A
      where
      A.BENHAN_ID = '$BENHAN_ID$'
      and GIATRI_BENHNHAN_DATHANHTOAN >= A.BENHNHAN_PHAITHANHTOAN
      and ACTIVE = '1' and REF_ID > 0 and SOLUONG > 0-->
      select
      CASE
      WHEN A.TRANGTHAI in ('DATHANHTOAN', 'DAKHOA') THEN 0
      WHEN A.TRANGTHAI = 'DAXUATVIEN' and (A.LOAIBENHAN = '1' or A.LOAIBENHAN = '3')
      and (select count(*)
      from TT_VIENPHI A
      left join TT_DVYEUCAU B on A.REF_ID = B.DVYEUCAU_ID and A.REF_TABLE = 'TT_DVYEUCAU'
      where (A.HOADON_ID = 0 or A.HOADON_ID is null) and A.BENHNHAN_PHAITHANHTOAN >0 and A.BENHAN_ID = '$BENHAN_ID$'
      and (B.HUYYEUCAU = '0' or B.HUYYEUCAU is null) and A.SOLUONG > 0 and A.ACTIVE = '1') = 0 then 0
      ELSE 1
      END as TOTALROWS
      from TT_NOITRU_BENHAN A
      where
      A.BENHAN_ID = '$BENHAN_ID$'
    </statement>
    <statement id="DAO00064_TT_VIENPHI_GetList_NoiTRuBHYT_CochiphiBHYT" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select VIENPHI_ID from TT_VIENPHI A
      where
      A.BENHAN_ID = '$BENHAN_ID$'
      and A.BHYT_THANHTIEN_CHITRA > 0
      and ACTIVE = '1'
    </statement>
    <statement id="DAO00064_TT_VIENPHI_GetList_NoiTRu" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select count(*) as TOTALROWS from TT_VIENPHI A
      where
      A.BENHAN_ID = '$BENHAN_ID$' and ACTIVE = '1'
      <isNotEmpty prepend="and" property="NGAYBENHAN">
        A.NGAYTAO >= '$NGAYBENHAN$'
      </isNotEmpty>
    </statement>
    <statement id="DAO00064_GetList" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      <!--get cache co where-->
      select * from $CACHE_TABLE$
      where
      BENHVIEN_ID = '$BENHVIEN_ID$'
    </statement>
    <statement id="DAO00064_GetDichvuNguon" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      <!--get cache co where-->
      select * from TM_DICHVU_NGUON
      where
      BENHVIEN_ID = '$BENHVIEN_ID$'
    </statement>
    <statement id="DAO00064_GetBHYTTylethanhtoan" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      <!--get cache co where-->
      select * from TM_BHYT_TYLETHANHTOAN
      where
      BENHVIEN_ID = '$BENHVIEN_ID$'
    </statement>
    <statement id="DAO00064_GetNguonDichvu" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      <!--get cache co where-->
      select * from TM_NGUONDICHVU
      where
      BENHVIEN_ID = '$BENHVIEN_ID$'
    </statement>
    <statement id="DAO00064_GetDanhsachDichvuNgoaitru_ByTiepnhan" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select A.DVYEUCAU_ID, C.LOAIDICHVU, B.BENHNHAN_PHAITHANHTOAN, B.DATHANHTOAN, A.TIEPNHAN_ID, D.SOTIEPNHAN, A.DICHVU_ID
      from TT_DVYEUCAU A
      left join (select * from TT_TIEPNHAN where TIEPNHAN_ID = '$TIEPNHAN_ID$') D on D.TIEPNHAN_ID = A.TIEPNHAN_ID
      left join (select A.DICHVU_ID,
      IIF(LEFT(B.MANHOMDICHVU,2) = '04', 'khambenh', 'nhomkhac') AS LOAIDICHVU
      from TM_DICHVU A
      left JOIN TM_NHOMDICHVU B on A.NHOMDICHVU_ID = B.NHOMDICHVU_ID ) C on C.DICHVU_ID = A.DICHVU_ID
      inner join
      (select * from TT_VIENPHI where TIEPNHAN_ID = '$TIEPNHAN_ID$' and (BENHAN_ID is null or BENHAN_ID = 0) and (DICHVU_ID is not null or DICHVU_ID != 0))  B on A.DVYEUCAU_ID = B.REF_ID
      where A.HUYYEUCAU = '0' and A.TIEPNHAN_ID = '$TIEPNHAN_ID$'
    </statement>
    <statement id="DAO00064_GetAllNgayYeucauDV" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      SELECT
      DISTINCT DVYEUCAU_ID, DICHVU_ID, CONVERT(date, NGAYYEUCAU) NGAYYEUCAU
      FROM TT_DVYEUCAU
      WHERE
      TIEPNHAN_ID = '$TIEPNHAN_ID$'
      <isNotEmpty prepend="and" property="BENHAN_ID">
        BENHAN_ID = '$BENHAN_ID$'
      </isNotEmpty>
    </statement>
    <statement id="DAO00064_GetAllNgayYeucauYlenh" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      SELECT
      DISTINCT A.TOATHUOC_ID, A.KHAMBENH_ID, A.DUOC_ID, CONVERT(date, B.THOIGIANKHAM) NGAYYEUCAU
      FROM TT_NOITRU_TOATHUOC A
      inner join TT_NOITRU_KHAMBENH B on B.KHAMBENH_ID = A.KHAMBENH_ID
      WHERE
      B.BENHAN_ID = '$BENHAN_ID$'
    </statement>
    <statement id="DAO00064_GetlistKhambenhToathuoc_TiepnhanId" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select * from TT_NGOAITRU_KHAMBENH_TOATHUOC
      where TIEPNHAN_ID = '$TIEPNHAN_ID$'
    </statement>
    <statement id="DAO00064_GetlistTT_TIEPNHAN_SOTHEBHYT" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select stbhyt.*, ba.SOBENHAN,
      tn.SOTIEPNHAN, tn.LOAITHANHVIEN_ID, tn.THE_ID, tn.THANHVIEN_ID,
      tn.SUDUNG_BHTN, tn.BAOLANH_VIENPHI, tn.VIP, tn.NGUOINUOCNGOAI
      from TT_TIEPNHAN_SOTHEBHYT stbhyt
      left join TT_TIEPNHAN tn on tn.TIEPNHAN_ID = stbhyt.TIEPNHAN_ID
      left join TT_NOITRU_BENHAN ba on ba.TIEPNHAN_ID = stbhyt.TIEPNHAN_ID
      where
      stbhyt.TIEPNHAN_ID = '$TIEPNHAN_ID$' and isnull(stbhyt.KHONGSUDUNG, '0') = '0'
      <isNotEmpty prepend="and" property="BENHAN_ID">
        ba.BENHAN_ID = '$BENHAN_ID$'
      </isNotEmpty>
    </statement>
    <statement id="DAO00064_GetTopTT_TIEPNHAN_SOTHEBHYT" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select top 1 stbhyt.*, ba.SOBENHAN,
      tn.SOTIEPNHAN, tn.LOAITHANHVIEN_ID, tn.THE_ID, tn.THANHVIEN_ID,
      tn.SUDUNG_BHTN, tn.BAOLANH_VIENPHI, tn.VIP, tn.NGUOINUOCNGOAI
      from TT_TIEPNHAN_SOTHEBHYT stbhyt
      left join TT_TIEPNHAN tn on tn.TIEPNHAN_ID = stbhyt.TIEPNHAN_ID
      left join TT_NOITRU_BENHAN ba on ba.TIEPNHAN_ID = stbhyt.TIEPNHAN_ID
      where
      stbhyt.TIEPNHAN_ID = '$TIEPNHAN_ID$' and isnull(stbhyt.KHONGSUDUNG, '0') = '0'
      order by SOBHYT_HUONG_ID desc
    </statement>
    <statement id="DAO00064_GetlistDSDoituongBHYT" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select A.SOBHYT_HUONG_ID, A.DOITUONG_ID DOITUONG_HUONG_ID,
      A.SOBHYT, A.BHYTTUNGAY, A.BHYTDENNGAY,
      B.TENDOITUONG, B.MADOITUONG, A.TRAITUYEN,A.KHONGSUDUNG,
      A.TIEPNHAN_ID, A.SOBHYT as SOBHYT_OLD, A.BENHNHAN_ID,
      ba.SOBENHAN, ba.BENHAN_ID,
      tn.SOBHYT as SOBHYT_TIEPNHAN,
      tn.SOTIEPNHAN, A.NGAYMIENDONGCHITRA
      from TT_TIEPNHAN_SOTHEBHYT A
      left join TM_DOITUONG B on A.DOITUONG_ID = B.DOITUONG_ID
      left join TT_TIEPNHAN tn on tn.TIEPNHAN_ID = A.TIEPNHAN_ID
      left join TT_NOITRU_BENHAN ba on ba.TIEPNHAN_ID = A.TIEPNHAN_ID
      where A.TIEPNHAN_ID = '$TIEPNHAN_ID$' and isnull(A.KHONGSUDUNG, '0') = '0'
    </statement>
    <statement id="DAO00064_GetTiepnhanVIPNNN" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select bn.MAYTE, bn.TENBENHNHAN, dt.TENDOITUONG, A.* from TT_TIEPNHAN A
      left join TT_BENHNHAN bn on bn.BENHNHAN_ID = A.BENHNHAN_ID
      left join TM_DOITUONG dt on dt.DOITUONG_ID = A.DOITUONG_ID
      where A.TIEPNHAN_ID = #TIEPNHAN_ID#
    </statement>

    <statement id="DAO00064_UpdateSoBHYTTiepnhanBHYT" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      begin
      update TT_TIEPNHAN_SOTHEBHYT
      set
      SOBHYT = #SOBHYT#
      , BHYTTUNGAY = #BHYTTUNGAY#
      , BHYTDENNGAY = #BHYTDENNGAY#
      , TRAITUYEN = #TRAITUYEN#
      , KHONGSUDUNG = #KHONGSUDUNG#
      , NGAYMIENDONGCHITRA = #NGAYMIENDONGCHITRA#
      , NGAYCAPNHAT = getdate()
      where SOBHYT_HUONG_ID = #SOBHYT_HUONG_ID#

      update TT_DOITUONG_THAYDOI set
      SOBHYT = #SOBHYT#
      , BHYTTUNGAY = #BHYTTUNGAY#
      , BHYTDENNGAY = #BHYTDENNGAY#
      , NGAYMIENDONGCHITRA = #NGAYMIENDONGCHITRA#
      where
      TIEPNHAN_ID = #TIEPNHAN_ID#
      and SOBHYT = '$SOBHYT_OLD$'

      <!--update TT_TIEPNHAN set
      SOBHYT = #SOBHYT#
      , BHYTTUNGAY = #BHYTTUNGAY#
      , BHYTDENNGAY = #BHYTDENNGAY#
      , TRAITUYEN = '$TRAITUYEN$'
      , NGAYMIENDONGCHITRA = #NGAYMIENDONGCHITRA#
      where TIEPNHAN_ID = #TIEPNHAN_ID#
      and SOBHYT = '$SOBHYT_OLD$'-->

      update TT_BENHNHAN_BHYT set
      SOTHE = #SOBHYT#
      , NGAYHIEULUC = #BHYTTUNGAY#
      , NGAYHETHIEULUC = #BHYTDENNGAY#
      where BENHNHAN_ID = #BENHNHAN_ID#
      and SOTHE = '$SOBHYT_OLD$'
      end
    </statement>
    <statement id="DAO00064_InsertXacnhanChitietBHYTNgoaitru" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      insert into TT_XACNHANCHIPHICHITIET
      select distinct
      '$XACNHANCHIPHI_ID$' as XACNHANCHIPHI_ID, A.VIENPHI_ID, A.REF_ID as IDREF, ISNULL(A.DICHVU_ID, A.DUOC_ID) as NOIDUNG_ID, isnull(dv.TENDICHVU, dc.TENDUOCDAYDU) NOIDUNG,
      A.SOLUONG as SOLUONG,
      A.DONGIA_DOANHTHU as DONGIADOANHTHU, A.BHYT_DONGIA as DONGIAHOTRO, A.BHYT_THANHTIEN_CHITRA as DONGIAHOTROCHITRA, A.BHYT_DONGIA_CHITRA as DONGIATHANHTOAN,
      'NGOAITRU' as LOAI, null as NGOAITRU_TOATHUOC_ID, null as NOITRU_TOATHUOC_ID, C.NOITHUCHIEN_ID as PHONGBAN_ID,
      '$BENHVIEN_ID$' as BENHVIEN_ID, getdate() as NGAYCAPNHAT, null as NGUOICAPNHAT_ID
      , 0 THANHTIEN, 0 MUCHUONG, 0 BN_TT, 0 THANHTIEN_BHYT, 0 BN_CTT
      from TT_VIENPHI A
      left join (select * from TT_DVYEUCAU where TIEPNHAN_ID = '$TIEPNHAN_ID$') C on C.TIEPNHAN_ID = A.TIEPNHAN_ID and C.DICHVU_ID = A.DICHVU_ID  and C.DVYEUCAU_ID = A.REF_ID
      left join (select * from TT_NGOAITRU_KHAMBENH where TIEPNHAN_ID = '$TIEPNHAN_ID$') D on D.TIEPNHAN_ID = A.TIEPNHAN_ID and D.DICHVU_ID = A.DICHVU_ID and C.KHAMBENH_NGOAITRU_ID = D.KHAMBENH_ID
      left join (select * from TT_NGOAITRU_TOATHUOC where TIEPNHAN_ID = '$TIEPNHAN_ID$') E on E.DUOC_ID = A.DUOC_ID and E.TOATHUOC_ID = A.REF_ID and A.REF_TABLE = 'TT_NGOAITRU_TOATHUOC'
      left join TT_NGOAITRU_KHAMBENH_TOATHUOC tk on tk.KHAMBENH_TOATHUOC_ID = e.KHAMBENH_TOATHUOC_ID
      left join TT_PHAUTHUAT_VTYT vtyt on vtyt.PHAUTHUAT_VTYT_ID = a.REF_ID and a.REF_TABLE = 'TT_PHAUTHUAT_VTYT'
      left join TM_DICHVU dv on dv.DICHVU_ID = A.DICHVU_ID
      left join TM_DUOC dc on dc.DUOC_ID = A.DUOC_ID
      where
      A.TIEPNHAN_ID = '$TIEPNHAN_ID$' and (A.BENHAN_ID is NULL or A.BENHAN_ID = '')
      and A.REF_TABLE != 'TT_DUOC_CHUNGTU_CHITIET' and isnull(A.KHONGTHUTIEN, '0') != '1'
      and (exists (select KHAMBENH_ID from TT_NGOAITRU_KHAMBENH where A.KHAMBENH_ID = KHAMBENH_ID and TIEPNHAN_ID = '$TIEPNHAN_ID$') or A.KHAMBENH_ID is null)
      and (C.HUYYEUCAU = '0' or C.HUYYEUCAU is null) and A.SOLUONG > 0 and A.REF_ID != 0 and
      ((A.BHYT_DONGIA > 0 and A.BHYT_DONGIA_CHITRA > 0)
      <isNotEmpty prepend="" property="PHA_DUOC_KHONG_KIEMTRA_GIA">
        <isEqual prepend="OR" property="PHA_DUOC_KHONG_KIEMTRA_GIA" compareValue="True">
          (A.DUOC_ID is not null and A.BHYT_DONGIA = 0 and A.DONGIA_DOANHTHU = 0)
        </isEqual>
      </isNotEmpty>
      )
      and
      (
      (A.DICHVU_ID is not null and C.HUYYEUCAU != '1') or (A.DICHVU_ID is null and A.DUOC_ID is not null and A.REF_TABLE != 'TT_DUOC_CHUNGTU_CHITIET')
      )
      ORDER BY A.VIENPHI_ID
    </statement>
    <statement id="DAO00064_InsertXacnhanChitietBHYTNoitru" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      insert into TT_XACNHANCHIPHICHITIET
      select
      '$XACNHANCHIPHI_ID$' as XACNHANCHIPHI_ID, A.VIENPHI_ID, A.REF_ID as IDREF, A.DICHVU_ID as NOIDUNG_ID, dv.TENDICHVU as NOIDUNG,
      A.SOLUONG as SOLUONG,
      A.DONGIA_DOANHTHU as DONGIADOANHTHU, A.BHYT_DONGIA as DONGIAHOTRO, A.BHYT_THANHTIEN_CHITRA as DONGIAHOTROCHITRA, A.BHYT_DONGIA_CHITRA as DONGIATHANHTOAN,
      '$LOAI$' as LOAI, null as NGOAITRU_TOATHUOC_ID, null as NOITRU_TOATHUOC_ID, dvyc.NOITHUCHIEN_ID as PHONGBAN_ID,
      '$BENHVIEN_ID$' as BENHVIEN_ID, getdate() as NGAYCAPNHAT, null as NGUOICAPNHAT_ID
      , 0 THANHTIEN, 0 MUCHUONG, 0 BN_TT, 0 THANHTIEN_BHYT, 0 BN_CTT
      from TT_VIENPHI A
      inner join TT_NOITRU_BENHAN D on D.BENHAN_ID = A.BENHAN_ID
      inner join TT_DVYEUCAU dvyc on dvyc.DVYEUCAU_ID = A.REF_ID
      left join TM_DICHVU dv on dv.DICHVU_ID = A.DICHVU_ID
      where A.BENHAN_ID = '$BENHAN_ID$' and A.BENHVIEN_ID = '$BENHVIEN_ID$'
      and (A.DICHVU_ID is not null and A.DUOC_ID is null)
      and isnull(A.KHONGTHUTIEN, '0') != '1' and dvyc.HUYYEUCAU != '1' and A.REF_TABLE = 'TT_DVYEUCAU'
      and A.TIEPNHAN_ID = '$TIEPNHAN_ID$' and A.BHYT_DONGIA > 0 and A.BHYT_DONGIA_CHITRA > 0
      <isNotEmpty prepend="and" property="DOTDIEUTRI_ID">
        A.DOTDIEUTRI_ID = #DOTDIEUTRI_ID#
      </isNotEmpty>
      union
      select
      '$XACNHANCHIPHI_ID$' as XACNHANCHIPHI_ID, A.VIENPHI_ID, A.REF_ID as IDREF, A.DUOC_ID as NOIDUNG_ID, dc.TENDUOCDAYDU as NOIDUNG,
      A.SOLUONG as SOLUONG,
      A.DONGIA_DOANHTHU as DONGIADOANHTHU, A.BHYT_DONGIA as DONGIAHOTRO, A.BHYT_THANHTIEN_CHITRA as DONGIAHOTROCHITRA, A.BHYT_DONGIA_CHITRA as DONGIATHANHTOAN,
      '$LOAI$' as LOAI, null as NGOAITRU_TOATHUOC_ID, null as NOITRU_TOATHUOC_ID, null as PHONGBAN_ID,
      '$BENHVIEN_ID$' as BENHVIEN_ID, getdate() as NGAYCAPNHAT, null as NGUOICAPNHAT_ID
      , 0 THANHTIEN, 0 MUCHUONG, 0 BN_TT, 0 THANHTIEN_BHYT, 0 BN_CTT
      from TT_VIENPHI A
      inner join TT_NOITRU_BENHAN D on D.BENHAN_ID = A.BENHAN_ID
      inner join TT_NOITRU_TOATHUOC B on A.TIEPNHAN_ID = B.TIEPNHAN_ID and A.REF_ID = B.TOATHUOC_ID
      left join TM_DUOC dc on dc.DUOC_ID = A.DUOC_ID
      where A.BENHAN_ID = '$BENHAN_ID$' and A.BENHVIEN_ID = '$BENHVIEN_ID$'
      and (A.DICHVU_ID is null and A.DUOC_ID is not null) and REF_TABLE = 'TT_NOITRU_TOATHUOC'
      and isnull(A.KHONGTHUTIEN, '0') != '1' and A.TIEPNHAN_ID = '$TIEPNHAN_ID$' and A.BHYT_DONGIA > 0 and A.BHYT_DONGIA_CHITRA > 0
      <isNotEmpty prepend="and" property="DOTDIEUTRI_ID">
        A.DOTDIEUTRI_ID = #DOTDIEUTRI_ID#
      </isNotEmpty>
      union
      select
      '$XACNHANCHIPHI_ID$' as XACNHANCHIPHI_ID, A.VIENPHI_ID, A.REF_ID as IDREF, A.DUOC_ID as NOIDUNG_ID, dc.TENDUOCDAYDU as NOIDUNG,
      A.SOLUONG as SOLUONG,
      A.DONGIA_DOANHTHU as DONGIADOANHTHU, A.BHYT_DONGIA as DONGIAHOTRO, A.BHYT_THANHTIEN_CHITRA as DONGIAHOTROCHITRA, A.BHYT_DONGIA_CHITRA as DONGIATHANHTOAN,
      '$LOAI$' as LOAI, null as NGOAITRU_TOATHUOC_ID, null as NOITRU_TOATHUOC_ID, null as PHONGBAN_ID,
      '$BENHVIEN_ID$' as BENHVIEN_ID, getdate() as NGAYCAPNHAT, null as NGUOICAPNHAT_ID
      , 0 THANHTIEN, 0 MUCHUONG, 0 BN_TT, 0 THANHTIEN_BHYT, 0 BN_CTT
      from TT_VIENPHI A
      inner join TT_NOITRU_BENHAN D on D.BENHAN_ID = A.BENHAN_ID
      left join TM_DUOC dc on dc.DUOC_ID = A.DUOC_ID
      where A.BENHAN_ID = '$BENHAN_ID$' and A.BENHVIEN_ID = '$BENHVIEN_ID$'
      and (A.DICHVU_ID is null and A.DUOC_ID is not null) and REF_TABLE not in ('TT_DVYEUCAU', 'TT_NOITRU_TOATHUOC', 'TT_NUT_XACNHANSUATAN_CHITIET', 'TT_MAU_CHUNGTU_CHITIET')
      and isnull(A.KHONGTHUTIEN, '0') != '1' and A.TIEPNHAN_ID = '$TIEPNHAN_ID$' and A.BHYT_DONGIA > 0 and A.BHYT_DONGIA_CHITRA > 0
      <isNotEmpty prepend="and" property="DOTDIEUTRI_ID">
        A.DOTDIEUTRI_ID = #DOTDIEUTRI_ID#
      </isNotEmpty>
    </statement>
    <statement id="DAO00064_KiemtraBHYTNgoaitruDaThanhtoan" parameterClass="System.Collections.IDictionary" resultClass="System.Int64">
      select COUNT(*)
      from TT_VIENPHI A
      left join (select * from TT_DVYEUCAU where TIEPNHAN_ID = '$TIEPNHAN_ID$') C on C.TIEPNHAN_ID = A.TIEPNHAN_ID and C.DICHVU_ID = A.DICHVU_ID  and C.DVYEUCAU_ID = A.REF_ID
      left join (select * from TT_NGOAITRU_KHAMBENH where TIEPNHAN_ID = '$TIEPNHAN_ID$') D on D.TIEPNHAN_ID = A.TIEPNHAN_ID and D.DICHVU_ID = A.DICHVU_ID and C.KHAMBENH_NGOAITRU_ID = D.KHAMBENH_ID
      left join (select * from TT_NGOAITRU_TOATHUOC where TIEPNHAN_ID = '$TIEPNHAN_ID$') E on E.DUOC_ID = A.DUOC_ID and E.TOATHUOC_ID = A.REF_ID and A.REF_TABLE = 'TT_NGOAITRU_TOATHUOC'
      left join TT_NGOAITRU_KHAMBENH_TOATHUOC tk on tk.KHAMBENH_TOATHUOC_ID = e.KHAMBENH_TOATHUOC_ID
      left join TT_PHAUTHUAT_VTYT vtyt on vtyt.PHAUTHUAT_VTYT_ID = a.REF_ID and a.REF_TABLE = 'TT_PHAUTHUAT_VTYT'
      where
      A.TIEPNHAN_ID = '$TIEPNHAN_ID$' and (A.BENHAN_ID is NULL or A.BENHAN_ID = '')
      and A.REF_TABLE != 'TT_DUOC_CHUNGTU_CHITIET' and A.KHONGTHUTIEN != '1'
      and (exists (select KHAMBENH_ID from TT_NGOAITRU_KHAMBENH where A.KHAMBENH_ID = KHAMBENH_ID and TIEPNHAN_ID = '$TIEPNHAN_ID$') or A.KHAMBENH_ID is null)
      and (C.HUYYEUCAU = '0' or C.HUYYEUCAU is null) <!--and A.BHYT_DONGIA > 0-->
      and
      (
      (A.DICHVU_ID is not null and C.HUYYEUCAU != '1') or (A.DICHVU_ID is null and A.DUOC_ID is not null and A.REF_TABLE != 'TT_DUOC_CHUNGTU_CHITIET')
      )
      and A.BENHNHAN_PHAITHANHTOAN > A.GIATRI_BENHNHAN_DATHANHTOAN
    </statement>
    <statement id="DAO00064_GetDanhsachXacnhanChiphiChitiet" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select A.*
      from TT_XACNHANCHIPHICHITIET A
      left join TT_XACNHANCHIPHI B on A.XACNHANCHIPHI_ID = B.XACNHANCHIPHI_ID
      where B.TIEPNHAN_ID = '$TIEPNHAN_ID$'
      <isNotEmpty prepend="and" property="BENHAN_ID">
        B.BENHAN_ID = '$BENHAN_ID$'
      </isNotEmpty>
    </statement>
    <statement id="DAO00064_GetVienphiTiepNhan_BIL09_DaBHYT" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select distinct case when YC.DVYEUCAU_ID is not null then YC.TRANGTHAI
      when KBTT.KHAMBENH_TOATHUOC_ID is not null then KBTT.TRANGTHAI
      when PT.PHAUTHUAT_VTYT_ID is not null then case when PT.CHUNGTU_ID is not null then 'DAXUAT' else 'CHUAXUAT' end
      when VTYT.KHAMBENH_VTYT_ID is not null then case when VTYT.CHUNGTU_ID is not null then 'DAXUAT' else 'CHUAXUAT' end
      when kqvtyt.CLSKETQUA_VTYT_ID is not null then case when kqvtyt.TRANGTHAI is not null then 'DAXUAT' else 'CHUAXUAT' end
      else '' end as TRANGTHAI
      , YC.NOITHUCHIEN_ID as PHONGBAN_ID, KB.NGAYKHAM,
      XNCT.NOIDUNG_ID, VP.REF_ID as IDREF, XNCT.VIENPHI_ID,
      VP.SOLUONG as SOLUONG, VP.SOLUONG as SOLUONG_NEW, VP.DICHVU_ID, VP.DUOC_ID, VP.BHYT_DONGIA_CHITRA,
      VP.DONGIA_DOANHTHU, VP.DONGIA_DOANHTHU as DONGIADOANHTHU, VP.BHYT_DONGIA as DONGIAHOTRO, VP.BHYT_THANHTIEN_CHITRA as DONGIAHOTROCHITRA, VP.BHYT_DONGIA_CHITRA as DONGIAHOTROCHITRA_NEW,
      VP.REF_TABLE as LOAI, VP.BHYT_DONGIA, VP.BHYT_THANHTIEN, VP.BHYT_THANHTIEN_CHITRA, VP.BENHNHAN_PHAITHANHTOAN, VP.GIATRI_BENHNHAN_DATHANHTOAN, VP.BENHVIEN_ID, VP.THANHTIEN_DOANHTHU,
      VP.LOAI_CHIPHI, VP.LOAIGIA_ID, REF_TABLE, VP.KHAMBENH_ID, VP.REF_ID, VP.DUOCPHEPTHUCHIEN,
      VP.HUY, VP.KHONGTHUTIEN, VP.DATHANHTOAN, VP.HOADON_ID, VP.ACTIVE, YC.DVYEUCAU_ID, YC.NGAYYEUCAU, ISNULL(YC.BACSICHIDINH_ID, YC.NGUOIGIOITHIEU_ID) as BACSICHIDINH_ID, YC.NOIYEUCAU_ID
      , VP.DATHUCHIEN,
      isnull(dv.TENDICHVU, dc.TENDUOCDAYDU) NOIDUNG, isnull(dv.MADICHVU, dc.MADUOC) MADICHVU, dv.NORESULT, dc.DONVITINH, ld.MALOAIDUOC, dc.BHYT DUOC_BHYT, ld.LOAIVATTU_ID,
      ndv.MANHOMDICHVU, KB.KBHUONGGIAIQUYET NOIDUNG2
      from TT_XACNHANCHIPHI XN
      inner join TT_XACNHANCHIPHICHITIET XNCT on XNCT.XACNHANCHIPHI_ID = XN.XACNHANCHIPHI_ID and XNCT.BENHVIEN_ID = XN.BENHVIEN_ID
      inner join TT_VIENPHI VP on VP.VIENPHI_ID = XNCT.VIENPHI_ID and VP.BENHVIEN_ID = XNCT.BENHVIEN_ID AND VP.REF_TABLE!='TT_MAU_CHUNGTU_CHITIET'
      left join TT_DVYEUCAU YC on YC.BENHVIEN_ID = VP.BENHVIEN_ID and YC.DVYEUCAU_ID = VP.REF_ID and VP.REF_TABLE = 'TT_DVYEUCAU'
      left join TT_NGOAITRU_TOATHUOC TT on TT.BENHVIEN_ID = VP.BENHVIEN_ID and TT.TOATHUOC_ID = VP.REF_ID and VP.REF_TABLE = 'TT_NGOAITRU_TOATHUOC'
      left join TT_NGOAITRU_KHAMBENH_TOATHUOC KBTT on KBTT.BENHVIEN_ID = TT.BENHVIEN_ID and KBTT.KHAMBENH_TOATHUOC_ID = TT.KHAMBENH_TOATHUOC_ID
      left join TT_NGOAITRU_KHAMBENH_VTYT VTYT on VTYT.BENHVIEN_ID = VP.BENHVIEN_ID and VTYT.KHAMBENH_VTYT_ID = VP.REF_ID and VP.REF_TABLE = 'TT_NGOAITRU_KHAMBENH_VTYT'
      left join TT_PHAUTHUAT_VTYT PT on PT.BENHVIEN_ID = VP.BENHVIEN_ID and PT.PHAUTHUAT_VTYT_ID = VP.REF_ID and VP.REF_TABLE = 'TT_PHAUTHUAT_VTYT'
      left join (
      select pb.TENPHONGBAN + ' - ' + nv.TENNHANVIEN + ' - '+ hgq.DICTIONARY_NAME KBHUONGGIAIQUYET, kb.* from TT_NGOAITRU_KHAMBENH kb
      left join TM_PHONGBAN pb on pb.PHONGBAN_ID = kb.PHONGBAN_ID
      left join TM_NHANVIEN nv on nv.NHANVIEN_ID = kb.BACSIKHAM_ID
      left join (select * from LST_DICTIONARY where DICTIONARY_TYPE_CODE = 'GiaiQuyetKhamBenh') hgq on hgq.DICTIONARY_ID = kb.HUONGGIAIQUYET_ID
      ) KB on KB.TIEPNHAN_ID = XN.TIEPNHAN_ID and KB.DICHVU_ID = VP.DICHVU_ID and YC.KHAMBENH_NGOAITRU_ID = KB.KHAMBENH_ID
      left join TT_CLSKETQUA_VTYT kqvtyt on kqvtyt.CLSKETQUA_VTYT_ID = VP.REF_ID and VP.REF_TABLE = 'TT_CLSKETQUA_VTYT'
      left join TM_DICHVU dv on VP.DICHVU_ID = dv.DICHVU_ID and VP.REF_TABLE = 'TT_DVYEUCAU'
      left join TM_DUOC dc on VP.DUOC_ID = dc.DUOC_ID
      left join TM_LOAIDUOC ld on dc.LOAIDUOC_ID = ld.LOAIDUOC_ID
      left join TM_NHOMDICHVU ndv on ndv.NHOMDICHVU_ID = dv.NHOMDICHVU_ID
      where XN.TIEPNHAN_ID = '$TIEPNHAN_ID$' and XN.BENHVIEN_ID = '$BENHVIEN_ID$'
      ORDER BY XNCT.VIENPHI_ID
    </statement>
    <statement id="DAO00064_CheckBenhNhanChuaXSDVTYT" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      IF EXISTS (
      select vt.KHAMBENH_VTYT_ID
      from TT_NGOAITRU_KHAMBENH_VTYT vt
      inner join TT_NGOAITRU_KHAMBENH kb on kb.KHAMBENH_ID = vt.KHAMBENH_ID
      where kb.TIEPNHAN_ID = $TIEPNHAN_ID$
      and kb.BENHVIEN_ID = '$BENHVIEN_ID$'
      and vt.CHUNGTU_ID is null

      union all

      select vt.CLSKETQUA_VTYT_ID
      from TT_CLSKETQUA_VTYT vt
      inner join TT_DVYEUCAU yc on yc.DVYEUCAU_ID = vt.DVYEUCAU_ID and yc.BENHVIEN_ID = vt.BENHVIEN_ID
      where yc.TIEPNHAN_ID = $TIEPNHAN_ID$
      and yc.BENHVIEN_ID = '$BENHVIEN_ID$'
      and vt.CHUNGTU_ID is null
      )
      BEGIN
      SELECT -1 AS RESULT
      END
      ELSE
      BEGIN
      SELECT 1 AS RESULT
      END
    </statement>
    <statement id="DAO00064_UpdateThongtinTraThuocNoitru" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      update TT_VIENPHI
      set SOLUONG = (TraThuoc.SOLUONG - TraThuoc.SOLUONG_NGUNG)
      from (select distinct nttt.SOLUONG, ttct.TOATHUOC_ID, ttct.DUOC_ID , ttct.SOLUONG SOLUONG_NGUNG
      from TT_NOITRU_TRATHUOC_CHITIET ttct
      left join TT_NOITRU_TRATHUOC tt on tt.TRATHUOC_ID = ttct.TRATHUOC_ID
      left join TT_NOITRU_TOATHUOC nttt on nttt.TOATHUOC_ID = ttct.TOATHUOC_ID
      where tt.BENHAN_ID = #BENHAN_ID#) TraThuoc
      where TT_VIENPHI.REF_ID = TraThuoc.TOATHUOC_ID and TT_VIENPHI.DUOC_ID = TraThuoc.DUOC_ID
      and TT_VIENPHI.REF_TABLE = 'TT_NOITRU_TOATHUOC' and TT_VIENPHI.BENHAN_ID = #BENHAN_ID#
      and TT_VIENPHI.SOLUONG > (TraThuoc.SOLUONG - TraThuoc.SOLUONG_NGUNG)
    </statement>
    <statement id="DAO00064_ChuyenChiPhiTuNgoaitruVaoNoitru" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      update TT_HOADON set BENHAN_ID = #BENHAN_ID#
      where LOAIHOADON = 'TU' and BENHAN_ID is null and TIEPNHAN_ID = #TIEPNHAN_ID#

      update TT_VIENPHI set BENHAN_ID = #BENHAN_ID#
      where BENHAN_ID is null and TIEPNHAN_ID = #TIEPNHAN_ID#
    </statement>
    <statement id="DAO00064_ChuyenChiPhiTuNgoaitruVaoDieutriNT" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      declare @intDotDT int;
      select @intDotDT = DOTDIEUTRI_ID from TT_NOITRU_DOTDIEUTRI where BENHAN_ID = #BENHAN_ID# and TRANGTHAI = '0'

      update TT_HOADON set BENHAN_ID = #BENHAN_ID#
      where LOAIHOADON = 'TU' and BENHAN_ID is null and TIEPNHAN_ID = #TIEPNHAN_ID#

      update TT_VIENPHI set BENHAN_ID = #BENHAN_ID#, DOTDIEUTRI_ID = @intDotDT
      where BENHAN_ID is null and TIEPNHAN_ID = #TIEPNHAN_ID#
    </statement>
    <statement id="DAO00064_GetBenhNhanBHYTInfo" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select BN.TENBENHNHAN, bn.GIOITINH, bn.NGAYSINH, SOBHYT, BHYTTUNGAY, BHYTDENNGAY, BN.NAMSINH
      from TT_TIEPNHAN TN
      inner join TT_BENHNHAN BN on BN.BENHNHAN_ID = TN.BENHNHAN_ID and BN.BENHVIEN_ID = TN.BENHVIEN_ID
      where TN.TIEPNHAN_ID = $TIEPNHAN_ID$
      and TN.BENHVIEN_ID = '$BENHVIEN_ID$'
    </statement>
    <statement id="DAO00064_UpdateVienPhiTiepnhan2Benhan" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      update TT_VIENPHI set BENHAN_ID = #BENHAN_ID#, NGAYCAPNHAT = #NGAYCAPNHAT#, NGUOICAPNHAT_ID = #NGUOICAPNHAT_ID#
      where TIEPNHAN_ID = #TIEPNHAN_ID# and VIENPHI_ID in ($LST_VIENPHI$)
    </statement>
    <statement id="DAO00064_CheckBenhNhanDaXacNhanBHYT" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      IF EXISTS (SELECT XACNHANCHIPHI_ID FROM TT_XACNHANCHIPHI WHERE TIEPNHAN_ID = $TIEPNHAN_ID$)
      BEGIN
      SELECT 1 AS RESULT
      END
      ELSE
      BEGIN
      SELECT 0 AS RESULT
      END
    </statement>
    <statement id="DAO00064_CheckBenhNhanCondichvuchuathuchien" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select count(*) TOTAL
      from TT_DVYEUCAU A
      join TM_DICHVU B on A.DICHVU_ID = B.DICHVU_ID
      join TM_NHOMDICHVU C on c.NHOMDICHVU_ID = B.NHOMDICHVU_ID
      where isnull(A.HUYYEUCAU,'0') = '0' and A.BENHAN_ID is null and A.TRANGTHAI = 'CHUAKETQUA'
      and left(C.MANHOMDICHVU,2) = '04' and A.TIEPNHAN_ID = #TIEPNHAN_ID#

      <!--select count(*) TOTAL
      from TT_DVYEUCAU
      where TIEPNHAN_ID = #TIEPNHAN_ID# and isnull(HUYYEUCAU,'0') = '0' and BENHAN_ID is null and TRANGTHAI = 'CHUAKETQUA'-->
    </statement>
    <statement id="DAO00064_GetListVienphiNgoaitru_updatewfl" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select VIENPHI_ID, DATHANHTOAN, DATHUCHIEN from TT_VIENPHI
      where VIENPHI_ID in ($LST_VIENPHI$) and (DATHANHTOAN = '1' or DATHUCHIEN = '1')
    </statement>

    <statement id="DAO00064_GetListVienphiDaThanhtoan" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select VIENPHI_ID, DATHANHTOAN from TT_VIENPHI
      where VIENPHI_ID in ($LST_VIENPHI$) and DATHANHTOAN = '1'
    </statement>
    <statement id="DAO00064_UpdateNguoiXacnhanChiphiNoitru" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      update TT_NOITRU_BENHAN
      set THOIGIANTHANHTOAN = getdate(), NGUOITHANHTOAN_ID = $NGUOIXACNHANDOANHTHU_ID$
      where BENHAN_ID = $BENHAN_ID$ and TRANGTHAI in ('DANGDIEUTRI', 'DAXUATVIEN')
    </statement>
    <statement id="DAO00064_GetBenhAnDaLuuTru" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select * from TT_BENHAN_LUUTRU where BENHAN_ID = '$BENHAN_ID$'
    </statement>
    <statement id="DAO00064_ValidateThoiGianXacNhanBHYT" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      IF EXISTS (SELECT DVYEUCAU_ID
      FROM TT_DVYEUCAU
      WHERE TIEPNHAN_ID = $TIEPNHAN_ID$ AND BENHVIEN_ID = '$BENHVIEN_ID$' AND NGAYGIOYEUCAU > '$THOIGIANXACNHAN$'
      )
      BEGIN
      SELECT -1 AS RESULT
      END
      ELSE
      IF EXISTS (SELECT CLSKETQUA_ID
      FROM TT_CLSKETQUA
      WHERE TIEPNHAN_ID = $TIEPNHAN_ID$ AND BENHVIEN_ID = '$BENHVIEN_ID$' AND THOIGIANTHUCHIEN > '$THOIGIANXACNHAN$'
      )
      BEGIN
      SELECT -2 AS RESULT
      END
      ELSE
      IF EXISTS (SELECT PHAUTHUAT_ID
      FROM TT_PHAUTHUAT
      WHERE TIEPNHAN_ID = $TIEPNHAN_ID$ AND BENHVIEN_ID = '$BENHVIEN_ID$' AND THOIGIANKETTHUC > '$THOIGIANXACNHAN$'
      )
      BEGIN
      SELECT -3 AS RESULT
      END
      ELSE
      BEGIN
      SELECT 0 AS RESULT
      END
    </statement>
    <statement id="DAO00064_GetList_TT_VIENPHI_BHTN" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select distinct a.*, a.DONGIA_DOANHTHU DONGIA_DOANHTHU_BK, b.TINHTRANG AS TINHTRANG_MG, d.TINHTRANG_BHTN, e.TINHTRANG_MGCT, d.GHINHAN_GIATRI_BHTN
      , b.MIENGIAMCHITIET_ID, b.GIATRIMIENGIAM, e.GIATRIMIENGIAM_CONGTY as GIATRIMIENGIAM_CTCT, f.GIATRIMIENGIAM_THANHVIEN
      , CAST(1 AS BIT) CHON, lg.TENLOAIGIA
      ,case when a.REF_TABLE = 'TT_DVYEUCAU' then dv.TENDICHVU
      when a.REF_TABLE = 'TT_MAU_CHUNGTU_CHITIET' then mau.TENMAU
      else dc.TENDUOCDAYDU end as TENDICHVU
      ,case when a.REF_TABLE = 'TT_DVYEUCAU' then dv.MADICHVU
      when a.REF_TABLE = 'TT_MAU_CHUNGTU_CHITIET' then mau.MAMAU
      else dc.MADUOC end as MADICHVU
      ,case when a.REF_TABLE = 'TT_DVYEUCAU' then 'DICHVU'
      when a.REF_TABLE = 'TT_MAU_CHUNGTU_CHITIET' then 'MAU'
      else 'DUOC' end as LOAIDICHVU
      from
      (select VP.* from TT_VIENPHI VP where VP.GIATRI_BENHNHAN_DATHANHTOAN = 0
      <isNotEmpty prepend="and" property="TIEPNHAN_ID">
        VP.TIEPNHAN_ID = '$TIEPNHAN_ID$'
      </isNotEmpty>
      <isNotEmpty prepend="and" property="BENHAN_ID">
        VP.BENHAN_ID = '$BENHAN_ID$'
      </isNotEmpty>
      )a
      left join TM_DICHVU dv on dv.DICHVU_ID = a.DICHVU_ID and a.REF_TABLE = 'TT_DVYEUCAU'
      left join TM_DUOC dc on dc.DUOC_ID = a.DUOC_ID and REF_TABLE != 'TT_DVYEUCAU' and a.REF_TABLE != 'TT_MAU_CHUNGTU_CHITIET'
      left join TM_MAU mau on mau.MAU_ID = a.DUOC_ID and a.REF_TABLE = 'TT_MAU_CHUNGTU_CHITIET'
      left join TM_LOAIGIA lg on lg.LOAIGIA_ID = a.LOAIGIA_ID
      <!--mien giam-->
      left join (
      select VIENPHI_ID, MG.TINHTRANG, MGCT.MIENGIAMCHITIET_ID, MGCT.GIATRIMIENGIAM
      from TT_MIENGIAM MG INNER JOIN TT_MIENGIAM_CHITIET MGCT ON MG.MIENGIAM_ID = MGCT.MIENGIAM_ID
      where
      MG.TIEPNHAN_ID= '$TIEPNHAN_ID$' and MGCT.REF_TABLE = 'TT_MIENGIAM'
      )b on a.VIENPHI_ID = b.VIENPHI_ID

      left join(
      select VIENPHI_ID, MG.TINHTRANG AS TINHTRANG_BHTN, MGCT.GIATRIMIENGIAM as GHINHAN_GIATRI_BHTN
      from TT_MIENGIAM_BHTN MG INNER JOIN TT_MIENGIAM_CHITIET MGCT ON MG.MIENGIAM_BHTN_ID = MGCT.MIENGIAM_ID
      where
      MG.TIEPNHAN_ID= '$TIEPNHAN_ID$' and MGCT.REF_TABLE = 'TT_MIENGIAM_BHTN'
      )d on a.VIENPHI_ID = d.VIENPHI_ID

      left join(
      select VIENPHI_ID, MG.TINHTRANG AS TINHTRANG_MGCT, MGCT.GIATRIMIENGIAM as GIATRIMIENGIAM_CONGTY
      from TT_MIENGIAM_CONGTY MG INNER JOIN TT_MIENGIAM_CHITIET MGCT ON MG.MIENGIAM_CONGTY_ID = MGCT.MIENGIAM_ID
      where
      MG.TIEPNHAN_ID= '$TIEPNHAN_ID$' and MGCT.REF_TABLE = 'TT_MIENGIAM_CONGTY'
      )e on a.VIENPHI_ID = e.VIENPHI_ID

      left join(
      select VIENPHI_ID, MG.TINHTRANG AS TINHTRANG_MGCT, MGCT.GIATRIMIENGIAM as GIATRIMIENGIAM_THANHVIEN
      from TT_MIENGIAM_THANHVIEN MG INNER JOIN TT_MIENGIAM_CHITIET MGCT ON MG.MIENGIAM_THANHVIEN_ID = MGCT.MIENGIAM_ID
      where
      MG.TIEPNHAN_ID= '$TIEPNHAN_ID$' and MGCT.REF_TABLE = 'TT_MIENGIAM_THANHVIEN'
      )f on a.VIENPHI_ID = f.VIENPHI_ID
      <!--dv yeu cau-->
      left join(
      select A.DVYEUCAU_ID
      from TT_DVYEUCAU A
      where A.TIEPNHAN_ID = '$TIEPNHAN_ID$' and isnull(A.HUYYEUCAU, '0') != '1'
      )c on c.DVYEUCAU_ID = a.REF_ID and a.REF_TABLE = 'TT_DVYEUCAU'
      <!--TT_NGOAITRU_KHAMBENH_VTYT-->
      left join(
      select A.KHAMBENH_VTYT_ID
      from TT_NGOAITRU_KHAMBENH_VTYT A
      inner join TT_NGOAITRU_KHAMBENH B on A.KHAMBENH_ID = B.KHAMBENH_ID
      where B.TIEPNHAN_ID = '$TIEPNHAN_ID$'
      )ntkbvtyt on ntkbvtyt.KHAMBENH_VTYT_ID = a.REF_ID and a.REF_TABLE = 'TT_NGOAITRU_KHAMBENH_VTYT'
      <!--TT_NGOAITRU_TOATHUOC-->
      left join(
      select A.TOATHUOC_ID
      from TT_NGOAITRU_TOATHUOC A
      where A.TIEPNHAN_ID = '$TIEPNHAN_ID$'
      )ngttt on ngttt.TOATHUOC_ID = a.REF_ID and a.REF_TABLE = 'TT_NGOAITRU_TOATHUOC'
      <!--TT_CLSKETQUA_VTYT-->
      left join(
      select A.CLSKETQUA_VTYT_ID
      from TT_CLSKETQUA_VTYT A
      inner join TT_DVYEUCAU B on A.DVYEUCAU_ID = B.DVYEUCAU_ID
      where B.TIEPNHAN_ID = '$TIEPNHAN_ID$'
      )clsvtyt on clsvtyt.CLSKETQUA_VTYT_ID = a.REF_ID and a.REF_TABLE = 'TT_CLSKETQUA_VTYT'
      <!--TT_PHAUTHUAT_VTYT-->
      left join(
      select A.PHAUTHUAT_VTYT_ID
      from TT_PHAUTHUAT_VTYT A
      inner join TT_PHAUTHUAT B on A.PHAUTHUAT_ID = B.PHAUTHUAT_ID
      where B.TIEPNHAN_ID = '$TIEPNHAN_ID$'
      )ptvtyt on ptvtyt.PHAUTHUAT_VTYT_ID = a.REF_ID and a.REF_TABLE = 'TT_PHAUTHUAT_VTYT'
      <!--TT_NOITRU_TOATHUOC-->
      left join(
      select A.TOATHUOC_ID
      from TT_NOITRU_TOATHUOC A
      where A.TIEPNHAN_ID = '$TIEPNHAN_ID$'
      )nttt on nttt.TOATHUOC_ID = a.REF_ID and a.REF_TABLE = 'TT_NOITRU_TOATHUOC'
      <!--TT_DUOC_CHUNGTU_CHITIET-->
      left join(
      select A.CHUNGTUCHITIET_ID
      from TT_DUOC_CHUNGTU_CHITIET A
      inner join TT_NGOAITRU_TOATHUOC B on A.TOATHUOCNGOAITRU_ID = B.TOATHUOC_ID
      where B.TIEPNHAN_ID = '$TIEPNHAN_ID$'
      )dct on dct.CHUNGTUCHITIET_ID = a.REF_ID and a.REF_TABLE = 'TT_DUOC_CHUNGTU_CHITIET'
      <!--TT_MAU_CHUNGTU_CHITIET-->
      left join(
      select A.CHUNGTUCHITIET_ID
      from TT_MAU_CHUNGTU_CHITIET A
      inner join TT_MAU_CHUNGTU B on A.CHUNGTU_ID = B.CHUNGTU_ID and B.CHUNGTULIENQUAN_ID is null
      inner join TT_MAU_DANGKYMAU C on C.DANGKYMAU_ID = B.DANGKYMAU_ID
      where C.TIEPNHAN_ID = '$TIEPNHAN_ID$'
      )mauct on mauct.CHUNGTUCHITIET_ID = a.REF_ID and a.REF_TABLE = 'TT_MAU_CHUNGTU_CHITIET'
    </statement>
    <statement id="DAO00064_GetLoaiGiaTheoCongty" resultClass="DataObject">
      select A.LOAIGIA_ID, C.TENLOAIGIA from TM_CONGTYBHTN_LOAIGIA A
      inner join TM_LOAIGIA C on A.LOAIGIA_ID = C.LOAIGIA_ID
      where
      C.CAPTREN_ID = (select LOAIGIA_ID from TM_LOAIGIA where MALOAIGIA = '$MALOAIGIA$' and BENHVIEN_ID = '$BENHVIEN_ID$')
      and A.CONGTY_ID = '$CONGTYBHTN_ID$'
    </statement>
    <statement id="DAO00064_BHTNKiemtraMiengiam" resultClass="DataObject">
      select * from TT_MIENGIAM_CHITIET where VIENPHI_ID in ($LST_VIENPHI$)
    </statement>
    <statement id="DAO00064_BHTNKiemtraDathanhtoan" resultClass="DataObject">
      select * from TT_VIENPHI where VIENPHI_ID in ($LST_VIENPHI$) and isnull(HOADON_ID, 0) > 0
    </statement>
    <statement id="DAO00064_UpdateGiaDoanhthuBHTN" resultClass="DataObject">
      declare @jsonVienPhi nvarchar(max) = N'$JSON_DATA$';
      declare @GHINHAN_BHTN_BANGGIA_ID int;

      insert into TT_GHINHAN_BHTNBANGGIA
      (TIEPNHAN_ID, BENHAN_ID, BENHNHAN_ID, CONGTYBHTN_ID, LOAIGIA_ID, GHICHU, NGUOITAO_ID, NGAYTAO
      , NGUOICAPNHAT_ID, NGAYCAPNHAT, BENHVIEN_ID)
      values
      (#TIEPNHAN_ID#, #BENHAN_ID#, #BENHNHAN_ID#, #CONGTYBHTN_ID#, #LOAIGIA_ID#, #GHICHU#, #NGUOITAO_ID#, getdate()
      , #NGUOITAO_ID#, getdate(), #BENHVIEN_ID#)

      set @GHINHAN_BHTN_BANGGIA_ID = SCOPE_IDENTITY()
      <!--update vienphi-->
      update TT_VIENPHI
      set TT_VIENPHI.DONGIA_DOANHTHU = vp.DONGIA_DOANHTHU, TT_VIENPHI.LOAIGIA_ID = vp.LOAIGIA_ID
      FROM OPENJSON(@jsonVienPhi)
      WITH (
      VIENPHI_ID int,
      LOAIGIA_ID int,
      DONGIA_DOANHTHU numeric(25, 4),
      DONGIA_DOANHTHU_BK numeric(25, 4)) vp
      where vp.VIENPHI_ID = TT_VIENPHI.VIENPHI_ID

      <!--log chi tiet-->
      INSERT INTO TT_GHINHAN_BHTNBANGGIACHITIET
      (GHINHAN_BHTN_BANGGIA_ID, TIEPNHAN_ID, BENHAN_ID, BENHNHAN_ID, CONGTYBHTN_ID, LOAIGIA_ID, VIENPHI_ID
      , DONGIA_DOANHTHU_MOI, DONGIA_DOANHTHU_OLD, BENHVIEN_ID, NGUOITAO_ID, NGAYTAO)
      SELECT @GHINHAN_BHTN_BANGGIA_ID, #TIEPNHAN_ID#, #BENHAN_ID#, #BENHNHAN_ID#, #CONGTYBHTN_ID#, #LOAIGIA_ID#, vp.VIENPHI_ID
      , vp.DONGIA_DOANHTHU, vp.DONGIA_DOANHTHU_BK, #BENHVIEN_ID#, #NGUOITAO_ID#, getdate()
      FROM OPENJSON(@jsonVienPhi)
      WITH (
      VIENPHI_ID int,
      DONGIA_DOANHTHU numeric(25, 4),
      DONGIA_DOANHTHU_BK numeric(25, 4)) vp


    </statement>
  </statements>
</sqlMap>