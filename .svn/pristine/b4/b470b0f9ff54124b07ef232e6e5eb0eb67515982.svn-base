<?xml version="1.0" encoding="utf-8" ?>
<!--============================================================================
//	CAUTION: This file is generated by IBatisNetGen.3.SQLMap.cst at 11/11/2015 9:27:48 AM
//				Any manual editing will be lost in re-generation.
//===========================================================================-->
<sqlMap namespace="eHospital" xmlns="http://ibatis.apache.org/mapping" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" >

  <statements>

    <statement id="DAO00064_CapNhatKhoaCaKham" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      update TT_TIEPNHAN set
      TRANGTHAI = #TRANGTHAI#,
      KHOADULIEU = #KHOADULIEU#,
      NGUOIKHOA_ID = #NGUOIKHOA_ID#,
      NGAYKHOA = #NGAYKHOA#,
      <IsPropertyAvailable prepend="" property="GHICHU_KHOADULIEU">
        GHICHU_KHOADULIEU = #GHICHU_KHOADULIEU#,
      </IsPropertyAvailable>
      NGUOICAPNHAT_ID = #NGUOICAPNHAT_ID#,
      NGAYCAPNHAT = #NGAYCAPNHAT#
      where
      TIEPNHAN_ID = '$TIEPNHAN_ID$'
      and BENHVIEN_ID = '$BENHVIEN_ID$'
    </statement>

    <statement id="DAO00064_CapNhatGhiChuKhoaCaKham" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      update TT_TIEPNHAN set
      GHICHU_KHOADULIEU = #GHICHU_KHOADULIEU#,
      NGUOICAPNHAT_ID = #NGUOICAPNHAT_ID#,
      NGAYCAPNHAT = #NGAYCAPNHAT#
      where
      TIEPNHAN_ID = '$TIEPNHAN_ID$'
      and BENHVIEN_ID = '$BENHVIEN_ID$'
    </statement>

    <statement id="DAO00064_GetListBenhNhanVienPhi" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select *
      from
      (select COUNT(*) OVER() as TOTALROWS,  ROW_NUMBER() OVER(order by B.SOTIEPNHAN desc) as ROWNUMBER,
      B.SOBHYT, B.NGAYTIEPNHAN , B.THOIGIANTIEPNHAN as NGAYVAO, B.SOTIEPNHAN, B.DOITUONG_ID, B.TIEPNHAN_ID, B.GHICHU_KHOADULIEU,
      C.MAYTE as MABN, C.TENBENHNHAN as TENBN, C.NAMSINH, Convert(varchar(10),C.NGAYSINH,103) as NGAYSINH , ISNULL(C.DIACHILIENLAC,C.SONHA) as DIACHI, C.SODIENTHOAI, C.BENHNHAN_ID, B.BENHVIEN_ID,
      D.XACNHANCHIPHI_ID, D.NGAYXACNHAN, B.KHOADULIEU, B.NGAYKHOA
      from TT_TIEPNHAN B
      inner join TT_BENHNHAN C on B.BENHNHAN_ID = C.BENHNHAN_ID
      left join TT_XACNHANCHIPHI D on D.TIEPNHAN_ID = B.TIEPNHAN_ID
      where
      (B.TIEPNHAN_ID not in (select TIEPNHAN_ID from TT_NOITRU_BENHAN where TIEPNHAN_ID = B.TIEPNHAN_ID)) and
      (B.SOBHYT is null or B.SOBHYT = '') and
      (B.TRANGTHAI = 'DATIEPNHAN' or B.TRANGTHAI = 'HOANTHANH' ) and C.MAYTE is not null
      <isNotEmpty prepend="and" property="TUNGAY">
        B.NGAYTIEPNHAN &#62;&#61; '$TUNGAY$'
      </isNotEmpty>
      <isNotEmpty prepend="and" property="DENNGAY">
        B.NGAYTIEPNHAN &#60;&#61; '$DENNGAY$'
      </isNotEmpty>
      and B.BENHVIEN_ID = '$BENHVIEN_ID$'
      <isNotEmpty prepend="and" property="MABENHNHAN">
        (C.TENBENHNHAN like N'%$MABENHNHAN$%' OR C.MAYTE like '%$MABENHNHAN$%')
      </isNotEmpty>
      <isNotEmpty prepend="and" property="NGAYKHOA">
        convert(date, B.NGAYKHOA) = '$NGAYKHOA$'
      </isNotEmpty>
      <isNotEmpty prepend="" property="TRANGTHAI">
        <isEqual prepend="AND" property="TRANGTHAI" compareValue="LOCKED">
          B.KHOADULIEU = 1
        </isEqual>
        <isEqual prepend="AND" property="TRANGTHAI" compareValue="NOTLOCKED">
          B.KHOADULIEU = 0
        </isEqual>
      </isNotEmpty>
      ) lst
      <isNotEmpty prepend="" property="FROMROW">
        where
        lst.ROWNUMBER between $FROMROW$ and $TOROW$
      </isNotEmpty>
    </statement>
    <statement id="DAO00064_GetListBenhNhan" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select * from
      (
      select *, COUNT(*) OVER() as TOTALROWS,  ROW_NUMBER() OVER(order by lst.SOTIEPNHAN desc) as ROWNUMBER
      from
      (select distinct
      B.SOBHYT, B.NGAYTIEPNHAN , B.THOIGIANTIEPNHAN as NGAYVAO, B.SOTIEPNHAN, B.DOITUONG_ID, B.TIEPNHAN_ID, B.GHICHU_KHOADULIEU,
      C.MAYTE as MABN, C.TENBENHNHAN as TENBN, C.NAMSINH , C.BENHNHAN_ID, E.BENHVIEN_ID,
      D.XACNHANCHIPHI_ID, D.NGAYXACNHAN, C.SONHA as DIACHITHUONGTRU<!--, nv.TENNHANVIEN, pb.TENPHONGBAN-->
      from TT_DVYEUCAU E
      inner join TT_TIEPNHAN B on B.TIEPNHAN_ID = E.TIEPNHAN_ID
      inner join TT_BENHNHAN C on E.BENHNHAN_ID = C.BENHNHAN_ID
      left join TT_XACNHANCHIPHI D on D.TIEPNHAN_ID = E.TIEPNHAN_ID
      left join TT_NGOAITRU_KHAMBENH ntkb on ntkb.KHAMBENH_ID = e.KHAMBENH_NGOAITRU_ID
      left join TM_NHANVIEN nv on nv.NHANVIEN_ID = ntkb.BACSIKHAM_ID
      left join TM_PHONGBAN pb on pb.PHONGBAN_ID = e.NOITHUCHIEN_ID
      where
      (B.TIEPNHAN_ID not in (select TIEPNHAN_ID from TT_NOITRU_BENHAN where TIEPNHAN_ID = B.TIEPNHAN_ID)) and
      (B.SOBHYT is not null and B.SOBHYT != '') and
      (B.TRANGTHAI = 'DATIEPNHAN' or B.TRANGTHAI = 'HOANTHANH' ) and C.MAYTE is not null
      <isNotEmpty prepend="and" property="TUNGAY">
        B.NGAYTIEPNHAN &#62;&#61; '$TUNGAY$'
      </isNotEmpty>
      <isNotEmpty prepend="and" property="DENNGAY">
        B.NGAYTIEPNHAN &#60;&#61; '$DENNGAY$'
      </isNotEmpty>
      <!--(B.NGAYTIEPNHAN BETWEEN '$TUNGAY$' AND '$DENNGAY$')-->
      and E.BENHVIEN_ID = '$BENHVIEN_ID$'
      <isNotEmpty prepend="and" property="MABENHNHAN">
        <!--B.SOTIEPNHAN = '$MABENHNHAN$'-->
        (C.TENBENHNHAN like N'%$MABENHNHAN$%' OR C.MAYTE like '%$MABENHNHAN$%')
      </isNotEmpty>      
      <isNotEmpty prepend="and" property="NGAYXACNHAN">
        D.NGAYXACNHAN = '$NGAYXACNHAN$'
      </isNotEmpty>
      <isNotEmpty prepend="" property="TRANGTHAI">
        <isEqual prepend="AND" property="TRANGTHAI" compareValue="2">
          D.XACNHANCHIPHI_ID is NULL
        </isEqual>
        <isEqual prepend="AND" property="TRANGTHAI" compareValue="3">
          D.XACNHANCHIPHI_ID is not NULL
        </isEqual>
        <isEqual prepend="AND" property="TRANGTHAI" compareValue="02">
          D.XACNHANCHIPHI_ID is NULL
        </isEqual>
        <isEqual prepend="AND" property="TRANGTHAI" compareValue="03">
          D.XACNHANCHIPHI_ID is not NULL
        </isEqual>
      </isNotEmpty>
      ) lst
      ) ds
      <isNotEmpty prepend="" property="FROMROW">
        where
        ds.ROWNUMBER between $FROMROW$ and $TOROW$
      </isNotEmpty>
    </statement>
    <statement id="DAO00064_GetListBenhNhanNoiTru" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select *
      from
      (select COUNT(*) OVER() as TOTALROWS,  ROW_NUMBER() OVER(order by B.SOTIEPNHAN desc) as ROWNUMBER,
      E.CHANDOANKHAMBENH as CHANDOAN, E.KHOAVAO_ID  as PHONGBAN_ID,  E.BENHAN_ID,
      E.ICD_BENHCHINH as MABENH, E.ICD_BENHPHU as BENHKHAC, E.SOBENHAN, E.SOCAPCUU,
      B.SOBHYT, B.NGAYTIEPNHAN , B.THOIGIANTIEPNHAN as NGAYVAO, B.SOTIEPNHAN, B.DOITUONG_ID, B.TIEPNHAN_ID,
      C.MAYTE as MABN, C.TENBENHNHAN as TENBN, C.NAMSINH , C.BENHNHAN_ID, E.BENHVIEN_ID,
      D.XACNHANCHIPHI_ID, D.NGAYXACNHAN, E.TRANGTHAI,
      D.NGUOICAPNHAT_ID as NGUOIKHOABENHAN, E.LOAIBENHAN, C.SONHA as DIACHITHUONGTRU, nv.TENNHANVIEN, pb.TENPHONGBAN
      from TT_NOITRU_BENHAN E
      inner join TT_TIEPNHAN B on B.TIEPNHAN_ID = E.TIEPNHAN_ID
      inner join TT_BENHNHAN C on E.BENHNHAN_ID = C.BENHNHAN_ID
      left join TT_XACNHANCHIPHI D on D.BENHAN_ID = E.BENHAN_ID
      left join TM_NHANVIEN nv on nv.NHANVIEN_ID = e.BACSIDIEUTRICHINH_ID
      left join TM_PHONGBAN pb on pb.PHONGBAN_ID = e.KHOACHUYENDEN_ID
      where
      (B.SOBHYT is not null and B.SOBHYT != '') AND (E.LOAIBENHAN is null or E.LOAIBENHAN != 2) AND
      E.TRANGTHAI = 'DATHANHTOAN'
      <!--(E.TRANGTHAI = 'DATHANHTOAN' or E.TRANGTHAI = 'DAKHOA' or E.TRANGTHAI = 'DAXUATVIEN')-->
      <isNotEmpty prepend="and" property="TUNGAY">
        E.NGAYRAVIEN &#62;&#61; '$TUNGAY$'
      </isNotEmpty>
      <isNotEmpty prepend="and" property="DENNGAY">
        E.NGAYRAVIEN &#60;&#61; '$DENNGAY$'
      </isNotEmpty>
      <!--(E.NGAYLAP BETWEEN '$TUNGAY$' AND '$DENNGAY$')-->
      and E.BENHVIEN_ID = '$BENHVIEN_ID$'
      <isNotEmpty prepend="and" property="MABENHAN">
        <!--(E.SOBENHAN like '%$MABENHAN$%' OR C.MAYTE like '%$MABENHAN$%')-->
        (C.TENBENHNHAN like N'%$MABENHAN$%' OR C.MAYTE like '%$MABENHAN$%')
      </isNotEmpty>
      <isNotEmpty prepend="and" property="NGAYXACNHAN">
        D.NGAYXACNHAN = '$NGAYXACNHAN$'
      </isNotEmpty>
      <isNotEmpty prepend="" property="TRANGTHAI">
        <isEqual prepend="AND" property="TRANGTHAI" compareValue="2">
          D.XACNHANCHIPHI_ID is NULL
        </isEqual>
        <isEqual prepend="AND" property="TRANGTHAI" compareValue="3">
          D.XACNHANCHIPHI_ID is not NULL
        </isEqual>
        <isEqual prepend="AND" property="TRANGTHAI" compareValue="02">
          D.XACNHANCHIPHI_ID is NULL
        </isEqual>
        <isEqual prepend="AND" property="TRANGTHAI" compareValue="03">
          D.XACNHANCHIPHI_ID is not NULL
        </isEqual>
      </isNotEmpty>
      <isNotEmpty prepend="" property="CAPCUU_NOITRU">
        <isEqual prepend="AND" property="CAPCUU_NOITRU" compareValue="CAPCUU">
          E.SOBENHAN like '%CC'
        </isEqual>
        <isEqual prepend="AND" property="CAPCUU_NOITRU" compareValue="NOITRU">
          E.SOBENHAN not like '%CC'
        </isEqual>
      </isNotEmpty>      
      ) lst
      <isNotEmpty prepend="" property="FROMROW">
        where
        lst.ROWNUMBER between $FROMROW$ and $TOROW$
      </isNotEmpty>
    </statement>
    
    <statement id="DAO00064_GetListBenhNhanNoiTruVP" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select *
      from
      (select COUNT(*) OVER() as TOTALROWS,  ROW_NUMBER() OVER(order by B.SOTIEPNHAN desc) as ROWNUMBER,
      E.CHANDOANKHAMBENH as CHANDOAN, E.KHOAVAO_ID  as PHONGBAN_ID,  E.BENHAN_ID,
      E.ICD_BENHCHINH as MABENH, E.ICD_BENHPHU as BENHKHAC, E.SOBENHAN, E.SOCAPCUU,
      B.SOBHYT, B.NGAYTIEPNHAN , B.THOIGIANTIEPNHAN as NGAYVAO, E.THOIGIANRAVIEN, B.SOTIEPNHAN, B.DOITUONG_ID, B.TIEPNHAN_ID,
      C.MAYTE as MABN, C.TENBENHNHAN as TENBN, isnull(C.NGAYSINH, C.NAMSINH) as NGAYSINH, C.NAMSINH , C.BENHNHAN_ID, E.BENHVIEN_ID,
      D.XACNHANCHIPHI_ID, D.NGAYXACNHAN, E.TRANGTHAI,
      gd.DESCRIPTION  as TENGIOITINH, pb.TENPHONGBAN, D.NGUOICAPNHAT_ID as NGUOIKHOABENHAN, C.DIACHILIENLAC,
      CASE WHEN balt.MABENHAN is null THEN 0 ELSE 1 END as CHUYENLUUTRU,
      E.LOAIBENHAN
      from TT_NOITRU_BENHAN E
      inner join TT_TIEPNHAN B on B.TIEPNHAN_ID = E.TIEPNHAN_ID
      left join TT_BENHNHAN C on E.BENHNHAN_ID = C.BENHNHAN_ID
      left join TT_XACNHANCHIPHI D on D.BENHAN_ID = E.BENHAN_ID
      left join TM_GENDER gd on gd.ID = C.GIOITINH
      left join TT_BENHAN_LUUTRU balt on balt.BENHAN_ID = E.BENHAN_ID and balt.REF_TABLE = 'TT_NOITRU_BENHAN'
      left join TM_PHONGBAN pb on pb.PHONGBAN_ID = isnull(E.KHOACHUYENDEN_ID, E.KHOAVAO_ID)
      where
      <!--(B.SOBHYT is null or B.SOBHYT = '') AND--> (E.LOAIBENHAN is null or E.LOAIBENHAN != 2) AND
      <!--E.TRANGTHAI != 'DANGDIEUTRI' AND-->
      (E.TRANGTHAI = 'DATHANHTOAN' or E.TRANGTHAI = 'DAKHOA' or E.TRANGTHAI = 'DAXUATVIEN')
      <isNotEmpty prepend="and" property="TUNGAY">
        E.NGAYRAVIEN &#62;&#61; '$TUNGAY$'
    </isNotEmpty>
    <isNotEmpty prepend="and" property="DENNGAY">
      E.NGAYRAVIEN &#60;&#61; '$DENNGAY$'
    </isNotEmpty>      
      <!--(E.NGAYLAP BETWEEN '$TUNGAY$' AND '$DENNGAY$')-->
      and E.BENHVIEN_ID = '$BENHVIEN_ID$'
      <isNotEmpty prepend="and" property="MABENHAN">
        (E.SOBENHAN like N'%$MABENHAN$%' or C.TENBENHNHAN like N'%$MABENHAN$%')
      </isNotEmpty>
      <isNotEmpty prepend="and" property="NGAYXACNHAN">
        D.NGAYXACNHAN = '$NGAYXACNHAN$'
      </isNotEmpty>
      <isNotEmpty prepend="" property="TRANGTHAI">
        <isEqual prepend="AND" property="TRANGTHAI" compareValue="2">
          D.XACNHANCHIPHI_ID is NULL
        </isEqual>
        <isEqual prepend="AND" property="TRANGTHAI" compareValue="3">
          D.XACNHANCHIPHI_ID is not NULL
        </isEqual>
        <isEqual prepend="AND" property="TRANGTHAI" compareValue="02">
          D.XACNHANCHIPHI_ID is NULL
        </isEqual>
        <isEqual prepend="AND" property="TRANGTHAI" compareValue="03">
          D.XACNHANCHIPHI_ID is not NULL
        </isEqual>
      </isNotEmpty>
      <isNotEmpty prepend="" property="IPD_OPD_XACNHANBHYT_KHOABENHAN">
        <isEqual prepend="AND" property="IPD_OPD_XACNHANBHYT_KHOABENHAN" compareValue="True">
          (B.SOBHYT is null or B.SOBHYT = '')
        </isEqual>      
      </isNotEmpty>
      ) lst
      <isNotEmpty prepend="" property="FROMROW">
        where
        lst.ROWNUMBER between $FROMROW$ and $TOROW$
      </isNotEmpty>
    </statement>
    <statement id="DAO00064_GetVienphiTiepNhan" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select distinct C.TRANGTHAI, C.NOITHUCHIEN_ID as PHONGBAN_ID, D.NGAYKHAM,
      ISNULL(A.DICHVU_ID, A.DUOC_ID) as NOIDUNG_ID, A.REF_ID as IDREF, A.VIENPHI_ID,
      A.SOLUONG as SOLUONG, A.SOLUONG as SOLUONG_NEW, A.DICHVU_ID, A.DUOC_ID, A.BHYT_DONGIA_CHITRA,
      A.DONGIA_DOANHTHU, A.DONGIA_DOANHTHU as DONGIADOANHTHU, A.BHYT_DONGIA as DONGIAHOTRO, A.BHYT_THANHTIEN_CHITRA as DONGIAHOTROCHITRA,
      A.REF_TABLE as LOAI, A.BHYT_DONGIA, A.BHYT_THANHTIEN, A.BHYT_THANHTIEN_CHITRA, A.BENHNHAN_PHAITHANHTOAN, A.GIATRI_BENHNHAN_DATHANHTOAN, A.BENHVIEN_ID, A.THANHTIEN_DOANHTHU,
      A.LOAI_CHIPHI, A.LOAIGIA_ID, REF_TABLE, A.KHAMBENH_ID, A.REF_ID, A.DUOCPHEPTHUCHIEN,
      A.HUY, A.KHONGTHUTIEN, A.DATHANHTOAN, A.HOADON_ID, A.ACTIVE, C.DVYEUCAU_ID, C.NGAYYEUCAU, ISNULL(C.BACSICHIDINH_ID, C.NGUOIGIOITHIEU_ID) as BACSICHIDINH_ID, C.NOIYEUCAU_ID
      from TT_VIENPHI A
      left join (select * from TT_DVYEUCAU where TIEPNHAN_ID = '$TIEPNHAN_ID$') C on C.TIEPNHAN_ID = A.TIEPNHAN_ID and C.DICHVU_ID = A.DICHVU_ID  and C.DVYEUCAU_ID = A.REF_ID
      left join (select * from TT_NGOAITRU_KHAMBENH where TIEPNHAN_ID = '$TIEPNHAN_ID$') D on D.TIEPNHAN_ID = A.TIEPNHAN_ID and D.DICHVU_ID = A.DICHVU_ID
      left join TT_NGOAITRU_TOATHUOC E on E.DUOC_ID = A.DUOC_ID and E.TOATHUOC_ID = A.REF_ID
      where
      A.TIEPNHAN_ID = '$TIEPNHAN_ID$' and A.BENHVIEN_ID = '$BENHVIEN_ID$' and (A.BENHAN_ID is NULL or A.BENHAN_ID = '') and A.HUY = '0'
      ORDER BY A.VIENPHI_ID
    </statement>
    <statement id="DAO00064_GetVienphiTiepNhan_BIL09" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select distinct C.TRANGTHAI, C.NOITHUCHIEN_ID as PHONGBAN_ID, D.NGAYKHAM,
      ISNULL(A.DICHVU_ID, A.DUOC_ID) as NOIDUNG_ID, A.REF_ID as IDREF, A.VIENPHI_ID,
      A.SOLUONG as SOLUONG, A.SOLUONG as SOLUONG_NEW, A.DICHVU_ID, A.DUOC_ID, A.BHYT_DONGIA_CHITRA,
      A.DONGIA_DOANHTHU, A.DONGIA_DOANHTHU as DONGIADOANHTHU, A.BHYT_DONGIA as DONGIAHOTRO, A.BHYT_THANHTIEN_CHITRA as DONGIAHOTROCHITRA,
      A.REF_TABLE as LOAI, A.BHYT_DONGIA, A.BHYT_THANHTIEN, A.BHYT_THANHTIEN_CHITRA, A.BENHNHAN_PHAITHANHTOAN, A.GIATRI_BENHNHAN_DATHANHTOAN, A.BENHVIEN_ID, A.THANHTIEN_DOANHTHU,
      A.LOAI_CHIPHI, A.LOAIGIA_ID, REF_TABLE, A.KHAMBENH_ID, A.REF_ID, A.DUOCPHEPTHUCHIEN,
      A.HUY, A.KHONGTHUTIEN, A.DATHANHTOAN, A.HOADON_ID, A.ACTIVE, C.DVYEUCAU_ID, C.NGAYYEUCAU, ISNULL(C.BACSICHIDINH_ID, C.NGUOIGIOITHIEU_ID) as BACSICHIDINH_ID, C.NOIYEUCAU_ID
      from TT_VIENPHI A
      left join (select * from TT_DVYEUCAU where TIEPNHAN_ID = '$TIEPNHAN_ID$') C on C.TIEPNHAN_ID = A.TIEPNHAN_ID and C.DICHVU_ID = A.DICHVU_ID  and C.DVYEUCAU_ID = A.REF_ID
      left join (select * from TT_NGOAITRU_KHAMBENH where TIEPNHAN_ID = '$TIEPNHAN_ID$') D on D.TIEPNHAN_ID = A.TIEPNHAN_ID and D.DICHVU_ID = A.DICHVU_ID
      left join (select * from TT_NGOAITRU_TOATHUOC where TIEPNHAN_ID = '$TIEPNHAN_ID$') E on E.DUOC_ID = A.DUOC_ID and E.TOATHUOC_ID = A.REF_ID and E.KHAMBENH_ID = D.KHAMBENH_ID
      where
      A.TIEPNHAN_ID = '$TIEPNHAN_ID$' and A.BENHVIEN_ID = '$BENHVIEN_ID$' and (A.BENHAN_ID is NULL or A.BENHAN_ID = '') <!--and A.HUY = '0'-->
      and A.REF_TABLE != 'TT_DUOC_CHUNGTU_CHITIET' and A.KHONGTHUTIEN != '1'
      and (A.KHAMBENH_ID in (select KHAMBENH_ID from TT_NGOAITRU_KHAMBENH where TIEPNHAN_ID = '$TIEPNHAN_ID$') or A.KHAMBENH_ID is null) 
      ORDER BY A.VIENPHI_ID
    </statement>
    <statement id="DAO00064_GetVienphiBenhanIdCapCuu" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select distinct C.TRANGTHAI, C.NOITHUCHIEN_ID as PHONGBAN_ID,
      ISNULL(A.DICHVU_ID, A.DUOC_ID) as NOIDUNG_ID, A.REF_ID as IDREF, A.VIENPHI_ID,
      A.SOLUONG as SOLUONG, A.SOLUONG as SOLUONG_NEW, A.DICHVU_ID, A.DUOC_ID, A.BHYT_DONGIA_CHITRA,
      A.DONGIA_DOANHTHU, A.DONGIA_DOANHTHU as DONGIADOANHTHU, A.BHYT_DONGIA as DONGIAHOTRO, A.BHYT_THANHTIEN_CHITRA as DONGIAHOTROCHITRA,
      A.REF_TABLE as LOAI, A.BHYT_DONGIA, A.BHYT_THANHTIEN, A.BHYT_THANHTIEN_CHITRA, A.BENHNHAN_PHAITHANHTOAN, A.GIATRI_BENHNHAN_DATHANHTOAN, A.BENHVIEN_ID, A.THANHTIEN_DOANHTHU,
      A.LOAI_CHIPHI, A.LOAIGIA_ID, REF_TABLE, A.KHAMBENH_ID, A.REF_ID, A.DUOCPHEPTHUCHIEN,
      A.HUY, A.KHONGTHUTIEN, A.DATHANHTOAN, A.HOADON_ID, A.ACTIVE, C.DVYEUCAU_ID, C.NGAYYEUCAU, ISNULL(C.BACSICHIDINH_ID, C.NGUOIGIOITHIEU_ID) as BACSICHIDINH_ID, C.NOIYEUCAU_ID
      from TT_VIENPHI A
      left join (select * from TT_DVYEUCAU where TIEPNHAN_ID = '$TIEPNHAN_ID$') C on C.TIEPNHAN_ID = A.TIEPNHAN_ID and C.DICHVU_ID = A.DICHVU_ID  and C.DVYEUCAU_ID = A.REF_ID
      left join (select * from TT_NOITRU_TOATHUOC where TIEPNHAN_ID = '$TIEPNHAN_ID$') D on D.TIEPNHAN_ID = A.TIEPNHAN_ID and D.DUOC_ID = A.DUOC_ID and D.TOATHUOC_ID = A.REF_ID
      left join (select * from TT_PHAUTHUAT_VTYT) E on E.DUOC_ID = A.DUOC_ID and E.PHAUTHUAT_VTYT_ID = A.REF_ID
      left join (select * from TT_CLSKETQUA_VTYT) F on F.DUOC_ID = A.DUOC_ID and F.CLSKETQUA_VTYT_ID = A.REF_ID
      where
      A.BENHAN_ID = '$BENHAN_CAPCUU$' and A.TIEPNHAN_ID = '$TIEPNHAN_ID$' and A.BENHVIEN_ID = '$BENHVIEN_ID$' and A.HUY = '0'
      ORDER BY A.VIENPHI_ID
    </statement>
    <statement id="DAO00064_UpdateVienphiBenhanIdCapCuu" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      update TT_VIENPHI set BENHAN_ID = '$BENHAN_ID$'
      where VIENPHI_ID in ($LST_VIENPHI_ID$)      
    </statement>
    <statement id="DAO00064_GetREGListVienphiTiepNhan" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select A.*, B.THUTIENSAU
      from TT_VIENPHI A
      left join TT_DVYEUCAU B on A.REF_ID =  B.DVYEUCAU_ID and A.REF_TABLE = 'TT_DVYEUCAU' and B.HUYYEUCAU = '0'
      where
      A.TIEPNHAN_ID = '$TIEPNHAN_ID$' and A.BENHVIEN_ID = '$BENHVIEN_ID$' and (A.BENHAN_ID is NULL or A.BENHAN_ID = '')
      and A.HUY = '0'
      ORDER BY A.VIENPHI_ID
    </statement>
    <statement id="DAO00064_GetChiTietVienphiNoiTru" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select distinct
      C.GIATRIMIENGIAM as GIATRIMIENGIAM, D.GIATRIMIENGIAM as GIATRIMIENGIAM_BHTN, E.GIATRIMIENGIAM as GIATRIMIENGIAM_THANHVIEN,
      A.*, dv.NGAYGIOYEUCAU, dv.NOIYEUCAU_ID, dv.NOITHUCHIEN_ID, dv.TRANGTHAI, dv.NGAYYEUCAU1, hd.SOHOADON, dv.KHOTHUCHIEN_ID,
      mgct.GIATRIMIENGIAM as GIATRIMIENGIAM_CONGTY, CONVERT(VARCHAR(10), dv.NGAYYEUCAU1, 103) as NGAYYEUCAU
      from TT_VIENPHI A
      left join TT_HOADON hd on hd.HOADON_ID = A.HOADON_ID and hd.BENHAN_ID is null
      left join (select sum(GIATRIMIENGIAM) as GIATRIMIENGIAM, VIENPHI_ID, REF_TABLE
      from TT_MIENGIAM_CHITIET
      where REF_TABLE = 'TT_MIENGIAM'
      and MIENGIAM_ID in (select MIENGIAM_ID from TT_MIENGIAM where TINHTRANG = 1 and TIEPNHAN_ID = '$TIEPNHAN_ID$')
      group by VIENPHI_ID, REF_TABLE) C on C.REF_TABLE = 'TT_MIENGIAM' and C.VIENPHI_ID = A.VIENPHI_ID
      left join (select sum(GIATRIMIENGIAM) as GIATRIMIENGIAM, VIENPHI_ID, REF_TABLE
      from TT_MIENGIAM_CHITIET
      where REF_TABLE = 'TT_MIENGIAM_BHTN'
      and MIENGIAM_ID in (select MIENGIAM_BHTN_ID from TT_MIENGIAM_BHTN where TINHTRANG = 1 and TIEPNHAN_ID = '$TIEPNHAN_ID$')
      group by VIENPHI_ID, REF_TABLE) D on D.REF_TABLE = 'TT_MIENGIAM_BHTN' and D.VIENPHI_ID = A.VIENPHI_ID
      left join (select sum(GIATRIMIENGIAM) as GIATRIMIENGIAM, VIENPHI_ID, REF_TABLE
      from TT_MIENGIAM_CHITIET
      where REF_TABLE = 'TT_MIENGIAM_THANHVIEN'
      and MIENGIAM_ID in (select MIENGIAM_THANHVIEN_ID from TT_MIENGIAM_THANHVIEN where TINHTRANG = 1 and TIEPNHAN_ID = '$TIEPNHAN_ID$')
      group by VIENPHI_ID, REF_TABLE) E on E.REF_TABLE = 'TT_MIENGIAM_THANHVIEN' and E.VIENPHI_ID = A.VIENPHI_ID
      left join (select sum(GIATRIMIENGIAM) as GIATRIMIENGIAM, VIENPHI_ID, REF_TABLE
      from TT_MIENGIAM_CHITIET
      where REF_TABLE = 'TT_MIENGIAM_CONGTY'
      and MIENGIAM_ID in (select MIENGIAM_CONGTY_ID from TT_MIENGIAM_CONGTY where  TIEPNHAN_ID = '$TIEPNHAN_ID$')
      group by VIENPHI_ID, REF_TABLE) mgct on mgct.REF_TABLE = 'TT_MIENGIAM_CONGTY' and mgct.VIENPHI_ID = A.VIENPHI_ID
      left join (select DVYEUCAU_ID as REF_ID, DICHVU_ID, NGAYGIOYEUCAU, CONVERT(date, NGAYGIOYEUCAU, 103) as NGAYYEUCAU1, NOIYEUCAU_ID, '' as KHOTHUCHIEN_ID, NOITHUCHIEN_ID, TRANGTHAI, 'TT_DVYEUCAU' as REF_TABLE
      from TT_DVYEUCAU where TIEPNHAN_ID = '$TIEPNHAN_ID$' and DANGKY_ID is null  and HUYYEUCAU = '0'
      union
      select A.TOATHUOC_ID as REF_ID, A.DUOC_ID as DICHVU_ID, B.THOIGIANKHAM as NGAYGIOYEUCAU, CONVERT(date, B.THOIGIANKHAM, 103) as NGAYYEUCAU1, A.PHONGBANRATOA_ID as NOIYEUCAU_ID, A.KHOPHAT_ID as KHOTHUCHIEN_ID, '' as NOITHUCHIEN_ID, CASE WHEN A.CHUNGTU_ID is null THEN 'CHUAXUAT' ELSE 'DAXUAT' END AS TRANGTHAI, 'TT_NOITRU_TOATHUOC' as REF_TABLE
      from TT_NOITRU_TOATHUOC A
      left join TT_NOITRU_KHAMBENH B on A.KHAMBENH_ID = B.KHAMBENH_ID
      where TIEPNHAN_ID = '$TIEPNHAN_ID$'
      union
      select CLSKETQUA_VTYT_ID as REF_ID, DUOC_ID as DICHVU_ID, NGAYTAO as NGAYGIOYEUCAU, CONVERT(date, NGAYTAO, 103) as NGAYYEUCAU1, PHONGBAN_ID as NOIYEUCAU_ID, KHOSUDUNG_ID as KHOTHUCHIEN_ID, '' as NOITHUCHIEN_ID, CASE WHEN CHUNGTU_ID is null THEN 'CHUAXUAT' ELSE 'DAXUAT' END AS TRANGTHAI, 'TT_CLSKETQUA_VTYT' as REF_TABLE
      from TT_CLSKETQUA_VTYT
      where DVYEUCAU_ID in (select DVYEUCAU_ID from TT_DVYEUCAU where TIEPNHAN_ID= '$TIEPNHAN_ID$')
      union
      select B.PHAUTHUAT_VTYT_ID as REF_ID, B.DUOC_ID as DICHVU_ID, A.NGAYTHUCHIEN as NGAYGIOYEUCAU, CONVERT(date, A.NGAYTHUCHIEN, 103) as NGAYYEUCAU1, A.PHONGBANTHUCHIEN_ID as NOIYEUCAU_ID, B.KHOSUDUNG_ID as KHOTHUCHIEN_ID, '' as NOITHUCHIEN_ID, CASE WHEN B.CHUNGTU_ID is null THEN 'CHUAXUAT' ELSE 'DAXUAT' END AS TRANGTHAI, 'TT_PHAUTHUAT_VTYT' as REF_TABLE
      from TT_PHAUTHUAT A
      left join TT_PHAUTHUAT_VTYT B on A.PHAUTHUAT_ID = B.PHAUTHUAT_ID
      left join TT_PHAUTHUAT_YEUCAU C on C.PHAUTHUAT_ID = A.PHAUTHUAT_ID
      left join TT_DVYEUCAU D on C.DVYEUCAU_ID = D.DVYEUCAU_ID and D.TIEPNHAN_ID= '$TIEPNHAN_ID$' and D.DANGKY_ID is null
      where A.TIEPNHAN_ID= '$TIEPNHAN_ID$' and B.DUOC_ID is not null
      union
      select A.XACNHANSUATANCHITIET_ID as REF_ID, B.KHAUPHANAN_ID as DICHVU_ID, B.NGAYCHIDINH as NGAYGIOYEUCAU,CONVERT(date, B.NGAYCHIDINH, 103) as NGAYYEUCAU1
      , B.PHONGBAN_ID as NOIYEUCAU_ID, '' as KHOTHUCHIEN_ID, B.PHONGBAN_ID as NOITHUCHIEN_ID, 'DAXACNHAN' as TRANGTHAI, 'TT_NUT_XACNHANSUATAN_CHITIET' as REF_TABLE
      from TT_NUT_XACNHANSUATAN_CHITIET A
      left join (select A.*, B.PHONGBAN_ID from TT_NUT_CHIDINHKHAUPHAN_CHITIET A
      left join TT_NUT_CHIDINHKHAUPHAN B on B.CHIDINHKHAUPHAN_ID = A.CHIDINHKHAUPHAN_ID and A.BENHAN_ID = '$BENHAN_ID$') B on B.CHIDINHKHAUPHANCHITIET_ID = A.CHIDINHKHAUPHANCHITIET_ID
      ) dv on dv.REF_TABLE = A.REF_TABLE and dv.REF_ID = A.REF_ID and dv.DICHVU_ID = isnull(A.DICHVU_ID, A.DUOC_ID)
      where
      A.TIEPNHAN_ID = '$TIEPNHAN_ID$' and A.BENHVIEN_ID = '$BENHVIEN_ID$' and A.BENHAN_ID = '$BENHAN_ID$'
      and dv.NGAYYEUCAU1 is not null and A.ACTIVE = '1' <!--and A.HUY = '0'-->
      ORDER BY dv.NGAYYEUCAU1 desc
    </statement>
    <statement id="DAO00064_GetVienphiBenhAnNoiTru" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select
      D.KHOAVAO_ID  as PHONGBAN_ID,
      ISNULL(A.DICHVU_ID, A.DUOC_ID) as NOIDUNG_ID, A.REF_ID as IDREF, A.VIENPHI_ID,
      A.SOLUONG as SOLUONG, A.SOLUONG as SOLUONG_NEW, A.DICHVU_ID, A.DUOC_ID,
      A.DONGIA_DOANHTHU, A.DONGIA_DOANHTHU as DONGIADOANHTHU, A.BHYT_DONGIA_CHITRA,
      A.BHYT_DONGIA as DONGIAHOTRO, A.BHYT_THANHTIEN_CHITRA as DONGIAHOTROCHITRA,
      A.REF_TABLE as LOAI, A.BHYT_DONGIA, A.BHYT_THANHTIEN, A.BHYT_THANHTIEN_CHITRA, A.BENHNHAN_PHAITHANHTOAN,
      A.GIATRI_BENHNHAN_DATHANHTOAN, A.BENHVIEN_ID, A.THANHTIEN_DOANHTHU,
      A.LOAI_CHIPHI, A.LOAIGIA_ID, A.REF_TABLE, A.KHAMBENH_ID, A.REF_ID, A.DUOCPHEPTHUCHIEN,
      A.HUY, A.KHONGTHUTIEN, A.DATHANHTOAN, A.HOADON_ID, A.ACTIVE<!--,-->
      <!--B.TOATHUOC_ID as NOITRU_TOATHUOC_ID-->
      from TT_VIENPHI A
      inner join TT_NOITRU_BENHAN D on D.BENHAN_ID = A.BENHAN_ID      
      <!--left join TT_NOITRU_TOATHUOC B on A.TIEPNHAN_ID = B.TIEPNHAN_ID and A.DUOC_ID = B.DUOC_ID and A.KHAMBENH_ID = B.KHAMBENH_ID-->
      where A.BENHAN_ID = '$BENHAN_ID$' and A.BENHVIEN_ID = '$BENHVIEN_ID$' <!--and A.HUY = '0'-->
      and (A.DICHVU_ID is not null and A.DUOC_ID is null)
      and A.KHONGTHUTIEN != '1'
      union
      select
      D.KHOAVAO_ID  as PHONGBAN_ID,
      ISNULL(A.DICHVU_ID, A.DUOC_ID) as NOIDUNG_ID, A.REF_ID as IDREF, A.VIENPHI_ID,
      A.SOLUONG as SOLUONG, A.SOLUONG as SOLUONG_NEW, A.DICHVU_ID, A.DUOC_ID,
      A.DONGIA_DOANHTHU, A.DONGIA_DOANHTHU as DONGIADOANHTHU, A.BHYT_DONGIA_CHITRA,
      A.BHYT_DONGIA as DONGIAHOTRO, A.BHYT_THANHTIEN_CHITRA as DONGIAHOTROCHITRA,
      A.REF_TABLE as LOAI, A.BHYT_DONGIA, A.BHYT_THANHTIEN, A.BHYT_THANHTIEN_CHITRA, A.BENHNHAN_PHAITHANHTOAN,
      A.GIATRI_BENHNHAN_DATHANHTOAN, A.BENHVIEN_ID, A.THANHTIEN_DOANHTHU,
      A.LOAI_CHIPHI, A.LOAIGIA_ID, A.REF_TABLE, A.KHAMBENH_ID, A.REF_ID, A.DUOCPHEPTHUCHIEN,
      A.HUY, A.KHONGTHUTIEN, A.DATHANHTOAN, A.HOADON_ID, A.ACTIVE<!--,-->
      <!--B.TOATHUOC_ID as NOITRU_TOATHUOC_ID-->
      from TT_VIENPHI A
      inner join TT_NOITRU_BENHAN D on D.BENHAN_ID = A.BENHAN_ID
      inner join TT_NOITRU_TOATHUOC B on A.TIEPNHAN_ID = B.TIEPNHAN_ID and A.REF_ID = B.TOATHUOC_ID
      where A.BENHAN_ID = '$BENHAN_ID$' and A.BENHVIEN_ID = '$BENHVIEN_ID$' <!--and A.HUY = '0'-->
      and (A.DICHVU_ID is null and A.DUOC_ID is not null)
      and A.KHONGTHUTIEN != '1'
    </statement>
    <statement id="DAO00064_GetListBenhNhanNgoaiTru2NoiTru" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select distinct
      A.HUONGGIAIQUYET_ID, A.CHANDOANKHOAKHAM as CHANDOAN, A.PHONGBAN_ID, A.CHANDOANICD_ID as MABENH, A.CHANDOANPHUICD_ID as BENHKHAC,
      B.SOBHYT, B.NGAYTIEPNHAN , B.THOIGIANTIEPNHAN as NGAYVAO, B.SOTIEPNHAN, B.DOITUONG_ID, B.TIEPNHAN_ID,
      C.MAYTE as MABN, C.TENBENHNHAN as TENBN, C.NAMSINH , C.BENHNHAN_ID, B.BENHVIEN_ID, D.BENHAN_ID, D.SOBENHAN, B.TRAITUYEN, B.NGAYMIENDONGCHITRA,
      D.LOAIBENHAN
      from TT_TIEPNHAN B
      left join TT_BENHNHAN C on B.BENHNHAN_ID = C.BENHNHAN_ID
      left join TT_NGOAITRU_KHAMBENH A on B.TIEPNHAN_ID = A.TIEPNHAN_ID
      left join TT_NOITRU_BENHAN D on D.TIEPNHAN_ID = B.TIEPNHAN_ID and D.SOBENHAN is not NULL
      left join (select count(*) as NUMOFVP, TIEPNHAN_ID, BENHAN_ID from TT_VIENPHI where BENHAN_ID is null and THANHTIEN_DOANHTHU &#62; 0 group by TIEPNHAN_ID, BENHAN_ID) E on E.TIEPNHAN_ID = A.TIEPNHAN_ID
      where
      (B.SOBHYT is not null and B.SOBHYT != '')
      and E.NUMOFVP is not null
      and E.BENHAN_ID is null  and
      (B.TRANGTHAI = 'NOITRU' or B.TRANGTHAI = 'CAPCUU' or B.TRANGTHAI='NGOAITRU')
      <isNotEmpty prepend="and" property="TUNGAY">
        B.NGAYTIEPNHAN &#62;&#61; '$TUNGAY$'
      </isNotEmpty>
      <isNotEmpty prepend="and" property="DENNGAY">
        B.NGAYTIEPNHAN &#60;&#61; '$DENNGAY$'
      </isNotEmpty>
      <!--(B.NGAYTIEPNHAN BETWEEN '$TUNGAY$' AND '$DENNGAY$')-->
      and B.BENHVIEN_ID = '$BENHVIEN_ID$'      
      <isNotEmpty prepend="and" property="MABENHNHAN">
        C.MAYTE = '$MABENHNHAN$'
      </isNotEmpty>           
      order by B.SOTIEPNHAN desc
    </statement>
    <statement id="DAO00064_GetListBenhNhanCapCuu2NoiTru" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select distinct
      B.SOBHYT, B.NGAYTIEPNHAN ,  D.THOIGIANVAOKHOA as NGAYVAO, B.SOTIEPNHAN, B.DOITUONG_ID, B.TIEPNHAN_ID,
      C.MAYTE as MABN, C.TENBENHNHAN as TENBN, C.NAMSINH , C.BENHNHAN_ID, B.BENHVIEN_ID, D.BENHAN_ID, D.SOBENHAN, B.TRAITUYEN, B.NGAYMIENDONGCHITRA,
      D.LOAIBENHAN, D.SOCAPCUU, D.BENHAN_CAPCUU
      from TT_TIEPNHAN B
      left join TT_BENHNHAN C on B.BENHNHAN_ID = C.BENHNHAN_ID
      left join (select A.*, B.BENHAN_ID as BENHAN_CAPCUU from TT_NOITRU_BENHAN A
      left join (select * from TT_NOITRU_BENHAN where LOAIBENHAN = '1' and TRANGTHAI = 'DAXUATVIEN') B on B.SOCAPCUU = A.SOCAPCUU
      where A.LOAIBENHAN = '3' and A.SOCAPCUU is not null) D on D.TIEPNHAN_ID = B.TIEPNHAN_ID
      left join (select count(*) as NUMOFVP, TIEPNHAN_ID, BENHAN_ID from TT_VIENPHI where BENHAN_ID is not null and THANHTIEN_DOANHTHU > 0 group by TIEPNHAN_ID, BENHAN_ID)
      E on E.BENHAN_ID = D.BENHAN_CAPCUU
      where B.TRANGTHAI = 'NOITRU' and D.SOCAPCUU is not null
      and E.NUMOFVP is not null
      and E.BENHAN_ID is not null
      <isNotEmpty prepend="and" property="TUNGAY">
        D.NGAYVAOKHOA &#62;&#61; '$TUNGAY$'
      </isNotEmpty>
      <isNotEmpty prepend="and" property="DENNGAY">
        D.NGAYVAOKHOA &#60;&#61; '$DENNGAY$'
      </isNotEmpty>
      <!--(B.NGAYTIEPNHAN BETWEEN '$TUNGAY$' AND '$DENNGAY$')-->
      and B.BENHVIEN_ID = '$BENHVIEN_ID$'
      <isNotEmpty prepend="and" property="MABENHNHAN">
        C.MAYTE = '$MABENHNHAN$'
      </isNotEmpty>
      order by B.SOTIEPNHAN desc
    </statement>
    <statement id="DAO00064_Add" parameterClass="System.Collections.IDictionary" resultClass="System.Int64">
      insert into TT_XACNHANCHIPHI (
      SOXACNHAN
      , TIEPNHAN_ID
      , BENHAN_ID
      , KHAMBENH_ID
      , BENHNHAN_ID
      , DOITUONG_ID
      , SOBHYT
      , NGAYVAO
      , NGAYRA
      , NGAYKHAM
      , CHANDOAN
      , LOAI
      , NGAYXACNHAN
      , BENHVIEN_ID
      , IDCHUYEN
      , IDCHUYENHUY
      , IDCHUYENHOAN
      , TUYENKHAMBENH
      , THOIGIANXACNHAN
      , NGAYXUATTHUOC
      , NOIXACNHAN_ID
      , MABENH
      , BENHKHAC
      , TENPHONGKHAM
      , NGAYTAO
      , NGUOITAO_ID
      , NGAYCAPNHAT
      , NGUOICAPNHAT_ID
      ) values (
      #SOXACNHAN#
      , #TIEPNHAN_ID#
      , #BENHAN_ID#
      , #KHAMBENH_ID#
      , #BENHNHAN_ID#
      , #DOITUONG_ID#
      , #SOBHYT#
      , #NGAYVAO#
      , #NGAYRA#
      , #NGAYKHAM#
      , #CHANDOAN#
      , #LOAI#
      , #NGAYXACNHAN#
      , #BENHVIEN_ID#
      , #IDCHUYEN#
      , #IDCHUYENHUY#
      , #IDCHUYENHOAN#
      , #TUYENKHAMBENH#
      , #THOIGIANXACNHAN#
      , #NGAYXUATTHUOC#
      , #NOIXACNHAN_ID#
      , #MABENH#
      , #BENHKHAC#
      , #TENPHONGKHAM#
      , #NGAYTAO#
      , #NGUOITAO_ID#
      , #NGAYCAPNHAT#
      , #NGUOICAPNHAT_ID#
      )
      SELECT SCOPE_IDENTITY()
      <!--<selectKey resultClass="System.Int64" type="post" >
        SELECT @@IDENTITY as value
      </selectKey>-->
    </statement>
    <update id="DAO00064_Update" parameterClass="System.Collections.IDictionary">
      update TT_XACNHANCHIPHI set
      SOXACNHAN = #SOXACNHAN#
      , TIEPNHAN_ID = #TIEPNHAN_ID#
      , BENHAN_ID = #BENHAN_ID#
      , KHAMBENH_ID = #KHAMBENH_ID#
      , BENHNHAN_ID = #BENHNHAN_ID#
      , DOITUONG_ID = #DOITUONG_ID#
      , SOBHYT = #SOBHYT#
      , NGAYVAO = #NGAYVAO#
      , NGAYRA = #NGAYRA#
      , NGAYKHAM = #NGAYKHAM#
      , CHANDOAN = #CHANDOAN#
      , LOAI = #LOAI#
      , NGAYXACNHAN = #NGAYXACNHAN#
      , BENHVIEN_ID = #BENHVIEN_ID#
      , IDCHUYEN = #IDCHUYEN#
      , IDCHUYENHUY = #IDCHUYENHUY#
      , IDCHUYENHOAN = #IDCHUYENHOAN#
      , TUYENKHAMBENH = #TUYENKHAMBENH#
      , THOIGIANXACNHAN = #THOIGIANXACNHAN#
      , NGAYXUATTHUOC = #NGAYXUATTHUOC#
      , NOIXACNHAN_ID = #NOIXACNHAN_ID#
      , MABENH = #MABENH#
      , BENHKHAC = #BENHKHAC#
      , TENPHONGKHAM = #TENPHONGKHAM#
      <!--, NGAYTAO = #NGAYTAO#
      , NGUOITAO_ID = #NGUOITAO_ID#-->
      , NGAYCAPNHAT = #NGAYCAPNHAT#
      , NGUOICAPNHAT_ID = #NGUOICAPNHAT_ID#
      where
      XACNHANCHIPHI_ID = '$XACNHANCHIPHI_ID$'
    </update>
    <statement id="DAO00064_Add_Chitiet" parameterClass="System.Collections.IDictionary" resultClass="System.Int64">
      insert into TT_XACNHANCHIPHICHITIET (
      XACNHANCHIPHI_ID
      , VIENPHI_ID
      , IDREF
      , NOIDUNG_ID
      , NOIDUNG
      , SOLUONG
      , DONGIADOANHTHU
      , DONGIAHOTRO
      , DONGIAHOTROCHITRA
      , DONGIATHANHTOAN     
      , LOAI
      , NGAYCAPNHAT
      , NGUOICAPNHAT_ID
      , PHONGBAN_ID
      , NGOAITRU_TOATHUOC_ID
      , NOITRU_TOATHUOC_ID
      , BENHVIEN_ID
      ) values (
      #XACNHANCHIPHI_ID#
      , #VIENPHI_ID#
      , #IDREF#
      , #NOIDUNG_ID#
      , #NOIDUNG#
      , #SOLUONG#
      , #DONGIADOANHTHU#
      , #DONGIAHOTRO#
      , #DONGIAHOTROCHITRA#     
      , #DONGIAHOTROCHITRA_NEW#
      , #LOAI#
      , #NGAYCAPNHAT#
      , #NGUOICAPNHAT_ID#
      , #PHONGBAN_ID#
      , #NGOAITRU_TOATHUOC_ID#
      , #NOITRU_TOATHUOC_ID#
      , #BENHVIEN_ID#
      )
      SELECT SCOPE_IDENTITY()
      <!--<selectKey resultClass="System.Int64" type="post" >
        SELECT @@IDENTITY as value
      </selectKey>-->
    </statement>
    <update id="DAO00064_Update_Chitiet" parameterClass="System.Collections.IDictionary">
      update TT_XACNHANCHIPHICHITIET set
      XACNHANCHIPHI_ID = #XACNHANCHIPHI_ID#
      , VIENPHI_ID = #VIENPHI_ID#
      <!--, LOAI_IDREF = #LOAI_IDREF#-->
      , IDREF = #IDREF#
      , NOIDUNG_ID = #NOIDUNG_ID#
      , NOIDUNG = #NOIDUNG#
      , SOLUONG = #SOLUONG#
      , DONGIADOANHTHU = #DONGIADOANHTHU#
      , DONGIAHOTRO = #DONGIAHOTRO#
      , DONGIAHOTROCHITRA = #DONGIAHOTROCHITRA#
      , DONGIATHANHTOAN = #DONGIATHANHTOAN#
      <!--, SOLUONG_NEW = #SOLUONG_NEW#
      , DONGIAHOTROCHITRA_NEW = #DONGIAHOTROCHITRA_NEW#-->
      , LOAI = #LOAI#
      , NGAYCAPNHAT = #NGAYCAPNHAT#
      , NGUOICAPNHAT_ID = #NGUOICAPNHAT_ID#
      , PHONGBAN_ID = #PHONGBAN_ID#
      , NGOAITRU_TOATHUOC_ID = #NGOAITRU_TOATHUOC_ID#
      , NOITRU_TOATHUOC_ID = #NOITRU_TOATHUOC_ID#
      , BENHVIEN_ID = #BENHVIEN_ID#
      where
      XACNHANCHIPHICHITIET_ID = '$XACNHANCHIPHICHITIET_ID$'
    </update>
    <statement id="DAO00064_Delete" parameterClass="System.Collections.IDictionary" resultClass="System.Int32">
      delete from TT_XACNHANCHIPHICHITIET
      where XACNHANCHIPHI_ID in
      (select XACNHANCHIPHI_ID from TT_XACNHANCHIPHI where TIEPNHAN_ID = '$TIEPNHAN_ID$');
      delete from TT_XACNHANCHIPHI where TIEPNHAN_ID = '$TIEPNHAN_ID$';
    </statement>

    <!--============================================================================
//CONG NO NOI TRU
//===========================================================================-->
    <statement id="DAO00064_GetListCongNoNoiTru" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select
      ntba.BENHAN_ID, ntba.TIEPNHAN_ID, ntba.SOBENHAN, ntba.NGAYVAOKHOA as NGAYVAOVIEN,
      tn.SOBHYT, tn.SOTIEPNHAN,
      bn.MAYTE, bn.TENBENHNHAN,
      dt.TENDOITUONG, gb.MAGIUONG, pb.TENPHONGBAN as TENKHOA, pb.MAPHONGBAN,
      tu.TAMUNG, hu.HOANUNG,cth.DICHVU_CHUATHUCHIEN,
      vp.CHIPHITHANHTOAN, vp.BENHNHANTHANHTOAN, vp.BHYTCHITRA<!--, vp.CHENHLECH-->
      , ntba.LOAIBENHAN
      from  TT_NOITRU_BENHAN ntba
      left join TT_BENHNHAN bn on bn.BENHNHAN_ID = ntba.BENHNHAN_ID
      left join TT_TIEPNHAN tn on tn.TIEPNHAN_ID = ntba.TIEPNHAN_ID and ntba.BENHNHAN_ID = tn.BENHNHAN_ID
      inner join TM_DOITUONG dt on tn.DOITUONG_ID = dt.DOITUONG_ID
      inner join TM_PHONGBAN pb on pb.PHONGBAN_ID = ntba.KHOACHUYENDEN_ID
      left join
      (
      select ntltct.GIUONGBENH_ID, ntlt.BENHAN_ID
      from TT_NOITRU_LUUTRU ntlt
      left join TT_NOITRU_LUUTRUCHITIET ntltct on ntlt.LUUTRU_ID = ntltct.LUUTRU_ID
      where ntlt.LUUTRU_CURRENT = '1' and ntltct.LUUTRUCHITIET_CURRENT = '1' and ntlt.BENHVIEN_ID = '$BENHVIEN_ID$'
      ) as lt on lt.BENHAN_ID = ntba.BENHAN_ID
      left join TM_GIUONGBENH gb on GB.GIUONGBENH_ID = lt.GIUONGBENH_ID
      left join
      (
      SELECT BENHAN_ID, SUM(GIATRITHUCTHU) AS TAMUNG
      FROM TT_HOADON WHERE LOAIHOADON ='TU'and (TRANGTHAI = 'DATHUTIEN' or TRANGTHAI = 'CHODUYET'  or TRANGTHAI = 'DADUYET') and BENHAN_ID is not null and HUYHOADON = 0 and BENHVIEN_ID = '$BENHVIEN_ID$'
      GROUP BY BENHAN_ID
      ) tu on tu.BENHAN_ID = ntba.BENHAN_ID
      left join
      (
      SELECT BENHAN_ID, SUM(GIATRIHOADON) AS HOANUNG
      FROM TT_HOADON WHERE LOAIHOADON ='HU' and BENHAN_ID is not null and BENHVIEN_ID = '$BENHVIEN_ID$' GROUP BY BENHAN_ID
      ) hu on hu.BENHAN_ID = ntba.BENHAN_ID
      left join
      (
      select BENHAN_ID, SUM(THANHTIEN_DOANHTHU) as CHIPHITHANHTOAN,
      sum(GIATRI_BENHNHAN_DATHANHTOAN) as BENHNHANTHANHTOAN,
      <!--(SUM(BENHNHAN_PHAITHANHTOAN) - sum(GIATRI_BENHNHAN_DATHANHTOAN)) as CHENHLECH ,-->
      sum (BHYT_THANHTIEN_CHITRA) as BHYTCHITRA
      from TT_VIENPHI where BENHAN_ID is not null and BENHVIEN_ID = '$BENHVIEN_ID$' and ACTIVE = '1' GROUP BY BENHAN_ID
      ) vp on vp.BENHAN_ID = ntba.BENHAN_ID

      left join
      (
      select vp.BENHAN_ID, vp.TIEPNHAN_ID, sum(vp.BENHNHAN_PHAITHANHTOAN) as DICHVU_CHUATHUCHIEN
      from TT_VIENPHI vp
      left join TT_DVYEUCAU dv on vp.TIEPNHAN_ID = dv.TIEPNHAN_ID and vp.REF_ID = dv.DVYEUCAU_ID
      where vp.BENHAN_ID is not null and REF_TABLE = 'TT_DVYEUCAU' and dv.TRANGTHAI = 'CHUAKETQUA' and vp.BENHVIEN_ID = '$BENHVIEN_ID$' and vp.ACTIVE = '1' GROUP BY vp.BENHAN_ID, vp.TIEPNHAN_ID
      ) cth on cth.BENHAN_ID = ntba.BENHAN_ID
      where
      ntba.KHOACHUYENDEN_ID IN ($LIST_KHOADIEUTRI_ID$) and ntba.BENHVIEN_ID = '$BENHVIEN_ID$'
      <isNotEmpty prepend="and" property="TUNGAY">
        ntba.NGAYVAOKHOA &#62;&#61; '$TUNGAY$'
      </isNotEmpty>
      <isNotEmpty prepend="and" property="DENNGAY">
        ntba.NGAYVAOKHOA &#60;&#61; '$DENNGAY$'
      </isNotEmpty>
      AND ntba.TRANGTHAI = '$TRANGTHAI$'
      <isNotEmpty prepend="and" property="TENBENHNHAN">
        (bn.TENBENHNHAN like N'%$TENBENHNHAN$%' or bn.MAYTE like N'%$TENBENHNHAN$%')
      </isNotEmpty> 

      <!--SELECT BA.*
      , case
      when BA.TRANGTHAI = 'DATHANHTOAN' then 0
      else PTT.CHIPHITHANHTOAN
      end CHIPHITHANHTOAN

      , case
      when BA.TRANGTHAI = 'DATHANHTOAN' then 0
      else TU.TAMUNG
      end TAMUNG

      , case
      when BA.TRANGTHAI = 'DATHANHTOAN' then 0
      else TU.TAMUNG - PTT.CHIPHITHANHTOAN
      end CHENHLECH

      , case
      when BA.TRANGTHAI = 'DATHANHTOAN' then 0
      else HU.HOANUNG
      end HOANUNG

      , GB.MAGIUONG
      FROM
      ( SELECT BA.TIEPNHAN_ID, BA.BENHAN_ID, BA.SOBENHAN, BN.TENBENHNHAN, PB.TENPHONGBAN AS TENKHOA,
      BA.NGAYVAOVIEN, BN.MAYTE, TN.SOBHYT, DT.TENDOITUONG, BA.TRANGTHAI
      FROM
      TT_NOITRU_BENHAN BA,
      TT_BENHNHAN BN,
      TM_PHONGBAN PB,
      TT_TIEPNHAN TN,
      TM_DOITUONG DT
      WHERE
      BA.BENHNHAN_ID = BN.BENHNHAN_ID
      AND (BA.KHOACHUYENDEN_ID = PB.PHONGBAN_ID or (BA.KHOAVAO_ID = PB.PHONGBAN_ID and BA.KHOACHUYENDEN_ID is null))
      AND BA.TIEPNHAN_ID = TN.TIEPNHAN_ID
      AND TN.DOITUONG_ID = DT.DOITUONG_ID
      AND PB.PHONGBAN_ID IN ($LIST_KHOADIEUTRI_ID$)
      <isNotEmpty prepend="and" property="TUNGAY">
          BA.NGAYVAOKHOA &#62;&#61; '$TUNGAY$'
      </isNotEmpty>
      <isNotEmpty prepend="and" property="DENNGAY">
        BA.NGAYVAOKHOA &#60;&#61; '$DENNGAY$'
      </isNotEmpty>
      AND BA.TRANGTHAI = '$TRANGTHAI$'
      <isNotEmpty prepend="and" property="TENBENHNHAN">
        (BN.TENBENHNHAN like N'%$TENBENHNHAN$%' or BN.MAYTE like N'%$TENBENHNHAN$%')
      </isNotEmpty>
      )BA
      left join TT_NOITRU_LUUTRU LT on LT.BENHAN_ID = BA.BENHAN_ID and LT.LUUTRU_CURRENT = '1'
      left join TT_NOITRU_LUUTRUCHITIET LTCT on LTCT.LUUTRU_ID = LT.LUUTRU_ID and ltct.LUUTRUCHITIET_CURRENT = '1'
      left join TM_GIUONGBENH GB on GB.GIUONGBENH_ID = LTCT.GIUONGBENH_ID
      left join (SELECT TIEPNHAN_ID, SUM(BENHNHAN_PHAITHANHTOAN) AS CHIPHITHANHTOAN
      FROM TT_VIENPHI where BENHAN_ID is not null and DATHANHTOAN = '0' GROUP BY TIEPNHAN_ID) PTT on BA.TIEPNHAN_ID = PTT.TIEPNHAN_ID
      left join (SELECT TIEPNHAN_ID, SUM(GIATRITHUCTHU) AS TAMUNG
      FROM TT_HOADON WHERE LOAIHOADON ='TU'and TRANGTHAI = 'DATHUTIEN' and HUYHOADON = 0
      GROUP BY TIEPNHAN_ID) TU on TU.TIEPNHAN_ID = BA.TIEPNHAN_ID
      left join (SELECT TIEPNHAN_ID, SUM(GIATRIHOADON) AS HOANUNG
      FROM TT_HOADON WHERE LOAIHOADON ='HU' GROUP BY TIEPNHAN_ID) HU on HU.TIEPNHAN_ID = BA.TIEPNHAN_ID
      order by BA.NGAYVAOVIEN DESC-->
    </statement>
    <statement id="DAO00064_GetThongTinGiuongCHoCongNo" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select * from TT_NOITRU_LUUTRUCHITIET
      where LUUTRU_ID in (select top 1 LUUTRU_ID from TT_NOITRU_LUUTRU
      where LUUTRU_CURRENT = '1' and BENHAN_ID = '$BENHAN_ID$' order by LUUTRU_ID desc)
    </statement>
    <statement id="DAO00064_GetThongTinBenhAnTamUng" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      SELECT BENHAN_ID, GIATRITHUCTHU, NGAYHOADON
      FROM TT_HOADON WHERE
      LOAIHOADON ='TU'and
      (TRANGTHAI != 'CHUATHUTIEN' and TRANGTHAI != 'DAHOANUNG') and
      BENHAN_ID is not null and
      HUYHOADON = 0 and
      BENHAN_ID = '$BENHAN_ID$' and
      BENHVIEN_ID = '$BENHVIEN_ID$'
    </statement>
    
    <!--============================================================================
//CAP NHAT DOI TUONG/GIA
//===========================================================================-->
  <statement id="DAO00064_GetDOITUONG" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
    SELECT TOP 1
    DT.TENDOITUONG,
    BHYT.SOTHE,
    BHYT.NGAYHIEULUC,
    BHYT.NGAYHETHIEULUC,
    BHYT.BENHVIEN_KCB_ID AS MABENHVIEN,
    BV.TENBENHVIEN,
    BHYT.NGAYMIENDONGCHITRA,
    BHYT.TREN5NAM

    FROM TT_BENHNHAN_BHYT BHYT, TM_DOITUONG DT, TM_BENHVIEN BV
    WHERE
    DT.NHOMTHE LIKE '%' + LEFT(BHYT.SOTHE,3) + '%'
    AND BHYT.BENHNHAN_ID = '$BENHNHAN_ID$'
    AND BHYT.BENHVIEN_KCB_ID = BV.MABENHVIEN
    ORDER BY BHYT.NGAYTAO DESC
  </statement>
    
    <statement id="DAO00064_GetNgayDangKyDichVu" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      SELECT
      DISTINCT CONVERT(date, NGAYTAO) as NGAYCHIPHI
      FROM TT_VIENPHI
      WHERE
      TIEPNHAN_ID = '$TIEPNHAN_ID$'
      <isNotEmpty prepend="and" property="BENHAN_ID">
        BENHAN_ID = '$BENHAN_ID$'
      </isNotEmpty>
      ORDER BY NGAYCHIPHI
    </statement>

    <statement id="DAO00064_GetLoaiGiaDichVu" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      <!--select lg.LOAIGIA_ID, lg.TENLOAIGIA, lg.MALOAIGIA
      from TM_LOAIGIA lg
      inner join LST_DICTIONARY dic on lg.NHOMGIA_ID = dic.DICTIONARY_ID
      where
      lg.TAMNGUNG = 0
      and dic.DICTIONARY_TYPE_CODE = 'NhomGia'
      and lg.MALOAIGIA like 'GiaDichVu%'-->

      select lg.LOAIGIA_ID, lg.TENLOAIGIA, lg.MALOAIGIA
      from TM_LOAIGIA lg
      where
      lg.TAMNGUNG = 0
      and lg.CAPTREN_ID = (select LOAIGIA_ID from TM_LOAIGIA
      where MALOAIGIA = 'GiaDichVu'
      and BENHVIEN_ID = '$BENHVIEN_ID$')
      and lg.BENHVIEN_ID = '$BENHVIEN_ID$'
    </statement>

    <statement id="DAO00064_GetLoaiGiaThuoc" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      <!--select lg.LOAIGIA_ID, lg.TENLOAIGIA, lg.MALOAIGIA, dic.DICTIONARY_CODE
      from TM_LOAIGIA lg
      inner join LST_DICTIONARY dic on lg.NHOMGIA_ID = dic.DICTIONARY_ID
      where
      lg.TAMNGUNG = 0
      and dic.DICTIONARY_TYPE_CODE = 'NhomGia'
      and lg.MALOAIGIA like 'GiaThuoc%'-->

      <!--select lg.LOAIGIA_ID, lg.TENLOAIGIA, lg.MALOAIGIA
      from TM_LOAIGIA lg
      where
      lg.TAMNGUNG = 0
      and lg.CAPTREN_ID = (select LOAIGIA_ID from TM_LOAIGIA
      where MALOAIGIA = 'GiaThuoc'
      and BENHVIEN_ID = '$BENHVIEN_ID$')
      and lg.BENHVIEN_ID = '$BENHVIEN_ID$'-->

      select C.LOAIGIA_ID, C.TENLOAIGIA, C.MALOAIGIA from
      TM_DOITUONG_LOAIGIA A
      inner join TM_LOAIGIA C on A.LOAIGIA_ID = C.LOAIGIA_ID and C.BENHVIEN_ID = '$BENHVIEN_ID$'
      where C.CAPTREN_ID = (select LOAIGIA_ID from TM_LOAIGIA
      where MALOAIGIA = 'GiaThuoc'          and BENHVIEN_ID = '$BENHVIEN_ID$')
      and A.DOITUONG_ID = '$DOITUONG_ID$' and (A.GIAHOTRO = '0')
    </statement>
    <statement id="DAO00064_GetLoaiGiaThuocMKT" parameterClass="System.Collections.IDictionary" resultClass="DataObject">  
      select lg.LOAIGIA_ID, lg.TENLOAIGIA, lg.MALOAIGIA
      from TM_LOAIGIA lg
      where
      lg.TAMNGUNG = 0
      and lg.CAPTREN_ID = (select LOAIGIA_ID from TM_LOAIGIA
      where MALOAIGIA = 'GiaThuoc'
      and BENHVIEN_ID = '$BENHVIEN_ID$')
      and lg.BENHVIEN_ID = '$BENHVIEN_ID$'
    </statement>
    <statement id="DAO00064_GetLoaiGiaGiuong" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      <!--select lg.LOAIGIA_ID, lg.TENLOAIGIA, lg.MALOAIGIA, dic.DICTIONARY_CODE
      from TM_LOAIGIA lg
      inner join LST_DICTIONARY dic on lg.NHOMGIA_ID = dic.DICTIONARY_ID
      where
      lg.TAMNGUNG = 0
      and dic.DICTIONARY_TYPE_CODE = 'NhomGia'
      and lg.MALOAIGIA like 'GiaGiuong%'-->

      <!--select lg.LOAIGIA_ID, lg.TENLOAIGIA, lg.MALOAIGIA
      from TM_LOAIGIA lg
      where
      lg.TAMNGUNG = 0
      and lg.CAPTREN_ID = (select LOAIGIA_ID from TM_LOAIGIA
      where MALOAIGIA = 'GiaGiuong'
      and BENHVIEN_ID = '$BENHVIEN_ID$')
      and lg.BENHVIEN_ID = '$BENHVIEN_ID$'-->

      select C.LOAIGIA_ID, C.TENLOAIGIA, C.MALOAIGIA from
      TM_DOITUONG_LOAIGIA A
      inner join TM_LOAIGIA C on A.LOAIGIA_ID = C.LOAIGIA_ID and C.BENHVIEN_ID = '$BENHVIEN_ID$'
      where C.CAPTREN_ID = (select LOAIGIA_ID from TM_LOAIGIA
      where MALOAIGIA = 'GiaGiuong'          and BENHVIEN_ID = '$BENHVIEN_ID$')
      and A.DOITUONG_ID = '$DOITUONG_ID$' and (A.GIAHOTRO = '0')
    </statement>

    <!--============================================================================
//TT_MIENGIAM
//===========================================================================-->
    <statement id="DAO00064_TT_VIENPHI_GetList" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select distinct a.*, b.TINHTRANG AS TINHTRANG_MG, d.TINHTRANG_BHTN, e.TINHTRANG_MGCT
      , b.MIENGIAMCHITIET_ID, b.GIATRIMIENGIAM, e.GIATRIMIENGIAM_CONGTY, e.GIATRIMIENGIAM_CONGTY as GIATRIMIENGIAM_CTCT, f.GIATRIMIENGIAM_THANHVIEN
      , c.DVKEMTHEO, c.DVKEMTHEO_KHACEKIP, c.NOIYEUCAU_ID, c.NOITHUCHIEN_ID, c.DVYEUCAU_ID, c.HUYYEUCAU, c.DANGKY_ID
      from
      (select VP.*
      from TT_VIENPHI VP
      where VP.GIATRI_BENHNHAN_DATHANHTOAN = 0
        <isNotEmpty prepend="and" property="TIEPNHAN_ID">
          VP.TIEPNHAN_ID = '$TIEPNHAN_ID$'
        </isNotEmpty>
      <isNotEmpty prepend="and" property="BENHAN_ID">
        VP.BENHAN_ID = '$BENHAN_ID$'
      </isNotEmpty>
        <isNotEmpty prepend="and" property="BENHVIEN_ID">
          VP.BENHVIEN_ID = '$BENHVIEN_ID$'
        </isNotEmpty>
        <isNotEmpty prepend="and" property="LISTDATE">
          CONVERT(date, NGAYTAO) IN ($LISTDATE$)
        </isNotEmpty>
      <!--TT_VIENPHI-->
      )a left join
      
      <!--TT_MIENGIAM-->
      (
      select VIENPHI_ID, MG.TINHTRANG, MGCT.MIENGIAMCHITIET_ID, MGCT.GIATRIMIENGIAM
      from TT_MIENGIAM MG INNER JOIN TT_MIENGIAM_CHITIET MGCT ON MG.MIENGIAM_ID = MGCT.MIENGIAM_ID
      where
      MG.TIEPNHAN_ID= '$TIEPNHAN_ID$' and MGCT.REF_TABLE = 'TT_MIENGIAM'
      )b
      on a.VIENPHI_ID = b.VIENPHI_ID

      left join(
      select VIENPHI_ID, MG.TINHTRANG AS TINHTRANG_BHTN
      from TT_MIENGIAM_BHTN MG INNER JOIN TT_MIENGIAM_CHITIET MGCT ON MG.MIENGIAM_BHTN_ID = MGCT.MIENGIAM_ID
      where
      MG.TIEPNHAN_ID= '$TIEPNHAN_ID$' and MGCT.REF_TABLE = 'TT_MIENGIAM_BHTN'
      )d
      on a.VIENPHI_ID = d.VIENPHI_ID

      left join(
      select VIENPHI_ID, MG.TINHTRANG AS TINHTRANG_MGCT, MGCT.GIATRIMIENGIAM as GIATRIMIENGIAM_CONGTY
      from TT_MIENGIAM_CONGTY MG INNER JOIN TT_MIENGIAM_CHITIET MGCT ON MG.MIENGIAM_CONGTY_ID = MGCT.MIENGIAM_ID
      where
      MG.TIEPNHAN_ID= '$TIEPNHAN_ID$' and MGCT.REF_TABLE = 'TT_MIENGIAM_CONGTY'
      )e
      on a.VIENPHI_ID = e.VIENPHI_ID

      left join(
      select VIENPHI_ID, MG.TINHTRANG AS TINHTRANG_MGCT, MGCT.GIATRIMIENGIAM as GIATRIMIENGIAM_THANHVIEN
      from TT_MIENGIAM_THANHVIEN MG INNER JOIN TT_MIENGIAM_CHITIET MGCT ON MG.MIENGIAM_THANHVIEN_ID = MGCT.MIENGIAM_ID
      where
      MG.TIEPNHAN_ID= '$TIEPNHAN_ID$' and MGCT.REF_TABLE = 'TT_MIENGIAM_THANHVIEN'
      )f
      on a.VIENPHI_ID = f.VIENPHI_ID

      left join
      (
      select DVYEUCAU_ID, TRANGTHAI, BHYTDONGTIEN, HUYYEUCAU, DVKEMTHEO, DVKEMTHEO_KHACEKIP, NOIYEUCAU_ID, NOITHUCHIEN_ID, DANGKY_ID from TT_DVYEUCAU
      where TIEPNHAN_ID = '$TIEPNHAN_ID$'
      )c on c.DVYEUCAU_ID = a.REF_ID
      where 
      c.HUYYEUCAU = '0' or c.HUYYEUCAU is null      
    </statement>
    <statement id="DAO00064_TT_VIENPHI_CheckList" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select  a.*, b.TINHTRANG AS TINHTRANG_MG, d.TINHTRANG_BHTN, e.TINHTRANG_MGCT
      <!--, c.BHYTDONGTIEN-->
      , b.MIENGIAMCHITIET_ID, b.GIATRIMIENGIAM, e.GIATRIMIENGIAM_CONGTY, e.GIATRIMIENGIAM_CONGTY as GIATRIMIENGIAM_CTCT, f.GIATRIMIENGIAM_THANHVIEN
      , c.DVKEMTHEO, c.DVKEMTHEO_KHACEKIP, c.NOIYEUCAU_ID, c.NOITHUCHIEN_ID, c.DVYEUCAU_ID, c.HUYYEUCAU

      <!--TT_VIENPHI-->
      from
      (
      select VP.*
      from TT_VIENPHI VP
      where VP.BENHNHAN_PHAITHANHTOAN &gt;= 0
      <isParameterPresent>
        <isNotEmpty prepend="and" property="LIST_VIENPHI">
          VP.VIENPHI_ID in ($LIST_VIENPHI$)
        </isNotEmpty>
        <isNotEmpty prepend="and" property="LIST_BENHNHAN_PHAITHANHTOAN">
          VP.BENHNHAN_PHAITHANHTOAN in ($LIST_BENHNHAN_PHAITHANHTOAN$)
        </isNotEmpty>
        <isNotEmpty prepend="and" property="VIENPHI_ID">
          VP.VIENPHI_ID = '$VIENPHI_ID$'
        </isNotEmpty>
        <isNotEmpty prepend="and" property="TIEPNHAN_ID">
          VP.TIEPNHAN_ID = '$TIEPNHAN_ID$'
        </isNotEmpty>
        <isNotEmpty prepend="and" property="BENHAN_ID">
          VP.BENHAN_ID = '$BENHAN_ID$'
        </isNotEmpty>
        <isNotEmpty prepend="and" property="REF_ID">
          VP.REF_ID = '$REF_ID$'
        </isNotEmpty>
        <isNotEmpty prepend="and" property="REF_TABLE">
          VP.REF_TABLE = '$REF_TABLE$'
        </isNotEmpty>
        <isNotEmpty prepend="and" property="DICHVU_ID">
          VP.DICHVU_ID is NULL
        </isNotEmpty>
        <isNotEmpty prepend="and" property="DUOC_ID">
          (DUOC_ID = '0' or DUOC_ID is NULL)
        </isNotEmpty>
        <isNotEmpty prepend="and" property="LOAI_CHIPHI">
          VP.LOAI_CHIPHI = '$LOAI_CHIPHI$'
        </isNotEmpty>
        <isNotEmpty prepend="and" property="LOAIGIA_ID">
          VP.LOAIGIA_ID = '$LOAIGIA_ID$'
        </isNotEmpty>
        <isNotEmpty prepend="and" property="SOLUONG">
          VP.SOLUONG = '$SOLUONG$'
        </isNotEmpty>
        <isNotEmpty prepend="and" property="DONGIA_DOANHTHU">
          VP.DONGIA_DOANHTHU = '$DONGIA_DOANHTHU$'
        </isNotEmpty>
        <isNotEmpty prepend="and" property="THANHTIEN_DOANHTHU">
          VP.THANHTIEN_DOANHTHU = '$THANHTIEN_DOANHTHU$'
        </isNotEmpty>
        <isNotEmpty prepend="and" property="BHYT_TL">
          VP.BHYT_TL = '$BHYT_TL$'
        </isNotEmpty>
        <isNotEmpty prepend="and" property="BHYT_DONGIA">
          VP.BHYT_DONGIA = '$BHYT_DONGIA$'
        </isNotEmpty>
        <isNotEmpty prepend="and" property="BHYT_THANHTIEN">
          VP.BHYT_THANHTIEN = '$BHYT_THANHTIEN$'
        </isNotEmpty>
        <isNotEmpty prepend="and" property="BHYT_DONGIA_CHITRA">
          VP.BHYT_DONGIA_CHITRA = '$BHYT_DONGIA_CHITRA$'
        </isNotEmpty>
        <isNotEmpty prepend="and" property="BHYT_THANHTIEN_CHITRA">
          VP.BHYT_THANHTIEN_CHITRA = '$BHYT_THANHTIEN_CHITRA$'
        </isNotEmpty>
        <isNotEmpty prepend="and" property="BENHNHAN_PHAITHANHTOAN">
          VP.BENHNHAN_PHAITHANHTOAN = '$BENHNHAN_PHAITHANHTOAN$'
        </isNotEmpty>
        <isNotEmpty prepend="and" property="GIATRI_HOADON">
          VP.GIATRI_HOADON = '$GIATRI_HOADON$'
        </isNotEmpty>
        <isNotEmpty prepend="and" property="GIATRI_HOADON_DATHANHTOAN">
          VP.GIATRI_HOADON_DATHANHTOAN = '$GIATRI_HOADON_DATHANHTOAN$'
        </isNotEmpty>
        <isNotEmpty prepend="and" property="GIATRI_BIENLAI">
          VP.GIATRI_BIENLAI = '$GIATRI_BIENLAI$'
        </isNotEmpty>
        <isNotEmpty prepend="and" property="GIATRI_BIENLAI_DATHANHTOAN">
          VP.GIATRI_BIENLAI_DATHANHTOAN = '$GIATRI_BIENLAI_DATHANHTOAN$'
        </isNotEmpty>
        <isNotEmpty prepend="and" property="GIATRI_BENHNHAN_DATHANHTOAN">
          VP.GIATRI_BENHNHAN_DATHANHTOAN = '$GIATRI_BENHNHAN_DATHANHTOAN$'
        </isNotEmpty>
        <isNotEmpty prepend="and" property="GIATRI_THATTHU">
          VP.GIATRI_THATTHU = '$GIATRI_THATTHU$'
        </isNotEmpty>
        <isNotEmpty prepend="and" property="MIENGIAM_TL">
          VP.MIENGIAM_TL = '$MIENGIAM_TL$'
        </isNotEmpty>
        <isNotEmpty prepend="and" property="MIENGIAM_GIATRI">
          VP.MIENGIAM_GIATRI = '$MIENGIAM_GIATRI$'
        </isNotEmpty>
        <isNotEmpty prepend="and" property="NGANSACH_TL">
          VP.NGANSACH_TL = '$NGANSACH_TL$'
        </isNotEmpty>
        <isNotEmpty prepend="and" property="NGANSACH_GIATRI">
          VP.NGANSACH_GIATRI = '$NGANSACH_GIATRI$'
        </isNotEmpty>
        <isNotEmpty prepend="and" property="TAITRO_TL">
          VP.TAITRO_TL = '$TAITRO_TL$'
        </isNotEmpty>
        <isNotEmpty prepend="and" property="TAITRO_GIATRI">
          VP.TAITRO_GIATRI = '$TAITRO_GIATRI$'
        </isNotEmpty>
        <isNotEmpty prepend="and" property="BHTN_TL">
          VP.BHTN_TL = '$BHTN_TL$'
        </isNotEmpty>
        <isNotEmpty prepend="and" property="BHTN_DONGIA">
          VP.BHTN_DONGIA = '$BHTN_DONGIA$'
        </isNotEmpty>
        <isNotEmpty prepend="and" property="BHTN_THANHTIEN">
          VP.BHTN_THANHTIEN = '$BHTN_THANHTIEN$'
        </isNotEmpty>
        <isNotEmpty prepend="and" property="BHTN_DONGIA_CHITRA">
          VP.BHTN_DONGIA_CHITRA = '$BHTN_DONGIA_CHITRA$'
        </isNotEmpty>
        <isNotEmpty prepend="and" property="BHTN_THANHTIEN_CHITRA">
          VP.BHTN_THANHTIEN_CHITRA = '$BHTN_THANHTIEN_CHITRA$'
        </isNotEmpty>
        <isNotEmpty prepend="and" property="DUOCPHEPTHUCHIEN">
          VP.DUOCPHEPTHUCHIEN = '$DUOCPHEPTHUCHIEN$'
        </isNotEmpty>
        <isNotEmpty prepend="and" property="HUY">
          VP.HUY = '$HUY$'
        </isNotEmpty>
        <isNotEmpty prepend="and" property="DATHANHTOAN">
          VP.DATHANHTOAN = '$DATHANHTOAN$'
        </isNotEmpty>
        <isNotEmpty prepend="and" property="DATHUCHIEN">
          VP.DATHUCHIEN = '$DATHUCHIEN$'
        </isNotEmpty>
        <isNotEmpty prepend="and" property="KHONGTHUTIEN">
          VP.KHONGTHUTIEN = '$KHONGTHUTIEN$'
        </isNotEmpty>
        <isNotEmpty prepend="and" property="HOADON_ID">
          VP.HOADON_ID = '$HOADON_ID$'
        </isNotEmpty>
        <isNotEmpty prepend="and" property="ACTIVE">
          VP.ACTIVE = '$ACTIVE$'
        </isNotEmpty>
        <isNotEmpty prepend="and" property="BENHVIEN_ID">
          VP.BENHVIEN_ID = '$BENHVIEN_ID$'
        </isNotEmpty>
        <isNotEmpty prepend="and" property="NGUOITAO_ID">
          VP.NGUOITAO_ID = '$NGUOITAO_ID$'
        </isNotEmpty>
        <isNotEmpty prepend="and" property="NGAYTAO">
          VP.NGAYTAO = '$NGAYTAO$'
        </isNotEmpty>
        <isNotEmpty prepend="and" property="NGUOICAPNHAT_ID">
          VP.NGUOICAPNHAT_ID = '$NGUOICAPNHAT_ID$'
        </isNotEmpty>
        <isNotEmpty prepend="and" property="NGAYCAPNHAT">
          VP.NGAYCAPNHAT = '$NGAYCAPNHAT$'
        </isNotEmpty>
        <isNotEmpty prepend="and" property="LISTDATE">
          CONVERT(date, NGAYTAO) IN ($LISTDATE$)
        </isNotEmpty>
      </isParameterPresent>
      <!--TT_VIENPHI-->
      )a left join

      <!--TT_MIENGIAM-->
      (
      select VIENPHI_ID, MG.TINHTRANG, MGCT.MIENGIAMCHITIET_ID, MGCT.GIATRIMIENGIAM
      from TT_MIENGIAM MG INNER JOIN TT_MIENGIAM_CHITIET MGCT ON MG.MIENGIAM_ID = MGCT.MIENGIAM_ID
      where
      MG.TIEPNHAN_ID= '$TIEPNHAN_ID$' and MGCT.REF_TABLE = 'TT_MIENGIAM'
      <isParameterPresent>
        <isNotEmpty prepend="and" property="TINHTRANG">
          MG.TINHTRANG = '$TINHTRANG$'
        </isNotEmpty>
      </isParameterPresent>
      )b
      on a.VIENPHI_ID = b.VIENPHI_ID

      left join
      (
      select VIENPHI_ID, MG.TINHTRANG AS TINHTRANG_BHTN
      from TT_MIENGIAM_BHTN MG INNER JOIN TT_MIENGIAM_CHITIET MGCT ON MG.MIENGIAM_BHTN_ID = MGCT.MIENGIAM_ID
      where
      MG.TIEPNHAN_ID= '$TIEPNHAN_ID$' and MGCT.REF_TABLE = 'TT_MIENGIAM_BHTN'
      <isParameterPresent>
        <isNotEmpty prepend="and" property="TINHTRANG">
          MG.TINHTRANG = '$TINHTRANG$'
        </isNotEmpty>
      </isParameterPresent>
      )d
      on a.VIENPHI_ID = d.VIENPHI_ID

      left join
      (
      select VIENPHI_ID, MG.TINHTRANG AS TINHTRANG_MGCT, MGCT.GIATRIMIENGIAM as GIATRIMIENGIAM_CONGTY
      from TT_MIENGIAM_CONGTY MG INNER JOIN TT_MIENGIAM_CHITIET MGCT ON MG.MIENGIAM_CONGTY_ID = MGCT.MIENGIAM_ID
      where
      MG.TIEPNHAN_ID= '$TIEPNHAN_ID$' and MGCT.REF_TABLE = 'TT_MIENGIAM_CONGTY'
      <isParameterPresent>
        <isNotEmpty prepend="and" property="TINHTRANG">
          MG.TINHTRANG = '$TINHTRANG$'
        </isNotEmpty>
      </isParameterPresent>
      )e
      on a.VIENPHI_ID = e.VIENPHI_ID

      left join
      (
      select VIENPHI_ID, MG.TINHTRANG AS TINHTRANG_MGCT, MGCT.GIATRIMIENGIAM as GIATRIMIENGIAM_THANHVIEN
      from TT_MIENGIAM_THANHVIEN MG INNER JOIN TT_MIENGIAM_CHITIET MGCT ON MG.MIENGIAM_THANHVIEN_ID = MGCT.MIENGIAM_ID
      where
      MG.TIEPNHAN_ID= '$TIEPNHAN_ID$' and MGCT.REF_TABLE = 'TT_MIENGIAM_THANHVIEN'
      <isParameterPresent>
        <isNotEmpty prepend="and" property="TINHTRANG">
          MG.TINHTRANG = '$TINHTRANG$'
        </isNotEmpty>
      </isParameterPresent>
      )f
      on a.VIENPHI_ID = f.VIENPHI_ID

      left join
      (
      select DVYEUCAU_ID, TRANGTHAI, BHYTDONGTIEN, HUYYEUCAU, DVKEMTHEO, DVKEMTHEO_KHACEKIP, NOIYEUCAU_ID, NOITHUCHIEN_ID from TT_DVYEUCAU
      <dynamic prepend="where">
        <isParameterPresent>
          <isNotEmpty prepend="and" property="TIEPNHAN_ID">
            TIEPNHAN_ID = '$TIEPNHAN_ID$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="HUYYEUCAU">
            HUYYEUCAU = '$HUYYEUCAU$'
          </isNotEmpty>
        </isParameterPresent>
      </dynamic>
      )c on c.DVYEUCAU_ID = a.REF_ID
      <dynamic prepend="where">
        <isParameterPresent>
          <isNotEmpty property="HUYYEUCAU">
            c.HUYYEUCAU = '$HUYYEUCAU$' or c.HUYYEUCAU is null
          </isNotEmpty>
        </isParameterPresent>
      </dynamic>
    </statement>
   
    <statement id="DAO00064_TT_MIENGIAM_GetAll" resultClass="DataObject">
      select *
      from TT_MIENGIAM
      order by MIENGIAM_ID
    </statement>
    <statement id="DAO00064_TT_MIENGIAM_GetList" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select *
      from TT_MIENGIAM
      <dynamic prepend="where">
        <isParameterPresent>
          <isNotEmpty prepend="and" property="MIENGIAM_ID">
            TT_MIENGIAM.MIENGIAM_ID = '$MIENGIAM_ID$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="MAMIENGIAM">
            TT_MIENGIAM.MAMIENGIAM = '$MAMIENGIAM$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="SOPHIEUMIENGIAM">
            TT_MIENGIAM.SOPHIEUMIENGIAM = '$SOPHIEUMIENGIAM$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="TIEPNHAN_ID">
            TT_MIENGIAM.TIEPNHAN_ID = '$TIEPNHAN_ID$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="BENHAN_ID">
            TT_MIENGIAM.BENHAN_ID = '$BENHAN_ID$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="BENHNHAN_ID">
            TT_MIENGIAM.BENHNHAN_ID = '$BENHNHAN_ID$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="TYLEMIENGIAM">
            TT_MIENGIAM.TYLEMIENGIAM = '$TYLEMIENGIAM$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="GIATRIMIENGIAM">
            TT_MIENGIAM.GIATRIMIENGIAM = '$GIATRIMIENGIAM$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="LYDO_ID">
            TT_MIENGIAM.LYDO_ID = '$LYDO_ID$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="NGAYLAP">
            TT_MIENGIAM.NGAYLAP = '$NGAYLAP$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="NGUOIDUYET_ID">
            TT_MIENGIAM.NGUOIDUYET_ID = '$NGUOIDUYET_ID$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="GHICHU">
            TT_MIENGIAM.GHICHU = '$GHICHU$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="TINHTRANG">
            TT_MIENGIAM.TINHTRANG = '$TINHTRANG$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="BENHVIEN_ID">
            TT_MIENGIAM.BENHVIEN_ID = '$BENHVIEN_ID$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="NGUOITAO_ID">
            TT_MIENGIAM.NGUOITAO_ID = '$NGUOITAO_ID$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="NGAYTAO">
            TT_MIENGIAM.NGAYTAO = '$NGAYTAO$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="NGUOICAPNHAT_ID">
            TT_MIENGIAM.NGUOICAPNHAT_ID = '$NGUOICAPNHAT_ID$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="NGAYCAPNHAT">
            TT_MIENGIAM.NGAYCAPNHAT = '$NGAYCAPNHAT$'
          </isNotEmpty>
        </isParameterPresent>
      </dynamic>
      order by MIENGIAM_ID
    </statement>

    <statement id="DAO00064_TT_MIENGIAM_CONGTY_GetList" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select *
      from TT_MIENGIAM_CONGTY
      <dynamic prepend="where">
        <isParameterPresent>
          <isNotEmpty prepend="and" property="MIENGIAM_ID">
            TT_MIENGIAM_CONGTY.MIENGIAM_CONGTY_ID = '$MIENGIAM_ID$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="MAMIENGIAM">
            TT_MIENGIAM_CONGTY.MAMIENGIAM = '$MAMIENGIAM$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="SOPHIEUMIENGIAM">
            TT_MIENGIAM_CONGTY.SOPHIEUMIENGIAM = '$SOPHIEUMIENGIAM$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="TIEPNHAN_ID">
            TT_MIENGIAM_CONGTY.TIEPNHAN_ID = '$TIEPNHAN_ID$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="BENHAN_ID">
            TT_MIENGIAM_CONGTY.BENHAN_ID = '$BENHAN_ID$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="BENHNHAN_ID">
            TT_MIENGIAM_CONGTY.BENHNHAN_ID = '$BENHNHAN_ID$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="TYLEMIENGIAM">
            TT_MIENGIAM_CONGTY.TYLEMIENGIAM = '$TYLEMIENGIAM$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="GIATRIMIENGIAM">
            TT_MIENGIAM_CONGTY.GIATRIMIENGIAM = '$GIATRIMIENGIAM$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="CONGTY_CHITRA_ID">
            TT_MIENGIAM_CONGTY.CONGTYCHITRA_ID = '$CONGTY_CHITRA_ID$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="NGAYLAP">
            TT_MIENGIAM_CONGTY.NGAYLAP = '$NGAYLAP$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="NGUOIDUYET_ID">
            TT_MIENGIAM_CONGTY.NGUOIDUYET_ID = '$NGUOIDUYET_ID$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="GHICHU">
            TT_MIENGIAM_CONGTY.GHICHU = '$GHICHU$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="TINHTRANG">
            TT_MIENGIAM_CONGTY.TINHTRANG = '$TINHTRANG$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="BENHVIEN_ID">
            TT_MIENGIAM_CONGTY.BENHVIEN_ID = '$BENHVIEN_ID$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="NGUOITAO_ID">
            TT_MIENGIAM_CONGTY.NGUOITAO_ID = '$NGUOITAO_ID$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="NGAYTAO">
            TT_MIENGIAM_CONGTY.NGAYTAO = '$NGAYTAO$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="NGUOICAPNHAT_ID">
            TT_MIENGIAM_CONGTY.NGUOICAPNHAT_ID = '$NGUOICAPNHAT_ID$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="NGAYCAPNHAT">
            TT_MIENGIAM_CONGTY.NGAYCAPNHAT = '$NGAYCAPNHAT$'
          </isNotEmpty>
        </isParameterPresent>
      </dynamic>
      order by MIENGIAM_CONGTY_ID
    </statement>
    
    
    <statement id="DAO00064_TT_MIENGIAM_SearchDetail" parameterClass="System.Collections.IDictionary" resultClass="DataObject">

      select MG.*
      , TN.SOTIEPNHAN, BA.SOBENHAN, BN.TENBENHNHAN, a.TINHTRANG_TEXT, BN.MAYTE
      , CASE ISNULL(BN.NGAYSINH,'')
      WHEN '' THEN CONVERT(VARCHAR(10), BN.NAMSINH)
      ELSE CONVERT(VARCHAR(10), BN.NGAYSINH, 103)
      END AS NAMSINH
      , vp.DATHUCHIEN, gt.DESCRIPTION as GIOITINH
      from TT_MIENGIAM MG
      left join TT_TIEPNHAN TN on TN.TIEPNHAN_ID = MG.TIEPNHAN_ID
      left join TT_MIENGIAM_CHITIET mgct on mgct.MIENGIAM_ID = mg.MIENGIAM_ID
      left join TT_NOITRU_BENHAN BA on BA.BENHAN_ID = MG.BENHAN_ID
      left join TT_BENHNHAN BN on BN.BENHNHAN_ID = MG.BENHNHAN_ID
      left join TM_GENDER gt on gt.ID = bn.GIOITINH
      left join TT_VIENPHI vp on vp.VIENPHI_ID = MGct.VIENPHI_ID and vp.TIEPNHAN_ID = mg.TIEPNHAN_ID and vp.HUY=0
      LEFT JOIN
      (
      select MIENGIAM_ID, N'đã thanh tóan' as TINHTRANG_TEXT from TT_MIENGIAM mg
      where mg.MIENGIAM_ID in (
      select  MIENGIAM_ID from TT_MIENGIAM_CHITIET mgct
      left join TT_VIENPHI vp on vp.VIENPHI_ID = mgct.VIENPHI_ID
      where vp.DATHANHTOAN = '1')

      union all

      select MIENGIAM_ID, N'chưa thanh tóan' as TINHTRANG_TEXT from TT_MIENGIAM mg
      where mg.MIENGIAM_ID not in (
      select MIENGIAM_ID from TT_MIENGIAM_CHITIET mgct
      left join TT_VIENPHI vp on vp.VIENPHI_ID = mgct.VIENPHI_ID
      where vp.DATHANHTOAN = '1')

      )a ON A.MIENGIAM_ID = MG.MIENGIAM_ID
      <dynamic prepend="where">
        <isParameterPresent>         
          <isNotEmpty prepend="and" property="MAMIENGIAM">
            MG.MAMIENGIAM like '%$MAMIENGIAM$%'
          </isNotEmpty>         
          <isNotEmpty prepend="and" property="USER_ID">
            (MG.NGUOIDUYET_ID = '$USER_ID$' or MG.NGUOITAO_ID = '$USER_ID$')
          </isNotEmpty>
          <isNotEmpty prepend="and" property="BENHVIEN_ID">
            MG.BENHVIEN_ID = '$BENHVIEN_ID$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="TINHTRANG">
            MG.TINHTRANG = '$TINHTRANG$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="BENHNHAN_ID">
            TN.BENHNHAN_ID = '$BENHNHAN_ID$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="TUNGAY">
            convert(date, MG.NGAYLAP) between convert(date, '$TUNGAY$') and convert(date, '$DENNGAY$')
          </isNotEmpty>
          
        </isParameterPresent>
      </dynamic>
      order by MG.MIENGIAM_ID DESC
    </statement>

    <statement id="DAO00064_TT_MIENGIAM_Search" parameterClass="System.Collections.IDictionary" resultClass="DataObject">

      select MG.*
      , TN.SOTIEPNHAN, BA.SOBENHAN, BN.TENBENHNHAN, BN.MAYTE
      , CASE ISNULL(BN.NGAYSINH,'')
      WHEN '' THEN CONVERT(VARCHAR(10), BN.NAMSINH)
      ELSE CONVERT(VARCHAR(10), BN.NGAYSINH, 103)
      END AS NAMSINH
      ,gt.DESCRIPTION as GIOITINH
      from TT_MIENGIAM MG
      left join TT_TIEPNHAN TN on TN.TIEPNHAN_ID = MG.TIEPNHAN_ID
      <!--left join TT_MIENGIAM_CHITIET mgct on mgct.MIENGIAM_ID = mg.MIENGIAM_ID-->
      left join TT_NOITRU_BENHAN BA on BA.BENHAN_ID = MG.BENHAN_ID
      left join TT_BENHNHAN BN on BN.BENHNHAN_ID = MG.BENHNHAN_ID
      left join TM_GENDER gt on gt.ID = bn.GIOITINH
      <!--left join TT_VIENPHI vp on vp.VIENPHI_ID = MGct.VIENPHI_ID and vp.TIEPNHAN_ID = mg.TIEPNHAN_ID and vp.HUY=0-->
     
      <dynamic prepend="where">
        <isParameterPresent>
          <isNotEmpty prepend="and" property="MAMG">
            MG.MAMIENGIAM like '%$MAMG$%'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="TUKHOA">
            (BN.TENBENHNHAN like '%$TUKHOA$%' or BN.MAYTE like '%$TUKHOA$%')
          </isNotEmpty>
          <isNotEmpty prepend="and" property="MAMIENGIAM">
           (MG.MAMIENGIAM like '%$MAMIENGIAM$%' or BN.TENBENHNHAN like '%$TUKHOA$%' or BN.MAYTE like '%$TUKHOA$%')
          </isNotEmpty>
          <isNotEmpty prepend="and" property="USER_ID">
            (MG.NGUOIDUYET_ID = '$USER_ID$' or MG.NGUOITAO_ID = '$USER_ID$')
          </isNotEmpty>
          <isNotEmpty prepend="and" property="BENHVIEN_ID">
            MG.BENHVIEN_ID = '$BENHVIEN_ID$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="TINHTRANG">
            MG.TINHTRANG = '$TINHTRANG$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="BENHNHAN_ID">
            TN.BENHNHAN_ID = '$BENHNHAN_ID$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="TUNGAY">
            convert(date, MG.NGAYLAP) between convert(date, '$TUNGAY$') and convert(date, '$DENNGAY$')
          </isNotEmpty>

        </isParameterPresent>
      </dynamic>
      order by MG.MIENGIAM_ID DESC
    </statement>

    <statement id="DAO00064_TT_MIENGIAM_CONGTY_Search" parameterClass="System.Collections.IDictionary" resultClass="DataObject">

      select MG.*
      , TN.SOTIEPNHAN, BA.SOBENHAN, BN.TENBENHNHAN, BN.MAYTE
      , CASE ISNULL(BN.NGAYSINH,'')
      WHEN '' THEN CONVERT(VARCHAR(10), BN.NAMSINH)
      ELSE CONVERT(VARCHAR(10), BN.NGAYSINH, 103)
      END AS NAMSINH
      ,gt.DESCRIPTION as GIOITINH
      from TT_MIENGIAM_CONGTY MG
      left join TT_TIEPNHAN TN on TN.TIEPNHAN_ID = MG.TIEPNHAN_ID
      <!--left join TT_MIENGIAM_CHITIET mgct on mgct.MIENGIAM_ID = mg.MIENGIAM_ID-->
      left join TT_NOITRU_BENHAN BA on BA.BENHAN_ID = MG.BENHAN_ID
      left join TT_BENHNHAN BN on BN.BENHNHAN_ID = MG.BENHNHAN_ID
      left join TM_GENDER gt on gt.ID = bn.GIOITINH
      <!--left join TT_VIENPHI vp on vp.VIENPHI_ID = MGct.VIENPHI_ID and vp.TIEPNHAN_ID = mg.TIEPNHAN_ID and vp.HUY=0-->

      <dynamic prepend="where">
        <isParameterPresent>
          <isNotEmpty prepend="and" property="MAMG">
            MG.MAMIENGIAM like '%$MAMG$%'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="TUKHOA">
            (BN.TENBENHNHAN like '%$TUKHOA$%' or BN.MAYTE like '%$TUKHOA$%')
          </isNotEmpty>
          <isNotEmpty prepend="and" property="MAMIENGIAM">
            MG.MAMIENGIAM like '%$MAMIENGIAM$%'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="USER_ID">
            (MG.NGUOIDUYET_ID = '$USER_ID$' or MG.NGUOITAO_ID = '$USER_ID$')
          </isNotEmpty>
          <isNotEmpty prepend="and" property="BENHVIEN_ID">
            MG.BENHVIEN_ID = '$BENHVIEN_ID$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="TINHTRANG">
            MG.TINHTRANG = '$TINHTRANG$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="BENHNHAN_ID">
            TN.BENHNHAN_ID = '$BENHNHAN_ID$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="TUNGAY">
            convert(date, MG.NGAYLAP) between convert(date, '$TUNGAY$') and convert(date, '$DENNGAY$')
          </isNotEmpty>

        </isParameterPresent>
      </dynamic>
      order by MG.MIENGIAM_CONGTY_ID DESC
    </statement>
    
    <statement id="DAO00064_TT_MIENGIAM_GetDetail" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select mg.*, ba.SOBENHAN
      from TT_MIENGIAM mg
      left join TT_NOITRU_BENHAN ba on ba.BENHAN_ID = mg.BENHAN_ID
      where mg.MIENGIAM_ID  = '$MIENGIAM_ID$'
    </statement>
    <statement id="DAO00064_TT_MIENGIAM_CONGTY_GetDetail" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select mg.*, ba.SOBENHAN
      from TT_MIENGIAM_CONGTY mg
      left join TT_NOITRU_BENHAN ba on ba.BENHAN_ID = mg.BENHAN_ID
      where mg.MIENGIAM_CONGTY_ID  = '$MIENGIAM_ID$'
    </statement>
    <statement id="DAO00064_TT_MIENGIAM_GetDetailP" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select *
      from TT_MIENGIAM
      where TT_MIENGIAM.MIENGIAM_ID  = '$MIENGIAM_ID$'
      order by MIENGIAM_ID
    </statement>
    <statement id="DAO00064_TT_MIENGIAM_Add" parameterClass="System.Collections.IDictionary" resultClass="System.Int64">     
      insert into TT_MIENGIAM (
      MAMIENGIAM
      , SOPHIEUMIENGIAM
      , TIEPNHAN_ID
      , BENHAN_ID
      , BENHNHAN_ID
      , TYLEMIENGIAM
      , GIATRIMIENGIAM
      , LYDO_ID
      , NGAYLAP
      , NGUOIDUYET_ID
      , GHICHU
      , TINHTRANG
      , BENHVIEN_ID
      , NGUOITAO_ID
      , NGAYTAO
      , NGUOICAPNHAT_ID
      , NGAYCAPNHAT
      ) values (
      #MAMIENGIAM#
      , #SOPHIEUMIENGIAM#
      , #TIEPNHAN_ID#
      , #BENHAN_ID#
      , #BENHNHAN_ID#
      , #TYLEMIENGIAM#
      , #GIATRIMIENGIAM#
      , #LYDO_ID#
      , #NGAYLAP#
      , #NGUOIDUYET_ID#
      , #GHICHU#
      , #TINHTRANG#
      , #BENHVIEN_ID#
      , #NGUOITAO_ID#
      , #NGAYTAO#
      , #NGUOICAPNHAT_ID#
      , #NGAYCAPNHAT#
      )
      SELECT SCOPE_IDENTITY()
      <!--<selectKey resultClass="System.Int64" type="post" >
        SELECT @@IDENTITY as value
      </selectKey>-->
    </statement>

    <statement id="DAO00064_TT_MIENGIAM_CONGTY_Add" parameterClass="System.Collections.IDictionary" resultClass="System.Int64">
      insert into TT_MIENGIAM_CONGTY (
      MAMIENGIAM
      , SOPHIEUMIENGIAM
      , TIEPNHAN_ID
      , BENHAN_ID
      , BENHNHAN_ID
      , TYLEMIENGIAM
      , GIATRIMIENGIAM
      , CONGTYCHITRA_ID
      , NGAYLAP
      , NGUOIDUYET_ID
      , GHICHU
      , TINHTRANG
      , BENHVIEN_ID
      , NGUOITAO_ID
      , NGAYTAO
      , NGUOICAPNHAT_ID
      , NGAYCAPNHAT
      ) values (
      #MAMIENGIAM#
      , #SOPHIEUMIENGIAM#
      , #TIEPNHAN_ID#
      , #BENHAN_ID#
      , #BENHNHAN_ID#
      , #TYLEMIENGIAM#
      , #GIATRIMIENGIAM#
      , #CONGTY_CHITRA_ID#
      , #NGAYLAP#
      , #NGUOIDUYET_ID#
      , #GHICHU#
      , #TINHTRANG#
      , #BENHVIEN_ID#
      , #NGUOITAO_ID#
      , #NGAYTAO#
      , #NGUOICAPNHAT_ID#
      , #NGAYCAPNHAT#
      )
      SELECT SCOPE_IDENTITY()
      <!--<selectKey resultClass="System.Int64" type="post" >
        SELECT @@IDENTITY as value
      </selectKey>-->
    </statement>

    <statement id="DAO00064_TT_MIENGIAM_AddTransaction" parameterClass="System.Collections.IDictionary">
      SET TRANSACTION ISOLATION LEVEL READ COMMITTED;
      IF(SELECT COUNT(*)
      FROM TT_VIENPHI
      WHERE
      REF_TABLE = '$REF_TABLE$'
      AND (DICHVU_ID IN ($LIST_DICHVU$) OR DUOC_ID IN ($LIST_DUOC$))
      AND VIENPHI_ID IN ($LIST_VIENPHI$)) = 0
      BEGIN
      BEGIN TRY
      BEGIN TRANSACTION
      UPDATE TT_VIENPHI
      SET REF_TABLE = '$REF_TABLE$'
      WHERE
      (DICHVU_ID IN ($LIST_DICHVU$) OR DUOC_ID IN ($LIST_DUOC$))
      AND VIENPHI_ID IN ($LIST_VIENPHI$)
      SELECT 1 AS RESULT
      COMMIT TRANSACTION
      END TRY

      BEGIN CATCH
      IF @@TRANCOUNT > 0
      ROLLBACK TRANSACTION
      SELECT -1 AS RESULT
      END CATCH
      END
      ELSE
      SELECT 0 AS RESULT
    </statement>

    <update id="DAO00064_TT_MIENGIAM_Update" parameterClass="System.Collections.IDictionary">
      update TT_MIENGIAM set
      MAMIENGIAM = #MAMIENGIAM#
      , SOPHIEUMIENGIAM = #SOPHIEUMIENGIAM#
      , TIEPNHAN_ID = #TIEPNHAN_ID#
      , BENHAN_ID = #BENHAN_ID#
      , BENHNHAN_ID = #BENHNHAN_ID#
      , TYLEMIENGIAM = #TYLEMIENGIAM#
      , GIATRIMIENGIAM = #GIATRIMIENGIAM#
      , LYDO_ID = #LYDO_ID#
      , NGAYLAP = #NGAYLAP#
      , NGUOIDUYET_ID = #NGUOIDUYET_ID#
      , GHICHU = #GHICHU#
      , TINHTRANG = #TINHTRANG#
      <!--, BENHVIEN_ID = #BENHVIEN_ID#
      , NGUOITAO_ID = #NGUOITAO_ID#
      , NGAYTAO = #NGAYTAO#-->
      , NGUOICAPNHAT_ID = #NGUOICAPNHAT_ID#
      , NGAYCAPNHAT = #NGAYCAPNHAT#
      where
      MIENGIAM_ID = '$MIENGIAM_ID$'
    </update>

    <update id="DAO00064_TT_MIENGIAM_CONGTY_Update" parameterClass="System.Collections.IDictionary">
      update TT_MIENGIAM_CONGTY set
      MAMIENGIAM = #MAMIENGIAM#
      , SOPHIEUMIENGIAM = #SOPHIEUMIENGIAM#
      , TIEPNHAN_ID = #TIEPNHAN_ID#
      , BENHAN_ID = #BENHAN_ID#
      , BENHNHAN_ID = #BENHNHAN_ID#
      , TYLEMIENGIAM = #TYLEMIENGIAM#
      , GIATRIMIENGIAM = #GIATRIMIENGIAM#
      , CONGTYCHITRA_ID = #CONGTY_CHITRA_ID#
      , NGAYLAP = #NGAYLAP#
      , NGUOIDUYET_ID = #NGUOIDUYET_ID#
      , GHICHU = #GHICHU#
      , TINHTRANG = #TINHTRANG#
      <!--, BENHVIEN_ID = #BENHVIEN_ID#
      , NGUOITAO_ID = #NGUOITAO_ID#
      , NGAYTAO = #NGAYTAO#-->
      , NGUOICAPNHAT_ID = #NGUOICAPNHAT_ID#
      , NGAYCAPNHAT = #NGAYCAPNHAT#
      where
      MIENGIAM_CONGTY_ID = '$MIENGIAM_ID$'
    </update>
    
    <update id="DAO00064_TT_MIENGIAM_Approve" parameterClass="System.Collections.IDictionary">
      update TT_MIENGIAM set
      MAMIENGIAM = #MAMIENGIAM#
      , SOPHIEUMIENGIAM = #SOPHIEUMIENGIAM#
      , TIEPNHAN_ID = #TIEPNHAN_ID#
      , BENHAN_ID = #BENHAN_ID#
      , BENHNHAN_ID = #BENHNHAN_ID#
      , TYLEMIENGIAM = #TYLEMIENGIAM#
      , GIATRIMIENGIAM = #GIATRIMIENGIAM#
      , LYDO_ID = #LYDO_ID#
      , NGAYLAP = #NGAYLAP#
      , NGUOIDUYET_ID = #NGUOIDUYET_ID#
      , GHICHU = #GHICHU#
      , TINHTRANG = #TINHTRANG#
      <!--, BENHVIEN_ID = #BENHVIEN_ID#
      , NGUOITAO_ID = #NGUOITAO_ID#
      , NGAYTAO = #NGAYTAO#-->
      , NGUOICAPNHAT_ID = #NGUOICAPNHAT_ID#
      , NGAYCAPNHAT = #NGAYCAPNHAT#
      where
      MIENGIAM_ID = '$MIENGIAM_ID$'
    </update>

    <update id="DAO00064_TT_MIENGIAM_CONGTY_Approve" parameterClass="System.Collections.IDictionary">
      update TT_MIENGIAM_CONGTY set
      MAMIENGIAM = #MAMIENGIAM#
      , SOPHIEUMIENGIAM = #SOPHIEUMIENGIAM#
      , TIEPNHAN_ID = #TIEPNHAN_ID#
      , BENHAN_ID = #BENHAN_ID#
      , BENHNHAN_ID = #BENHNHAN_ID#
      , TYLEMIENGIAM = #TYLEMIENGIAM#
      , GIATRIMIENGIAM = #GIATRIMIENGIAM#
      <!--, CONGTYCHITRA_ID = #CONGTY_CHITRA_ID#-->
      , NGAYLAP = #NGAYLAP#
      , NGUOIDUYET_ID = #NGUOIDUYET_ID#
      , GHICHU = #GHICHU#
      , TINHTRANG = #TINHTRANG#
      <!--, BENHVIEN_ID = #BENHVIEN_ID#
      , NGUOITAO_ID = #NGUOITAO_ID#
      , NGAYTAO = #NGAYTAO#-->
      , NGUOICAPNHAT_ID = #NGUOICAPNHAT_ID#
      , NGAYCAPNHAT = #NGAYCAPNHAT#
      where
      MIENGIAM_CONGTY_ID = '$MIENGIAM_CONGTY_ID$'
    </update>

    <statement id="DAO00064_TT_MIENGIAM_Delete" parameterClass="System.Collections.IDictionary" resultClass="System.Int32">
      delete from TT_MIENGIAM
      where
      MIENGIAM_ID = '$MIENGIAM_ID$'
    </statement>
    <statement id="DAO00064_TT_MIENGIAM_CONGTY_Delete" parameterClass="System.Collections.IDictionary" resultClass="System.Int32">
      delete from TT_MIENGIAM_CONGTY
      where
      MIENGIAM_CONGTY_ID = '$MIENGIAM_ID$'
    </statement>

    <statement id="DAO00064_TT_MIENGIAM_DeleteP" parameterClass="System.Collections.IDictionary" resultClass="System.Int32">
      delete from TT_MIENGIAM
      <dynamic prepend="where">
        <isParameterPresent>
          <isNotEmpty prepend="and" property="MIENGIAM_ID">
            TT_MIENGIAM.MIENGIAM_ID = '$MIENGIAM_ID$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="MAMIENGIAM">
            TT_MIENGIAM.MAMIENGIAM = '$MAMIENGIAM$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="SOPHIEUMIENGIAM">
            TT_MIENGIAM.SOPHIEUMIENGIAM = '$SOPHIEUMIENGIAM$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="TIEPNHAN_ID">
            TT_MIENGIAM.TIEPNHAN_ID = '$TIEPNHAN_ID$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="BENHAN_ID">
            TT_MIENGIAM.BENHAN_ID = '$BENHAN_ID$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="BENHNHAN_ID">
            TT_MIENGIAM.BENHNHAN_ID = '$BENHNHAN_ID$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="TYLEMIENGIAM">
            TT_MIENGIAM.TYLEMIENGIAM = '$TYLEMIENGIAM$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="GIATRIMIENGIAM">
            TT_MIENGIAM.GIATRIMIENGIAM = '$GIATRIMIENGIAM$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="LYDO_ID">
            TT_MIENGIAM.LYDO_ID = '$LYDO_ID$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="NGAYLAP">
            TT_MIENGIAM.NGAYLAP = '$NGAYLAP$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="NGUOIDUYET_ID">
            TT_MIENGIAM.NGUOIDUYET_ID = '$NGUOIDUYET_ID$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="GHICHU">
            TT_MIENGIAM.GHICHU = '$GHICHU$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="BENHVIEN_ID">
            TT_MIENGIAM.BENHVIEN_ID = '$BENHVIEN_ID$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="NGUOITAO_ID">
            TT_MIENGIAM.NGUOITAO_ID = '$NGUOITAO_ID$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="NGAYTAO">
            TT_MIENGIAM.NGAYTAO = '$NGAYTAO$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="NGUOICAPNHAT_ID">
            TT_MIENGIAM.NGUOICAPNHAT_ID = '$NGUOICAPNHAT_ID$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="NGAYCAPNHAT">
            TT_MIENGIAM.NGAYCAPNHAT = '$NGAYCAPNHAT$'
          </isNotEmpty>
        </isParameterPresent>
      </dynamic>
    </statement>
    <statement id="DAO00064_TT_MIENGIAM_SumTyLeMG_DaDuyet" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      SELECT SUM(TYLEMIENGIAM) AS TYLEMG
      FROM TT_MIENGIAM
      WHERE TIEPNHAN_ID = '$TIEPNHAN_ID$'
      AND BENHVIEN_ID = '$BENHVIEN_ID$' AND TINHTRANG = '$TINHTRANG$'
    </statement>

    <!--============================================================================
//TT_MIENGIAM_CHITIET
//===========================================================================-->
    <statement id="DAO00064_TT_MIENGIAM_CHITIET_GetAll" resultClass="DataObject">
      select *
      from TT_MIENGIAM_CHITIET
      order by MIENGIAMCHITIET_ID
    </statement>
    
    <!--Get thông tin miễn giảm-->
    <statement id="DAO00064_TT_MIENGIAM_CHITIET_GetList" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
     select VP.*, MGCT.MIENGIAMCHITIET_ID, MGCT.GIATRIMIENGIAM as GIATRIMIENGIAM_CTCT, MGCT.GIATRISAUMIENGIAM
      from TT_VIENPHI VP
      left join TT_MIENGIAM_CHITIET MGCT on VP.VIENPHI_ID = MGCT.VIENPHI_ID
      <dynamic prepend="where">
      <isParameterPresent>
        <isNotEmpty prepend="and" property="MIENGIAM_ID">
          MGCT.MIENGIAM_ID = '$MIENGIAM_ID$'
        </isNotEmpty>
        <isNotEmpty prepend="and" property="REF_TABLE">
          MGCT.REF_TABLE = '$REF_TABLE$'
        </isNotEmpty>
        <isNotEmpty prepend="and" property="DATHANHTOAN">
          VP.DATHANHTOAN = '$DATHANHTOAN$'
        </isNotEmpty>        
      </isParameterPresent>
    </dynamic>
    </statement>
    
        <!--Get thông tin miễn giảm công ty-->
    <statement id="DAO00064_TT_MIENGIAM_CHITIET_CONGTY_GetList" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
    select A.*, B.GIATRIMIENGIAM, C.GIATRIMIENGIAM_THANHVIEN
    from
    (
    select VP.*, MGCT.MIENGIAMCHITIET_ID, MGCT.GIATRIMIENGIAM as GIATRIMIENGIAM_CTCT, MGCT.GIATRISAUMIENGIAM
      from TT_VIENPHI VP
      left join TT_MIENGIAM_CHITIET MGCT on VP.VIENPHI_ID = MGCT.VIENPHI_ID
      <dynamic prepend="where">
      <isParameterPresent>
        <isNotEmpty prepend="and" property="MIENGIAM_ID">
          MGCT.MIENGIAM_ID = '$MIENGIAM_ID$'
        </isNotEmpty>
        <isNotEmpty prepend="and" property="REF_TABLE">
          MGCT.REF_TABLE = '$REF_TABLE$'
        </isNotEmpty>
        <isNotEmpty prepend="and" property="DATHANHTOAN">
          VP.DATHANHTOAN = '$DATHANHTOAN$'
        </isNotEmpty>        
      </isParameterPresent>
    </dynamic>
    )A 
    left join 
      (
      select VIENPHI_ID, mgct.GIATRIMIENGIAM
          from TT_MIENGIAM MG 
	      left join TT_MIENGIAM_CHITIET mgct on mgct.MIENGIAM_ID = mg.miengiam_id
          where
	      MGCT.REF_TABLE = 'TT_MIENGIAM' and MG.TINHTRANG = 1
	        <isParameterPresent>
        <isNotEmpty prepend="and" property="VIENPHI_ID">
          MGCT.VIENPHI_ID = '$VIENPHI_ID$'
        </isNotEmpty>       
      </isParameterPresent>

      )B
      on A.VIENPHI_ID = B.VIENPHI_ID
      
      left join 
      (
      select VIENPHI_ID, mgct.GIATRIMIENGIAM as GIATRIMIENGIAM_THANHVIEN
          from TT_MIENGIAM MG 
	      left join TT_MIENGIAM_CHITIET mgct on mgct.MIENGIAM_ID = mg.miengiam_id
          where
	      MGCT.REF_TABLE = 'TT_MIENGIAM_THANHVIEN' and MG.TINHTRANG = 1
	        <isParameterPresent>
        <isNotEmpty prepend="and" property="VIENPHI_ID">
          MGCT.VIENPHI_ID = '$VIENPHI_ID$'
        </isNotEmpty>       
      </isParameterPresent>

      )C
      on A.VIENPHI_ID = C.VIENPHI_ID
      
      <!--left join 
      (
      select VIENPHI_ID, mgct.GIATRIMIENGIAM as GIATRIMIENGIAM_THANHVIEN
          from TT_MIENGIAM MG 
	      left join TT_MIENGIAM_CHITIET mgct on mgct.MIENGIAM_ID = mg.miengiam_id
          where
	      MGCT.REF_TABLE = 'TT_MIENGIAM_THANHVIEN' and MG.TINHTRANG = 1
	        <isParameterPresent>
        <isNotEmpty prepend="and" property="VIENPHI_ID">
          MGCT.VIENPHI_ID = '$VIENPHI_ID$'
        </isNotEmpty>       
      </isParameterPresent>

      )D-->
      <!--on A.VIENPHI_ID = D.VIENPHI_ID-->
    </statement>
    
      <!--Get thông tin miễn giảm-->
    <statement id="DAO00064_TT_MIENGIAM_CHITIET_Detail_GetList" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select A.*, D.GIATRIMIENGIAM_BHTN, e.GIATRIMIENGIAM_CTCT, f.GIATRIMIENGIAM_THANHVIEN
      from
      (
      select VP.*, MGCT.MIENGIAMCHITIET_ID, MGCT.GIATRIMIENGIAM, MGCT.GIATRISAUMIENGIAM
      from TT_VIENPHI VP
      left join TT_MIENGIAM_CHITIET MGCT on VP.VIENPHI_ID = MGCT.VIENPHI_ID
      <dynamic prepend="where">
      <isParameterPresent>
        <isNotEmpty prepend="and" property="MIENGIAM_ID">
          MGCT.MIENGIAM_ID = '$MIENGIAM_ID$'
        </isNotEmpty>
        <isNotEmpty prepend="and" property="REF_TABLE">
          MGCT.REF_TABLE = '$REF_TABLE$'
        </isNotEmpty>
        <isNotEmpty prepend="and" property="DATHANHTOAN">
          VP.DATHANHTOAN = '$DATHANHTOAN$'
        </isNotEmpty>        
      </isParameterPresent>
    </dynamic>
      )A
      left join
      (
      select VIENPHI_ID, MG.TINHTRANG AS TINHTRANG_BHTN, MGCT.GIATRIMIENGIAM as GIATRIMIENGIAM_BHTN
      from TT_MIENGIAM_BHTN MG INNER JOIN TT_MIENGIAM_CHITIET MGCT ON MG.MIENGIAM_BHTN_ID = MGCT.MIENGIAM_ID
      where
      MG.TIEPNHAN_ID= '$TIEPNHAN_ID$' and MGCT.REF_TABLE = 'TT_MIENGIAM_BHTN'
      <isParameterPresent>
        <isNotEmpty prepend="and" property="TINHTRANG">
          MG.TINHTRANG = 1
        </isNotEmpty>
      </isParameterPresent>
      )d
      on a.VIENPHI_ID = d.VIENPHI_ID

      left join
      (
      select VIENPHI_ID, MG.TINHTRANG AS TINHTRANG_MGCT, MGCT.GIATRIMIENGIAM as GIATRIMIENGIAM_CTCT
      from TT_MIENGIAM_CONGTY MG INNER JOIN TT_MIENGIAM_CHITIET MGCT ON MG.MIENGIAM_CONGTY_ID = MGCT.MIENGIAM_ID
      where
      MG.TIEPNHAN_ID= '$TIEPNHAN_ID$' and MGCT.REF_TABLE = 'TT_MIENGIAM_CONGTY'
      <isParameterPresent>
        <isNotEmpty prepend="and" property="TINHTRANG">
          MG.TINHTRANG = 1
        </isNotEmpty>
      </isParameterPresent>
      )e
      on a.VIENPHI_ID = e.VIENPHI_ID

      left join
      (
      select VIENPHI_ID, MG.TINHTRANG AS TINHTRANG_MGCT, MGCT.GIATRIMIENGIAM as GIATRIMIENGIAM_THANHVIEN
      from TT_MIENGIAM_THANHVIEN MG INNER JOIN TT_MIENGIAM_CHITIET MGCT ON MG.MIENGIAM_THANHVIEN_ID = MGCT.MIENGIAM_ID
      where
      MG.TIEPNHAN_ID= '$TIEPNHAN_ID$' and MGCT.REF_TABLE = 'TT_MIENGIAM_THANHVIEN'
      <isParameterPresent>
        <isNotEmpty prepend="and" property="TINHTRANG">
          MG.TINHTRANG = 1
        </isNotEmpty>
      </isParameterPresent>
      )f
      on a.VIENPHI_ID = f.VIENPHI_ID

    </statement>
    
    <statement id="DAO00064_TT_MIENGIAM_CHITIET_GetDetail" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select *
      from TT_MIENGIAM_CHITIET
      where TT_MIENGIAM_CHITIET.MIENGIAMCHITIET_ID  = '$value$'
      order by MIENGIAMCHITIET_ID
    </statement>
    <statement id="DAO00064_TT_MIENGIAM_CHITIET_GetDetailP" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select *
      from TT_MIENGIAM_CHITIET
      where TT_MIENGIAM_CHITIET.MIENGIAMCHITIET_ID  = '$MIENGIAMCHITIET_ID$'
      order by MIENGIAMCHITIET_ID
    </statement>
    <insert id="DAO00064_TT_MIENGIAM_CHITIET_Add" parameterClass="System.Collections.IDictionary" resultClass="System.Int64">
      insert into TT_MIENGIAM_CHITIET (      
        MIENGIAM_ID
      , REF_TABLE
      , VIENPHI_ID
      , TYLEMIENGIAM
      , GIATRIMIENGIAM
      , BENHVIEN_ID
      , NGUOITAO_ID
      , NGAYTAO
      , NGUOICAPNHAT_ID
      , NGAYCAPNHAT
      , GIATRISAUMIENGIAM
      ) values (      
        #MIENGIAM_ID#
      , #REF_TABLE#
      , #VIENPHI_ID#
      , #TYLEMIENGIAM#
      , #GIATRIMIENGIAM#
      , #BENHVIEN_ID#
      , #NGUOITAO_ID#
      , #NGAYTAO#
      , #NGUOICAPNHAT_ID#
      , #NGAYCAPNHAT#
      , #GIATRISAUMIENGIAM#
      )
    </insert>

    <update id="DAO00064_TT_MIENGIAM_CHITIET_Update" parameterClass="System.Collections.IDictionary">
      update TT_MIENGIAM_CHITIET set
      MIENGIAM_ID = #MIENGIAM_ID#
      , VIENPHI_ID = #VIENPHI_ID#
      , TYLEMIENGIAM = #TYLEMIENGIAM#
      , GIATRIMIENGIAM = #GIATRIMIENGIAM#
      <!--, BENHVIEN_ID = #BENHVIEN_ID#
      , NGUOITAO_ID = #NGUOITAO_ID#
      , NGAYTAO = #NGAYTAO#-->
      , NGUOICAPNHAT_ID = #NGUOICAPNHAT_ID#
      , NGAYCAPNHAT = #NGAYCAPNHAT#
      , GIATRISAUMIENGIAM = #GIATRISAUMIENGIAM#
      where
      MIENGIAMCHITIET_ID = '$MIENGIAMCHITIET_ID$'
    </update>

    <statement id="DAO00064_TT_MIENGIAM_CHITIET_Delete" parameterClass="System.Collections.IDictionary" resultClass="System.Int32">
      delete from TT_MIENGIAM_CHITIET
      where
      MIENGIAMCHITIET_ID = '$MIENGIAMCHITIET_ID$'
    </statement>

    <statement id="DAO00064_TT_MIENGIAM_CHITIET_DeleteP" parameterClass="System.Collections.IDictionary" resultClass="System.Int32">
      delete from TT_MIENGIAM_CHITIET
      <dynamic prepend="where">
        <isParameterPresent>
          <isNotEmpty prepend="and" property="MIENGIAMCHITIET_ID">
            TT_MIENGIAM_CHITIET.MIENGIAMCHITIET_ID = '$MIENGIAMCHITIET_ID$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="MIENGIAM_ID">
            TT_MIENGIAM_CHITIET.MIENGIAM_ID = '$MIENGIAM_ID$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="VIENPHI_ID">
            TT_MIENGIAM_CHITIET.VIENPHI_ID = '$VIENPHI_ID$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="TYLEMIENGIAM">
            TT_MIENGIAM_CHITIET.TYLEMIENGIAM = '$TYLEMIENGIAM$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="GIATRIMIENGIAM">
            TT_MIENGIAM_CHITIET.GIATRIMIENGIAM = '$GIATRIMIENGIAM$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="BENHVIEN_ID">
            TT_MIENGIAM_CHITIET.BENHVIEN_ID = '$BENHVIEN_ID$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="NGUOITAO_ID">
            TT_MIENGIAM_CHITIET.NGUOITAO_ID = '$NGUOITAO_ID$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="NGAYTAO">
            TT_MIENGIAM_CHITIET.NGAYTAO = '$NGAYTAO$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="NGUOICAPNHAT_ID">
            TT_MIENGIAM_CHITIET.NGUOICAPNHAT_ID = '$NGUOICAPNHAT_ID$'
          </isNotEmpty>
          <isNotEmpty prepend="and" property="NGAYCAPNHAT">
            TT_MIENGIAM_CHITIET.NGAYCAPNHAT = '$NGAYCAPNHAT$'
          </isNotEmpty>
        </isParameterPresent>
      </dynamic>
    </statement>

    <statement id="DAO00064_TT_MIENGIAM_DichVu" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select *
      from TT_MIENGIAM mg
      left join TT_MIENGIAM_CHITIET mgct on mgct.MIENGIAM_ID = mg.MIENGIAM_ID
      left join TT_VIENPHI vp on vp.VIENPHI_ID = mgct.VIENPHI_ID
      where mg.TINHTRANG = '$TINHTRANG$'
      <dynamic prepend=" and REF_ID in ">
        <iterate property="REF_ID" open="(" close=")" conjunction=",">
          #REF_ID[]#
        </iterate>
      </dynamic>
    </statement>

    <insert id="DAO00064_TT_BENHNHAN_BHYT_Add" parameterClass="System.Collections.IDictionary" resultClass="System.Int64">
      insert into TT_BENHNHAN_BHYT (      
        BENHNHAN_ID
      , LOAIBHYT
      , SOTHE
      , NGAYCAP
      , NGAYHIEULUC
      , NGAYHETHIEULUC
      , TINHTHANH_CAPTHE_ID
      , BENHVIEN_ID
      , BENHVIEN_KCB_ID
      , TREN3NAM
      , TREN5NAM
      , NGAYMIENDONGCHITRA
      , TREN6THANG
      , KHUVUCSONG_ID
      , TAMNGUNG
      , NGAYTAO
      , NGUOITAO_ID
      , NGAYCAPNHAT
      , NGUOICAPNHAT_ID
      ) values (      
        #BENHNHAN_ID#
      , #LOAIBHYT#
      , #SOTHE#
      , #NGAYCAP#
      , #NGAYHIEULUC#
      , #NGAYHETHIEULUC#
      , #TINHTHANH_CAPTHE_ID#
      , #BENHVIEN_ID#
      , #BENHVIEN_KCB_ID#
      , #TREN3NAM#
      , #TREN5NAM#
      , #NGAYMIENDONGCHITRA#
      , #TREN6THANG#
      , #KHUVUCSONG_ID#
      , #TAMNGUNG#
      , #NGAYTAO#
      , #NGUOITAO_ID#
      , #NGAYCAPNHAT#
      , #NGUOICAPNHAT_ID#
      )
    </insert>
    <insert id="DAO00064_TT_DOITUONG_THAYDOI_Add" parameterClass="System.Collections.IDictionary" resultClass="System.Int64">
      insert into TT_DOITUONG_THAYDOI (
      BENHNHAN_ID
      ,TIEPNHAN_ID
      ,BENHAN_ID
      ,DOITUONG_ID
      ,SOBHYT
      ,BHYTTUNGAY
      ,BHYTDENNGAY
      ,BHYTTREN3NAM
      ,BHYTTREN5NAM
      ,NGAYMIENDONGCHITRA
      ,OLD_DOITUONG_ID
      ,OLD_SOBHYT
      ,OLD_BHYTTUNGAY
      ,OLD_BHYTDENNGAY
      ,OLD_BHYTTREN3NAM
      ,OLD_BHYTTREN5NAM
      ,OLD_NGAYMIENDONGCHITRA
      ,BENHVIEN_ID
      ,NGAYTAO
      ,NGUOITAO_ID
      ,NGAYCAPNHAT
      ,NGUOICAPNHAT_ID
      ) values (
      #BENHNHAN_ID#
      ,#TIEPNHAN_ID#
      ,#BENHAN_ID#
      ,#DOITUONG_ID#
      ,#SOBHYT#
      ,#BHYTTUNGAY#
      ,#BHYTDENNGAY#
      ,#BHYTTREN3NAM#
      ,#BHYTTREN5NAM#
      ,#NGAYMIENDONGCHITRA#
      ,#OLD_DOITUONG_ID#
      ,#OLD_SOBHYT#
      ,#OLD_NGAYHIEULUC#
      ,#OLD_NGAYHETHIEULUC#
      ,#OLD_BHYTTREN3NAM#
      ,#OLD_BHYTTREN5NAM#
      ,#OLD_NGAYMIENDONGCHITRA#
      ,#BENHVIEN_ID#
      ,#NGAYTAO#
      ,#NGUOITAO_ID#
      ,#NGAYCAPNHAT#
      ,#NGUOICAPNHAT_ID#
      )
    </insert>
    <update id="DAO00064_TT_BENHNHAN_BHYT_Update" parameterClass="System.Collections.IDictionary">
      update TT_BENHNHAN_BHYT set
      BENHNHAN_ID = #BENHNHAN_ID#
      , LOAIBHYT = #LOAIBHYT#
      , SOTHE = #SOTHE#
      , NGAYCAP = #NGAYCAP#
      , NGAYHIEULUC = #NGAYHIEULUC#
      , NGAYHETHIEULUC = #NGAYHETHIEULUC#
      , TINHTHANH_CAPTHE_ID = #TINHTHANH_CAPTHE_ID#
      , BENHVIEN_ID = #BENHVIEN_ID#
      , BENHVIEN_KCB_ID = #BENHVIEN_KCB_ID#
      , TREN3NAM = #TREN3NAM#
      , TREN5NAM = #TREN5NAM#
      , NGAYMIENDONGCHITRA = #NGAYMIENDONGCHITRA#
      , TREN6THANG = #TREN6THANG#
      , KHUVUCSONG_ID = #KHUVUCSONG_ID#
      , TAMNGUNG = #TAMNGUNG#
      <!--, NGAYTAO = #NGAYTAO#
      , NGUOITAO_ID = #NGUOITAO_ID#-->
      , NGAYCAPNHAT = #NGAYCAPNHAT#
      , NGUOICAPNHAT_ID = #NGUOICAPNHAT_ID#
      where
      BENHNHAN_BHYT_ID = '$BENHNHAN_BHYT_ID$'
    </update>

    <statement id="DAO00064_GetGiaTriMienGiamByVienPhiID" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select CT.GIATRIMIENGIAM
      from TT_MIENGIAM_CHITIET CT
      left join TT_MIENGIAM MG
      on CT.MIENGIAM_ID = MG.MIENGIAM_ID
      where
      VIENPHI_ID = '$VIENPHI_ID$' and
      MG.TINHTRANG = 1
    </statement>

    <statement id="DAO00064_TT_TIEPNHAN_GetHoanThanh" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select *
      from TT_TIEPNHAN
      where
      TIEPNHAN_ID = '$TIEPNHAN_ID$'
      and TRANGTHAI  = 'HOANTHANH'      
    </statement>
    <statement id="DAO00064_KiemTraPhongBanKhoaNoi" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select PHONGBAN_ID from TM_PHONGBAN
      where
      LOAIPHONGBAN_ID = (select DICTIONARY_ID from LST_DICTIONARY where DICTIONARY_CODE = 'KhoaNoi')
      and PHONGBAN_ID = '$PHONGBAN_ID$'
      and BENHVIEN_ID = '$BENHVIEN_ID$'
    </statement>
    <statement id="DAO00064_GetListVienPhiByTiepNnan" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select distinct
      B.DOITUONG_ID, B.NGAYMIENDONGCHITRA, B.BENHNHAN_ID as TIEPNHAN_BENHNHAN_ID, B.TRAITUYEN,
      B.BHYTTREN3NAM as TREN3NAM, B.BHYTTREN5NAM as TREN5NAM, B.SOTIEPNHAN, B.SOBENHAN,
      B.LOAITHANHVIEN_ID, B.SUDUNG_BHTN, B.THE_ID, B.THANHVIEN_ID, B.BAOLANH_VIENPHI,
      C.GIATRIMIENGIAM as GIATRIMIENGIAM, D.GIATRIMIENGIAM as GIATRIMIENGIAM_BHTN, E.GIATRIMIENGIAM as GIATRIMIENGIAM_THANHVIEN,
      F.GIATRIMIENGIAM as GIATRIMIENGIAM_CONGTY, DVYC.THE_ID as DVDUNGTHE, DVYC.TRANGTHAI as TRANGTHAIDICHVU,
      A.* from TT_VIENPHI A
      left join
      (select B.*, C.SOBENHAN, C.BENHAN_ID
      from TT_TIEPNHAN B
      left join TT_NOITRU_BENHAN C on B.TIEPNHAN_ID = C.TIEPNHAN_ID
      where B.TIEPNHAN_ID = '$TIEPNHAN_ID$') B on B.TIEPNHAN_ID = A.TIEPNHAN_ID
      left join (select sum(GIATRIMIENGIAM) as GIATRIMIENGIAM, VIENPHI_ID, REF_TABLE
      from TT_MIENGIAM_CHITIET
      where REF_TABLE = 'TT_MIENGIAM'
      and MIENGIAM_ID in (select MIENGIAM_ID from TT_MIENGIAM where TINHTRANG = 1 and TIEPNHAN_ID = '$TIEPNHAN_ID$')
      group by VIENPHI_ID, REF_TABLE) C on C.REF_TABLE = 'TT_MIENGIAM' and C.VIENPHI_ID = A.VIENPHI_ID
      left join (select sum(GIATRIMIENGIAM) as GIATRIMIENGIAM, VIENPHI_ID, REF_TABLE
      from TT_MIENGIAM_CHITIET
      where REF_TABLE = 'TT_MIENGIAM_BHTN'
      and MIENGIAM_ID in (select MIENGIAM_BHTN_ID from TT_MIENGIAM_BHTN where TINHTRANG = 1 and TIEPNHAN_ID = '$TIEPNHAN_ID$')
      group by VIENPHI_ID, REF_TABLE) D on D.REF_TABLE = 'TT_MIENGIAM_BHTN' and D.VIENPHI_ID = A.VIENPHI_ID
      left join (select sum(GIATRIMIENGIAM) as GIATRIMIENGIAM, VIENPHI_ID, REF_TABLE
      from TT_MIENGIAM_CHITIET
      where REF_TABLE = 'TT_MIENGIAM_THANHVIEN'
      and MIENGIAM_ID in (select MIENGIAM_THANHVIEN_ID from TT_MIENGIAM_THANHVIEN where TINHTRANG = 1 and TIEPNHAN_ID = '$TIEPNHAN_ID$')
      group by VIENPHI_ID, REF_TABLE) E on E.REF_TABLE = 'TT_MIENGIAM_THANHVIEN' and E.VIENPHI_ID = A.VIENPHI_ID
      left join (select sum(GIATRIMIENGIAM) as GIATRIMIENGIAM, VIENPHI_ID, REF_TABLE
      from TT_MIENGIAM_CHITIET
      where REF_TABLE = 'TT_MIENGIAM_CONGTY'
      and MIENGIAM_ID in (select MIENGIAM_CONGTY_ID from TT_MIENGIAM_CONGTY where TINHTRANG = 1 and TIEPNHAN_ID = '$TIEPNHAN_ID$')
      group by VIENPHI_ID, REF_TABLE) F on F.REF_TABLE = 'TT_MIENGIAM_CONGTY' and F.VIENPHI_ID = A.VIENPHI_ID
      left join TT_DVYEUCAU DVYC on DVYC.DVYEUCAU_ID = A.REF_ID and A.REF_TABLE = 'TT_DVYEUCAU'
      where
      A.TIEPNHAN_ID = '$TIEPNHAN_ID$' and ((DVYC.HUYYEUCAU = '0' and A.DICHVU_ID is not null) or A.DUOC_ID is not null or A.REF_TABLE = 'TT_NUT_XACNHANSUATAN_CHITIET')
      <!--and A.HUY = '0'-->
      and A.ACTIVE = '1'
      <isNotEmpty prepend="and" property="BENHAN_ID">
        A.BENHAN_ID = '$BENHAN_ID$'
      </isNotEmpty>
      and A.BENHVIEN_ID = '$BENHVIEN_ID$'
      order by A.VIENPHI_ID
    </statement>
    <statement id="DAO00064_GetTT_MIENGIAM_THANHVIEN" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select * from TT_MIENGIAM_THANHVIEN where TIEPNHAN_ID = '$TIEPNHAN_ID$'
    </statement>
    <statement id="DAO00064_TT_MIENGIAM_THANHVIEN_Add" parameterClass="System.Collections.IDictionary" resultClass="System.Int64">
      insert into TT_MIENGIAM_THANHVIEN (
      SOPHIEU_THANHVIEN
      , TIEPNHAN_ID
      , BENHAN_ID
      , BENHNHAN_ID
      , LOAITHANHVIEN_ID
      , THE_ID
      , NGAYHIEULUC
      , NGAYHETHAN
      , NGUOIDUYET_ID
      , GHICHU
      , TINHTRANG
      , BENHVIEN_ID
      , NGUOITAO_ID
      , NGAYTAO
      , NGUOICAPNHAT_ID
      , NGAYCAPNHAT
      ) values (
      #SOPHIEU_THANHVIEN#
      , #TIEPNHAN_ID#
      , #BENHAN_ID#
      , #BENHNHAN_ID#
      , #LOAITHANHVIEN_ID#
      , #THE_ID#
      , #NGAYHIEULUC#
      , #NGAYHETHAN#
      , #NGUOIDUYET_ID#
      , #GHICHU#
      , '1'
      , #BENHVIEN_ID#
      , #NGUOITAO_ID#
      , #NGAYTAO#
      , #NGUOICAPNHAT_ID#
      , #NGAYCAPNHAT#
      )
      SELECT SCOPE_IDENTITY()
      <!--<selectKey resultClass="System.Int64" type="post" >
        SELECT @@IDENTITY as value
      </selectKey>-->
    </statement>
    <insert id="DAO00064_TT_MIENGIAM_CHITIET_THANHVIEN_Add" parameterClass="System.Collections.IDictionary" resultClass="System.Int64">
      insert into TT_MIENGIAM_CHITIET (
      MIENGIAM_ID
      , REF_TABLE
      , VIENPHI_ID
      , TYLEMIENGIAM
      , GIATRIMIENGIAM
      , BENHVIEN_ID
      , NGUOITAO_ID
      , NGAYTAO
      , NGUOICAPNHAT_ID
      , NGAYCAPNHAT
      , GIATRISAUMIENGIAM
      ) values (
      #MIENGIAM_ID#
      , 'TT_MIENGIAM_THANHVIEN'
      , #VIENPHI_ID#
      , #TYLEMIENGIAM#
      , #GIATRIMIENGIAM_UPDATE#
      , #BENHVIEN_ID#
      , #NGUOITAO_ID#
      , #NGAYTAO#
      , #NGUOICAPNHAT_ID#
      , #NGAYCAPNHAT#
      , #GIATRISAUMIENGIAM#
      )
    </insert>
    <update id="DAO00064_TT_MIENGIAM_CHITIET_THANHVIEN_Update" parameterClass="System.Collections.IDictionary">
      update TT_MIENGIAM_CHITIET set      
      <isPropertyAvailable prepend="" property="TYLEMIENGIAM">
        TYLEMIENGIAM = #TYLEMIENGIAM#
      </isPropertyAvailable>
      <isPropertyAvailable prepend="," property="GIATRIMIENGIAM">
        GIATRIMIENGIAM = #GIATRIMIENGIAM_UPDATE#
      </isPropertyAvailable>     
      <isPropertyAvailable prepend="," property="NGUOICAPNHAT_ID">
        NGUOICAPNHAT_ID = #NGUOICAPNHAT_ID#
      </isPropertyAvailable>
      <isPropertyAvailable prepend="," property="NGAYCAPNHAT">
        NGAYCAPNHAT = #NGAYCAPNHAT#
      </isPropertyAvailable>
      <isPropertyAvailable prepend="," property="GIATRISAUMIENGIAM">
        GIATRISAUMIENGIAM = #GIATRISAUMIENGIAM#
      </isPropertyAvailable>
      where
      VIENPHI_ID = '$VIENPHI_ID$'
      and REF_TABLE = 'TT_MIENGIAM_THANHVIEN'
    </update>
    <statement id="DAO00064_GetListBenhNhanNgoaiTru" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select distinct
      E.CHANDOANKHAMBENH as CHANDOAN, E.KHOAVAO_ID  as PHONGBAN_ID,  E.BENHAN_ID,
      E.ICD_BENHCHINH as MABENH, E.ICD_BENHPHU as BENHKHAC, E.SOBENHAN, E.SOCAPCUU,
      B.SOBHYT, B.NGAYTIEPNHAN , B.THOIGIANTIEPNHAN as NGAYVAO, B.SOTIEPNHAN, B.DOITUONG_ID, B.TIEPNHAN_ID,
      C.MAYTE as MABN, C.TENBENHNHAN as TENBN, C.NAMSINH , C.BENHNHAN_ID, E.BENHVIEN_ID,
      D.XACNHANCHIPHI_ID, D.NGAYXACNHAN, E.TRANGTHAI, G.GIATRI_BENHNHAN_DATHANHTOAN,
      F.NGAYCHUNGTU as NGAYXUATTHUOC, D.NGUOICAPNHAT_ID as NGUOIKHOABENHAN, nv.TENNHANVIEN, pb.TENPHONGBAN
      from TT_NOITRU_BENHAN E
      inner join TT_TIEPNHAN B on B.TIEPNHAN_ID = E.TIEPNHAN_ID
      left join TT_BENHNHAN C on E.BENHNHAN_ID = C.BENHNHAN_ID
      left join TT_XACNHANCHIPHI D on D.BENHAN_ID = E.BENHAN_ID
      left join TT_NOITRU_KHAMBENH A on E.BENHAN_ID = A.BENHAN_ID
      left join TT_DUOC_CHUNGTU F on F.KHAMBENH_ID = A.KHAMBENH_ID
      left join TM_NHANVIEN nv on nv.NHANVIEN_ID = e.BACSIDIEUTRICHINH_ID
      left join TM_PHONGBAN pb on pb.PHONGBAN_ID = e.KHOACHUYENDEN_ID
      left join (select BENHAN_ID, SUM(GIATRI_BENHNHAN_DATHANHTOAN) as GIATRI_BENHNHAN_DATHANHTOAN
      from TT_VIENPHI vp
      inner join TT_NOITRU_DOTDIEUTRI_CHITIET ct ON ct.VIENPHI_ID = vp.VIENPHI_ID
      inner join TT_NOITRU_DOTDIEUTRI dt on dt.DOTDIEUTRI_ID = ct.DOTDIEUTRI_ID
      where vp.BENHVIEN_ID = '$BENHVIEN_ID$'
      and dt.TRANGTHAI = '1' and ct.TRANGTHAI = 'DATHANHTOAN' group by vp.BENHAN_ID) G on E.BENHAN_ID = A.BENHAN_ID
      where
      (B.SOBHYT is not null and B.SOBHYT != '') AND E.LOAIBENHAN = 2 AND
      (E.TRANGTHAI = 'DAKHOA'  or (E.TRANGTHAI = 'DAXUATVIEN' and (G.GIATRI_BENHNHAN_DATHANHTOAN = 0 or G.GIATRI_BENHNHAN_DATHANHTOAN is null)))
      <isNotEmpty prepend="and" property="TUNGAY">
        E.NGAYLAP &#62;&#61; '$TUNGAY$'
      </isNotEmpty>
      <isNotEmpty prepend="and" property="DENNGAY">
        E.NGAYLAP &#60;&#61; '$DENNGAY$'
      </isNotEmpty>
      and E.BENHVIEN_ID = '$BENHVIEN_ID$'
      <isNotEmpty prepend="and" property="MABENHAN">
        (C.TENBENHNHAN like N'%$MABENHAN$%' OR C.MAYTE like '%$MABENHAN$%')
      </isNotEmpty>
      <isNotEmpty prepend="and" property="NGAYXACNHAN">
        D.NGAYXACNHAN = '$NGAYXACNHAN$'
      </isNotEmpty>
      <isNotEmpty prepend="" property="TRANGTHAI">
        <isEqual prepend="AND" property="TRANGTHAI" compareValue="2">
          D.XACNHANCHIPHI_ID is NULL
        </isEqual>
        <isEqual prepend="AND" property="TRANGTHAI" compareValue="3">
          D.XACNHANCHIPHI_ID is not NULL
        </isEqual>
        <isEqual prepend="AND" property="TRANGTHAI" compareValue="02">
          D.XACNHANCHIPHI_ID is NULL
        </isEqual>
        <isEqual prepend="AND" property="TRANGTHAI" compareValue="03">
          D.XACNHANCHIPHI_ID is not NULL
        </isEqual>
      </isNotEmpty>
      order by B.SOTIEPNHAN desc
    </statement>
    <statement id="DAO00064_TT_DUOC_CHUNGTU_KiemtraChungtuPhatThuoc" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select * from TT_DUOC_CHUNGTU where CHUNGTU_ID = '$CHUNGTUPHATTHUOC_ID$'
    </statement>
    <statement id="DAO00064_TT_NGOAITRU_KHAMBENH_TOATHUOC_UpdateChungtuPhatThuoc" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      UPDATE TT_NGOAITRU_KHAMBENH_TOATHUOC 
      SET CHUNGTUPHATTHUOC_ID = 0, TRANGTHAI = 'CHUAXUAT' 
      WHERE CHUNGTUPHATTHUOC_ID = '$CHUNGTUPHATTHUOC_ID$'
    </statement>
    <statement id="DAO00064_TT_NGOAITRU_KHAMBENH_TOATHUOC_GetListToaThuocBHYT" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select * from TT_NGOAITRU_KHAMBENH_TOATHUOC 
      where TIEPNHAN_ID = '$TIEPNHAN_ID$' and LOAITOATHUOC = 'BV'
    </statement>
    <statement id="DAO00064_TT_NOITRU_TOATHUOC_GetListToaThuocBHYT" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select distinct kb.*, tt.TRANGTHAI,tt.CHUNGTU_ID
      from TT_NOITRU_KHAMBENH kb
      left join TT_NOITRU_TOATHUOC tt on KB.KHAMBENH_ID = TT.KHAMBENH_ID
      where kb.BENHAN_ID = '$BENHAN_ID$' and kb.RAVIEN = '1' and kb.ISTHUOCBV = '1' and tt.HUYTOATHUOC = '0'
    </statement>
    <statement id="DAO00064_DeleteXacNhanBHYTDTNGoaiTru" parameterClass="System.Collections.IDictionary" resultClass="System.Int32">
      delete from TT_XACNHANCHIPHICHITIET
      where XACNHANCHIPHI_ID in
      (select XACNHANCHIPHI_ID from TT_XACNHANCHIPHI where XACNHANCHIPHI_ID = '$XACNHANCHIPHI_ID$');
      delete from TT_XACNHANCHIPHI where XACNHANCHIPHI_ID = '$XACNHANCHIPHI_ID$';
    </statement>
    <statement id="DAO00064_TT_VIENPHI_GetList_DaThanhToan" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select A.* from TT_VIENPHI A
      where
      A.TIEPNHAN_ID = '$TIEPNHAN_ID$'
      and A.DATHANHTOAN = '0'
    </statement>
    <statement id="DAO00064_TT_VIENPHI_GetList_NoiTRuBHYT_XacnhanBHYT" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select * from TT_XACNHANCHIPHI where TIEPNHAN_ID in (
      select distinct TIEPNHAN_ID from TT_VIENPHI A
      where
      A.BENHAN_ID = '$BENHAN_ID$'
      and A.BHYT_THANHTIEN_CHITRA > 0)
    </statement>
    <statement id="DAO00064_TT_VIENPHI_GetList_NoiTRu_Chuathanhtoan" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select count(*) as TOTALROWS from TT_VIENPHI A
      where
      A.BENHAN_ID = '$BENHAN_ID$'
      and A.BENHNHAN_PHAITHANHTOAN > GIATRI_BENHNHAN_DATHANHTOAN
    </statement>
    <statement id="DAO00064_TT_VIENPHI_GetList_NoiTRuBHYT_CochiphiBHYT" parameterClass="System.Collections.IDictionary" resultClass="DataObject"> 
      select VIENPHI_ID from TT_VIENPHI A
      where
      A.BENHAN_ID = '$BENHAN_ID$'
      and A.BHYT_THANHTIEN_CHITRA > 0
    </statement>
    <statement id="DAO00064_TT_VIENPHI_GetList_NoiTRu" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select count(*) as TOTALROWS from TT_VIENPHI A
      where
      A.BENHAN_ID = '$BENHAN_ID$'
      <isNotEmpty prepend="and" property="NGAYBENHAN">
        A.NGAYTAO >= '$NGAYBENHAN$'
      </isNotEmpty>
    </statement>
    <statement id="DAO00064_GetList" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      <!--get cache co where-->
      select * from $CACHE_TABLE$
      where
      BENHVIEN_ID = '$BENHVIEN_ID$'
    </statement>
    <statement id="DAO00064_GetDichvuNguon" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      <!--get cache co where-->
      select * from TM_DICHVU_NGUON
      where
      BENHVIEN_ID = '$BENHVIEN_ID$'
    </statement>
    <statement id="DAO00064_GetBHYTTylethanhtoan" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      <!--get cache co where-->
      select * from TM_BHYT_TYLETHANHTOAN
      where
      BENHVIEN_ID = '$BENHVIEN_ID$'
    </statement>
    <statement id="DAO00064_GetNguonDichvu" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      <!--get cache co where-->
      select * from TM_NGUONDICHVU
      where
      BENHVIEN_ID = '$BENHVIEN_ID$'
    </statement>
    <statement id="DAO00064_GetDanhsachDichvuNgoaitru_ByTiepnhan" parameterClass="System.Collections.IDictionary" resultClass="DataObject">
      select A.DVYEUCAU_ID, C.LOAIDICHVU, B.BENHNHAN_PHAITHANHTOAN, B.DATHANHTOAN, A.TIEPNHAN_ID, D.SOTIEPNHAN, A.DICHVU_ID
      from TT_DVYEUCAU A
      left join (select * from TT_TIEPNHAN where TIEPNHAN_ID = '$TIEPNHAN_ID$') D on D.TIEPNHAN_ID = A.TIEPNHAN_ID
      left join (select A.DICHVU_ID,
      IIF(LEFT(B.MANHOMDICHVU,2) = '04', 'khambenh', 'nhomkhac') AS LOAIDICHVU
      from TM_DICHVU A
      left JOIN TM_NHOMDICHVU B on A.NHOMDICHVU_ID = B.NHOMDICHVU_ID ) C on C.DICHVU_ID = A.DICHVU_ID
      inner join
      (select * from TT_VIENPHI where TIEPNHAN_ID = '$TIEPNHAN_ID$' and (BENHAN_ID is null or BENHAN_ID = 0) and (DICHVU_ID is not null or DICHVU_ID != 0))  B on A.DVYEUCAU_ID = B.REF_ID
      where A.HUYYEUCAU = '0' and A.TIEPNHAN_ID = '$TIEPNHAN_ID$'
    </statement>
   
</statements>   
</sqlMap>